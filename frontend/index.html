<!DOCTYPE html>

<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Dance Studio</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
/* ====== ЦВЕТА (ФИКСИРОВАННАЯ БЕЛАЯ ТЕМА) ====== */
:root {
  --bg: #ffffff;
  --text: #111111;
  --hint: #777777;
  --accent: #e91e63;
  --card: #f5f5f5;
  --border: #eeeeee;
  --safe-top: 0px;
  --safe-bottom: 0px;
}

/* ====== БАЗА ====== */
* {
  box-sizing: border-box;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
}

body {
  margin: 0;
  background: var(--bg);
  color: var(--text);
}

/* ====== HEADER ====== */
header {
  display: none;
}

.header-back {
  border: none;
  background: transparent;
  color: var(--accent);
  font-size: 22px;
  line-height: 1;
  padding: 4px 6px;
  cursor: pointer;
}

/* На мобильных используем системную кнопку Telegram */
body.tg-mobile .header-back {
  display: none;
}

.header-back:active {
  opacity: 0.6;
}

.header-center {
  flex: 1;
  text-align: center;
  pointer-events: none;
}

.header-center-title {
  font-size: 20px;
  font-weight: 700;
  color: var(--text);
}

.header-spacer {
  width: 32px;
  height: 32px;
}

/* ====== СТРАНИЦЫ ====== */
.page {
  display: none;
  padding: 16px;
  padding-bottom: calc(56px + var(--safe-bottom));
  padding-top: calc(16px + var(--safe-top));
}

.page.active {
  display: block;
}

/* Минимальная высота для страниц */
#staff {
  min-height: calc(100vh - 100px);
}

/* ====== КАРТОЧКИ ====== */
.card {
  background: var(--card);
  padding: 14px;
  border-radius: 14px;
  margin-bottom: 12px;
}

/* Компактные секции на вкладке "Работа" */
.work-section {
  background: transparent;
  border: none;
  box-shadow: none;
  padding: 0;
  margin-bottom: 10px;
}
.work-section h4 {
  margin: 0 0 8px 0;
}

.menu-item {
  background: var(--card);
  padding: 14px;
  border-radius: 12px;
  margin-bottom: 10px;
  cursor: pointer;
}

.menu-item:active {
  opacity: 0.7;
}

/* ====== НИЖНЕЕ МЕНЮ ====== */
.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  min-height: 45px;
  height: auto;
  display: flex;
  align-items: center;
  background: var(--bg);
  border-top: 1px solid var(--border);
  padding: 6px 8px calc(env(safe-area-inset-bottom) + 10px);
  box-sizing: border-box;
}

.nav-btn {
  flex: 1;
  text-align: center;
  padding: 4px 0;
  font-size: 12px;
  color: var(--hint);
  cursor: pointer;
  line-height: 1.3;
}

.nav-btn.active {
  color: var(--accent);
  font-weight: 600;
}

.nav-btn.hidden {
  width: 0;
  opacity: 0;
  pointer-events: none;
  overflow: hidden;
  flex: 0;
}

/* ====== ВКЛАДКИ С АНИМАЦИЕЙ ====== */
.nav-tab {
  transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1) !important;
}

.tabs-container {
  position: relative !important;
}

.tab-indicator {
  position: absolute;
  bottom: -2px;
  height: 3px;
  background: #2196F3;
  transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
}

/* ====== ПРОФИЛЬ ====== */
.profile {
  text-align: center;
}

.avatar {
  width: 90px;
  height: 90px;
  border-radius: 50%;
  background: var(--card);
  margin: 0 auto 12px;
  overflow: hidden;
}

.avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* ====== ПАНЕЛЬ ПЕРСОНАЛА ====== */
.staff-info-panel {
  background: var(--card);
  padding: 14px;
  border-radius: 12px;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 12px;
}

.staff-avatar-small {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: var(--border);
  flex-shrink: 0;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
}

.staff-avatar-small img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.staff-info-text {
  flex: 1;
  text-align: left;
}

.staff-name {
  font-weight: 600;
  font-size: 15px;
  color: var(--text);
  margin: 0;
}

.staff-position {
  font-size: 13px;
  color: var(--hint);
  margin: 4px 0 0 0;
}

.staff-card-row {
  display: flex;
  gap: 12px;
  align-items: flex-start;
}

.staff-card-avatar {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background: #e0e0e0;
  color: #fff;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  flex-shrink: 0;
}

.staff-card-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

.staff-card-row {
  display: flex;
  gap: 12px;
  align-items: flex-start;
}

.staff-card-avatar {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background: #e0e0e0;
  color: #fff;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  flex-shrink: 0;
}

.staff-card-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}



/* ====== ТЕКСТ ====== */
.small {
  color: var(--hint);
  font-size: 14px;
}

/* ====== ДЕТАЛИ ГРУПП ====== */
.group-detail-grid {
  display: grid;
  gap: 6px;
}

.group-detail-row {
  display: flex;
  align-items: baseline;
  gap: 6px;
  font-size: 14px;
  line-height: 1.4;
}

.group-detail-row span {
  color: var(--hint);
  white-space: nowrap;
}

.group-detail-row div {
  font-weight: 600;
  color: var(--text);
}

/* ====== НАЗАД ====== */
.back {
  color: var(--accent);
  cursor: pointer;
  margin-bottom: 12px;
  display: inline-block;
}

/* ====== РАЗДЕЛ О СТУДИИ ====== */
.studio-section {
  background: transparent;
  padding: 0;
  border-radius: 0;
  box-shadow: none;
}

.section-item {
  background: #ffffff;
  padding: 16px;
  border-radius: 16px;
  margin-bottom: 12px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: space-between;
  box-shadow: 0 6px 14px rgba(0, 0, 0, 0.08);
  transition: all 0.2s;
}

.section-item:active {
  opacity: 0.7;
  background: var(--border);
}

.section-item-left {
  display: flex;
  align-items: center;
  gap: 14px;
  flex: 1;
}

.section-item-icon {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  color: #ffffff;
  font-size: 24px;
  flex-shrink: 0;
}

.section-icon--orange {
  background: #ff9800;
}

.section-icon--purple {
  background: #5a55d6;
}

.section-icon--blue {
  background: #49b6e7;
}

.section-icon--pink {
  background: #ff3b6b;
}

.section-item-text {
  text-align: left;
}

.section-item-title {
  font-weight: 700;
  font-size: 16px;
  margin: 0;
}

.section-item-desc {
  font-size: 13px;
  color: var(--hint);
  margin: 6px 0 0 0;
}

.section-item-arrow {
  color: #1a1a1a;
  font-size: 28px;
  font-weight: 700;
}

/* ====== КОНТАКТНАЯ ИНФОРМАЦИЯ ====== */
.contact-btn {
  background: var(--card);
  padding: 12px;
  border-radius: 12px;
  margin-bottom: 10px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: space-between;
  transition: all 0.2s;
}

.contact-btn:active {
  opacity: 0.7;
  background: var(--border);
}

.contact-btn-content {
  display: flex;
  align-items: center;
  gap: 12px;
  flex: 1;
}

.contact-icon {
  font-size: 24px;
}

.contact-label {
  font-size: 12px;
  color: var(--hint);
  margin-bottom: 2px;
}

.contact-value {
  font-weight: 600;
  font-size: 14px;
  color: var(--text);
}

.contact-action {
  font-size: 12px;
  color: var(--accent);
  font-weight: 600;
  white-space: nowrap;
  margin-left: 8px;
}

/* ====== ФОРМЫ ====== */
.form-group {
  margin-bottom: 14px;
}

.form-group label {
  display: block;
  font-size: 12px;
  color: var(--hint);
  margin-bottom: 6px;
  font-weight: 600;
}

.form-input {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid var(--border);
  border-radius: 8px;
  font-size: 14px;
  font-family: inherit;
  background: var(--card);
  color: var(--text);
  box-sizing: border-box;
}

.form-input:focus {
  outline: none;
  border-color: var(--accent);
  background: var(--bg);
}

textarea.form-input {
  resize: vertical;
}

.save-btn {
  width: 100%;
  padding: 12px;
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.save-btn:active {
  opacity: 0.8;
  transform: scale(0.98);
}

.save-btn {
  text-align: center;
  white-space: normal;
  word-wrap: break-word;
  display: flex;
  justify-content: center;
  align-items: center;
}

/* ====== РЃС‚СЂР°РЅРёС†Р° СЂРµРґР°РєС‚РёСЂРѕРІР°РЅРёСЏ ====== */
.direction-edit-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
}

.lock-btn {
  width: 32px;
  height: 32px;
  border-radius: 16px;
  border: 1px solid var(--border);
  background: var(--card);
  color: var(--text);
  cursor: pointer;
  font-size: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.lock-btn:active {
  opacity: 0.7;
}

.direction-lockable {
  position: relative;
}

.direction-lockable .lock-overlay {
  display: none;
  position: absolute;
  inset: 0;
  background: rgba(245, 245, 245, 0.7);
  border-radius: 12px;
  z-index: 2;
  pointer-events: all;
}

#direction-edit-form.direction-locked .direction-lockable .lock-overlay {
  display: block;
}

/* ====== СПИСОК КЛИЕНТОВ (ПЕРСОНАЛ) ====== */
.clients-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.client-card {
  background: var(--card);
  padding: 12px;
  border-radius: 12px;
  cursor: pointer;
  border-left: 4px solid var(--accent);
  transition: all 0.2s;
}

.client-card:active {
  background: var(--border);
  transform: translateX(4px);
}

.client-card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.client-card-name {
  font-weight: 600;
  font-size: 14px;
}

.client-card-status {
  font-size: 12px;
  padding: 2px 8px;
  border-radius: 6px;
  background: var(--accent);
  color: white;
}

.client-card-info {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  margin-bottom: 8px;
}

.client-info-item {
  font-size: 12px;
  color: var(--hint);
}

.client-info-label {
  color: var(--hint);
  font-size: 11px;
}

.client-info-value {
  color: var(--text);
  font-weight: 500;
}

.client-card-notes {
  background: var(--bg);
  padding: 8px;
  border-radius: 8px;
  margin-top: 8px;
  font-size: 12px;
  color: var(--hint);
}

/* ====== ФОТО ПРОФИЛЯ ====== */
.photo-preview {
  background: var(--card);
  border-radius: 12px;
  padding: 20px;
  text-align: center;
  margin-bottom: 12px;
  border: 2px dashed var(--border);
}

#profile-photo-img {
  max-width: 100%;
  max-height: 300px;
  border-radius: 8px;
}

/* ====== НОВОСТИ ====== */
.news-grid {
  display: flex;
  gap: 10px;
  overflow-x: auto;
  overflow-y: hidden;
  scroll-behavior: smooth;
  padding-bottom: 8px;
  -webkit-overflow-scrolling: touch;
}

.news-item {
  position: relative;
  width: 100px;
  height: 100px;
  min-width: 100px;
  border-radius: 12px;
  overflow: hidden;
  cursor: pointer;
  transition: transform 0.2s, opacity 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  background: linear-gradient(135deg, var(--accent), #ff69b4);
}

.news-item::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, var(--accent), #ff69b4);
  z-index: -1;
}

.news-item img {
  position: absolute;
  width: 100%;
  height: 100%;
  object-fit: cover;
  z-index: 0;
}

.news-item-title {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  background: rgba(0, 0, 0, 0.6);
  color: white;
  font-weight: 600;
  font-size: 11px;
  line-height: 1.2;
  padding: 6px 4px;
  text-align: center;
  z-index: 1;
  max-height: 40%;
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  line-clamp: 2;
  -webkit-box-orient: vertical;
}

.news-item:active {
  transform: scale(0.95);
  opacity: 0.8;
}

.news-empty {
  text-align: center;
  color: var(--hint);
  padding: 20px;
  font-size: 14px;
}

/* ====== ПРОСМОТР НОВОСТИ ====== */
#news-detail {
  padding: 0 !important;
  padding-bottom: 56px !important;
}

#news-detail .news-detail-header {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  background: var(--bg);
  position: sticky;
  top: 0;
  z-index: 10;
  border-bottom: 1px solid var(--border);
}

#news-detail .news-detail-back {
  color: var(--accent);
  cursor: pointer;
  font-size: 24px;
  line-height: 1;
  flex-shrink: 0;
  padding: 4px 8px;
}

#news-detail .news-detail-back:active {
  opacity: 0.6;
}

#news-detail .news-detail-title-header {
  font-size: 18px;
  font-weight: 600;
  color: var(--text);
  margin: 0;
  flex: 1;
}

#news-detail-photo-container {
  width: 100%;
  height: 300px;
  background: var(--card);
  overflow: hidden;
  margin-bottom: -30px;
  position: relative;
  z-index: 1;
}

#news-detail-photo-container img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

#news-detail .news-detail-content-wrapper {
  background: var(--bg);
  border-radius: 30px 30px 0 0;
  padding: 30px 16px 16px 16px;
  margin-top: 0;
  position: relative;
  z-index: 2;
}

#news-detail-title {
  font-size: 20px;
  font-weight: 700;
  margin: 0 0 8px 0;
  color: var(--text);
}

#news-detail-date {
  color: var(--hint);
  font-size: 13px;
  margin-bottom: 16px !important;
}

#news-detail-content {
  color: var(--text);
  line-height: 1.6;
  font-size: 15px;
  margin: 0;
}

.brand-header {
  text-align: center;
  margin: -6px 0 14px 0;
}

.brand-row {
  display: inline-flex;
  align-items: center;
  gap: 10px;
  padding: 4px 10px;
  border-radius: 999px;
  background: rgba(0, 0, 0, 0.12);
}

.brand-avatar {
  width: 22px;
  height: 22px;
  border-radius: 50%;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  background: rgba(0, 0, 0, 0.08);
}

.brand-avatar:empty {
  display: none;
}

.brand-name {
  font-size: 14px;
  font-weight: 600;
  color: var(--text);
}

.page-title {
  font-size: 22px;
  font-weight: 700;
  margin: 10px 0 12px 0;
  text-align: center;
}

/* ====== АДМИН-РАСПИСАНИЕ ====== */
.schedule-toolbar {
  display: flex;
  gap: 8px;
  align-items: center;
  margin-bottom: 12px;
}

.schedule-toolbar .button {
  flex: 1;
  padding: 10px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: var(--card);
  cursor: pointer;
  font-size: 13px;
}

.schedule-toolbar .button.active {
  background: var(--accent);
  color: #fff;
  border-color: var(--accent);
}

.schedule-nav {
  display: flex;
  gap: 8px;
  align-items: center;
  margin-bottom: 12px;
}

.schedule-nav .nav-btn-mini {
  padding: 8px 10px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: var(--card);
  cursor: pointer;
}

.schedule-nav .date-label {
  flex: 1;
  text-align: center;
  font-weight: 600;
}

.schedule-grid {
  display: grid;
  grid-template-columns: 64px repeat(7, 1fr);
  border: 1px solid var(--border);
  border-radius: 12px;
  overflow: hidden;
  background: #fff;
}

#teacher-working-hours .schedule-grid {
  touch-action: none;
}

.schedule-grid.day {
  grid-template-columns: 64px 1fr;
}

.schedule-cell {
  border-bottom: 1px solid var(--border);
  border-right: 1px solid var(--border);
  min-height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  padding: 2px 4px;
}

.schedule-cell.time {
  background: var(--card);
  color: var(--hint);
  font-weight: 600;
}

.schedule-cell.time.half {
  opacity: 0.45;
}

.schedule-cell.head {
  background: var(--card);
  font-weight: 600;
  font-size: 12px;
}

.schedule-slot {
  background: #fff;
  cursor: pointer;
}

.schedule-slot.busy {
  cursor: not-allowed;
}

.schedule-slot.non-working {
  background: #ffcdd2;
}

.schedule-slot.non-working:hover {
  background: #ef9a9a;
}

.schedule-slot.busy.group {
}

.schedule-slot.busy.individual {
}

.schedule-slot.busy.rental {
}

.schedule-event {
  font-size: 11px;
  font-weight: 600;
  text-align: center;
}

.schedule-form {
  margin-top: 12px;
  padding: 12px;
  background: var(--card);
  border-radius: 12px;
  display: none;
}

.schedule-form.show {
  display: block;
}

.schedule-detail-modal {
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  background: #fff;
  border-radius: 20px 20px 0 0;
  box-shadow: 0 -8px 20px rgba(0, 0, 0, 0.15);
  padding: 16px;
  display: none;
  z-index: 1002;
  max-height: 70vh;
  overflow-y: auto;
}

.schedule-detail-modal.show {
  display: block;
}

.schedule-detail-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.2);
  display: none;
  z-index: 1001;
}

.schedule-detail-overlay.show {
  display: block;
}

.group-schedule-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.2);
  display: none;
  z-index: 1001;
}

.group-schedule-overlay.show {
  display: block;
}

.group-schedule-modal {
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  background: #fff;
  border-radius: 20px 20px 0 0;
  box-shadow: 0 -8px 20px rgba(0, 0, 0, 0.15);
  padding: 16px;
  display: none;
  z-index: 1002;
  max-height: 85vh;
  overflow-y: auto;
}

.group-schedule-modal.show {
  display: block;
}

.confirm-modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.25);
  display: none;
  z-index: 1001;
}

.confirm-modal-overlay.show {
  display: block;
}

.confirm-modal {
  position: fixed;
  left: 16px;
  right: 16px;
  top: 50%;
  transform: translateY(-50%);
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 12px 30px rgba(0, 0, 0, 0.2);
  padding: 16px;
  display: none;
  z-index: 1002;
}

.confirm-modal.show {
  display: block;
}

.schedule-detail-chip {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 10px;
  border-radius: 999px;
  background: var(--card);
  font-size: 12px;
}

.schedule-detail-card {
  margin-top: 10px;
  padding: 12px;
  border-radius: 12px;
  background: var(--card);
  border: 1px solid var(--border);
  display: grid;
  gap: 8px;
}

.schedule-detail-row {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
}

.repeat-panel {
  margin-top: 10px;
  padding: 10px;
  border-radius: 12px;
  background: #fff;
  border: 1px solid var(--border);
}

.repeat-row {
  display: flex;
  gap: 8px;
  align-items: center;
  margin: 8px 0;
}

.repeat-row .chip {
  padding: 6px 8px;
  border-radius: 999px;
  border: 1px solid var(--border);
  background: var(--card);
  font-size: 12px;
  cursor: pointer;
}

.repeat-row .chip.active {
  background: var(--accent);
  color: #fff;
  border-color: var(--accent);
}

.repeat-inline {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 12px;
}

.repeat-inline input[type="number"] {
  width: 60px;
}

.repeat-summary {
  margin-top: 8px;
  font-size: 12px;
  color: var(--hint);
}

.work-page .staff-info-panel {
  margin-top: 6px;
  margin-bottom: 18px;
}

.work-page .card {
  margin-bottom: 18px;
}

/* ====== РАСПИСАНИЕ (ПОЛЬЗОВАТЕЛИ) ====== */
.public-schedule-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  margin-bottom: 12px;
}

.public-schedule-title {
  display: inline-flex;
  align-items: center;
  gap: 10px;
  font-size: 20px;
  font-weight: 700;
}

.public-schedule-action {
  font-size: 14px;
  color: var(--hint);
  font-weight: 600;
}

.public-schedule-month {
  font-size: 12px;
  color: var(--hint);
  text-transform: uppercase;
  letter-spacing: 0.08em;
  margin: 6px 0 10px 2px;
}

.public-schedule-strip {
  display: flex;
  gap: 10px;
  overflow-x: auto;
  padding-bottom: 6px;
  -webkit-overflow-scrolling: touch;
}

.public-date-card {
  min-width: 64px;
  background: #fff;
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 8px 10px;
  text-align: center;
  cursor: pointer;
}

.public-date-card:hover,
.public-schedule-item:hover {
  cursor: pointer;
}

.public-date-card.active {
  background: #111;
  color: #fff;
  border-color: #111;
}

.public-date-dow {
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  color: inherit;
}

.public-date-day {
  font-size: 18px;
  font-weight: 700;
  margin: 4px 0 2px 0;
}

.public-date-label {
  font-size: 11px;
  color: var(--hint);
}

.public-date-card.active .public-date-label {
  color: rgba(255, 255, 255, 0.8);
}

.public-schedule-list {
  margin-top: 8px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.public-schedule-item {
  display: grid;
  grid-template-columns: 54px 1fr 18px;
  gap: 10px;
  align-items: start;
  padding: 8px 0;
  border-bottom: 1px solid var(--border);
}

.public-schedule-time {
  display: flex;
  flex-direction: column;
  gap: 6px;
  align-items: center;
}

.public-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
}

.public-time {
  font-weight: 700;
  font-size: 14px;
}

.public-duration {
  font-size: 12px;
  color: var(--hint);
}

.public-info-title {
  font-weight: 700;
  font-size: 15px;
  margin-bottom: 4px;
}

.public-info-image {
  width: 100%;
  height: 90px;
  border-radius: 12px;
  object-fit: cover;
  margin-bottom: 6px;
  display: block;
}

.public-info-sub {
  font-size: 13px;
  color: var(--hint);
  margin-bottom: 2px;
}

.public-info-teacher {
  font-size: 13px;
  color: var(--hint);
}

/* ====== НАПРАВЛЕНИЕ (ДЕТАЛИ) ====== */
.direction-detail-photo {
  width: calc(100% + 32px);
  height: 300px;
  background: var(--card);
  overflow: hidden;
  margin-bottom: -30px;
  margin-left: -16px;
  margin-right: -16px;
  position: relative;
  z-index: 1;
  border-radius: 0;
}

.direction-detail-photo img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

.direction-detail-content {
  background: var(--bg);
  border-radius: 24px 24px 0 0;
  padding: 20px 16px 16px 16px;
  position: relative;
  z-index: 2;
  box-shadow: 0 -10px 20px rgba(0, 0, 0, 0.08);
  margin-left: -16px;
  margin-right: -16px;
}

.public-chevron {
  font-size: 18px;
  color: var(--hint);
  align-self: center;
}

.public-schedule-detail {
  display: grid;
  gap: 12px;
}

.group-inline-details {
  margin-top: 0;
  padding: 0;
  border-radius: 10px;
  background: transparent;
  border: 0;
  max-height: 0;
  opacity: 0;
  overflow: hidden;
  transition: max-height 0.35s ease, opacity 0.25s ease;
}

.group-inline-details.show {
  opacity: 1;
  margin-top: 10px;
  padding: 10px;
  background: var(--card);
  border: 1px solid var(--border);
}

.group-summary,
.group-teacher {
  transition: opacity 0.2s ease, max-height 0.25s ease;
  max-height: 200px;
  overflow: hidden;
}

.group-summary.hidden,
.group-teacher.hidden {
  opacity: 0;
  max-height: 0;
  margin-top: 0;
}

.group-teacher-link {
  margin-top: 10px;
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 10px 12px;
  background: #fff;
  display: grid;
  gap: 6px;
  text-align: left;
  cursor: pointer;
  color: var(--text);
}

.group-teacher-row {
  display: flex;
  align-items: center;
  gap: 8px;
}

.group-teacher-avatar {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  background: #e0e0e0;
  color: #555;
  font-weight: 700;
  font-size: 12px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  overflow: hidden;
}

.group-teacher-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

.group-teacher-label {
  font-size: 11px;
  color: var(--hint);
  text-transform: uppercase;
  letter-spacing: 0.6px;
}

</style>
</head>
<body>
<header id="header">
<button aria-label="Назад" class="header-back" id="header-back" onclick="goBack()">←</button>
<div class="header-center">
<div class="header-center-title" id="header-title">LISSA DANCE</div>
</div>
<div class="header-spacer" aria-hidden="true"></div>
</header>
<!-- ====== ГЛАВНАЯ ====== -->
<div class="page active" id="home">
<div class="card">
<h3>Добро пожаловать!</h3>
<p class="small">Мы рады видеть вас в нашей студии</p>
</div>
<div class="card">
<h4>Новости</h4>
<div class="news-grid" id="news-container">
<p class="news-empty">Новостей пока нет v-v</p>
</div>
</div>
<div class="card studio-section">
<h4>О студии</h4>
<div class="section-item" onclick="showSection('info-about')">
<div class="section-item-left">
<div class="section-item-icon section-icon--orange">☆</div>
<div class="section-item-text">
<h4 class="section-item-title">Информация</h4>
<p class="section-item-desc">Инфо о нас, время работы</p>
</div>
</div>
<div class="section-item-arrow">›</div>
</div>
<div class="section-item" onclick="showSection('info-teachers')">
<div class="section-item-left">
<div class="section-item-icon section-icon--purple">🎓</div>
<div class="section-item-text">
<h4 class="section-item-title">Преподаватели</h4>
<p class="section-item-desc">Список всех преподавателей</p>
</div>
</div>
<div class="section-item-arrow">›</div>
</div>
<div class="section-item" onclick="showSection('info-directions')">
<div class="section-item-left">
<div class="section-item-icon section-icon--blue">⏱</div>
<div class="section-item-text">
<h4 class="section-item-title">Направления</h4>
<p class="section-item-desc">Виды танцев</p>
</div>
</div>
<div class="section-item-arrow">›</div>
</div>
<div class="section-item" onclick="showSection('info-individual')">
<div class="section-item-left">
<div class="section-item-icon section-icon--blue">⏱️</div>
<div class="section-item-text">
<h4 class="section-item-title">Индивидуальные занятия</h4>
<p class="section-item-desc">Запишитесь на персональную тренировку</p>
</div>
</div>
<div class="section-item-arrow">›</div>
</div>
<div class="section-item" onclick="showSection('info-rent')">
<div class="section-item-left">
<div class="section-item-icon section-icon--pink">🔑</div>
<div class="section-item-text">
<h4 class="section-item-title">Аренда зала</h4>
<p class="section-item-desc">Условия аренды и бронирование</p>
</div>
</div>
<div class="section-item-arrow">›</div>
</div>
</div>
</div>
<!-- ====== ИНФОРМАЦИЯ О СТУДИИ ====== -->
<div class="page" id="info-about">
<h3>Информация о студии</h3>
<div class="card">
<h4>⏰ Время работы</h4>
<p>Ежедневно: 09:00 - 22:00</p>
</div>
<div class="card">
<h4>📍 Как добраться</h4>
<script async="" charset="utf-8" src="https://api-maps.yandex.ru/services/constructor/1.0/js/?um=constructor%3Aa1063a1f3fac777c9cdef5b98494aee9e4ffee329067594a69657b435039fe33&amp;width=334&amp;height=265&amp;lang=ru_RU&amp;scroll=true" type="text/javascript"></script>
</div>
<div class="card">
<h4>📞 Контактная информация</h4>
<div class="contact-btn" onclick="copyPhone('+7 800 555 35 35')">
<div class="contact-btn-content">
<span class="contact-icon">📱</span>
<div>
<div class="contact-label">Номер телефона</div>
<div class="contact-value">+7 800 555 35 35</div>
</div>
</div>
<span class="contact-action">Скопировать</span>
</div>
<div class="contact-btn">
<div class="contact-btn-content">
<span class="contact-icon">💬</span>
<div>
<div class="contact-label">Telegram</div>
<div class="contact-value">Скоро</div>
</div>
</div>
<span class="contact-action">Скоро</span>
</div>
</div>
</div>
<!-- ====== РАСПИСАНИЕ ====== -->
<div class="page" data-title="🗓 Расписание" id="schedule">
<div class="public-schedule-header">
  <div class="public-schedule-title"><span>☆</span>Расписание</div>
  <div class="public-schedule-action">Фильтр</div>
</div>
<div class="public-schedule-month" id="public-schedule-month">—</div>
<div class="public-schedule-strip" id="public-schedule-strip"></div>
<div class="public-schedule-list" id="schedule-container">
  <p class="small" style="text-align: center; color: var(--hint); padding: 20px;">Загрузка...</p>
</div>
</div>
<div class="page" data-title="🗓 Занятие" id="public-schedule-detail">
  <div class="public-schedule-detail" id="public-schedule-detail-content"></div>
</div>
<!-- ====== РАБОТЫ (ПЕРСОНАЛ) ====== -->
<div class="page work-page" data-title="👨‍💼 Работа" id="staff">
<!-- Панель с информацией о персонале -->
<div class="staff-info-panel">
<div class="staff-avatar-small" id="staff-panel-avatar">
<img alt="Фото" id="staff-panel-avatar-img" src="" style="display: none;"/>
<p style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--hint);">👤</p>
</div>
<div class="staff-info-text">
<div class="staff-name" id="staff-panel-name">—</div>
<div class="staff-position" id="staff-panel-position">—</div>
</div>
<button class="lock-btn" onclick="openStaffProfileEdit()" title="Редактировать рабочий профиль">✏️</button>
</div>
<!-- Меню функционала -->
<div class="card work-section" style="margin-bottom: 12px;">
<h4 style="margin-bottom: 10px;">Персональное</h4>
<button class="save-btn" onclick="showPage('personal-schedule')" style="width: 100%; margin-bottom: 8px;">📅 Личное расписание</button>
<button class="save-btn" type="button" style="width: 100%; margin-bottom: 8px;">👥 Личные группы</button>
</div>
<div class="card work-section" style="margin-bottom: 12px;">
<h4 style="margin-bottom: 10px;">Структура</h4>
<button class="save-btn" onclick="showPage('schedule-control')" style="width: 100%; margin-bottom: 8px;">🗓️ Расписание</button>
<button class="save-btn" onclick="showPage('directions-groups')" style="width: 100%; margin-bottom: 8px;">📚 Направления и группы</button>
</div>
<div class="card work-section" style="margin-bottom: 12px;">
<h4 style="margin-bottom: 10px;">Коммуникации</h4>
<button class="save-btn" onclick="showPage('mailings')" style="width: 100%; margin-bottom: 8px;">📧 Рассылки</button>
<button class="save-btn" onclick="showPage('news-manage')" style="width: 100%; margin-bottom: 8px;">📰 Новости</button>
</div>
<div class="card work-section">
<h4 style="margin-bottom: 10px;">Работа с людьми</h4>
<button class="save-btn" id="staff-manage-btn-work" onclick="showPage('staff-manage')" style="width: 100%; margin-bottom: 8px; display: none; text-align: center;">👥 Персонал</button>
<button class="save-btn" onclick="showPage('clients-list')" style="width: 100%; margin-bottom: 8px;">👨‍👩‍👧‍👦 Клиенты</button>
</div>
</div>
<!-- ====== ЛИЧНОЕ РАСПИСАНИЕ ====== -->
<div class="page" data-title="📅 Личное расписание" id="personal-schedule">

<div id="personal-schedule-container">
<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">⏳ Загрузка...</p>
</div>
</div>
<!-- ====== УПРАВЛЕНИЕ РАСПИСАНИЕМ ====== -->
<div class="page" data-title="🗓 Расписание" id="schedule-control">

<div id="schedule-control-container">
<div class="schedule-toolbar">
  <button class="button active" id="schedule-view-week" onclick="setScheduleView('week')">Неделя</button>
  <button class="button" id="schedule-view-day" onclick="setScheduleView('day')">День</button>
</div>
<div class="schedule-nav">
  <button class="nav-btn-mini" onclick="shiftScheduleDate(-1)">‹</button>
  <div class="date-label" id="schedule-date-label">—</div>
  <button class="nav-btn-mini" onclick="shiftScheduleDate(1)">›</button>
</div>
<div id="schedule-grid-container"></div>
<div class="schedule-detail-overlay" id="schedule-detail-overlay" onclick="closeScheduleDetail()"></div>
<div class="schedule-detail-modal" id="schedule-detail-modal">
  <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px;">
    <h4 style="margin: 0;">Детали занятия</h4>
    <button class="save-btn" style="padding: 6px 10px; background: #777;" onclick="closeScheduleDetail()">Закрыть</button>
  </div>
  <div id="schedule-detail-content" style="margin-top: 8px;"></div>
</div>

<div class="schedule-form" id="schedule-admin-form">
  <h4 style="margin: 0 0 8px 0;">Создать занятие</h4>
  <label class="label">Тип</label>
  <select class="form-input" id="schedule-object-type">
    <option value="group">Групповое</option>
    <option value="individual">Индивидуальное</option>
    <option value="rental">Аренда</option>
  </select>
  <label class="label">ID объекта</label>
  <input class="form-input" id="schedule-object-id" type="number" placeholder="ID объекта"/>
  <label class="label">Дата</label>
  <input class="form-input" id="schedule-date" type="date"/>
  <label class="label">Время от</label>
  <input class="form-input" id="schedule-time-from" type="time" step="1800"/>
  <label class="label">Время до</label>
  <input class="form-input" id="schedule-time-to" type="time" step="1800"/>
  <label class="label">Повторять до (по неделям)</label>
  <input class="form-input" id="schedule-repeat-until" type="date"/>
  <div style="display: flex; gap: 8px; margin-top: 10px;">
    <button class="save-btn" style="flex: 1;" onclick="createScheduleV2()">Создать</button>
    <button class="save-btn" style="flex: 1; background: #777;" onclick="closeScheduleForm()">Отмена</button>
  </div>
</div>

<button class="save-btn" style="width: 100%; margin-top: 12px; background: #2196F3;" onclick="toggleGroupScheduleForm()">➕ Добавить групповое занятие</button>
<div class="group-schedule-overlay" id="group-schedule-overlay" onclick="toggleGroupScheduleForm(false)"></div>
<div class="group-schedule-modal" id="group-schedule-modal">
  <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px;">
    <h4 style="margin: 0;">Групповое занятие</h4>
    <button class="save-btn" style="padding: 6px 10px; background: #777;" onclick="toggleGroupScheduleForm(false)">Закрыть</button>
  </div>
  <label class="label">Группа</label>
  <select class="form-input" id="group-schedule-group">
    <option value="">Выберите группу</option>
  </select>
  <div class="schedule-detail-card" id="group-schedule-preview" style="display: none;"></div>
  <label class="label">Дата</label>
  <input class="form-input" id="group-schedule-date" type="date"/>
  <div style="display: flex; gap: 8px;">
    <div style="flex: 1;">
      <label class="label">Время от</label>
      <input class="form-input" id="group-schedule-time-from" type="time" step="1800"/>
    </div>
    <div style="flex: 1;">
      <label class="label">Время до</label>
      <input class="form-input" id="group-schedule-time-to" type="time" step="1800"/>
    </div>
  </div>

  <div class="repeat-panel">
    <div class="repeat-row">
      <span style="font-size: 12px; font-weight: 600;">Повторять</span>
      <select class="form-input" id="repeat-mode" style="flex: 1;">
        <option value="none">Не повторять</option>
        <option value="weekly" selected>По неделям</option>
        <option value="daily">По дням</option>
        <option value="monthly">По месяцам</option>
      </select>
    </div>

    <div class="repeat-row repeat-inline" id="repeat-interval-row">
      <span>Каждую(ые)</span>
      <input class="form-input" id="repeat-interval" type="number" min="1" value="1"/>
      <span id="repeat-interval-label">неделю</span>
    </div>

    <div class="repeat-row" id="repeat-weekdays-row">
      <span class="chip" data-day="1">Пн</span>
      <span class="chip" data-day="2">Вт</span>
      <span class="chip" data-day="3">Ср</span>
      <span class="chip" data-day="4">Чт</span>
      <span class="chip" data-day="5">Пт</span>
      <span class="chip" data-day="6">Сб</span>
      <span class="chip" data-day="0">Вс</span>
    </div>

  <div class="repeat-row repeat-inline">
      <label class="label" style="margin: 0;">До</label>
      <input class="form-input" id="repeat-until" type="date"/>
  </div>

    <div class="repeat-summary" id="repeat-summary">Без повторения</div>
  </div>

  <div style="display: flex; gap: 8px; margin-top: 10px;">
    <button class="save-btn" style="flex: 1;" onclick="createGroupSchedule()">Создать</button>
    <button class="save-btn" style="flex: 1; background: #777;" onclick="toggleGroupScheduleForm(false)">Отмена</button>
  </div>
</div>
</div>
</div>
<!-- ====== НАПРАВЛЕНИЯ И ГРУППЫ ====== -->
<div class="page" data-title="📚 Направления и группы" id="directions-groups">

<div class="card" style="margin-bottom: 12px;">
<button class="save-btn" onclick="showPage('direction-create-form')" style="width: 100%;">➕ Создать направление</button>
</div>
<!-- ВКЛАДКИ -->
<div class="tabs-container" style="display: flex; gap: 8px; margin-bottom: 12px; border-bottom: 2px solid var(--border); position: relative;">
<button class="nav-tab" id="active-tab" onclick="switchDirectionTab('active')" style="flex: 1; padding: 12px; background: none; border: none; color: #2196F3; font-weight: bold; cursor: pointer;">✅ Активные</button>
<button class="nav-tab" id="archived-tab" onclick="switchDirectionTab('archived')" style="flex: 1; padding: 12px; background: none; border: none; color: var(--hint); font-weight: bold; cursor: pointer;">📦 Архив</button>
<div class="tab-indicator"></div>
</div>
<div id="directions-groups-container">
<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">⏳ Загрузка...</p>
</div>
</div>
<!-- ====== РАССЫЛКИ ====== -->
<div class="page" data-title="📧 Рассылки" id="mailings">

<button class="save-btn" onclick="showPage('mailing-create-form')" style="width: 100%; margin-bottom: 16px;">✉️ Создать новую рассылку</button>
<div id="mailings-container">
<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">⏳ Загрузка...</p>
</div>
</div>
<!-- ====== ФОРМА СОЗДАНИЯ РАССЫЛКИ ====== -->
<div class="page" data-title="✉️ Создать рассылку" id="mailing-create-form">

<!-- БЛОК 1: ОСНОВНЫЕ ДАННЫЕ -->
<div class="card" style="margin-bottom: 16px; border-left: 4px solid var(--accent);">
<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 14px; padding-bottom: 12px; border-bottom: 2px solid var(--border);">
<span style="font-size: 20px;">📝</span>
<h4 style="margin: 0;">Основные данные</h4>
</div>
<!-- Название рассылки -->
<label class="label" style="font-weight: 600;">Название рассылки</label>
<input class="form-input" id="mailing-name" placeholder="Например: Расписание смены" style="margin-bottom: 14px;" type="text"/>
<!-- Описание рассылки -->
<label class="label" style="font-weight: 600;">Описание</label>
<textarea class="form-input" id="mailing-description" placeholder="Описание рассылки..." style="margin-bottom: 14px; min-height: 80px; resize: vertical;"></textarea>
<!-- Назначение -->
<label class="label" style="font-weight: 600;">Назначение</label>
<input class="form-input" id="mailing-purpose" placeholder="Например: Информирование, Приглашение, Напоминание..." type="text"/>
</div>
<!-- БЛОК 2: КОМ ОТПРАВИТЬ -->
<div class="card" style="margin-bottom: 16px; border-left: 4px solid #2196F3;">
<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 14px; padding-bottom: 12px; border-bottom: 2px solid var(--border);">
<span style="font-size: 20px;">👥</span>
<h4 style="margin: 0;">Кому отправить</h4>
</div>
<!-- Тип кому отправлять -->
<label class="label" style="font-weight: 600;">Тип рассылки</label>
<select class="form-input" id="mailing-target-type" onchange="onMailingTargetTypeChange()" style="margin-bottom: 14px; font-size: 14px;">
<option value="">-- Выберите тип --</option>
<option value="all">🌍 Все пользователи</option>
<option value="user">👤 Выбранные пользователи</option>
<option value="group">👫 Группе НГ (от бота участникам группы)</option>
<option value="direction">💃 Направление</option>
<option value="tg_chat">📱 Telegram-группа/канал</option>
</select>
<!-- Контейнер для выбора пользователей -->
<div id="mailing-users-container" style="display: none;">
<label class="label" style="font-weight: 600;">🔍 Выбор пользователей</label>
<!-- Поиск пользователей -->
<input class="form-input" id="mailing-users-search" oninput="searchMailingUsers()" placeholder="Поиск по имени, ID или @юзернейм..." style="margin-bottom: 10px;" type="text"/>
<!-- Результаты поиска -->
<div id="mailing-users-search-results" style="max-height: 300px; overflow-y: auto; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 12px; padding: 8px;">
<p class="small" style="text-align: center; color: var(--hint); padding: 12px;">Загрузка пользователей...</p>
</div>
<!-- Выбранные пользователи -->
<div style="background: #f5f5f5; padding: 12px; border-radius: 8px;">
<label class="label" style="font-weight: 600; margin-bottom: 8px;">✓ Выбранные пользователи</label>
<div id="mailing-selected-users" style="display: flex; flex-wrap: wrap; gap: 8px; min-height: 32px; align-content: flex-start;">
<p class="small" style="color: var(--hint); width: 100%;">Выбрано: <span id="mailing-users-count" style="font-weight: 600;">0</span></p>
</div>
</div>
</div>
<!-- ID цели (для направлений и Telegram) -->
<div id="mailing-target-id-container" style="display: none;">
<label class="label" style="font-weight: 600;">ID направления/группы Telegram</label>
<input class="form-input" id="mailing-target-id" placeholder="Введите ID" type="number"/>
</div>
</div>
<!-- БЛОК 3: ВРЕМЯ ОТПРАВКИ -->
<div class="card" style="margin-bottom: 16px; border-left: 4px solid #4CAF50;">
<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 14px; padding-bottom: 12px; border-bottom: 2px solid var(--border);">
<span style="font-size: 20px;">⏰</span>
<h4 style="margin: 0;">Время отправки</h4>
</div>
<!-- Выбор времени отправки -->
<label class="label" style="font-weight: 600; margin-bottom: 10px;">Когда отправить</label>
<div style="display: flex; gap: 10px; margin-bottom: 14px;">
<button class="save-btn" id="send-now-btn" onclick="setMailingSendNow(true)" style="flex: 1; background: var(--accent); font-weight: 600; padding: 12px;">▶️ Сейчас</button>
<button class="save-btn" onclick="setMailingSendNow(false)" style="flex: 1; background: var(--hint); font-weight: 600; padding: 12px;">⏲️ Позже</button>
</div>
<!-- Дата и время для отложенной отправки -->
<div id="mailing-schedule-container" style="display: none;">
<label class="label" style="font-weight: 600;">Дата и время отправки</label>
<input class="form-input" id="mailing-scheduled-at" type="datetime-local"/>
</div>
</div>
<!-- КНОПКА СОЗДАНИЯ -->
<div class="card" style="background: linear-gradient(135deg, var(--accent) 0%, #c2185b 100%); padding: 0; border: none;">
<button class="save-btn" onclick="createMailing()" style="width: 100%; background: transparent; color: white; font-size: 16px; font-weight: 600; padding: 16px; border: none; cursor: pointer;">✉️ Создать рассылку</button>
</div>
</div>
<!-- ====== ОБЪЯВЛЕНИЯ (СТАРОЕ) ====== -->
<div class="page" data-title="Объявления" id="announcements" style="display: none;">

<button class="save-btn" style="width: 100%; margin-bottom: 16px;">📝 Создать объявление</button>
<div id="announcements-container">
<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">⏳ Загрузка...</p>
</div>
</div>
<!-- ====== УПРАВЛЕНИЕ НОВОСТЯМИ ====== -->
<div class="page" data-title="📰 Новости" id="news-manage">

<button class="save-btn" onclick="showPage('news-add-form')" style="width: 100%; margin-bottom: 16px;">✍️ Создать новость</button>
<div id="news-manage-container">
<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">⏳ Загрузка...</p>
</div>
</div>
<!-- ====== ФОРМА ДОБАВЛЕНИЯ НОВОСТИ ====== -->
<div class="page" data-title="📝 Создать новость" id="news-add-form">

<button class="save-btn" onclick="openBotForCreateNews()" style="width: 100%; padding: 20px; font-size: 16px;">📝 Создать новость через бота</button>
</div>
<!-- ====== УПРАВЛЕНИЕ ПЕРСОНАЛОМ (ИЗ РАБОТЫ) ====== -->
<div class="page" data-title="👥 Персонал" id="staff-manage">

<button class="save-btn" onclick="showAddStaffForm()" style="width: 100%; margin-bottom: 16px;">➕ Добавить персонал</button>
<div class="card" style="margin-bottom: 16px;">
<h4>🔍 Поиск персонала</h4>
<input class="form-input" id="staff-manage-search" oninput="searchStaffManage()" placeholder="Имя, ID или @юзернейм" style="margin-top: 8px;" type="text"/>
</div>
<div id="staff-manage-container">
<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">⏳ Загрузка...</p>
</div>
</div>
<!-- ====== КЛИЕНТЫ ====== -->
<div class="page" data-title="👨‍👩‍👧‍👦 Клиенты" id="clients-list">

<div class="card">
<h4>🔍 Поиск клиента</h4>
<input class="form-input" placeholder="Введите имя или Telegram ID..." style="margin-bottom: 12px;" type="text"/>
</div>
<div id="clients-list-container">
<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">⏳ Загрузка...</p>
</div>
</div>
<!-- ====== ПРОФИЛЬ ====== -->
<div class="page" data-title="👤 Профиль" id="profile">
<div class="profile">
<div class="avatar" id="avatar"></div>
<h3 id="profile-name">—</h3>
<p class="small" id="profile-username">—</p>
</div>
<div class="menu-item" onclick="showPage('profile-info')">📋 Личная информация</div>
<div class="menu-item" onclick="showPage('profile-transactions')">💳 Транзакции</div>
<div class="menu-item" onclick="showPage('profile-abonements')">🎟️ Абонементы</div>
<div class="menu-item" onclick="showPage('profile-groups')">👥 Группы</div>
</div>
<div class="page" data-title="📋 Личная информация" id="profile-info">
<div class="card">
<h4>Личная информация</h4>
<div class="form-group">
<label>Имя</label>
<input class="form-input" id="profile-input-name" placeholder="Ваше имя" type="text"/>
</div>
<div class="form-group">
<label>Телефон</label>
<input class="form-input" id="profile-input-phone" placeholder="+7 800 555 35 35" type="tel"/>
</div>
<div class="form-group">
<label>Email</label>
<input class="form-input" id="profile-input-email" placeholder="example@mail.com" type="email"/>
</div>
<div class="form-group">
<label>Дата рождения</label>
<input class="form-input" id="profile-input-birth-date" type="date"/>
</div>
<div class="form-group">
<label>Ваши пожелания</label>
<textarea class="form-input" id="profile-input-user-notes" placeholder="Напишите ваши пожелания и предпочтения..." rows="3"></textarea>
</div>
<button class="save-btn" onclick="saveProfileChanges()">💾 Сохранить изменения</button>
</div>
<div class="card">
<h4>Информация об аккаунте</h4>
<p class="small"><strong>Статус:</strong> <span id="profile-status">—</span></p>
<p class="small"><strong>Дата регистрации:</strong> <span id="profile-registered">—</span></p>
</div>
</div>
<div class="page" data-title="💳 Транзакции" id="profile-transactions">
<div id="profile-transactions-container">
<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">Загрузка...</p>
</div>
</div>
<div class="page" data-title="🎟️ Абонементы" id="profile-abonements">
<div id="profile-abonements-container">
<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">Загрузка...</p>
</div>
</div>
<div class="page" data-title="👥 Группы" id="profile-groups">
<div id="profile-groups-container">
<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">Загрузка...</p>
</div>
</div>
<!-- ====== РАСПИСАНИЕ ПЕРСОНАЛА ====== -->
<div class="page" data-title="📅 Расписание сотрудника" id="staff-schedule">

<div id="staff-schedule-container">
<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">⏳ Загрузка...</p>
</div>
<!-- Кнопка создания занятия для учителя -->
<div id="teacher-create-btn-container" style="display: none; padding: 16px; padding-top: 0;">
<button class="save-btn" onclick="openCreateSchedule()" style="width: 100%;">➕ Создать занятие</button>
</div>
</div>
<!-- ====== СОЗДАНИЕ/РЕДАКТИРОВАНИЕ ЗАНЯТИЯ ====== -->
<div class="page" data-title="🗓 Занятие" id="schedule-form">

<div class="card">
<div class="form-group">
<label>Название занятия</label>
<input class="form-input" id="schedule-input-title" placeholder="Балет, Хип-хоп и т.д." type="text"/>
</div>
<div class="form-group">
<label>Преподаватель</label>
<select class="form-input" id="schedule-input-teacher">
<option value="">Выберите преподавателя</option>
</select>
</div>
<div class="form-group">
<label>Дата</label>
<input class="form-input" id="schedule-input-date" type="date"/>
</div>
<div class="form-group">
<label>Время начала</label>
<input class="form-input" id="schedule-input-start" type="time"/>
</div>
<div class="form-group">
<label>Время окончания</label>
<input class="form-input" id="schedule-input-end" type="time"/>
</div>
<div style="display: flex; gap: 8px;">
<button class="save-btn" onclick="saveSchedule()" style="flex: 1;">💾 Сохранить</button>
<button class="save-btn" id="schedule-delete-btn" onclick="deleteSchedule()" style="flex: 1; background: #ff6b6b; display: none;">🗑️ Удалить</button>
</div>
</div>
</div>
<!-- ====== УПРАВЛЕНИЕ ПЕРСОНАЛОМ ====== -->
<div class="page" data-title="👥 Персонал" id="staff-management">

<button class="save-btn" onclick="showAddStaffForm()" style="width: 100%; margin-bottom: 12px;">➕ Добавить персонал</button>
<div id="staff-list-container">
<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">⏳ Загрузка...</p>
</div>
</div>
<!-- ====== ФОРМА ДОБАВЛЕНИЯ ПЕРСОНАЛА ====== -->
<div class="page" data-title="➕ Добавить персонал" id="staff-add-form">

<div class="card">
<div class="form-group">
<label>🔍 Поиск пользователя</label>
<input class="form-input" id="staff-user-search" oninput="searchForStaffUser()" placeholder="Имя, ID или @юзер" type="text"/>
</div>
<div id="staff-user-search-results" style="max-height: 280px; overflow-y: auto; margin-bottom: 16px; border-radius: 8px; background: var(--card); padding: 8px; border: 1px solid var(--border);">
<p class="small" style="text-align: center; color: var(--hint); padding: 16px 0;">Начните вводить для поиска...</p>
</div>
</div>
<!-- Общие поля для обоих способов -->
<div class="card">
<div class="form-group">
<label>Должность *</label>
<select class="form-input" id="staff-add-position" onchange="updateStaffTeachesToggle()">
<option value="">Выберите должность</option>
<option value="учитель">👩‍🏫 Учитель</option>
<option value="администратор">📋 Администратор</option>
</select>
</div>


<div class="form-group">
<label>👩‍🏫 Преподает</label>
<label style="display: inline-flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text);">
<input id="staff-add-teaches" type="checkbox"/>
<span>Преподаватель</span>
</label>
</div>
<div class="form-group">
<label>Специализация (опционально)</label>
<input class="form-input" id="staff-add-specialization" placeholder="Балет, Хип-хоп и т.д." type="text"/>
</div>
<div class="form-group">
<label>Биография (опционально)</label>
<textarea class="form-input" id="staff-add-bio" placeholder="Описание сотрудника" style="height: 80px; resize: none;"></textarea>
</div>
<label style="display: inline-flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text); margin-bottom: 12px;">
<input id="staff-add-notify" type="checkbox" checked/>
<span>Отправить уведомление в Telegram</span>
</label>
<button class="save-btn" onclick="saveNewStaff()" style="width: 100%; margin-top: 12px;">💾 Добавить персонал</button>
</div>
</div>
<!-- ====== СТРАНИЦА ПЕРСОНАЛА ====== -->
<div class="page" id="staff-detail">
<div class="profile">
<div class="avatar" id="staff-detail-avatar">
<img alt="Фото" id="staff-detail-avatar-img" src="" style="display: none;"/>
<p style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--hint); margin: 0;">👤</p>
</div>
<h3 id="staff-detail-name">—</h3>
<p class="small" id="staff-detail-position">—</p>
</div>
<div class="card">
<h4>📋 Информация</h4>
<div style="margin-bottom: 12px;">
<label style="font-size: 12px; color: var(--hint);">Должность</label>
<div id="staff-detail-position-full" style="font-size: 15px; margin-top: 4px;">—</div>
</div>
<div id="staff-detail-phone-block" style="margin-bottom: 12px; display: none;">
<label style="font-size: 12px; color: var(--hint);">Телефон</label>
<div id="staff-detail-phone" style="font-size: 15px; margin-top: 4px;">—</div>
</div>
<div style="margin-bottom: 12px;">
<label style="font-size: 12px; color: var(--hint);">Email</label>
<div id="staff-detail-email" style="font-size: 15px; margin-top: 4px;">—</div>
</div>
<div style="margin-bottom: 12px;">
<label style="font-size: 12px; color: var(--hint);">Специализация</label>
<div id="staff-detail-specialization" style="font-size: 15px; margin-top: 4px;">—</div>
</div>
<div style="margin-bottom: 12px;">
<label style="font-size: 12px; color: var(--hint);">Статус</label>
<div id="staff-detail-status" style="font-size: 15px; margin-top: 4px;">—</div>
</div>
</div>
<div class="card">
<h4>📝 Биография</h4>
<p id="staff-detail-bio" style="white-space: pre-wrap; line-height: 1.5;">—</p>
</div>
<button class="save-btn" onclick="deleteCurrentStaff()" style="width: 100%; background: #ff6b6b;">🗑️ Удалить персонал</button>
</div>
<!-- ====== ФОРМА СОЗДАНИЯ НАПРАВЛЕНИЯ ====== -->
<div class="page" data-title="➕ Создать направление" id="direction-create-form">

<div class="card" style="margin-bottom: 16px; border-left: 4px solid var(--accent);">
<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 14px; padding-bottom: 12px; border-bottom: 2px solid var(--border);">
<span style="font-size: 20px;">📝</span>
<h4 style="margin: 0;">Основная информация</h4>
</div>
<!-- Название -->
<label class="label" style="font-weight: 600;">Название направления *</label>
<input class="form-input" id="direction-title" placeholder="Например: Балет, Хип-хоп, Современный танец" style="margin-bottom: 14px;" type="text"/>
<!-- Описание -->
<label class="label" style="font-weight: 600;">Описание *</label>
<textarea class="form-input" id="direction-description" placeholder="Опишите направление..." style="margin-bottom: 14px; min-height: 100px; resize: vertical;"></textarea>
<!-- Цена -->
<label class="label" style="font-weight: 600;">Базовая цена (₽) *</label>
<input class="form-input" id="direction-price" placeholder="Например: 5000" style="margin-bottom: 14px;" type="number"/>
</div>
<div class="card" style="margin-bottom: 16px; border-left: 4px solid #4CAF50;">
<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 14px; padding-bottom: 12px; border-bottom: 2px solid var(--border);">
<span style="font-size: 20px;">📸</span>
<h4 style="margin: 0;">Фотография</h4>
</div>
<!-- Статус загрузки -->
<div id="direction-photo-status" style="padding: 12px; background: #f0f0f0; border-radius: 8px; margin-bottom: 12px; text-align: center;">
<p style="margin: 0; color: var(--hint); font-size: 14px;">❌ Фотография не загружена</p>
</div>
<!-- Кнопка для получения токена -->
<button class="save-btn" id="direction-upload-btn" onclick="generateDirectionUploadToken()" style="width: 100%; margin-bottom: 8px; background: #2196F3;">
      📱 Загрузить фото через бот
    </button>
<p style="font-size: 12px; color: var(--hint); margin: 0; line-height: 1.5;">
      💡 Нажмите кнопку, скопируйте токен, отправьте его боту и загрузите фотографию. После этого кнопка активируется.
    </p>
</div>
<button class="save-btn" id="direction-create-btn" onclick="createDirection()" style="width: 100%; margin-bottom: 8px; background: #4CAF50;">
    ✅ Создать направление
  </button>
<button class="save-btn" onclick="goBack()" style="width: 100%; background: #777;">
    ❌ Отменить
  </button>
<!-- Сообщение об ошибке -->
<div id="direction-error-msg" style="margin-top: 12px; padding: 12px; background: #ffebee; border-radius: 8px; color: #c62828; display: none;">
<p id="direction-error-text" style="margin: 0;"></p>
</div>
<!-- Сообщение об успехе -->
<div id="direction-success-msg" style="margin-top: 12px; padding: 12px; background: #e8f5e9; border-radius: 8px; color: #2e7d32; display: none;">
<p id="direction-success-text" style="margin: 0;"></p>
</div>
</div>
<!-- ====== РЕДАКТИРОВАНИЕ НАПРАВЛЕНИЯ ====== -->
<div class="page" data-title="✏️ Редактировать направление" id="direction-edit-form">
<div class="direction-edit-header">

<button class="lock-btn" id="direction-edit-lock-btn" onclick="toggleDirectionEditLock()" title="Разблокировать редактирование">🔓</button>
</div>
<p class="small" id="direction-edit-lock-hint" style="margin: 6px 0 12px 0;">Поля заблокированы, чтобы избежать случайных изменений.</p>
<!-- ГРУППЫ -->
<div class="card" style="margin-bottom: 16px; border-left: 4px solid #FF9800;">
<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 14px; padding-bottom: 12px; border-bottom: 2px solid var(--border);">
<span style="font-size: 20px;">👥</span>
<h4 style="margin: 0; flex: 1;">Группы</h4>
<button class="lock-btn" onclick="openCreateGroupPage()" title="Создать группу">➕</button>
</div>
<div id="edit-direction-groups-list" style="display: flex; flex-direction: column; gap: 8px;">
<p style="text-align: center; color: var(--hint); padding: 12px; margin: 0;">⏳ Загрузка групп...</p>
</div>
</div>
<!-- ОСНОВНАЯ ИНФОРМАЦИЯ -->
<div class="card direction-lockable" style="margin-bottom: 16px; border-left: 4px solid var(--accent);">
<div aria-hidden="true" class="lock-overlay"></div>
<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 14px; padding-bottom: 12px; border-bottom: 2px solid var(--border);">
<span style="font-size: 20px;">📝</span>
<h4 style="margin: 0;">Основная информация</h4>
</div>
<!-- Название -->
<label class="label" style="font-weight: 600;">Название направления *</label>
<input class="form-input direction-editable" id="edit-direction-title" placeholder="Например: Балет, Хип-хоп, Современный танец" style="margin-bottom: 14px;" type="text"/>
<!-- Описание -->
<label class="label" style="font-weight: 600;">Описание *</label>
<textarea class="form-input direction-editable" id="edit-direction-description" placeholder="Опишите направление..." style="margin-bottom: 14px; min-height: 100px; resize: vertical;"></textarea>
<!-- Цена -->
<label class="label" style="font-weight: 600;">Базовая цена (₽) *</label>
<input class="form-input direction-editable" id="edit-direction-price" placeholder="Например: 5000" style="margin-bottom: 14px;" type="number"/>
<!-- Статус -->
<label class="label" style="font-weight: 600;">Статус</label>
<select class="form-input direction-editable" id="edit-direction-status" style="margin-bottom: 14px;">
<option value="active">✅ Активное</option>
<option value="inactive">⏸️ Неактивное</option>
</select>
</div>
<!-- ФОТОГРАФИЯ -->
<div class="card direction-lockable" style="margin-bottom: 16px; border-left: 4px solid #4CAF50;">
<div aria-hidden="true" class="lock-overlay"></div>
<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 14px; padding-bottom: 12px; border-bottom: 2px solid var(--border);">
<span style="font-size: 20px;">📸</span>
<h4 style="margin: 0;">Фотография</h4>
</div>
<div id="edit-direction-photo-preview" style="width: 100%; height: 150px; background: #f0f0f0; border-radius: 8px; margin-bottom: 12px; display: flex; align-items: center; justify-content: center; color: var(--hint); overflow: hidden;">
      📸 Фото не загружено
    </div>
<button class="save-btn direction-editable" onclick="generateDirectionUploadToken()" style="width: 100%; margin-bottom: 8px; background: #2196F3;">
      📱 Загрузить новое фото через бот
    </button>
</div>
<!-- КНОПКИ ДЕЙСТВИЯ -->
<div class="direction-lockable" style="margin-bottom: 12px;">
<div aria-hidden="true" class="lock-overlay"></div>
<button class="save-btn direction-editable" id="direction-save-btn" onclick="saveDirectionChanges()" style="width: 100%; margin-bottom: 8px; background: #4CAF50;">
      ✅ Сохранить изменения
    </button>
<button class="save-btn" onclick="goBack()" style="width: 100%; background: #777;">
      ❌ Отменить
    </button>
</div>
<!-- Сообщение об ошибке -->
<div id="edit-direction-error-msg" style="margin-top: 12px; padding: 12px; background: #ffebee; border-radius: 8px; color: #c62828; display: none;">
<p id="edit-direction-error-text" style="margin: 0;"></p>
</div>
<!-- Сообщение об успехе -->
<div id="edit-direction-success-msg" style="margin-top: 12px; padding: 12px; background: #e8f5e9; border-radius: 8px; color: #2e7d32; display: none;">
<p id="edit-direction-success-text" style="margin: 0;"></p>
</div>
</div>
<!-- ====== РЕДАКТИРОВАНИЕ РАБОЧЕГО ПРОФИЛЯ ====== -->
<div class="page" data-title="👤 Профиль персонала" id="staff-profile-edit">

<div class="card">
<div class="form-group">
<label>Имя</label>
<input class="form-input" id="staff-profile-name" placeholder="Имя" type="text"/>
</div>
<div class="form-group">
<label>Специализация</label>
<input class="form-input" id="staff-profile-specialization" placeholder="Например: Балет, Хип‑хоп" type="text"/>
</div>
<div class="form-group">
<label>Биография</label>
<textarea class="form-input" id="staff-profile-bio" placeholder="Коротко о себе..." style="min-height: 80px;"></textarea>
</div>
<div class="form-group" id="staff-profile-teaches-group" style="display: none;">
<label>👩‍🏫 Преподаёт</label>
<label style="display: inline-flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text);">
<input id="staff-profile-teaches" type="checkbox"/>
<span>Преподаватель</span>
</label>
</div>
<div class="form-group">
<label>Телефон</label>
<input class="form-input" id="staff-profile-phone" placeholder="+7 900 000 00 00" type="text"/>
</div>
<div class="form-group">
<label>Email</label>
<input class="form-input" id="staff-profile-email" placeholder="name@example.com" type="email"/>
</div>
<input id="staff-profile-photo-input" type="file" accept="image/*" style="display: none;" onchange="uploadStaffPhotoFromGallery()"/>
<button class="save-btn" onclick="openStaffPhotoPicker()" style="width: 100%; margin-top: 8px;">
      📸 Загрузить фото
    </button>
<button class="save-btn" onclick="saveStaffProfile()" style="width: 100%; margin-top: 8px;">
      💾 Сохранить
    </button>
</div>
<div class="card" style="margin-top: 12px;">
<h4 style="margin-bottom: 10px;">График работы</h4>
<button class="save-btn" onclick="openTeacherWorkingHours()" style="width: 100%;">🗓 Открыть график работы</button>
</div>
</div>
<!-- ====== РАБОЧИЕ ЧАСЫ ПРЕПОДАВАТЕЛЯ ====== -->
<div class="page" data-title="🗓 Рабочие часы" id="teacher-working-hours">
<div class="card" style="margin-bottom: 12px;">
  <div class="schedule-toolbar">
    <button class="button active" id="working-hours-view-week" onclick="setWorkingHoursView('week')">Неделя</button>
    <button class="button" id="working-hours-view-day" onclick="setWorkingHoursView('day')">День</button>
  </div>
  <div class="form-group" id="working-hours-day-select-group" style="display: none; margin-top: 12px;">
    <label>День недели</label>
    <select class="form-input" id="working-hours-day-select" onchange="renderWorkingHoursEditor()">
      <option value="0">Понедельник</option>
      <option value="1">Вторник</option>
      <option value="2">Среда</option>
      <option value="3">Четверг</option>
      <option value="4">Пятница</option>
      <option value="5">Суббота</option>
      <option value="6">Воскресенье</option>
    </select>
  </div>
</div>
<div id="working-hours-container"></div>
<div class="card" style="margin-top: 12px;">
  <button class="save-btn" onclick="saveTeacherWorkingHours()" style="width: 100%; background: #4CAF50;">✅ Сохранить рабочие часы</button>
  <button class="save-btn" onclick="goBack()" style="width: 100%; margin-top: 8px; background: #777;">❌ Назад</button>
</div>
</div>
<!-- ====== СОЗДАНИЕ ГРУППЫ ====== -->
<div class="page" data-title="➕ Создать группу" id="direction-group-create">

<div class="card" style="margin-bottom: 16px; border-left: 4px solid #FF9800;">
<div class="form-group">
<label>Название группы *</label>
<input class="form-input" id="edit-direction-group-name" placeholder="Например: Дети 10-12, Хип‑хоп Beginners" type="text"/>
</div>
<div class="form-group">
<label>Преподаватель *</label>
<input class="form-input" id="group-teacher-search" oninput="searchGroupTeacher()" placeholder="Имя, ID или @юзер" type="text"/>
</div>
<div id="group-teacher-search-results" style="max-height: 240px; overflow-y: auto; margin-bottom: 12px; border-radius: 8px; background: var(--card); padding: 8px; border: 1px solid var(--border);">
<p class="small" style="text-align: center; color: var(--hint); padding: 12px 0;">Начните вводить для поиска...</p>
</div>
<div class="form-group">
<label>Возрастная группа *</label>
<input class="form-input" id="edit-direction-group-age" placeholder="Например: 12-16" type="text"/>
</div>
<div class="form-group">
<label>Макс. учеников *</label>
<input class="form-input" id="edit-direction-group-max" placeholder="Например: 12" type="number"/>
</div>
<div class="form-group">
<label>Длительность (мин) *</label>
<input class="form-input" id="edit-direction-group-duration" placeholder="Например: 60" type="number"/>
</div>
<div class="form-group">
<label>Занятий в неделю</label>
<input class="form-input" id="edit-direction-group-lessons" placeholder="Например: 3" type="number" min="1"/>
</div>
<div class="form-group">
<label>Описание</label>
<textarea class="form-input" id="edit-direction-group-desc" placeholder="Коротко о группе..." style="min-height: 80px;"></textarea>
</div>
<button class="save-btn" onclick="createDirectionGroup()" style="width: 100%; margin-bottom: 8px; background: #FF9800;">
      ➕ Создать группу
    </button>
<button class="save-btn" onclick="goBack()" style="width: 100%; background: #777;">
      ❌ Отменить
    </button>
<div id="edit-direction-group-msg" style="margin: 12px 0 0 0; padding: 10px; border-radius: 8px; display: none;"></div>
</div>
</div>
<!-- ====== РЕДАКТИРОВАНИЕ ГРУППЫ ====== -->
<div class="page" data-title="✏️ Редактировать группу" id="direction-group-edit">

<div class="card" style="margin-bottom: 16px; border-left: 4px solid #4CAF50;">
<div class="form-group">
<label>Название группы *</label>
<input class="form-input" id="edit-group-name" placeholder="Название группы" type="text"/>
</div>
<div class="form-group">
<label>Преподаватель *</label>
<input class="form-input" id="edit-group-teacher-search" oninput="searchEditGroupTeacher()" placeholder="Имя, ID или @юзер" type="text"/>
</div>
<div id="edit-group-teacher-search-results" style="max-height: 240px; overflow-y: auto; margin-bottom: 12px; border-radius: 8px; background: var(--card); padding: 8px; border: 1px solid var(--border);">
<p class="small" style="text-align: center; color: var(--hint); padding: 12px 0;">⏳ Загрузка преподавателей...</p>
</div>
<div class="form-group">
<label>Возрастная группа *</label>
<input class="form-input" id="edit-group-age" placeholder="Например: 12-16" type="text"/>
</div>
<div class="form-group">
<label>Макс. учеников *</label>
<input class="form-input" id="edit-group-max" placeholder="Например: 12" type="number"/>
</div>
<div class="form-group">
<label>Длительность (мин) *</label>
<input class="form-input" id="edit-group-duration" placeholder="Например: 60" type="number"/>
</div>
<div class="form-group">
<label>Занятий в неделю</label>
<input class="form-input" id="edit-group-lessons" placeholder="Например: 3" type="number" min="1"/>
</div>
<div class="form-group">
<label>Описание</label>
<textarea class="form-input" id="edit-group-desc" placeholder="Коротко о группе..." style="min-height: 80px;"></textarea>
</div>
<button class="save-btn" onclick="saveGroupChanges()" style="width: 100%; margin-bottom: 8px; background: #4CAF50;">
      ✅ Сохранить изменения
    </button>
<button class="save-btn" onclick="goBack()" style="width: 100%; background: #777;">
      ❌ Отменить
    </button>
<div id="edit-group-msg" style="margin: 12px 0 0 0; padding: 10px; border-radius: 8px; display: none;"></div>
</div>
</div>
<div class="page" data-title="ℹ️ Информация" id="info">

<h3 id="info-title" style="display: none;"></h3>
<p class="small" id="info-placeholder">Раздел находится в разработке</p>
<div id="info-directions-container" style="display: none;"></div>
</div>
<div class="page" data-title="🎯 Направление" id="direction-detail">
  <div id="direction-detail-content"></div>
</div>
<div class="page" data-title="⏱️ Индивидуальные занятия" id="info-individual">
<p class="small">Раздел находится в разработке</p>
</div>
<div class="page" data-title="🔑 Аренда зала" id="info-rent">
<p class="small">Раздел находится в разработке</p>
</div>
<!-- ====== ПРОСМОТР НОВОСТИ ====== -->
<div class="page" id="news-detail">
<div class="news-detail-header">
<div class="news-detail-back" onclick="goBack()">←</div>
<h3 class="news-detail-title-header">Новости</h3>
</div>
<div id="news-detail-photo-container"></div>
<div class="news-detail-content-wrapper">
<h3 id="news-detail-title"></h3>
<p class="small" id="news-detail-date"></p>
<p id="news-detail-content" style="white-space: pre-wrap;"></p>
</div>
</div>
<div class="confirm-modal-overlay" id="staff-delete-overlay" onclick="closeStaffDeleteModal()"></div>
<div class="confirm-modal" id="staff-delete-modal">
<h4 style="margin: 0 0 6px 0;">Вы действительно хотите удалить?</h4>
<p class="small" id="staff-delete-subtitle" style="margin: 0 0 12px 0; color: var(--hint);">—</p>
<label style="display: inline-flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text); margin-bottom: 12px;">
<input id="staff-delete-notify" type="checkbox" checked/>
<span>Отправить оповещение</span>
</label>
<div style="display: flex; gap: 8px;">
<button class="save-btn" onclick="confirmStaffDelete()" style="flex: 1; background: #ef5350;">Удалить</button>
<button class="save-btn" onclick="closeStaffDeleteModal()" style="flex: 1; background: var(--card); color: var(--text);">Отмена</button>
</div>
</div>
<!-- ====== НИЖНЕЕ МЕНЮ ====== -->
<div class="bottom-nav">
<div class="nav-btn active" onclick="showPage('home')">🏠<br/>Главная</div>
<div class="nav-btn" onclick="showPage('schedule')">🗓<br/>Расписание</div>
<div class="nav-btn hidden" id="staff-nav-btn" onclick="showPage('staff')">👨‍💼<br/>Работа</div>
<div class="nav-btn" onclick="showPage('profile')">👤<br/>Профиль</div>
</div>
<script>
/* ====== TELEGRAM ====== */
const tg = window.Telegram?.WebApp;
if (tg && typeof tg.ready === 'function') {
  tg.ready();
}

function getAuthHeaders(extraHeaders = {}) {
  const telegramId = tg.initDataUnsafe?.user?.id;
  const headers = { ...extraHeaders };
  if (telegramId) {
    headers['X-Telegram-Id'] = telegramId;
  }
  return headers;
}

function updateSafeAreaVars() {
  const inset = tg.safeAreaInset || tg.contentSafeAreaInset || {};
  const top = Number(inset.top) || 0;
  const bottom = Number(inset.bottom) || 0;
  document.documentElement.style.setProperty('--safe-top', `${top}px`);
  document.documentElement.style.setProperty('--safe-bottom', `${bottom}px`);
}

function initMobileViewport() {
  const platform = tg.platform;
  const isMobile = platform === 'android' || platform === 'ios';
  if (!isMobile) return;

  document.body.classList.add('tg-mobile');

  try {
    if (!tg.isExpanded) {
      tg.expand();
    }
  } catch (err) {
    // ignore expand errors
  }

  if (typeof tg.requestFullscreen === 'function') {
    setTimeout(() => {
      try {
        tg.requestFullscreen();
      } catch (err) {
        // ignore fullscreen errors
      }
    }, 200);
  }
}

initMobileViewport();
updateSafeAreaVars();
if (typeof tg.onEvent === 'function') {
  tg.onEvent('viewportChanged', updateSafeAreaVars);
}
tg.expand();

/* ====== НАВИГАЦИЯ ====== */
const ROOT_PAGES = ['home', 'schedule', 'staff', 'profile'];
let currentPageId = 'home';

const header = document.getElementById('header');
const headerTitle = document.getElementById('header-title');
const headerBack = document.getElementById('header-back');
const hasTelegramBackButton = typeof tg.BackButton !== 'undefined';

if (hasTelegramBackButton && typeof tg.BackButton.onClick === 'function') {
  tg.BackButton.onClick(() => {
    goBack();
  });
}
const pageTitleCache = {
  home: 'LISSA DANCE',
  schedule: 'LISSA DANCE',
  staff: 'Работа',
  profile: 'LISSA DANCE'
};

function setHeaderTitle(title) {
  if (!headerTitle) return;
  headerTitle.textContent = title;
  pageTitleCache[currentPageId] = title;
}

function setHeaderBackVisible(isVisible) {
  if (!headerBack) return;
  headerBack.style.visibility = isVisible ? 'visible' : 'hidden';
  headerBack.style.pointerEvents = isVisible ? 'auto' : 'none';
}

function syncTelegramBackButton(isVisible) {
  if (hasTelegramBackButton) {
    if (isVisible) {
      tg.BackButton.show();
    } else {
      tg.BackButton.hide();
    }
    if (headerBack) {
      headerBack.style.display = 'none';
    }
  } else if (headerBack) {
    headerBack.style.display = '';
  }
}

function applyHeaderForPage(pageId) {
  currentPageId = pageId;
  const isRoot = ROOT_PAGES.includes(pageId);
  setHeaderBackVisible(!isRoot);
  syncTelegramBackButton(!isRoot);

  const page = document.getElementById(pageId);
  if (!page) return;
  const dataTitle = page.getAttribute('data-title');
  if (dataTitle) {
    let brandEl = page.querySelector('.brand-header');
    if (!brandEl) {
      brandEl = document.createElement('div');
      brandEl.className = 'brand-header';
      brandEl.innerHTML = `
        <div class="brand-row">
          <div class="brand-avatar"></div>
          <div class="brand-name"></div>
        </div>
        <h2 class="page-title"></h2>
      `;
      page.insertBefore(brandEl, page.firstChild);
    }
    const brandNameEl = brandEl.querySelector('.brand-name');
    if (brandNameEl) {
      brandNameEl.textContent = dataTitle;
    }

    const titleEl = brandEl.querySelector('.page-title');
    if (titleEl) {
      titleEl.textContent = '';
      titleEl.style.display = 'none';
    }
    pageTitleCache[pageId] = dataTitle;
  }
}

// Стек для навигации (история переходов)
let navigationStack = ['home'];
applyHeaderForPage('home');

function showPage(id) {
  // Получаем текущую страницу
  const currentPage = Array.from(document.querySelectorAll('.page')).find(p => p.classList.contains('active'));
  
  // Если переходим на другую страницу, добавляем текущую в стек
  if (currentPage && currentPage.id !== id) {
    navigationStack.push(id);
  }
  
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(id).classList.add('active');

  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  const index = ROOT_PAGES.indexOf(id);
  if (index >= 0) {
    document.querySelectorAll('.nav-btn')[index].classList.add('active');
  }

  applyHeaderForPage(id);
  
  // Загружаем данные для вкладки "Работы"
  if (id === 'staff') {
    loadAllClients();
  }
  
  // Загружаем расписание для вкладки "Расписание"
  if (id === 'schedule') {
    loadPublicSchedule();
  }
  
  // Загружаем список персонала для управления
  if (id === 'staff-manage') {
    setHeaderTitle('👥 Управление персоналом');
    loadStaffList();
  }
  
  // Загружаем список персонала для управления (старая версия)
  if (id === 'staff-management') {
    setHeaderTitle('👥 Управление персоналом');
    loadStaffList();
  }
  
  // Загружаем список новостей для управления
  if (id === 'news-manage') {
    setHeaderTitle('📰 Новости');
    loadNewsManage();
  }
  
  // Инициализируем preview фотографии для новостей
  if (id === 'news-add-form') {
    initNewsPhotoPreview();
  }
  
  // Загружаем список направлений для управления
  if (id === 'directions-groups') {
    setHeaderTitle('🎭 Направления и группы');
    loadDirections();
    
    // Инициализируем индикатор вкладок
    setTimeout(() => {
      const activeTab = document.getElementById('active-tab');
      const indicator = document.querySelector('.tab-indicator');
      if (indicator && activeTab) {
        indicator.style.width = activeTab.offsetWidth + 'px';
        indicator.style.transform = `translateX(${activeTab.offsetLeft}px)`;
      }
    }, 0);
  }
  if (id === 'profile-info') {
    setHeaderTitle('Личная информация');
  }

  if (id === 'profile-transactions') {
    setHeaderTitle('Транзакции');
    loadProfileTransactions();
  }

  if (id === 'profile-abonements') {
    setHeaderTitle('Абонементы');
    loadProfileAbonements();
  }

  if (id === 'profile-groups') {
    setHeaderTitle('Группы');
    loadProfileGroups();
  }

}

function openInfo(title) {
  showPage('info');
  document.getElementById('info-title').innerText = title;
  setHeaderTitle(title);
}

function showSection(section) {
  // Переход на страницы разделов
  switch(section) {
    case 'info-about':
      showPage('info-about');
      setHeaderTitle('Информация');
      break;
    case 'info-teachers':
      showPage('info');
      document.getElementById('info-title').innerText = 'Преподаватели';
      setHeaderTitle('Преподаватели');
      resetInfoPage();
      break;
    case 'info-directions':
      showPage('info');
      document.getElementById('info-title').innerText = 'Направления';
      setHeaderTitle('Направления');
      loadInfoDirections();
      break;
    case 'info-individual':
      showPage('info-individual');
      setHeaderTitle('Индивидуальные занятия');
      break;
    case 'info-rent':
      showPage('info-rent');
      setHeaderTitle('Аренда зала');
      break;
  }
}

function resetInfoPage() {
  const container = document.getElementById('info-directions-container');
  const placeholder = document.getElementById('info-placeholder');
  if (container) {
    container.style.display = 'none';
    container.innerHTML = '';
  }
  if (placeholder) {
    placeholder.style.display = 'block';
    placeholder.textContent = 'Раздел находится в разработке';
  }
}

function loadInfoDirections() {
  const container = document.getElementById('info-directions-container');
  const placeholder = document.getElementById('info-placeholder');
  if (!container) return;
  container.style.display = 'block';
  if (placeholder) placeholder.style.display = 'none';

  container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 12px;">⏳ Загрузка направлений...</p>';

  fetch('/api/directions')
    .then(async res => {
      if (!res.ok) throw new Error('Не удалось загрузить направления');
      return res.json();
    })
    .then(directions => {
      if (!directions || directions.length === 0) {
        container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 12px;">📭 Направлений нет</p>';
        return;
      }
      container.innerHTML = directions.map(d => {
        const imageHtml = d.image_path
          ? `<img src="${d.image_path}" style="width: 100%; height: 140px; object-fit: cover; border-radius: 10px; margin-bottom: 10px;">`
          : '';
        const price = d.base_price ? `💰 ${d.base_price} ₽` : '';
        const groupsCount = typeof d.groups_count === 'number' ? `👥 ${d.groups_count} групп` : '';
        const metaLine = [price, groupsCount].filter(Boolean).join(' • ');
        return `
          <div class="card" style="cursor: pointer;" onclick="openDirectionDetail(${d.direction_id})">
            ${imageHtml}
            <div style="font-weight: 700; font-size: 16px; margin-bottom: 6px;">${d.title || 'Направление'}</div>
            <div class="small" style="margin-bottom: 8px;">${d.description || 'Описание отсутствует'}</div>
            ${metaLine ? `<div class="small">${metaLine}</div>` : ''}
          </div>
        `;
      }).join('');
    })
    .catch(err => {
      container.innerHTML = `<p class="small" style="text-align: center; color: #c62828; padding: 12px;">❌ ${err.message}</p>`;
    });
}

function openDirectionDetail(directionId) {
  if (!directionId) return;
  const content = document.getElementById('direction-detail-content');
  if (!content) return;

  content.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 12px;">⏳ Загрузка...</p>';
  showPage('direction-detail');

  Promise.all([
    fetch(`/api/directions/${directionId}`).then(res => res.ok ? res.json() : Promise.reject(new Error('Не удалось загрузить направление'))),
    fetch(`/api/directions/${directionId}/groups`).then(res => res.ok ? res.json() : [])
  ])
    .then(([d, groups]) => {
      const price = d.base_price ? `💰 ${d.base_price} ₽` : '';
      const status = d.status === 'active' ? '✅ Активно' : '⏸️ Неактивно';
      const photoBlock = d.image_path
        ? `<div class="direction-detail-photo"><img src="${d.image_path}" alt="Направление"></div>`
        : '';

      
      


window.groupDetails = window.groupDetails || {};
      const groupsHtml = (groups && groups.length)
        ? groups.map(g => {
            const teacherName = g.teacher_name || '—';
            const teacher = teacherName ? ` ${teacherName}` : '';
            const lessons = g.lessons_per_week ? `${g.lessons_per_week} в неделю` : '—';
            window.groupDetails[g.id] = g;
            return `
              <div class="card" style="margin-bottom: 8px;">
                <div style="font-weight: 700; font-size: 16px; margin-bottom: 6px;">${g.name || 'Группа'}</div>
                <div class="small group-teacher" id="group-teacher-${g.id}" style="margin-bottom: 6px;">${teacher}</div>
                
                <div class="small group-summary" id="group-summary-${g.id}" style="display: flex; gap: 8px; flex-wrap: wrap;">
                  <span>&#x1F388; ${g.age_group || '-'}</span>
                  <span>&#x23F1; ${g.duration_minutes ? g.duration_minutes + ' min' : '-'}</span>
                  <span>&#x1F4C6; ${lessons}</span>
                  <span>&#x1F465; ${g.max_students || '-'}</span>
                </div>

                <button class="save-btn" id="group-detail-btn-${g.id}" style="width: 100%; margin-top: 8px; background: #111;" onclick="toggleGroupInlineDetails(${g.id})">Подробнее</button>
                <div class="group-inline-details" id="group-inline-details-${g.id}"></div>
              </div>
            `;
          }).join('')
        : '<p class="small" style="text-align: center; color: var(--hint); padding: 10px;">Групп пока нет</p>';

content.innerHTML = `
        ${photoBlock}
        <div class="direction-detail-content">
          <div style="font-weight: 700; font-size: 20px; margin-bottom: 6px;">${d.title || 'Направление'}</div>
          <div class="small" style="margin-bottom: 8px;">${[status, price].filter(Boolean).join(' • ')}</div>
          <div class="small" style="margin-bottom: 10px;">${d.description || 'Описание отсутствует'}</div>
          <div style="font-weight: 700; font-size: 16px; margin: 12px 0 8px 0;">Группы</div>
          ${groupsHtml}
        </div>
      `;
    })
    .catch(err => {
      content.innerHTML = `<p class="small" style="text-align: center; color: #c62828; padding: 12px;">❌ ${err.message}</p>`;
    });
}




function toggleGroupInlineDetails(groupId) {
  const details = document.getElementById(`group-inline-details-${groupId}`);
  const button = document.getElementById(`group-detail-btn-${groupId}`);
  const summary = document.getElementById(`group-summary-${groupId}`);
  const teacher = document.getElementById(`group-teacher-${groupId}`);
  if (!details || !button) return;

  if (!details.innerHTML) {
    const data = (window.groupDetails && window.groupDetails[groupId]) || {};
    const title = data?.name || 'Группа';
    const teacherName = data?.teacher_name || '—';
    const teacherInitials = teacherName
      .split(' ')
      .filter(Boolean)
      .slice(0, 2)
      .map(part => part[0].toUpperCase())
      .join('') || '—';
    const teacherPhoto = data?.teacher_photo || '';
    const age = data?.age_group || '—';
    const duration = data?.duration_minutes ? `${data.duration_minutes} мин` : '—';
    const lessons = data?.lessons_per_week ? `${data.lessons_per_week} в неделю` : '—';
    const maxStudents = data?.max_students ? `${data.max_students}` : '—';
    const description = data?.description || 'Описание отсутствует';

    details.innerHTML = `
      <div style="font-weight: 700; font-size: 15px;">${title}</div>
      <div class="group-teacher-link" onclick="openTeacherProfilePlaceholder()">
        <div class="group-teacher-label">Профиль преподавателя</div>
        <div class="group-teacher-row">
          <div class="group-teacher-avatar">
            ${teacherPhoto ? `<img src="${teacherPhoto}" alt="${teacherName}">` : teacherInitials}
          </div>
          <div class="small" style="font-weight: 600;">${teacherName}</div>
        </div>
      </div>
      <div class="group-detail-grid" style="margin-top: 8px;">
        <div class="group-detail-row"><span>Возраст:</span><div>${age}</div></div>
        <div class="group-detail-row"><span>Длительность:</span><div>${duration}</div></div>
        <div class="group-detail-row"><span>Занятий в неделю:</span><div>${lessons}</div></div>
        <div class="group-detail-row"><span>Макс. учеников:</span><div>${maxStudents}</div></div>
      </div>
      <div class="small" style="margin-top: 10px;">${description}</div>
      <button class="save-btn" style="width: 100%; margin-top: 10px;">Записаться</button>
    `;
  }

  const isOpen = !details.classList.contains('show');
  details.classList.toggle('show', isOpen);
  button.textContent = isOpen ? 'Свернуть' : 'Подробнее';
  if (summary) summary.classList.toggle('hidden', isOpen);
  if (teacher) teacher.classList.toggle('hidden', isOpen);
  if (isOpen) {
    details.style.maxHeight = details.scrollHeight + 'px';
  } else {
    details.style.maxHeight = '0px';
  }
}

function openTeacherProfilePlaceholder() {
  return;
}


/* ====== АДМИН-РАСПИСАНИЕ (РАБОТА) ====== */
let scheduleView = 'week';
let scheduleFocusDate = new Date();
let scheduleItems = [];
let scheduleInitialized = false;

const WORK_START_HOUR = 9;
const WORK_END_HOUR = 22;
const SLOT_MINUTES = 30;

function initScheduleControl() {
  if (!scheduleInitialized) {
    scheduleInitialized = true;
  }
  updateScheduleControlsUI();
  loadScheduleV2();
  initGroupScheduleForm();
}

function setScheduleView(view) {
  scheduleView = view;
  updateScheduleControlsUI();
  loadScheduleV2();
}

function shiftScheduleDate(delta) {
  const stepDays = scheduleView === 'week' ? 7 : 1;
  scheduleFocusDate = new Date(scheduleFocusDate.getTime() + delta * stepDays * 24 * 60 * 60 * 1000);
  updateScheduleControlsUI();
  loadScheduleV2();
}

function updateScheduleControlsUI() {
  const weekBtn = document.getElementById('schedule-view-week');
  const dayBtn = document.getElementById('schedule-view-day');
  if (weekBtn && dayBtn) {
    weekBtn.classList.toggle('active', scheduleView === 'week');
    dayBtn.classList.toggle('active', scheduleView === 'day');
  }

  const label = document.getElementById('schedule-date-label');
  if (label) {
    if (scheduleView === 'week') {
      const start = getWeekStart(scheduleFocusDate);
      const end = new Date(start.getTime() + 6 * 24 * 60 * 60 * 1000);
      label.textContent = `${formatDateShort(start)} - ${formatDateShort(end)}`;
    } else {
      label.textContent = formatDateLong(scheduleFocusDate);
    }
  }
}

function getWeekStart(date) {
  const d = new Date(date);
  const day = (d.getDay() + 6) % 7; // 0=Mon
  d.setDate(d.getDate() - day);
  d.setHours(0, 0, 0, 0);
  return d;
}

function formatDateShort(d) {
  return d.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
}

function formatDateLong(d) {
  return d.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long', year: 'numeric' });
}

function timeToMinutes(t) {
  const [h, m] = t.split(':').map(Number);
  return h * 60 + m;
}

function minutesToTime(min) {
  const h = Math.floor(min / 60);
  const m = min % 60;
  return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
}

function formatTimeLabel(timeStr) {
  const parts = timeStr.split(':');
  if (parts.length < 2) return '';
  const minutes = parseInt(parts[1], 10);
  return minutes === 0 ? timeStr : '';
}

function isHalfHour(timeStr) {
  const parts = timeStr.split(':');
  if (parts.length < 2) return false;
  const minutes = parseInt(parts[1], 10);
  return minutes === 30;
}

function loadScheduleV2() {
  const dateFrom = scheduleView === 'week' ? getWeekStart(scheduleFocusDate) : new Date(scheduleFocusDate);
  const dateTo = scheduleView === 'week'
    ? new Date(dateFrom.getTime() + 6 * 24 * 60 * 60 * 1000)
    : new Date(scheduleFocusDate);

  const params = new URLSearchParams({
    date_from: dateFrom.toISOString().slice(0, 10),
    date_to: dateTo.toISOString().slice(0, 10)
  });

  fetch(`/schedule/v2?${params.toString()}`, { headers: getAuthHeaders() })
    .then(async res => {
      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.error || 'Ошибка загрузки расписания');
      }
      return res.json();
    })
    .then(data => {
      scheduleItems = Array.isArray(data) ? data : [];
      renderScheduleGrid();
    })
    .catch(err => {
      console.error(err);
      const container = document.getElementById('schedule-grid-container');
      if (container) {
        container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">❌ Ошибка загрузки расписания</p>';
      }
    });
}

function renderScheduleGrid() {
  const container = document.getElementById('schedule-grid-container');
  if (!container) return;

  const slots = [];
  for (let t = WORK_START_HOUR * 60; t < WORK_END_HOUR * 60; t += SLOT_MINUTES) {
    slots.push(minutesToTime(t));
  }

  if (scheduleView === 'day') {
    const dateStr = scheduleFocusDate.toISOString().slice(0, 10);
    let html = `<div class="schedule-grid day">`;
    html += `<div class="schedule-cell head">Время</div><div class="schedule-cell head">${formatDateShort(scheduleFocusDate)}</div>`;
    for (const time of slots) {
      const timeClass = isHalfHour(time) ? 'schedule-cell time half' : 'schedule-cell time';
      html += `<div class="${timeClass}">${formatTimeLabel(time)}</div>`;
      const busyInfo = getSlotInfo(dateStr, time);
      html += renderSlotCell(dateStr, time, busyInfo);
    }
    html += `</div>`;
    container.innerHTML = html;
  } else {
    const weekStart = getWeekStart(scheduleFocusDate);
    const days = [];
    for (let i = 0; i < 7; i++) {
      const d = new Date(weekStart.getTime() + i * 24 * 60 * 60 * 1000);
      days.push(d);
    }

    let html = `<div class="schedule-grid">`;
    html += `<div class="schedule-cell head">Время</div>`;
    for (const d of days) {
      html += `<div class="schedule-cell head">${d.toLocaleDateString('ru-RU', { weekday: 'short', day: '2-digit' })}</div>`;
    }
    for (const time of slots) {
      const timeClass = isHalfHour(time) ? 'schedule-cell time half' : 'schedule-cell time';
      html += `<div class="${timeClass}">${formatTimeLabel(time)}</div>`;
      for (const d of days) {
        const dateStr = d.toISOString().slice(0, 10);
        const busyInfo = getSlotInfo(dateStr, time);
        html += renderSlotCell(dateStr, time, busyInfo);
      }
    }
    html += `</div>`;
    container.innerHTML = html;
  }
}

function getSlotInfo(dateStr, timeStr) {
  const slotStart = timeToMinutes(timeStr);
  const slotEnd = slotStart + SLOT_MINUTES;
  const item = scheduleItems.find(s => {
    if (s.date !== dateStr) return false;
    if (!s.time_from || !s.time_to) return false;
    const start = timeToMinutes(s.time_from);
    const end = timeToMinutes(s.time_to);
    return slotStart < end && slotEnd > start && s.status !== 'cancelled';
  });
  return item || null;
}

function renderSlotCell(dateStr, timeStr, item) {
  if (item) {
    const info = getSlotRenderInfo(item, timeStr);
    const labelHtml = info.showLabel ? `<div class="schedule-event">${getScheduleLabel(item)}</div>` : '';
    const color = getScheduleColor(item);
    return `<div class="schedule-cell schedule-slot busy ${item.object_type}" style="background: ${color};" onclick="openScheduleDetailById(${item.id})">${labelHtml}</div>`;
  }
  return `<div class="schedule-cell schedule-slot" onclick="openScheduleForm('${dateStr}', '${timeStr}')"></div>`;
}

function getScheduleLabel(item) {
  const typeMap = {
    group: 'Группа',
    individual: 'Индив.',
    rental: 'Аренда'
  };
  return `${typeMap[item.object_type] || 'Событие'} #${item.object_id}`;
}

function getSlotRenderInfo(item, timeStr) {
  if (!item.time_from || !item.time_to) return { showLabel: true };
  const start = timeToMinutes(item.time_from);
  const end = timeToMinutes(item.time_to);
  const slotStart = timeToMinutes(timeStr);
  const totalSlots = Math.max(1, Math.ceil((end - start) / SLOT_MINUTES));
  const slotIndex = Math.floor((slotStart - start) / SLOT_MINUTES);
  const midIndex = Math.floor((totalSlots - 1) / 2);
  return { showLabel: slotIndex === midIndex };
}

function getScheduleColor(item) {
  const baseOffset = {
    group: 210,
    individual: 120,
    rental: 290
  }[item.object_type] || 0;
  const key = `${item.object_type}-${item.object_id || ''}`;
  const hue = (hashString(key) + baseOffset) % 360;
  return `hsla(${hue}, 70%, 85%, 0.8)`;
}

function hashString(str) {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    hash = ((hash << 5) - hash) + str.charCodeAt(i);
    hash |= 0;
  }
  return Math.abs(hash);
}

function openScheduleDetailById(id) {
  const item = scheduleItems.find(s => s.id === id);
  if (!item) return;
  openScheduleDetail(item);
}

function openScheduleDetail(item) {
  const card = document.getElementById('schedule-detail-modal');
  const overlay = document.getElementById('schedule-detail-overlay');
  const content = document.getElementById('schedule-detail-content');
  if (!card || !content || !overlay) return;

  const typeMap = {
    group: 'Групповое занятие',
    individual: 'Индивидуальное занятие',
    rental: 'Аренда'
  };

  const dateText = item.date ? new Date(item.date).toLocaleDateString('ru-RU') : '—';
  const timeText = item.time_from && item.time_to ? `${item.time_from} - ${item.time_to}` : '—';

  content.innerHTML = `
    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
      <div class="schedule-detail-chip">📌 ${typeMap[item.object_type] || 'Событие'}</div>
      <div class="schedule-detail-chip">📅 ${dateText}</div>
      <div class="schedule-detail-chip">⏰ ${timeText}</div>
    </div>
    <div class="schedule-detail-card" id="schedule-detail-extra"></div>
  `;

  card.classList.add('show');
  overlay.classList.add('show');

  if (item.object_type === 'group') {
    loadGroupScheduleDetails(item.object_id);
  } else {
    const extra = document.getElementById('schedule-detail-extra');
    if (extra) extra.innerHTML = '<div class="small">Нет дополнительных данных</div>';
  }
}

function closeScheduleDetail() {
  const card = document.getElementById('schedule-detail-modal');
  const overlay = document.getElementById('schedule-detail-overlay');
  if (card) card.classList.remove('show');
  if (overlay) overlay.classList.remove('show');
}

function loadGroupScheduleDetails(groupId) {
  const extra = document.getElementById('schedule-detail-extra');
  if (!extra) return;
  extra.innerHTML = '<div class="small">⏳ Загрузка деталей группы...</div>';

  fetch(`/api/groups/${groupId}`, { headers: getAuthHeaders() })
    .then(async res => {
      if (!res.ok) throw new Error('Ошибка загрузки группы');
      return res.json();
    })
    .then(async group => {
      let directionTitle = '—';
      let directionPrice = null;
      let teacherName = '—';

      if (group.direction_id) {
        try {
          const dirRes = await fetch(`/api/directions/${group.direction_id}`, { headers: getAuthHeaders() });
          if (dirRes.ok) {
            const dir = await dirRes.json();
            directionTitle = dir.title || directionTitle;
            directionPrice = dir.base_price || directionPrice;
          }
        } catch (err) {
          // ignore
        }
      }

      if (group.teacher_id) {
        try {
          const staffRes = await fetch(`/staff/${group.teacher_id}`, { headers: getAuthHeaders() });
          if (staffRes.ok) {
            const staff = await staffRes.json();
            teacherName = staff.name || teacherName;
          }
        } catch (err) {
          // ignore
        }
      }

      extra.innerHTML = `
        <div class="schedule-detail-row">👥 <strong>Группа:</strong> ${group.name || '—'}</div>
        <div class="schedule-detail-row">🎯 <strong>Направление:</strong> ${directionTitle}</div>
        <div class="schedule-detail-row">👩‍🏫 <strong>Учитель:</strong> ${teacherName}</div>
        <div class="schedule-detail-row">🎈 <strong>Возраст:</strong> ${group.age_group || '—'}</div>
        ${group.lessons_per_week ? `<div class="schedule-detail-row">📆 <strong>Занятий в неделю:</strong> ${group.lessons_per_week}</div>` : ''}
        <div class="schedule-detail-row">💰 <strong>Цена:</strong> ${directionPrice ? directionPrice + ' ₽' : '—'}</div>
      `;
    })
    .catch(() => {
      extra.innerHTML = '<div class="small">❌ Не удалось загрузить детали группы</div>';
    });
}

function openScheduleForm(dateStr, timeStr) {
  const form = document.getElementById('schedule-admin-form');
  if (!form) return;
  form.classList.add('show');

  const dateInput = document.getElementById('schedule-date');
  const timeFromInput = document.getElementById('schedule-time-from');
  const timeToInput = document.getElementById('schedule-time-to');

  if (dateInput) dateInput.value = dateStr;
  if (timeFromInput) timeFromInput.value = timeStr;
  const end = minutesToTime(timeToMinutes(timeStr) + SLOT_MINUTES);
  if (timeToInput) timeToInput.value = end;
}

function closeScheduleForm() {
  const form = document.getElementById('schedule-admin-form');
  if (form) form.classList.remove('show');
}

function createScheduleV2() {
  const objectType = document.getElementById('schedule-object-type').value;
  const objectId = document.getElementById('schedule-object-id').value;
  const dateStr = document.getElementById('schedule-date').value;
  const timeFrom = document.getElementById('schedule-time-from').value;
  const timeTo = document.getElementById('schedule-time-to').value;
  const repeatUntil = document.getElementById('schedule-repeat-until').value;

  if (!objectId || !dateStr || !timeFrom || !timeTo) {
    showNotification('⚠️ Заполните все поля');
    return;
  }

  if (hasScheduleConflict(dateStr, timeFrom, timeTo)) {
    showNotification('❌ В это время уже есть занятие');
    return;
  }

  const payload = {
    object_type: objectType,
    object_id: parseInt(objectId, 10),
    date: dateStr,
    time_from: timeFrom,
    time_to: timeTo,
    repeat_weekly_until: repeatUntil || null
  };

  fetch('/schedule/v2', {
    method: 'POST',
    headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
    body: JSON.stringify(payload)
  })
    .then(async res => {
      const data = await res.json();
      if (!res.ok) {
        throw new Error(data.error || 'Ошибка при создании');
      }
      showNotification('✅ Занятие создано');
      closeScheduleForm();
      loadScheduleV2();
    })
    .catch(err => {
      console.error(err);
      showNotification('❌ ' + err.message);
    });
}

function hasScheduleConflict(dateStr, timeFrom, timeTo) {
  const start = timeToMinutes(timeFrom);
  const end = timeToMinutes(timeTo);
  return scheduleItems.some(s => {
    if (s.date !== dateStr) return false;
    if (!s.time_from || !s.time_to) return false;
    const sStart = timeToMinutes(s.time_from);
    const sEnd = timeToMinutes(s.time_to);
    return start < sEnd && end > sStart && s.status !== 'cancelled';
  });
}

function initGroupScheduleForm() {
  const select = document.getElementById('group-schedule-group');
  if (!select || select.dataset.loaded === '1') return;

  select.innerHTML = '<option value="">Загрузка групп...</option>';
  fetch('/api/directions/manage', { headers: getAuthHeaders() })
    .then(async res => {
      if (!res.ok) throw new Error('Не удалось загрузить направления');
      return res.json();
    })
    .then(async directions => {
      const groups = [];
      for (const d of directions) {
        try {
          const res = await fetch(`/api/directions/${d.direction_id}/groups`, { headers: getAuthHeaders() });
          if (!res.ok) continue;
          const g = await res.json();
          g.forEach(gr => groups.push(gr));
        } catch (err) {
          // ignore
        }
      }
      if (groups.length === 0) {
        select.innerHTML = '<option value="">Группы не найдены</option>';
        return;
      }
      select.innerHTML = '<option value="">Выберите группу</option>' + groups.map(gr => `<option value="${gr.id}">${gr.name}</option>`).join('');
      select.dataset.loaded = '1';
    })
    .catch(() => {
      select.innerHTML = '<option value="">Ошибка загрузки групп</option>';
    });

  select.addEventListener('change', () => {
    updateGroupFormDefaults();
  });

  const dateInput = document.getElementById('group-schedule-date');
  if (dateInput) {
    dateInput.addEventListener('change', () => {
      updateGroupFormDefaults();
      updateRepeatSummary();
    });
  }

  const weekdayRow = document.getElementById('repeat-weekdays-row');
  if (weekdayRow) {
    weekdayRow.addEventListener('click', e => {
      const target = e.target;
      if (target.classList.contains('chip')) {
        target.classList.toggle('active');
        updateRepeatSummary();
      }
    });
  }

  const repeatMode = document.getElementById('repeat-mode');
  const repeatUntil = document.getElementById('repeat-until');
  const repeatInterval = document.getElementById('repeat-interval');
  if (repeatMode) repeatMode.addEventListener('change', updateRepeatSummary);
  if (repeatInterval) repeatInterval.addEventListener('input', updateRepeatSummary);
  if (repeatUntil) repeatUntil.addEventListener('change', updateRepeatSummary);
  updateRepeatSummary();
  updateGroupFormDefaults();
}

function toggleGroupScheduleForm(force) {
  const modal = document.getElementById('group-schedule-modal');
  const overlay = document.getElementById('group-schedule-overlay');
  if (!modal || !overlay) return;
  const shouldShow = typeof force === 'boolean' ? force : !modal.classList.contains('show');
  if (shouldShow) {
    resetGroupScheduleForm();
    modal.classList.add('show');
    overlay.classList.add('show');
  } else {
    modal.classList.remove('show');
    overlay.classList.remove('show');
  }
}

function updateRepeatSummary() {
  const mode = document.getElementById('repeat-mode')?.value || 'none';
  const interval = parseInt(document.getElementById('repeat-interval')?.value || '1', 10);
  const untilInput = document.getElementById('repeat-until');
  const until = untilInput?.value;
  const dateBase = document.getElementById('group-schedule-date')?.value;
  const summary = document.getElementById('repeat-summary');
  const weekdays = getSelectedWeekdays();

  if (!summary) return;
  if (mode === 'none') {
    summary.textContent = 'Без повторения';
    toggleRepeatControls();
    return;
  }

  let text = 'Повторять ';
  if (mode === 'weekly') {
    text += `каждую ${interval} неделю`;
    if (weekdays.length) {
      text += ` (${weekdays.map(d => WEEKDAY_LABELS[d]).join(', ')})`;
    }
  } else if (mode === 'daily') {
    text += `каждые ${interval} день`;
  } else if (mode === 'monthly') {
    text += `каждый ${interval} месяц`;
  }
  const baseDate = dateBase ? new Date(dateBase) : new Date();
  const finalUntil = until || addMonths(baseDate, 6).toISOString().slice(0, 10);
  text += ` до ${new Date(finalUntil).toLocaleDateString('ru-RU')}`;
  summary.textContent = text;
  toggleRepeatControls();
}

function toggleRepeatControls() {
  const mode = document.getElementById('repeat-mode')?.value || 'none';
  const intervalRow = document.getElementById('repeat-interval-row');
  const weekRow = document.getElementById('repeat-weekdays-row');
  const untilRow = document.getElementById('repeat-until')?.parentElement;
  const label = document.getElementById('repeat-interval-label');
  if (intervalRow) intervalRow.style.display = mode === 'none' ? 'none' : 'flex';
  if (weekRow) weekRow.style.display = mode === 'weekly' ? 'flex' : 'none';
  if (untilRow) untilRow.style.display = mode === 'none' ? 'none' : 'flex';
  if (label) {
    label.textContent = mode === 'daily' ? 'день' : mode === 'monthly' ? 'месяц' : 'неделю';
  }
}

const WEEKDAY_LABELS = {
  0: 'Вс',
  1: 'Пн',
  2: 'Вт',
  3: 'Ср',
  4: 'Чт',
  5: 'Пт',
  6: 'Сб'
};

function getSelectedWeekdays() {
  const chips = document.querySelectorAll('#repeat-weekdays-row .chip.active');
  return Array.from(chips).map(c => parseInt(c.dataset.day, 10));
}

function getWeekRangeForDate(dateStr) {
  const date = new Date(dateStr);
  if (Number.isNaN(date.getTime())) return null;
  const start = getWeekStart(date);
  const end = new Date(start.getTime() + 6 * 24 * 60 * 60 * 1000);
  return {
    dateFrom: start.toISOString().slice(0, 10),
    dateTo: end.toISOString().slice(0, 10)
  };
}

function getGroupWeekCount(groupId, dateStr) {
  const range = getWeekRangeForDate(dateStr);
  if (!range) return Promise.resolve(null);
  const params = new URLSearchParams({
    date_from: range.dateFrom,
    date_to: range.dateTo
  });
  return fetch(`/schedule/v2?${params.toString()}`, { headers: getAuthHeaders() })
    .then(res => res.ok ? res.json() : [])
    .then(items => {
      if (!Array.isArray(items)) return 0;
      return items.filter(s => s.object_type === 'group' && s.object_id === parseInt(groupId, 10) && s.status !== 'cancelled').length;
    })
    .catch(() => null);
}

function createGroupSchedule() {
  const groupId = document.getElementById('group-schedule-group')?.value;
  const dateStr = document.getElementById('group-schedule-date')?.value;
  const timeFrom = document.getElementById('group-schedule-time-from')?.value;
  const timeTo = document.getElementById('group-schedule-time-to')?.value;
  const mode = document.getElementById('repeat-mode')?.value || 'none';
  const interval = parseInt(document.getElementById('repeat-interval')?.value || '1', 10);
  const untilStrInput = document.getElementById('repeat-until')?.value;
  const untilStr = untilStrInput || addMonths(new Date(dateStr), 6).toISOString().slice(0, 10);

  if (!groupId || !dateStr || !timeFrom || !timeTo) {
    showNotification('⚠️ Заполните все поля');
    return;
  }

  if (hasScheduleConflict(dateStr, timeFrom, timeTo)) {
    showNotification('❌ В это время уже есть занятие');
    return;
  }

  const dates = buildRepeatDates(dateStr, mode, interval, untilStr);
  if (!dates.length) {
    showNotification('⚠️ Не удалось построить даты');
    return;
  }

  const dateFrom = dates[0];
  const dateTo = dates[dates.length - 1];

  const params = new URLSearchParams({
    date_from: dateFrom,
    date_to: dateTo
  });

  fetch(`/schedule/v2?${params.toString()}`, { headers: getAuthHeaders() })
    .then(async res => {
      if (!res.ok) throw new Error('Ошибка проверки конфликтов');
      return res.json();
    })
    .then(data => {
      scheduleItems = Array.isArray(data) ? data : [];
      const conflict = dates.some(d => hasScheduleConflict(d, timeFrom, timeTo));
      if (conflict) {
        showNotification('❌ В выбранные даты уже есть занятия');
        return;
      }
      createGroupScheduleEntries(groupId, dates, timeFrom, timeTo);
    })
    .catch(err => {
      console.error(err);
      showNotification('❌ Ошибка проверки конфликтов');
    });
}

function updateGroupFormDefaults() {
  const groupId = document.getElementById('group-schedule-group')?.value;
  const dateStr = document.getElementById('group-schedule-date')?.value;
  const preview = document.getElementById('group-schedule-preview');
  if (!groupId) {
    if (preview) {
      preview.style.display = 'none';
      preview.innerHTML = '';
    }
    return;
  }
  fetch(`/api/groups/${groupId}`, { headers: getAuthHeaders() })
    .then(async res => {
      if (!res.ok) throw new Error('Не удалось загрузить группу');
      return res.json();
    })
    .then(group => {
      const timeFromInput = document.getElementById('group-schedule-time-from');
      const timeToInput = document.getElementById('group-schedule-time-to');
      if (timeFromInput && timeToInput && (!timeFromInput.value || !timeToInput.value)) {
        const base = group.duration_minutes || 60;
        const from = timeFromInput.value || '09:00';
        const endMinutes = timeToMinutes(from) + base;
        timeFromInput.value = from;
        timeToInput.value = minutesToTime(endMinutes);
      }

      if (preview) {
        preview.style.display = 'grid';
        const lessonsRow = group.lessons_per_week
          ? `<div class="schedule-detail-row">📆 <strong>Занятий в неделю:</strong> ${group.lessons_per_week}${dateStr ? ' (в этой неделе: <span id="group-week-count">…</span>)' : ''}</div>`
          : '';
        preview.innerHTML = `
          <div class="schedule-detail-row">👥 <strong>Группа:</strong> ${group.name || '—'}</div>
          <div class="schedule-detail-row">🎈 <strong>Возраст:</strong> ${group.age_group || '—'}</div>
          ${lessonsRow}
          <div class="schedule-detail-row">⏱️ <strong>Длительность:</strong> ${group.duration_minutes ? group.duration_minutes + ' мин' : '—'}</div>
        `;
        if (group.teacher_name) {
          preview.innerHTML += `<div class="schedule-detail-row">👩‍🏫 <strong>Учитель:</strong> ${group.teacher_name}</div>`;
        }
        preview.innerHTML += `<div class="schedule-detail-row">🎯 <strong>Направление:</strong> —</div>`;
        preview.innerHTML += `<div class="schedule-detail-row">💰 <strong>Цена:</strong> —</div>`;
      }

      if (group.lessons_per_week && dateStr) {
        getGroupWeekCount(groupId, dateStr).then(count => {
          const countEl = document.getElementById('group-week-count');
          if (countEl) countEl.textContent = count === null ? '—' : String(count);
        });
      }

      if (group.direction_id && preview) {
        fetch(`/api/directions/${group.direction_id}`, { headers: getAuthHeaders() })
          .then(async res => {
            if (!res.ok) throw new Error('Не удалось загрузить направление');
            return res.json();
          })
          .then(direction => {
            const rows = preview.querySelectorAll('.schedule-detail-row');
            if (rows.length >= 2) {
              rows[rows.length - 2].innerHTML = `🎯 <strong>Направление:</strong> ${direction.title || '—'}`;
              rows[rows.length - 1].innerHTML = `💰 <strong>Цена:</strong> ${direction.base_price ? direction.base_price + ' ₽' : '—'}`;
            }
          })
          .catch(() => {});
      }
    })
    .catch(() => {
      // ignore
    });
}

function resetGroupScheduleForm() {
  const groupSelect = document.getElementById('group-schedule-group');
  const dateInput = document.getElementById('group-schedule-date');
  const timeFromInput = document.getElementById('group-schedule-time-from');
  const timeToInput = document.getElementById('group-schedule-time-to');
  const repeatUntil = document.getElementById('repeat-until');
  const repeatInterval = document.getElementById('repeat-interval');
  const repeatMode = document.getElementById('repeat-mode');

  if (groupSelect) groupSelect.value = '';
  if (dateInput) dateInput.value = '';
  if (timeFromInput) timeFromInput.value = '';
  if (timeToInput) timeToInput.value = '';
  if (repeatInterval) repeatInterval.value = '1';
  if (repeatMode) repeatMode.value = 'weekly';
  if (repeatUntil) repeatUntil.value = '';

  const chips = document.querySelectorAll('#repeat-weekdays-row .chip');
  chips.forEach(c => c.classList.remove('active'));

  updateRepeatSummary();
}

function createGroupScheduleEntries(groupId, dates, timeFrom, timeTo) {
  const headers = getAuthHeaders({ 'Content-Type': 'application/json' });
  const requests = dates.map(d => () => fetch('/schedule/v2', {
    method: 'POST',
    headers,
    body: JSON.stringify({
      object_type: 'group',
      object_id: parseInt(groupId, 10),
      date: d,
      time_from: timeFrom,
      time_to: timeTo
    })
  }));

  let chain = Promise.resolve();
  requests.forEach(req => {
    chain = chain.then(() => req());
  });

  chain
    .then(() => {
      showNotification('✅ Занятия созданы');
      toggleGroupScheduleForm(false);
      loadScheduleV2();
    })
    .catch(err => {
      console.error(err);
      showNotification('❌ Ошибка создания');
    });
}

function buildRepeatDates(startDateStr, mode, interval, untilStr) {
  const start = new Date(startDateStr);
  if (Number.isNaN(start.getTime())) return [];
  const until = untilStr ? new Date(untilStr) : addMonths(start, 6);
  if (untilStr && Number.isNaN(until.getTime())) return [];

  const dates = [];
  if (mode === 'none') {
    dates.push(startDateStr);
    return dates;
  }

  if (!until) {
    dates.push(startDateStr);
    return dates;
  }

  if (mode === 'daily') {
    let current = new Date(start);
    while (current <= until) {
      dates.push(current.toISOString().slice(0, 10));
      current.setDate(current.getDate() + interval);
    }
    return dates;
  }

  if (mode === 'monthly') {
    let current = new Date(start);
    while (current <= until) {
      dates.push(current.toISOString().slice(0, 10));
      current.setMonth(current.getMonth() + interval);
    }
    return dates;
  }

  const weekdays = getSelectedWeekdays();
  const targetWeekdays = weekdays.length ? weekdays : [start.getDay()];
  let current = new Date(start);
  while (current <= until) {
    const weekStart = new Date(current);
    const day = weekStart.getDay();
    weekStart.setDate(weekStart.getDate() - day);
    for (let i = 0; i < 7; i++) {
      const d = new Date(weekStart);
      d.setDate(weekStart.getDate() + i);
      if (d < start || d > until) continue;
      if (targetWeekdays.includes(d.getDay())) {
        dates.push(d.toISOString().slice(0, 10));
      }
    }
    current.setDate(current.getDate() + interval * 7);
  }
  return Array.from(new Set(dates)).sort();
}

function addMonths(date, count) {
  const d = new Date(date);
  d.setMonth(d.getMonth() + count);
  return d;
}

function goHome() {
  showPage('home');
}

function goBack() {
  // Если в стеке есть хотя бы одна страница, берем последнюю
  if (navigationStack.length > 1) {
    navigationStack.pop(); // Удаляем текущую страницу из стека
    const previousPageId = navigationStack[navigationStack.length - 1];
    
    // Переходим на предыдущую страницу без добавления в стек
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(previousPageId).classList.add('active');
    
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    const index = ROOT_PAGES.indexOf(previousPageId);
    if (index >= 0) document.querySelectorAll('.nav-btn')[index].classList.add('active');
    
    applyHeaderForPage(previousPageId);
  } else {
    // Если стек пуст, идем домой
    showPage('home');
  }
}

/* ====== УПРАВЛЕНИЕ РАСПИСАНИЕМ ПЕРСОНАЛА ====== */
let currentStaffPosition = '';
const STAFF_CACHE_KEY = 'staff_status_cache_v1';

function getCachedStaffStatus() {
  try {
    const raw = localStorage.getItem(STAFF_CACHE_KEY);
    if (!raw) return null;
    const parsed = JSON.parse(raw);
    if (typeof parsed !== 'object' || parsed === null) return null;
    if (typeof parsed.isStaff !== 'boolean') return null;
    return parsed;
  } catch (err) {
    return null;
  }
}

function setCachedStaffStatus(isStaffValue, positionValue) {
  try {
    const payload = {
      isStaff: Boolean(isStaffValue),
      position: positionValue || '',
      updatedAt: Date.now()
    };
    localStorage.setItem(STAFF_CACHE_KEY, JSON.stringify(payload));
  } catch (err) {
    // ignore cache write errors
  }
}
let currentScheduleId = null;



async function loadStaffList() {
  try {
    // Определяем контейнер в зависимости от текущей страницы
    const currentPage = Array.from(document.querySelectorAll('.page')).find(p => p.classList.contains('active'));
    const containerId = (currentPage && currentPage.id === 'staff-manage') 
      ? 'staff-manage-container' 
      : 'staff-list-container';
    
    const container = document.getElementById(containerId);
    if (!container) return;
    
    container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">⏳ Загрузка...</p>';
    
    const response = await fetch('/staff/list/all');
    
    if (!response.ok) {
      container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">❌ Ошибка при загрузке</p>';
      return;
    }
    
    const staffList = await response.json();
    window.allStaffList = staffList; // Сохраняем для поиска
    
    if (staffList.length === 0) {
      container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">📭 Персонал не найден</p>';
      return;
    }
    
    displayStaffList(staffList);
  } catch (error) {
    console.error('Ошибка при загрузке персонала:', error);
    const currentPage = Array.from(document.querySelectorAll('.page')).find(p => p.classList.contains('active'));
    const containerId = (currentPage && currentPage.id === 'staff-manage') 
      ? 'staff-manage-container' 
      : 'staff-list-container';
    const container = document.getElementById(containerId);
    if (container) {
      container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">❌ Ошибка сети</p>';
    }
  }
}

function getStaffInitials(name) {
  const safe = (name || '').trim();
  if (!safe) return '?';
  const parts = safe.split(/\s+/).filter(Boolean);
  const first = parts[0] ? parts[0][0] : '';
  const second = parts.length > 1 ? parts[1][0] : (parts[0] && parts[0][1] ? parts[0][1] : '');
  return (first + second).toUpperCase();
}

function getStaffAvatarColor(name) {
  const colors = ['#f44336', '#e91e63', '#9c27b0', '#3f51b5', '#2196f3', '#009688', '#4caf50', '#ff9800'];
  const safe = (name || '').trim();
  if (!safe) return '#9e9e9e';
  let hash = 0;
  for (let i = 0; i < safe.length; i++) {
    hash = (hash * 31 + safe.charCodeAt(i)) >>> 0;
  }
  return colors[hash % colors.length];
}

function displayStaffList(staffList) {
  // Определяем правильный контейнер в зависимости от текущей страницы
  const currentPage = Array.from(document.querySelectorAll('.page')).find(p => p.classList.contains('active'));
  const containerId = (currentPage && currentPage.id === 'staff-manage') 
    ? 'staff-manage-container' 
    : 'staff-list-container';
  
  const container = document.getElementById(containerId);
  if (!container) return;
  
  container.innerHTML = staffList.map(s => {
    const photoUrl = s.photo ? buildMediaUrl(s.photo) : null;
    const initials = getStaffInitials(s.name);
    const avatarBg = getStaffAvatarColor(s.name);
    return `
    <div class="card" onclick="openStaffDetail(${s.id}, '${s.name}', '${s.position}', '${s.phone ? s.phone : ''}', '${s.email}', '${s.specialization || ''}', '${s.bio || ''}', '${s.status}')" style="cursor: pointer;">
      <div class="staff-card-row">
        <div class="staff-card-avatar" style="background: ${photoUrl ? '#e0e0e0' : avatarBg};">
          ${photoUrl ? `<img src="${photoUrl}" alt=""/>` : `<span>${initials}</span>`}
        </div>
        <div style="flex: 1;">
          <div style="display: flex; align-items: center; justify-content: space-between; gap: 8px;">
            <div style="font-weight: 600; font-size: 16px;">${s.name}</div>
            ${s.teaches ? '<span style="font-size: 11px; padding: 2px 8px; border-radius: 999px; background: rgba(76, 175, 80, 0.12); color: #2e7d32;">👩‍🏫</span>' : ''}
          </div>
          ${s.username ? `<div style="font-size: 13px; color: var(--accent); margin-top: 2px;">@${s.username}</div>` : ''}
          <div style="font-size: 14px; color: var(--hint); margin-top: 4px;">📍 ${s.position}</div>
          ${s.phone ? `<div style="font-size: 13px; color: var(--hint); margin-top: 2px;">📱 ${s.phone}</div>` : ''}
          <div style="font-size: 12px; color: ${s.status === 'active' ? '#4caf50' : '#ff6b6b'}; margin-top: 6px;">● ${s.status === 'active' ? 'Активен' : 'Неактивен'}</div>
        </div>
      </div>
    </div>
  `;
  }).join('');
}

function searchStaffManage() {
  const searchInput = document.getElementById('staff-manage-search');
  const search = searchInput.value.trim().toLowerCase();
  
  if (!window.allStaffList) {
    return;
  }
  
  if (search.length === 0) {
    displayStaffList(window.allStaffList);
    return;
  }
  
  let filtered = [];
  
  // Проверяем, ищет ли пользователь по юзернейму (с @)
  if (search.startsWith('@')) {
    // Поиск по юзернейму
    const usernameQuery = search.substring(1).toLowerCase();
    filtered = window.allStaffList.filter(s => 
      s.username && s.username.toLowerCase().includes(usernameQuery)
    );
  } else {
    // Поиск по ID или имени
    filtered = window.allStaffList.filter(s => 
      s.name.toLowerCase().includes(search) ||
      s.id.toString().includes(search) ||
      (s.telegram_id && s.telegram_id.toString().includes(search))
    );
  }
  
  if (filtered.length === 0) {
    document.getElementById('staff-manage-container').innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">❌ Персонал не найден</p>';
  } else {
    displayStaffList(filtered);
  }
}

// Хранилище для выбранного пользователя и текущего персонала
window.selectedStaffUserData = null;
window.currentStaffTelegramIds = []; // Список telegram_id текущего персонала

function showAddStaffForm() {
  // Очищаем поле поиска и форму
  document.getElementById('staff-user-search').value = '';
  document.getElementById('staff-add-position').value = '';
  document.getElementById('staff-add-specialization').value = '';
  document.getElementById('staff-add-bio').value = '';
  const notifyCheckbox = document.getElementById('staff-add-notify');
  if (notifyCheckbox) {
    notifyCheckbox.checked = true;
  }
  const teachesCheckbox = document.getElementById('staff-add-teaches');
  if (teachesCheckbox) {
    teachesCheckbox.checked = false;
    teachesCheckbox.disabled = false;
  }
  updateStaffTeachesToggle();
  
  // Загружаем текущий персонал и всех пользователей при открытии формы
  loadCurrentStaffAndUsers();
  
  showPage('staff-add-form');
  setHeaderTitle('➕ Добавить персонал');
}

function updateStaffTeachesToggle() {
  const positionSelect = document.getElementById('staff-add-position');
  const teachesCheckbox = document.getElementById('staff-add-teaches');
  if (!positionSelect || !teachesCheckbox) return;

  const position = (positionSelect.value || '').toLowerCase();
  const isTeacher = position === 'учитель';
  teachesCheckbox.checked = isTeacher ? true : teachesCheckbox.checked;
  teachesCheckbox.disabled = isTeacher;
}

async function loadCurrentStaffAndUsers() {
  try {
    // Получаем текущий персонал
    const staffResponse = await fetch('/staff/list/all');
    if (staffResponse.ok) {
      const staffList = await staffResponse.json();
      window.currentStaffTelegramIds = staffList.map(s => s.telegram_id);
    }
    
    // Загружаем всех пользователей
    const response = await fetch('/staff/search');
    if (!response.ok) return;
    
    const users = await response.json();
    // Фильтруем - исключаем уже добавленный персонал
    const filteredUsers = users.filter(u => !window.currentStaffTelegramIds.includes(u.telegram_id));
    displaySearchResults(filteredUsers);
  } catch (error) {
    console.error('Ошибка при загрузке пользователей:', error);
  }
}

async function loadAllStaffUsers() {
  try {
    const response = await fetch('/staff/search');
    if (!response.ok) return;
    
    const users = await response.json();
    // Фильтруем - исключаем уже добавленный персонал
    const filteredUsers = users.filter(u => !window.currentStaffTelegramIds.includes(u.telegram_id));
    displaySearchResults(filteredUsers);
  } catch (error) {
    console.error('Ошибка при загрузке пользователей:', error);
  }
}

async function searchForStaffUser() {
  let search = document.getElementById('staff-user-search').value.trim().toLowerCase();
  
  try {
    // Определяем тип поиска
    const searchByUsername = search.startsWith('@');
    
    // Удаляем @ для отправки на сервер
    const cleanSearch = search.replace(/^@/, '');
    
    console.log('Поиск:', {search, searchByUsername, cleanSearch});
    
    // Формируем параметры запроса
    const params = new URLSearchParams();
    if (cleanSearch) {
      params.append('q', cleanSearch);
      if (searchByUsername) {
        params.append('by_username', 'true');
      }
    }
    
    console.log('Запрос к:', `/staff/search?${params.toString()}`);
    
    const response = await fetch(`/staff/search?${params.toString()}`);
    
    if (!response.ok) {
      document.getElementById('staff-user-search-results').innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 16px 0;">❌ Ошибка при загрузке</p>';
      return;
    }
    
    const users = await response.json();
    // Фильтруем - исключаем уже добавленный персонал
    const filteredUsers = users.filter(u => !window.currentStaffTelegramIds.includes(u.telegram_id));
    
    // Если поле поиска пусто, показываем всех пользователей
    if (!cleanSearch) {
      if (filteredUsers.length === 0) {
        document.getElementById('staff-user-search-results').innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 16px 0;">📭 Нет пользователей</p>';
        return;
      }
    } else {
      if (filteredUsers.length === 0) {
        document.getElementById('staff-user-search-results').innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 16px 0;">❌ Персонал не найден</p>';
        return;
      }
    }
    
    displaySearchResults(filteredUsers);
  } catch (error) {
    console.error('Ошибка при поиске персонала:', error);
    document.getElementById('staff-user-search-results').innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 16px 0;">❌ Ошибка сети</p>';
  }
}

function displaySearchResults(users) {
  const resultsHtml = users.map(u => {
    const safeName = u.name.replace(/'/g, "\\'").replace(/"/g, '\\"');
    const safePhone = (u.phone || '').replace(/'/g, "\\'").replace(/"/g, '\\"');
    const safeEmail = (u.email || '').replace(/'/g, "\\'").replace(/"/g, '\\"');
    const isSelected = window.selectedStaffUserData && window.selectedStaffUserData.id === u.id;
    const borderColor = isSelected ? '#1976d2' : 'var(--accent)';
    const bgColor = isSelected ? '#e3f2fd' : 'var(--bg)';
    
    return `
      <div class="card" id="user-card-${u.id}" style="margin-bottom: 8px; cursor: pointer; background: ${bgColor}; border-left: 4px solid ${borderColor}; transition: all 0.2s;" onclick="selectStaffUser(${u.id}, '${safeName}', ${u.telegram_id}, '${safePhone}', '${safeEmail}')">
        <div style="font-weight: 600; font-size: 14px;">
          ${u.name}
          ${window.selectedStaffUserData && window.selectedStaffUserData.id === u.id ? ' ✓' : ''}
        </div>
        <div style="font-size: 12px; color: var(--hint); margin-top: 2px;">ID: ${u.telegram_id}${u.username ? ` • @${u.username}` : ''}</div>
        ${u.phone ? `<div style="font-size: 12px; color: var(--hint);">📱 ${u.phone}</div>` : ''}
      </div>
    `;
  }).join('');
  
  document.getElementById('staff-user-search-results').innerHTML = resultsHtml;
}

function selectStaffUser(id, name, telegramId, phone, email) {
  window.selectedStaffUserData = {
    id,
    name,
    telegram_id: telegramId,
    phone,
    email
  };
  
  // Обновляем стили всех карточек
  const allCards = document.querySelectorAll('[id^="user-card-"]');
  allCards.forEach(card => {
    if (card.id === `user-card-${id}`) {
      // Выбранная карточка - синяя
      card.style.background = '#e3f2fd';
      card.style.borderLeftColor = '#1976d2';
      // Добавляем галочку
      const titleDiv = card.querySelector('div');
      if (!titleDiv.textContent.includes('✓')) {
        titleDiv.textContent += ' ✓';
      }
    } else {
      // Остальные карточки - стандартный вид
      card.style.background = 'var(--bg)';
      card.style.borderLeftColor = 'var(--accent)';
      // Убираем галочку
      const titleDiv = card.querySelector('div');
      titleDiv.textContent = titleDiv.textContent.replace(' ✓', '');
    }
  });
}

async function saveNewStaff() {
  // Проверяем, выбран ли пользователь
  if (!window.selectedStaffUserData) {
    showNotification('⚠️ Выберите пользователя из списка');
    return;
  }
  
  const position = document.getElementById('staff-add-position').value;
  const specialization = document.getElementById('staff-add-specialization').value.trim();
  const bio = document.getElementById('staff-add-bio').value.trim();
  const teaches = document.getElementById('staff-add-teaches')?.checked;
  const notify = document.getElementById('staff-add-notify')?.checked;
  
  // Проверяем обязательные поля
  if (!position) {
    showNotification('⚠️ Выберите должность');
    return;
  }
  
  try {
    const payload = {
      name: window.selectedStaffUserData.name,
      telegram_id: window.selectedStaffUserData.telegram_id,
      position,
      specialization: specialization || undefined,
      bio: bio || undefined,
      teaches: teaches ? 1 : 0,
      notify: notify ? 1 : 0
    };
    
    const response = await fetch('/staff', {
      method: 'POST',
      headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
      body: JSON.stringify(payload)
    });
    
    if (response.ok) {
      showNotification('✅ Персонал добавлен');
      setTimeout(() => {
        // Очищаем выбор
        window.selectedStaffUserData = null;
        goBack();
        loadStaffList();
      }, 500);
    } else {
      const error = await response.json();
      showNotification('❌ Ошибка: ' + (error.error || 'неизвестная ошибка'));
    }
  } catch (error) {
    console.error('Ошибка при добавлении персонала:', error);
    showNotification('❌ Ошибка сети');
  }
}

let pendingDeleteStaffId = null;
let pendingDeleteStaffName = '';

function openStaffDeleteModal(staffId, name) {
  pendingDeleteStaffId = staffId;
  pendingDeleteStaffName = name || '';
  const overlay = document.getElementById('staff-delete-overlay');
  const modal = document.getElementById('staff-delete-modal');
  const subtitle = document.getElementById('staff-delete-subtitle');
  const notifyCheckbox = document.getElementById('staff-delete-notify');
  if (subtitle) {
    subtitle.textContent = pendingDeleteStaffName ? `Персонал: ${pendingDeleteStaffName}` : '—';
  }
  if (notifyCheckbox) {
    notifyCheckbox.checked = true;
  }
  if (overlay) overlay.classList.add('show');
  if (modal) modal.classList.add('show');
}

function closeStaffDeleteModal() {
  const overlay = document.getElementById('staff-delete-overlay');
  const modal = document.getElementById('staff-delete-modal');
  if (overlay) overlay.classList.remove('show');
  if (modal) modal.classList.remove('show');
  pendingDeleteStaffId = null;
  pendingDeleteStaffName = '';
}

async function confirmStaffDelete() {
  if (!pendingDeleteStaffId) return;
  const notifyCheckbox = document.getElementById('staff-delete-notify');
  const notify = notifyCheckbox ? notifyCheckbox.checked : true;
  const staffId = pendingDeleteStaffId;
  const shouldGoBack = (currentDetailStaffId && currentDetailStaffId === staffId);
  closeStaffDeleteModal();

  try {
    const response = await fetch(`/staff/${staffId}?notify=${notify ? 1 : 0}`, {
      method: 'DELETE',
      headers: getAuthHeaders()
    });
    
    if (response.ok) {
      showNotification('✅ Персонал удален');
      if (shouldGoBack && document.getElementById('staff-detail')?.classList.contains('active')) {
        goBack();
      }
      loadStaffList();
    } else {
      showNotification('❌ Ошибка при удалении');
    }
  } catch (error) {
    console.error('Ошибка при удалении:', error);
    showNotification('❌ Ошибка сети');
  }
}

function deleteStaffMember(staffId, name) {
  openStaffDeleteModal(staffId, name);
}

let currentDetailStaffId = null;

function openStaffDetail(id, name, position, phone, email, specialization, bio, status) {
  currentDetailStaffId = id;
  
  const phoneValue = (phone === 'null' || phone === 'undefined') ? '' : phone;

  document.getElementById('staff-detail-name').innerText = name;
  document.getElementById('staff-detail-position').innerText = position;
  document.getElementById('staff-detail-position-full').innerText = position;
  const phoneBlock = document.getElementById('staff-detail-phone-block');
  if (phoneValue) {
    document.getElementById('staff-detail-phone').innerText = phoneValue;
    phoneBlock.style.display = 'block';
  } else {
    document.getElementById('staff-detail-phone').innerText = '—';
    phoneBlock.style.display = 'none';
  }
  document.getElementById('staff-detail-email').innerText = email || '—';
  document.getElementById('staff-detail-specialization').innerText = specialization || '—';
  document.getElementById('staff-detail-bio').innerText = bio || '—';
  document.getElementById('staff-detail-status').innerText = status === 'active' ? '✅ Активен' : '❌ Неактивен';
  
  showPage('staff-detail');
  setHeaderTitle(name);

  // Обновляем аватар (staff -> user -> telegram)
  updateStaffDetailAvatar(null, null);
  fetch(`/staff/${id}`)
    .then(async r => {
      const data = await r.json();
      if (!r.ok) throw new Error(data.error || 'Не удалось загрузить профиль');
      return data;
    })
    .then(staff => {
      updateStaffDetailAvatar(staff.photo_path, staff.telegram_id);
    })
    .catch(() => {
      // если не получилось - оставляем плейсхолдер
    });
}

function buildMediaUrl(photoPath) {
  if (!photoPath) return null;
  let normalized = String(photoPath).replace(/\\/g, '/');
  while (normalized.startsWith('../')) {
    normalized = normalized.slice(3);
  }
  if (normalized.startsWith('./')) {
    normalized = normalized.slice(2);
  }
  if (normalized.startsWith('/database/')) return normalized;
  if (normalized.startsWith('database/')) return `/${normalized}`;
  return `/media/${normalized.replace(/^\/+/, '')}`;
}

function updateStaffDetailAvatar(photoPath, telegramId) {
  const img = document.getElementById('staff-detail-avatar-img');
  const placeholder = document.querySelector('#staff-detail-avatar p');
  if (!img || !placeholder) return;

  if (photoPath) {
    const mediaUrl = buildMediaUrl(photoPath);
    if (mediaUrl) img.src = mediaUrl;
    img.style.display = 'block';
    placeholder.style.display = 'none';
    return;
  }

  const tgUser = tg?.initDataUnsafe?.user;
  if (tgUser && telegramId && tgUser.id === telegramId && tgUser.photo_url) {
    img.src = tgUser.photo_url;
    img.style.display = 'block';
    placeholder.style.display = 'none';
    return;
  }

  img.style.display = 'none';
  img.src = '';
  placeholder.style.display = 'flex';
}

async function deleteCurrentStaff() {
  if (!currentDetailStaffId) return;
  const name = document.getElementById('staff-detail-name')?.innerText || '';
  openStaffDeleteModal(currentDetailStaffId, name);
}

async function loadStaffSchedule() {
  try {
    const container = document.getElementById('staff-schedule-container');
    container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">⏳ Загрузка...</p>';
    
    const response = await fetch('/schedule');
    
    if (!response.ok) {
      container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">❌ Ошибка при загрузке расписания</p>';
      return;
    }
    
    let schedules = await response.json();
    
    // Фильтруем расписание в зависимости от должности
    if (currentStaffPosition === 'учитель') {
      // Учитель видит только свои занятия
      schedules = schedules.filter(s => s.teacher === currentUserData.name);
    }
    // Модератор и выше видят все занятия
    
    if (schedules.length === 0) {
      container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">📭 Занятий нет</p>';
      return;
    }
    
    displayStaffSchedules(schedules);
  } catch (error) {
    console.error('Ошибка при загрузке расписания:', error);
    document.getElementById('staff-schedule-container').innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">❌ Ошибка сети</p>';
  }
}

function displayStaffSchedules(schedules) {
  const container = document.getElementById('staff-schedule-container');
  
  container.innerHTML = schedules.map(s => `
    <div class="card" onclick="editSchedule(${s.id}, '${s.title}', ${s.teacher_id}, '${s.teacher.name}', '${s.date}', '${s.start}', '${s.end}')">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <div style="font-weight: 600; font-size: 15px;">${s.title}</div>
          <div style="font-size: 13px; color: var(--hint); margin-top: 4px;">📅 ${new Date(s.date).toLocaleDateString('ru-RU')}</div>
          <div style="font-size: 13px; color: var(--hint);">🕐 ${s.start} - ${s.end}</div>
          <div style="font-size: 13px; color: var(--hint);">👨‍🏫 ${s.teacher.name}</div>
        </div>
        <div style="font-size: 24px;">→</div>
      </div>
    </div>
  `).join('');
}

async function loadPublicSchedule() {
  try {
    const container = document.getElementById('schedule-container');
    if (container) {
      container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">⏳ Загрузка...</p>';
    }
    
    const response = await fetch('/schedule/public');
    
    if (!response.ok) {
      if (container) {
        container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">❌ Ошибка при загрузке расписания</p>';
      }
      return;
    }
    
    const schedules = await response.json();
    window.publicScheduleItems = Array.isArray(schedules) ? schedules : [];
    
    preloadPublicDirections().then(() => {
      initPublicScheduleStrip();
      renderPublicScheduleList();
    });
  } catch (error) {
    console.error('Ошибка при загрузке расписания:', error);
    const container = document.getElementById('schedule-container');
    if (container) {
      container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">❌ Ошибка сети</p>';
    }
  }
}

function preloadPublicDirections() {
  const items = Array.isArray(window.publicScheduleItems) ? window.publicScheduleItems : [];
  const missingIds = Array.from(new Set(items
    .filter(s => s.direction_id && !s.direction_image)
    .map(s => s.direction_id)
  ));
  if (!missingIds.length) return Promise.resolve();
  if (!window.publicDirectionsCache) window.publicDirectionsCache = {};

  return Promise.all(missingIds.map(id => {
    if (window.publicDirectionsCache[id]) return Promise.resolve();
    return fetch(`/api/directions/${id}`)
      .then(res => res.ok ? res.json() : null)
      .then(dir => {
        if (dir && dir.image_path) {
          window.publicDirectionsCache[id] = dir.image_path;
        }
      })
      .catch(() => {});
  })).then(() => {
    items.forEach(s => {
      if (!s.direction_image && s.direction_id && window.publicDirectionsCache[s.direction_id]) {
        s.direction_image = window.publicDirectionsCache[s.direction_id];
      }
    });
  });
}

function initPublicScheduleStrip() {
  const strip = document.getElementById('public-schedule-strip');
  const monthLabel = document.getElementById('public-schedule-month');
  if (!strip) return;

  const today = new Date();
  const days = [];
  for (let i = 0; i < 7; i++) {
    const d = new Date(today.getTime() + i * 24 * 60 * 60 * 1000);
    days.push(d);
  }

  if (!window.publicScheduleDate) {
    window.publicScheduleDate = today.toISOString().slice(0, 10);
  }

  if (monthLabel) {
    monthLabel.textContent = today.toLocaleDateString('ru-RU', { month: 'long' });
  }

  const labels = ['вс', 'пн', 'вт', 'ср', 'чт', 'пт', 'сб'];
  strip.innerHTML = days.map((d, idx) => {
    const dateStr = d.toISOString().slice(0, 10);
    const isActive = window.publicScheduleDate === dateStr;
    const dayLabel = labels[d.getDay()];
    const shortLabel = idx === 0 ? 'сегодня' : idx === 1 ? 'завтра' : '';
    return `
      <div class="public-date-card ${isActive ? 'active' : ''}" onclick="selectPublicScheduleDate('${dateStr}')">
        <div class="public-date-dow">${dayLabel}</div>
        <div class="public-date-day">${d.getDate()}</div>
        <div class="public-date-label">${shortLabel}</div>
      </div>
    `;
  }).join('');
}

function selectPublicScheduleDate(dateStr) {
  window.publicScheduleDate = dateStr;
  initPublicScheduleStrip();
  renderPublicScheduleList();
}

function renderPublicScheduleList() {
  const container = document.getElementById('schedule-container');
  if (!container) return;
  const items = Array.isArray(window.publicScheduleItems) ? window.publicScheduleItems : [];
  const selected = window.publicScheduleDate;
  const filtered = selected ? items.filter(s => s.date === selected) : items;

  if (!filtered.length) {
    container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">📭 На этот день занятий нет</p>';
    return;
  }

  const sorted = filtered.slice().sort((a, b) => (a.start || '').localeCompare(b.start || ''));
  container.innerHTML = sorted.map(s => {
    const teacherName = s.teacher_name || (s.teacher && s.teacher.name ? s.teacher.name : '—');
    const directionTitle = s.direction || '—';
    const startTime = formatTimeShort(s.start);
    const endTime = formatTimeShort(s.end);
    const duration = getDurationMinutes(startTime, endTime);
    const color = getPublicScheduleColor(s.title || '');
    return `
      <div class="public-schedule-item" onclick="openPublicScheduleDetail(${s.id})">
        <div class="public-schedule-time">
          <div class="public-dot" style="background:${color};"></div>
          <div class="public-time">${startTime || '—'}</div>
          <div class="public-duration">${duration ? duration + ' мин' : '—'}</div>
        </div>
        <div>
          <div class="public-info-title">${s.title || 'Занятие'}</div>
          <div class="public-info-sub">${directionTitle}</div>
          <div class="public-info-sub">Групповое занятие</div>
          <div class="public-info-teacher">${teacherName}</div>
        </div>
        <div class="public-chevron">›</div>
      </div>
    `;
  }).join('');
}

function getDurationMinutes(start, end) {
  if (!start || !end) return null;
  const [sh, sm] = start.split(':').map(Number);
  const [eh, em] = end.split(':').map(Number);
  if (Number.isNaN(sh) || Number.isNaN(eh)) return null;
  return Math.max(0, (eh * 60 + em) - (sh * 60 + sm));
}

function formatTimeShort(timeStr) {
  if (!timeStr) return '';
  const parts = timeStr.split(':');
  if (parts.length < 2) return timeStr;
  return `${parts[0].padStart(2, '0')}:${parts[1].padStart(2, '0')}`;
}

function getPublicScheduleColor(key) {
  const hue = (hashString(key || '') + 180) % 360;
  return `hsl(${hue}, 70%, 55%)`;
}

function openPublicScheduleDetail(id) {
  const items = Array.isArray(window.publicScheduleItems) ? window.publicScheduleItems : [];
  const item = items.find(i => i.id === id);
  if (!item) return;

  const content = document.getElementById('public-schedule-detail-content');
  if (!content) return;

  const startTime = formatTimeShort(item.start);
  const endTime = formatTimeShort(item.end);
  const duration = getDurationMinutes(startTime, endTime);
  const lessons = item.lessons_per_week ? item.lessons_per_week : '—';
  const directionImage = item.direction_image || '';

  content.innerHTML = `
    ${directionImage ? `<div class="card" style="padding:0; overflow:hidden; margin-bottom:8px;"><img src="${directionImage}" alt="Направление" style="width:100%; height:180px; object-fit:cover; display:block;"></div>` : ''}
    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:6px;">
      <div class="schedule-detail-chip">📅 ${item.date ? new Date(item.date).toLocaleDateString('ru-RU') : '—'}</div>
      <div class="schedule-detail-chip">⏰ ${startTime || '—'} — ${endTime || '—'}</div>
      <div class="schedule-detail-chip">⏳ ${duration ? duration + ' мин' : '—'}</div>
    </div>
    <div class="schedule-detail-card">
      <div class="schedule-detail-row">👥 <strong>Группа:</strong> ${item.title || '—'}</div>
      <div class="schedule-detail-row">👩‍🏫 <strong>Преподаватель:</strong> ${item.teacher_name || '—'}</div>
      <div class="schedule-detail-row">📆 <strong>Занятий в неделю:</strong> ${lessons}</div>
      <div class="schedule-detail-row">🎈 <strong>Возраст:</strong> ${item.age_group || '—'}</div>
    </div>
    <div class="schedule-detail-card">
      <div class="schedule-detail-row">🎯 <strong>Направление:</strong> ${item.direction || '—'}</div>
      <div class="schedule-detail-row">📝 <strong>Описание направления:</strong> ${item.direction_description || '—'}</div>
      <button class="save-btn" style="width:100%; margin-top:4px; background:#111;">Перейти в направление</button>
    </div>
  `;

  showPage('public-schedule-detail');
}

async function loadTeachers() {
  try {
    const response = await fetch('/staff/list/teachers');
    if (!response.ok) return [];
    return await response.json();
  } catch (error) {
    console.error('Ошибка при загрузке учителей:', error);
    return [];
  }
}

function populateTeacherSelect(teachers, selectedTeacherId = null) {
  const select = document.getElementById('schedule-input-teacher');
  const currentValue = select.value;
  
  select.innerHTML = '<option value="">Выберите преподавателя</option>';
  
  teachers.forEach(t => {
    const option = document.createElement('option');
    option.value = t.id;
    option.textContent = t.name;
    if (t.id == (selectedTeacherId || currentValue)) {
      option.selected = true;
    }
    select.appendChild(option);
  });
}

async function openCreateSchedule() {
  currentScheduleId = null;
  
  document.getElementById('schedule-form-title').innerText = 'Создать занятие';
  document.getElementById('schedule-input-title').value = '';
  document.getElementById('schedule-input-date').value = '';
  document.getElementById('schedule-input-start').value = '';
  document.getElementById('schedule-input-end').value = '';
  document.getElementById('schedule-delete-btn').style.display = 'none';
  
  const teachers = await loadTeachers();
  populateTeacherSelect(teachers, currentUserData.id);
  
  showPage('schedule-form');
  setHeaderTitle('Создать занятие');
}

function editSchedule(scheduleId, title, teacherId, teacherName, date, start, end) {
  currentScheduleId = scheduleId;
  
  document.getElementById('schedule-form-title').innerText = 'Редактировать занятие';
  document.getElementById('schedule-input-title').value = title;
  document.getElementById('schedule-input-date').value = date;
  document.getElementById('schedule-input-start').value = start;
  document.getElementById('schedule-input-end').value = end;
  document.getElementById('schedule-delete-btn').style.display = 'block';
  
  // Загружаем учителей и выбираем текущего
  loadTeachers().then(teachers => {
    populateTeacherSelect(teachers, teacherId);
  });
  
  showPage('schedule-form');
  setHeaderTitle('Редактировать занятие');
}

async function saveSchedule() {
  const title = document.getElementById('schedule-input-title').value.trim();
  const teacher_id = document.getElementById('schedule-input-teacher').value;
  const date = document.getElementById('schedule-input-date').value;
  const start = document.getElementById('schedule-input-start').value;
  const end = document.getElementById('schedule-input-end').value;
  
  if (!title || !teacher_id || !date || !start || !end) {
    showNotification('⚠️ Заполните все поля');
    return;
  }
  
  try {
    if (currentScheduleId) {
      // Редактируем существующее занятие
      const response = await fetch(`/schedule/${currentScheduleId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title, teacher_id: parseInt(teacher_id), date, start_time: start, end_time: end })
      });
      
      if (response.ok) {
        showNotification('✅ Занятие обновлено');
        goBack();
      } else {
        const error = await response.json();
        showNotification('❌ Ошибка: ' + (error.error || 'неизвестная ошибка'));
      }
    } else {
      // Создаем новое занятие
      const response = await fetch('/schedule', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title, teacher_id: parseInt(teacher_id), date, start_time: start, end_time: end })
      });
      
      if (response.ok) {
        showNotification('✅ Занятие создано');
        goBack();
      } else {
        const error = await response.json();
        showNotification('❌ Ошибка: ' + (error.error || 'неизвестная ошибка'));
      }
    }
  } catch (error) {
    console.error('Ошибка при сохранении занятия:', error);
    showNotification('❌ Ошибка при сохранении занятия');
  }
}

async function deleteSchedule() {
  if (!currentScheduleId) {
    showNotification('❌ ID занятия не найден');
    return;
  }
  
  if (!confirm('Вы уверены, что хотите удалить это занятие?')) {
    return;
  }
  
  try {
    const response = await fetch(`/schedule/${currentScheduleId}`, {
      method: 'DELETE'
    });
    
    if (response.ok) {
      showNotification('✅ Занятие удалено');
      goBack();
    } else {
      const error = await response.json();
      showNotification('❌ Ошибка: ' + (error.error || 'неизвестная ошибка'));
    }
  } catch (error) {
    console.error('Ошибка при удалении занятия:', error);
    showNotification('❌ Ошибка при удалении занятия');
  }
}

/* ====== ПРОВЕРКА СТАТУСА ПЕРСОНАЛА ====== */
async function checkStaffStatus(telegramId) {
  try {
    const response = await fetch(`/staff/check/${telegramId}`);
    
    if (!response.ok) {
      isStaff = false;
      currentStaffPosition = '';
      setCachedStaffStatus(false, '');
      updateStaffNavigation();
      return;
    }
    
    const data = await response.json();
    isStaff = data.is_staff;
    if (data.staff) {
      currentStaffPosition = data.staff.position.toLowerCase();
      
      // Обновляем имя из Telegram если это владелец или администратор
      const user = tg.initDataUnsafe?.user;
      if (user && (currentStaffPosition === 'владелец' || currentStaffPosition === 'администратор')) {
        try {
          await fetch(`/staff/update-from-telegram/${telegramId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              first_name: user.first_name,
              last_name: user.last_name
            })
          });
        } catch (error) {
          console.log('Не удалось обновить имя из Telegram:', error);
        }
      }
    }
    setCachedStaffStatus(isStaff, currentStaffPosition);
    updateStaffNavigation();
    
    console.log(`Статус персонала: ${isStaff}, должность: ${currentStaffPosition}`);
  } catch (error) {
    console.error('Ошибка при проверке статуса персонала:', error);
    isStaff = false;
    currentStaffPosition = '';
    setCachedStaffStatus(false, '');
    updateStaffNavigation();
  }
}

function updateStaffNavigation() {
  const staffNavBtn = document.getElementById('staff-nav-btn');
  const staffManageBtn = document.getElementById('staff-manage-btn-work');
  
  if (isStaff) {
    staffNavBtn.classList.remove('hidden');
    
    // Показываем кнопку управления персоналом только для администраторов и владельцев
    if (currentStaffPosition && (
      currentStaffPosition.toLowerCase() === 'администратор' || 
      currentStaffPosition.toLowerCase() === 'владелец' || 
      currentStaffPosition.toLowerCase() === 'тех. админ'
    )) {
      staffManageBtn.style.display = 'flex';
    } else {
      staffManageBtn.style.display = 'none';
    }
  } else {
    staffNavBtn.classList.add('hidden');
    staffManageBtn.style.display = 'none';
    // Если персонал пытается перейти на скрытую страницу, показываем главную
    if (document.getElementById('staff').classList.contains('active')) {
      showPage('home');
    }
  }
}

/* ====== ПРОФИЛЬ ИЗ TELEGRAM ====== */
const user = tg.initDataUnsafe?.user;
let currentUserData = null;
let isStaff = false;

if (user) {
  document.getElementById('profile-name').innerText = user.first_name || '—';
  document.getElementById('profile-username').innerText = user.username ? '@' + user.username : '—';

  if (user.photo_url) {
    document.getElementById('avatar').innerHTML = `<img src="${user.photo_url}">`;
  }
  
  // Автоматическая регистрация пользователя
  registerUserIfNeeded(user);
  
  // Загружаем данные профиля из БД
  loadProfileData(user.id);
  
  // Проверяем, является ли пользователь сотрудником
  const cachedStaff = getCachedStaffStatus();
  if (cachedStaff) {
    isStaff = cachedStaff.isStaff;
    currentStaffPosition = cachedStaff.position || '';
    updateStaffNavigation();
  }

  checkStaffStatus(user.id);
}

/* ====== ЗАГРУЗКА ДАННЫХ ПРОФИЛЯ ====== */
async function loadProfileData(telegramId) {
  try {
    // Небольшая задержка, чтобы дать время на регистрацию
    await new Promise(resolve => setTimeout(resolve, 500));
    
    const response = await fetch(`/users/${telegramId}`);
    
    if (!response.ok) {
      console.error('Ошибка при загрузке профиля:', response.status);
      showNotification('⚠️ Не удалось загрузить профиль. Попробуйте позже.');
      return;
    }
    
    const data = await response.json();
    currentUserData = data;
    
    console.log('✅ Профиль загружен:', data);
    
    // Заполняем форму данными
    document.getElementById('profile-input-name').value = data.name || '';
    document.getElementById('profile-input-phone').value = data.phone || '';
    document.getElementById('profile-input-email').value = data.email || '';
    document.getElementById('profile-input-birth-date').value = data.birth_date || '';
    document.getElementById('profile-input-user-notes').value = data.user_notes || '';
    document.getElementById('profile-status').innerText = getStatusText(data.status);
    document.getElementById('profile-registered').innerText = formatDate(data.registered_at);
    
    // Загружаем фото если существует
    if (data.photo_path) {
      displayProfilePhoto(data.photo_path);
    }
    
    // Обновляем информацию на панели персонала
    if (isStaff) {
      displayStaffInfo(data);
    }
    
  } catch (error) {
    console.error('Ошибка при загрузке профиля:', error);
    showNotification('❌ Ошибка при загрузке профиля');
  }
}

/* ====== СОХРАНЕНИЕ ИЗМЕНЕНИЙ ПРОФИЛЯ ====== */
async function saveProfileChanges() {
  if (!currentUserData) {
    showNotification('❌ Данные профиля не загружены');
    return;
  }
  
  const telegramId = currentUserData.telegram_id;
  
  const updatedData = {
    name: document.getElementById('profile-input-name').value.trim(),
    phone: document.getElementById('profile-input-phone').value.trim(),
    email: document.getElementById('profile-input-email').value.trim() || null,
    birth_date: document.getElementById('profile-input-birth-date').value || null,
    user_notes: document.getElementById('profile-input-user-notes').value.trim() || null
  };
  
  // Проверяем, что имя и телефон не пустые
  if (!updatedData.name) {
    showNotification('⚠️ Введите имя');
    return;
  }
  if (!updatedData.phone) {
    showNotification('⚠️ Введите номер телефона');
    return;
  }
  
  try {
    console.log('Отправляем данные:', updatedData);
    
    const response = await fetch(`/users/${telegramId}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(updatedData)
    });
    
    if (response.ok) {
      const newData = await response.json();
      currentUserData = newData;
      
      console.log('✅ Профиль сохранен:', newData);
      
      // Обновляем отображение имени
      document.getElementById('profile-name').innerText = newData.name;
      
      showNotification('✅ Профиль успешно обновлен!');
    } else {
      const error = await response.json();
      console.error('Ошибка сервера:', error);
      showNotification('❌ Ошибка: ' + (error.error || 'неизвестная ошибка'));
    }
  } catch (error) {
    console.error('Ошибка при сохранении профиля:', error);
    showNotification('❌ Ошибка при сохранении профиля');
  }
}

/* ====== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ====== */
function getStatusText(status) {
  const statusMap = {
    'active': '✅ Активен',
    'inactive': '⏸️ Неактивен',
    'frozen': '❄️ Заморозка'
  };
  return statusMap[status] || status;
}

function loadProfileTransactions() {
  const container = document.getElementById('profile-transactions-container');
  if (!container) return;
  container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">Загрузка...</p>';

  fetch('/api/payment-transactions/my', { headers: getAuthHeaders() })
    .then(async res => {
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Не удалось загрузить транзакции');
      return data;
    })
    .then(items => {
      if (!items.length) {
        container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">Транзакций нет</p>';
        return;
      }
      container.innerHTML = items.map(t => {
        const amount = `${t.amount} ${t.currency || 'RUB'}`;
        const status = formatPaymentStatus(t.status);
        const created = t.created_at ? formatDate(t.created_at) : '?';
        return `
          <div class="card">
            <div style="font-weight: 600; margin-bottom: 6px;">${amount}</div>
            <div class="small" style="margin-bottom: 4px;">${status}</div>
            <div class="small">${t.description || 'Платеж'}</div>
            <div class="small" style="margin-top: 6px;">${created}</div>
          </div>
        `;
      }).join('');
    })
    .catch(err => {
      container.innerHTML = `<p class="small" style="text-align: center; color: #c62828; padding: 20px;">Ошибка: ${err.message}</p>`;
    });
}

function loadProfileAbonements() {
  const container = document.getElementById('profile-abonements-container');
  if (!container) return;
  container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">Загрузка...</p>';

  fetch('/api/group-abonements/my', { headers: getAuthHeaders() })
    .then(async res => {
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Не удалось загрузить абонементы');
      return data;
    })
    .then(items => {
      if (!items.length) {
        container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">Абонементов нет</p>';
        return;
      }
      container.innerHTML = items.map(a => {
        const status = formatAbonementStatus(a.status);
        const validTo = a.valid_to ? formatDate(a.valid_to) : '?';
        return `
          <div class="card">
            <div style="font-weight: 600; margin-bottom: 6px;">${a.group_name || 'Группа'}</div>
            <div class="small" style="margin-bottom: 4px;">${status}</div>
            <div class="small">Остаток занятий: ${a.balance_credits ?? '—'}</div>
            <div class="small" style="margin-top: 6px;">Действует до: ${validTo}</div>
          </div>
        `;
      }).join('');
    })
    .catch(err => {
      container.innerHTML = `<p class="small" style="text-align: center; color: #c62828; padding: 20px;">Ошибка: ${err.message}</p>`;
    });
}

function loadProfileGroups() {
  const container = document.getElementById('profile-groups-container');
  if (!container) return;
  container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">Загрузка...</p>';

  fetch('/api/groups/my', { headers: getAuthHeaders() })
    .then(async res => {
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Не удалось загрузить группы');
      return data;
    })
    .then(items => {
      if (!items.length) {
        container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">Групп нет</p>';
        return;
      }
      container.innerHTML = items.map(g => {
        const teacher = g.teacher_name ? g.teacher_name : '?';
        return `
          <div class="card">
            <div style="font-weight: 600; margin-bottom: 6px;">${g.group_name || 'Группа'}</div>
            <div class="small" style="margin-bottom: 4px;">${g.direction_title || ''}</div>
            <div class="small">Преподаватель: ${teacher}</div>
          </div>
        `;
      }).join('');
    })
    .catch(err => {
      container.innerHTML = `<p class="small" style="text-align: center; color: #c62828; padding: 20px;">Ошибка: ${err.message}</p>`;
    });
}

function formatPaymentStatus(status) {
  const map = {
    pending: 'Ожидание оплаты',
    paid: 'Оплачено',
    failed: 'Ошибка',
    refunded: 'Возврат',
    cancelled: 'Отменено'
  };
  return map[status] || status || '?';
}

function formatAbonementStatus(status) {
  const map = {
    pending_activation: 'Ожидает активации',
    active: 'Активен',
    expired: 'Истек',
    blocked: 'Заблокирован'
  };
  return map[status] || status || '?';
}

function formatDate(dateString) {
  const date = new Date(dateString);
  return date.toLocaleDateString('ru-RU', { 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
}

/* ====== УПРАВЛЕНИЕ КЛИЕНТАМИ (ПЕРСОНАЛ) ====== */
let allClients = [];

async function loadAllClients() {
  try {
    const container = document.getElementById('staff-clients-container');
    container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">⏳ Загрузка...</p>';
    
    // Загружаем информацию о текущем пользователе (персонале)
    if (currentUserData) {
      displayStaffInfo(currentUserData);
    }
    
    const response = await fetch('/users/list/all');
    
    if (!response.ok) {
      container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">❌ Ошибка при загрузке клиентов</p>';
      return;
    }
    
    allClients = await response.json();
    
    if (allClients.length === 0) {
      container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">📭 Клиентов еще нет</p>';
      return;
    }
    
    displayClients(allClients);
    console.log(`✅ Загружено ${allClients.length} клиентов`);
  } catch (error) {
    console.error('Ошибка при загрузке клиентов:', error);
    document.getElementById('staff-clients-container').innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">❌ Ошибка сети</p>';
  }
}

function searchClients() {
  const searchTerm = document.getElementById('staff-search-input').value.toLowerCase();
  
  if (!searchTerm) {
    loadAllClients();
    return;
  }
  
  // Фильтруем по имени или ID
  const filtered = allClients.filter(client => 
    client.name.toLowerCase().includes(searchTerm) ||
    client.telegram_id.toString().includes(searchTerm)
  );
  
  displayClients(filtered);
}

/* ====== ОТОБРАЖЕНИЕ ИНФОРМАЦИИ О ПЕРСОНАЛЕ ====== */
async function displayStaffInfo(userData) {
  try {
    // Получаем информацию о персонале
    const response = await fetch(`/staff/check/${userData.telegram_id}`);
    
    if (!response.ok) {
      console.error('Не удалось загрузить информацию о персонале');
      return;
    }
    
    const data = await response.json();
    
    if (data.is_staff && data.staff) {
      const staff = data.staff;
      
      // Обновляем ФИО
      document.getElementById('staff-panel-name').textContent = staff.name;
      
      // Обновляем должность
      const positionText = staff.position.charAt(0).toUpperCase() + staff.position.slice(1);
      document.getElementById('staff-panel-position').textContent = positionText;
      
      // Обновляем фото
      if (staff.photo_path) {
        const img = document.getElementById('staff-panel-avatar-img');
        const mediaUrl = buildMediaUrl(staff.photo_path);
        if (mediaUrl) img.src = mediaUrl;
        img.style.display = 'block';
        document.querySelector('.staff-avatar-small p').style.display = 'none';
      }

      window.currentStaffProfileId = staff.id;
    }
  } catch (error) {
    console.error('Ошибка при загрузке информации о персонале:', error);
  }
}

async function openStaffProfileEdit() {
  if (!currentUserData) {
    showNotification('⚠️ Профиль не загружен');
    return;
  }

  try {
    const response = await fetch(`/staff/check/${currentUserData.telegram_id}`);
    if (!response.ok) {
      showNotification('❌ Не удалось загрузить профиль');
      return;
    }
    const data = await response.json();
    if (!data.is_staff || !data.staff) {
      showNotification('❌ Профиль персонала не найден');
      return;
    }

    const staff = data.staff;
    window.currentStaffProfileId = staff.id;
    document.getElementById('staff-profile-name').value = staff.name || '';
    document.getElementById('staff-profile-specialization').value = staff.specialization || '';
    document.getElementById('staff-profile-bio').value = staff.bio || '';
    document.getElementById('staff-profile-phone').value = staff.phone || '';
    document.getElementById('staff-profile-email').value = staff.email || '';
    const teachesGroup = document.getElementById('staff-profile-teaches-group');
    const teachesCheckbox = document.getElementById('staff-profile-teaches');
    if (teachesCheckbox) {
      teachesCheckbox.checked = !!staff.teaches;
    }
    if (teachesGroup) {
      const isOwner = (currentStaffPosition || '').toLowerCase() === 'владелец';
      teachesGroup.style.display = isOwner ? 'block' : 'none';
    }

    showPage('staff-profile-edit');
  } catch (error) {
    console.error('Ошибка при открытии профиля персонала:', error);
    showNotification('❌ Ошибка сети');
  }
}

async function saveStaffProfile() {
  const staffId = window.currentStaffProfileId;
  if (!staffId) {
    showNotification('❌ ID персонала не найден');
    return;
  }

  const name = document.getElementById('staff-profile-name').value.trim();
  const specialization = document.getElementById('staff-profile-specialization').value.trim();
  const bio = document.getElementById('staff-profile-bio').value.trim();
  const phone = document.getElementById('staff-profile-phone').value.trim();
  const email = document.getElementById('staff-profile-email').value.trim();
  const teachesCheckbox = document.getElementById('staff-profile-teaches');
  const isOwner = (currentStaffPosition || '').toLowerCase() === 'владелец';

  try {
    const payload = {
      name: name || null,
      specialization: specialization || null,
      bio: bio || null,
      phone: phone || null,
      email: email || null
    };
    if (isOwner && teachesCheckbox) {
      payload.teaches = teachesCheckbox.checked ? 1 : 0;
    }
    const response = await fetch(`/staff/${staffId}`, {
      method: 'PUT',
      headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
      body: JSON.stringify(payload)
    });

    const data = await response.json();
    if (!response.ok) {
      showNotification('❌ ' + (data.error || 'Не удалось сохранить'));
      return;
    }

    showNotification('✅ Профиль обновлен');
    if (currentUserData) {
      displayStaffInfo(currentUserData);
    }
    goBack();
  } catch (error) {
    console.error('Ошибка при сохранении профиля персонала:', error);
    showNotification('❌ Ошибка сети');
  }
}

// ====== РАБОЧИЕ ЧАСЫ ПРЕПОДАВАТЕЛЯ ======
let workingHoursView = 'week';
let currentWorkingHoursTeacherId = null;
let teacherWorkingHours = [];
let nonWorkingSlots = new Set();
let workingHoursDragActive = false;
let workingHoursDragValue = null;
let workingHoursDragBound = false;

const WORKING_WEEKDAY_LABELS = [
  'Понедельник',
  'Вторник',
  'Среда',
  'Четверг',
  'Пятница',
  'Суббота',
  'Воскресенье'
];
const WORKING_WEEKDAY_SHORT = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'];

function openTeacherWorkingHours() {
  const staffId = window.currentStaffProfileId;
  if (!staffId) {
    showNotification('❌ ID персонала не найден');
    return;
  }
  currentWorkingHoursTeacherId = staffId;
  workingHoursView = 'week';
  const daySelect = document.getElementById('working-hours-day-select');
  if (daySelect) {
    daySelect.value = '0';
  }
  loadTeacherWorkingHours();
  showPage('teacher-working-hours');
}

function setWorkingHoursView(view) {
  workingHoursView = view;
  const weekBtn = document.getElementById('working-hours-view-week');
  const dayBtn = document.getElementById('working-hours-view-day');
  if (weekBtn && dayBtn) {
    weekBtn.classList.toggle('active', view === 'week');
    dayBtn.classList.toggle('active', view === 'day');
  }
  const daySelectGroup = document.getElementById('working-hours-day-select-group');
  if (daySelectGroup) {
    daySelectGroup.style.display = view === 'day' ? 'block' : 'none';
  }
  renderWorkingHoursEditor();
}

async function loadTeacherWorkingHours() {
  if (!currentWorkingHoursTeacherId) return;
  try {
    const response = await fetch(`/teacher-working-hours/${currentWorkingHoursTeacherId}`, {
      headers: getAuthHeaders()
    });
    const data = await response.json();
    if (!response.ok) {
      showNotification('❌ ' + (data.error || 'Не удалось загрузить рабочие часы'));
      return;
    }
    teacherWorkingHours = Array.isArray(data) ? data : [];
    buildNonWorkingSlots();
    renderWorkingHoursEditor();
  } catch (error) {
    console.error('Ошибка при загрузке рабочих часов:', error);
    showNotification('❌ Ошибка сети');
  }
}

function renderWorkingHoursEditor() {
  const container = document.getElementById('working-hours-container');
  if (!container) return;

  container.innerHTML = renderWorkingHoursGrid();
  bindWorkingHoursDrag(container);
}

function getAllSlotTimes() {
  const slots = [];
  for (let t = WORK_START_HOUR * 60; t < WORK_END_HOUR * 60; t += SLOT_MINUTES) {
    slots.push(minutesToTime(t));
  }
  return slots;
}

function buildNonWorkingSlots() {
  const activeIntervals = teacherWorkingHours.filter(i => i.status !== 'archived');
  if (activeIntervals.length === 0) {
    nonWorkingSlots = new Set();
    return;
  }

  const allSlots = new Set();
  const slotTimes = getAllSlotTimes();
  for (let d = 0; d <= 6; d++) {
    for (const time of slotTimes) {
      allSlots.add(`${d}|${time}`);
    }
  }

  activeIntervals.forEach(i => {
      if (!i.time_from || !i.time_to) return;
      const start = timeToMinutes(i.time_from);
      const end = timeToMinutes(i.time_to);
      for (let t = start; t < end; t += SLOT_MINUTES) {
        allSlots.delete(`${i.weekday}|${minutesToTime(t)}`);
      }
    });

  nonWorkingSlots = allSlots;
}

function renderWorkingHoursGrid() {
  const slots = getAllSlotTimes();

  if (workingHoursView === 'day') {
    const weekday = parseInt(document.getElementById('working-hours-day-select')?.value || '0', 10);
    let html = `<div class="schedule-grid day">`;
    html += `<div class="schedule-cell head">Время</div><div class="schedule-cell head">${WORKING_WEEKDAY_LABELS[weekday]}</div>`;
    for (const time of slots) {
      const timeClass = isHalfHour(time) ? 'schedule-cell time half' : 'schedule-cell time';
      html += `<div class="${timeClass}">${formatTimeLabel(time)}</div>`;
      html += renderWorkingHoursSlotCell(weekday, time);
    }
    html += `</div>`;
    return html;
  }

  let html = `<div class="schedule-grid">`;
  html += `<div class="schedule-cell head">Время</div>`;
  for (let d = 0; d <= 6; d++) {
    html += `<div class="schedule-cell head">${WORKING_WEEKDAY_SHORT[d]}</div>`;
  }
  for (const time of slots) {
    const timeClass = isHalfHour(time) ? 'schedule-cell time half' : 'schedule-cell time';
    html += `<div class="${timeClass}">${formatTimeLabel(time)}</div>`;
    for (let d = 0; d <= 6; d++) {
      html += renderWorkingHoursSlotCell(d, time);
    }
  }
  html += `</div>`;
  return html;
}

function renderWorkingHoursSlotCell(weekday, timeStr) {
  const key = `${weekday}|${timeStr}`;
  const isNonWorking = nonWorkingSlots.has(key);
  const className = isNonWorking ? 'schedule-cell schedule-slot non-working' : 'schedule-cell schedule-slot';
  return `<div class="${className}" data-wh-slot="1" data-weekday="${weekday}" data-time="${timeStr}" onclick="toggleWorkingHoursSlot(${weekday}, '${timeStr}')"></div>`;
}

function toggleWorkingHoursSlot(weekday, timeStr) {
  const key = `${weekday}|${timeStr}`;
  if (nonWorkingSlots.has(key)) {
    nonWorkingSlots.delete(key);
  } else {
    nonWorkingSlots.add(key);
  }
  renderWorkingHoursEditor();
}

function setNonWorkingSlot(weekday, timeStr, makeNonWorking, cellEl) {
  const key = `${weekday}|${timeStr}`;
  if (makeNonWorking) {
    nonWorkingSlots.add(key);
    if (cellEl) cellEl.classList.add('non-working');
  } else {
    nonWorkingSlots.delete(key);
    if (cellEl) cellEl.classList.remove('non-working');
  }
}

function bindWorkingHoursDrag(container) {
  if (workingHoursDragBound) return;
  workingHoursDragBound = true;

  container.addEventListener('pointerdown', (event) => {
    const target = event.target.closest('[data-wh-slot]');
    if (!target) return;
    event.preventDefault();
    const weekday = parseInt(target.dataset.weekday, 10);
    const timeStr = target.dataset.time;
    const isNonWorking = nonWorkingSlots.has(`${weekday}|${timeStr}`);
    workingHoursDragActive = true;
    workingHoursDragValue = !isNonWorking;
    setNonWorkingSlot(weekday, timeStr, workingHoursDragValue, target);
  });

  container.addEventListener('pointerover', (event) => {
    if (!workingHoursDragActive) return;
    const target = event.target.closest('[data-wh-slot]');
    if (!target) return;
    const weekday = parseInt(target.dataset.weekday, 10);
    const timeStr = target.dataset.time;
    setNonWorkingSlot(weekday, timeStr, workingHoursDragValue, target);
  });

  window.addEventListener('pointerup', () => {
    workingHoursDragActive = false;
    workingHoursDragValue = null;
  });
}

function buildIntervalsFromSlots() {
  const byDay = new Map();
  const slotTimes = getAllSlotTimes();
  for (let day = 0; day <= 6; day++) {
    for (const timeStr of slotTimes) {
      const key = `${day}|${timeStr}`;
      if (!nonWorkingSlots.has(key)) {
        if (!byDay.has(day)) byDay.set(day, []);
        byDay.get(day).push(timeToMinutes(timeStr));
      }
    }
  }

  const items = [];
  for (let day = 0; day <= 6; day++) {
    const times = (byDay.get(day) || []).sort((a, b) => a - b);
    if (times.length === 0) continue;
    let start = times[0];
    let prev = times[0];
    for (let i = 1; i < times.length; i++) {
      const t = times[i];
      if (t === prev + SLOT_MINUTES) {
        prev = t;
        continue;
      }
      items.push({
        weekday: day,
        time_from: minutesToTime(start),
        time_to: minutesToTime(prev + SLOT_MINUTES)
      });
      start = t;
      prev = t;
    }
    items.push({
      weekday: day,
      time_from: minutesToTime(start),
      time_to: minutesToTime(prev + SLOT_MINUTES)
    });
  }
  return items;
}

async function saveTeacherWorkingHours() {
  if (!currentWorkingHoursTeacherId) {
    showNotification('❌ ID персонала не найден');
    return;
  }
  const items = buildIntervalsFromSlots();
  try {
    const response = await fetch(`/teacher-working-hours/${currentWorkingHoursTeacherId}`, {
      method: 'PUT',
      headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
      body: JSON.stringify({ items })
    });
    const data = await response.json();
    if (!response.ok) {
      showNotification('❌ ' + (data.error || 'Не удалось сохранить'));
      return;
    }
    teacherWorkingHours = Array.isArray(data.items) ? data.items : teacherWorkingHours;
    buildNonWorkingSlots();
    showNotification('✅ Рабочие часы сохранены');
    renderWorkingHoursEditor();
  } catch (error) {
    console.error('Ошибка при сохранении рабочих часов:', error);
    showNotification('❌ Ошибка сети');
  }
}

function displayClients(clients) {
  const container = document.getElementById('staff-clients-container');
  
  if (clients.length === 0) {
    container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">Клиентов не найдено</p>';
    return;
  }
  
  container.innerHTML = clients.map(client => `
    <div class="client-card" onclick="viewClientDetails(${client.telegram_id})">
      <div class="client-card-header">
        <div class="client-card-name">${client.name}</div>
        <div class="client-card-status">${getStatusText(client.status)}</div>
      </div>
      
      <div class="client-card-info">
        ${client.phone ? `
          <div class="client-info-item">
            <div class="client-info-label">📱 Телефон</div>
            <div class="client-info-value">${client.phone}</div>
          </div>
        ` : ''}
        ${client.email ? `
          <div class="client-info-item">
            <div class="client-info-label">📧 Email</div>
            <div class="client-info-value">${client.email}</div>
          </div>
        ` : ''}
      </div>
      
      ${client.user_notes ? `<div class="client-card-notes"><strong>🎯 Пожелания:</strong> ${client.user_notes}</div>` : ''}
      ${client.staff_notes ? `<div class="client-card-notes"><strong>📌 Заметки персонала:</strong> ${client.staff_notes}</div>` : ''}
    </div>
  `).join('');
}

function viewClientDetails(telegramId) {
  // TODO: Открыть модальное окно или отдельную страницу с полной информацией клиента
  console.log('Просмотр клиента:', telegramId);
  showNotification('Функция в разработке');
}

/* ====== РАБОТА С ФОТО ПРОФИЛЯ ====== */
function displayProfilePhoto(photoPath) {
  const img = document.getElementById('profile-photo-img');
  const placeholder = document.getElementById('profile-photo-placeholder');
  
  const mediaUrl = buildMediaUrl(photoPath);
  if (mediaUrl) {
    img.src = mediaUrl;
  }
  img.style.display = 'block';
  placeholder.style.display = 'none';
}

async function uploadProfilePhoto() {
  if (!isStaff) {
    showNotification('❌ Загрузка фото доступна только для персонала');
    return;
  }
  
  if (!currentUserData) {
    showNotification('❌ Данные профиля не загружены');
    return;
  }
  
  const fileInput = document.getElementById('profile-photo-input');
  if (!fileInput.files || fileInput.files.length === 0) {
    showNotification('⚠️ Выберите файл');
    return;
  }
  
  const file = fileInput.files[0];
  const telegramId = currentUserData.telegram_id;
  
  // Проверяем размер
  if (file.size > 5 * 1024 * 1024) {
    showNotification('❌ Размер файла не должен превышать 5 МБ');
    return;
  }
  
  try {
    const formData = new FormData();
    formData.append('photo', file);
    
    console.log('Загружаем фото...');
    
    const response = await fetch(`/users/${telegramId}/photo`, {
      method: 'POST',
      body: formData
    });
    
    if (response.ok) {
      const data = await response.json();
      currentUserData.photo_path = data.photo_path;
      displayProfilePhoto(data.photo_path);
      showNotification('✅ Фото успешно загружено!');
      fileInput.value = '';
    } else {
      const error = await response.json();
      showNotification('❌ Ошибка: ' + (error.error || 'неизвестная ошибка'));
    }
  } catch (error) {
    console.error('Ошибка при загрузке фото:', error);
    showNotification('❌ Ошибка при загрузке фото');
  }
}

async function deleteProfilePhoto() {
  if (!isStaff) {
    showNotification('❌ Удаление фото доступно только для персонала');
    return;
  }
  
  if (!currentUserData) {
    showNotification('❌ Данные профиля не загружены');
    return;
  }
  
  if (!currentUserData.photo_path) {
    showNotification('⚠️ Фото не найдено');
    return;
  }
  
  try {
    const response = await fetch(`/users/${currentUserData.telegram_id}/photo`, {
      method: 'DELETE'
    });
    
    if (response.ok) {
      currentUserData.photo_path = null;
      
      const img = document.getElementById('profile-photo-img');
      const placeholder = document.getElementById('profile-photo-placeholder');
      img.style.display = 'none';
      placeholder.style.display = 'block';
      
      showNotification('✅ Фото удалено!');
    } else {
      const error = await response.json();
      showNotification('❌ Ошибка: ' + (error.error || 'неизвестная ошибка'));
    }
  } catch (error) {
    console.error('Ошибка при удалении фото:', error);
    showNotification('❌ Ошибка при удалении фото');
  }
}

/* ====== АВТОМАТИЧЕСКАЯ РЕГИСТРАЦИЯ ====== */
async function registerUserIfNeeded(user) {
  try {
    // Проверяем, зарегистрирован ли уже пользователь
    const checkResponse = await fetch(`/users/${user.id}`);
    
    if (checkResponse.ok) {
      // Пользователь уже зарегистрирован
      console.log('Пользователь уже в системе');
      return;
    }
    
    // Если пользователя нет, регистрируем его
    console.log('Регистрируем нового пользователя...');
    
    const registerResponse = await fetch('/users', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        telegram_id: user.id,
        username: user.username,
        phone: '',  // Пусто, заполнит в профиле
        name: user.first_name || 'Пользователь',
        email: null,
        birth_date: null,
        notes: null
      })
    });
    
    if (registerResponse.ok) {
      console.log('✅ Пользователь успешно зарегистрирован');
      showNotification('Добро пожаловать! Пожалуйста, заполните ваши данные.');
      
      // Даем время на регистрацию и загружаем профиль
      setTimeout(() => loadProfileData(user.id), 1000);
    } else {
      const error = await registerResponse.json();
      console.error('Ошибка регистрации:', error);
    }
  } catch (error) {
    console.error('Ошибка при проверке регистрации:', error);
  }
}

/* DEBUG VERSION */
console.log("Mini App version:", new URLSearchParams(location.search).get("v"));

/* ====== STAFF PROFILE ====== */
const NEWS_CACHE_KEY = 'news_cache_v1';
const NEWS_ETAG_KEY = 'news_etag_v1';
let cachedNews = null;

function getCachedNews() {
  if (cachedNews) return cachedNews;
  try {
    const raw = localStorage.getItem(NEWS_CACHE_KEY);
    if (!raw) return null;
    const parsed = JSON.parse(raw);
    if (!Array.isArray(parsed)) return null;
    cachedNews = parsed;
    return parsed;
  } catch (err) {
    return null;
  }
}

function setCachedNews(news, etag) {
  cachedNews = news;
  try {
    localStorage.setItem(NEWS_CACHE_KEY, JSON.stringify(news));
    if (etag) {
      localStorage.setItem(NEWS_ETAG_KEY, etag);
    }
  } catch (err) {
    // ignore cache write errors
  }
}

function renderNewsList(news) {
  const container = document.getElementById('news-container');
  if (!container) return;

  if (!news || news.length === 0) {
    container.innerHTML = '<p class="news-empty">Новостей пока нет v-v</p>';
    return;
  }

  container.innerHTML = news.map(n => `
    <div class="news-item" onclick="showNewsDetail(${n.id})">
      ${n.photo_path ? `<img src="${n.photo_path}" alt="Новость">` : ''}
      <div class="news-item-title">${n.title}</div>
    </div>
  `).join('');
}

// Показать кэш сразу, если есть
const initialCachedNews = getCachedNews();
if (initialCachedNews) {
  renderNewsList(initialCachedNews);
}

async function loadNews() {
  try {
    const cached = getCachedNews();
    if (cached) {
      renderNewsList(cached);
    }

    const headers = {};
    const etag = localStorage.getItem(NEWS_ETAG_KEY);
    if (etag) {
      headers['If-None-Match'] = etag;
    }

    const response = await fetch('/news', { headers });
    if (response.status === 304) {
      return;
    }
    if (!response.ok) {
      throw new Error('Не удалось загрузить новости');
    }

    const news = await response.json();
    setCachedNews(news, response.headers.get('ETag'));
    renderNewsList(news);
  } catch (error) {
    console.error('Ошибка загрузки новостей:', error);
  }
}

async function loadNewsManage() {
  try {
    const response = await fetch('/news/manage', {
      headers: getAuthHeaders()
    });
    const news = await response.json();
    const container = document.getElementById('news-manage-container');
    
    if (news.length === 0) {
      container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">📭 Новостей пока нет</p>';
      return;
    }
    
    container.innerHTML = news.map(n => `
      <div class="card" style="cursor: pointer; margin-bottom: 12px;">
        ${n.photo_path ? `<div style="width: 100%; height: 150px; background: var(--hint); border-radius: 8px 8px 0 0; overflow: hidden; margin: -12px -12px 8px -12px;"><img src="${n.photo_path}" style="width: 100%; height: 100%; object-fit: cover;"></div>` : ''}
        <div style="font-weight: 600; font-size: 16px;">${n.title}</div>
        <div style="font-size: 12px; color: var(--hint); margin-top: 4px;">${new Date(n.created_at).toLocaleDateString('ru-RU')} ${n.status === 'archived' ? '📦 В архиве' : ''}</div>
        <div style="font-size: 13px; margin-top: 8px; color: var(--text);">${n.content.substring(0, 100)}...</div>
        <div style="display: flex; gap: 8px; margin-top: 8px;">
          ${n.status === 'active' ? `<button class="save-btn" onclick="archiveNews(${n.id})" style="flex: 1; background: #ffa940; margin: 0;">� Архив</button>` : `<button class="save-btn" onclick="restoreNews(${n.id})" style="flex: 1; background: #52c41a; margin: 0;">↩️ Вернуть</button>`}
          <button class="save-btn" onclick="deleteNews(${n.id})" style="flex: 1; background: #ff6b6b; margin: 0;">🗑️ Удалить</button>
        </div>
      </div>
    `).join('');
  } catch (error) {
    console.error('Ошибка загрузки новостей:', error);
    document.getElementById('news-manage-container').innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">❌ Ошибка при загрузке</p>';
  }
}

async function openBotForCreateNews() {
  // Открываем бота для создания новости
  try {
    // Получаем имя бота с сервера
    const response = await fetch('/bot-username');
    const data = await response.json();
    const botUsername = data.bot_username || 'dance_studio_admin_bot';
    
    // Открываем бота с параметром start
    window.open(`https://t.me/${botUsername}?start=create_news`, '_blank');
  } catch (error) {
    console.error('Ошибка при получении имени бота:', error);
    window.open('https://t.me/dance_studio_admin_bot?start=create_news', '_blank');
  }
}

async function openBotForStaffPhoto() {
  const staffId = window.currentStaffProfileId;
  if (!staffId) {
    showNotification('❌ ID персонала не найден');
    return;
  }
  try {
    const response = await fetch('/bot-username');
    const data = await response.json();
    const botUsername = data.bot_username || 'dance_studio_admin_bot';
    const botLink = `https://t.me/${botUsername}?start=staff_photo_${staffId}`;
    if (tg?.openLink) {
      tg.openLink(botLink);
    } else {
      window.open(botLink, '_blank');
    }
  } catch (error) {
    window.open(`https://t.me/dance_studio_admin_bot?start=staff_photo_${staffId}`, '_blank');
  }
}

function openStaffPhotoPicker() {
  const input = document.getElementById('staff-profile-photo-input');
  if (input) {
    input.value = '';
    input.click();
  }
}

async function uploadStaffPhotoFromGallery() {
  const staffId = window.currentStaffProfileId;
  if (!staffId) {
    showNotification('❌ ID персонала не найден');
    return;
  }
  const input = document.getElementById('staff-profile-photo-input');
  const file = input?.files?.[0];
  if (!file) return;

  try {
    const formData = new FormData();
    formData.append('photo', file);

    const response = await fetch(`/staff/${staffId}/photo`, {
      method: 'POST',
      body: formData,
      headers: getAuthHeaders()
    });

    if (response.ok) {
      const data = await response.json();
      showNotification('✅ Фото загружено');
      if (data.photo_path) {
        const mediaUrl = buildMediaUrl(data.photo_path);
        const staffAvatar = document.getElementById('staff-panel-avatar-img');
        if (mediaUrl && staffAvatar) {
          staffAvatar.src = mediaUrl;
          staffAvatar.style.display = 'block';
          document.querySelector('.staff-avatar-small p').style.display = 'none';
        }
      }
      return;
    }

    const error = await response.json();
    showNotification('❌ ' + (error.error || 'Не удалось загрузить фото'));
  } catch (error) {
    console.error('Ошибка при загрузке фото персонала:', error);
    showNotification('❌ Ошибка сети при загрузке фото: ' + (error && error.message ? error.message : 'unknown'));
  }
}



async function deleteNews(newsId) {
  if (!confirm('Удалить эту новость?')) {
    return;
  }
  
  try {
    const response = await fetch(`/news/${newsId}`, {
      method: 'DELETE',
      headers: getAuthHeaders()
    });
    
    if (response.ok) {
      showNotification('✅ Новость удалена');
      loadNewsManage();
    } else {
      showNotification('❌ Ошибка при удалении');
    }
  } catch (error) {
    console.error('Ошибка при удалении новости:', error);
    showNotification('❌ Ошибка сети');
  }
}

async function archiveNews(newsId) {
  try {
    const response = await fetch(`/news/${newsId}/archive`, {
      method: 'PUT',
      headers: getAuthHeaders()
    });
    
    if (response.ok) {
      showNotification('✅ Новость отправлена в архив');
      loadNewsManage();
    } else {
      showNotification('❌ Ошибка при архивировании');
    }
  } catch (error) {
    console.error('Ошибка при архивировании новости:', error);
    showNotification('❌ Ошибка сети');
  }
}

async function restoreNews(newsId) {
  try {
    const response = await fetch(`/news/${newsId}/restore`, {
      method: 'PUT',
      headers: getAuthHeaders()
    });
    
    if (response.ok) {
      showNotification('✅ Новость восстановлена');
      loadNewsManage();
    } else {
      showNotification('❌ Ошибка при восстановлении');
    }
  } catch (error) {
    console.error('Ошибка при восстановлении новости:', error);
    showNotification('❌ Ошибка сети');
  }
}

function renderNewsDetail(newsItem) {
  document.getElementById('news-detail-title').innerText = newsItem.title;
  document.getElementById('news-detail-date').innerText = new Date(newsItem.created_at).toLocaleDateString('ru-RU', {
    day: 'numeric',
    month: 'long',
    year: 'numeric'
  });

  const photoContainer = document.getElementById('news-detail-photo-container');
  if (newsItem.photo_path) {
    photoContainer.innerHTML = `<img src="${newsItem.photo_path}" alt="Фото новости">`;
    photoContainer.style.height = '';
    photoContainer.style.marginBottom = '';
  } else {
    photoContainer.innerHTML = '';
    photoContainer.style.height = '0';
    photoContainer.style.marginBottom = '0';
  }

  document.getElementById('news-detail-content').innerText = newsItem.content;
  showPage('news-detail');
}

async function showNewsDetail(id) {
  try {
    const cached = getCachedNews();
    if (cached) {
      const newsItem = cached.find(n => n.id === id);
      if (newsItem) {
        renderNewsDetail(newsItem);
        return;
      }
    }

    const response = await fetch('/news');
    if (!response.ok) {
      throw new Error('Не удалось загрузить новость');
    }
    const news = await response.json();
    setCachedNews(news, response.headers.get('ETag'));
    const newsItem = news.find(n => n.id === id);
    if (newsItem) {
      renderNewsDetail(newsItem);
    }
  } catch (error) {
    console.error('Ошибка при загрузке новости:', error);
    showNotification('Ошибка при загрузке новости');
  }
}

function copyPhone(phone) {
  navigator.clipboard.writeText(phone).then(() => {
    // Показываем уведомление
    showNotification('Номер скопирован в буфер обмена!');
  }).catch(() => {
    alert('Не удалось скопировать номер');
  });
}

function openTelegram(username) {
  // Открываем Telegram в новой вкладке
  const telegramUrl = `https://t.me/${username.replace('@', '')}`;
  window.open(telegramUrl, '_blank');
}

function showNotification(message) {
  // Создаем простое уведомление
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--accent);
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 14px;
    z-index: 1000;
    animation: slideDown 0.3s ease-out;
  `;
  notification.innerText = message;
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.remove();
  }, 2000);
}

// Добавляем стили анимации
const style = document.createElement('style');
style.innerText = `
  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateX(-50%) translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
  }
`;
document.head.appendChild(style);

// Загружаем новости как можно раньше
document.addEventListener('DOMContentLoaded', loadNews);

// ======================== СИСТЕМА РАССЫЛОК ========================

// Хранилище для выбранных пользователей в рассылках
let selectedMailingUsers = new Map(); // { userId: userName }
let mailingAllUsers = []; // Все загруженные пользователи
let mailingsSendNow = true; // По умолчанию отправляем сейчас

function setMailingSendNow(value) {
  mailingsSendNow = value;
  
  // Обновляем стиль кнопок
  const nowBtn = document.getElementById('send-now-btn');
  const laterBtn = document.querySelectorAll('[onclick="setMailingSendNow(false)"]')[0];
  
  if (value) {
    nowBtn.style.background = 'var(--accent)';
    if (laterBtn) laterBtn.style.background = 'var(--hint)';
    document.getElementById('mailing-schedule-container').style.display = 'none';
  } else {
    nowBtn.style.background = 'var(--hint)';
    if (laterBtn) laterBtn.style.background = 'var(--accent)';
    document.getElementById('mailing-schedule-container').style.display = 'block';
  }
}

function onMailingTargetTypeChange() {
  const targetType = document.getElementById('mailing-target-type').value;
  const idContainer = document.getElementById('mailing-target-id-container');
  const usersContainer = document.getElementById('mailing-users-container');
  
  // Скрываем оба контейнера по умолчанию
  idContainer.style.display = 'none';
  usersContainer.style.display = 'none';
  
  // Показываем нужный контейнер
  if (targetType === 'user') {
    usersContainer.style.display = 'block';
    clearMailingUserSelection(); // Очищаем предыдущий выбор
    // Всегда загружаем пользователей
    loadMailingUsers();
  } else if (targetType === 'group' || targetType === 'direction' || targetType === 'tg_chat') {
    idContainer.style.display = 'block';
  }
}

async function loadMailingUsers() {
  try {
    console.log('Загрузка пользователей для рассылок...');
    
    // Загружаем всех пользователей
    const response = await fetch('/staff/search');
    if (!response.ok) {
      console.error('Ошибка при загрузке пользователей:', response.status);
      document.getElementById('mailing-users-search-results').innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 12px;">❌ Ошибка при загрузке</p>';
      return;
    }
    
    const users = await response.json();
    console.log('Загружено пользователей:', users.length);
    
    mailingAllUsers = users;
    displayMailingSearchResults(mailingAllUsers);
  } catch (error) {
    console.error('Ошибка при загрузке пользователей:', error);
    document.getElementById('mailing-users-search-results').innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 12px;">❌ Ошибка сети</p>';
  }
}

function searchMailingUsers() {
  const searchInput = document.getElementById('mailing-users-search');
  const search = searchInput.value.trim().toLowerCase();
  
  if (mailingAllUsers.length === 0) {
    console.log('Нет загруженных пользователей');
    return;
  }
  
  if (search.length === 0) {
    displayMailingSearchResults(mailingAllUsers);
    return;
  }
  
  let filtered = [];
  
  // Проверяем, ищет ли пользователь по юзернейму (с @)
  if (search.startsWith('@')) {
    // Поиск по юзернейму
    const usernameQuery = search.substring(1).toLowerCase();
    filtered = mailingAllUsers.filter(u => 
      u.username && u.username.toLowerCase().includes(usernameQuery)
    );
  } else {
    // Поиск по ID или имени
    filtered = mailingAllUsers.filter(u => 
      u.name.toLowerCase().includes(search) ||
      u.id.toString().includes(search) ||
      (u.telegram_id && u.telegram_id.toString().includes(search))
    );
  }
  
  if (filtered.length === 0) {
    document.getElementById('mailing-users-search-results').innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 12px;">Пользователи не найдены</p>';
  } else {
    displayMailingSearchResults(filtered);
  }
}

function displayMailingSearchResults(users) {
  const resultsHtml = users.map(u => {
    const isSelected = selectedMailingUsers.has(u.id);
    const bgColor = isSelected ? 'var(--accent)' : 'var(--card)';
    const textColor = isSelected ? '#fff' : 'var(--text)';
    const borderColor = isSelected ? 'var(--accent)' : 'var(--border)';
    const safeName = u.name.replace(/'/g, "\\'").replace(/"/g, '\\"');
    
    return `
      <div style="padding: 10px 12px; cursor: pointer; background: ${bgColor}; color: ${textColor}; border-left: 4px solid ${borderColor}; margin-bottom: 8px; border-radius: 6px; transition: all 0.2s; hover-background: opacity(0.9);" onclick="toggleMailingUserSelection(${u.id}, '${safeName}')">
        <div style="font-weight: 600; font-size: 14px; display: flex; align-items: center; justify-content: space-between;">
          <span>${u.name}</span>
          ${isSelected ? '<span style="font-size: 16px;">✓</span>' : ''}
        </div>
        <div class="small" style="opacity: 0.8; margin-top: 3px; font-size: 12px;">ID: ${u.telegram_id}${u.username ? ` • @${u.username}` : ''}</div>
      </div>
    `;
  }).join('');
  
  document.getElementById('mailing-users-search-results').innerHTML = resultsHtml || '<p class="small" style="text-align: center; color: var(--hint); padding: 12px;">Нет пользователей</p>';
}

function clearMailingUserSelection() {
  selectedMailingUsers.clear();
  document.getElementById('mailing-selected-users').innerHTML = '<p class="small" style="color: var(--hint); width: 100%;">Выбрано: <span id="mailing-users-count">0</span></p>';
  document.getElementById('mailing-users-count').textContent = '0';
}

function toggleMailingUserSelection(userId, userName) {
  if (selectedMailingUsers.has(userId)) {
    selectedMailingUsers.delete(userId);
  } else {
    selectedMailingUsers.set(userId, userName);
  }
  
  updateMailingSelectedUsersDisplay();
  searchMailingUsers(); // Обновляем результаты поиска
}

function updateMailingSelectedUsersDisplay() {
  const container = document.getElementById('mailing-selected-users');
  const count = selectedMailingUsers.size;
  
  if (count === 0) {
    container.innerHTML = '<p class="small" style="color: var(--hint); width: 100%; text-align: center; padding: 8px 0;">Выбранных пользователей: <span id="mailing-users-count" style="font-weight: 600; color: var(--accent);">0</span></p>';
    return;
  }
  
  let html = '<p class="small" style="color: var(--hint); width: 100%; text-align: center; padding: 8px 0; margin-bottom: 8px;">Выбрано: <span id="mailing-users-count" style="font-weight: 600; color: var(--accent);">' + count + '</span></p>';
  
  for (const [userId, userName] of selectedMailingUsers) {
    const safeName = userName.replace(/'/g, "\\'").replace(/"/g, '\\"');
    html += `
      <div style="background: var(--accent); color: white; padding: 8px 12px; border-radius: 20px; display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 500; box-shadow: 0 2px 4px rgba(233, 30, 99, 0.2);">
        <span>👤 ${userName}</span>
        <span onclick="toggleMailingUserSelection(${userId}, '${safeName}')" style="cursor: pointer; font-weight: bold; opacity: 0.8; hover: opacity(1);">✕</span>
      </div>
    `;
  }
  
  container.innerHTML = html;
}


async function createMailing() {
  try {
    const name = document.getElementById('mailing-name').value.trim();
    const description = document.getElementById('mailing-description').value.trim();
    const purpose = document.getElementById('mailing-purpose').value.trim();
    const targetType = document.getElementById('mailing-target-type').value;
    
    if (!name) {
      showNotification('❌ Введите название рассылки');
      return;
    }
    
    if (!purpose) {
      showNotification('❌ Введите назначение рассылки');
      return;
    }
    
    if (!targetType) {
      showNotification('❌ Выберите кому отправить');
      return;
    }
    
    // Если не "все пользователи", требуется ID
    let targetId = null;
    
    // Специальная обработка для пользователей
    if (targetType === 'user') {
      if (selectedMailingUsers.size === 0) {
        showNotification('❌ Выберите хотя бы одного пользователя');
        return;
      }
      // Для пользователей используем специальный формат (могут быть несколько)
      targetId = Array.from(selectedMailingUsers.keys()).join(',');
    } else if (targetType !== 'all') {
      // Для остальных типов требуется ID
      const targetIdInput = document.getElementById('mailing-target-id').value.trim();
      if (!targetIdInput) {
        showNotification('❌ Введите ID цели');
        return;
      }
      targetId = parseInt(targetIdInput);
    }
    
    // Если отправка позже, требуется дата
    let scheduledAt = null;
    if (!mailingsSendNow) {
      const scheduledAtInput = document.getElementById('mailing-scheduled-at').value;
      if (!scheduledAtInput) {
        showNotification('❌ Выберите дату и время отправки');
        return;
      }
      // datetime-local возвращает строку в формате "2026-01-23T19:11"
      // Преобразуем в ISO формат, сохраняя локальное время пользователя
      const [datePart, timePart] = scheduledAtInput.split('T');
      scheduledAt = `${datePart}T${timePart}:00`;  // Добавляем секунды если их нет
    }
    
    // Получаем ID создателя из localStorage или используем пример
    const staffId = localStorage.getItem('staff_id') || 1;
    
    const payload = {
      creator_id: parseInt(staffId),
      name: name,
      description: description || null,
      purpose: purpose,
      target_type: targetType,
      target_id: targetId,
      send_now: mailingsSendNow,
      scheduled_at: scheduledAt
    };
    
    const response = await fetch('/mailings', {
      method: 'POST',
      headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
      body: JSON.stringify(payload)
    });
    
    if (!response.ok) {
      const error = await response.json();
      showNotification('❌ ' + (error.error || 'Ошибка при создании рассылки'));
      return;
    }
    
    showNotification('✅ Рассылка создана успешно!');
    
    // Очищаем форму
    document.getElementById('mailing-name').value = '';
    clearMailingUserSelection();
    document.getElementById('mailing-description').value = '';
    document.getElementById('mailing-purpose').value = '';
    document.getElementById('mailing-target-type').value = '';
    document.getElementById('mailing-target-id').value = '';
    document.getElementById('mailing-scheduled-at').value = '';
    document.getElementById('mailing-users-search').value = '';
    document.getElementById('mailing-users-search-results').innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 12px;">Выберите тип рассылки "Выбранные пользователи" для поиска</p>';
    
    // Возвращаемся к списку рассылок
    setTimeout(() => {
      goBack();
      loadMailings();
    }, 1000);
    
  } catch (error) {
    console.error('Ошибка при создании рассылки:', error);
    showNotification('❌ Ошибка при создании рассылки');
  }
}

async function loadMailings() {
  try {
    const response = await fetch('/mailings', {
      headers: getAuthHeaders()
    });
    if (!response.ok) throw new Error('Ошибка сервера');
    
    const mailings = await response.json();
    const container = document.getElementById('mailings-container');
    
    if (mailings.length === 0) {
      container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">Рассылок не найдено</p>';
      return;
    }
    
    const statusLabels = {
      'pending': '⏳ На ожидании',
      'scheduled': '📅 Запланирована',
      'sending': '📤 В процессе',
      'sent': '✅ Отправлено',
      'failed': '❌ Ошибка',
      'cancelled': '🚫 Отменено'
    };
    
    const mailingTypeLabels = {
      'manual': '👤 Ручная рассылка',
      'automatic': '🤖 Автоматическая рассылка'
    };
    
    let html = '';
    for (const m of mailings) {
      const statusLabel = statusLabels[m.status] || m.status;
      const mailingTypeLabel = mailingTypeLabels[m.mailing_type] || m.mailing_type;
      const sentTime = m.sent_at ? new Date(m.sent_at).toLocaleString('ru-RU') : '—';
      const scheduledTime = m.scheduled_at ? new Date(m.scheduled_at).toLocaleString('ru-RU') : '—';
      
      // Показываем кнопку отправки только для рассылок со статусом "pending"
      const sendButtonHtml = m.status === 'pending' ? `
        <button class="button small" style="width: 100%; margin-top: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);" onclick="sendMailingNow(${m.mailing_id})">
          📤 Отправить сейчас
        </button>
      ` : '';
      
      html += `
        <div class="card">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
            <h4 style="margin: 0;">${m.name}</h4>
            <span class="small" style="background: ${m.mailing_type === 'automatic' ? '#4CAF50' : '#2196F3'}; color: white; padding: 4px 10px; border-radius: 12px; font-weight: 500;">${mailingTypeLabel}</span>
          </div>
          <p class="small" style="color: var(--hint); margin: 8px 0;">
            <strong>Назначение:</strong> ${m.purpose}
          </p>
          <p class="small" style="color: var(--hint); margin: 8px 0;">
            <strong>Статус:</strong> ${statusLabel}
          </p>
          <p class="small" style="color: var(--hint); margin: 8px 0;">
            <strong>Кому:</strong> ${m.target_type} ${m.target_id ? '(ID: ' + m.target_id + ')' : ''}
          </p>
          ${m.description ? '<p class="small" style="color: var(--hint); margin: 8px 0; font-style: italic;">' + m.description + '</p>' : ''}
          <p class="small" style="color: var(--hint); margin: 8px 0; border-top: 1px solid var(--border); padding-top: 8px; margin-top: 8px;">
            Создана: ${new Date(m.created_at).toLocaleString('ru-RU')}<br>
            ${m.sent_at ? 'Отправлена: ' + sentTime + '<br>' : ''}
            ${m.scheduled_at && !m.sent_at ? 'Запланирована: ' + scheduledTime : ''}
          </p>
          ${sendButtonHtml}
        </div>
      `;
    }
    
    container.innerHTML = html;
  } catch (error) {
    console.error('Ошибка при загрузке рассылок:', error);
    document.getElementById('mailings-container').innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">❌ Ошибка при загрузке</p>';
  }
}

async function sendMailingNow(mailingId) {
  try {
    const response = await fetch(`/mailings/${mailingId}/send`, {
      method: 'POST',
      headers: getAuthHeaders({ 'Content-Type': 'application/json' })
    });
    
    const data = await response.json();
    
    if (response.ok || response.status === 206) {
      showNotification('✅ Рассылка отправлена!');
      setTimeout(() => {
        loadMailings();
      }, 1000);
    } else {
      showNotification('❌ ' + (data.error || 'Ошибка при отправке'));
    }
  } catch (error) {
    console.error('Ошибка при отправке рассылки:', error);
    showNotification('❌ Ошибка при отправке рассылки');
  }
}

// Загружаем рассылки при отображении страницы
const originalShowPage = window.showPage;
window.showPage = function(pageId) {
  if (pageId === 'mailings') {
    loadMailings();
  }
  if (pageId === 'direction-create-form') {
    resetDirectionForm();
  }
  if (pageId === 'schedule-control') {
    initScheduleControl();
  }
  return originalShowPage(pageId);
};

/* ====== УПРАВЛЕНИЕ НАПРАВЛЕНИЯМИ ====== */

async function generateDirectionUploadToken() {
  // Получаем данные из формы
  const title = document.getElementById('direction-title').value.trim();
  const description = document.getElementById('direction-description').value.trim();
  const price = document.getElementById('direction-price').value.trim();
  
  // Проверяем обязательные поля
  if (!title) {
    showDirectionError('Введите название направления');
    return;
  }
  if (!description) {
    showDirectionError('Введите описание направления');
    return;
  }
  if (!price || isNaN(price) || parseInt(price) <= 0) {
    showDirectionError('Введите корректную цену');
    return;
  }
  
  // Получаем Telegram ID админа
  const telegramUserId = tg.initDataUnsafe?.user?.id;
  if (!telegramUserId) {
    showDirectionError('Ошибка: не удалось получить ID из Telegram');
    return;
  }
  
  try {
    // Создаем сессию на сервере
    const response = await fetch('/api/directions/create-session', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        telegram_user_id: telegramUserId,
        title: title,
        description: description,
        base_price: parseInt(price)
      })
    });
    
    const data = await response.json();
    
    if (!response.ok) {
      showDirectionError(data.error || 'Ошибка при создании сессии');
      return;
    }
    
    // Сохраняем токен в localStorage
    localStorage.setItem('direction_session_token', data.session_token);
    localStorage.setItem('direction_session_id', data.session_id);
    
    const token = data.session_token;
    
    // Сохраняем токен в буфер обмена для удобства
    navigator.clipboard.writeText(token).catch(() => {
      // Если копирование не сработало - ничего страшного
    });
    
    // Открываем бота с параметром session_token
    // Используем обычную https ссылку, которую tg.openLink откроет в Telegram приложении
    const botUsername = 'dance_studio_tester_bot';
    const botLink = `https://t.me/${botUsername}?start=upload_${token}`;
    
    console.log('Открываем бота с ссылкой:', botLink);
    
    // Открываем через Telegram Web App API
    // tg.openLink() автоматически откроет приложение Telegram если оно установлено
    try {
      tg.openLink(botLink);
      
      // Показываем уведомление
      showDirectionSuccess('✅ Бот открыт! Загрузите фотографию.');
      
      // Обновляем статус загрузки
      checkDirectionPhotoStatus(token);
    } catch (err) {
      console.error('Ошибка при открытии бота:', err);
      showDirectionError('Не удалось открыть бота. Попробуйте еще раз.');
    }
    
  } catch (error) {
    console.error('Ошибка:', error);
    showDirectionError('Ошибка сети: ' + error.message);
  }
}

async function checkDirectionPhotoStatus(token) {
  try {
    // Проверяем статус каждую секунду
    const checkInterval = setInterval(async () => {
      try {
        const response = await fetch(`/api/directions/upload-complete/${token}`);
        
        if (response.ok) {
          const data = await response.json();
          
          if (data.status === 'photo_received') {
            clearInterval(checkInterval);
            
            // Обновляем UI
            document.getElementById('direction-photo-status').innerHTML = 
              '<p style="margin: 0; color: #4CAF50; font-size: 14px;">✅ Фотография загружена</p>';
            
            // Активируем кнопку создания
            document.getElementById('direction-create-btn').style.opacity = '1';
            document.getElementById('direction-create-btn').disabled = false;
            
            // Сохраняем токен для создания
            localStorage.setItem('direction_upload_token', token);
            
            showDirectionSuccess('Фотография успешно загружена! Теперь нажмите "Создать направление"');
          }
        }
      } catch (error) {
        // Ошибка при проверке - продолжаем проверять
      }
    }, 1000);
    
    // Останавливаем проверку через 5 минут
    setTimeout(() => clearInterval(checkInterval), 300000);
    
  } catch (error) {
    console.error('Ошибка при проверке статуса:', error);
  }
}

async function createDirection() {
  const token = localStorage.getItem('direction_upload_token');
  
  if (!token) {
    showDirectionError('Фотография не загружена. Пожалуйста, загрузите фотографию через бота.');
    return;
  }
  
  try {
    const response = await fetch('/api/directions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        session_token: token,
        is_popular: 0
      })
    });
    
    const data = await response.json();
    
    if (!response.ok) {
      showDirectionError(data.error || 'Ошибка при создании направления');
      return;
    }
    
    // Очищаем форму и localStorage
    resetDirectionForm();
    localStorage.removeItem('direction_upload_token');
    localStorage.removeItem('direction_session_token');
    localStorage.removeItem('direction_session_id');
    
    showDirectionSuccess(`✅ Направление "${data.title}" успешно создано!`);
    
    // Возвращаемся в меню
    setTimeout(() => {
      goBack();
    }, 2000);
    
  } catch (error) {
    console.error('Ошибка:', error);
    showDirectionError('Ошибка сети: ' + error.message);
  }
}

function resetDirectionForm() {
  document.getElementById('direction-title').value = '';
  document.getElementById('direction-description').value = '';
  document.getElementById('direction-price').value = '';
  document.getElementById('direction-photo-status').innerHTML = 
    '<p style="margin: 0; color: var(--hint); font-size: 14px;">❌ Фотография не загружена</p>';
  document.getElementById('direction-create-btn').disabled = true;
  document.getElementById('direction-create-btn').style.opacity = '0.5';
  document.getElementById('direction-error-msg').style.display = 'none';
  document.getElementById('direction-success-msg').style.display = 'none';
  localStorage.removeItem('direction_upload_token');
}

function showDirectionError(message) {
  const errorDiv = document.getElementById('direction-error-msg');
  document.getElementById('direction-error-text').textContent = message;
  errorDiv.style.display = 'block';
  
  // Автоматически скрываем через 5 сек
  setTimeout(() => {
    errorDiv.style.display = 'none';
  }, 5000);
}

function showDirectionSuccess(message) {
  const successDiv = document.getElementById('direction-success-msg');
  document.getElementById('direction-success-text').textContent = message;
  successDiv.style.display = 'block';
  
  // Автоматически скрываем через 5 сек
  setTimeout(() => {
    successDiv.style.display = 'none';
  }, 5000);
}

/* ====== ЗАГРУЗКА И ОТОБРАЖЕНИЕ НАПРАВЛЕНИЙ ====== */

let currentDirectionTab = 'active'; // Текущая активная вкладка

async function loadDirections() {
  try {
    const response = await fetch('/api/directions/manage');
    const directions = await response.json();
    
    // Разделяем активные и архивные направления
    const activeDirections = directions.filter(d => d.status === 'active');
    const archivedDirections = directions.filter(d => d.status !== 'active');
    
    // Отображаем текущую вкладку
    renderDirections(currentDirectionTab === 'active' ? activeDirections : archivedDirections);
    
  } catch (error) {
    console.error('Ошибка при загрузке направлений:', error);
    const container = document.getElementById('directions-groups-container');
    container.innerHTML = '<p class="small" style="text-align: center; color: #c62828; padding: 20px;">❌ Ошибка при загрузке</p>';
  }
}

function renderDirections(directions) {
  const container = document.getElementById('directions-groups-container');
  
  if (!directions || directions.length === 0) {
    const emptyText = currentDirectionTab === 'active' ? 'Активных направлений нет' : 'Архив пуст';
    container.innerHTML = `<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">📭 ${emptyText}</p>`;
    return;
  }
  
  let html = '';
  
  directions.forEach(direction => {
    const statusColor = direction.status === 'active' ? '#4CAF50' : '#ff9800';
    const statusText = direction.status === 'active' ? '✅ Активное' : '⏸️ Неактивное';
    const popularBadge = direction.is_popular ? '⭐ Популярное' : '';
    
    const imageHtml = direction.image_path 
      ? `<img src="${direction.image_path}" style="width: 100%; height: 120px; object-fit: cover; border-radius: 8px; margin-bottom: 12px;">`
      : `<div style="width: 100%; height: 120px; background: #f0f0f0; border-radius: 8px; margin-bottom: 12px; display: flex; align-items: center; justify-content: center; color: var(--hint);">📸 Нет фото</div>`;
    
    html += `
      <div class="card" style="margin-bottom: 12px; border-left: 4px solid ${statusColor}; position: relative;">
        ${imageHtml}
        <h4 style="margin: 0 0 8px 0;">${direction.title}</h4>
        <p style="font-size: 13px; color: var(--hint); margin: 0 0 8px 0; line-height: 1.4;">${direction.description || 'Нет описания'}</p>
        
        <div style="display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap;">
          <span style="background: #f0f0f0; padding: 4px 8px; border-radius: 4px; font-size: 12px;">💰 ${direction.base_price} ₽</span>
          <span style="background: #f0f0f0; padding: 4px 8px; border-radius: 4px; font-size: 12px; color: ${statusColor};">${statusText}</span>
          ${popularBadge ? `<span style="background: #fff3cd; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${popularBadge}</span>` : ''}
        </div>
        
        <div style="font-size: 11px; color: var(--hint); margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border);">
          Создано: ${new Date(direction.created_at).toLocaleDateString('ru-RU')}
        </div>
        
        <div style="display: flex; gap: 8px; margin-top: 8px; align-items: center; justify-content: space-between;">
          <button class="save-btn" style="flex: 0 0 calc(100% - 48px); height: 40px; padding: 8px; font-size: 12px; background: #2196F3; border-radius: 8px;" onclick="editDirection(${direction.direction_id})">✏️ Редактировать</button>
          <button class="save-btn" style="width: 40px; height: 40px; padding: 0; font-size: 18px; background: #ff9800; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;" onclick="archiveDirection(${direction.direction_id})">📦</button>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

function switchDirectionTab(tab) {
  currentDirectionTab = tab;
  
  const activeTabBtn = document.getElementById('active-tab');
  const archivedTabBtn = document.getElementById('archived-tab');
  const indicator = document.querySelector('.tab-indicator');
  
  // Обновляем цвета текста вкладок
  activeTabBtn.style.color = tab === 'active' ? '#2196F3' : 'var(--hint)';
  archivedTabBtn.style.color = tab === 'archived' ? '#2196F3' : 'var(--hint)';
  
  // Анимируем индикатор
  const activeTab = tab === 'active' ? activeTabBtn : archivedTabBtn;
  const tabWidth = activeTab.offsetWidth;
  const tabLeft = activeTab.offsetLeft;
  
  indicator.style.width = tabWidth + 'px';
  indicator.style.transform = `translateX(${tabLeft}px)`;
  
  // Перезагружаем направления
  loadDirections();
}

function setDirectionEditLocked(locked) {
  window.directionEditLocked = locked;
  const editableFields = document.querySelectorAll('.direction-editable');
  const editPage = document.getElementById('direction-edit-form');

  editableFields.forEach(el => {
    if (el.tagName === 'BUTTON') {
      el.disabled = locked;
      el.style.opacity = locked ? '0.5' : '1';
      el.style.pointerEvents = locked ? 'none' : 'auto';
    } else {
      el.disabled = locked;
    }
  });

  const lockBtn = document.getElementById('direction-edit-lock-btn');
  const lockHint = document.getElementById('direction-edit-lock-hint');
  if (editPage) {
    if (locked) editPage.classList.add('direction-locked');
    else editPage.classList.remove('direction-locked');
  }
  if (lockBtn && lockHint) {
    if (locked) {
      lockBtn.textContent = '🔓';
      lockBtn.title = 'Разблокировать редактирование';
      lockHint.textContent = 'Поля заблокированы, чтобы избежать случайных изменений.';
    } else {
      lockBtn.textContent = '🔒';
      lockBtn.title = 'Заблокировать редактирование';
      lockHint.textContent = 'Редактирование разблокировано. Не забудьте сохранить изменения.';
    }
  }
}

function toggleDirectionEditLock() {
  setDirectionEditLocked(!window.directionEditLocked);
}

function editDirection(directionId) {
  // Сохраняем ID направления для использования в других функциях
  window.currentEditDirectionId = directionId;
  
  // Загружаем данные направления
  fetch(`/api/directions/${directionId}`)
    .then(r => r.json())
    .then(direction => {
      // Заполняем форму данными
      document.getElementById('edit-direction-title').value = direction.title || '';
      document.getElementById('edit-direction-description').value = direction.description || '';
      document.getElementById('edit-direction-price').value = direction.base_price || '';
      document.getElementById('edit-direction-status').value = direction.status || 'active';
      
      // Показываем фотографию если она есть
      if (direction.image_path) {
        const photoDiv = document.getElementById('edit-direction-photo-preview');
        photoDiv.innerHTML = `<img src="${direction.image_path}" style="width: 100%; height: 100%; object-fit: cover;">`;
      }
      
      // Загружаем группы
      loadDirectionGroups();
      
      // Переходим на страницу редактирования
      showPage('direction-edit-form');
      setDirectionEditLocked(true);
    })
    .catch(err => {
      alert('❌ Ошибка при загрузке данных: ' + err.message);
    });
}

function loadDirectionGroups() {
  const directionId = window.currentEditDirectionId;
  const groupsList = document.getElementById('edit-direction-groups-list');
  if (!directionId || !groupsList) return;

  groupsList.innerHTML = `<p style="text-align: center; color: var(--hint); padding: 12px; margin: 0;">⏳ Загрузка групп...</p>`;

  fetch(`/api/directions/${directionId}/groups`)
    .then(async groupsRes => {
      if (!groupsRes.ok) {
        const err = await groupsRes.json();
        throw new Error(err.error || 'Не удалось загрузить группы');
      }
      const groups = await groupsRes.json();

      // Рендерим группы
      if (!groups.length) {
        groupsList.innerHTML = `<p style="text-align: center; color: var(--hint); padding: 12px; margin: 0;">📭 Групп пока нет</p>`;
        return;
      }

      let html = '';
      groups.forEach(g => {
        html += `
          <div class="card" style="margin-bottom: 8px; border-left: 4px solid #4CAF50;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
              <div style="font-weight: 600; flex: 1;">${g.name}</div>
              <button class="lock-btn" title="Редактировать группу" onclick="openEditGroupPage(${g.id});">✏️</button>
            </div>
            <div class="small" style="margin-bottom: 6px;">Преподаватель: <b>${g.teacher_name || '—'}</b></div>
            <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 6px;">
              <span style="background: #f0f0f0; padding: 4px 8px; border-radius: 4px; font-size: 12px;">👶 ${g.age_group}</span>
              <span style="background: #f0f0f0; padding: 4px 8px; border-radius: 4px; font-size: 12px;">👥 ${g.max_students} учеников</span>
              <span style="background: #f0f0f0; padding: 4px 8px; border-radius: 4px; font-size: 12px;">⏱️ ${g.duration_minutes} мин</span>
              ${g.lessons_per_week ? `<span style="background: #f0f0f0; padding: 4px 8px; border-radius: 4px; font-size: 12px;">📆 ${g.lessons_per_week} в неделю</span>` : ''}
            </div>
            <div class="small">${g.description || 'Описание не указано'}</div>
          </div>
        `;
      });
      groupsList.innerHTML = html;
    })
    .catch(err => {
      groupsList.innerHTML = `<p style="text-align: center; color: #c62828; padding: 12px; margin: 0;">❌ ${err.message}</p>`;
    });
}

function loadGroupTeachers() {
  const results = document.getElementById('group-teacher-search-results');
  if (!results) return;

  results.innerHTML = `<p class="small" style="text-align: center; color: var(--hint); padding: 12px 0;">⏳ Загрузка преподавателей...</p>`;

  fetch('/staff/list/teachers')
    .then(async res => {
      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.error || 'Не удалось загрузить преподавателей');
      }
      return res.json();
    })
    .then(teachers => {
      window.groupTeachers = teachers || [];
      displayGroupTeacherResults(window.groupTeachers);
    })
    .catch(err => {
      results.innerHTML = `<p class="small" style="text-align: center; color: var(--hint); padding: 12px 0;">❌ ${err.message}</p>`;
    });
}

function searchGroupTeacher() {
  const input = document.getElementById('group-teacher-search');
  const query = (input?.value || '').trim().toLowerCase();
  const results = document.getElementById('group-teacher-search-results');
  if (!results) return;

  if (!window.groupTeachers) {
    results.innerHTML = `<p class="small" style="text-align: center; color: var(--hint); padding: 12px 0;">⏳ Загрузка преподавателей...</p>`;
    return;
  }

  if (!query) {
    displayGroupTeacherResults(window.groupTeachers);
    return;
  }

  const filtered = window.groupTeachers.filter(t => {
    const name = (t.name || '').toLowerCase();
    const username = (t.username || '').toLowerCase();
    const idStr = String(t.id || '');
    return name.includes(query) || username.includes(query) || idStr.includes(query);
  });

  if (!filtered.length) {
    results.innerHTML = `<p class="small" style="text-align: center; color: var(--hint); padding: 12px 0;">Преподаватели не найдены</p>`;
    return;
  }

  displayGroupTeacherResults(filtered);
}

function displayGroupTeacherResults(teachers) {
  const results = document.getElementById('group-teacher-search-results');
  if (!results) return;

  const html = teachers.map(t => {
    const safeName = (t.name || '—').replace(/'/g, "\\'").replace(/"/g, '\\"');
    const safeUsername = (t.username || '').replace(/'/g, "\\'").replace(/"/g, '\\"');
    const isSelected = window.selectedGroupTeacher && window.selectedGroupTeacher.id === t.id;
    const borderColor = isSelected ? '#1976d2' : 'var(--accent)';
    const bgColor = isSelected ? '#e3f2fd' : 'var(--bg)';
    return `
      <div class="card" id="group-teacher-card-${t.id}" style="margin-bottom: 8px; cursor: pointer; background: ${bgColor}; border-left: 4px solid ${borderColor}; transition: all 0.2s;" onclick="selectGroupTeacher(${t.id}, '${safeName}', '${safeUsername}')">
        <div style="font-weight: 600; font-size: 14px;">
          ${t.name || '—'}
          ${isSelected ? ' ✅' : ''}
        </div>
        <div style="font-size: 12px; color: var(--hint); margin-top: 2px;">ID: ${t.id}${t.username ? ` • @${t.username}` : ''}</div>
      </div>
    `;
  }).join('');

  results.innerHTML = html || '<p class="small" style="text-align: center; color: var(--hint); padding: 12px 0;">Нет преподавателей</p>';
}

function selectGroupTeacher(id, name, username) {
  window.selectedGroupTeacher = { id, name, username };
  displayGroupTeacherResults(window.groupTeachers || []);
}

function openCreateGroupPage() {
  if (!window.currentEditDirectionId) {
    alert('❌ Сначала откройте направление для редактирования');
    return;
  }
  showPage('direction-group-create');
  window.selectedGroupTeacher = null;
  document.getElementById('group-teacher-search').value = '';
  document.getElementById('edit-direction-group-lessons').value = '';
  loadGroupTeachers();
}

function setDirectionGroupMessage(text, isError) {
  const msg = document.getElementById('edit-direction-group-msg');
  if (!msg) return;
  msg.style.display = 'block';
  msg.style.background = isError ? '#ffebee' : '#e8f5e9';
  msg.style.color = isError ? '#c62828' : '#2e7d32';
  msg.textContent = text;
  setTimeout(() => {
    msg.style.display = 'none';
  }, 4000);
}

function createDirectionGroup() {
  const directionId = window.currentEditDirectionId;
  if (!directionId) {
    setDirectionGroupMessage('❌ ID направления не найден', true);
    return;
  }

  const name = document.getElementById('edit-direction-group-name').value.trim();
  const teacherId = window.selectedGroupTeacher ? window.selectedGroupTeacher.id : null;
  const ageGroup = document.getElementById('edit-direction-group-age').value.trim();
  const maxStudents = document.getElementById('edit-direction-group-max').value;
  const durationMinutes = document.getElementById('edit-direction-group-duration').value;
  const lessonsPerWeek = document.getElementById('edit-direction-group-lessons').value;
  const description = document.getElementById('edit-direction-group-desc').value.trim();

  if (!name || !teacherId || !ageGroup || !maxStudents || !durationMinutes) {
    setDirectionGroupMessage('❌ Заполните обязательные поля', true);
    return;
  }

  fetch(`/api/directions/${directionId}/groups`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      name,
      teacher_id: parseInt(teacherId, 10),
      age_group: ageGroup,
      max_students: parseInt(maxStudents, 10),
      duration_minutes: parseInt(durationMinutes, 10),
      lessons_per_week: lessonsPerWeek ? parseInt(lessonsPerWeek, 10) : null,
      description
    })
  })
    .then(async r => {
      const data = await r.json();
      if (!r.ok) throw new Error(data.error || 'Не удалось создать группу');
      return data;
    })
    .then(() => {
      document.getElementById('edit-direction-group-name').value = '';
      document.getElementById('edit-direction-group-age').value = '';
      document.getElementById('edit-direction-group-max').value = '';
      document.getElementById('edit-direction-group-duration').value = '';
      document.getElementById('edit-direction-group-lessons').value = '';
      document.getElementById('edit-direction-group-desc').value = '';
      document.getElementById('group-teacher-search').value = '';
      window.selectedGroupTeacher = null;
      setDirectionGroupMessage('✅ Группа создана', false);
      loadDirectionGroups();
      setTimeout(() => {
        goBack();
      }, 600);
    })
    .catch(err => {
      setDirectionGroupMessage('❌ ' + err.message, true);
    });
}

function setEditGroupMessage(text, isError) {
  const msg = document.getElementById('edit-group-msg');
  if (!msg) return;
  msg.style.display = 'block';
  msg.style.background = isError ? '#ffebee' : '#e8f5e9';
  msg.style.color = isError ? '#c62828' : '#2e7d32';
  msg.textContent = text;
  setTimeout(() => {
    msg.style.display = 'none';
  }, 4000);
}

function loadEditGroupTeachers() {
  const results = document.getElementById('edit-group-teacher-search-results');
  if (!results) return;

  results.innerHTML = `<p class="small" style="text-align: center; color: var(--hint); padding: 12px 0;">⏳ Загрузка преподавателей...</p>`;

  fetch('/staff/list/teachers')
    .then(async res => {
      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.error || 'Не удалось загрузить преподавателей');
      }
      return res.json();
    })
    .then(teachers => {
      window.editGroupTeachers = teachers || [];
      // Предвыбор по teacher_id
      if (window.editGroupPreselectTeacherId) {
        const selected = window.editGroupTeachers.find(t => t.id === window.editGroupPreselectTeacherId);
        if (selected) {
          window.selectedEditGroupTeacher = { id: selected.id, name: selected.name, username: selected.username };
        }
      }
      displayEditGroupTeacherResults(window.editGroupTeachers);
    })
    .catch(err => {
      results.innerHTML = `<p class="small" style="text-align: center; color: var(--hint); padding: 12px 0;">❌ ${err.message}</p>`;
    });
}

function searchEditGroupTeacher() {
  const input = document.getElementById('edit-group-teacher-search');
  const query = (input?.value || '').trim().toLowerCase();
  const results = document.getElementById('edit-group-teacher-search-results');
  if (!results) return;

  if (!window.editGroupTeachers) {
    results.innerHTML = `<p class="small" style="text-align: center; color: var(--hint); padding: 12px 0;">⏳ Загрузка преподавателей...</p>`;
    return;
  }

  if (!query) {
    displayEditGroupTeacherResults(window.editGroupTeachers);
    return;
  }

  const filtered = window.editGroupTeachers.filter(t => {
    const name = (t.name || '').toLowerCase();
    const username = (t.username || '').toLowerCase();
    const idStr = String(t.id || '');
    return name.includes(query) || username.includes(query) || idStr.includes(query);
  });

  if (!filtered.length) {
    results.innerHTML = `<p class="small" style="text-align: center; color: var(--hint); padding: 12px 0;">Преподаватели не найдены</p>`;
    return;
  }

  displayEditGroupTeacherResults(filtered);
}

function displayEditGroupTeacherResults(teachers) {
  const results = document.getElementById('edit-group-teacher-search-results');
  if (!results) return;

  const html = teachers.map(t => {
    const safeName = (t.name || '—').replace(/'/g, "\\'").replace(/"/g, '\\"');
    const safeUsername = (t.username || '').replace(/'/g, "\\'").replace(/"/g, '\\"');
    const isSelected = window.selectedEditGroupTeacher && window.selectedEditGroupTeacher.id === t.id;
    const borderColor = isSelected ? '#1976d2' : 'var(--accent)';
    const bgColor = isSelected ? '#e3f2fd' : 'var(--bg)';
    return `
      <div class="card" id="edit-group-teacher-card-${t.id}" style="margin-bottom: 8px; cursor: pointer; background: ${bgColor}; border-left: 4px solid ${borderColor}; transition: all 0.2s;" onclick="selectEditGroupTeacher(${t.id}, '${safeName}', '${safeUsername}')">
        <div style="font-weight: 600; font-size: 14px;">
          ${t.name || '—'}
          ${isSelected ? ' ✅' : ''}
        </div>
        <div style="font-size: 12px; color: var(--hint); margin-top: 2px;">ID: ${t.id}${t.username ? ` • @${t.username}` : ''}</div>
      </div>
    `;
  }).join('');

  results.innerHTML = html || '<p class="small" style="text-align: center; color: var(--hint); padding: 12px 0;">Нет преподавателей</p>';
}

function selectEditGroupTeacher(id, name, username) {
  window.selectedEditGroupTeacher = { id, name, username };
  displayEditGroupTeacherResults(window.editGroupTeachers || []);
}

function openEditGroupPage(groupId) {
  window.currentEditGroupId = groupId;
  window.selectedEditGroupTeacher = null;
  window.editGroupPreselectTeacherId = null;

  try {
    showPage('direction-group-edit');
  } catch (err) {
    showNotification('❌ Не удалось открыть форму редактирования группы');
    return;
  }
  const teacherSearch = document.getElementById('edit-group-teacher-search');
  if (teacherSearch) teacherSearch.value = '';

  fetch(`/api/groups/${groupId}`)
    .then(async r => {
      const data = await r.json();
      if (!r.ok) throw new Error(data.error || 'Не удалось загрузить группу');
      return data;
    })
    .then(group => {
      document.getElementById('edit-group-name').value = group.name || '';
      document.getElementById('edit-group-age').value = group.age_group || '';
      document.getElementById('edit-group-max').value = group.max_students || '';
      document.getElementById('edit-group-duration').value = group.duration_minutes || '';
      document.getElementById('edit-group-desc').value = group.description || '';
      document.getElementById('edit-group-lessons').value = group.lessons_per_week || '';
      window.editGroupPreselectTeacherId = group.teacher_id;
      loadEditGroupTeachers();
    })
    .catch(err => {
      setEditGroupMessage('❌ ' + err.message, true);
      showNotification('❌ ' + err.message);
    });
}

function saveGroupChanges() {
  const groupId = window.currentEditGroupId;
  if (!groupId) {
    setEditGroupMessage('❌ ID группы не найден', true);
    return;
  }

  const name = document.getElementById('edit-group-name').value.trim();
  const teacherId = window.selectedEditGroupTeacher ? window.selectedEditGroupTeacher.id : null;
  const ageGroup = document.getElementById('edit-group-age').value.trim();
  const maxStudents = document.getElementById('edit-group-max').value;
  const durationMinutes = document.getElementById('edit-group-duration').value;
  const lessonsPerWeek = document.getElementById('edit-group-lessons').value;
  const description = document.getElementById('edit-group-desc').value.trim();

  if (!name || !teacherId || !ageGroup || !maxStudents || !durationMinutes) {
    setEditGroupMessage('❌ Заполните обязательные поля', true);
    return;
  }

  fetch(`/api/groups/${groupId}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      name,
      teacher_id: parseInt(teacherId, 10),
      age_group: ageGroup,
      max_students: parseInt(maxStudents, 10),
      duration_minutes: parseInt(durationMinutes, 10),
      lessons_per_week: lessonsPerWeek ? parseInt(lessonsPerWeek, 10) : null,
      description
    })
  })
    .then(async r => {
      const data = await r.json();
      if (!r.ok) throw new Error(data.error || 'Не удалось сохранить группу');
      return data;
    })
    .then(() => {
      setEditGroupMessage('✅ Группа обновлена', false);
      loadDirectionGroups();
      setTimeout(() => {
        goBack();
      }, 600);
    })
    .catch(err => {
      setEditGroupMessage('❌ ' + err.message, true);
    });
}

function saveDirectionChanges() {
  if (window.directionEditLocked) {
    alert('🔒 Сначала разблокируйте редактирование.');
    return;
  }

  const directionId = window.currentEditDirectionId;
  if (!directionId) {
    alert('❌ ID направления не найден');
    return;
  }
  
  const title = document.getElementById('edit-direction-title').value.trim();
  const description = document.getElementById('edit-direction-description').value.trim();
  const price = document.getElementById('edit-direction-price').value;
  const status = document.getElementById('edit-direction-status').value;
  
  if (!title || !description || !price) {
    alert('❌ Пожалуйста, заполните все поля');
    return;
  }
  
  fetch(`/api/directions/${directionId}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      title,
      description,
      base_price: parseFloat(price),
      status
    })
  })
    .then(r => r.json())
    .then(data => {
      alert('✅ Направление обновлено');
      goBack();
      loadDirections();
    })
    .catch(err => alert('❌ Ошибка: ' + err.message));
}

function archiveDirection(directionId) {
  if (confirm('Архивировать это направление?')) {
    fetch(`/api/directions/${directionId}`, { method: 'DELETE' })
      .then(r => r.json())
      .then(data => {
        alert('✅ Направление архивировано');
        loadDirections();
      })
      .catch(err => alert('❌ Ошибка: ' + err.message));
  }
}

</script>
</body>
</html>
