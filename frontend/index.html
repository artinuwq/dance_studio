<!DOCTYPE html>

<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Dance Studio</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
/* ====== –¶–í–ï–¢–ê (–§–ò–ö–°–ò–†–û–í–ê–ù–ù–ê–Ø –ë–ï–õ–ê–Ø –¢–ï–ú–ê) ====== */
:root {
  --bg: #ffffff;
  --text: #111111;
  --hint: #777777;
  --accent: #e91e63;
  --card: #f5f5f5;
  --border: #eeeeee;
  --safe-top: 0px;
  --safe-bottom: 0px;
}

/* ====== –ë–ê–ó–ê ====== */
* {
  box-sizing: border-box;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
}

body {
  margin: 0;
  background: var(--bg);
  color: var(--text);
}

/* ====== HEADER ====== */
header {
  display: none;
}

.header-back {
  border: none;
  background: transparent;
  color: var(--accent);
  font-size: 22px;
  line-height: 1;
  padding: 4px 6px;
  cursor: pointer;
}

/* –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏—Å—Ç–µ–º–Ω—É—é –∫–Ω–æ–ø–∫—É Telegram */
body.tg-mobile .header-back {
  display: none;
}

.header-back:active {
  opacity: 0.6;
}

.header-center {
  flex: 1;
  text-align: center;
  pointer-events: none;
}

.header-center-title {
  font-size: 20px;
  font-weight: 700;
  color: var(--text);
}

.header-spacer {
  width: 32px;
  height: 32px;
}

/* ====== –°–¢–†–ê–ù–ò–¶–´ ====== */
.page {
  display: none;
  padding: 16px;
  padding-bottom: calc(56px + var(--safe-bottom));
  padding-top: calc(16px + var(--safe-top));
}

.page.active {
  display: block;
}

/* –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü */
#staff {
  min-height: calc(100vh - 100px);
}

/* ====== –ö–ê–†–¢–û–ß–ö–ò ====== */
.card {
  background: var(--card);
  padding: 14px;
  border-radius: 14px;
  margin-bottom: 12px;
}

/* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–µ —Å–µ–∫—Ü–∏–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ "–†–∞–±–æ—Ç–∞" */
.work-section {
  background: transparent;
  border: none;
  box-shadow: none;
  padding: 0;
  margin-bottom: 10px;
}
.work-section h4 {
  margin: 0 0 8px 0;
}

.menu-item {
  background: var(--card);
  padding: 14px;
  border-radius: 12px;
  margin-bottom: 10px;
  cursor: pointer;
}

.menu-item:active {
  opacity: 0.7;
}

/* ====== –ù–ò–ñ–ù–ï–ï –ú–ï–ù–Æ ====== */
.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  min-height: 45px;
  height: auto;
  display: flex;
  align-items: center;
  background: var(--bg);
  border-top: 1px solid var(--border);
  padding: 6px 8px calc(env(safe-area-inset-bottom) + 10px);
  box-sizing: border-box;
}

.nav-btn {
  flex: 1;
  text-align: center;
  padding: 4px 0;
  font-size: 12px;
  color: var(--hint);
  cursor: pointer;
  line-height: 1.3;
}

.nav-btn.active {
  color: var(--accent);
  font-weight: 600;
}

.nav-btn.hidden {
  width: 0;
  opacity: 0;
  pointer-events: none;
  overflow: hidden;
  flex: 0;
}

/* ====== –í–ö–õ–ê–î–ö–ò –° –ê–ù–ò–ú–ê–¶–ò–ï–ô ====== */
.nav-tab {
  transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1) !important;
}

.tabs-container {
  position: relative !important;
}

.tab-indicator {
  position: absolute;
  bottom: -2px;
  height: 3px;
  background: #2196F3;
  transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
}

/* ====== –ü–†–û–§–ò–õ–¨ ====== */
.profile {
  text-align: center;
}

.avatar {
  width: 90px;
  height: 90px;
  border-radius: 50%;
  background: var(--card);
  margin: 0 auto 12px;
  overflow: hidden;
}

.avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* ====== –ü–ê–ù–ï–õ–¨ –ü–ï–†–°–û–ù–ê–õ–ê ====== */
.staff-info-panel {
  background: var(--card);
  padding: 14px;
  border-radius: 12px;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 12px;
}

.staff-avatar-small {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: var(--border);
  flex-shrink: 0;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
}

.staff-avatar-small img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.staff-info-text {
  flex: 1;
  text-align: left;
}

.staff-name {
  font-weight: 600;
  font-size: 15px;
  color: var(--text);
  margin: 0;
}

.staff-position {
  font-size: 13px;
  color: var(--hint);
  margin: 4px 0 0 0;
}



/* ====== –¢–ï–ö–°–¢ ====== */
.small {
  color: var(--hint);
  font-size: 14px;
}

/* ====== –ù–ê–ó–ê–î ====== */
.back {
  color: var(--accent);
  cursor: pointer;
  margin-bottom: 12px;
  display: inline-block;
}

/* ====== –†–ê–ó–î–ï–õ –û –°–¢–£–î–ò–ò ====== */
.studio-section {
  background: transparent;
  padding: 0;
  border-radius: 0;
  box-shadow: none;
}

.section-item {
  background: #ffffff;
  padding: 16px;
  border-radius: 16px;
  margin-bottom: 12px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: space-between;
  box-shadow: 0 6px 14px rgba(0, 0, 0, 0.08);
  transition: all 0.2s;
}

.section-item:active {
  opacity: 0.7;
  background: var(--border);
}

.section-item-left {
  display: flex;
  align-items: center;
  gap: 14px;
  flex: 1;
}

.section-item-icon {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  color: #ffffff;
  font-size: 24px;
  flex-shrink: 0;
}

.section-icon--orange {
  background: #ff9800;
}

.section-icon--purple {
  background: #5a55d6;
}

.section-icon--blue {
  background: #49b6e7;
}

.section-icon--pink {
  background: #ff3b6b;
}

.section-item-text {
  text-align: left;
}

.section-item-title {
  font-weight: 700;
  font-size: 16px;
  margin: 0;
}

.section-item-desc {
  font-size: 13px;
  color: var(--hint);
  margin: 6px 0 0 0;
}

.section-item-arrow {
  color: #1a1a1a;
  font-size: 28px;
  font-weight: 700;
}

/* ====== –ö–û–ù–¢–ê–ö–¢–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø ====== */
.contact-btn {
  background: var(--card);
  padding: 12px;
  border-radius: 12px;
  margin-bottom: 10px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: space-between;
  transition: all 0.2s;
}

.contact-btn:active {
  opacity: 0.7;
  background: var(--border);
}

.contact-btn-content {
  display: flex;
  align-items: center;
  gap: 12px;
  flex: 1;
}

.contact-icon {
  font-size: 24px;
}

.contact-label {
  font-size: 12px;
  color: var(--hint);
  margin-bottom: 2px;
}

.contact-value {
  font-weight: 600;
  font-size: 14px;
  color: var(--text);
}

.contact-action {
  font-size: 12px;
  color: var(--accent);
  font-weight: 600;
  white-space: nowrap;
  margin-left: 8px;
}

/* ====== –§–û–†–ú–´ ====== */
.form-group {
  margin-bottom: 14px;
}

.form-group label {
  display: block;
  font-size: 12px;
  color: var(--hint);
  margin-bottom: 6px;
  font-weight: 600;
}

.form-input {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid var(--border);
  border-radius: 8px;
  font-size: 14px;
  font-family: inherit;
  background: var(--card);
  color: var(--text);
  box-sizing: border-box;
}

.form-input:focus {
  outline: none;
  border-color: var(--accent);
  background: var(--bg);
}

textarea.form-input {
  resize: vertical;
}

.save-btn {
  width: 100%;
  padding: 12px;
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.save-btn:active {
  opacity: 0.8;
  transform: scale(0.98);
}

.save-btn {
  text-align: center;
  white-space: normal;
  word-wrap: break-word;
  display: flex;
  justify-content: center;
  align-items: center;
}

/* ====== –†–É–°‚Äö–°–Ç–†¬∞–†–Ö–†—ë–°‚Ä†–†¬∞ –°–Ç–†¬µ–†“ë–†¬∞–†—î–°‚Äö–†—ë–°–Ç–†—ï–†–Ü–†¬∞–†–Ö–†—ë–°–è ====== */
.direction-edit-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
}

.lock-btn {
  width: 32px;
  height: 32px;
  border-radius: 16px;
  border: 1px solid var(--border);
  background: var(--card);
  color: var(--text);
  cursor: pointer;
  font-size: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.lock-btn:active {
  opacity: 0.7;
}

.direction-lockable {
  position: relative;
}

.direction-lockable .lock-overlay {
  display: none;
  position: absolute;
  inset: 0;
  background: rgba(245, 245, 245, 0.7);
  border-radius: 12px;
  z-index: 2;
  pointer-events: all;
}

#direction-edit-form.direction-locked .direction-lockable .lock-overlay {
  display: block;
}

/* ====== –°–ü–ò–°–û–ö –ö–õ–ò–ï–ù–¢–û–í (–ü–ï–†–°–û–ù–ê–õ) ====== */
.clients-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.client-card {
  background: var(--card);
  padding: 12px;
  border-radius: 12px;
  cursor: pointer;
  border-left: 4px solid var(--accent);
  transition: all 0.2s;
}

.client-card:active {
  background: var(--border);
  transform: translateX(4px);
}

.client-card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.client-card-name {
  font-weight: 600;
  font-size: 14px;
}

.client-card-status {
  font-size: 12px;
  padding: 2px 8px;
  border-radius: 6px;
  background: var(--accent);
  color: white;
}

.client-card-info {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  margin-bottom: 8px;
}

.client-info-item {
  font-size: 12px;
  color: var(--hint);
}

.client-info-label {
  color: var(--hint);
  font-size: 11px;
}

.client-info-value {
  color: var(--text);
  font-weight: 500;
}

.client-card-notes {
  background: var(--bg);
  padding: 8px;
  border-radius: 8px;
  margin-top: 8px;
  font-size: 12px;
  color: var(--hint);
}

/* ====== –§–û–¢–û –ü–†–û–§–ò–õ–Ø ====== */
.photo-preview {
  background: var(--card);
  border-radius: 12px;
  padding: 20px;
  text-align: center;
  margin-bottom: 12px;
  border: 2px dashed var(--border);
}

#profile-photo-img {
  max-width: 100%;
  max-height: 300px;
  border-radius: 8px;
}

/* ====== –ù–û–í–û–°–¢–ò ====== */
.news-grid {
  display: flex;
  gap: 10px;
  overflow-x: auto;
  overflow-y: hidden;
  scroll-behavior: smooth;
  padding-bottom: 8px;
  -webkit-overflow-scrolling: touch;
}

.news-item {
  position: relative;
  width: 100px;
  height: 100px;
  min-width: 100px;
  border-radius: 12px;
  overflow: hidden;
  cursor: pointer;
  transition: transform 0.2s, opacity 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  background: linear-gradient(135deg, var(--accent), #ff69b4);
}

.news-item::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, var(--accent), #ff69b4);
  z-index: -1;
}

.news-item img {
  position: absolute;
  width: 100%;
  height: 100%;
  object-fit: cover;
  z-index: 0;
}

.news-item-title {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  background: rgba(0, 0, 0, 0.6);
  color: white;
  font-weight: 600;
  font-size: 11px;
  line-height: 1.2;
  padding: 6px 4px;
  text-align: center;
  z-index: 1;
  max-height: 40%;
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  line-clamp: 2;
  -webkit-box-orient: vertical;
}

.news-item:active {
  transform: scale(0.95);
  opacity: 0.8;
}

.news-empty {
  text-align: center;
  color: var(--hint);
  padding: 20px;
  font-size: 14px;
}

/* ====== –ü–†–û–°–ú–û–¢–† –ù–û–í–û–°–¢–ò ====== */
#news-detail {
  padding: 0 !important;
  padding-bottom: 56px !important;
}

#news-detail .news-detail-header {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  background: var(--bg);
  position: sticky;
  top: 0;
  z-index: 10;
  border-bottom: 1px solid var(--border);
}

#news-detail .news-detail-back {
  color: var(--accent);
  cursor: pointer;
  font-size: 24px;
  line-height: 1;
  flex-shrink: 0;
  padding: 4px 8px;
}

#news-detail .news-detail-back:active {
  opacity: 0.6;
}

#news-detail .news-detail-title-header {
  font-size: 18px;
  font-weight: 600;
  color: var(--text);
  margin: 0;
  flex: 1;
}

#news-detail-photo-container {
  width: 100%;
  height: 300px;
  background: var(--card);
  overflow: hidden;
  margin-bottom: -30px;
  position: relative;
  z-index: 1;
}

#news-detail-photo-container img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

#news-detail .news-detail-content-wrapper {
  background: var(--bg);
  border-radius: 30px 30px 0 0;
  padding: 30px 16px 16px 16px;
  margin-top: 0;
  position: relative;
  z-index: 2;
}

#news-detail-title {
  font-size: 20px;
  font-weight: 700;
  margin: 0 0 8px 0;
  color: var(--text);
}

#news-detail-date {
  color: var(--hint);
  font-size: 13px;
  margin-bottom: 16px !important;
}

#news-detail-content {
  color: var(--text);
  line-height: 1.6;
  font-size: 15px;
  margin: 0;
}

.brand-header {
  text-align: center;
  margin: -6px 0 14px 0;
}

.brand-row {
  display: inline-flex;
  align-items: center;
  gap: 10px;
  padding: 4px 10px;
  border-radius: 999px;
  background: rgba(0, 0, 0, 0.12);
}

.brand-avatar {
  width: 22px;
  height: 22px;
  border-radius: 50%;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  background: rgba(0, 0, 0, 0.08);
}

.brand-avatar:empty {
  display: none;
}

.brand-name {
  font-size: 14px;
  font-weight: 600;
  color: var(--text);
}

.page-title {
  font-size: 22px;
  font-weight: 700;
  margin: 10px 0 12px 0;
  text-align: center;
}

/* ====== –ê–î–ú–ò–ù-–†–ê–°–ü–ò–°–ê–ù–ò–ï ====== */
.schedule-toolbar {
  display: flex;
  gap: 8px;
  align-items: center;
  margin-bottom: 12px;
}

.schedule-toolbar .button {
  flex: 1;
  padding: 10px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: var(--card);
  cursor: pointer;
  font-size: 13px;
}

.schedule-toolbar .button.active {
  background: var(--accent);
  color: #fff;
  border-color: var(--accent);
}

.schedule-nav {
  display: flex;
  gap: 8px;
  align-items: center;
  margin-bottom: 12px;
}

.schedule-nav .nav-btn-mini {
  padding: 8px 10px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: var(--card);
  cursor: pointer;
}

.schedule-nav .date-label {
  flex: 1;
  text-align: center;
  font-weight: 600;
}

.schedule-grid {
  display: grid;
  grid-template-columns: 64px repeat(7, 1fr);
  border: 1px solid var(--border);
  border-radius: 12px;
  overflow: hidden;
  background: #fff;
}

.schedule-grid.day {
  grid-template-columns: 64px 1fr;
}

.schedule-cell {
  border-bottom: 1px solid var(--border);
  border-right: 1px solid var(--border);
  min-height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  padding: 2px 4px;
}

.schedule-cell.time {
  background: var(--card);
  color: var(--hint);
  font-weight: 600;
}

.schedule-cell.time.half {
  opacity: 0.45;
}

.schedule-cell.head {
  background: var(--card);
  font-weight: 600;
  font-size: 12px;
}

.schedule-slot {
  background: #fff;
  cursor: pointer;
}

.schedule-slot.busy {
  cursor: not-allowed;
}

.schedule-slot.busy.group {
}

.schedule-slot.busy.individual {
}

.schedule-slot.busy.rental {
}

.schedule-event {
  font-size: 11px;
  font-weight: 600;
  text-align: center;
}

.schedule-form {
  margin-top: 12px;
  padding: 12px;
  background: var(--card);
  border-radius: 12px;
  display: none;
}

.schedule-form.show {
  display: block;
}

.schedule-detail-modal {
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  background: #fff;
  border-radius: 20px 20px 0 0;
  box-shadow: 0 -8px 20px rgba(0, 0, 0, 0.15);
  padding: 16px;
  display: none;
  z-index: 1002;
  max-height: 70vh;
  overflow-y: auto;
}

.schedule-detail-modal.show {
  display: block;
}

.schedule-detail-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.2);
  display: none;
  z-index: 1001;
}

.schedule-detail-overlay.show {
  display: block;
}

.group-schedule-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.2);
  display: none;
  z-index: 1001;
}

.group-schedule-overlay.show {
  display: block;
}

.group-schedule-modal {
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  background: #fff;
  border-radius: 20px 20px 0 0;
  box-shadow: 0 -8px 20px rgba(0, 0, 0, 0.15);
  padding: 16px;
  display: none;
  z-index: 1002;
  max-height: 85vh;
  overflow-y: auto;
}

.group-schedule-modal.show {
  display: block;
}

.schedule-detail-chip {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 10px;
  border-radius: 999px;
  background: var(--card);
  font-size: 12px;
}

.schedule-detail-card {
  margin-top: 10px;
  padding: 12px;
  border-radius: 12px;
  background: var(--card);
  border: 1px solid var(--border);
  display: grid;
  gap: 8px;
}

.schedule-detail-row {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
}

.repeat-panel {
  margin-top: 10px;
  padding: 10px;
  border-radius: 12px;
  background: #fff;
  border: 1px solid var(--border);
}

.repeat-row {
  display: flex;
  gap: 8px;
  align-items: center;
  margin: 8px 0;
}

.repeat-row .chip {
  padding: 6px 8px;
  border-radius: 999px;
  border: 1px solid var(--border);
  background: var(--card);
  font-size: 12px;
  cursor: pointer;
}

.repeat-row .chip.active {
  background: var(--accent);
  color: #fff;
  border-color: var(--accent);
}

.repeat-inline {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 12px;
}

.repeat-inline input[type="number"] {
  width: 60px;
}

.repeat-summary {
  margin-top: 8px;
  font-size: 12px;
  color: var(--hint);
}

.work-page .staff-info-panel {
  margin-top: 6px;
  margin-bottom: 18px;
}

.work-page .card {
  margin-bottom: 18px;
}

/* ====== –†–ê–°–ü–ò–°–ê–ù–ò–ï (–ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò) ====== */
.public-schedule-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  margin-bottom: 12px;
}

.public-schedule-title {
  display: inline-flex;
  align-items: center;
  gap: 10px;
  font-size: 20px;
  font-weight: 700;
}

.public-schedule-action {
  font-size: 14px;
  color: var(--hint);
  font-weight: 600;
}

.public-schedule-month {
  font-size: 12px;
  color: var(--hint);
  text-transform: uppercase;
  letter-spacing: 0.08em;
  margin: 6px 0 10px 2px;
}

.public-schedule-strip {
  display: flex;
  gap: 10px;
  overflow-x: auto;
  padding-bottom: 6px;
  -webkit-overflow-scrolling: touch;
}

.public-date-card {
  min-width: 64px;
  background: #fff;
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 8px 10px;
  text-align: center;
  cursor: pointer;
}

.public-date-card:hover,
.public-schedule-item:hover {
  cursor: pointer;
}

.public-date-card.active {
  background: #111;
  color: #fff;
  border-color: #111;
}

.public-date-dow {
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  color: inherit;
}

.public-date-day {
  font-size: 18px;
  font-weight: 700;
  margin: 4px 0 2px 0;
}

.public-date-label {
  font-size: 11px;
  color: var(--hint);
}

.public-date-card.active .public-date-label {
  color: rgba(255, 255, 255, 0.8);
}

.public-schedule-list {
  margin-top: 8px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.public-schedule-item {
  display: grid;
  grid-template-columns: 54px 1fr 18px;
  gap: 10px;
  align-items: start;
  padding: 8px 0;
  border-bottom: 1px solid var(--border);
}

.public-schedule-time {
  display: flex;
  flex-direction: column;
  gap: 6px;
  align-items: center;
}

.public-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
}

.public-time {
  font-weight: 700;
  font-size: 14px;
}

.public-duration {
  font-size: 12px;
  color: var(--hint);
}

.public-info-title {
  font-weight: 700;
  font-size: 15px;
  margin-bottom: 4px;
}

.public-info-image {
  width: 100%;
  height: 90px;
  border-radius: 12px;
  object-fit: cover;
  margin-bottom: 6px;
  display: block;
}

.public-info-sub {
  font-size: 13px;
  color: var(--hint);
  margin-bottom: 2px;
}

.public-info-teacher {
  font-size: 13px;
  color: var(--hint);
}

/* ====== –ù–ê–ü–†–ê–í–õ–ï–ù–ò–ï (–î–ï–¢–ê–õ–ò) ====== */
.direction-detail-photo {
  width: calc(100% + 32px);
  height: 300px;
  background: var(--card);
  overflow: hidden;
  margin-bottom: -30px;
  margin-left: -16px;
  margin-right: -16px;
  position: relative;
  z-index: 1;
  border-radius: 0;
}

.direction-detail-photo img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

.direction-detail-content {
  background: var(--bg);
  border-radius: 24px 24px 0 0;
  padding: 20px 16px 16px 16px;
  position: relative;
  z-index: 2;
  box-shadow: 0 -10px 20px rgba(0, 0, 0, 0.08);
  margin-left: -16px;
  margin-right: -16px;
}

.public-chevron {
  font-size: 18px;
  color: var(--hint);
  align-self: center;
}

.public-schedule-detail {
  display: grid;
  gap: 12px;
}
</style>
</head>
<body>
<header id="header">
<button aria-label="–ù–∞–∑–∞–¥" class="header-back" id="header-back" onclick="goBack()">‚Üê</button>
<div class="header-center">
<div class="header-center-title" id="header-title">LISSA DANCE</div>
</div>
<div class="header-spacer" aria-hidden="true"></div>
</header>
<!-- ====== –ì–õ–ê–í–ù–ê–Ø ====== -->
<div class="page active" id="home">
<div class="card">
<h3>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h3>
<p class="small">–ú—ã —Ä–∞–¥—ã –≤–∏–¥–µ—Ç—å –≤–∞—Å –≤ –Ω–∞—à–µ–π —Å—Ç—É–¥–∏–∏</p>
</div>
<div class="card">
<h4>–ù–æ–≤–æ—Å—Ç–∏</h4>
<div class="news-grid" id="news-container">
<p class="news-empty">–ù–æ–≤–æ—Å—Ç–µ–π –ø–æ–∫–∞ –Ω–µ—Ç v-v</p>
</div>
</div>
<div class="card studio-section">
<h4>–û —Å—Ç—É–¥–∏–∏</h4>
<div class="section-item" onclick="showSection('info-about')">
<div class="section-item-left">
<div class="section-item-icon section-icon--orange">‚òÜ</div>
<div class="section-item-text">
<h4 class="section-item-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
<p class="section-item-desc">–ò–Ω—Ñ–æ –æ –Ω–∞—Å, –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã</p>
</div>
</div>
<div class="section-item-arrow">‚Ä∫</div>
</div>
<div class="section-item" onclick="showSection('info-teachers')">
<div class="section-item-left">
<div class="section-item-icon section-icon--purple">üéì</div>
<div class="section-item-text">
<h4 class="section-item-title">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–∏</h4>
<p class="section-item-desc">–°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π</p>
</div>
</div>
<div class="section-item-arrow">‚Ä∫</div>
</div>
<div class="section-item" onclick="showSection('info-directions')">
<div class="section-item-left">
<div class="section-item-icon section-icon--blue">‚è±</div>
<div class="section-item-text">
<h4 class="section-item-title">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h4>
<p class="section-item-desc">–í–∏–¥—ã —Ç–∞–Ω—Ü–µ–≤</p>
</div>
</div>
<div class="section-item-arrow">‚Ä∫</div>
</div>
<div class="section-item" onclick="showSection('info-individual')">
<div class="section-item-left">
<div class="section-item-icon section-icon--blue">‚è±Ô∏è</div>
<div class="section-item-text">
<h4 class="section-item-title">–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –∑–∞–Ω—è—Ç–∏—è</h4>
<p class="section-item-desc">–ó–∞–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</p>
</div>
</div>
<div class="section-item-arrow">‚Ä∫</div>
</div>
<div class="section-item" onclick="showSection('info-rent')">
<div class="section-item-left">
<div class="section-item-icon section-icon--pink">üîë</div>
<div class="section-item-text">
<h4 class="section-item-title">–ê—Ä–µ–Ω–¥–∞ –∑–∞–ª–∞</h4>
<p class="section-item-desc">–£—Å–ª–æ–≤–∏—è –∞—Ä–µ–Ω–¥—ã –∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</p>
</div>
</div>
<div class="section-item-arrow">‚Ä∫</div>
</div>
</div>
</div>
<!-- ====== –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –°–¢–£–î–ò–ò ====== -->
<div class="page" id="info-about">
<h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç—É–¥–∏–∏</h3>
<div class="card">
<h4>‚è∞ –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã</h4>
<p>–ï–∂–µ–¥–Ω–µ–≤–Ω–æ: 09:00 - 22:00</p>
</div>
<div class="card" style="display: none;">
<h4>üìç –ö–∞–∫ –¥–æ–±—Ä–∞—Ç—å—Å—è</h4>
<script async="" charset="utf-8" src="https://api-maps.yandex.ru/services/constructor/1.0/js/?um=constructor%3Aa1063a1f3fac777c9cdef5b98494aee9e4ffee329067594a69657b435039fe33&amp;width=334&amp;height=265&amp;lang=ru_RU&amp;scroll=true" type="text/javascript"></script>
</div>
<div class="card">
<h4>üìû –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
<div class="contact-btn" onclick="copyPhone('+7 800 555 35 35')">
<div class="contact-btn-content">
<span class="contact-icon">üì±</span>
<div>
<div class="contact-label">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</div>
<div class="contact-value">+7 800 555 35 35</div>
</div>
</div>
<span class="contact-action">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</span>
</div>
<div class="contact-btn">
<div class="contact-btn-content">
<span class="contact-icon">üí¨</span>
<div>
<div class="contact-label">Telegram</div>
<div class="contact-value">–°–∫–æ—Ä–æ</div>
</div>
</div>
<span class="contact-action">–°–∫–æ—Ä–æ</span>
</div>
</div>
</div>
<!-- ====== –†–ê–°–ü–ò–°–ê–ù–ò–ï ====== -->
<div class="page" data-title="üóì –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ" id="schedule">
<div class="public-schedule-header">
  <div class="public-schedule-title"><span>‚òÜ</span>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</div>
  <div class="public-schedule-action">–§–∏–ª—å—Ç—Ä</div>
</div>
<div class="public-schedule-month" id="public-schedule-month">‚Äî</div>
<div class="public-schedule-strip" id="public-schedule-strip"></div>
<div class="public-schedule-list" id="schedule-container">
  <p class="small" style="text-align: center; color: var(--hint); padding: 20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
</div>
</div>
<div class="page" data-title="üóì –ó–∞–Ω—è—Ç–∏–µ" id="public-schedule-detail">
  <div class="public-schedule-detail" id="public-schedule-detail-content"></div>
</div>
<!-- ====== –†–ê–ë–û–¢–´ (–ü–ï–†–°–û–ù–ê–õ) ====== -->
<div class="page work-page" data-title="üë®‚Äçüíº –†–∞–±–æ—Ç–∞" id="staff">
<!-- –ü–∞–Ω–µ–ª—å —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–µ—Ä—Å–æ–Ω–∞–ª–µ -->
<div class="staff-info-panel">
<div class="staff-avatar-small" id="staff-panel-avatar">
<img alt="–§–æ—Ç–æ" id="staff-panel-avatar-img" src="" style="display: none;"/>
<p style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--hint);">üë§</p>
</div>
<div class="staff-info-text">
<div class="staff-name" id="staff-panel-name">‚Äî</div>
<div class="staff-position" id="staff-panel-position">‚Äî</div>
</div>
<button class="lock-btn" onclick="openStaffProfileEdit()" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–±–æ—á–∏–π –ø—Ä–æ—Ñ–∏–ª—å">‚úèÔ∏è</button>
</div>
<!-- –ú–µ–Ω—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ -->
<div class="card work-section" style="margin-bottom: 12px;">
<h4 style="margin-bottom: 10px;">–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ</h4>
<button class="save-btn" onclick="showPage('personal-schedule')" style="width: 100%; margin-bottom: 8px;">üìÖ –õ–∏—á–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ</button>
<button class="save-btn" type="button" style="width: 100%; margin-bottom: 8px;">üë• –õ–∏—á–Ω—ã–µ –≥—Ä—É–ø–ø—ã</button>
</div>
<div class="card work-section" style="margin-bottom: 12px;">
<h4 style="margin-bottom: 10px;">–°—Ç—Ä—É–∫—Ç—É—Ä–∞</h4>
<button class="save-btn" onclick="showPage('schedule-control')" style="width: 100%; margin-bottom: 8px;">üóìÔ∏è –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</button>
<button class="save-btn" onclick="showPage('directions-groups')" style="width: 100%; margin-bottom: 8px;">üìö –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –≥—Ä—É–ø–ø—ã</button>
</div>
<div class="card work-section" style="margin-bottom: 12px;">
<h4 style="margin-bottom: 10px;">–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏</h4>
<button class="save-btn" onclick="showPage('mailings')" style="width: 100%; margin-bottom: 8px;">üìß –†–∞—Å—Å—ã–ª–∫–∏</button>
<button class="save-btn" onclick="showPage('news-manage')" style="width: 100%; margin-bottom: 8px;">üì∞ –ù–æ–≤–æ—Å—Ç–∏</button>
</div>
<div class="card work-section">
<h4 style="margin-bottom: 10px;">–†–∞–±–æ—Ç–∞ —Å –ª—é–¥—å–º–∏</h4>
<button class="save-btn" id="staff-manage-btn-work" onclick="showPage('staff-manage')" style="width: 100%; margin-bottom: 8px; display: none; text-align: center;">üë• –ü–µ—Ä—Å–æ–Ω–∞–ª</button>
<button class="save-btn" onclick="showPage('clients-list')" style="width: 100%; margin-bottom: 8px;">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –ö–ª–∏–µ–Ω—Ç—ã</button>
</div>
</div>
<!-- ====== –õ–ò–ß–ù–û–ï –†–ê–°–ü–ò–°–ê–ù–ò–ï ====== -->
<div class="page" data-title="üìÖ –õ–∏—á–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ" id="personal-schedule">

<div id="personal-schedule-container">
<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</p>
</div>
</div>
<!-- ====== –£–ü–†–ê–í–õ–ï–ù–ò–ï –†–ê–°–ü–ò–°–ê–ù–ò–ï–ú ====== -->
<div class="page" data-title="üóì –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ" id="schedule-control">

<div id="schedule-control-container">
<div class="schedule-toolbar">
  <button class="button active" id="schedule-view-week" onclick="setScheduleView('week')">–ù–µ–¥–µ–ª—è</button>
  <button class="button" id="schedule-view-day" onclick="setScheduleView('day')">–î–µ–Ω—å</button>
</div>
<div class="schedule-nav">
  <button class="nav-btn-mini" onclick="shiftScheduleDate(-1)">‚Äπ</button>
  <div class="date-label" id="schedule-date-label">‚Äî</div>
  <button class="nav-btn-mini" onclick="shiftScheduleDate(1)">‚Ä∫</button>
</div>
<div id="schedule-grid-container"></div>
<div class="schedule-detail-overlay" id="schedule-detail-overlay" onclick="closeScheduleDetail()"></div>
<div class="schedule-detail-modal" id="schedule-detail-modal">
  <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px;">
    <h4 style="margin: 0;">–î–µ—Ç–∞–ª–∏ –∑–∞–Ω—è—Ç–∏—è</h4>
    <button class="save-btn" style="padding: 6px 10px; background: #777;" onclick="closeScheduleDetail()">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
  <div id="schedule-detail-content" style="margin-top: 8px;"></div>
</div>

<div class="schedule-form" id="schedule-admin-form">
  <h4 style="margin: 0 0 8px 0;">–°–æ–∑–¥–∞—Ç—å –∑–∞–Ω—è—Ç–∏–µ</h4>
  <label class="label">–¢–∏–ø</label>
  <select class="form-input" id="schedule-object-type">
    <option value="group">–ì—Ä—É–ø–ø–æ–≤–æ–µ</option>
    <option value="individual">–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–µ</option>
    <option value="rental">–ê—Ä–µ–Ω–¥–∞</option>
  </select>
  <label class="label">ID –æ–±—ä–µ–∫—Ç–∞</label>
  <input class="form-input" id="schedule-object-id" type="number" placeholder="ID –æ–±—ä–µ–∫—Ç–∞"/>
  <label class="label">–î–∞—Ç–∞</label>
  <input class="form-input" id="schedule-date" type="date"/>
  <label class="label">–í—Ä–µ–º—è –æ—Ç</label>
  <input class="form-input" id="schedule-time-from" type="time" step="1800"/>
  <label class="label">–í—Ä–µ–º—è –¥–æ</label>
  <input class="form-input" id="schedule-time-to" type="time" step="1800"/>
  <label class="label">–ü–æ–≤—Ç–æ—Ä—è—Ç—å –¥–æ (–ø–æ –Ω–µ–¥–µ–ª—è–º)</label>
  <input class="form-input" id="schedule-repeat-until" type="date"/>
  <div style="display: flex; gap: 8px; margin-top: 10px;">
    <button class="save-btn" style="flex: 1;" onclick="createScheduleV2()">–°–æ–∑–¥–∞—Ç—å</button>
    <button class="save-btn" style="flex: 1; background: #777;" onclick="closeScheduleForm()">–û—Ç–º–µ–Ω–∞</button>
  </div>
</div>

<button class="save-btn" style="width: 100%; margin-top: 12px; background: #2196F3;" onclick="toggleGroupScheduleForm()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≥—Ä—É–ø–ø–æ–≤–æ–µ –∑–∞–Ω—è—Ç–∏–µ</button>
<div class="group-schedule-overlay" id="group-schedule-overlay" onclick="toggleGroupScheduleForm(false)"></div>
<div class="group-schedule-modal" id="group-schedule-modal">
  <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px;">
    <h4 style="margin: 0;">–ì—Ä—É–ø–ø–æ–≤–æ–µ –∑–∞–Ω—è—Ç–∏–µ</h4>
    <button class="save-btn" style="padding: 6px 10px; background: #777;" onclick="toggleGroupScheduleForm(false)">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
  <label class="label">–ì—Ä—É–ø–ø–∞</label>
  <select class="form-input" id="group-schedule-group">
    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É</option>
  </select>
  <div class="schedule-detail-card" id="group-schedule-preview" style="display: none;"></div>
  <label class="label">–î–∞—Ç–∞</label>
  <input class="form-input" id="group-schedule-date" type="date"/>
  <div style="display: flex; gap: 8px;">
    <div style="flex: 1;">
      <label class="label">–í—Ä–µ–º—è –æ—Ç</label>
      <input class="form-input" id="group-schedule-time-from" type="time" step="1800"/>
    </div>
    <div style="flex: 1;">
      <label class="label">–í—Ä–µ–º—è –¥–æ</label>
      <input class="form-input" id="group-schedule-time-to" type="time" step="1800"/>
    </div>
  </div>

  <div class="repeat-panel">
    <div class="repeat-row">
      <span style="font-size: 12px; font-weight: 600;">–ü–æ–≤—Ç–æ—Ä—è—Ç—å</span>
      <select class="form-input" id="repeat-mode" style="flex: 1;">
        <option value="none">–ù–µ –ø–æ–≤—Ç–æ—Ä—è—Ç—å</option>
        <option value="weekly" selected>–ü–æ –Ω–µ–¥–µ–ª—è–º</option>
        <option value="daily">–ü–æ –¥–Ω—è–º</option>
        <option value="monthly">–ü–æ –º–µ—Å—è—Ü–∞–º</option>
      </select>
    </div>

    <div class="repeat-row repeat-inline" id="repeat-interval-row">
      <span>–ö–∞–∂–¥—É—é(—ã–µ)</span>
      <input class="form-input" id="repeat-interval" type="number" min="1" value="1"/>
      <span id="repeat-interval-label">–Ω–µ–¥–µ–ª—é</span>
    </div>

    <div class="repeat-row" id="repeat-weekdays-row">
      <span class="chip" data-day="1">–ü–Ω</span>
      <span class="chip" data-day="2">–í—Ç</span>
      <span class="chip" data-day="3">–°—Ä</span>
      <span class="chip" data-day="4">–ß—Ç</span>
      <span class="chip" data-day="5">–ü—Ç</span>
      <span class="chip" data-day="6">–°–±</span>
      <span class="chip" data-day="0">–í—Å</span>
    </div>

  <div class="repeat-row repeat-inline">
      <label class="label" style="margin: 0;">–î–æ</label>
      <input class="form-input" id="repeat-until" type="date"/>
  </div>

    <div class="repeat-summary" id="repeat-summary">–ë–µ–∑ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è</div>
  </div>

  <div style="display: flex; gap: 8px; margin-top: 10px;">
    <button class="save-btn" style="flex: 1;" onclick="createGroupSchedule()">–°–æ–∑–¥–∞—Ç—å</button>
    <button class="save-btn" style="flex: 1; background: #777;" onclick="toggleGroupScheduleForm(false)">–û—Ç–º–µ–Ω–∞</button>
  </div>
</div>
</div>
</div>
<!-- ====== –ù–ê–ü–†–ê–í–õ–ï–ù–ò–Ø –ò –ì–†–£–ü–ü–´ ====== -->
<div class="page" data-title="üìö –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –≥—Ä—É–ø–ø—ã" id="directions-groups">

<div class="card" style="margin-bottom: 12px;">
<button class="save-btn" onclick="showPage('direction-create-form')" style="width: 100%;">‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</button>
</div>
<!-- –í–ö–õ–ê–î–ö–ò -->
<div class="tabs-container" style="display: flex; gap: 8px; margin-bottom: 12px; border-bottom: 2px solid var(--border); position: relative;">
<button class="nav-tab" id="active-tab" onclick="switchDirectionTab('active')" style="flex: 1; padding: 12px; background: none; border: none; color: #2196F3; font-weight: bold; cursor: pointer;">‚úÖ –ê–∫—Ç–∏–≤–Ω—ã–µ</button>
<button class="nav-tab" id="archived-tab" onclick="switchDirectionTab('archived')" style="flex: 1; padding: 12px; background: none; border: none; color: var(--hint); font-weight: bold; cursor: pointer;">üì¶ –ê—Ä—Ö–∏–≤</button>
<div class="tab-indicator"></div>
</div>
<div id="directions-groups-container">
<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</p>
</div>
</div>
<!-- ====== –†–ê–°–°–´–õ–ö–ò ====== -->
<div class="page" data-title="üìß –†–∞—Å—Å—ã–ª–∫–∏" id="mailings">

<button class="save-btn" onclick="showPage('mailing-create-form')" style="width: 100%; margin-bottom: 16px;">‚úâÔ∏è –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Ä–∞—Å—Å—ã–ª–∫—É</button>
<div id="mailings-container">
<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</p>
</div>
</div>
<!-- ====== –§–û–†–ú–ê –°–û–ó–î–ê–ù–ò–Ø –†–ê–°–°–´–õ–ö–ò ====== -->
<div class="page" data-title="‚úâÔ∏è –°–æ–∑–¥–∞—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É" id="mailing-create-form">

<!-- –ë–õ–û–ö 1: –û–°–ù–û–í–ù–´–ï –î–ê–ù–ù–´–ï -->
<div class="card" style="margin-bottom: 16px; border-left: 4px solid var(--accent);">
<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 14px; padding-bottom: 12px; border-bottom: 2px solid var(--border);">
<span style="font-size: 20px;">üìù</span>
<h4 style="margin: 0;">–û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h4>
</div>
<!-- –ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏ -->
<label class="label" style="font-weight: 600;">–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏</label>
<input class="form-input" id="mailing-name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å–º–µ–Ω—ã" style="margin-bottom: 14px;" type="text"/>
<!-- –û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏ -->
<label class="label" style="font-weight: 600;">–û–ø–∏—Å–∞–Ω–∏–µ</label>
<textarea class="form-input" id="mailing-description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏..." style="margin-bottom: 14px; min-height: 80px; resize: vertical;"></textarea>
<!-- –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ -->
<label class="label" style="font-weight: 600;">–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ</label>
<input class="form-input" id="mailing-purpose" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ò–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ, –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ, –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ..." type="text"/>
</div>
<!-- –ë–õ–û–ö 2: –ö–û–ú –û–¢–ü–†–ê–í–ò–¢–¨ -->
<div class="card" style="margin-bottom: 16px; border-left: 4px solid #2196F3;">
<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 14px; padding-bottom: 12px; border-bottom: 2px solid var(--border);">
<span style="font-size: 20px;">üë•</span>
<h4 style="margin: 0;">–ö–æ–º—É –æ—Ç–ø—Ä–∞–≤–∏—Ç—å</h4>
</div>
<!-- –¢–∏–ø –∫–æ–º—É –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å -->
<label class="label" style="font-weight: 600;">–¢–∏–ø —Ä–∞—Å—Å—ã–ª–∫–∏</label>
<select class="form-input" id="mailing-target-type" onchange="onMailingTargetTypeChange()" style="margin-bottom: 14px; font-size: 14px;">
<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø --</option>
<option value="all">üåç –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>
<option value="user">üë§ –í—ã–±—Ä–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>
<option value="group">üë´ –ì—Ä—É–ø–ø–µ –ù–ì (–æ—Ç –±–æ—Ç–∞ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º –≥—Ä—É–ø–ø—ã)</option>
<option value="direction">üíÉ –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</option>
<option value="tg_chat">üì± Telegram-–≥—Ä—É–ø–ø–∞/–∫–∞–Ω–∞–ª</option>
</select>
<!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
<div id="mailing-users-container" style="display: none;">
<label class="label" style="font-weight: 600;">üîç –í—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</label>
<!-- –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
<input class="form-input" id="mailing-users-search" oninput="searchMailingUsers()" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏, ID –∏–ª–∏ @—é–∑–µ—Ä–Ω–µ–π–º..." style="margin-bottom: 10px;" type="text"/>
<!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ -->
<div id="mailing-users-search-results" style="max-height: 300px; overflow-y: auto; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 12px; padding: 8px;">
<p class="small" style="text-align: center; color: var(--hint); padding: 12px;">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...</p>
</div>
<!-- –í—ã–±—Ä–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ -->
<div style="background: #f5f5f5; padding: 12px; border-radius: 8px;">
<label class="label" style="font-weight: 600; margin-bottom: 8px;">‚úì –í—ã–±—Ä–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</label>
<div id="mailing-selected-users" style="display: flex; flex-wrap: wrap; gap: 8px; min-height: 32px; align-content: flex-start;">
<p class="small" style="color: var(--hint); width: 100%;">–í—ã–±—Ä–∞–Ω–æ: <span id="mailing-users-count" style="font-weight: 600;">0</span></p>
</div>
</div>
</div>
<!-- ID —Ü–µ–ª–∏ (–¥–ª—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π –∏ Telegram) -->
<div id="mailing-target-id-container" style="display: none;">
<label class="label" style="font-weight: 600;">ID –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è/–≥—Ä—É–ø–ø—ã Telegram</label>
<input class="form-input" id="mailing-target-id" placeholder="–í–≤–µ–¥–∏—Ç–µ ID" type="number"/>
</div>
</div>
<!-- –ë–õ–û–ö 3: –í–†–ï–ú–Ø –û–¢–ü–†–ê–í–ö–ò -->
<div class="card" style="margin-bottom: 16px; border-left: 4px solid #4CAF50;">
<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 14px; padding-bottom: 12px; border-bottom: 2px solid var(--border);">
<span style="font-size: 20px;">‚è∞</span>
<h4 style="margin: 0;">–í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏</h4>
</div>
<!-- –í—ã–±–æ—Ä –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
<label class="label" style="font-weight: 600; margin-bottom: 10px;">–ö–æ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å</label>
<div style="display: flex; gap: 10px; margin-bottom: 14px;">
<button class="save-btn" id="send-now-btn" onclick="setMailingSendNow(true)" style="flex: 1; background: var(--accent); font-weight: 600; padding: 12px;">‚ñ∂Ô∏è –°–µ–π—á–∞—Å</button>
<button class="save-btn" onclick="setMailingSendNow(false)" style="flex: 1; background: var(--hint); font-weight: 600; padding: 12px;">‚è≤Ô∏è –ü–æ–∑–∂–µ</button>
</div>
<!-- –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –¥–ª—è –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
<div id="mailing-schedule-container" style="display: none;">
<label class="label" style="font-weight: 600;">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏</label>
<input class="form-input" id="mailing-scheduled-at" type="datetime-local"/>
</div>
</div>
<!-- –ö–ù–û–ü–ö–ê –°–û–ó–î–ê–ù–ò–Ø -->
<div class="card" style="background: linear-gradient(135deg, var(--accent) 0%, #c2185b 100%); padding: 0; border: none;">
<button class="save-btn" onclick="createMailing()" style="width: 100%; background: transparent; color: white; font-size: 16px; font-weight: 600; padding: 16px; border: none; cursor: pointer;">‚úâÔ∏è –°–æ–∑–¥–∞—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É</button>
</div>
</div>
<!-- ====== –û–ë–™–Ø–í–õ–ï–ù–ò–Ø (–°–¢–ê–†–û–ï) ====== -->
<div class="page" data-title="–û–±—ä—è–≤–ª–µ–Ω–∏—è" id="announcements" style="display: none;">

<button class="save-btn" style="width: 100%; margin-bottom: 16px;">üìù –°–æ–∑–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</button>
<div id="announcements-container">
<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</p>
</div>
</div>
<!-- ====== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ù–û–í–û–°–¢–Ø–ú–ò ====== -->
<div class="page" data-title="üì∞ –ù–æ–≤–æ—Å—Ç–∏" id="news-manage">

<button class="save-btn" onclick="showPage('news-add-form')" style="width: 100%; margin-bottom: 16px;">‚úçÔ∏è –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ—Å—Ç—å</button>
<div id="news-manage-container">
<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</p>
</div>
</div>
<!-- ====== –§–û–†–ú–ê –î–û–ë–ê–í–õ–ï–ù–ò–Ø –ù–û–í–û–°–¢–ò ====== -->
<div class="page" data-title="üìù –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ—Å—Ç—å" id="news-add-form">

<button class="save-btn" onclick="openBotForCreateNews()" style="width: 100%; padding: 20px; font-size: 16px;">üìù –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ—Å—Ç—å —á–µ—Ä–µ–∑ –±–æ—Ç–∞</button>
</div>
<!-- ====== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ü–ï–†–°–û–ù–ê–õ–û–ú (–ò–ó –†–ê–ë–û–¢–´) ====== -->
<div class="page" data-title="üë• –ü–µ—Ä—Å–æ–Ω–∞–ª" id="staff-manage">

<button class="save-btn" onclick="showAddStaffForm()" style="width: 100%; margin-bottom: 16px;">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª</button>
<div class="card" style="margin-bottom: 16px;">
<h4>üîç –ü–æ–∏—Å–∫ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞</h4>
<input class="form-input" id="staff-manage-search" oninput="searchStaffManage()" placeholder="–ò–º—è, ID –∏–ª–∏ @—é–∑–µ—Ä–Ω–µ–π–º" style="margin-top: 8px;" type="text"/>
</div>
<div id="staff-manage-container">
<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</p>
</div>
</div>
<!-- ====== –ö–õ–ò–ï–ù–¢–´ ====== -->
<div class="page" data-title="üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –ö–ª–∏–µ–Ω—Ç—ã" id="clients-list">

<div class="card">
<h4>üîç –ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞</h4>
<input class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏–ª–∏ Telegram ID..." style="margin-bottom: 12px;" type="text"/>
</div>
<div id="clients-list-container">
<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</p>
</div>
</div>
<!-- ====== –ü–†–û–§–ò–õ–¨ ====== -->
<div class="page" id="profile">
<div class="profile">
<div class="avatar" id="avatar"></div>
<h3 id="profile-name">‚Äî</h3>
<p class="small" id="profile-username">‚Äî</p>
</div>
<div class="card">
<h4>üìã –õ–∏—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
<div class="form-group">
<label>–ò–º—è</label>
<input class="form-input" id="profile-input-name" placeholder="–í–∞—à–µ –∏–º—è" type="text"/>
</div>
<div class="form-group">
<label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
<input class="form-input" id="profile-input-phone" placeholder="+7 800 555 35 35" type="tel"/>
</div>
<div class="form-group">
<label>Email</label>
<input class="form-input" id="profile-input-email" placeholder="example@mail.com" type="email"/>
</div>
<div class="form-group">
<label>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
<input class="form-input" id="profile-input-birth-date" type="date"/>
</div>
<div class="form-group">
<label>–í–∞—à–∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è</label>
<textarea class="form-input" id="profile-input-user-notes" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à–∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è –∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è..." rows="3"></textarea>
</div>
<button class="save-btn" onclick="saveProfileChanges()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
</div>
<div class="card">
<h4>‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–∫–∫–∞—É–Ω—Ç–µ</h4>
<p class="small"><strong>–°—Ç–∞—Ç—É—Å:</strong> <span id="profile-status">‚Äî</span></p>
<p class="small"><strong>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</strong> <span id="profile-registered">‚Äî</span></p>
</div>
</div>
<!-- ====== –†–ê–°–ü–ò–°–ê–ù–ò–ï –ü–ï–†–°–û–ù–ê–õ–ê ====== -->
<div class="page" data-title="üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞" id="staff-schedule">

<div id="staff-schedule-container">
<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</p>
</div>
<!-- –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–Ω—è—Ç–∏—è –¥–ª—è —É—á–∏—Ç–µ–ª—è -->
<div id="teacher-create-btn-container" style="display: none; padding: 16px; padding-top: 0;">
<button class="save-btn" onclick="openCreateSchedule()" style="width: 100%;">‚ûï –°–æ–∑–¥–∞—Ç—å –∑–∞–Ω—è—Ç–∏–µ</button>
</div>
</div>
<!-- ====== –°–û–ó–î–ê–ù–ò–ï/–†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –ó–ê–ù–Ø–¢–ò–Ø ====== -->
<div class="page" data-title="üóì –ó–∞–Ω—è—Ç–∏–µ" id="schedule-form">

<div class="card">
<div class="form-group">
<label>–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–Ω—è—Ç–∏—è</label>
<input class="form-input" id="schedule-input-title" placeholder="–ë–∞–ª–µ—Ç, –•–∏–ø-—Ö–æ–ø –∏ —Ç.–¥." type="text"/>
</div>
<div class="form-group">
<label>–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å</label>
<select class="form-input" id="schedule-input-teacher">
<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è</option>
</select>
</div>
<div class="form-group">
<label>–î–∞—Ç–∞</label>
<input class="form-input" id="schedule-input-date" type="date"/>
</div>
<div class="form-group">
<label>–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞</label>
<input class="form-input" id="schedule-input-start" type="time"/>
</div>
<div class="form-group">
<label>–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
<input class="form-input" id="schedule-input-end" type="time"/>
</div>
<div style="display: flex; gap: 8px;">
<button class="save-btn" onclick="saveSchedule()" style="flex: 1;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
<button class="save-btn" id="schedule-delete-btn" onclick="deleteSchedule()" style="flex: 1; background: #ff6b6b; display: none;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
</div>
</div>
</div>
<!-- ====== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ü–ï–†–°–û–ù–ê–õ–û–ú ====== -->
<div class="page" data-title="üë• –ü–µ—Ä—Å–æ–Ω–∞–ª" id="staff-management">

<button class="save-btn" onclick="showAddStaffForm()" style="width: 100%; margin-bottom: 12px;">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª</button>
<div id="staff-list-container">
<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</p>
</div>
</div>
<!-- ====== –§–û–†–ú–ê –î–û–ë–ê–í–õ–ï–ù–ò–Ø –ü–ï–†–°–û–ù–ê–õ–ê ====== -->
<div class="page" data-title="‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª" id="staff-add-form">

<div class="card">
<div class="form-group">
<label>üîç –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
<input class="form-input" id="staff-user-search" oninput="searchForStaffUser()" placeholder="–ò–º—è, ID –∏–ª–∏ @—é–∑–µ—Ä" type="text"/>
</div>
<div id="staff-user-search-results" style="max-height: 280px; overflow-y: auto; margin-bottom: 16px; border-radius: 8px; background: var(--card); padding: 8px; border: 1px solid var(--border);">
<p class="small" style="text-align: center; color: var(--hint); padding: 16px 0;">–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –¥–ª—è –ø–æ–∏—Å–∫–∞...</p>
</div>
</div>
<!-- –û–±—â–∏–µ –ø–æ–ª—è –¥–ª—è –æ–±–æ–∏—Ö —Å–ø–æ—Å–æ–±–æ–≤ -->
<div class="card">
<div class="form-group">
<label>–î–æ–ª–∂–Ω–æ—Å—Ç—å *</label>
<select class="form-input" id="staff-add-position">
<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¥–æ–ª–∂–Ω–æ—Å—Ç—å</option>
<option value="—É—á–∏—Ç–µ–ª—å">üë©‚Äçüè´ –£—á–∏—Ç–µ–ª—å</option>
<option value="–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä">üìã –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
</select>
</div>
<div class="form-group">
<label>–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
<input class="form-input" id="staff-add-specialization" placeholder="–ë–∞–ª–µ—Ç, –•–∏–ø-—Ö–æ–ø –∏ —Ç.–¥." type="text"/>
</div>
<div class="form-group">
<label>–ë–∏–æ–≥—Ä–∞—Ñ–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
<textarea class="form-input" id="staff-add-bio" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞" style="height: 80px; resize: none;"></textarea>
</div>
<button class="save-btn" onclick="saveNewStaff()" style="width: 100%; margin-top: 12px;">üíæ –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª</button>
</div>
</div>
<!-- ====== –°–¢–†–ê–ù–ò–¶–ê –ü–ï–†–°–û–ù–ê–õ–ê ====== -->
<div class="page" id="staff-detail">
<div class="profile">
<div class="avatar" id="staff-detail-avatar">
<img alt="–§–æ—Ç–æ" id="staff-detail-avatar-img" src="" style="display: none;"/>
<p style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--hint); margin: 0;">üë§</p>
</div>
<h3 id="staff-detail-name">‚Äî</h3>
<p class="small" id="staff-detail-position">‚Äî</p>
</div>
<div class="card">
<h4>üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
<div style="margin-bottom: 12px;">
<label style="font-size: 12px; color: var(--hint);">–î–æ–ª–∂–Ω–æ—Å—Ç—å</label>
<div id="staff-detail-position-full" style="font-size: 15px; margin-top: 4px;">‚Äî</div>
</div>
<div id="staff-detail-phone-block" style="margin-bottom: 12px; display: none;">
<label style="font-size: 12px; color: var(--hint);">–¢–µ–ª–µ—Ñ–æ–Ω</label>
<div id="staff-detail-phone" style="font-size: 15px; margin-top: 4px;">‚Äî</div>
</div>
<div style="margin-bottom: 12px;">
<label style="font-size: 12px; color: var(--hint);">Email</label>
<div id="staff-detail-email" style="font-size: 15px; margin-top: 4px;">‚Äî</div>
</div>
<div style="margin-bottom: 12px;">
<label style="font-size: 12px; color: var(--hint);">–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è</label>
<div id="staff-detail-specialization" style="font-size: 15px; margin-top: 4px;">‚Äî</div>
</div>
<div style="margin-bottom: 12px;">
<label style="font-size: 12px; color: var(--hint);">–°—Ç–∞—Ç—É—Å</label>
<div id="staff-detail-status" style="font-size: 15px; margin-top: 4px;">‚Äî</div>
</div>
</div>
<div class="card">
<h4>üìù –ë–∏–æ–≥—Ä–∞—Ñ–∏—è</h4>
<p id="staff-detail-bio" style="white-space: pre-wrap; line-height: 1.5;">‚Äî</p>
</div>
<button class="save-btn" onclick="deleteCurrentStaff()" style="width: 100%; background: #ff6b6b;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª</button>
</div>
<!-- ====== –§–û–†–ú–ê –°–û–ó–î–ê–ù–ò–Ø –ù–ê–ü–†–ê–í–õ–ï–ù–ò–Ø ====== -->
<div class="page" data-title="‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ" id="direction-create-form">

<div class="card" style="margin-bottom: 16px; border-left: 4px solid var(--accent);">
<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 14px; padding-bottom: 12px; border-bottom: 2px solid var(--border);">
<span style="font-size: 20px;">üìù</span>
<h4 style="margin: 0;">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
</div>
<!-- –ù–∞–∑–≤–∞–Ω–∏–µ -->
<label class="label" style="font-weight: 600;">–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è *</label>
<input class="form-input" id="direction-title" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ë–∞–ª–µ—Ç, –•–∏–ø-—Ö–æ–ø, –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ç–∞–Ω–µ—Ü" style="margin-bottom: 14px;" type="text"/>
<!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
<label class="label" style="font-weight: 600;">–û–ø–∏—Å–∞–Ω–∏–µ *</label>
<textarea class="form-input" id="direction-description" placeholder="–û–ø–∏—à–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ..." style="margin-bottom: 14px; min-height: 100px; resize: vertical;"></textarea>
<!-- –¶–µ–Ω–∞ -->
<label class="label" style="font-weight: 600;">–ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ (‚ÇΩ) *</label>
<input class="form-input" id="direction-price" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 5000" style="margin-bottom: 14px;" type="number"/>
</div>
<div class="card" style="margin-bottom: 16px; border-left: 4px solid #4CAF50;">
<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 14px; padding-bottom: 12px; border-bottom: 2px solid var(--border);">
<span style="font-size: 20px;">üì∏</span>
<h4 style="margin: 0;">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è</h4>
</div>
<!-- –°—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–∫–∏ -->
<div id="direction-photo-status" style="padding: 12px; background: #f0f0f0; border-radius: 8px; margin-bottom: 12px; text-align: center;">
<p style="margin: 0; color: var(--hint); font-size: 14px;">‚ùå –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞</p>
</div>
<!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ -->
<button class="save-btn" id="direction-upload-btn" onclick="generateDirectionUploadToken()" style="width: 100%; margin-bottom: 8px; background: #2196F3;">
      üì± –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ —á–µ—Ä–µ–∑ –±–æ—Ç
    </button>
<p style="font-size: 12px; color: var(--hint); margin: 0; line-height: 1.5;">
      üí° –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É, —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–æ–∫–µ–Ω, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–≥–æ –±–æ—Ç—É –∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é. –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –∫–Ω–æ–ø–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è.
    </p>
</div>
<button class="save-btn" id="direction-create-btn" onclick="createDirection()" style="width: 100%; margin-bottom: 8px; background: #4CAF50;">
    ‚úÖ –°–æ–∑–¥–∞—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
  </button>
<button class="save-btn" onclick="goBack()" style="width: 100%; background: #777;">
    ‚ùå –û—Ç–º–µ–Ω–∏—Ç—å
  </button>
<!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ -->
<div id="direction-error-msg" style="margin-top: 12px; padding: 12px; background: #ffebee; border-radius: 8px; color: #c62828; display: none;">
<p id="direction-error-text" style="margin: 0;"></p>
</div>
<!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ -->
<div id="direction-success-msg" style="margin-top: 12px; padding: 12px; background: #e8f5e9; border-radius: 8px; color: #2e7d32; display: none;">
<p id="direction-success-text" style="margin: 0;"></p>
</div>
</div>
<!-- ====== –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –ù–ê–ü–†–ê–í–õ–ï–ù–ò–Ø ====== -->
<div class="page" data-title="‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ" id="direction-edit-form">
<div class="direction-edit-header">

<button class="lock-btn" id="direction-edit-lock-btn" onclick="toggleDirectionEditLock()" title="–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ">üîì</button>
</div>
<p class="small" id="direction-edit-lock-hint" style="margin: 6px 0 12px 0;">–ü–æ–ª—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Å–ª—É—á–∞–π–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π.</p>
<!-- –ì–†–£–ü–ü–´ -->
<div class="card" style="margin-bottom: 16px; border-left: 4px solid #FF9800;">
<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 14px; padding-bottom: 12px; border-bottom: 2px solid var(--border);">
<span style="font-size: 20px;">üë•</span>
<h4 style="margin: 0; flex: 1;">–ì—Ä—É–ø–ø—ã</h4>
<button class="lock-btn" onclick="openCreateGroupPage()" title="–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É">‚ûï</button>
</div>
<div id="edit-direction-groups-list" style="display: flex; flex-direction: column; gap: 8px;">
<p style="text-align: center; color: var(--hint); padding: 12px; margin: 0;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä—É–ø–ø...</p>
</div>
</div>
<!-- –û–°–ù–û–í–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø -->
<div class="card direction-lockable" style="margin-bottom: 16px; border-left: 4px solid var(--accent);">
<div aria-hidden="true" class="lock-overlay"></div>
<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 14px; padding-bottom: 12px; border-bottom: 2px solid var(--border);">
<span style="font-size: 20px;">üìù</span>
<h4 style="margin: 0;">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
</div>
<!-- –ù–∞–∑–≤–∞–Ω–∏–µ -->
<label class="label" style="font-weight: 600;">–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è *</label>
<input class="form-input direction-editable" id="edit-direction-title" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ë–∞–ª–µ—Ç, –•–∏–ø-—Ö–æ–ø, –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ç–∞–Ω–µ—Ü" style="margin-bottom: 14px;" type="text"/>
<!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
<label class="label" style="font-weight: 600;">–û–ø–∏—Å–∞–Ω–∏–µ *</label>
<textarea class="form-input direction-editable" id="edit-direction-description" placeholder="–û–ø–∏—à–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ..." style="margin-bottom: 14px; min-height: 100px; resize: vertical;"></textarea>
<!-- –¶–µ–Ω–∞ -->
<label class="label" style="font-weight: 600;">–ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ (‚ÇΩ) *</label>
<input class="form-input direction-editable" id="edit-direction-price" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 5000" style="margin-bottom: 14px;" type="number"/>
<!-- –°—Ç–∞—Ç—É—Å -->
<label class="label" style="font-weight: 600;">–°—Ç–∞—Ç—É—Å</label>
<select class="form-input direction-editable" id="edit-direction-status" style="margin-bottom: 14px;">
<option value="active">‚úÖ –ê–∫—Ç–∏–≤–Ω–æ–µ</option>
<option value="inactive">‚è∏Ô∏è –ù–µ–∞–∫—Ç–∏–≤–Ω–æ–µ</option>
</select>
</div>
<!-- –§–û–¢–û–ì–†–ê–§–ò–Ø -->
<div class="card direction-lockable" style="margin-bottom: 16px; border-left: 4px solid #4CAF50;">
<div aria-hidden="true" class="lock-overlay"></div>
<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 14px; padding-bottom: 12px; border-bottom: 2px solid var(--border);">
<span style="font-size: 20px;">üì∏</span>
<h4 style="margin: 0;">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è</h4>
</div>
<div id="edit-direction-photo-preview" style="width: 100%; height: 150px; background: #f0f0f0; border-radius: 8px; margin-bottom: 12px; display: flex; align-items: center; justify-content: center; color: var(--hint); overflow: hidden;">
      üì∏ –§–æ—Ç–æ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ
    </div>
<button class="save-btn direction-editable" onclick="generateDirectionUploadToken()" style="width: 100%; margin-bottom: 8px; background: #2196F3;">
      üì± –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤–æ–µ —Ñ–æ—Ç–æ —á–µ—Ä–µ–∑ –±–æ—Ç
    </button>
</div>
<!-- –ö–ù–û–ü–ö–ò –î–ï–ô–°–¢–í–ò–Ø -->
<div class="direction-lockable" style="margin-bottom: 12px;">
<div aria-hidden="true" class="lock-overlay"></div>
<button class="save-btn direction-editable" id="direction-save-btn" onclick="saveDirectionChanges()" style="width: 100%; margin-bottom: 8px; background: #4CAF50;">
      ‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
    </button>
<button class="save-btn" onclick="goBack()" style="width: 100%; background: #777;">
      ‚ùå –û—Ç–º–µ–Ω–∏—Ç—å
    </button>
</div>
<!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ -->
<div id="edit-direction-error-msg" style="margin-top: 12px; padding: 12px; background: #ffebee; border-radius: 8px; color: #c62828; display: none;">
<p id="edit-direction-error-text" style="margin: 0;"></p>
</div>
<!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ -->
<div id="edit-direction-success-msg" style="margin-top: 12px; padding: 12px; background: #e8f5e9; border-radius: 8px; color: #2e7d32; display: none;">
<p id="edit-direction-success-text" style="margin: 0;"></p>
</div>
</div>
<!-- ====== –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –†–ê–ë–û–ß–ï–ì–û –ü–†–û–§–ò–õ–Ø ====== -->
<div class="page" data-title="üë§ –ü—Ä–æ—Ñ–∏–ª—å –ø–µ—Ä—Å–æ–Ω–∞–ª–∞" id="staff-profile-edit">

<div class="card">
<div class="form-group">
<label>–ò–º—è</label>
<input class="form-input" id="staff-profile-name" placeholder="–ò–º—è" type="text"/>
</div>
<div class="form-group">
<label>–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è</label>
<input class="form-input" id="staff-profile-specialization" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ë–∞–ª–µ—Ç, –•–∏–ø‚Äë—Ö–æ–ø" type="text"/>
</div>
<div class="form-group">
<label>–ë–∏–æ–≥—Ä–∞—Ñ–∏—è</label>
<textarea class="form-input" id="staff-profile-bio" placeholder="–ö–æ—Ä–æ—Ç–∫–æ –æ —Å–µ–±–µ..." style="min-height: 80px;"></textarea>
</div>
<div class="form-group">
<label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
<input class="form-input" id="staff-profile-phone" placeholder="+7 900 000 00 00" type="text"/>
</div>
<div class="form-group">
<label>Email</label>
<input class="form-input" id="staff-profile-email" placeholder="name@example.com" type="email"/>
</div>
<button class="save-btn" onclick="saveStaffProfile()" style="width: 100%; margin-top: 8px;">
      üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
    </button>
</div>
</div>
<!-- ====== –°–û–ó–î–ê–ù–ò–ï –ì–†–£–ü–ü–´ ====== -->
<div class="page" data-title="‚ûï –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É" id="direction-group-create">

<div class="card" style="margin-bottom: 16px; border-left: 4px solid #FF9800;">
<div class="form-group">
<label>–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã *</label>
<input class="form-input" id="edit-direction-group-name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –î–µ—Ç–∏ 10-12, –•–∏–ø‚Äë—Ö–æ–ø Beginners" type="text"/>
</div>
<div class="form-group">
<label>–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å *</label>
<input class="form-input" id="group-teacher-search" oninput="searchGroupTeacher()" placeholder="–ò–º—è, ID –∏–ª–∏ @—é–∑–µ—Ä" type="text"/>
</div>
<div id="group-teacher-search-results" style="max-height: 240px; overflow-y: auto; margin-bottom: 12px; border-radius: 8px; background: var(--card); padding: 8px; border: 1px solid var(--border);">
<p class="small" style="text-align: center; color: var(--hint); padding: 12px 0;">–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –¥–ª—è –ø–æ–∏—Å–∫–∞...</p>
</div>
<div class="form-group">
<label>–í–æ–∑—Ä–∞—Å—Ç–Ω–∞—è –≥—Ä—É–ø–ø–∞ *</label>
<input class="form-input" id="edit-direction-group-age" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 12-16" type="text"/>
</div>
<div class="form-group">
<label>–ú–∞–∫—Å. —É—á–µ–Ω–∏–∫–æ–≤ *</label>
<input class="form-input" id="edit-direction-group-max" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 12" type="number"/>
</div>
<div class="form-group">
<label>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω) *</label>
<input class="form-input" id="edit-direction-group-duration" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 60" type="number"/>
</div>
<div class="form-group">
<label>–ó–∞–Ω—è—Ç–∏–π –≤ –Ω–µ–¥–µ–ª—é</label>
<input class="form-input" id="edit-direction-group-lessons" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 3" type="number" min="1"/>
</div>
<div class="form-group">
<label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
<textarea class="form-input" id="edit-direction-group-desc" placeholder="–ö–æ—Ä–æ—Ç–∫–æ –æ –≥—Ä—É–ø–ø–µ..." style="min-height: 80px;"></textarea>
</div>
<button class="save-btn" onclick="createDirectionGroup()" style="width: 100%; margin-bottom: 8px; background: #FF9800;">
      ‚ûï –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É
    </button>
<button class="save-btn" onclick="goBack()" style="width: 100%; background: #777;">
      ‚ùå –û—Ç–º–µ–Ω–∏—Ç—å
    </button>
<div id="edit-direction-group-msg" style="margin: 12px 0 0 0; padding: 10px; border-radius: 8px; display: none;"></div>
</div>
</div>
<!-- ====== –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –ì–†–£–ü–ü–´ ====== -->
<div class="page" data-title="‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≥—Ä—É–ø–ø—É" id="direction-group-edit">

<div class="card" style="margin-bottom: 16px; border-left: 4px solid #4CAF50;">
<div class="form-group">
<label>–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã *</label>
<input class="form-input" id="edit-group-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã" type="text"/>
</div>
<div class="form-group">
<label>–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å *</label>
<input class="form-input" id="edit-group-teacher-search" oninput="searchEditGroupTeacher()" placeholder="–ò–º—è, ID –∏–ª–∏ @—é–∑–µ—Ä" type="text"/>
</div>
<div id="edit-group-teacher-search-results" style="max-height: 240px; overflow-y: auto; margin-bottom: 12px; border-radius: 8px; background: var(--card); padding: 8px; border: 1px solid var(--border);">
<p class="small" style="text-align: center; color: var(--hint); padding: 12px 0;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π...</p>
</div>
<div class="form-group">
<label>–í–æ–∑—Ä–∞—Å—Ç–Ω–∞—è –≥—Ä—É–ø–ø–∞ *</label>
<input class="form-input" id="edit-group-age" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 12-16" type="text"/>
</div>
<div class="form-group">
<label>–ú–∞–∫—Å. —É—á–µ–Ω–∏–∫–æ–≤ *</label>
<input class="form-input" id="edit-group-max" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 12" type="number"/>
</div>
<div class="form-group">
<label>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω) *</label>
<input class="form-input" id="edit-group-duration" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 60" type="number"/>
</div>
<div class="form-group">
<label>–ó–∞–Ω—è—Ç–∏–π –≤ –Ω–µ–¥–µ–ª—é</label>
<input class="form-input" id="edit-group-lessons" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 3" type="number" min="1"/>
</div>
<div class="form-group">
<label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
<textarea class="form-input" id="edit-group-desc" placeholder="–ö–æ—Ä–æ—Ç–∫–æ –æ –≥—Ä—É–ø–ø–µ..." style="min-height: 80px;"></textarea>
</div>
<button class="save-btn" onclick="saveGroupChanges()" style="width: 100%; margin-bottom: 8px; background: #4CAF50;">
      ‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
    </button>
<button class="save-btn" onclick="goBack()" style="width: 100%; background: #777;">
      ‚ùå –û—Ç–º–µ–Ω–∏—Ç—å
    </button>
<div id="edit-group-msg" style="margin: 12px 0 0 0; padding: 10px; border-radius: 8px; display: none;"></div>
</div>
</div>
<div class="page" data-title="‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è" id="info">

<h3 id="info-title" style="display: none;"></h3>
<p class="small" id="info-placeholder">–†–∞–∑–¥–µ–ª –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</p>
<div id="info-directions-container" style="display: none;"></div>
</div>
<div class="page" data-title="üéØ –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ" id="direction-detail">
  <div id="direction-detail-content"></div>
</div>
<div class="page" data-title="‚è±Ô∏è –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –∑–∞–Ω—è—Ç–∏—è" id="info-individual">
<p class="small">–†–∞–∑–¥–µ–ª –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</p>
</div>
<div class="page" data-title="üîë –ê—Ä–µ–Ω–¥–∞ –∑–∞–ª–∞" id="info-rent">
<p class="small">–†–∞–∑–¥–µ–ª –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</p>
</div>
<!-- ====== –ü–†–û–°–ú–û–¢–† –ù–û–í–û–°–¢–ò ====== -->
<div class="page" id="news-detail">
<div class="news-detail-header">
<div class="news-detail-back" onclick="goBack()">‚Üê</div>
<h3 class="news-detail-title-header">–ù–æ–≤–æ—Å—Ç–∏</h3>
</div>
<div id="news-detail-photo-container"></div>
<div class="news-detail-content-wrapper">
<h3 id="news-detail-title"></h3>
<p class="small" id="news-detail-date"></p>
<p id="news-detail-content" style="white-space: pre-wrap;"></p>
</div>
</div>
<!-- ====== –ù–ò–ñ–ù–ï–ï –ú–ï–ù–Æ ====== -->
<div class="bottom-nav">
<div class="nav-btn active" onclick="showPage('home')">üè†<br/>–ì–ª–∞–≤–Ω–∞—è</div>
<div class="nav-btn" onclick="showPage('schedule')">üóì<br/>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</div>
<div class="nav-btn hidden" id="staff-nav-btn" onclick="showPage('staff')">üë®‚Äçüíº<br/>–†–∞–±–æ—Ç–∞</div>
<div class="nav-btn" onclick="showPage('profile')">üë§<br/>–ü—Ä–æ—Ñ–∏–ª—å</div>
</div>
<script>
/* ====== TELEGRAM ====== */
const tg = window.Telegram.WebApp;
tg.ready();

function getAuthHeaders(extraHeaders = {}) {
  const telegramId = tg.initDataUnsafe?.user?.id;
  const headers = { ...extraHeaders };
  if (telegramId) {
    headers['X-Telegram-Id'] = telegramId;
  }
  return headers;
}

function updateSafeAreaVars() {
  const inset = tg.safeAreaInset || tg.contentSafeAreaInset || {};
  const top = Number(inset.top) || 0;
  const bottom = Number(inset.bottom) || 0;
  document.documentElement.style.setProperty('--safe-top', `${top}px`);
  document.documentElement.style.setProperty('--safe-bottom', `${bottom}px`);
}

function initMobileViewport() {
  const platform = tg.platform;
  const isMobile = platform === 'android' || platform === 'ios';
  if (!isMobile) return;

  document.body.classList.add('tg-mobile');

  try {
    if (!tg.isExpanded) {
      tg.expand();
    }
  } catch (err) {
    // ignore expand errors
  }

  if (typeof tg.requestFullscreen === 'function') {
    setTimeout(() => {
      try {
        tg.requestFullscreen();
      } catch (err) {
        // ignore fullscreen errors
      }
    }, 200);
  }
}

initMobileViewport();
updateSafeAreaVars();
if (typeof tg.onEvent === 'function') {
  tg.onEvent('viewportChanged', updateSafeAreaVars);
}
tg.expand();

/* ====== –ù–ê–í–ò–ì–ê–¶–ò–Ø ====== */
const ROOT_PAGES = ['home', 'schedule', 'staff', 'profile'];
let currentPageId = 'home';

const header = document.getElementById('header');
const headerTitle = document.getElementById('header-title');
const headerBack = document.getElementById('header-back');
const hasTelegramBackButton = typeof tg.BackButton !== 'undefined';

if (hasTelegramBackButton && typeof tg.BackButton.onClick === 'function') {
  tg.BackButton.onClick(() => {
    goBack();
  });
}
const pageTitleCache = {
  home: 'LISSA DANCE',
  schedule: 'LISSA DANCE',
  staff: '–†–∞–±–æ—Ç–∞',
  profile: 'LISSA DANCE'
};

function setHeaderTitle(title) {
  if (!headerTitle) return;
  headerTitle.textContent = title;
  pageTitleCache[currentPageId] = title;
}

function setHeaderBackVisible(isVisible) {
  if (!headerBack) return;
  headerBack.style.visibility = isVisible ? 'visible' : 'hidden';
  headerBack.style.pointerEvents = isVisible ? 'auto' : 'none';
}

function syncTelegramBackButton(isVisible) {
  if (hasTelegramBackButton) {
    if (isVisible) {
      tg.BackButton.show();
    } else {
      tg.BackButton.hide();
    }
    if (headerBack) {
      headerBack.style.display = 'none';
    }
  } else if (headerBack) {
    headerBack.style.display = '';
  }
}

function applyHeaderForPage(pageId) {
  currentPageId = pageId;
  const isRoot = ROOT_PAGES.includes(pageId);
  setHeaderBackVisible(!isRoot);
  syncTelegramBackButton(!isRoot);

  const page = document.getElementById(pageId);
  if (!page) return;
  const dataTitle = page.getAttribute('data-title');
  if (dataTitle) {
    let brandEl = page.querySelector('.brand-header');
    if (!brandEl) {
      brandEl = document.createElement('div');
      brandEl.className = 'brand-header';
      brandEl.innerHTML = `
        <div class="brand-row">
          <div class="brand-avatar"></div>
          <div class="brand-name"></div>
        </div>
        <h2 class="page-title"></h2>
      `;
      page.insertBefore(brandEl, page.firstChild);
    }
    const brandNameEl = brandEl.querySelector('.brand-name');
    if (brandNameEl) {
      brandNameEl.textContent = dataTitle;
    }

    const titleEl = brandEl.querySelector('.page-title');
    if (titleEl) {
      titleEl.textContent = '';
      titleEl.style.display = 'none';
    }
    pageTitleCache[pageId] = dataTitle;
  }
}

// –°—Ç–µ–∫ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ (–∏—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ—Ö–æ–¥–æ–≤)
let navigationStack = ['home'];
applyHeaderForPage('home');

function showPage(id) {
  // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
  const currentPage = Array.from(document.querySelectorAll('.page')).find(p => p.classList.contains('active'));
  
  // –ï—Å–ª–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –¥—Ä—É–≥—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É, –¥–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é –≤ —Å—Ç–µ–∫
  if (currentPage && currentPage.id !== id) {
    navigationStack.push(id);
  }
  
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(id).classList.add('active');

  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  const index = ROOT_PAGES.indexOf(id);
  if (index >= 0) {
    document.querySelectorAll('.nav-btn')[index].classList.add('active');
  }

  applyHeaderForPage(id);
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ "–†–∞–±–æ—Ç—ã"
  if (id === 'staff') {
    loadAllClients();
  }
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ"
  if (id === 'schedule') {
    loadPublicSchedule();
  }
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
  if (id === 'staff-manage') {
    setHeaderTitle('üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–æ–º');
    loadStaffList();
  }
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (—Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è)
  if (id === 'staff-management') {
    setHeaderTitle('üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–æ–º');
    loadStaffList();
  }
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –Ω–æ–≤–æ—Å—Ç–µ–π –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
  if (id === 'news-manage') {
    setHeaderTitle('üì∞ –ù–æ–≤–æ—Å—Ç–∏');
    loadNewsManage();
  }
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º preview —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –¥–ª—è –Ω–æ–≤–æ—Å—Ç–µ–π
  if (id === 'news-add-form') {
    initNewsPhotoPreview();
  }
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
  if (id === 'directions-groups') {
    setHeaderTitle('üé≠ –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –≥—Ä—É–ø–ø—ã');
    loadDirections();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤–∫–ª–∞–¥–æ–∫
    setTimeout(() => {
      const activeTab = document.getElementById('active-tab');
      const indicator = document.querySelector('.tab-indicator');
      if (indicator && activeTab) {
        indicator.style.width = activeTab.offsetWidth + 'px';
        indicator.style.transform = `translateX(${activeTab.offsetLeft}px)`;
      }
    }, 0);
  }
}

function openInfo(title) {
  showPage('info');
  document.getElementById('info-title').innerText = title;
  setHeaderTitle(title);
}

function showSection(section) {
  // –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ä–∞–∑–¥–µ–ª–æ–≤
  switch(section) {
    case 'info-about':
      showPage('info-about');
      setHeaderTitle('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è');
      break;
    case 'info-teachers':
      showPage('info');
      document.getElementById('info-title').innerText = '–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–∏';
      setHeaderTitle('–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–∏');
      resetInfoPage();
      break;
    case 'info-directions':
      showPage('info');
      document.getElementById('info-title').innerText = '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è';
      setHeaderTitle('–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è');
      loadInfoDirections();
      break;
    case 'info-individual':
      showPage('info-individual');
      setHeaderTitle('–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –∑–∞–Ω—è—Ç–∏—è');
      break;
    case 'info-rent':
      showPage('info-rent');
      setHeaderTitle('–ê—Ä–µ–Ω–¥–∞ –∑–∞–ª–∞');
      break;
  }
}

function resetInfoPage() {
  const container = document.getElementById('info-directions-container');
  const placeholder = document.getElementById('info-placeholder');
  if (container) {
    container.style.display = 'none';
    container.innerHTML = '';
  }
  if (placeholder) {
    placeholder.style.display = 'block';
    placeholder.textContent = '–†–∞–∑–¥–µ–ª –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ';
  }
}

function loadInfoDirections() {
  const container = document.getElementById('info-directions-container');
  const placeholder = document.getElementById('info-placeholder');
  if (!container) return;
  container.style.display = 'block';
  if (placeholder) placeholder.style.display = 'none';

  container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 12px;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π...</p>';

  fetch('/api/directions')
    .then(async res => {
      if (!res.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è');
      return res.json();
    })
    .then(directions => {
      if (!directions || directions.length === 0) {
        container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 12px;">üì≠ –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π –Ω–µ—Ç</p>';
        return;
      }
      container.innerHTML = directions.map(d => {
        const imageHtml = d.image_path
          ? `<img src="${d.image_path}" style="width: 100%; height: 140px; object-fit: cover; border-radius: 10px; margin-bottom: 10px;">`
          : '';
        const price = d.base_price ? `üí∞ ${d.base_price} ‚ÇΩ` : '';
        const groupsCount = typeof d.groups_count === 'number' ? `üë• ${d.groups_count} –≥—Ä—É–ø–ø` : '';
        const metaLine = [price, groupsCount].filter(Boolean).join(' ‚Ä¢ ');
        return `
          <div class="card" style="cursor: pointer;" onclick="openDirectionDetail(${d.direction_id})">
            ${imageHtml}
            <div style="font-weight: 700; font-size: 16px; margin-bottom: 6px;">${d.title || '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'}</div>
            <div class="small" style="margin-bottom: 8px;">${d.description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}</div>
            ${metaLine ? `<div class="small">${metaLine}</div>` : ''}
          </div>
        `;
      }).join('');
    })
    .catch(err => {
      container.innerHTML = `<p class="small" style="text-align: center; color: #c62828; padding: 12px;">‚ùå ${err.message}</p>`;
    });
}

function openDirectionDetail(directionId) {
  if (!directionId) return;
  const content = document.getElementById('direction-detail-content');
  if (!content) return;

  content.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 12px;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</p>';
  showPage('direction-detail');

  Promise.all([
    fetch(`/api/directions/${directionId}`).then(res => res.ok ? res.json() : Promise.reject(new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'))),
    fetch(`/api/directions/${directionId}/groups`).then(res => res.ok ? res.json() : [])
  ])
    .then(([d, groups]) => {
      const price = d.base_price ? `üí∞ ${d.base_price} ‚ÇΩ` : '';
      const status = d.status === 'active' ? '‚úÖ –ê–∫—Ç–∏–≤–Ω–æ' : '‚è∏Ô∏è –ù–µ–∞–∫—Ç–∏–≤–Ω–æ';
      const photoBlock = d.image_path
        ? `<div class="direction-detail-photo"><img src="${d.image_path}" alt="–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ"></div>`
        : '';

      const groupsHtml = (groups && groups.length)
        ? groups.map(g => {
            const teacher = g.teacher_name ? `üë©‚Äçüè´ ${g.teacher_name}` : 'üë©‚Äçüè´ ‚Äî';
            const lessons = g.lessons_per_week ? `üìÜ ${g.lessons_per_week} –≤ –Ω–µ–¥–µ–ª—é` : 'üìÜ ‚Äî';
            return `
              <div class="card" style="margin-bottom: 8px;">
                <div style="font-weight: 700; font-size: 16px; margin-bottom: 6px;">${g.name || '–ì—Ä—É–ø–ø–∞'}</div>
                <div class="small" style="margin-bottom: 6px;">${teacher}</div>
                <div class="small" style="display: flex; gap: 8px; flex-wrap: wrap;">
                  <span>üéà ${g.age_group || '‚Äî'}</span>
                  <span>‚è±Ô∏è ${g.duration_minutes ? g.duration_minutes + ' –º–∏–Ω' : '‚Äî'}</span>
                  <span>${lessons}</span>
                  <span>üë• ${g.max_students || '‚Äî'} —É—á–µ–Ω–∏–∫–æ–≤</span>
                </div>
                <button class="save-btn" style="width: 100%; margin-top: 8px; background: #111;">–ó–∞–ø–∏—Å–∞—Ç—å—Å—è</button>
              </div>
            `;
          }).join('')
        : '<p class="small" style="text-align: center; color: var(--hint); padding: 10px;">üì≠ –ì—Ä—É–ø–ø –ø–æ–∫–∞ –Ω–µ—Ç</p>';

      content.innerHTML = `
        ${photoBlock}
        <div class="direction-detail-content">
          <div style="font-weight: 700; font-size: 20px; margin-bottom: 6px;">${d.title || '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'}</div>
          <div class="small" style="margin-bottom: 8px;">${[status, price].filter(Boolean).join(' ‚Ä¢ ')}</div>
          <div class="small" style="margin-bottom: 10px;">${d.description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}</div>
          <div style="font-weight: 700; font-size: 16px; margin: 12px 0 8px 0;">–ì—Ä—É–ø–ø—ã</div>
          ${groupsHtml}
        </div>
      `;
    })
    .catch(err => {
      content.innerHTML = `<p class="small" style="text-align: center; color: #c62828; padding: 12px;">‚ùå ${err.message}</p>`;
    });
}

/* ====== –ê–î–ú–ò–ù-–†–ê–°–ü–ò–°–ê–ù–ò–ï (–†–ê–ë–û–¢–ê) ====== */
let scheduleView = 'week';
let scheduleFocusDate = new Date();
let scheduleItems = [];
let scheduleInitialized = false;

const WORK_START_HOUR = 9;
const WORK_END_HOUR = 22;
const SLOT_MINUTES = 30;

function initScheduleControl() {
  if (!scheduleInitialized) {
    scheduleInitialized = true;
  }
  updateScheduleControlsUI();
  loadScheduleV2();
  initGroupScheduleForm();
}

function setScheduleView(view) {
  scheduleView = view;
  updateScheduleControlsUI();
  loadScheduleV2();
}

function shiftScheduleDate(delta) {
  const stepDays = scheduleView === 'week' ? 7 : 1;
  scheduleFocusDate = new Date(scheduleFocusDate.getTime() + delta * stepDays * 24 * 60 * 60 * 1000);
  updateScheduleControlsUI();
  loadScheduleV2();
}

function updateScheduleControlsUI() {
  const weekBtn = document.getElementById('schedule-view-week');
  const dayBtn = document.getElementById('schedule-view-day');
  if (weekBtn && dayBtn) {
    weekBtn.classList.toggle('active', scheduleView === 'week');
    dayBtn.classList.toggle('active', scheduleView === 'day');
  }

  const label = document.getElementById('schedule-date-label');
  if (label) {
    if (scheduleView === 'week') {
      const start = getWeekStart(scheduleFocusDate);
      const end = new Date(start.getTime() + 6 * 24 * 60 * 60 * 1000);
      label.textContent = `${formatDateShort(start)} - ${formatDateShort(end)}`;
    } else {
      label.textContent = formatDateLong(scheduleFocusDate);
    }
  }
}

function getWeekStart(date) {
  const d = new Date(date);
  const day = (d.getDay() + 6) % 7; // 0=Mon
  d.setDate(d.getDate() - day);
  d.setHours(0, 0, 0, 0);
  return d;
}

function formatDateShort(d) {
  return d.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
}

function formatDateLong(d) {
  return d.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long', year: 'numeric' });
}

function timeToMinutes(t) {
  const [h, m] = t.split(':').map(Number);
  return h * 60 + m;
}

function minutesToTime(min) {
  const h = Math.floor(min / 60);
  const m = min % 60;
  return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
}

function formatTimeLabel(timeStr) {
  const parts = timeStr.split(':');
  if (parts.length < 2) return '';
  const minutes = parseInt(parts[1], 10);
  return minutes === 0 ? timeStr : '';
}

function isHalfHour(timeStr) {
  const parts = timeStr.split(':');
  if (parts.length < 2) return false;
  const minutes = parseInt(parts[1], 10);
  return minutes === 30;
}

function loadScheduleV2() {
  const dateFrom = scheduleView === 'week' ? getWeekStart(scheduleFocusDate) : new Date(scheduleFocusDate);
  const dateTo = scheduleView === 'week'
    ? new Date(dateFrom.getTime() + 6 * 24 * 60 * 60 * 1000)
    : new Date(scheduleFocusDate);

  const params = new URLSearchParams({
    date_from: dateFrom.toISOString().slice(0, 10),
    date_to: dateTo.toISOString().slice(0, 10)
  });

  fetch(`/schedule/v2?${params.toString()}`, { headers: getAuthHeaders() })
    .then(async res => {
      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è');
      }
      return res.json();
    })
    .then(data => {
      scheduleItems = Array.isArray(data) ? data : [];
      renderScheduleGrid();
    })
    .catch(err => {
      console.error(err);
      const container = document.getElementById('schedule-grid-container');
      if (container) {
        container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è</p>';
      }
    });
}

function renderScheduleGrid() {
  const container = document.getElementById('schedule-grid-container');
  if (!container) return;

  const slots = [];
  for (let t = WORK_START_HOUR * 60; t < WORK_END_HOUR * 60; t += SLOT_MINUTES) {
    slots.push(minutesToTime(t));
  }

  if (scheduleView === 'day') {
    const dateStr = scheduleFocusDate.toISOString().slice(0, 10);
    let html = `<div class="schedule-grid day">`;
    html += `<div class="schedule-cell head">–í—Ä–µ–º—è</div><div class="schedule-cell head">${formatDateShort(scheduleFocusDate)}</div>`;
    for (const time of slots) {
      const timeClass = isHalfHour(time) ? 'schedule-cell time half' : 'schedule-cell time';
      html += `<div class="${timeClass}">${formatTimeLabel(time)}</div>`;
      const busyInfo = getSlotInfo(dateStr, time);
      html += renderSlotCell(dateStr, time, busyInfo);
    }
    html += `</div>`;
    container.innerHTML = html;
  } else {
    const weekStart = getWeekStart(scheduleFocusDate);
    const days = [];
    for (let i = 0; i < 7; i++) {
      const d = new Date(weekStart.getTime() + i * 24 * 60 * 60 * 1000);
      days.push(d);
    }

    let html = `<div class="schedule-grid">`;
    html += `<div class="schedule-cell head">–í—Ä–µ–º—è</div>`;
    for (const d of days) {
      html += `<div class="schedule-cell head">${d.toLocaleDateString('ru-RU', { weekday: 'short', day: '2-digit' })}</div>`;
    }
    for (const time of slots) {
      const timeClass = isHalfHour(time) ? 'schedule-cell time half' : 'schedule-cell time';
      html += `<div class="${timeClass}">${formatTimeLabel(time)}</div>`;
      for (const d of days) {
        const dateStr = d.toISOString().slice(0, 10);
        const busyInfo = getSlotInfo(dateStr, time);
        html += renderSlotCell(dateStr, time, busyInfo);
      }
    }
    html += `</div>`;
    container.innerHTML = html;
  }
}

function getSlotInfo(dateStr, timeStr) {
  const slotStart = timeToMinutes(timeStr);
  const slotEnd = slotStart + SLOT_MINUTES;
  const item = scheduleItems.find(s => {
    if (s.date !== dateStr) return false;
    if (!s.time_from || !s.time_to) return false;
    const start = timeToMinutes(s.time_from);
    const end = timeToMinutes(s.time_to);
    return slotStart < end && slotEnd > start && s.status !== 'cancelled';
  });
  return item || null;
}

function renderSlotCell(dateStr, timeStr, item) {
  if (item) {
    const info = getSlotRenderInfo(item, timeStr);
    const labelHtml = info.showLabel ? `<div class="schedule-event">${getScheduleLabel(item)}</div>` : '';
    const color = getScheduleColor(item);
    return `<div class="schedule-cell schedule-slot busy ${item.object_type}" style="background: ${color};" onclick="openScheduleDetailById(${item.id})">${labelHtml}</div>`;
  }
  return `<div class="schedule-cell schedule-slot" onclick="openScheduleForm('${dateStr}', '${timeStr}')"></div>`;
}

function getScheduleLabel(item) {
  const typeMap = {
    group: '–ì—Ä—É–ø–ø–∞',
    individual: '–ò–Ω–¥–∏–≤.',
    rental: '–ê—Ä–µ–Ω–¥–∞'
  };
  return `${typeMap[item.object_type] || '–°–æ–±—ã—Ç–∏–µ'} #${item.object_id}`;
}

function getSlotRenderInfo(item, timeStr) {
  if (!item.time_from || !item.time_to) return { showLabel: true };
  const start = timeToMinutes(item.time_from);
  const end = timeToMinutes(item.time_to);
  const slotStart = timeToMinutes(timeStr);
  const totalSlots = Math.max(1, Math.ceil((end - start) / SLOT_MINUTES));
  const slotIndex = Math.floor((slotStart - start) / SLOT_MINUTES);
  const midIndex = Math.floor((totalSlots - 1) / 2);
  return { showLabel: slotIndex === midIndex };
}

function getScheduleColor(item) {
  const baseOffset = {
    group: 210,
    individual: 120,
    rental: 290
  }[item.object_type] || 0;
  const key = `${item.object_type}-${item.object_id || ''}`;
  const hue = (hashString(key) + baseOffset) % 360;
  return `hsla(${hue}, 70%, 85%, 0.8)`;
}

function hashString(str) {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    hash = ((hash << 5) - hash) + str.charCodeAt(i);
    hash |= 0;
  }
  return Math.abs(hash);
}

function openScheduleDetailById(id) {
  const item = scheduleItems.find(s => s.id === id);
  if (!item) return;
  openScheduleDetail(item);
}

function openScheduleDetail(item) {
  const card = document.getElementById('schedule-detail-modal');
  const overlay = document.getElementById('schedule-detail-overlay');
  const content = document.getElementById('schedule-detail-content');
  if (!card || !content || !overlay) return;

  const typeMap = {
    group: '–ì—Ä—É–ø–ø–æ–≤–æ–µ –∑–∞–Ω—è—Ç–∏–µ',
    individual: '–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–µ –∑–∞–Ω—è—Ç–∏–µ',
    rental: '–ê—Ä–µ–Ω–¥–∞'
  };

  const dateText = item.date ? new Date(item.date).toLocaleDateString('ru-RU') : '‚Äî';
  const timeText = item.time_from && item.time_to ? `${item.time_from} - ${item.time_to}` : '‚Äî';

  content.innerHTML = `
    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
      <div class="schedule-detail-chip">üìå ${typeMap[item.object_type] || '–°–æ–±—ã—Ç–∏–µ'}</div>
      <div class="schedule-detail-chip">üìÖ ${dateText}</div>
      <div class="schedule-detail-chip">‚è∞ ${timeText}</div>
    </div>
    <div class="schedule-detail-card" id="schedule-detail-extra"></div>
  `;

  card.classList.add('show');
  overlay.classList.add('show');

  if (item.object_type === 'group') {
    loadGroupScheduleDetails(item.object_id);
  } else {
    const extra = document.getElementById('schedule-detail-extra');
    if (extra) extra.innerHTML = '<div class="small">–ù–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</div>';
  }
}

function closeScheduleDetail() {
  const card = document.getElementById('schedule-detail-modal');
  const overlay = document.getElementById('schedule-detail-overlay');
  if (card) card.classList.remove('show');
  if (overlay) overlay.classList.remove('show');
}

function loadGroupScheduleDetails(groupId) {
  const extra = document.getElementById('schedule-detail-extra');
  if (!extra) return;
  extra.innerHTML = '<div class="small">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–µ—Ç–∞–ª–µ–π –≥—Ä—É–ø–ø—ã...</div>';

  fetch(`/api/groups/${groupId}`, { headers: getAuthHeaders() })
    .then(async res => {
      if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä—É–ø–ø—ã');
      return res.json();
    })
    .then(async group => {
      let directionTitle = '‚Äî';
      let directionPrice = null;
      let teacherName = '‚Äî';

      if (group.direction_id) {
        try {
          const dirRes = await fetch(`/api/directions/${group.direction_id}`, { headers: getAuthHeaders() });
          if (dirRes.ok) {
            const dir = await dirRes.json();
            directionTitle = dir.title || directionTitle;
            directionPrice = dir.base_price || directionPrice;
          }
        } catch (err) {
          // ignore
        }
      }

      if (group.teacher_id) {
        try {
          const staffRes = await fetch(`/staff/${group.teacher_id}`, { headers: getAuthHeaders() });
          if (staffRes.ok) {
            const staff = await staffRes.json();
            teacherName = staff.name || teacherName;
          }
        } catch (err) {
          // ignore
        }
      }

      extra.innerHTML = `
        <div class="schedule-detail-row">üë• <strong>–ì—Ä—É–ø–ø–∞:</strong> ${group.name || '‚Äî'}</div>
        <div class="schedule-detail-row">üéØ <strong>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</strong> ${directionTitle}</div>
        <div class="schedule-detail-row">üë©‚Äçüè´ <strong>–£—á–∏—Ç–µ–ª—å:</strong> ${teacherName}</div>
        <div class="schedule-detail-row">üéà <strong>–í–æ–∑—Ä–∞—Å—Ç:</strong> ${group.age_group || '‚Äî'}</div>
        ${group.lessons_per_week ? `<div class="schedule-detail-row">üìÜ <strong>–ó–∞–Ω—è—Ç–∏–π –≤ –Ω–µ–¥–µ–ª—é:</strong> ${group.lessons_per_week}</div>` : ''}
        <div class="schedule-detail-row">üí∞ <strong>–¶–µ–Ω–∞:</strong> ${directionPrice ? directionPrice + ' ‚ÇΩ' : '‚Äî'}</div>
      `;
    })
    .catch(() => {
      extra.innerHTML = '<div class="small">‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –≥—Ä—É–ø–ø—ã</div>';
    });
}

function openScheduleForm(dateStr, timeStr) {
  const form = document.getElementById('schedule-admin-form');
  if (!form) return;
  form.classList.add('show');

  const dateInput = document.getElementById('schedule-date');
  const timeFromInput = document.getElementById('schedule-time-from');
  const timeToInput = document.getElementById('schedule-time-to');

  if (dateInput) dateInput.value = dateStr;
  if (timeFromInput) timeFromInput.value = timeStr;
  const end = minutesToTime(timeToMinutes(timeStr) + SLOT_MINUTES);
  if (timeToInput) timeToInput.value = end;
}

function closeScheduleForm() {
  const form = document.getElementById('schedule-admin-form');
  if (form) form.classList.remove('show');
}

function createScheduleV2() {
  const objectType = document.getElementById('schedule-object-type').value;
  const objectId = document.getElementById('schedule-object-id').value;
  const dateStr = document.getElementById('schedule-date').value;
  const timeFrom = document.getElementById('schedule-time-from').value;
  const timeTo = document.getElementById('schedule-time-to').value;
  const repeatUntil = document.getElementById('schedule-repeat-until').value;

  if (!objectId || !dateStr || !timeFrom || !timeTo) {
    showNotification('‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
    return;
  }

  if (hasScheduleConflict(dateStr, timeFrom, timeTo)) {
    showNotification('‚ùå –í —ç—Ç–æ –≤—Ä–µ–º—è —É–∂–µ –µ—Å—Ç—å –∑–∞–Ω—è—Ç–∏–µ');
    return;
  }

  const payload = {
    object_type: objectType,
    object_id: parseInt(objectId, 10),
    date: dateStr,
    time_from: timeFrom,
    time_to: timeTo,
    repeat_weekly_until: repeatUntil || null
  };

  fetch('/schedule/v2', {
    method: 'POST',
    headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
    body: JSON.stringify(payload)
  })
    .then(async res => {
      const data = await res.json();
      if (!res.ok) {
        throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏');
      }
      showNotification('‚úÖ –ó–∞–Ω—è—Ç–∏–µ —Å–æ–∑–¥–∞–Ω–æ');
      closeScheduleForm();
      loadScheduleV2();
    })
    .catch(err => {
      console.error(err);
      showNotification('‚ùå ' + err.message);
    });
}

function hasScheduleConflict(dateStr, timeFrom, timeTo) {
  const start = timeToMinutes(timeFrom);
  const end = timeToMinutes(timeTo);
  return scheduleItems.some(s => {
    if (s.date !== dateStr) return false;
    if (!s.time_from || !s.time_to) return false;
    const sStart = timeToMinutes(s.time_from);
    const sEnd = timeToMinutes(s.time_to);
    return start < sEnd && end > sStart && s.status !== 'cancelled';
  });
}

function initGroupScheduleForm() {
  const select = document.getElementById('group-schedule-group');
  if (!select || select.dataset.loaded === '1') return;

  select.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä—É–ø–ø...</option>';
  fetch('/api/directions/manage', { headers: getAuthHeaders() })
    .then(async res => {
      if (!res.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è');
      return res.json();
    })
    .then(async directions => {
      const groups = [];
      for (const d of directions) {
        try {
          const res = await fetch(`/api/directions/${d.direction_id}/groups`, { headers: getAuthHeaders() });
          if (!res.ok) continue;
          const g = await res.json();
          g.forEach(gr => groups.push(gr));
        } catch (err) {
          // ignore
        }
      }
      if (groups.length === 0) {
        select.innerHTML = '<option value="">–ì—Ä—É–ø–ø—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</option>';
        return;
      }
      select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É</option>' + groups.map(gr => `<option value="${gr.id}">${gr.name}</option>`).join('');
      select.dataset.loaded = '1';
    })
    .catch(() => {
      select.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä—É–ø–ø</option>';
    });

  select.addEventListener('change', () => {
    updateGroupFormDefaults();
  });

  const dateInput = document.getElementById('group-schedule-date');
  if (dateInput) {
    dateInput.addEventListener('change', () => {
      updateGroupFormDefaults();
      updateRepeatSummary();
    });
  }

  const weekdayRow = document.getElementById('repeat-weekdays-row');
  if (weekdayRow) {
    weekdayRow.addEventListener('click', e => {
      const target = e.target;
      if (target.classList.contains('chip')) {
        target.classList.toggle('active');
        updateRepeatSummary();
      }
    });
  }

  const repeatMode = document.getElementById('repeat-mode');
  const repeatUntil = document.getElementById('repeat-until');
  const repeatInterval = document.getElementById('repeat-interval');
  if (repeatMode) repeatMode.addEventListener('change', updateRepeatSummary);
  if (repeatInterval) repeatInterval.addEventListener('input', updateRepeatSummary);
  if (repeatUntil) repeatUntil.addEventListener('change', updateRepeatSummary);
  updateRepeatSummary();
  updateGroupFormDefaults();
}

function toggleGroupScheduleForm(force) {
  const modal = document.getElementById('group-schedule-modal');
  const overlay = document.getElementById('group-schedule-overlay');
  if (!modal || !overlay) return;
  const shouldShow = typeof force === 'boolean' ? force : !modal.classList.contains('show');
  if (shouldShow) {
    resetGroupScheduleForm();
    modal.classList.add('show');
    overlay.classList.add('show');
  } else {
    modal.classList.remove('show');
    overlay.classList.remove('show');
  }
}

function updateRepeatSummary() {
  const mode = document.getElementById('repeat-mode')?.value || 'none';
  const interval = parseInt(document.getElementById('repeat-interval')?.value || '1', 10);
  const untilInput = document.getElementById('repeat-until');
  const until = untilInput?.value;
  const dateBase = document.getElementById('group-schedule-date')?.value;
  const summary = document.getElementById('repeat-summary');
  const weekdays = getSelectedWeekdays();

  if (!summary) return;
  if (mode === 'none') {
    summary.textContent = '–ë–µ–∑ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è';
    toggleRepeatControls();
    return;
  }

  let text = '–ü–æ–≤—Ç–æ—Ä—è—Ç—å ';
  if (mode === 'weekly') {
    text += `–∫–∞–∂–¥—É—é ${interval} –Ω–µ–¥–µ–ª—é`;
    if (weekdays.length) {
      text += ` (${weekdays.map(d => WEEKDAY_LABELS[d]).join(', ')})`;
    }
  } else if (mode === 'daily') {
    text += `–∫–∞–∂–¥—ã–µ ${interval} –¥–µ–Ω—å`;
  } else if (mode === 'monthly') {
    text += `–∫–∞–∂–¥—ã–π ${interval} –º–µ—Å—è—Ü`;
  }
  const baseDate = dateBase ? new Date(dateBase) : new Date();
  const finalUntil = until || addMonths(baseDate, 6).toISOString().slice(0, 10);
  text += ` –¥–æ ${new Date(finalUntil).toLocaleDateString('ru-RU')}`;
  summary.textContent = text;
  toggleRepeatControls();
}

function toggleRepeatControls() {
  const mode = document.getElementById('repeat-mode')?.value || 'none';
  const intervalRow = document.getElementById('repeat-interval-row');
  const weekRow = document.getElementById('repeat-weekdays-row');
  const untilRow = document.getElementById('repeat-until')?.parentElement;
  const label = document.getElementById('repeat-interval-label');
  if (intervalRow) intervalRow.style.display = mode === 'none' ? 'none' : 'flex';
  if (weekRow) weekRow.style.display = mode === 'weekly' ? 'flex' : 'none';
  if (untilRow) untilRow.style.display = mode === 'none' ? 'none' : 'flex';
  if (label) {
    label.textContent = mode === 'daily' ? '–¥–µ–Ω—å' : mode === 'monthly' ? '–º–µ—Å—è—Ü' : '–Ω–µ–¥–µ–ª—é';
  }
}

const WEEKDAY_LABELS = {
  0: '–í—Å',
  1: '–ü–Ω',
  2: '–í—Ç',
  3: '–°—Ä',
  4: '–ß—Ç',
  5: '–ü—Ç',
  6: '–°–±'
};

function getSelectedWeekdays() {
  const chips = document.querySelectorAll('#repeat-weekdays-row .chip.active');
  return Array.from(chips).map(c => parseInt(c.dataset.day, 10));
}

function getWeekRangeForDate(dateStr) {
  const date = new Date(dateStr);
  if (Number.isNaN(date.getTime())) return null;
  const start = getWeekStart(date);
  const end = new Date(start.getTime() + 6 * 24 * 60 * 60 * 1000);
  return {
    dateFrom: start.toISOString().slice(0, 10),
    dateTo: end.toISOString().slice(0, 10)
  };
}

function getGroupWeekCount(groupId, dateStr) {
  const range = getWeekRangeForDate(dateStr);
  if (!range) return Promise.resolve(null);
  const params = new URLSearchParams({
    date_from: range.dateFrom,
    date_to: range.dateTo
  });
  return fetch(`/schedule/v2?${params.toString()}`, { headers: getAuthHeaders() })
    .then(res => res.ok ? res.json() : [])
    .then(items => {
      if (!Array.isArray(items)) return 0;
      return items.filter(s => s.object_type === 'group' && s.object_id === parseInt(groupId, 10) && s.status !== 'cancelled').length;
    })
    .catch(() => null);
}

function createGroupSchedule() {
  const groupId = document.getElementById('group-schedule-group')?.value;
  const dateStr = document.getElementById('group-schedule-date')?.value;
  const timeFrom = document.getElementById('group-schedule-time-from')?.value;
  const timeTo = document.getElementById('group-schedule-time-to')?.value;
  const mode = document.getElementById('repeat-mode')?.value || 'none';
  const interval = parseInt(document.getElementById('repeat-interval')?.value || '1', 10);
  const untilStrInput = document.getElementById('repeat-until')?.value;
  const untilStr = untilStrInput || addMonths(new Date(dateStr), 6).toISOString().slice(0, 10);

  if (!groupId || !dateStr || !timeFrom || !timeTo) {
    showNotification('‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
    return;
  }

  if (hasScheduleConflict(dateStr, timeFrom, timeTo)) {
    showNotification('‚ùå –í —ç—Ç–æ –≤—Ä–µ–º—è —É–∂–µ –µ—Å—Ç—å –∑–∞–Ω—è—Ç–∏–µ');
    return;
  }

  const dates = buildRepeatDates(dateStr, mode, interval, untilStr);
  if (!dates.length) {
    showNotification('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –¥–∞—Ç—ã');
    return;
  }

  const dateFrom = dates[0];
  const dateTo = dates[dates.length - 1];

  const params = new URLSearchParams({
    date_from: dateFrom,
    date_to: dateTo
  });

  fetch(`/schedule/v2?${params.toString()}`, { headers: getAuthHeaders() })
    .then(async res => {
      if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤');
      return res.json();
    })
    .then(data => {
      scheduleItems = Array.isArray(data) ? data : [];
      const conflict = dates.some(d => hasScheduleConflict(d, timeFrom, timeTo));
      if (conflict) {
        showNotification('‚ùå –í –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –¥–∞—Ç—ã —É–∂–µ –µ—Å—Ç—å –∑–∞–Ω—è—Ç–∏—è');
        return;
      }
      createGroupScheduleEntries(groupId, dates, timeFrom, timeTo);
    })
    .catch(err => {
      console.error(err);
      showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤');
    });
}

function updateGroupFormDefaults() {
  const groupId = document.getElementById('group-schedule-group')?.value;
  const dateStr = document.getElementById('group-schedule-date')?.value;
  const preview = document.getElementById('group-schedule-preview');
  if (!groupId) {
    if (preview) {
      preview.style.display = 'none';
      preview.innerHTML = '';
    }
    return;
  }
  fetch(`/api/groups/${groupId}`, { headers: getAuthHeaders() })
    .then(async res => {
      if (!res.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≥—Ä—É–ø–ø—É');
      return res.json();
    })
    .then(group => {
      const timeFromInput = document.getElementById('group-schedule-time-from');
      const timeToInput = document.getElementById('group-schedule-time-to');
      if (timeFromInput && timeToInput && (!timeFromInput.value || !timeToInput.value)) {
        const base = group.duration_minutes || 60;
        const from = timeFromInput.value || '09:00';
        const endMinutes = timeToMinutes(from) + base;
        timeFromInput.value = from;
        timeToInput.value = minutesToTime(endMinutes);
      }

      if (preview) {
        preview.style.display = 'grid';
        const lessonsRow = group.lessons_per_week
          ? `<div class="schedule-detail-row">üìÜ <strong>–ó–∞–Ω—è—Ç–∏–π –≤ –Ω–µ–¥–µ–ª—é:</strong> ${group.lessons_per_week}${dateStr ? ' (–≤ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ: <span id="group-week-count">‚Ä¶</span>)' : ''}</div>`
          : '';
        preview.innerHTML = `
          <div class="schedule-detail-row">üë• <strong>–ì—Ä—É–ø–ø–∞:</strong> ${group.name || '‚Äî'}</div>
          <div class="schedule-detail-row">üéà <strong>–í–æ–∑—Ä–∞—Å—Ç:</strong> ${group.age_group || '‚Äî'}</div>
          ${lessonsRow}
          <div class="schedule-detail-row">‚è±Ô∏è <strong>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</strong> ${group.duration_minutes ? group.duration_minutes + ' –º–∏–Ω' : '‚Äî'}</div>
        `;
        if (group.teacher_name) {
          preview.innerHTML += `<div class="schedule-detail-row">üë©‚Äçüè´ <strong>–£—á–∏—Ç–µ–ª—å:</strong> ${group.teacher_name}</div>`;
        }
        preview.innerHTML += `<div class="schedule-detail-row">üéØ <strong>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</strong> ‚Äî</div>`;
        preview.innerHTML += `<div class="schedule-detail-row">üí∞ <strong>–¶–µ–Ω–∞:</strong> ‚Äî</div>`;
      }

      if (group.lessons_per_week && dateStr) {
        getGroupWeekCount(groupId, dateStr).then(count => {
          const countEl = document.getElementById('group-week-count');
          if (countEl) countEl.textContent = count === null ? '‚Äî' : String(count);
        });
      }

      if (group.direction_id && preview) {
        fetch(`/api/directions/${group.direction_id}`, { headers: getAuthHeaders() })
          .then(async res => {
            if (!res.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ');
            return res.json();
          })
          .then(direction => {
            const rows = preview.querySelectorAll('.schedule-detail-row');
            if (rows.length >= 2) {
              rows[rows.length - 2].innerHTML = `üéØ <strong>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</strong> ${direction.title || '‚Äî'}`;
              rows[rows.length - 1].innerHTML = `üí∞ <strong>–¶–µ–Ω–∞:</strong> ${direction.base_price ? direction.base_price + ' ‚ÇΩ' : '‚Äî'}`;
            }
          })
          .catch(() => {});
      }
    })
    .catch(() => {
      // ignore
    });
}

function resetGroupScheduleForm() {
  const groupSelect = document.getElementById('group-schedule-group');
  const dateInput = document.getElementById('group-schedule-date');
  const timeFromInput = document.getElementById('group-schedule-time-from');
  const timeToInput = document.getElementById('group-schedule-time-to');
  const repeatUntil = document.getElementById('repeat-until');
  const repeatInterval = document.getElementById('repeat-interval');
  const repeatMode = document.getElementById('repeat-mode');

  if (groupSelect) groupSelect.value = '';
  if (dateInput) dateInput.value = '';
  if (timeFromInput) timeFromInput.value = '';
  if (timeToInput) timeToInput.value = '';
  if (repeatInterval) repeatInterval.value = '1';
  if (repeatMode) repeatMode.value = 'weekly';
  if (repeatUntil) repeatUntil.value = '';

  const chips = document.querySelectorAll('#repeat-weekdays-row .chip');
  chips.forEach(c => c.classList.remove('active'));

  updateRepeatSummary();
}

function createGroupScheduleEntries(groupId, dates, timeFrom, timeTo) {
  const headers = getAuthHeaders({ 'Content-Type': 'application/json' });
  const requests = dates.map(d => () => fetch('/schedule/v2', {
    method: 'POST',
    headers,
    body: JSON.stringify({
      object_type: 'group',
      object_id: parseInt(groupId, 10),
      date: d,
      time_from: timeFrom,
      time_to: timeTo
    })
  }));

  let chain = Promise.resolve();
  requests.forEach(req => {
    chain = chain.then(() => req());
  });

  chain
    .then(() => {
      showNotification('‚úÖ –ó–∞–Ω—è—Ç–∏—è —Å–æ–∑–¥–∞–Ω—ã');
      toggleGroupScheduleForm(false);
      loadScheduleV2();
    })
    .catch(err => {
      console.error(err);
      showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è');
    });
}

function buildRepeatDates(startDateStr, mode, interval, untilStr) {
  const start = new Date(startDateStr);
  if (Number.isNaN(start.getTime())) return [];
  const until = untilStr ? new Date(untilStr) : addMonths(start, 6);
  if (untilStr && Number.isNaN(until.getTime())) return [];

  const dates = [];
  if (mode === 'none') {
    dates.push(startDateStr);
    return dates;
  }

  if (!until) {
    dates.push(startDateStr);
    return dates;
  }

  if (mode === 'daily') {
    let current = new Date(start);
    while (current <= until) {
      dates.push(current.toISOString().slice(0, 10));
      current.setDate(current.getDate() + interval);
    }
    return dates;
  }

  if (mode === 'monthly') {
    let current = new Date(start);
    while (current <= until) {
      dates.push(current.toISOString().slice(0, 10));
      current.setMonth(current.getMonth() + interval);
    }
    return dates;
  }

  const weekdays = getSelectedWeekdays();
  const targetWeekdays = weekdays.length ? weekdays : [start.getDay()];
  let current = new Date(start);
  while (current <= until) {
    const weekStart = new Date(current);
    const day = weekStart.getDay();
    weekStart.setDate(weekStart.getDate() - day);
    for (let i = 0; i < 7; i++) {
      const d = new Date(weekStart);
      d.setDate(weekStart.getDate() + i);
      if (d < start || d > until) continue;
      if (targetWeekdays.includes(d.getDay())) {
        dates.push(d.toISOString().slice(0, 10));
      }
    }
    current.setDate(current.getDate() + interval * 7);
  }
  return Array.from(new Set(dates)).sort();
}

function addMonths(date, count) {
  const d = new Date(date);
  d.setMonth(d.getMonth() + count);
  return d;
}

function goHome() {
  showPage('home');
}

function goBack() {
  // –ï—Å–ª–∏ –≤ —Å—Ç–µ–∫–µ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞, –±–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é
  if (navigationStack.length > 1) {
    navigationStack.pop(); // –£–¥–∞–ª—è–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–∑ —Å—Ç–µ–∫–∞
    const previousPageId = navigationStack[navigationStack.length - 1];
    
    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –±–µ–∑ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ —Å—Ç–µ–∫
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(previousPageId).classList.add('active');
    
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    const index = ROOT_PAGES.indexOf(previousPageId);
    if (index >= 0) document.querySelectorAll('.nav-btn')[index].classList.add('active');
    
    applyHeaderForPage(previousPageId);
  } else {
    // –ï—Å–ª–∏ —Å—Ç–µ–∫ –ø—É—Å—Ç, –∏–¥–µ–º –¥–æ–º–æ–π
    showPage('home');
  }
}

/* ====== –£–ü–†–ê–í–õ–ï–ù–ò–ï –†–ê–°–ü–ò–°–ê–ù–ò–ï–ú –ü–ï–†–°–û–ù–ê–õ–ê ====== */
let currentStaffPosition = '';
const STAFF_CACHE_KEY = 'staff_status_cache_v1';

function getCachedStaffStatus() {
  try {
    const raw = localStorage.getItem(STAFF_CACHE_KEY);
    if (!raw) return null;
    const parsed = JSON.parse(raw);
    if (typeof parsed !== 'object' || parsed === null) return null;
    if (typeof parsed.isStaff !== 'boolean') return null;
    return parsed;
  } catch (err) {
    return null;
  }
}

function setCachedStaffStatus(isStaffValue, positionValue) {
  try {
    const payload = {
      isStaff: Boolean(isStaffValue),
      position: positionValue || '',
      updatedAt: Date.now()
    };
    localStorage.setItem(STAFF_CACHE_KEY, JSON.stringify(payload));
  } catch (err) {
    // ignore cache write errors
  }
}
let currentScheduleId = null;



async function loadStaffList() {
  try {
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    const currentPage = Array.from(document.querySelectorAll('.page')).find(p => p.classList.contains('active'));
    const containerId = (currentPage && currentPage.id === 'staff-manage') 
      ? 'staff-manage-container' 
      : 'staff-list-container';
    
    const container = document.getElementById(containerId);
    if (!container) return;
    
    container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</p>';
    
    const response = await fetch('/staff/list/all');
    
    if (!response.ok) {
      container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ</p>';
      return;
    }
    
    const staffList = await response.json();
    window.allStaffList = staffList; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –ø–æ–∏—Å–∫–∞
    
    if (staffList.length === 0) {
      container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">üì≠ –ü–µ—Ä—Å–æ–Ω–∞–ª –Ω–µ –Ω–∞–π–¥–µ–Ω</p>';
      return;
    }
    
    displayStaffList(staffList);
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞:', error);
    const currentPage = Array.from(document.querySelectorAll('.page')).find(p => p.classList.contains('active'));
    const containerId = (currentPage && currentPage.id === 'staff-manage') 
      ? 'staff-manage-container' 
      : 'staff-list-container';
    const container = document.getElementById(containerId);
    if (container) {
      container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏</p>';
    }
  }
}

function displayStaffList(staffList) {
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  const currentPage = Array.from(document.querySelectorAll('.page')).find(p => p.classList.contains('active'));
  const containerId = (currentPage && currentPage.id === 'staff-manage') 
    ? 'staff-manage-container' 
    : 'staff-list-container';
  
  const container = document.getElementById(containerId);
  if (!container) return;
  
  container.innerHTML = staffList.map(s => `
    <div class="card" onclick="openStaffDetail(${s.id}, '${s.name}', '${s.position}', '${s.phone ? s.phone : ''}', '${s.email}', '${s.specialization || ''}', '${s.bio || ''}', '${s.status}')" style="cursor: pointer;">
      <div style="font-weight: 600; font-size: 16px;">${s.name}</div>
      ${s.username ? `<div style="font-size: 13px; color: var(--accent); margin-top: 2px;">@${s.username}</div>` : ''}
      <div style="font-size: 14px; color: var(--hint); margin-top: 4px;">üìç ${s.position}</div>
      ${s.phone ? `<div style="font-size: 13px; color: var(--hint); margin-top: 2px;">üì± ${s.phone}</div>` : ''}
      <div style="font-size: 12px; color: ${s.status === 'active' ? '#4caf50' : '#ff6b6b'}; margin-top: 6px;">‚óè ${s.status === 'active' ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}</div>
    </div>
  `).join('');
}

function searchStaffManage() {
  const searchInput = document.getElementById('staff-manage-search');
  const search = searchInput.value.trim().toLowerCase();
  
  if (!window.allStaffList) {
    return;
  }
  
  if (search.length === 0) {
    displayStaffList(window.allStaffList);
    return;
  }
  
  let filtered = [];
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏—â–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ —é–∑–µ—Ä–Ω–µ–π–º—É (—Å @)
  if (search.startsWith('@')) {
    // –ü–æ–∏—Å–∫ –ø–æ —é–∑–µ—Ä–Ω–µ–π–º—É
    const usernameQuery = search.substring(1).toLowerCase();
    filtered = window.allStaffList.filter(s => 
      s.username && s.username.toLowerCase().includes(usernameQuery)
    );
  } else {
    // –ü–æ–∏—Å–∫ –ø–æ ID –∏–ª–∏ –∏–º–µ–Ω–∏
    filtered = window.allStaffList.filter(s => 
      s.name.toLowerCase().includes(search) ||
      s.id.toString().includes(search) ||
      (s.telegram_id && s.telegram_id.toString().includes(search))
    );
  }
  
  if (filtered.length === 0) {
    document.getElementById('staff-manage-container').innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">‚ùå –ü–µ—Ä—Å–æ–Ω–∞–ª –Ω–µ –Ω–∞–π–¥–µ–Ω</p>';
  } else {
    displayStaffList(filtered);
  }
}

// –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Ç–µ–∫—É—â–µ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞
window.selectedStaffUserData = null;
window.currentStaffTelegramIds = []; // –°–ø–∏—Å–æ–∫ telegram_id —Ç–µ–∫—É—â–µ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞

function showAddStaffForm() {
  // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞ –∏ —Ñ–æ—Ä–º—É
  document.getElementById('staff-user-search').value = '';
  document.getElementById('staff-add-position').value = '';
  document.getElementById('staff-add-specialization').value = '';
  document.getElementById('staff-add-bio').value = '';
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–∏–π –ø–µ—Ä—Å–æ–Ω–∞–ª –∏ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ñ–æ—Ä–º—ã
  loadCurrentStaffAndUsers();
  
  showPage('staff-add-form');
  setHeaderTitle('‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª');
}

async function loadCurrentStaffAndUsers() {
  try {
    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –ø–µ—Ä—Å–æ–Ω–∞–ª
    const staffResponse = await fetch('/staff/list/all');
    if (staffResponse.ok) {
      const staffList = await staffResponse.json();
      window.currentStaffTelegramIds = staffList.map(s => s.telegram_id);
    }
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    const response = await fetch('/staff/search');
    if (!response.ok) return;
    
    const users = await response.json();
    // –§–∏–ª—å—Ç—Ä—É–µ–º - –∏—Å–∫–ª—é—á–∞–µ–º —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π –ø–µ—Ä—Å–æ–Ω–∞–ª
    const filteredUsers = users.filter(u => !window.currentStaffTelegramIds.includes(u.telegram_id));
    displaySearchResults(filteredUsers);
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
  }
}

async function loadAllStaffUsers() {
  try {
    const response = await fetch('/staff/search');
    if (!response.ok) return;
    
    const users = await response.json();
    // –§–∏–ª—å—Ç—Ä—É–µ–º - –∏—Å–∫–ª—é—á–∞–µ–º —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π –ø–µ—Ä—Å–æ–Ω–∞–ª
    const filteredUsers = users.filter(u => !window.currentStaffTelegramIds.includes(u.telegram_id));
    displaySearchResults(filteredUsers);
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
  }
}

async function searchForStaffUser() {
  let search = document.getElementById('staff-user-search').value.trim().toLowerCase();
  
  try {
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –ø–æ–∏—Å–∫–∞
    const searchByUsername = search.startsWith('@');
    
    // –£–¥–∞–ª—è–µ–º @ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    const cleanSearch = search.replace(/^@/, '');
    
    console.log('–ü–æ–∏—Å–∫:', {search, searchByUsername, cleanSearch});
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞
    const params = new URLSearchParams();
    if (cleanSearch) {
      params.append('q', cleanSearch);
      if (searchByUsername) {
        params.append('by_username', 'true');
      }
    }
    
    console.log('–ó–∞–ø—Ä–æ—Å –∫:', `/staff/search?${params.toString()}`);
    
    const response = await fetch(`/staff/search?${params.toString()}`);
    
    if (!response.ok) {
      document.getElementById('staff-user-search-results').innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 16px 0;">‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ</p>';
      return;
    }
    
    const users = await response.json();
    // –§–∏–ª—å—Ç—Ä—É–µ–º - –∏—Å–∫–ª—é—á–∞–µ–º —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π –ø–µ—Ä—Å–æ–Ω–∞–ª
    const filteredUsers = users.filter(u => !window.currentStaffTelegramIds.includes(u.telegram_id));
    
    // –ï—Å–ª–∏ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞ –ø—É—Å—Ç–æ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    if (!cleanSearch) {
      if (filteredUsers.length === 0) {
        document.getElementById('staff-user-search-results').innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 16px 0;">üì≠ –ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>';
        return;
      }
    } else {
      if (filteredUsers.length === 0) {
        document.getElementById('staff-user-search-results').innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 16px 0;">‚ùå –ü–µ—Ä—Å–æ–Ω–∞–ª –Ω–µ –Ω–∞–π–¥–µ–Ω</p>';
        return;
      }
    }
    
    displaySearchResults(filteredUsers);
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞:', error);
    document.getElementById('staff-user-search-results').innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 16px 0;">‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏</p>';
  }
}

function displaySearchResults(users) {
  const resultsHtml = users.map(u => {
    const safeName = u.name.replace(/'/g, "\\'").replace(/"/g, '\\"');
    const safePhone = (u.phone || '').replace(/'/g, "\\'").replace(/"/g, '\\"');
    const safeEmail = (u.email || '').replace(/'/g, "\\'").replace(/"/g, '\\"');
    const isSelected = window.selectedStaffUserData && window.selectedStaffUserData.id === u.id;
    const borderColor = isSelected ? '#1976d2' : 'var(--accent)';
    const bgColor = isSelected ? '#e3f2fd' : 'var(--bg)';
    
    return `
      <div class="card" id="user-card-${u.id}" style="margin-bottom: 8px; cursor: pointer; background: ${bgColor}; border-left: 4px solid ${borderColor}; transition: all 0.2s;" onclick="selectStaffUser(${u.id}, '${safeName}', ${u.telegram_id}, '${safePhone}', '${safeEmail}')">
        <div style="font-weight: 600; font-size: 14px;">
          ${u.name}
          ${window.selectedStaffUserData && window.selectedStaffUserData.id === u.id ? ' ‚úì' : ''}
        </div>
        <div style="font-size: 12px; color: var(--hint); margin-top: 2px;">ID: ${u.telegram_id}${u.username ? ` ‚Ä¢ @${u.username}` : ''}</div>
        ${u.phone ? `<div style="font-size: 12px; color: var(--hint);">üì± ${u.phone}</div>` : ''}
      </div>
    `;
  }).join('');
  
  document.getElementById('staff-user-search-results').innerHTML = resultsHtml;
}

function selectStaffUser(id, name, telegramId, phone, email) {
  window.selectedStaffUserData = {
    id,
    name,
    telegram_id: telegramId,
    phone,
    email
  };
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –≤—Å–µ—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
  const allCards = document.querySelectorAll('[id^="user-card-"]');
  allCards.forEach(card => {
    if (card.id === `user-card-${id}`) {
      // –í—ã–±—Ä–∞–Ω–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ - —Å–∏–Ω—è—è
      card.style.background = '#e3f2fd';
      card.style.borderLeftColor = '#1976d2';
      // –î–æ–±–∞–≤–ª—è–µ–º –≥–∞–ª–æ—á–∫—É
      const titleDiv = card.querySelector('div');
      if (!titleDiv.textContent.includes('‚úì')) {
        titleDiv.textContent += ' ‚úì';
      }
    } else {
      // –û—Å—Ç–∞–ª—å–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –≤–∏–¥
      card.style.background = 'var(--bg)';
      card.style.borderLeftColor = 'var(--accent)';
      // –£–±–∏—Ä–∞–µ–º –≥–∞–ª–æ—á–∫—É
      const titleDiv = card.querySelector('div');
      titleDiv.textContent = titleDiv.textContent.replace(' ‚úì', '');
    }
  });
}

async function saveNewStaff() {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—ã–±—Ä–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
  if (!window.selectedStaffUserData) {
    showNotification('‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å–ø–∏—Å–∫–∞');
    return;
  }
  
  const position = document.getElementById('staff-add-position').value;
  const specialization = document.getElementById('staff-add-specialization').value.trim();
  const bio = document.getElementById('staff-add-bio').value.trim();
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
  if (!position) {
    showNotification('‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ –¥–æ–ª–∂–Ω–æ—Å—Ç—å');
    return;
  }
  
  try {
    const payload = {
      name: window.selectedStaffUserData.name,
      telegram_id: window.selectedStaffUserData.telegram_id,
      position,
      specialization: specialization || undefined,
      bio: bio || undefined
    };
    
    const response = await fetch('/staff', {
      method: 'POST',
      headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
      body: JSON.stringify(payload)
    });
    
    if (response.ok) {
      showNotification('‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–ª –¥–æ–±–∞–≤–ª–µ–Ω');
      setTimeout(() => {
        // –û—á–∏—â–∞–µ–º –≤—ã–±–æ—Ä
        window.selectedStaffUserData = null;
        goBack();
        loadStaffList();
      }, 500);
    } else {
      const error = await response.json();
      showNotification('‚ùå –û—à–∏–±–∫–∞: ' + (error.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞:', error);
    showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
  }
}

async function deleteStaffMember(staffId, name) {
  if (!confirm(`–£–¥–∞–ª–∏—Ç—å ${name}?`)) {
    return;
  }
  
  try {
    const response = await fetch(`/staff/${staffId}`, {
      method: 'DELETE',
      headers: getAuthHeaders()
    });
    
    if (response.ok) {
      showNotification('‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–ª —É–¥–∞–ª–µ–Ω');
      loadStaffList();
    } else {
      showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏');
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏:', error);
    showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
  }
}

let currentDetailStaffId = null;

function openStaffDetail(id, name, position, phone, email, specialization, bio, status) {
  currentDetailStaffId = id;
  
  const phoneValue = (phone === 'null' || phone === 'undefined') ? '' : phone;

  document.getElementById('staff-detail-name').innerText = name;
  document.getElementById('staff-detail-position').innerText = position;
  document.getElementById('staff-detail-position-full').innerText = position;
  const phoneBlock = document.getElementById('staff-detail-phone-block');
  if (phoneValue) {
    document.getElementById('staff-detail-phone').innerText = phoneValue;
    phoneBlock.style.display = 'block';
  } else {
    document.getElementById('staff-detail-phone').innerText = '‚Äî';
    phoneBlock.style.display = 'none';
  }
  document.getElementById('staff-detail-email').innerText = email || '‚Äî';
  document.getElementById('staff-detail-specialization').innerText = specialization || '‚Äî';
  document.getElementById('staff-detail-bio').innerText = bio || '‚Äî';
  document.getElementById('staff-detail-status').innerText = status === 'active' ? '‚úÖ –ê–∫—Ç–∏–≤–µ–Ω' : '‚ùå –ù–µ–∞–∫—Ç–∏–≤–µ–Ω';
  
  showPage('staff-detail');
  setHeaderTitle(name);

  // –û–±–Ω–æ–≤–ª—è–µ–º –∞–≤–∞—Ç–∞—Ä (staff -> user -> telegram)
  updateStaffDetailAvatar(null, null);
  fetch(`/staff/${id}`)
    .then(async r => {
      const data = await r.json();
      if (!r.ok) throw new Error(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å');
      return data;
    })
    .then(staff => {
      updateStaffDetailAvatar(staff.photo_path, staff.telegram_id);
    })
    .catch(() => {
      // –µ—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å - –æ—Å—Ç–∞–≤–ª—è–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä
    });
}

function updateStaffDetailAvatar(photoPath, telegramId) {
  const img = document.getElementById('staff-detail-avatar-img');
  const placeholder = document.querySelector('#staff-detail-avatar p');
  if (!img || !placeholder) return;

  if (photoPath) {
    img.src = `/media/${photoPath}`;
    img.style.display = 'block';
    placeholder.style.display = 'none';
    return;
  }

  const tgUser = tg?.initDataUnsafe?.user;
  if (tgUser && telegramId && tgUser.id === telegramId && tgUser.photo_url) {
    img.src = tgUser.photo_url;
    img.style.display = 'block';
    placeholder.style.display = 'none';
    return;
  }

  img.style.display = 'none';
  img.src = '';
  placeholder.style.display = 'flex';
}

async function deleteCurrentStaff() {
  if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞?')) {
    return;
  }
  
  try {
    const response = await fetch(`/staff/${currentDetailStaffId}`, {
      method: 'DELETE',
      headers: getAuthHeaders()
    });
    
    if (response.ok) {
      showNotification('‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–ª —É–¥–∞–ª–µ–Ω');
      goBack();
      setTimeout(() => loadStaffList(), 500);
    } else {
      showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏');
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏:', error);
    showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
  }
}

async function loadStaffSchedule() {
  try {
    const container = document.getElementById('staff-schedule-container');
    container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</p>';
    
    const response = await fetch('/schedule');
    
    if (!response.ok) {
      container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è</p>';
      return;
    }
    
    let schedules = await response.json();
    
    // –§–∏–ª—å—Ç—Ä—É–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –¥–æ–ª–∂–Ω–æ—Å—Ç–∏
    if (currentStaffPosition === '—É—á–∏—Ç–µ–ª—å') {
      // –£—á–∏—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –∑–∞–Ω—è—Ç–∏—è
      schedules = schedules.filter(s => s.teacher === currentUserData.name);
    }
    // –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä –∏ –≤—ã—à–µ –≤–∏–¥—è—Ç –≤—Å–µ –∑–∞–Ω—è—Ç–∏—è
    
    if (schedules.length === 0) {
      container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">üì≠ –ó–∞–Ω—è—Ç–∏–π –Ω–µ—Ç</p>';
      return;
    }
    
    displayStaffSchedules(schedules);
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è:', error);
    document.getElementById('staff-schedule-container').innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏</p>';
  }
}

function displayStaffSchedules(schedules) {
  const container = document.getElementById('staff-schedule-container');
  
  container.innerHTML = schedules.map(s => `
    <div class="card" onclick="editSchedule(${s.id}, '${s.title}', ${s.teacher_id}, '${s.teacher.name}', '${s.date}', '${s.start}', '${s.end}')">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <div style="font-weight: 600; font-size: 15px;">${s.title}</div>
          <div style="font-size: 13px; color: var(--hint); margin-top: 4px;">üìÖ ${new Date(s.date).toLocaleDateString('ru-RU')}</div>
          <div style="font-size: 13px; color: var(--hint);">üïê ${s.start} - ${s.end}</div>
          <div style="font-size: 13px; color: var(--hint);">üë®‚Äçüè´ ${s.teacher.name}</div>
        </div>
        <div style="font-size: 24px;">‚Üí</div>
      </div>
    </div>
  `).join('');
}

async function loadPublicSchedule() {
  try {
    const container = document.getElementById('schedule-container');
    if (container) {
      container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</p>';
    }
    
    const response = await fetch('/schedule/public');
    
    if (!response.ok) {
      if (container) {
        container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è</p>';
      }
      return;
    }
    
    const schedules = await response.json();
    window.publicScheduleItems = Array.isArray(schedules) ? schedules : [];
    
    preloadPublicDirections().then(() => {
      initPublicScheduleStrip();
      renderPublicScheduleList();
    });
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è:', error);
    const container = document.getElementById('schedule-container');
    if (container) {
      container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏</p>';
    }
  }
}

function preloadPublicDirections() {
  const items = Array.isArray(window.publicScheduleItems) ? window.publicScheduleItems : [];
  const missingIds = Array.from(new Set(items
    .filter(s => s.direction_id && !s.direction_image)
    .map(s => s.direction_id)
  ));
  if (!missingIds.length) return Promise.resolve();
  if (!window.publicDirectionsCache) window.publicDirectionsCache = {};

  return Promise.all(missingIds.map(id => {
    if (window.publicDirectionsCache[id]) return Promise.resolve();
    return fetch(`/api/directions/${id}`)
      .then(res => res.ok ? res.json() : null)
      .then(dir => {
        if (dir && dir.image_path) {
          window.publicDirectionsCache[id] = dir.image_path;
        }
      })
      .catch(() => {});
  })).then(() => {
    items.forEach(s => {
      if (!s.direction_image && s.direction_id && window.publicDirectionsCache[s.direction_id]) {
        s.direction_image = window.publicDirectionsCache[s.direction_id];
      }
    });
  });
}

function initPublicScheduleStrip() {
  const strip = document.getElementById('public-schedule-strip');
  const monthLabel = document.getElementById('public-schedule-month');
  if (!strip) return;

  const today = new Date();
  const days = [];
  for (let i = 0; i < 7; i++) {
    const d = new Date(today.getTime() + i * 24 * 60 * 60 * 1000);
    days.push(d);
  }

  if (!window.publicScheduleDate) {
    window.publicScheduleDate = today.toISOString().slice(0, 10);
  }

  if (monthLabel) {
    monthLabel.textContent = today.toLocaleDateString('ru-RU', { month: 'long' });
  }

  const labels = ['–≤—Å', '–ø–Ω', '–≤—Ç', '—Å—Ä', '—á—Ç', '–ø—Ç', '—Å–±'];
  strip.innerHTML = days.map((d, idx) => {
    const dateStr = d.toISOString().slice(0, 10);
    const isActive = window.publicScheduleDate === dateStr;
    const dayLabel = labels[d.getDay()];
    const shortLabel = idx === 0 ? '—Å–µ–≥–æ–¥–Ω—è' : idx === 1 ? '–∑–∞–≤—Ç—Ä–∞' : '';
    return `
      <div class="public-date-card ${isActive ? 'active' : ''}" onclick="selectPublicScheduleDate('${dateStr}')">
        <div class="public-date-dow">${dayLabel}</div>
        <div class="public-date-day">${d.getDate()}</div>
        <div class="public-date-label">${shortLabel}</div>
      </div>
    `;
  }).join('');
}

function selectPublicScheduleDate(dateStr) {
  window.publicScheduleDate = dateStr;
  initPublicScheduleStrip();
  renderPublicScheduleList();
}

function renderPublicScheduleList() {
  const container = document.getElementById('schedule-container');
  if (!container) return;
  const items = Array.isArray(window.publicScheduleItems) ? window.publicScheduleItems : [];
  const selected = window.publicScheduleDate;
  const filtered = selected ? items.filter(s => s.date === selected) : items;

  if (!filtered.length) {
    container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">üì≠ –ù–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å –∑–∞–Ω—è—Ç–∏–π –Ω–µ—Ç</p>';
    return;
  }

  const sorted = filtered.slice().sort((a, b) => (a.start || '').localeCompare(b.start || ''));
  container.innerHTML = sorted.map(s => {
    const teacherName = s.teacher_name || (s.teacher && s.teacher.name ? s.teacher.name : '‚Äî');
    const directionTitle = s.direction || '‚Äî';
    const startTime = formatTimeShort(s.start);
    const endTime = formatTimeShort(s.end);
    const duration = getDurationMinutes(startTime, endTime);
    const color = getPublicScheduleColor(s.title || '');
    return `
      <div class="public-schedule-item" onclick="openPublicScheduleDetail(${s.id})">
        <div class="public-schedule-time">
          <div class="public-dot" style="background:${color};"></div>
          <div class="public-time">${startTime || '‚Äî'}</div>
          <div class="public-duration">${duration ? duration + ' –º–∏–Ω' : '‚Äî'}</div>
        </div>
        <div>
          <div class="public-info-title">${s.title || '–ó–∞–Ω—è—Ç–∏–µ'}</div>
          <div class="public-info-sub">${directionTitle}</div>
          <div class="public-info-sub">–ì—Ä—É–ø–ø–æ–≤–æ–µ –∑–∞–Ω—è—Ç–∏–µ</div>
          <div class="public-info-teacher">${teacherName}</div>
        </div>
        <div class="public-chevron">‚Ä∫</div>
      </div>
    `;
  }).join('');
}

function getDurationMinutes(start, end) {
  if (!start || !end) return null;
  const [sh, sm] = start.split(':').map(Number);
  const [eh, em] = end.split(':').map(Number);
  if (Number.isNaN(sh) || Number.isNaN(eh)) return null;
  return Math.max(0, (eh * 60 + em) - (sh * 60 + sm));
}

function formatTimeShort(timeStr) {
  if (!timeStr) return '';
  const parts = timeStr.split(':');
  if (parts.length < 2) return timeStr;
  return `${parts[0].padStart(2, '0')}:${parts[1].padStart(2, '0')}`;
}

function getPublicScheduleColor(key) {
  const hue = (hashString(key || '') + 180) % 360;
  return `hsl(${hue}, 70%, 55%)`;
}

function openPublicScheduleDetail(id) {
  const items = Array.isArray(window.publicScheduleItems) ? window.publicScheduleItems : [];
  const item = items.find(i => i.id === id);
  if (!item) return;

  const content = document.getElementById('public-schedule-detail-content');
  if (!content) return;

  const startTime = formatTimeShort(item.start);
  const endTime = formatTimeShort(item.end);
  const duration = getDurationMinutes(startTime, endTime);
  const lessons = item.lessons_per_week ? item.lessons_per_week : '‚Äî';
  const directionImage = item.direction_image || '';

  content.innerHTML = `
    ${directionImage ? `<div class="card" style="padding:0; overflow:hidden; margin-bottom:8px;"><img src="${directionImage}" alt="–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ" style="width:100%; height:180px; object-fit:cover; display:block;"></div>` : ''}
    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:6px;">
      <div class="schedule-detail-chip">üìÖ ${item.date ? new Date(item.date).toLocaleDateString('ru-RU') : '‚Äî'}</div>
      <div class="schedule-detail-chip">‚è∞ ${startTime || '‚Äî'} ‚Äî ${endTime || '‚Äî'}</div>
      <div class="schedule-detail-chip">‚è≥ ${duration ? duration + ' –º–∏–Ω' : '‚Äî'}</div>
    </div>
    <div class="schedule-detail-card">
      <div class="schedule-detail-row">üë• <strong>–ì—Ä—É–ø–ø–∞:</strong> ${item.title || '‚Äî'}</div>
      <div class="schedule-detail-row">üë©‚Äçüè´ <strong>–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å:</strong> ${item.teacher_name || '‚Äî'}</div>
      <div class="schedule-detail-row">üìÜ <strong>–ó–∞–Ω—è—Ç–∏–π –≤ –Ω–µ–¥–µ–ª—é:</strong> ${lessons}</div>
      <div class="schedule-detail-row">üéà <strong>–í–æ–∑—Ä–∞—Å—Ç:</strong> ${item.age_group || '‚Äî'}</div>
    </div>
    <div class="schedule-detail-card">
      <div class="schedule-detail-row">üéØ <strong>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</strong> ${item.direction || '‚Äî'}</div>
      <div class="schedule-detail-row">üìù <strong>–û–ø–∏—Å–∞–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è:</strong> ${item.direction_description || '‚Äî'}</div>
      <button class="save-btn" style="width:100%; margin-top:4px; background:#111;">–ü–µ—Ä–µ–π—Ç–∏ –≤ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</button>
    </div>
  `;

  showPage('public-schedule-detail');
}

async function loadTeachers() {
  try {
    const response = await fetch('/staff/list/teachers');
    if (!response.ok) return [];
    return await response.json();
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —É—á–∏—Ç–µ–ª–µ–π:', error);
    return [];
  }
}

function populateTeacherSelect(teachers, selectedTeacherId = null) {
  const select = document.getElementById('schedule-input-teacher');
  const currentValue = select.value;
  
  select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è</option>';
  
  teachers.forEach(t => {
    const option = document.createElement('option');
    option.value = t.id;
    option.textContent = t.name;
    if (t.id == (selectedTeacherId || currentValue)) {
      option.selected = true;
    }
    select.appendChild(option);
  });
}

async function openCreateSchedule() {
  currentScheduleId = null;
  
  document.getElementById('schedule-form-title').innerText = '–°–æ–∑–¥–∞—Ç—å –∑–∞–Ω—è—Ç–∏–µ';
  document.getElementById('schedule-input-title').value = '';
  document.getElementById('schedule-input-date').value = '';
  document.getElementById('schedule-input-start').value = '';
  document.getElementById('schedule-input-end').value = '';
  document.getElementById('schedule-delete-btn').style.display = 'none';
  
  const teachers = await loadTeachers();
  populateTeacherSelect(teachers, currentUserData.id);
  
  showPage('schedule-form');
  setHeaderTitle('–°–æ–∑–¥–∞—Ç—å –∑–∞–Ω—è—Ç–∏–µ');
}

function editSchedule(scheduleId, title, teacherId, teacherName, date, start, end) {
  currentScheduleId = scheduleId;
  
  document.getElementById('schedule-form-title').innerText = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–Ω—è—Ç–∏–µ';
  document.getElementById('schedule-input-title').value = title;
  document.getElementById('schedule-input-date').value = date;
  document.getElementById('schedule-input-start').value = start;
  document.getElementById('schedule-input-end').value = end;
  document.getElementById('schedule-delete-btn').style.display = 'block';
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º —É—á–∏—Ç–µ–ª–µ–π –∏ –≤—ã–±–∏—Ä–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ
  loadTeachers().then(teachers => {
    populateTeacherSelect(teachers, teacherId);
  });
  
  showPage('schedule-form');
  setHeaderTitle('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–Ω—è—Ç–∏–µ');
}

async function saveSchedule() {
  const title = document.getElementById('schedule-input-title').value.trim();
  const teacher_id = document.getElementById('schedule-input-teacher').value;
  const date = document.getElementById('schedule-input-date').value;
  const start = document.getElementById('schedule-input-start').value;
  const end = document.getElementById('schedule-input-end').value;
  
  if (!title || !teacher_id || !date || !start || !end) {
    showNotification('‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
    return;
  }
  
  try {
    if (currentScheduleId) {
      // –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –∑–∞–Ω—è—Ç–∏–µ
      const response = await fetch(`/schedule/${currentScheduleId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title, teacher_id: parseInt(teacher_id), date, start_time: start, end_time: end })
      });
      
      if (response.ok) {
        showNotification('‚úÖ –ó–∞–Ω—è—Ç–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ');
        goBack();
      } else {
        const error = await response.json();
        showNotification('‚ùå –û—à–∏–±–∫–∞: ' + (error.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
      }
    } else {
      // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ –∑–∞–Ω—è—Ç–∏–µ
      const response = await fetch('/schedule', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title, teacher_id: parseInt(teacher_id), date, start_time: start, end_time: end })
      });
      
      if (response.ok) {
        showNotification('‚úÖ –ó–∞–Ω—è—Ç–∏–µ —Å–æ–∑–¥–∞–Ω–æ');
        goBack();
      } else {
        const error = await response.json();
        showNotification('‚ùå –û—à–∏–±–∫–∞: ' + (error.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
      }
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∑–∞–Ω—è—Ç–∏—è:', error);
    showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∑–∞–Ω—è—Ç–∏—è');
  }
}

async function deleteSchedule() {
  if (!currentScheduleId) {
    showNotification('‚ùå ID –∑–∞–Ω—è—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω');
    return;
  }
  
  if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ –∑–∞–Ω—è—Ç–∏–µ?')) {
    return;
  }
  
  try {
    const response = await fetch(`/schedule/${currentScheduleId}`, {
      method: 'DELETE'
    });
    
    if (response.ok) {
      showNotification('‚úÖ –ó–∞–Ω—è—Ç–∏–µ —É–¥–∞–ª–µ–Ω–æ');
      goBack();
    } else {
      const error = await response.json();
      showNotification('‚ùå –û—à–∏–±–∫–∞: ' + (error.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–Ω—è—Ç–∏—è:', error);
    showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–Ω—è—Ç–∏—è');
  }
}

/* ====== –ü–†–û–í–ï–†–ö–ê –°–¢–ê–¢–£–°–ê –ü–ï–†–°–û–ù–ê–õ–ê ====== */
async function checkStaffStatus(telegramId) {
  try {
    const response = await fetch(`/staff/check/${telegramId}`);
    
    if (!response.ok) {
      isStaff = false;
      currentStaffPosition = '';
      setCachedStaffStatus(false, '');
      updateStaffNavigation();
      return;
    }
    
    const data = await response.json();
    isStaff = data.is_staff;
    if (data.staff) {
      currentStaffPosition = data.staff.position.toLowerCase();
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∏–º—è –∏–∑ Telegram –µ—Å–ª–∏ —ç—Ç–æ –≤–ª–∞–¥–µ–ª–µ—Ü –∏–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
      const user = tg.initDataUnsafe?.user;
      if (user && (currentStaffPosition === '–≤–ª–∞–¥–µ–ª–µ—Ü' || currentStaffPosition === '–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä')) {
        try {
          await fetch(`/staff/update-from-telegram/${telegramId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              first_name: user.first_name,
              last_name: user.last_name
            })
          });
        } catch (error) {
          console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∏–º—è –∏–∑ Telegram:', error);
        }
      }
    }
    setCachedStaffStatus(isStaff, currentStaffPosition);
    updateStaffNavigation();
    
    console.log(`–°—Ç–∞—Ç—É—Å –ø–µ—Ä—Å–æ–Ω–∞–ª–∞: ${isStaff}, –¥–æ–ª–∂–Ω–æ—Å—Ç—å: ${currentStaffPosition}`);
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞:', error);
    isStaff = false;
    currentStaffPosition = '';
    setCachedStaffStatus(false, '');
    updateStaffNavigation();
  }
}

function updateStaffNavigation() {
  const staffNavBtn = document.getElementById('staff-nav-btn');
  const staffManageBtn = document.getElementById('staff-manage-btn-work');
  
  if (isStaff) {
    staffNavBtn.classList.remove('hidden');
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª–æ–º —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ –∏ –≤–ª–∞–¥–µ–ª—å—Ü–µ–≤
    if (currentStaffPosition && (
      currentStaffPosition.toLowerCase() === '–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' || 
      currentStaffPosition.toLowerCase() === '–≤–ª–∞–¥–µ–ª–µ—Ü' || 
      currentStaffPosition.toLowerCase() === '—Ç–µ—Ö. –∞–¥–º–∏–Ω'
    )) {
      staffManageBtn.style.display = 'flex';
    } else {
      staffManageBtn.style.display = 'none';
    }
  } else {
    staffNavBtn.classList.add('hidden');
    staffManageBtn.style.display = 'none';
    // –ï—Å–ª–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª –ø—ã—Ç–∞–µ—Ç—Å—è –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å–∫—Ä—ã—Ç—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω—É—é
    if (document.getElementById('staff').classList.contains('active')) {
      showPage('home');
    }
  }
}

/* ====== –ü–†–û–§–ò–õ–¨ –ò–ó TELEGRAM ====== */
const user = tg.initDataUnsafe?.user;
let currentUserData = null;
let isStaff = false;

if (user) {
  document.getElementById('profile-name').innerText = user.first_name || '‚Äî';
  document.getElementById('profile-username').innerText = user.username ? '@' + user.username : '‚Äî';

  if (user.photo_url) {
    document.getElementById('avatar').innerHTML = `<img src="${user.photo_url}">`;
  }
  
  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  registerUserIfNeeded(user);
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è –∏–∑ –ë–î
  loadProfileData(user.id);
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–º
  const cachedStaff = getCachedStaffStatus();
  if (cachedStaff) {
    isStaff = cachedStaff.isStaff;
    currentStaffPosition = cachedStaff.position || '';
    updateStaffNavigation();
  }

  checkStaffStatus(user.id);
}

/* ====== –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• –ü–†–û–§–ò–õ–Ø ====== */
async function loadProfileData(telegramId) {
  try {
    // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã –¥–∞—Ç—å –≤—Ä–µ–º—è –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
    await new Promise(resolve => setTimeout(resolve, 500));
    
    const response = await fetch(`/users/${telegramId}`);
    
    if (!response.ok) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ—Ñ–∏–ª—è:', response.status);
      showNotification('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
      return;
    }
    
    const data = await response.json();
    currentUserData = data;
    
    console.log('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω:', data);
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏
    document.getElementById('profile-input-name').value = data.name || '';
    document.getElementById('profile-input-phone').value = data.phone || '';
    document.getElementById('profile-input-email').value = data.email || '';
    document.getElementById('profile-input-birth-date').value = data.birth_date || '';
    document.getElementById('profile-input-user-notes').value = data.user_notes || '';
    document.getElementById('profile-status').innerText = getStatusText(data.status);
    document.getElementById('profile-registered').innerText = formatDate(data.registered_at);
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ –µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if (data.photo_path) {
      displayProfilePhoto(data.photo_path);
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –Ω–∞ –ø–∞–Ω–µ–ª–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞
    if (isStaff) {
      displayStaffInfo(data);
    }
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ—Ñ–∏–ª—è:', error);
    showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ—Ñ–∏–ª—è');
  }
}

/* ====== –°–û–•–†–ê–ù–ï–ù–ò–ï –ò–ó–ú–ï–ù–ï–ù–ò–ô –ü–†–û–§–ò–õ–Ø ====== */
async function saveProfileChanges() {
  if (!currentUserData) {
    showNotification('‚ùå –î–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
    return;
  }
  
  const telegramId = currentUserData.telegram_id;
  
  const updatedData = {
    name: document.getElementById('profile-input-name').value.trim(),
    phone: document.getElementById('profile-input-phone').value.trim(),
    email: document.getElementById('profile-input-email').value.trim() || null,
    birth_date: document.getElementById('profile-input-birth-date').value || null,
    user_notes: document.getElementById('profile-input-user-notes').value.trim() || null
  };
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω –Ω–µ –ø—É—Å—Ç—ã–µ
  if (!updatedData.name) {
    showNotification('‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –∏–º—è');
    return;
  }
  if (!updatedData.phone) {
    showNotification('‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞');
    return;
  }
  
  try {
    console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ:', updatedData);
    
    const response = await fetch(`/users/${telegramId}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(updatedData)
    });
    
    if (response.ok) {
      const newData = await response.json();
      currentUserData = newData;
      
      console.log('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω:', newData);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–º–µ–Ω–∏
      document.getElementById('profile-name').innerText = newData.name;
      
      showNotification('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!');
    } else {
      const error = await response.json();
      console.error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:', error);
      showNotification('‚ùå –û—à–∏–±–∫–∞: ' + (error.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è:', error);
    showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è');
  }
}

/* ====== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ====== */
function getStatusText(status) {
  const statusMap = {
    'active': '‚úÖ –ê–∫—Ç–∏–≤–µ–Ω',
    'inactive': '‚è∏Ô∏è –ù–µ–∞–∫—Ç–∏–≤–µ–Ω',
    'frozen': '‚ùÑÔ∏è –ó–∞–º–æ—Ä–æ–∑–∫–∞'
  };
  return statusMap[status] || status;
}

function formatDate(dateString) {
  const date = new Date(dateString);
  return date.toLocaleDateString('ru-RU', { 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
}

/* ====== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–õ–ò–ï–ù–¢–ê–ú–ò (–ü–ï–†–°–û–ù–ê–õ) ====== */
let allClients = [];

async function loadAllClients() {
  try {
    const container = document.getElementById('staff-clients-container');
    container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</p>';
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ (–ø–µ—Ä—Å–æ–Ω–∞–ª–µ)
    if (currentUserData) {
      displayStaffInfo(currentUserData);
    }
    
    const response = await fetch('/users/list/all');
    
    if (!response.ok) {
      container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–ª–∏–µ–Ω—Ç–æ–≤</p>';
      return;
    }
    
    allClients = await response.json();
    
    if (allClients.length === 0) {
      container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">üì≠ –ö–ª–∏–µ–Ω—Ç–æ–≤ –µ—â–µ –Ω–µ—Ç</p>';
      return;
    }
    
    displayClients(allClients);
    console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${allClients.length} –∫–ª–∏–µ–Ω—Ç–æ–≤`);
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–ª–∏–µ–Ω—Ç–æ–≤:', error);
    document.getElementById('staff-clients-container').innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏</p>';
  }
}

function searchClients() {
  const searchTerm = document.getElementById('staff-search-input').value.toLowerCase();
  
  if (!searchTerm) {
    loadAllClients();
    return;
  }
  
  // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ ID
  const filtered = allClients.filter(client => 
    client.name.toLowerCase().includes(searchTerm) ||
    client.telegram_id.toString().includes(searchTerm)
  );
  
  displayClients(filtered);
}

/* ====== –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –ò–ù–§–û–†–ú–ê–¶–ò–ò –û –ü–ï–†–°–û–ù–ê–õ–ï ====== */
async function displayStaffInfo(userData) {
  try {
    // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–µ—Ä—Å–æ–Ω–∞–ª–µ
    const response = await fetch(`/staff/check/${userData.telegram_id}`);
    
    if (!response.ok) {
      console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–µ—Ä—Å–æ–Ω–∞–ª–µ');
      return;
    }
    
    const data = await response.json();
    
    if (data.is_staff && data.staff) {
      const staff = data.staff;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –§–ò–û
      document.getElementById('staff-panel-name').textContent = staff.name;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ–ª–∂–Ω–æ—Å—Ç—å
      const positionText = staff.position.charAt(0).toUpperCase() + staff.position.slice(1);
      document.getElementById('staff-panel-position').textContent = positionText;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–æ—Ç–æ
      if (staff.photo_path) {
        const img = document.getElementById('staff-panel-avatar-img');
        img.src = `/media/${staff.photo_path}`;
        img.style.display = 'block';
        document.querySelector('.staff-avatar-small p').style.display = 'none';
      }

      window.currentStaffProfileId = staff.id;
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–µ—Ä—Å–æ–Ω–∞–ª–µ:', error);
  }
}

async function openStaffProfileEdit() {
  if (!currentUserData) {
    showNotification('‚ö†Ô∏è –ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
    return;
  }

  try {
    const response = await fetch(`/staff/check/${currentUserData.telegram_id}`);
    if (!response.ok) {
      showNotification('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å');
      return;
    }
    const data = await response.json();
    if (!data.is_staff || !data.staff) {
      showNotification('‚ùå –ü—Ä–æ—Ñ–∏–ª—å –ø–µ—Ä—Å–æ–Ω–∞–ª–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω');
      return;
    }

    const staff = data.staff;
    window.currentStaffProfileId = staff.id;
    document.getElementById('staff-profile-name').value = staff.name || '';
    document.getElementById('staff-profile-specialization').value = staff.specialization || '';
    document.getElementById('staff-profile-bio').value = staff.bio || '';
    document.getElementById('staff-profile-phone').value = staff.phone || '';
    document.getElementById('staff-profile-email').value = staff.email || '';

    showPage('staff-profile-edit');
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∞:', error);
    showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
  }
}

async function saveStaffProfile() {
  const staffId = window.currentStaffProfileId;
  if (!staffId) {
    showNotification('‚ùå ID –ø–µ—Ä—Å–æ–Ω–∞–ª–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω');
    return;
  }

  const name = document.getElementById('staff-profile-name').value.trim();
  const specialization = document.getElementById('staff-profile-specialization').value.trim();
  const bio = document.getElementById('staff-profile-bio').value.trim();
  const phone = document.getElementById('staff-profile-phone').value.trim();
  const email = document.getElementById('staff-profile-email').value.trim();

  try {
    const response = await fetch(`/staff/${staffId}`, {
      method: 'PUT',
      headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
      body: JSON.stringify({
        name: name || null,
        specialization: specialization || null,
        bio: bio || null,
        phone: phone || null,
        email: email || null
      })
    });

    const data = await response.json();
    if (!response.ok) {
      showNotification('‚ùå ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å'));
      return;
    }

    showNotification('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω');
    if (currentUserData) {
      displayStaffInfo(currentUserData);
    }
    goBack();
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∞:', error);
    showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
  }
}

function displayClients(clients) {
  const container = document.getElementById('staff-clients-container');
  
  if (clients.length === 0) {
    container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">–ö–ª–∏–µ–Ω—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
    return;
  }
  
  container.innerHTML = clients.map(client => `
    <div class="client-card" onclick="viewClientDetails(${client.telegram_id})">
      <div class="client-card-header">
        <div class="client-card-name">${client.name}</div>
        <div class="client-card-status">${getStatusText(client.status)}</div>
      </div>
      
      <div class="client-card-info">
        ${client.phone ? `
          <div class="client-info-item">
            <div class="client-info-label">üì± –¢–µ–ª–µ—Ñ–æ–Ω</div>
            <div class="client-info-value">${client.phone}</div>
          </div>
        ` : ''}
        ${client.email ? `
          <div class="client-info-item">
            <div class="client-info-label">üìß Email</div>
            <div class="client-info-value">${client.email}</div>
          </div>
        ` : ''}
      </div>
      
      ${client.user_notes ? `<div class="client-card-notes"><strong>üéØ –ü–æ–∂–µ–ª–∞–Ω–∏—è:</strong> ${client.user_notes}</div>` : ''}
      ${client.staff_notes ? `<div class="client-card-notes"><strong>üìå –ó–∞–º–µ—Ç–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞:</strong> ${client.staff_notes}</div>` : ''}
    </div>
  `).join('');
}

function viewClientDetails(telegramId) {
  // TODO: –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –∫–ª–∏–µ–Ω—Ç–∞
  console.log('–ü—Ä–æ—Å–º–æ—Ç—Ä –∫–ª–∏–µ–Ω—Ç–∞:', telegramId);
  showNotification('–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
}

/* ====== –†–ê–ë–û–¢–ê –° –§–û–¢–û –ü–†–û–§–ò–õ–Ø ====== */
function displayProfilePhoto(photoPath) {
  const img = document.getElementById('profile-photo-img');
  const placeholder = document.getElementById('profile-photo-placeholder');
  
  img.src = `/media/${photoPath}`;
  img.style.display = 'block';
  placeholder.style.display = 'none';
}

async function uploadProfilePhoto() {
  if (!isStaff) {
    showNotification('‚ùå –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∞');
    return;
  }
  
  if (!currentUserData) {
    showNotification('‚ùå –î–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
    return;
  }
  
  const fileInput = document.getElementById('profile-photo-input');
  if (!fileInput.files || fileInput.files.length === 0) {
    showNotification('‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª');
    return;
  }
  
  const file = fileInput.files[0];
  const telegramId = currentUserData.telegram_id;
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä
  if (file.size > 5 * 1024 * 1024) {
    showNotification('‚ùå –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å 5 –ú–ë');
    return;
  }
  
  try {
    const formData = new FormData();
    formData.append('photo', file);
    
    console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ...');
    
    const response = await fetch(`/users/${telegramId}/photo`, {
      method: 'POST',
      body: formData
    });
    
    if (response.ok) {
      const data = await response.json();
      currentUserData.photo_path = data.photo_path;
      displayProfilePhoto(data.photo_path);
      showNotification('‚úÖ –§–æ—Ç–æ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ!');
      fileInput.value = '';
    } else {
      const error = await response.json();
      showNotification('‚ùå –û—à–∏–±–∫–∞: ' + (error.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–æ—Ç–æ:', error);
    showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–æ—Ç–æ');
  }
}

async function deleteProfilePhoto() {
  if (!isStaff) {
    showNotification('‚ùå –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∞');
    return;
  }
  
  if (!currentUserData) {
    showNotification('‚ùå –î–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
    return;
  }
  
  if (!currentUserData.photo_path) {
    showNotification('‚ö†Ô∏è –§–æ—Ç–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
    return;
  }
  
  try {
    const response = await fetch(`/users/${currentUserData.telegram_id}/photo`, {
      method: 'DELETE'
    });
    
    if (response.ok) {
      currentUserData.photo_path = null;
      
      const img = document.getElementById('profile-photo-img');
      const placeholder = document.getElementById('profile-photo-placeholder');
      img.style.display = 'none';
      placeholder.style.display = 'block';
      
      showNotification('‚úÖ –§–æ—Ç–æ —É–¥–∞–ª–µ–Ω–æ!');
    } else {
      const error = await response.json();
      showNotification('‚ùå –û—à–∏–±–∫–∞: ' + (error.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–æ—Ç–æ:', error);
    showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–æ—Ç–æ');
  }
}

/* ====== –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø ====== */
async function registerUserIfNeeded(user) {
  try {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –ª–∏ —É–∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    const checkResponse = await fetch(`/users/${user.id}`);
    
    if (checkResponse.ok) {
      // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
      console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –≤ —Å–∏—Å—Ç–µ–º–µ');
      return;
    }
    
    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç, —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –µ–≥–æ
    console.log('–†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');
    
    const registerResponse = await fetch('/users', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        telegram_id: user.id,
        username: user.username,
        phone: '',  // –ü—É—Å—Ç–æ, –∑–∞–ø–æ–ª–Ω–∏—Ç –≤ –ø—Ä–æ—Ñ–∏–ª–µ
        name: user.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
        email: null,
        birth_date: null,
        notes: null
      })
    });
    
    if (registerResponse.ok) {
      console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω');
      showNotification('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ.');
      
      // –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å
      setTimeout(() => loadProfileData(user.id), 1000);
    } else {
      const error = await registerResponse.json();
      console.error('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', error);
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', error);
  }
}

/* DEBUG VERSION */
console.log("Mini App version:", new URLSearchParams(location.search).get("v"));

/* ====== ???????? ???????? ====== */
const NEWS_CACHE_KEY = 'news_cache_v1';
const NEWS_ETAG_KEY = 'news_etag_v1';
let cachedNews = null;

function getCachedNews() {
  if (cachedNews) return cachedNews;
  try {
    const raw = localStorage.getItem(NEWS_CACHE_KEY);
    if (!raw) return null;
    const parsed = JSON.parse(raw);
    if (!Array.isArray(parsed)) return null;
    cachedNews = parsed;
    return parsed;
  } catch (err) {
    return null;
  }
}

function setCachedNews(news, etag) {
  cachedNews = news;
  try {
    localStorage.setItem(NEWS_CACHE_KEY, JSON.stringify(news));
    if (etag) {
      localStorage.setItem(NEWS_ETAG_KEY, etag);
    }
  } catch (err) {
    // ignore cache write errors
  }
}

function renderNewsList(news) {
  const container = document.getElementById('news-container');
  if (!container) return;

  if (!news || news.length === 0) {
    container.innerHTML = '<p class="news-empty">–ù–æ–≤–æ—Å—Ç–µ–π –ø–æ–∫–∞ –Ω–µ—Ç v-v</p>';
    return;
  }

  container.innerHTML = news.map(n => `
    <div class="news-item" onclick="showNewsDetail(${n.id})">
      ${n.photo_path ? `<img src="${n.photo_path}" alt="–ù–æ–≤–æ—Å—Ç—å">` : ''}
      <div class="news-item-title">${n.title}</div>
    </div>
  `).join('');
}

// –ü–æ–∫–∞–∑–∞—Ç—å –∫—ç—à —Å—Ä–∞–∑—É, –µ—Å–ª–∏ –µ—Å—Ç—å
const initialCachedNews = getCachedNews();
if (initialCachedNews) {
  renderNewsList(initialCachedNews);
}

async function loadNews() {
  try {
    const cached = getCachedNews();
    if (cached) {
      renderNewsList(cached);
    }

    const headers = {};
    const etag = localStorage.getItem(NEWS_ETAG_KEY);
    if (etag) {
      headers['If-None-Match'] = etag;
    }

    const response = await fetch('/news', { headers });
    if (response.status === 304) {
      return;
    }
    if (!response.ok) {
      throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤–æ—Å—Ç–∏');
    }

    const news = await response.json();
    setCachedNews(news, response.headers.get('ETag'));
    renderNewsList(news);
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ–≤–æ—Å—Ç–µ–π:', error);
  }
}

async function loadNewsManage() {
  try {
    const response = await fetch('/news/manage', {
      headers: getAuthHeaders()
    });
    const news = await response.json();
    const container = document.getElementById('news-manage-container');
    
    if (news.length === 0) {
      container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">üì≠ –ù–æ–≤–æ—Å—Ç–µ–π –ø–æ–∫–∞ –Ω–µ—Ç</p>';
      return;
    }
    
    container.innerHTML = news.map(n => `
      <div class="card" style="cursor: pointer; margin-bottom: 12px;">
        ${n.photo_path ? `<div style="width: 100%; height: 150px; background: var(--hint); border-radius: 8px 8px 0 0; overflow: hidden; margin: -12px -12px 8px -12px;"><img src="${n.photo_path}" style="width: 100%; height: 100%; object-fit: cover;"></div>` : ''}
        <div style="font-weight: 600; font-size: 16px;">${n.title}</div>
        <div style="font-size: 12px; color: var(--hint); margin-top: 4px;">${new Date(n.created_at).toLocaleDateString('ru-RU')} ${n.status === 'archived' ? 'üì¶ –í –∞—Ä—Ö–∏–≤–µ' : ''}</div>
        <div style="font-size: 13px; margin-top: 8px; color: var(--text);">${n.content.substring(0, 100)}...</div>
        <div style="display: flex; gap: 8px; margin-top: 8px;">
          ${n.status === 'active' ? `<button class="save-btn" onclick="archiveNews(${n.id})" style="flex: 1; background: #ffa940; margin: 0;">ÔøΩ –ê—Ä—Ö–∏–≤</button>` : `<button class="save-btn" onclick="restoreNews(${n.id})" style="flex: 1; background: #52c41a; margin: 0;">‚Ü©Ô∏è –í–µ—Ä–Ω—É—Ç—å</button>`}
          <button class="save-btn" onclick="deleteNews(${n.id})" style="flex: 1; background: #ff6b6b; margin: 0;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </div>
    `).join('');
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ–≤–æ—Å—Ç–µ–π:', error);
    document.getElementById('news-manage-container').innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ</p>';
  }
}

async function openBotForCreateNews() {
  // –û—Ç–∫—Ä—ã–≤–∞–µ–º –±–æ—Ç–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ—Å—Ç–∏
  try {
    // –ü–æ–ª—É—á–∞–µ–º –∏–º—è –±–æ—Ç–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞
    const response = await fetch('/bot-username');
    const data = await response.json();
    const botUsername = data.bot_username || 'dance_studio_admin_bot';
    
    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –±–æ—Ç–∞ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º start
    window.open(`https://t.me/${botUsername}?start=create_news`, '_blank');
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–º–µ–Ω–∏ –±–æ—Ç–∞:', error);
    window.open('https://t.me/dance_studio_admin_bot?start=create_news', '_blank');
  }
}



async function deleteNews(newsId) {
  if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –Ω–æ–≤–æ—Å—Ç—å?')) {
    return;
  }
  
  try {
    const response = await fetch(`/news/${newsId}`, {
      method: 'DELETE',
      headers: getAuthHeaders()
    });
    
    if (response.ok) {
      showNotification('‚úÖ –ù–æ–≤–æ—Å—Ç—å —É–¥–∞–ª–µ–Ω–∞');
      loadNewsManage();
    } else {
      showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏');
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ—Å—Ç–∏:', error);
    showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
  }
}

async function archiveNews(newsId) {
  try {
    const response = await fetch(`/news/${newsId}/archive`, {
      method: 'PUT',
      headers: getAuthHeaders()
    });
    
    if (response.ok) {
      showNotification('‚úÖ –ù–æ–≤–æ—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ –∞—Ä—Ö–∏–≤');
      loadNewsManage();
    } else {
      showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–∏');
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–∏ –Ω–æ–≤–æ—Å—Ç–∏:', error);
    showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
  }
}

async function restoreNews(newsId) {
  try {
    const response = await fetch(`/news/${newsId}/restore`, {
      method: 'PUT',
      headers: getAuthHeaders()
    });
    
    if (response.ok) {
      showNotification('‚úÖ –ù–æ–≤–æ—Å—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
      loadNewsManage();
    } else {
      showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏');
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ—Å—Ç–∏:', error);
    showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
  }
}

function renderNewsDetail(newsItem) {
  document.getElementById('news-detail-title').innerText = newsItem.title;
  document.getElementById('news-detail-date').innerText = new Date(newsItem.created_at).toLocaleDateString('ru-RU', {
    day: 'numeric',
    month: 'long',
    year: 'numeric'
  });

  const photoContainer = document.getElementById('news-detail-photo-container');
  if (newsItem.photo_path) {
    photoContainer.innerHTML = `<img src="${newsItem.photo_path}" alt="–§–æ—Ç–æ –Ω–æ–≤–æ—Å—Ç–∏">`;
    photoContainer.style.height = '';
    photoContainer.style.marginBottom = '';
  } else {
    photoContainer.innerHTML = '';
    photoContainer.style.height = '0';
    photoContainer.style.marginBottom = '0';
  }

  document.getElementById('news-detail-content').innerText = newsItem.content;
  showPage('news-detail');
}

async function showNewsDetail(id) {
  try {
    const cached = getCachedNews();
    if (cached) {
      const newsItem = cached.find(n => n.id === id);
      if (newsItem) {
        renderNewsDetail(newsItem);
        return;
      }
    }

    const response = await fetch('/news');
    if (!response.ok) {
      throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤–æ—Å—Ç—å');
    }
    const news = await response.json();
    setCachedNews(news, response.headers.get('ETag'));
    const newsItem = news.find(n => n.id === id);
    if (newsItem) {
      renderNewsDetail(newsItem);
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–æ–≤–æ—Å—Ç–∏:', error);
    showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–æ–≤–æ—Å—Ç–∏');
  }
}

function copyPhone(phone) {
  navigator.clipboard.writeText(phone).then(() => {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    showNotification('–ù–æ–º–µ—Ä —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
  }).catch(() => {
    alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–º–µ—Ä');
  });
}

function openTelegram(username) {
  // –û—Ç–∫—Ä—ã–≤–∞–µ–º Telegram –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ
  const telegramUrl = `https://t.me/${username.replace('@', '')}`;
  window.open(telegramUrl, '_blank');
}

function showNotification(message) {
  // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--accent);
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 14px;
    z-index: 1000;
    animation: slideDown 0.3s ease-out;
  `;
  notification.innerText = message;
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.remove();
  }, 2000);
}

// –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –∞–Ω–∏–º–∞—Ü–∏–∏
const style = document.createElement('style');
style.innerText = `
  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateX(-50%) translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
  }
`;
document.head.appendChild(style);

// –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ–≤–æ—Å—Ç–∏ –∫–∞–∫ –º–æ–∂–Ω–æ —Ä–∞–Ω—å—à–µ
document.addEventListener('DOMContentLoaded', loadNews);

// ======================== –°–ò–°–¢–ï–ú–ê –†–ê–°–°–´–õ–û–ö ========================

// –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —Ä–∞—Å—Å—ã–ª–∫–∞—Ö
let selectedMailingUsers = new Map(); // { userId: userName }
let mailingAllUsers = []; // –í—Å–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
let mailingsSendNow = true; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–µ–π—á–∞—Å

function setMailingSendNow(value) {
  mailingsSendNow = value;
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª—å –∫–Ω–æ–ø–æ–∫
  const nowBtn = document.getElementById('send-now-btn');
  const laterBtn = document.querySelectorAll('[onclick="setMailingSendNow(false)"]')[0];
  
  if (value) {
    nowBtn.style.background = 'var(--accent)';
    if (laterBtn) laterBtn.style.background = 'var(--hint)';
    document.getElementById('mailing-schedule-container').style.display = 'none';
  } else {
    nowBtn.style.background = 'var(--hint)';
    if (laterBtn) laterBtn.style.background = 'var(--accent)';
    document.getElementById('mailing-schedule-container').style.display = 'block';
  }
}

function onMailingTargetTypeChange() {
  const targetType = document.getElementById('mailing-target-type').value;
  const idContainer = document.getElementById('mailing-target-id-container');
  const usersContainer = document.getElementById('mailing-users-container');
  
  // –°–∫—Ä—ã–≤–∞–µ–º –æ–±–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  idContainer.style.display = 'none';
  usersContainer.style.display = 'none';
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
  if (targetType === 'user') {
    usersContainer.style.display = 'block';
    clearMailingUserSelection(); // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≤—ã–±–æ—Ä
    // –í—Å–µ–≥–¥–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    loadMailingUsers();
  } else if (targetType === 'group' || targetType === 'direction' || targetType === 'tg_chat') {
    idContainer.style.display = 'block';
  }
}

async function loadMailingUsers() {
  try {
    console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —Ä–∞—Å—Å—ã–ª–æ–∫...');
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    const response = await fetch('/staff/search');
    if (!response.ok) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', response.status);
      document.getElementById('mailing-users-search-results').innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 12px;">‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ</p>';
      return;
    }
    
    const users = await response.json();
    console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', users.length);
    
    mailingAllUsers = users;
    displayMailingSearchResults(mailingAllUsers);
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
    document.getElementById('mailing-users-search-results').innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 12px;">‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏</p>';
  }
}

function searchMailingUsers() {
  const searchInput = document.getElementById('mailing-users-search');
  const search = searchInput.value.trim().toLowerCase();
  
  if (mailingAllUsers.length === 0) {
    console.log('–ù–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
    return;
  }
  
  if (search.length === 0) {
    displayMailingSearchResults(mailingAllUsers);
    return;
  }
  
  let filtered = [];
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏—â–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ —é–∑–µ—Ä–Ω–µ–π–º—É (—Å @)
  if (search.startsWith('@')) {
    // –ü–æ–∏—Å–∫ –ø–æ —é–∑–µ—Ä–Ω–µ–π–º—É
    const usernameQuery = search.substring(1).toLowerCase();
    filtered = mailingAllUsers.filter(u => 
      u.username && u.username.toLowerCase().includes(usernameQuery)
    );
  } else {
    // –ü–æ–∏—Å–∫ –ø–æ ID –∏–ª–∏ –∏–º–µ–Ω–∏
    filtered = mailingAllUsers.filter(u => 
      u.name.toLowerCase().includes(search) ||
      u.id.toString().includes(search) ||
      (u.telegram_id && u.telegram_id.toString().includes(search))
    );
  }
  
  if (filtered.length === 0) {
    document.getElementById('mailing-users-search-results').innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 12px;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
  } else {
    displayMailingSearchResults(filtered);
  }
}

function displayMailingSearchResults(users) {
  const resultsHtml = users.map(u => {
    const isSelected = selectedMailingUsers.has(u.id);
    const bgColor = isSelected ? 'var(--accent)' : 'var(--card)';
    const textColor = isSelected ? '#fff' : 'var(--text)';
    const borderColor = isSelected ? 'var(--accent)' : 'var(--border)';
    const safeName = u.name.replace(/'/g, "\\'").replace(/"/g, '\\"');
    
    return `
      <div style="padding: 10px 12px; cursor: pointer; background: ${bgColor}; color: ${textColor}; border-left: 4px solid ${borderColor}; margin-bottom: 8px; border-radius: 6px; transition: all 0.2s; hover-background: opacity(0.9);" onclick="toggleMailingUserSelection(${u.id}, '${safeName}')">
        <div style="font-weight: 600; font-size: 14px; display: flex; align-items: center; justify-content: space-between;">
          <span>${u.name}</span>
          ${isSelected ? '<span style="font-size: 16px;">‚úì</span>' : ''}
        </div>
        <div class="small" style="opacity: 0.8; margin-top: 3px; font-size: 12px;">ID: ${u.telegram_id}${u.username ? ` ‚Ä¢ @${u.username}` : ''}</div>
      </div>
    `;
  }).join('');
  
  document.getElementById('mailing-users-search-results').innerHTML = resultsHtml || '<p class="small" style="text-align: center; color: var(--hint); padding: 12px;">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>';
}

function clearMailingUserSelection() {
  selectedMailingUsers.clear();
  document.getElementById('mailing-selected-users').innerHTML = '<p class="small" style="color: var(--hint); width: 100%;">–í—ã–±—Ä–∞–Ω–æ: <span id="mailing-users-count">0</span></p>';
  document.getElementById('mailing-users-count').textContent = '0';
}

function toggleMailingUserSelection(userId, userName) {
  if (selectedMailingUsers.has(userId)) {
    selectedMailingUsers.delete(userId);
  } else {
    selectedMailingUsers.set(userId, userName);
  }
  
  updateMailingSelectedUsersDisplay();
  searchMailingUsers(); // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
}

function updateMailingSelectedUsersDisplay() {
  const container = document.getElementById('mailing-selected-users');
  const count = selectedMailingUsers.size;
  
  if (count === 0) {
    container.innerHTML = '<p class="small" style="color: var(--hint); width: 100%; text-align: center; padding: 8px 0;">–í—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: <span id="mailing-users-count" style="font-weight: 600; color: var(--accent);">0</span></p>';
    return;
  }
  
  let html = '<p class="small" style="color: var(--hint); width: 100%; text-align: center; padding: 8px 0; margin-bottom: 8px;">–í—ã–±—Ä–∞–Ω–æ: <span id="mailing-users-count" style="font-weight: 600; color: var(--accent);">' + count + '</span></p>';
  
  for (const [userId, userName] of selectedMailingUsers) {
    const safeName = userName.replace(/'/g, "\\'").replace(/"/g, '\\"');
    html += `
      <div style="background: var(--accent); color: white; padding: 8px 12px; border-radius: 20px; display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 500; box-shadow: 0 2px 4px rgba(233, 30, 99, 0.2);">
        <span>üë§ ${userName}</span>
        <span onclick="toggleMailingUserSelection(${userId}, '${safeName}')" style="cursor: pointer; font-weight: bold; opacity: 0.8; hover: opacity(1);">‚úï</span>
      </div>
    `;
  }
  
  container.innerHTML = html;
}


async function createMailing() {
  try {
    const name = document.getElementById('mailing-name').value.trim();
    const description = document.getElementById('mailing-description').value.trim();
    const purpose = document.getElementById('mailing-purpose').value.trim();
    const targetType = document.getElementById('mailing-target-type').value;
    
    if (!name) {
      showNotification('‚ùå –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏');
      return;
    }
    
    if (!purpose) {
      showNotification('‚ùå –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏');
      return;
    }
    
    if (!targetType) {
      showNotification('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º—É –æ—Ç–ø—Ä–∞–≤–∏—Ç—å');
      return;
    }
    
    // –ï—Å–ª–∏ –Ω–µ "–≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏", —Ç—Ä–µ–±—É–µ—Ç—Å—è ID
    let targetId = null;
    
    // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    if (targetType === 'user') {
      if (selectedMailingUsers.size === 0) {
        showNotification('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        return;
      }
      // –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç (–º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ)
      targetId = Array.from(selectedMailingUsers.keys()).join(',');
    } else if (targetType !== 'all') {
      // –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Ç—Ä–µ–±—É–µ—Ç—Å—è ID
      const targetIdInput = document.getElementById('mailing-target-id').value.trim();
      if (!targetIdInput) {
        showNotification('‚ùå –í–≤–µ–¥–∏—Ç–µ ID —Ü–µ–ª–∏');
        return;
      }
      targetId = parseInt(targetIdInput);
    }
    
    // –ï—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–∑–∂–µ, —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–∞—Ç–∞
    let scheduledAt = null;
    if (!mailingsSendNow) {
      const scheduledAtInput = document.getElementById('mailing-scheduled-at').value;
      if (!scheduledAtInput) {
        showNotification('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏');
        return;
      }
      // datetime-local –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–∫—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ "2026-01-23T19:11"
      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ ISO —Ñ–æ—Ä–º–∞—Ç, —Å–æ—Ö—Ä–∞–Ω—è—è –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      const [datePart, timePart] = scheduledAtInput.split('T');
      scheduledAt = `${datePart}T${timePart}:00`;  // –î–æ–±–∞–≤–ª—è–µ–º —Å–µ–∫—É–Ω–¥—ã –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
    }
    
    // –ü–æ–ª—É—á–∞–µ–º ID —Å–æ–∑–¥–∞—Ç–µ–ª—è –∏–∑ localStorage –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∏–º–µ—Ä
    const staffId = localStorage.getItem('staff_id') || 1;
    
    const payload = {
      creator_id: parseInt(staffId),
      name: name,
      description: description || null,
      purpose: purpose,
      target_type: targetType,
      target_id: targetId,
      send_now: mailingsSendNow,
      scheduled_at: scheduledAt
    };
    
    const response = await fetch('/mailings', {
      method: 'POST',
      headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
      body: JSON.stringify(payload)
    });
    
    if (!response.ok) {
      const error = await response.json();
      showNotification('‚ùå ' + (error.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ä–∞—Å—Å—ã–ª–∫–∏'));
      return;
    }
    
    showNotification('‚úÖ –†–∞—Å—Å—ã–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ!');
    
    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
    document.getElementById('mailing-name').value = '';
    clearMailingUserSelection();
    document.getElementById('mailing-description').value = '';
    document.getElementById('mailing-purpose').value = '';
    document.getElementById('mailing-target-type').value = '';
    document.getElementById('mailing-target-id').value = '';
    document.getElementById('mailing-scheduled-at').value = '';
    document.getElementById('mailing-users-search').value = '';
    document.getElementById('mailing-users-search-results').innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 12px;">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Ä–∞—Å—Å—ã–ª–∫–∏ "–í—ã–±—Ä–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏" –¥–ª—è –ø–æ–∏—Å–∫–∞</p>';
    
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ —Å–ø–∏—Å–∫—É —Ä–∞—Å—Å—ã–ª–æ–∫
    setTimeout(() => {
      goBack();
      loadMailings();
    }, 1000);
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ä–∞—Å—Å—ã–ª–∫–∏:', error);
    showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ä–∞—Å—Å—ã–ª–∫–∏');
  }
}

async function loadMailings() {
  try {
    const response = await fetch('/mailings', {
      headers: getAuthHeaders()
    });
    if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
    
    const mailings = await response.json();
    const container = document.getElementById('mailings-container');
    
    if (mailings.length === 0) {
      container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">–†–∞—Å—Å—ã–ª–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
      return;
    }
    
    const statusLabels = {
      'pending': '‚è≥ –ù–∞ –æ–∂–∏–¥–∞–Ω–∏–∏',
      'scheduled': 'üìÖ –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞',
      'sending': 'üì§ –í –ø—Ä–æ—Ü–µ—Å—Å–µ',
      'sent': '‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ',
      'failed': '‚ùå –û—à–∏–±–∫–∞',
      'cancelled': 'üö´ –û—Ç–º–µ–Ω–µ–Ω–æ'
    };
    
    const mailingTypeLabels = {
      'manual': 'üë§ –†—É—á–Ω–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞',
      'automatic': 'ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞'
    };
    
    let html = '';
    for (const m of mailings) {
      const statusLabel = statusLabels[m.status] || m.status;
      const mailingTypeLabel = mailingTypeLabels[m.mailing_type] || m.mailing_type;
      const sentTime = m.sent_at ? new Date(m.sent_at).toLocaleString('ru-RU') : '‚Äî';
      const scheduledTime = m.scheduled_at ? new Date(m.scheduled_at).toLocaleString('ru-RU') : '‚Äî';
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞—Å—Å—ã–ª–æ–∫ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "pending"
      const sendButtonHtml = m.status === 'pending' ? `
        <button class="button small" style="width: 100%; margin-top: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);" onclick="sendMailingNow(${m.mailing_id})">
          üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–µ–π—á–∞—Å
        </button>
      ` : '';
      
      html += `
        <div class="card">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
            <h4 style="margin: 0;">${m.name}</h4>
            <span class="small" style="background: ${m.mailing_type === 'automatic' ? '#4CAF50' : '#2196F3'}; color: white; padding: 4px 10px; border-radius: 12px; font-weight: 500;">${mailingTypeLabel}</span>
          </div>
          <p class="small" style="color: var(--hint); margin: 8px 0;">
            <strong>–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:</strong> ${m.purpose}
          </p>
          <p class="small" style="color: var(--hint); margin: 8px 0;">
            <strong>–°—Ç–∞—Ç—É—Å:</strong> ${statusLabel}
          </p>
          <p class="small" style="color: var(--hint); margin: 8px 0;">
            <strong>–ö–æ–º—É:</strong> ${m.target_type} ${m.target_id ? '(ID: ' + m.target_id + ')' : ''}
          </p>
          ${m.description ? '<p class="small" style="color: var(--hint); margin: 8px 0; font-style: italic;">' + m.description + '</p>' : ''}
          <p class="small" style="color: var(--hint); margin: 8px 0; border-top: 1px solid var(--border); padding-top: 8px; margin-top: 8px;">
            –°–æ–∑–¥–∞–Ω–∞: ${new Date(m.created_at).toLocaleString('ru-RU')}<br>
            ${m.sent_at ? '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞: ' + sentTime + '<br>' : ''}
            ${m.scheduled_at && !m.sent_at ? '–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞: ' + scheduledTime : ''}
          </p>
          ${sendButtonHtml}
        </div>
      `;
    }
    
    container.innerHTML = html;
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä–∞—Å—Å—ã–ª–æ–∫:', error);
    document.getElementById('mailings-container').innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ</p>';
  }
}

async function sendMailingNow(mailingId) {
  try {
    const response = await fetch(`/mailings/${mailingId}/send`, {
      method: 'POST',
      headers: getAuthHeaders({ 'Content-Type': 'application/json' })
    });
    
    const data = await response.json();
    
    if (response.ok || response.status === 206) {
      showNotification('‚úÖ –†–∞—Å—Å—ã–ª–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!');
      setTimeout(() => {
        loadMailings();
      }, 1000);
    } else {
      showNotification('‚ùå ' + (data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ'));
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ä–∞—Å—Å—ã–ª–∫–∏:', error);
    showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ä–∞—Å—Å—ã–ª–∫–∏');
  }
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞—Å—Å—ã–ª–∫–∏ –ø—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
const originalShowPage = window.showPage;
window.showPage = function(pageId) {
  if (pageId === 'mailings') {
    loadMailings();
  }
  if (pageId === 'direction-create-form') {
    resetDirectionForm();
  }
  if (pageId === 'schedule-control') {
    initScheduleControl();
  }
  return originalShowPage(pageId);
};

/* ====== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ù–ê–ü–†–ê–í–õ–ï–ù–ò–Ø–ú–ò ====== */

async function generateDirectionUploadToken() {
  // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–æ—Ä–º—ã
  const title = document.getElementById('direction-title').value.trim();
  const description = document.getElementById('direction-description').value.trim();
  const price = document.getElementById('direction-price').value.trim();
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
  if (!title) {
    showDirectionError('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è');
    return;
  }
  if (!description) {
    showDirectionError('–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è');
    return;
  }
  if (!price || isNaN(price) || parseInt(price) <= 0) {
    showDirectionError('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ü–µ–Ω—É');
    return;
  }
  
  // –ü–æ–ª—É—á–∞–µ–º Telegram ID –∞–¥–º–∏–Ω–∞
  const telegramUserId = tg.initDataUnsafe?.user?.id;
  if (!telegramUserId) {
    showDirectionError('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å ID –∏–∑ Telegram');
    return;
  }
  
  try {
    // –°–æ–∑–¥–∞–µ–º —Å–µ—Å—Å–∏—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
    const response = await fetch('/api/directions/create-session', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        telegram_user_id: telegramUserId,
        title: title,
        description: description,
        base_price: parseInt(price)
      })
    });
    
    const data = await response.json();
    
    if (!response.ok) {
      showDirectionError(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–µ—Å—Å–∏–∏');
      return;
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –≤ localStorage
    localStorage.setItem('direction_session_token', data.session_token);
    localStorage.setItem('direction_session_id', data.session_id);
    
    const token = data.session_token;
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
    navigator.clipboard.writeText(token).catch(() => {
      // –ï—Å–ª–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ - –Ω–∏—á–µ–≥–æ —Å—Ç—Ä–∞—à–Ω–æ–≥–æ
    });
    
    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –±–æ—Ç–∞ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º session_token
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—ã—á–Ω—É—é https —Å—Å—ã–ª–∫—É, –∫–æ—Ç–æ—Ä—É—é tg.openLink –æ—Ç–∫—Ä–æ–µ—Ç –≤ Telegram –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
    const botUsername = 'dance_studio_tester_bot';
    const botLink = `https://t.me/${botUsername}?start=upload_${token}`;
    
    console.log('–û—Ç–∫—Ä—ã–≤–∞–µ–º –±–æ—Ç–∞ —Å —Å—Å—ã–ª–∫–æ–π:', botLink);
    
    // –û—Ç–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ Telegram Web App API
    // tg.openLink() –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫—Ä–æ–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ Telegram –µ—Å–ª–∏ –æ–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
    try {
      tg.openLink(botLink);
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
      showDirectionSuccess('‚úÖ –ë–æ—Ç –æ—Ç–∫—Ä—ã—Ç! –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é.');
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–∫–∏
      checkDirectionPhotoStatus(token);
    } catch (err) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –±–æ—Ç–∞:', err);
      showDirectionError('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
    }
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞:', error);
    showDirectionError('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
  }
}

async function checkDirectionPhotoStatus(token) {
  try {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
    const checkInterval = setInterval(async () => {
      try {
        const response = await fetch(`/api/directions/upload-complete/${token}`);
        
        if (response.ok) {
          const data = await response.json();
          
          if (data.status === 'photo_received') {
            clearInterval(checkInterval);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            document.getElementById('direction-photo-status').innerHTML = 
              '<p style="margin: 0; color: #4CAF50; font-size: 14px;">‚úÖ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞</p>';
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É —Å–æ–∑–¥–∞–Ω–∏—è
            document.getElementById('direction-create-btn').style.opacity = '1';
            document.getElementById('direction-create-btn').disabled = false;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è
            localStorage.setItem('direction_upload_token', token);
            
            showDirectionSuccess('–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞! –¢–µ–ø–µ—Ä—å –Ω–∞–∂–º–∏—Ç–µ "–°–æ–∑–¥–∞—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ"');
          }
        }
      } catch (error) {
        // –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ - –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø—Ä–æ–≤–µ—Ä—è—Ç—å
      }
    }, 1000);
    
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç
    setTimeout(() => clearInterval(checkInterval), 300000);
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞—Ç—É—Å–∞:', error);
  }
}

async function createDirection() {
  const token = localStorage.getItem('direction_upload_token');
  
  if (!token) {
    showDirectionError('–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é —á–µ—Ä–µ–∑ –±–æ—Ç–∞.');
    return;
  }
  
  try {
    const response = await fetch('/api/directions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        session_token: token,
        is_popular: 0
      })
    });
    
    const data = await response.json();
    
    if (!response.ok) {
      showDirectionError(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è');
      return;
    }
    
    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É –∏ localStorage
    resetDirectionForm();
    localStorage.removeItem('direction_upload_token');
    localStorage.removeItem('direction_session_token');
    localStorage.removeItem('direction_session_id');
    
    showDirectionSuccess(`‚úÖ –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ "${data.title}" —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ!`);
    
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –º–µ–Ω—é
    setTimeout(() => {
      goBack();
    }, 2000);
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞:', error);
    showDirectionError('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
  }
}

function resetDirectionForm() {
  document.getElementById('direction-title').value = '';
  document.getElementById('direction-description').value = '';
  document.getElementById('direction-price').value = '';
  document.getElementById('direction-photo-status').innerHTML = 
    '<p style="margin: 0; color: var(--hint); font-size: 14px;">‚ùå –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞</p>';
  document.getElementById('direction-create-btn').disabled = true;
  document.getElementById('direction-create-btn').style.opacity = '0.5';
  document.getElementById('direction-error-msg').style.display = 'none';
  document.getElementById('direction-success-msg').style.display = 'none';
  localStorage.removeItem('direction_upload_token');
}

function showDirectionError(message) {
  const errorDiv = document.getElementById('direction-error-msg');
  document.getElementById('direction-error-text').textContent = message;
  errorDiv.style.display = 'block';
  
  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫
  setTimeout(() => {
    errorDiv.style.display = 'none';
  }, 5000);
}

function showDirectionSuccess(message) {
  const successDiv = document.getElementById('direction-success-msg');
  document.getElementById('direction-success-text').textContent = message;
  successDiv.style.display = 'block';
  
  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫
  setTimeout(() => {
    successDiv.style.display = 'none';
  }, 5000);
}

/* ====== –ó–ê–ì–†–£–ó–ö–ê –ò –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –ù–ê–ü–†–ê–í–õ–ï–ù–ò–ô ====== */

let currentDirectionTab = 'active'; // –¢–µ–∫—É—â–∞—è –∞–∫—Ç–∏–≤–Ω–∞—è –≤–∫–ª–∞–¥–∫–∞

async function loadDirections() {
  try {
    const response = await fetch('/api/directions/manage');
    const directions = await response.json();
    
    // –†–∞–∑–¥–µ–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –∞—Ä—Ö–∏–≤–Ω—ã–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    const activeDirections = directions.filter(d => d.status === 'active');
    const archivedDirections = directions.filter(d => d.status !== 'active');
    
    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–µ–∫—É—â—É—é –≤–∫–ª–∞–¥–∫—É
    renderDirections(currentDirectionTab === 'active' ? activeDirections : archivedDirections);
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π:', error);
    const container = document.getElementById('directions-groups-container');
    container.innerHTML = '<p class="small" style="text-align: center; color: #c62828; padding: 20px;">‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ</p>';
  }
}

function renderDirections(directions) {
  const container = document.getElementById('directions-groups-container');
  
  if (!directions || directions.length === 0) {
    const emptyText = currentDirectionTab === 'active' ? '–ê–∫—Ç–∏–≤–Ω—ã—Ö –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π –Ω–µ—Ç' : '–ê—Ä—Ö–∏–≤ –ø—É—Å—Ç';
    container.innerHTML = `<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">üì≠ ${emptyText}</p>`;
    return;
  }
  
  let html = '';
  
  directions.forEach(direction => {
    const statusColor = direction.status === 'active' ? '#4CAF50' : '#ff9800';
    const statusText = direction.status === 'active' ? '‚úÖ –ê–∫—Ç–∏–≤–Ω–æ–µ' : '‚è∏Ô∏è –ù–µ–∞–∫—Ç–∏–≤–Ω–æ–µ';
    const popularBadge = direction.is_popular ? '‚≠ê –ü–æ–ø—É–ª—è—Ä–Ω–æ–µ' : '';
    
    const imageHtml = direction.image_path 
      ? `<img src="${direction.image_path}" style="width: 100%; height: 120px; object-fit: cover; border-radius: 8px; margin-bottom: 12px;">`
      : `<div style="width: 100%; height: 120px; background: #f0f0f0; border-radius: 8px; margin-bottom: 12px; display: flex; align-items: center; justify-content: center; color: var(--hint);">üì∏ –ù–µ—Ç —Ñ–æ—Ç–æ</div>`;
    
    html += `
      <div class="card" style="margin-bottom: 12px; border-left: 4px solid ${statusColor}; position: relative;">
        ${imageHtml}
        <h4 style="margin: 0 0 8px 0;">${direction.title}</h4>
        <p style="font-size: 13px; color: var(--hint); margin: 0 0 8px 0; line-height: 1.4;">${direction.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
        
        <div style="display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap;">
          <span style="background: #f0f0f0; padding: 4px 8px; border-radius: 4px; font-size: 12px;">üí∞ ${direction.base_price} ‚ÇΩ</span>
          <span style="background: #f0f0f0; padding: 4px 8px; border-radius: 4px; font-size: 12px; color: ${statusColor};">${statusText}</span>
          ${popularBadge ? `<span style="background: #fff3cd; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${popularBadge}</span>` : ''}
        </div>
        
        <div style="font-size: 11px; color: var(--hint); margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border);">
          –°–æ–∑–¥–∞–Ω–æ: ${new Date(direction.created_at).toLocaleDateString('ru-RU')}
        </div>
        
        <div style="display: flex; gap: 8px; margin-top: 8px; align-items: center; justify-content: space-between;">
          <button class="save-btn" style="flex: 0 0 calc(100% - 48px); height: 40px; padding: 8px; font-size: 12px; background: #2196F3; border-radius: 8px;" onclick="editDirection(${direction.direction_id})">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
          <button class="save-btn" style="width: 40px; height: 40px; padding: 0; font-size: 18px; background: #ff9800; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;" onclick="archiveDirection(${direction.direction_id})">üì¶</button>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

function switchDirectionTab(tab) {
  currentDirectionTab = tab;
  
  const activeTabBtn = document.getElementById('active-tab');
  const archivedTabBtn = document.getElementById('archived-tab');
  const indicator = document.querySelector('.tab-indicator');
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–≤–µ—Ç–∞ —Ç–µ–∫—Å—Ç–∞ –≤–∫–ª–∞–¥–æ–∫
  activeTabBtn.style.color = tab === 'active' ? '#2196F3' : 'var(--hint)';
  archivedTabBtn.style.color = tab === 'archived' ? '#2196F3' : 'var(--hint)';
  
  // –ê–Ω–∏–º–∏—Ä—É–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
  const activeTab = tab === 'active' ? activeTabBtn : archivedTabBtn;
  const tabWidth = activeTab.offsetWidth;
  const tabLeft = activeTab.offsetLeft;
  
  indicator.style.width = tabWidth + 'px';
  indicator.style.transform = `translateX(${tabLeft}px)`;
  
  // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
  loadDirections();
}

function setDirectionEditLocked(locked) {
  window.directionEditLocked = locked;
  const editableFields = document.querySelectorAll('.direction-editable');
  const editPage = document.getElementById('direction-edit-form');

  editableFields.forEach(el => {
    if (el.tagName === 'BUTTON') {
      el.disabled = locked;
      el.style.opacity = locked ? '0.5' : '1';
      el.style.pointerEvents = locked ? 'none' : 'auto';
    } else {
      el.disabled = locked;
    }
  });

  const lockBtn = document.getElementById('direction-edit-lock-btn');
  const lockHint = document.getElementById('direction-edit-lock-hint');
  if (editPage) {
    if (locked) editPage.classList.add('direction-locked');
    else editPage.classList.remove('direction-locked');
  }
  if (lockBtn && lockHint) {
    if (locked) {
      lockBtn.textContent = 'üîì';
      lockBtn.title = '–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ';
      lockHint.textContent = '–ü–æ–ª—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Å–ª—É—á–∞–π–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π.';
    } else {
      lockBtn.textContent = 'üîí';
      lockBtn.title = '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ';
      lockHint.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ. –ù–µ –∑–∞–±—É–¥—å—Ç–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è.';
    }
  }
}

function toggleDirectionEditLock() {
  setDirectionEditLocked(!window.directionEditLocked);
}

function editDirection(directionId) {
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö
  window.currentEditDirectionId = directionId;
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
  fetch(`/api/directions/${directionId}`)
    .then(r => r.json())
    .then(direction => {
      // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏
      document.getElementById('edit-direction-title').value = direction.title || '';
      document.getElementById('edit-direction-description').value = direction.description || '';
      document.getElementById('edit-direction-price').value = direction.base_price || '';
      document.getElementById('edit-direction-status').value = direction.status || 'active';
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
      if (direction.image_path) {
        const photoDiv = document.getElementById('edit-direction-photo-preview');
        photoDiv.innerHTML = `<img src="${direction.image_path}" style="width: 100%; height: 100%; object-fit: cover;">`;
      }
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –≥—Ä—É–ø–ø—ã
      loadDirectionGroups();
      
      // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
      showPage('direction-edit-form');
      setDirectionEditLocked(true);
    })
    .catch(err => {
      alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö: ' + err.message);
    });
}

function loadDirectionGroups() {
  const directionId = window.currentEditDirectionId;
  const groupsList = document.getElementById('edit-direction-groups-list');
  if (!directionId || !groupsList) return;

  groupsList.innerHTML = `<p style="text-align: center; color: var(--hint); padding: 12px; margin: 0;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä—É–ø–ø...</p>`;

  fetch(`/api/directions/${directionId}/groups`)
    .then(async groupsRes => {
      if (!groupsRes.ok) {
        const err = await groupsRes.json();
        throw new Error(err.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≥—Ä—É–ø–ø—ã');
      }
      const groups = await groupsRes.json();

      // –†–µ–Ω–¥–µ—Ä–∏–º –≥—Ä—É–ø–ø—ã
      if (!groups.length) {
        groupsList.innerHTML = `<p style="text-align: center; color: var(--hint); padding: 12px; margin: 0;">üì≠ –ì—Ä—É–ø–ø –ø–æ–∫–∞ –Ω–µ—Ç</p>`;
        return;
      }

      let html = '';
      groups.forEach(g => {
        html += `
          <div class="card" style="margin-bottom: 8px; border-left: 4px solid #4CAF50;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
              <div style="font-weight: 600; flex: 1;">${g.name}</div>
              <button class="lock-btn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≥—Ä—É–ø–ø—É" onclick="openEditGroupPage(${g.id});">‚úèÔ∏è</button>
            </div>
            <div class="small" style="margin-bottom: 6px;">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å: <b>${g.teacher_name || '‚Äî'}</b></div>
            <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 6px;">
              <span style="background: #f0f0f0; padding: 4px 8px; border-radius: 4px; font-size: 12px;">üë∂ ${g.age_group}</span>
              <span style="background: #f0f0f0; padding: 4px 8px; border-radius: 4px; font-size: 12px;">üë• ${g.max_students} —É—á–µ–Ω–∏–∫–æ–≤</span>
              <span style="background: #f0f0f0; padding: 4px 8px; border-radius: 4px; font-size: 12px;">‚è±Ô∏è ${g.duration_minutes} –º–∏–Ω</span>
              ${g.lessons_per_week ? `<span style="background: #f0f0f0; padding: 4px 8px; border-radius: 4px; font-size: 12px;">üìÜ ${g.lessons_per_week} –≤ –Ω–µ–¥–µ–ª—é</span>` : ''}
            </div>
            <div class="small">${g.description || '–û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ —É–∫–∞–∑–∞–Ω–æ'}</div>
          </div>
        `;
      });
      groupsList.innerHTML = html;
    })
    .catch(err => {
      groupsList.innerHTML = `<p style="text-align: center; color: #c62828; padding: 12px; margin: 0;">‚ùå ${err.message}</p>`;
    });
}

function loadGroupTeachers() {
  const results = document.getElementById('group-teacher-search-results');
  if (!results) return;

  results.innerHTML = `<p class="small" style="text-align: center; color: var(--hint); padding: 12px 0;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π...</p>`;

  fetch('/staff/list/teachers')
    .then(async res => {
      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π');
      }
      return res.json();
    })
    .then(teachers => {
      window.groupTeachers = teachers || [];
      displayGroupTeacherResults(window.groupTeachers);
    })
    .catch(err => {
      results.innerHTML = `<p class="small" style="text-align: center; color: var(--hint); padding: 12px 0;">‚ùå ${err.message}</p>`;
    });
}

function searchGroupTeacher() {
  const input = document.getElementById('group-teacher-search');
  const query = (input?.value || '').trim().toLowerCase();
  const results = document.getElementById('group-teacher-search-results');
  if (!results) return;

  if (!window.groupTeachers) {
    results.innerHTML = `<p class="small" style="text-align: center; color: var(--hint); padding: 12px 0;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π...</p>`;
    return;
  }

  if (!query) {
    displayGroupTeacherResults(window.groupTeachers);
    return;
  }

  const filtered = window.groupTeachers.filter(t => {
    const name = (t.name || '').toLowerCase();
    const username = (t.username || '').toLowerCase();
    const idStr = String(t.id || '');
    return name.includes(query) || username.includes(query) || idStr.includes(query);
  });

  if (!filtered.length) {
    results.innerHTML = `<p class="small" style="text-align: center; color: var(--hint); padding: 12px 0;">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>`;
    return;
  }

  displayGroupTeacherResults(filtered);
}

function displayGroupTeacherResults(teachers) {
  const results = document.getElementById('group-teacher-search-results');
  if (!results) return;

  const html = teachers.map(t => {
    const safeName = (t.name || '‚Äî').replace(/'/g, "\\'").replace(/"/g, '\\"');
    const safeUsername = (t.username || '').replace(/'/g, "\\'").replace(/"/g, '\\"');
    const isSelected = window.selectedGroupTeacher && window.selectedGroupTeacher.id === t.id;
    const borderColor = isSelected ? '#1976d2' : 'var(--accent)';
    const bgColor = isSelected ? '#e3f2fd' : 'var(--bg)';
    return `
      <div class="card" id="group-teacher-card-${t.id}" style="margin-bottom: 8px; cursor: pointer; background: ${bgColor}; border-left: 4px solid ${borderColor}; transition: all 0.2s;" onclick="selectGroupTeacher(${t.id}, '${safeName}', '${safeUsername}')">
        <div style="font-weight: 600; font-size: 14px;">
          ${t.name || '‚Äî'}
          ${isSelected ? ' ‚úÖ' : ''}
        </div>
        <div style="font-size: 12px; color: var(--hint); margin-top: 2px;">ID: ${t.id}${t.username ? ` ‚Ä¢ @${t.username}` : ''}</div>
      </div>
    `;
  }).join('');

  results.innerHTML = html || '<p class="small" style="text-align: center; color: var(--hint); padding: 12px 0;">–ù–µ—Ç –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π</p>';
}

function selectGroupTeacher(id, name, username) {
  window.selectedGroupTeacher = { id, name, username };
  displayGroupTeacherResults(window.groupTeachers || []);
}

function openCreateGroupPage() {
  if (!window.currentEditDirectionId) {
    alert('‚ùå –°–Ω–∞—á–∞–ª–∞ –æ—Ç–∫—Ä–æ–π—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
    return;
  }
  showPage('direction-group-create');
  window.selectedGroupTeacher = null;
  document.getElementById('group-teacher-search').value = '';
  document.getElementById('edit-direction-group-lessons').value = '';
  loadGroupTeachers();
}

function setDirectionGroupMessage(text, isError) {
  const msg = document.getElementById('edit-direction-group-msg');
  if (!msg) return;
  msg.style.display = 'block';
  msg.style.background = isError ? '#ffebee' : '#e8f5e9';
  msg.style.color = isError ? '#c62828' : '#2e7d32';
  msg.textContent = text;
  setTimeout(() => {
    msg.style.display = 'none';
  }, 4000);
}

function createDirectionGroup() {
  const directionId = window.currentEditDirectionId;
  if (!directionId) {
    setDirectionGroupMessage('‚ùå ID –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω', true);
    return;
  }

  const name = document.getElementById('edit-direction-group-name').value.trim();
  const teacherId = window.selectedGroupTeacher ? window.selectedGroupTeacher.id : null;
  const ageGroup = document.getElementById('edit-direction-group-age').value.trim();
  const maxStudents = document.getElementById('edit-direction-group-max').value;
  const durationMinutes = document.getElementById('edit-direction-group-duration').value;
  const lessonsPerWeek = document.getElementById('edit-direction-group-lessons').value;
  const description = document.getElementById('edit-direction-group-desc').value.trim();

  if (!name || !teacherId || !ageGroup || !maxStudents || !durationMinutes) {
    setDirectionGroupMessage('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', true);
    return;
  }

  fetch(`/api/directions/${directionId}/groups`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      name,
      teacher_id: parseInt(teacherId, 10),
      age_group: ageGroup,
      max_students: parseInt(maxStudents, 10),
      duration_minutes: parseInt(durationMinutes, 10),
      lessons_per_week: lessonsPerWeek ? parseInt(lessonsPerWeek, 10) : null,
      description
    })
  })
    .then(async r => {
      const data = await r.json();
      if (!r.ok) throw new Error(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É');
      return data;
    })
    .then(() => {
      document.getElementById('edit-direction-group-name').value = '';
      document.getElementById('edit-direction-group-age').value = '';
      document.getElementById('edit-direction-group-max').value = '';
      document.getElementById('edit-direction-group-duration').value = '';
      document.getElementById('edit-direction-group-lessons').value = '';
      document.getElementById('edit-direction-group-desc').value = '';
      document.getElementById('group-teacher-search').value = '';
      window.selectedGroupTeacher = null;
      setDirectionGroupMessage('‚úÖ –ì—Ä—É–ø–ø–∞ —Å–æ–∑–¥–∞–Ω–∞', false);
      loadDirectionGroups();
      setTimeout(() => {
        goBack();
      }, 600);
    })
    .catch(err => {
      setDirectionGroupMessage('‚ùå ' + err.message, true);
    });
}

function setEditGroupMessage(text, isError) {
  const msg = document.getElementById('edit-group-msg');
  if (!msg) return;
  msg.style.display = 'block';
  msg.style.background = isError ? '#ffebee' : '#e8f5e9';
  msg.style.color = isError ? '#c62828' : '#2e7d32';
  msg.textContent = text;
  setTimeout(() => {
    msg.style.display = 'none';
  }, 4000);
}

function loadEditGroupTeachers() {
  const results = document.getElementById('edit-group-teacher-search-results');
  if (!results) return;

  results.innerHTML = `<p class="small" style="text-align: center; color: var(--hint); padding: 12px 0;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π...</p>`;

  fetch('/staff/list/teachers')
    .then(async res => {
      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π');
      }
      return res.json();
    })
    .then(teachers => {
      window.editGroupTeachers = teachers || [];
      // –ü—Ä–µ–¥–≤—ã–±–æ—Ä –ø–æ teacher_id
      if (window.editGroupPreselectTeacherId) {
        const selected = window.editGroupTeachers.find(t => t.id === window.editGroupPreselectTeacherId);
        if (selected) {
          window.selectedEditGroupTeacher = { id: selected.id, name: selected.name, username: selected.username };
        }
      }
      displayEditGroupTeacherResults(window.editGroupTeachers);
    })
    .catch(err => {
      results.innerHTML = `<p class="small" style="text-align: center; color: var(--hint); padding: 12px 0;">‚ùå ${err.message}</p>`;
    });
}

function searchEditGroupTeacher() {
  const input = document.getElementById('edit-group-teacher-search');
  const query = (input?.value || '').trim().toLowerCase();
  const results = document.getElementById('edit-group-teacher-search-results');
  if (!results) return;

  if (!window.editGroupTeachers) {
    results.innerHTML = `<p class="small" style="text-align: center; color: var(--hint); padding: 12px 0;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π...</p>`;
    return;
  }

  if (!query) {
    displayEditGroupTeacherResults(window.editGroupTeachers);
    return;
  }

  const filtered = window.editGroupTeachers.filter(t => {
    const name = (t.name || '').toLowerCase();
    const username = (t.username || '').toLowerCase();
    const idStr = String(t.id || '');
    return name.includes(query) || username.includes(query) || idStr.includes(query);
  });

  if (!filtered.length) {
    results.innerHTML = `<p class="small" style="text-align: center; color: var(--hint); padding: 12px 0;">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>`;
    return;
  }

  displayEditGroupTeacherResults(filtered);
}

function displayEditGroupTeacherResults(teachers) {
  const results = document.getElementById('edit-group-teacher-search-results');
  if (!results) return;

  const html = teachers.map(t => {
    const safeName = (t.name || '‚Äî').replace(/'/g, "\\'").replace(/"/g, '\\"');
    const safeUsername = (t.username || '').replace(/'/g, "\\'").replace(/"/g, '\\"');
    const isSelected = window.selectedEditGroupTeacher && window.selectedEditGroupTeacher.id === t.id;
    const borderColor = isSelected ? '#1976d2' : 'var(--accent)';
    const bgColor = isSelected ? '#e3f2fd' : 'var(--bg)';
    return `
      <div class="card" id="edit-group-teacher-card-${t.id}" style="margin-bottom: 8px; cursor: pointer; background: ${bgColor}; border-left: 4px solid ${borderColor}; transition: all 0.2s;" onclick="selectEditGroupTeacher(${t.id}, '${safeName}', '${safeUsername}')">
        <div style="font-weight: 600; font-size: 14px;">
          ${t.name || '‚Äî'}
          ${isSelected ? ' ‚úÖ' : ''}
        </div>
        <div style="font-size: 12px; color: var(--hint); margin-top: 2px;">ID: ${t.id}${t.username ? ` ‚Ä¢ @${t.username}` : ''}</div>
      </div>
    `;
  }).join('');

  results.innerHTML = html || '<p class="small" style="text-align: center; color: var(--hint); padding: 12px 0;">–ù–µ—Ç –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π</p>';
}

function selectEditGroupTeacher(id, name, username) {
  window.selectedEditGroupTeacher = { id, name, username };
  displayEditGroupTeacherResults(window.editGroupTeachers || []);
}

function openEditGroupPage(groupId) {
  window.currentEditGroupId = groupId;
  window.selectedEditGroupTeacher = null;
  window.editGroupPreselectTeacherId = null;

  try {
    showPage('direction-group-edit');
  } catch (err) {
    showNotification('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã');
    return;
  }
  const teacherSearch = document.getElementById('edit-group-teacher-search');
  if (teacherSearch) teacherSearch.value = '';

  fetch(`/api/groups/${groupId}`)
    .then(async r => {
      const data = await r.json();
      if (!r.ok) throw new Error(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≥—Ä—É–ø–ø—É');
      return data;
    })
    .then(group => {
      document.getElementById('edit-group-name').value = group.name || '';
      document.getElementById('edit-group-age').value = group.age_group || '';
      document.getElementById('edit-group-max').value = group.max_students || '';
      document.getElementById('edit-group-duration').value = group.duration_minutes || '';
      document.getElementById('edit-group-desc').value = group.description || '';
      document.getElementById('edit-group-lessons').value = group.lessons_per_week || '';
      window.editGroupPreselectTeacherId = group.teacher_id;
      loadEditGroupTeachers();
    })
    .catch(err => {
      setEditGroupMessage('‚ùå ' + err.message, true);
      showNotification('‚ùå ' + err.message);
    });
}

function saveGroupChanges() {
  const groupId = window.currentEditGroupId;
  if (!groupId) {
    setEditGroupMessage('‚ùå ID –≥—Ä—É–ø–ø—ã –Ω–µ –Ω–∞–π–¥–µ–Ω', true);
    return;
  }

  const name = document.getElementById('edit-group-name').value.trim();
  const teacherId = window.selectedEditGroupTeacher ? window.selectedEditGroupTeacher.id : null;
  const ageGroup = document.getElementById('edit-group-age').value.trim();
  const maxStudents = document.getElementById('edit-group-max').value;
  const durationMinutes = document.getElementById('edit-group-duration').value;
  const lessonsPerWeek = document.getElementById('edit-group-lessons').value;
  const description = document.getElementById('edit-group-desc').value.trim();

  if (!name || !teacherId || !ageGroup || !maxStudents || !durationMinutes) {
    setEditGroupMessage('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', true);
    return;
  }

  fetch(`/api/groups/${groupId}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      name,
      teacher_id: parseInt(teacherId, 10),
      age_group: ageGroup,
      max_students: parseInt(maxStudents, 10),
      duration_minutes: parseInt(durationMinutes, 10),
      lessons_per_week: lessonsPerWeek ? parseInt(lessonsPerWeek, 10) : null,
      description
    })
  })
    .then(async r => {
      const data = await r.json();
      if (!r.ok) throw new Error(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≥—Ä—É–ø–ø—É');
      return data;
    })
    .then(() => {
      setEditGroupMessage('‚úÖ –ì—Ä—É–ø–ø–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞', false);
      loadDirectionGroups();
      setTimeout(() => {
        goBack();
      }, 600);
    })
    .catch(err => {
      setEditGroupMessage('‚ùå ' + err.message, true);
    });
}

function saveDirectionChanges() {
  if (window.directionEditLocked) {
    alert('üîí –°–Ω–∞—á–∞–ª–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–π—Ç–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ.');
    return;
  }

  const directionId = window.currentEditDirectionId;
  if (!directionId) {
    alert('‚ùå ID –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω');
    return;
  }
  
  const title = document.getElementById('edit-direction-title').value.trim();
  const description = document.getElementById('edit-direction-description').value.trim();
  const price = document.getElementById('edit-direction-price').value;
  const status = document.getElementById('edit-direction-status').value;
  
  if (!title || !description || !price) {
    alert('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
    return;
  }
  
  fetch(`/api/directions/${directionId}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      title,
      description,
      base_price: parseFloat(price),
      status
    })
  })
    .then(r => r.json())
    .then(data => {
      alert('‚úÖ –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ');
      goBack();
      loadDirections();
    })
    .catch(err => alert('‚ùå –û—à–∏–±–∫–∞: ' + err.message));
}

function archiveDirection(directionId) {
  if (confirm('–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ?')) {
    fetch(`/api/directions/${directionId}`, { method: 'DELETE' })
      .then(r => r.json())
      .then(data => {
        alert('‚úÖ –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–æ');
        loadDirections();
      })
      .catch(err => alert('‚ùå –û—à–∏–±–∫–∞: ' + err.message));
  }
}

</script>
</body>
</html>
