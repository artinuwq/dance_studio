<!DOCTYPE html>

<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Dance Studio</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
/* ====== БАЗОВАЯ ТЕМНАЯ ПАЛИТРА В СТИЛЕ РЕФЕРЕНСА ====== */
:root {
  --bg: #0f0f0f;
  --card: #151515;
  --elevated: #1d1d1d;
  --border: #242424;
  --text: #f5f5f7;
  --hint: #9a9da6;
  --accent: #fe5815;
  --accent-soft: rgba(254, 88, 21, 0.12);
  --accent-strong: rgba(254, 88, 21, 0.22);
  --safe-top: 0px;
  --safe-bottom: 0px;
}

/* ====== БАЗА ====== */
* {
  box-sizing: border-box;
  font-family: "SF Pro Display", "SF Pro Text", -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
}

body {
  margin: 0;
  background: var(--bg);
  color: var(--text);
}

body.group-booking-open {
  overflow: hidden;
}

#schedule-grid-container {
  position: relative;
}

/* ====== HEADER ====== */
header {
  display: none;
}

.header-back {
  border: none;
  background: transparent;
  color: var(--accent);
  font-size: 22px;
  line-height: 1;
  padding: 4px 6px;
  cursor: pointer;
}

/* На мобильных используем системную кнопку Telegram */
body.tg-mobile .header-back {
  display: none;
}

.header-back:active {
  opacity: 0.6;
}

.header-center {
  flex: 1;
  text-align: center;
  pointer-events: none;
}

.header-center-title {
  font-size: 20px;
  font-weight: 700;
  color: var(--text);
}

.header-spacer {
  width: 32px;
  height: 32px;
}

/* ====== СТРАНИЦЫ ====== */
.page {
  display: none;
  padding: 16px;
  padding-bottom: calc(56px + var(--safe-bottom));
  padding-top: calc(16px + var(--safe-top));
}

.page.active {
  display: block;
}

/* Минимальная высота для страниц */
#staff {
  min-height: calc(100vh - 100px);
}

/* ====== КАРТОЧКИ ====== */
.card {
  background: var(--card);
  padding: 14px;
  border-radius: 14px;
  margin-bottom: 12px;
  border: 1px solid var(--border);
  box-shadow: 0 10px 26px rgba(0, 0, 0, 0.35);
  color: var(--text);
}

.home-welcome-card {
  text-align: center;
  margin-top: -30px;
}

.home-news-card {
  padding-top: 10px;
}

.home-news-card > h4 {
  margin: 0 0 8px 0;
}

.home-logo-wrap {
  margin: 0 0 8px;
}

.home-logo {
  width: min(100%, 380px);
  height: auto;
  display: block;
  margin: 0 auto;
  object-fit: contain;
}

.home-logo-standalone {
  margin-bottom: 6px;
}

/* Компактные секции на вкладке "Работа" */
.work-section {
  background: #1f1f1f;
  border: 1px solid #d5d5d5;
  box-shadow: none;
  padding: 12px;
  margin-bottom: 10px;
}
.work-section h4 {
  margin: 0 0 8px 0;
}

.payment-tabs-container {
  display: flex;
  gap: 8px;
  margin-bottom: 4px;
  border-bottom: 2px solid var(--border);
  position: relative;
}

.payment-tab-btn {
  flex: 1;
  padding: 12px;
  background: none;
  border: none;
  color: var(--hint);
  font-weight: bold;
  cursor: pointer;
}

.payment-tab-btn.active {
  color: var(--accent);
}

.payment-tab-indicator {
  position: absolute;
  bottom: -2px;
  left: 0;
  height: 2px;
  background: var(--accent);
  transition: transform 0.3s ease, width 0.3s ease;
}

#staff .work-section .save-btn {
  background: #1f1f1f !important;
  color: var(--text) !important;
  border: 2px solid var(--accent) !important;
  box-shadow: none !important;
}

#staff .work-section .save-btn:active {
  background: #262626 !important;
}

#profile .menu-item,
#profile-settings .menu-item,
#work-settings .menu-item,
#work-settings-other .menu-item {
  background: #1f1f1f;
  color: var(--text);
  border: 2px solid var(--accent);
  box-shadow: none;
}

#profile .menu-item:active,
#profile-settings .menu-item:active,
#work-settings .menu-item:active,
#work-settings-other .menu-item:active {
  background: #262626;
  opacity: 1;
}

#profile-info .save-btn,
#profile-abonements .save-btn,
#profile-booking-requests .save-btn,
#profile-settings .save-btn,
#display-settings .save-btn,
#work-settings-prices .save-btn {
  background: #1f1f1f !important;
  color: var(--text) !important;
  border: 2px solid var(--accent) !important;
  box-shadow: none !important;
}

#profile-info .save-btn:active,
#profile-abonements .save-btn:active,
#profile-booking-requests .save-btn:active,
#profile-settings .save-btn:active,
#display-settings .save-btn:active,
#work-settings-prices .save-btn:active {
  background: #262626 !important;
}

.menu-item {
  background: var(--card);
  padding: 14px;
  border-radius: 12px;
  margin-bottom: 10px;
  cursor: pointer;
  border: 1px solid var(--border);
  box-shadow: 0 8px 22px rgba(0, 0, 0, 0.28);
  color: var(--text);
}

.menu-item:active {
  opacity: 0.7;
}

/* ====== НИЖНЕЕ МЕНЮ ====== */
.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  min-height: 45px;
  height: auto;
  display: flex;
  align-items: center;
  background: rgba(12, 12, 12, 0.96);
  border-top: 1px solid var(--border);
  padding: 6px 8px calc(env(safe-area-inset-bottom) + 10px);
  box-sizing: border-box;
  z-index: 1000;
}

.nav-btn {
  flex: 1;
  text-align: center;
  padding: 4px 0;
  font-size: 12px;
  color: var(--hint);
  cursor: pointer;
  line-height: 1.3;
}

.nav-btn.active {
  color: var(--accent);
  font-weight: 700;
}

.nav-btn.hidden {
  width: 0;
  opacity: 0;
  pointer-events: none;
  overflow: hidden;
  flex: 0;
}

/* ====== ВКЛАДКИ С АНИМАЦИЕЙ ====== */
.nav-tab {
  transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1) !important;
}

.tabs-container {
  position: relative !important;
}

.tab-indicator {
  position: absolute;
  bottom: -2px;
  height: 3px;
  background: var(--accent);
  transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
}

/* ====== ПРОФИЛЬ ====== */
.profile {
  text-align: center;
}

.profile-account-info-card {
  padding: 10px 12px;
}

.profile-account-info-card h4 {
  margin: 0 0 6px;
}

.profile-account-info-card .small {
  margin: 3px 0;
  line-height: 1.3;
}

.avatar {
  width: 90px;
  height: 90px;
  border-radius: 50%;
  background: var(--card);
  margin: 0 auto 12px;
  overflow: hidden;
}

.avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* ====== ПАНЕЛЬ ПЕРСОНАЛА ====== */
.staff-info-panel {
  background: var(--card);
  padding: 14px;
  border-radius: 12px;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 12px;
}

.staff-avatar-small {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: var(--border);
  flex-shrink: 0;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
}

.staff-avatar-small img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.staff-info-text {
  flex: 1;
  text-align: left;
}

.staff-name {
  font-weight: 600;
  font-size: 15px;
  color: var(--text);
  margin: 0;
}

.staff-position {
  font-size: 13px;
  color: var(--hint);
  margin: 4px 0 0 0;
}

.staff-card-row {
  display: flex;
  gap: 12px;
  align-items: flex-start;
}

.staff-card-avatar {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background: #262626;
  color: #fff;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  flex-shrink: 0;
}

.staff-card-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

.staff-card-row {
  display: flex;
  gap: 12px;
  align-items: flex-start;
}

.staff-card-avatar {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background: #262626;
  color: #fff;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  flex-shrink: 0;
}

.staff-card-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}



/* ====== ТЕКСТ ====== */
.small {
  color: var(--hint);
  font-size: 14px;
}

/* ====== ДЕТАЛИ ГРУПП ====== */
.group-detail-grid {
  display: grid;
  gap: 6px;
}

.group-detail-row {
  display: flex;
  align-items: baseline;
  gap: 6px;
  font-size: 14px;
  line-height: 1.4;
}

.group-detail-row span {
  color: var(--hint);
  white-space: nowrap;
}

.group-detail-row div {
  font-weight: 600;
  color: var(--text);
}

/* ====== НАЗАД ====== */
.back {
  color: var(--accent);
  cursor: pointer;
  margin-bottom: 12px;
  display: inline-block;
}

/* ====== РАЗДЕЛ О СТУДИИ ====== */
.studio-section {
  background: transparent;
  padding: 0;
  border-radius: 0;
  border: none;
  box-shadow: none;
  margin-bottom: 0;
}

.section-item {
  background: var(--card);
  padding: 16px;
  border-radius: 16px;
  margin-bottom: 12px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: space-between;
  box-shadow: 0 10px 26px rgba(0, 0, 0, 0.3);
  border: 1px solid var(--border);
  transition: all 0.2s;
}

.section-item:active {
  opacity: 0.7;
  background: #111;
}

.section-item-left {
  display: flex;
  align-items: center;
  gap: 14px;
  flex: 1;
}

.section-item-icon {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  color: #ffffff;
  font-size: 24px;
  flex-shrink: 0;
  box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.06);
}

.section-icon--orange {
  background: #fe5815;
}

.section-icon--purple {
  background: #fe5815;
}

.section-icon--blue {
  background: #fe5815;
}

.section-icon--pink {
  background: #fe5815;
}

.section-item-text {
  text-align: left;
}

.section-item-title {
  font-weight: 700;
  font-size: 16px;
  margin: 0;
  color: var(--text);
}

.section-item-desc {
  font-size: 13px;
  color: var(--hint);
  margin: 6px 0 0 0;
}

.section-item-arrow {
  color: var(--text);
  font-size: 28px;
  font-weight: 700;
}

.section-title-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 8px;
  margin-bottom: 8px;
}

.individual-intro-card h3 {
  margin: 0 0 6px;
}

.individual-teacher-strip,
.individual-date-strip {
  display: flex;
  gap: 8px;
  overflow-x: auto;
  padding-bottom: 4px;
}

.individual-teacher-card {
  min-width: 130px;
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 10px;
  display: flex;
  flex-direction: column;
  gap: 6px;
  background: var(--card);
  cursor: pointer;
  transition: box-shadow 0.2s, border-color 0.2s;
}

.individual-teacher-card.selected {
  border-color: var(--accent);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
}

.individual-teacher-card:hover {
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
}

.individual-teacher-photo {
  width: 56px;
  height: 56px;
  border-radius: 12px;
  background: #262626;
  overflow: hidden;
  align-self: center;
  display: flex;
  align-items: center;
  justify-content: center;
}

.individual-teacher-photo img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

.individual-teacher-detail {
  margin-top: 12px;
  border-top: 1px solid var(--border);
  padding-top: 12px;
}

.individual-teacher-detail h4 {
  margin: 0;
}

.individual-date-strip {
  margin-top: 4px;
}

.individual-date-card {
  min-width: 72px;
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 10px 6px;
  text-align: center;
  cursor: pointer;
  background: var(--card);
  transition: border-color 0.2s, background 0.2s;
}

.individual-date-card.active {
  border-color: var(--accent);
  background: rgba(254, 88, 21, 0.12);
}

.booking-time-layout {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
  gap: 12px;
  margin-bottom: 8px;
}

.booking-time-column {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.booking-window-strip {
  min-height: 52px;
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 8px;
  background: var(--card);
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-bottom: 8px;
}

.individual-slot-grid,
.rental-slot-grid,
.rental-slot-strip {
  min-height: 90px;
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 8px;
  background: var(--card);
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}

.rental-slot-strip {
  min-height: 52px;
}

.individual-slot-card,
.rental-slot-card,
.booking-window-chip {
  border-radius: 12px;
  border: 1px solid var(--border);
  padding: 8px 10px;
  text-align: center;
  cursor: pointer;
  background: var(--card);
  transition: border-color 0.2s, box-shadow 0.2s;
}

.individual-slot-card,
.rental-slot-card {
  min-width: 100px;
}

.booking-window-chip {
  min-width: 134px;
  text-align: left;
}

.individual-slot-card.active,
.rental-slot-card.active,
.booking-window-chip.active {
  border-color: var(--accent);
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
}

.booking-selection-compact {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}

.booking-change-btn {
  border: 1px solid var(--border);
  background: transparent;
  color: var(--hint);
  border-radius: 10px;
  padding: 6px 10px;
  font-size: 12px;
  cursor: pointer;
}

.booking-change-btn:active {
  opacity: 0.8;
}

.individual-slot-duration-display {
  margin-top: 4px;
  font-weight: 600;
  color: var(--text);
}

.individual-booking-card {
  margin-bottom: 60px;
}

.individual-booking-footer {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.individual-booking-message {
  min-height: 20px;
  margin: 0;
  color: var(--text);
}

/* ====== КОНТАКТНАЯ ИНФОРМАЦИЯ ====== */
.contact-btn {
  background: var(--card);
  padding: 12px;
  border-radius: 12px;
  margin-bottom: 10px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: space-between;
  transition: all 0.2s;
  border: 1px solid var(--border);
  color: var(--text);
}

.contact-btn:active {
  opacity: 0.7;
  background: #111;
}

.contact-btn-content {
  display: flex;
  align-items: center;
  gap: 12px;
  flex: 1;
}

.contact-icon {
  font-size: 24px;
}

.contact-label {
  font-size: 12px;
  color: var(--hint);
  margin-bottom: 2px;
}

.contact-value {
  font-weight: 600;
  font-size: 14px;
  color: var(--text);
}

.contact-action {
  font-size: 12px;
  color: var(--accent);
  font-weight: 600;
  white-space: nowrap;
  margin-left: 8px;
}

/* ====== ФОРМЫ ====== */
.form-group {
  margin-bottom: 14px;
}

.form-group label {
  display: block;
  font-size: 12px;
  color: var(--hint);
  margin-bottom: 6px;
  font-weight: 600;
}

.form-input {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid var(--border);
  border-radius: 8px;
  font-size: 14px;
  font-family: inherit;
  background: var(--card);
  color: var(--text);
  box-sizing: border-box;
}

.form-input:focus {
  outline: none;
  border-color: var(--accent);
  background: var(--bg);
}

textarea.form-input {
  resize: vertical;
}

.rental-form-card {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.rental-form-row {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}

.rental-fieldset--wide {
  flex: 1 1 100%;
}

.rental-date-hint {
  margin: 6px 0 0;
  font-size: 12px;
  color: var(--hint);
}

.rental-fieldset {
  flex: 1;
  min-width: 180px;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.rental-booking-message {
  min-height: 20px;
  margin: 0;
  color: var(--text);
  font-size: 13px;
}

.rental-booking-message.error {
  color: #ffb3b3;
}

.rental-time-summary {
  margin: -4px 0 0;
  min-height: 18px;
  font-weight: 600;
  color: var(--text);
}

.rental-note {
  font-size: 13px;
  color: var(--hint);
}

.rental-occupancy-panel {
  display: flex;
  flex-direction: column;
  gap: 10px;
  padding: 8px 0;
}

.rental-occupancy-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 13px;
  text-transform: uppercase;
  letter-spacing: 0.02em;
  color: var(--hint);
}

.rental-occupancy-timeline {
  position: relative;
  height: 28px;
  border-radius: 14px;
  background: #1d1d1d;
  overflow: hidden;
  border: 1px solid rgba(255, 255, 255, 0.06);
}

.rental-occupancy-timeline::after {
  content: '';
  position: absolute;
  inset: 20% 0;
  border-top: 1px dashed rgba(0, 0, 0, 0.08);
  pointer-events: none;
}

.rental-occupancy-slot {
  position: absolute;
  top: 4px;
  bottom: 4px;
  border-radius: 10px;
  background: rgba(254, 88, 21, 0.28);
  border: 1px solid rgba(254, 88, 21, 0.9);
  transition: transform 0.2s;
}

.rental-occupancy-slot:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.18);
}

.rental-occupancy-list {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.rental-occupancy-debug {
  margin-top: 6px;
  font-size: 12px;
  color: #777;
}

.rental-occupancy-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 13px;
  padding: 6px 8px;
  border-radius: 10px;
  background: var(--card);
  border: 1px solid var(--border);
}

.rental-occupancy-item span {
  font-weight: 600;
}

.rental-occupancy-status {
  font-size: 11px;
  padding: 2px 8px;
  border-radius: 999px;
  text-transform: uppercase;
  letter-spacing: 0.04em;
  color: var(--accent);
  border: 1px solid rgba(254, 88, 21, 0.35);
}

.save-btn {
  width: 100%;
  padding: 12px;
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.save-btn:active {
  opacity: 0.8;
  transform: scale(0.98);
}

.save-btn {
  text-align: center;
  white-space: normal;
  word-wrap: break-word;
  display: flex;
  justify-content: center;
  align-items: center;
}

/* ====== РЃС‚СЂР°РЅРёС†Р° СЂРµРґР°РєС‚РёСЂРѕРІР°РЅРёСЏ ====== */
.direction-edit-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
}

.lock-btn {
  width: 32px;
  height: 32px;
  border-radius: 16px;
  border: 1px solid var(--border);
  background: var(--card);
  color: var(--text);
  cursor: pointer;
  font-size: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.lock-btn:active {
  opacity: 0.7;
}

.direction-lockable {
  position: relative;
}

.direction-lockable .lock-overlay {
  display: none;
  position: absolute;
  inset: 0;
  background: rgba(0, 0, 0, 0.55);
  border-radius: 12px;
  z-index: 2;
  pointer-events: all;
}

#direction-edit-form.direction-locked .direction-lockable .lock-overlay {
  display: block;
}

/* ====== СПИСОК КЛИЕНТОВ (ПЕРСОНАЛ) ====== */
.clients-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.client-card {
  background: var(--card);
  padding: 10px 12px;
  border-radius: 10px;
  cursor: pointer;
  border-left: 3px solid var(--accent);
  border: 1px solid var(--border);
  margin-bottom: 2px;
  transition: background 0.15s ease, transform 0.15s ease, border-color 0.15s ease;
}

.client-card:active {
  background: #1b1b1b;
  transform: translateX(2px);
  border-color: #2c2c2c;
}

.client-card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 6px;
  gap: 8px;
}

.client-card-name {
  font-weight: 700;
  font-size: 15px;
  line-height: 1.2;
}

.client-card-status {
  font-size: 11px;
  padding: 2px 7px;
  border-radius: 999px;
  border: 1px solid var(--border);
  background: #232323;
  color: #f0f0f0;
  white-space: nowrap;
}

.client-card-status.status-active {
  border-color: rgba(76, 175, 80, 0.35);
  background: rgba(76, 175, 80, 0.16);
  color: #cce8ce;
}

.client-card-status.status-inactive {
  border-color: rgba(158, 158, 158, 0.35);
  background: rgba(158, 158, 158, 0.14);
  color: #d2d2d2;
}

.client-card-status.status-frozen {
  border-color: rgba(100, 181, 246, 0.35);
  background: rgba(100, 181, 246, 0.14);
  color: #c7e3ff;
}

.client-meta-line {
  font-size: 12px;
  color: var(--hint);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin-bottom: 4px;
}

.client-meta-strong {
  color: #d9d9d9;
  font-weight: 600;
}

.client-card-notes {
  margin-top: 3px;
  font-size: 11px;
  color: var(--hint);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* ====== СПИСОК ПЕРСОНАЛА (В СТИЛЕ КЛИЕНТОВ) ====== */
.staff-list-cards {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.staff-client-card {
  padding: 10px 12px;
}

.staff-client-card .staff-card-row {
  align-items: center;
  gap: 10px;
  margin-bottom: 0;
}

.staff-card-main {
  flex: 1;
  min-width: 0;
}

.staff-card-title {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
}

.staff-card-name {
  font-weight: 700;
  font-size: 15px;
  line-height: 1.2;
  min-width: 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.staff-role-chip {
  border-color: rgba(255, 140, 66, 0.35);
  background: rgba(255, 140, 66, 0.14);
  color: #ffd3b3;
}

.staff-user-line {
  margin-top: 2px;
  font-size: 12px;
  color: var(--accent);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.staff-meta-row {
  margin-top: 6px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
}

.staff-phone-line {
  font-size: 12px;
  color: var(--hint);
  min-width: 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.staff-teaches-chip {
  font-size: 11px;
  line-height: 1;
  padding: 3px 8px;
  border-radius: 999px;
  border: 1px solid var(--border);
  color: #f0f0f0;
  display: inline-flex;
  align-items: center;
  gap: 4px;
  white-space: nowrap;
  font-weight: 600;
  flex-shrink: 0;
}

.staff-teaches-chip.is-true {
  background: rgba(76, 175, 80, 0.16);
}

.staff-teaches-chip.is-false {
  background: rgba(158, 158, 158, 0.16);
}

/* ====== ФОТО ПРОФИЛЯ ====== */
.photo-preview {
  background: var(--card);
  border-radius: 12px;
  padding: 20px;
  text-align: center;
  margin-bottom: 12px;
  border: 2px dashed var(--border);
}

#profile-photo-img {
  max-width: 100%;
  max-height: 300px;
  border-radius: 8px;
}

/* ====== НОВОСТИ ====== */
.news-grid {
  display: flex;
  gap: 10px;
  overflow-x: auto;
  overflow-y: hidden;
  scroll-behavior: smooth;
  padding-bottom: 8px;
  -webkit-overflow-scrolling: touch;
}

.news-item {
  position: relative;
  width: 100px;
  height: 100px;
  min-width: 100px;
  border-radius: 12px;
  overflow: hidden;
  cursor: pointer;
  transition: transform 0.2s, opacity 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  background: linear-gradient(135deg, var(--accent), #ff8a3d);
}

.news-item::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, var(--accent), #ff8a3d);
  z-index: -1;
}

.news-item img {
  position: absolute;
  width: 100%;
  height: 100%;
  object-fit: cover;
  z-index: 0;
}

.news-item-title {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  background: rgba(0, 0, 0, 0.6);
  color: white;
  font-weight: 600;
  font-size: 11px;
  line-height: 1.2;
  padding: 6px 4px;
  text-align: center;
  z-index: 1;
  max-height: 40%;
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  line-clamp: 2;
  -webkit-box-orient: vertical;
}

.news-item:active {
  transform: scale(0.95);
  opacity: 0.8;
}

.news-empty {
  text-align: center;
  color: var(--hint);
  padding: 20px;
  font-size: 14px;
}

/* ====== ПРОСМОТР НОВОСТИ ====== */
#news-detail {
  padding: 0 !important;
  padding-bottom: 56px !important;
  position: relative;
}

#news-detail .brand-header {
  margin: 0;
  padding: 0 16px;
  position: absolute;
  top: calc(8px + var(--safe-top));
  left: 0;
  right: 0;
  z-index: 5;
  pointer-events: none;
}

#news-detail .brand-row {
  background: rgba(20, 20, 20, 0.62);
  border: 1px solid rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  padding: 6px 12px;
}

#news-detail .brand-avatar {
  display: none;
}

#news-detail.news-detail-no-photo .brand-header {
  position: relative;
  top: 0;
  margin: calc(8px + var(--safe-top)) 0 10px 0;
  pointer-events: auto;
}

#news-detail-photo-container {
  width: 100%;
  height: 300px;
  background: var(--card);
  overflow: hidden;
  margin-bottom: -30px;
  position: relative;
  z-index: 1;
}

#news-detail-photo-container img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

#news-detail .news-detail-content-wrapper {
  background: var(--bg);
  border-radius: 30px 30px 0 0;
  padding: 30px 16px 16px 16px;
  margin-top: 0;
  position: relative;
  z-index: 2;
}

#news-detail-title {
  font-size: 20px;
  font-weight: 700;
  margin: 0 0 8px 0;
  color: var(--text);
}

#news-detail-date {
  color: var(--hint);
  font-size: 13px;
  margin-bottom: 16px !important;
}

#news-detail-content {
  color: var(--text);
  line-height: 1.6;
  font-size: 15px;
  margin: 0;
}

.brand-header {
  text-align: center;
  margin: -6px 0 14px 0;
}

.brand-row {
  display: inline-flex;
  align-items: center;
  gap: 10px;
  padding: 4px 10px;
  border-radius: 999px;
  background: rgba(0, 0, 0, 0.12);
}

.brand-avatar {
  width: 22px;
  height: 22px;
  border-radius: 50%;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  background: rgba(0, 0, 0, 0.08);
}

.brand-avatar:empty {
  display: none;
}

.brand-name {
  font-size: 14px;
  font-weight: 600;
  color: var(--text);
}

.page-title {
  font-size: 22px;
  font-weight: 700;
  margin: 10px 0 12px 0;
  text-align: center;
}

/* ====== АДМИН-РАСПИСАНИЕ ====== */
.schedule-toolbar {
  display: flex;
  gap: 8px;
  align-items: center;
  margin-bottom: 12px;
}

.schedule-filter-toggle {
  flex: 0 0 auto;
  padding: 8px 14px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: var(--card);
  font-size: 12px;
  cursor: pointer;
  white-space: nowrap;
  transition: all 0.2s ease;
  color: var(--text);
}

.schedule-filter-toggle.active {
  background: var(--accent-soft);
  border-color: rgba(254, 88, 21, 0.6);
  color: var(--accent);
}

.schedule-toolbar .button {
  flex: 1;
  padding: 10px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: var(--card);
  cursor: pointer;
  font-size: 13px;
  color: var(--text);
}

.schedule-toolbar .button.active {
  background: var(--accent);
  color: #fff;
  border-color: var(--accent);
}

.schedule-filter-row {
  margin-top: 10px;
  display: flex;
  justify-content: flex-end;
}

.schedule-nav {
  display: flex;
  gap: 8px;
  align-items: center;
  margin-bottom: 12px;
}

.schedule-nav .nav-btn-mini {
  padding: 8px 10px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: var(--card);
  cursor: pointer;
}

.schedule-nav .date-label {
  flex: 1;
  text-align: center;
  font-weight: 600;
  color: var(--text);
}

.schedule-grid {
  display: grid;
  grid-template-columns: 64px repeat(7, 1fr);
  border: 1px solid var(--border);
  border-radius: 12px;
  overflow: hidden;
  background: var(--card);
}

#teacher-working-hours .schedule-grid {
  touch-action: none;
}

.schedule-grid.day {
  grid-template-columns: 64px 1fr;
}

.schedule-cell {
  border-bottom: 1px solid var(--border);
  border-right: 1px solid var(--border);
  min-height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  padding: 2px 4px;
}

/* Убираем горизонтальные линии сетки внутри склеенных слотов */
.schedule-cell.time {
  background: var(--card);
  color: var(--hint);
  font-weight: 600;
}

.schedule-cell.time.half {
  opacity: 0.45;
}

.schedule-cell.head {
  background: var(--card);
  font-weight: 600;
  font-size: 12px;
}

.schedule-now-line {
  position: absolute;
  pointer-events: none;
  height: 2px;
  border-radius: 999px;
  background: #ff4b4b;
  box-shadow: 0 0 0 1px rgba(255, 75, 75, 0.2);
  z-index: 3;
}

.schedule-grid-block-highlight {
  position: absolute;
  pointer-events: none;
  background: var(--accent-soft);
  border: 2px solid rgba(254, 88, 21, 0.45);
  border-radius: 10px;
  transition: width 0.12s ease, height 0.12s ease, top 0.12s ease, left 0.12s ease, opacity 0.12s ease;
  box-shadow: 0 8px 18px rgba(0, 0, 0, 0.08);
  z-index: 1;
  opacity: 0;
}

.schedule-slot {
  background: var(--card);
  cursor: pointer;
  min-height: 42px;
  border-radius: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  transition: all 0.15s ease;
}

/* Визуальное объединение многослойных слотов одной заявки */
.schedule-slot:hover {
  border-radius: 8px;
  transform: translateY(-1px);
  box-shadow: 0 8px 16px rgba(0, 0, 0, 0.08);
}

.schedule-slot.confirmed,
.schedule-slot.pending,
.schedule-slot.tentative {
  border: 1px solid transparent;
}

.schedule-slot.pending {
  border-color: rgba(255, 152, 0, 0.9);
}

.schedule-slot.pending .schedule-event {
  color: #e65100;
}

.schedule-slot.tentative {
  border-color: rgba(254, 88, 21, 0.8);
  background: rgba(254, 88, 21, 0.12);
}

.schedule-slot.tentative .schedule-event {
  color: #ffb3b3;
}

.schedule-slot-highlighted-other,
.schedule-slot-highlighted-active {
  border-width: 0 !important;
  border-radius: 0 !important;
  box-shadow: none !important;
  background: rgba(0, 0, 0, 0.08) !important;
}

.schedule-slot-highlighted-active {
  border-width: 1px !important;
  border-style: solid !important;
  border-color: rgba(254, 88, 21, 0.7) !important;
  background: rgba(254, 88, 21, 0.08) !important;
  z-index: 1;
}

.schedule-slot.non-working {
  background: rgba(255, 99, 99, 0.15);
}

.schedule-slot.non-working:hover {
  background: rgba(255, 99, 99, 0.22);
}

/* Схлопываем части одной заявки в единую колонку */
.schedule-cell.slot-grouped {
  border-top: 0;
  border-bottom: 0;
}

.schedule-slot.slot-grouped {
  border-left: 1px solid rgba(254, 88, 21, 0.8) !important;
  border-right: 1px solid rgba(254, 88, 21, 0.8) !important;
  background: rgba(254, 88, 21, 0.12) !important;
}

.schedule-slot.slot-group-start {
  border-top-left-radius: 10px;
  border-top-right-radius: 10px;
  border-top: 2px solid rgba(254, 88, 21, 0.8);
}

.schedule-slot.slot-group-end {
  border-bottom-left-radius: 10px;
  border-bottom-right-radius: 10px;
  border-bottom: 2px solid rgba(254, 88, 21, 0.8);
}

.schedule-slot.slot-group-middle {
  border-radius: 0;
}

.schedule-slot.slot-group-middle,
.schedule-slot.slot-group-end {
  margin-top: -2px;
}

.schedule-event {
  font-size: 11px;
  font-weight: 600;
  text-align: center;
}

.schedule-form {
  margin-top: 12px;
  padding: 12px;
  background: var(--card);
  color: var(--text);
  border-radius: 12px;
  display: none;
}

.schedule-form.show {
  display: block;
}

.schedule-detail-modal {
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  background: var(--card);
  color: var(--text);
  border-radius: 20px 20px 0 0;
  box-shadow: 0 -8px 20px rgba(0, 0, 0, 0.15);
  padding: 16px;
  display: none;
  z-index: 1002;
  max-height: 70vh;
  overflow-y: auto;
}

.schedule-detail-modal.show {
  display: block;
}

.modal-fullscreen {
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  position: fixed;
  border-radius: 0;
  max-height: none;
  height: 100vh;
  width: 100vw;
  padding: 18px;
}

.schedule-detail-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.2);
  display: none;
  z-index: 1001;
}

.schedule-detail-overlay.show {
  display: block;
}

.action-title-popup {
  position: fixed;
  top: calc(var(--safe-top) + 10px);
  left: 50%;
  transform: translate(-50%, -10px);
  background: rgba(20, 20, 20, 0.62);
  border: 1px solid rgba(255, 255, 255, 0.16);
  color: #fff;
  padding: 8px 12px;
  border-radius: 12px;
  font-size: 13px;
  font-weight: 600;
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  z-index: 2201;
  opacity: 0;
  transition: opacity 0.2s ease, transform 0.2s ease;
  pointer-events: none;
  max-width: min(calc(100vw - 24px), 440px);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  text-align: center;
}

.action-title-popup.show {
  opacity: 1;
  transform: translate(-50%, 0);
}

.group-schedule-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.2);
  display: none;
  z-index: 1001;
}

.group-schedule-overlay.show {
  display: block;
}

.group-schedule-modal {
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  background: var(--card);
  color: var(--text);
  border-radius: 20px 20px 0 0;
  box-shadow: 0 -8px 20px rgba(0, 0, 0, 0.15);
  padding: 16px;
  display: none;
  z-index: 1002;
  max-height: 85vh;
  overflow-y: auto;
}

.group-schedule-modal.show {
  display: block;
}

.confirm-modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.25);
  display: none;
  z-index: 1001;
}

.confirm-modal-overlay.show {
  display: block;
}

.confirm-modal {
  position: fixed;
  left: 16px;
  right: 16px;
  top: 50%;
  transform: translateY(-50%);
  background: var(--card);
  border-radius: 16px;
  box-shadow: 0 12px 30px rgba(0, 0, 0, 0.2);
  padding: 16px;
  display: none;
  z-index: 1002;
}

.confirm-modal.show {
  display: block;
}

.schedule-detail-chip {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 10px;
  border-radius: 999px;
  background: var(--card);
  font-size: 12px;
}

.schedule-detail-card {
  margin-top: 10px;
  padding: 12px;
  border-radius: 12px;
  background: var(--card);
  border: 1px solid var(--border);
  display: grid;
  gap: 8px;
}

.schedule-detail-row {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
}

.attendance-list {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.attendance-item {
  display: flex;
  flex-direction: column;
  gap: 8px;
  padding: 10px;
  border: 1px solid var(--border);
  border-radius: 12px;
}

.attendance-top {
  display: flex;
  gap: 8px;
  align-items: center;
  width: 100%;
}

.attendance-name {
  font-weight: 600;
  flex: 1;
}

.attendance-actions {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  width: 100%;
}

.attendance-btn {
  border: 1px solid var(--border);
  background: #222;
  color: var(--text);
  padding: 6px 10px;
  border-radius: 10px;
  cursor: pointer;
  font-size: 12px;
}

.attendance-btn.active {
  background: var(--accent-soft);
  border-color: var(--accent);
  color: var(--accent);
}

.attendance-badge {
  font-size: 11px;
  color: var(--hint);
}

.attendance-screen {
  display: none;
  height: 100vh;
  overflow-y: auto;
  padding: 16px;
}

.attendance-screen.active {
  display: block;
}

.stats-grid {
  display: grid;
  gap: 10px;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
}

.stats-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 12px;
  box-shadow: 0 10px 24px rgba(0,0,0,0.3);
}

.stats-label {
  font-size: 12px;
  color: var(--hint);
  margin-bottom: 4px;
}

.stats-value {
  font-size: 20px;
  font-weight: 700;
  color: var(--text);
}

.work-settings-menu-hint {
  margin-top: -4px;
  margin-bottom: 14px;
  color: var(--hint);
  font-size: 13px;
}

.work-price-row {
  display: flex;
  align-items: flex-end;
  gap: 8px;
  flex-wrap: wrap;
}

.work-price-input-wrap {
  flex: 1;
  min-width: 160px;
}

.work-price-status {
  margin-top: 6px;
  font-size: 12px;
  color: var(--hint);
}

.attendance-screen-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 8px;
  margin-bottom: 12px;
}

.attendance-footer {
  position: sticky;
  bottom: 0;
  background: var(--card);
  padding: 10px 0 4px 0;
  display: flex;
  gap: 8px;
}

.photo-picker {
  border: 1px dashed var(--border);
  border-radius: 12px;
  padding: 12px;
  display: flex;
  gap: 10px;
  align-items: center;
  background: rgba(255,255,255,0.02);
}

.photo-picker button {
  margin: 0;
}

.photo-preview {
  width: 80px;
  height: 80px;
  border-radius: 10px;
  overflow: hidden;
  background: var(--border);
  display: flex;
  align-items: center;
  justify-content: center;
}

.photo-preview img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.schedule-detail-actions {
  margin-top: 12px;
  display: flex;
  justify-content: flex-end;
}

.schedule-detail-client-btn {
  border-radius: 999px;
  border: 1px solid rgba(254, 88, 21, 0.65);
  background: var(--accent-soft);
  color: var(--accent);
  padding: 6px 14px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.2s ease;
}

.schedule-detail-client-btn:hover {
  background: var(--accent-strong);
}

.repeat-panel {
  margin-top: 10px;
  padding: 10px;
  border-radius: 12px;
  background: var(--card);
  border: 1px solid var(--border);
}

.repeat-row {
  display: flex;
  gap: 8px;
  align-items: center;
  margin: 8px 0;
}

.repeat-row .chip {
  padding: 6px 8px;
  border-radius: 999px;
  border: 1px solid var(--border);
  background: var(--card);
  font-size: 12px;
  cursor: pointer;
}

.repeat-row .chip.active {
  background: var(--accent);
  color: #fff;
  border-color: var(--accent);
}

.repeat-inline {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 12px;
}

.repeat-inline input[type="number"] {
  width: 60px;
}

.repeat-summary {
  margin-top: 8px;
  font-size: 12px;
  color: var(--hint);
}

.work-page .staff-info-panel {
  margin-top: 6px;
  margin-bottom: 18px;
}

.work-page .card {
  margin-bottom: 18px;
}

/* ====== РАСПИСАНИЕ (ПОЛЬЗОВАТЕЛИ) ====== */
.public-schedule-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  margin-bottom: 12px;
}
.public-type-tabs {
  display: flex;
  gap: 8px;
  margin: 10px 0 4px;
  flex-wrap: wrap;
}
.public-type-tab {
  padding: 8px 12px;
  border-radius: 12px;
  border: 1px solid var(--border);
  background: var(--card);
  color: var(--text);
  font-size: 13px;
  cursor: pointer;
  transition: all 0.15s ease;
}
.public-type-tab.active {
  background: var(--accent);
  color: #111;
  border-color: var(--accent);
  box-shadow: 0 8px 20px rgba(0,0,0,0.25);
}

.public-view-tabs {
  display: flex;
  gap: 8px;
  margin: 8px 0 4px;
}

.public-view-tab {
  padding: 8px 12px;
  border-radius: 12px;
  border: 1px solid var(--border);
  background: var(--card);
  color: var(--text);
  font-size: 13px;
  cursor: pointer;
  transition: all 0.15s ease;
}

.public-view-tab.active {
  background: #111;
  color: #fff;
  border-color: #111;
}

.public-schedule-title {
  display: inline-flex;
  align-items: center;
  gap: 10px;
  font-size: 20px;
  font-weight: 700;
}

.public-schedule-action {
  font-size: 14px;
  color: var(--hint);
  font-weight: 600;
}

.public-schedule-month {
  font-size: 12px;
  color: var(--hint);
  text-transform: uppercase;
  letter-spacing: 0.08em;
  margin: 6px 0 10px 2px;
}

.public-schedule-strip {
  display: flex;
  gap: 10px;
  overflow-x: auto;
  padding-bottom: 6px;
  -webkit-overflow-scrolling: touch;
}

.public-date-card {
  min-width: 64px;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 8px 10px;
  text-align: center;
  cursor: pointer;
}

.public-date-card:hover,
.public-schedule-item:hover {
  cursor: pointer;
}

.public-date-card.active {
  background: #111;
  color: #fff;
  border-color: #111;
}

.public-date-dow {
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  color: inherit;
}

.public-date-day {
  font-size: 18px;
  font-weight: 700;
  margin: 4px 0 2px 0;
}

.public-date-label {
  font-size: 11px;
  color: var(--hint);
}

.public-date-card.active .public-date-label {
  color: rgba(255, 255, 255, 0.8);
}

.public-schedule-list {
  margin-top: 8px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.public-schedule-item {
  display: grid;
  grid-template-columns: 54px 1fr 18px;
  gap: 10px;
  align-items: start;
  padding: 8px 0;
  border-bottom: 1px solid var(--border);
}

.public-schedule-time {
  display: flex;
  flex-direction: column;
  gap: 6px;
  align-items: center;
}

.public-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
}

.public-time {
  font-weight: 700;
  font-size: 14px;
}

.public-duration {
  font-size: 12px;
  color: var(--hint);
}

.public-info-title {
  font-weight: 700;
  font-size: 15px;
  margin-bottom: 4px;
}

.public-info-image {
  width: 100%;
  height: 90px;
  border-radius: 12px;
  object-fit: cover;
  margin-bottom: 6px;
  display: block;
}

.public-info-sub {
  font-size: 13px;
  color: var(--hint);
  margin-bottom: 2px;
}

.public-info-teacher {
  font-size: 13px;
  color: var(--hint);
}

.public-calendar-nav {
  display: none;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 8px;
}

#personal-calendar-nav {
  gap: 8px;
}

#personal-calendar-nav .public-calendar-nav-label {
  flex: 1;
  margin: 0;
  text-align: center;
}

.public-calendar-nav.active {
  display: flex;
}

.public-calendar-nav button {
  width: 34px;
  height: 34px;
  border-radius: 999px;
  border: 1px solid var(--border);
  background: var(--card);
  color: var(--text);
  cursor: pointer;
}

.public-week-nav {
  display: none;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 8px;
  gap: 8px;
}

.public-week-nav.active {
  display: flex;
}

.public-week-nav button {
  width: 34px;
  height: 34px;
  border-radius: 999px;
  border: 1px solid var(--border);
  background: var(--card);
  color: var(--text);
  cursor: pointer;
}

.public-week-label {
  flex: 1;
  text-align: center;
  font-size: 12px;
  color: var(--hint);
  text-transform: uppercase;
  letter-spacing: 0.06em;
}

.public-calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, minmax(0, 1fr));
  border: 1px solid var(--border);
  border-radius: 12px;
  overflow: hidden;
}

.public-calendar-head {
  background: var(--accent-soft);
  color: var(--text);
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  padding: 8px 4px;
  text-align: center;
  border-right: 1px solid var(--border);
}

.public-calendar-head:nth-child(7n) {
  border-right: none;
}

.public-calendar-cell {
  min-height: 82px;
  border-right: 1px solid var(--border);
  border-top: 1px solid var(--border);
  padding: 6px 6px 4px;
  background: var(--card);
}

.public-calendar-cell:nth-child(7n) {
  border-right: none;
}

.public-calendar-cell.is-outside {
  opacity: 0.45;
}

.public-calendar-cell.is-today {
  background: #131313;
}

.public-calendar-cell.is-selected {
  outline: 2px solid var(--accent);
  outline-offset: -2px;
}

.public-calendar-cell.is-range {
  background: rgba(239, 108, 0, 0.16);
}

.client-sick-bottom-actions {
  display: none;
  gap: 8px;
  background: rgba(20, 20, 20, 0.92);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 8px;
  margin-top: 10px;
}

.client-sick-bottom-actions .save-btn[disabled] {
  opacity: 0.55;
  pointer-events: none;
}

.public-calendar-day {
  font-size: 12px;
  font-weight: 700;
  margin-bottom: 4px;
}

.public-calendar-events {
  display: flex;
  flex-direction: column;
  gap: 3px;
}

.public-calendar-event {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 10px;
  line-height: 1.15;
  cursor: pointer;
  white-space: nowrap;
}

.public-calendar-event-dot {
  width: 7px;
  height: 7px;
  border-radius: 999px;
  flex: 0 0 7px;
}

.public-calendar-event-text {
  font-variant-numeric: tabular-nums;
  letter-spacing: 0.01em;
}

.public-calendar-agenda {
  margin-top: 10px;
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 10px;
  background: var(--card);
}

.public-calendar-agenda-title {
  font-size: 12px;
  font-weight: 700;
  margin: 0 0 8px;
  color: var(--hint);
  text-transform: uppercase;
  letter-spacing: 0.06em;
}

.personal-individual-form {
  margin-top: 0;
  overflow: hidden;
  max-height: 0;
  opacity: 0;
  transform: translateY(-8px);
  transition:
    max-height 360ms cubic-bezier(0.22, 0.61, 0.36, 1),
    opacity 220ms ease,
    transform 320ms cubic-bezier(0.22, 0.61, 0.36, 1),
    margin-top 320ms ease,
    padding-top 220ms ease,
    padding-bottom 220ms ease,
    border-color 220ms ease,
    background-color 220ms ease;
  pointer-events: none;
  padding-top: 0;
  padding-bottom: 0;
  border-color: transparent;
  background: transparent;
}

.personal-individual-form.is-open {
  margin-top: 12px;
  max-height: 1200px;
  opacity: 1;
  transform: translateY(0);
  pointer-events: auto;
  padding-top: 12px;
  padding-bottom: 12px;
  border-color: var(--border);
  background: var(--card);
}

#personal-individual-toggle-btn {
  transition: transform 180ms ease, box-shadow 220ms ease, background-color 220ms ease;
}

#personal-individual-toggle-btn:active {
  transform: translateY(1px) scale(0.99);
}

#personal-individual-toggle-btn.is-open {
  background: #111;
}

.personal-individual-user-results {
  max-height: 240px;
  overflow-y: auto;
  margin-bottom: 10px;
  border-radius: 8px;
  background: var(--card);
  padding: 8px;
  border: 1px solid var(--border);
}

.personal-individual-user-card {
  margin-bottom: 8px;
  cursor: pointer;
  transition: all 0.2s;
}

.personal-individual-user-card:last-child {
  margin-bottom: 0;
}

.personal-individual-user-card.is-selected {
  border-left: 4px solid var(--accent);
  background: var(--accent-soft);
}

.personal-individual-user-chip {
  margin: 0 0 10px 0;
  padding: 8px 10px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--card);
  font-size: 12px;
}

.personal-individual-booking-msg {
  margin: 10px 0 0 0;
  font-size: 12px;
  color: var(--hint);
}

@media (max-width: 380px) {
  .public-calendar-cell {
    min-height: 74px;
    padding: 5px 5px 4px;
  }
  .public-calendar-event {
    font-size: 9px;
    gap: 4px;
  }
  .public-calendar-event-dot {
    width: 6px;
    height: 6px;
    flex: 0 0 6px;
  }
}

/* ====== НАПРАВЛЕНИЕ (ДЕТАЛИ) ====== */
.direction-detail-photo {
  width: calc(100% + 32px);
  height: 300px;
  background: var(--card);
  overflow: hidden;
  margin-bottom: -30px;
  margin-left: -16px;
  margin-right: -16px;
  position: relative;
  z-index: 1;
  border-radius: 0;
}

.direction-detail-photo img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

.direction-detail-content {
  background: var(--bg);
  border-radius: 24px 24px 0 0;
  padding: 20px 16px 16px 16px;
  position: relative;
  z-index: 2;
  box-shadow: 0 -10px 20px rgba(0, 0, 0, 0.08);
  margin-left: -16px;
  margin-right: -16px;
}

.public-chevron {
  font-size: 18px;
  color: var(--hint);
  align-self: center;
}

.public-schedule-detail {
  display: grid;
  gap: 12px;
}

.group-inline-details {
  margin-top: 0;
  padding: 0;
  border-radius: 10px;
  background: transparent;
  border: 0;
  max-height: 0;
  opacity: 0;
  overflow: hidden;
  transition: max-height 0.35s ease, opacity 0.25s ease;
}

.group-inline-details.show {
  opacity: 1;
  margin-top: 10px;
  padding: 10px;
  background: var(--card);
  border: 1px solid var(--border);
}

.group-summary,
.group-teacher {
  transition: opacity 0.2s ease, max-height 0.25s ease;
  max-height: 200px;
  overflow: hidden;
}

.group-summary.hidden,
.group-teacher.hidden {
  opacity: 0;
  max-height: 0;
  margin-top: 0;
}

.group-teacher-link {
  margin-top: 10px;
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 10px 12px;
  background: var(--card);
  display: grid;
  gap: 6px;
  text-align: left;
  cursor: pointer;
  color: var(--text);
}

.group-teacher-row {
  display: flex;
  align-items: center;
  gap: 8px;
}

.group-teacher-avatar {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  background: #262626;
  color: #555;
  font-weight: 700;
  font-size: 12px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  overflow: hidden;
}

.group-teacher-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

.group-teacher-label {
  font-size: 11px;
  color: var(--hint);
  text-transform: uppercase;
  letter-spacing: 0.6px;
}

.group-booking-overlay {
  position: fixed;
  inset: 0;
  bottom: calc(56px + var(--safe-bottom));
  z-index: 2000;
  display: none;
  background: rgba(5, 6, 9, 0.84);
  backdrop-filter: blur(6px);
}

.group-booking-overlay.show {
  display: block;
}

.group-booking-slider-wrapper {
  margin-top: 8px;
  width: 100%;
  padding: 10px 10px 6px;
  border-radius: 12px;
  background: var(--card);
  border: 1px solid var(--border);
}

.group-booking-slider-marks {
  display: flex;
  justify-content: space-between;
  font-size: 11px;
  color: var(--hint);
  margin-top: 4px;
}

.group-booking-slider-selected {
  font-size: 13px;
  color: var(--accent);
  margin-top: 8px;
  text-align: left;
  font-weight: 600;
}

.teacher-cards-grid {
  display: grid;
  gap: 12px;
}

.teacher-card {
  background: var(--card);
  border-radius: 12px;
  padding: 12px;
  display: flex;
  gap: 12px;
  align-items: center;
}

.teacher-photo {
  width: 70px;
  height: 70px;
  border-radius: 50%;
  background: #262626;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  font-weight: 600;
  color: #555;
}

.teacher-photo img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.teacher-info {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.teacher-info .teacher-name {
  font-weight: 600;
}

.teacher-info .teacher-meta {
  font-size: 12px;
  color: var(--hint);
}
.group-booking-price-preview {
  font-size: 13px;
  font-weight: 600;
  color: var(--text);
  margin-top: 6px;
}

.group-booking-range-text,
.group-booking-meta {
  font-size: 13px;
  color: var(--hint);
  margin-top: 6px;
}

.group-booking-backdrop {
  position: absolute;
  inset: 0;
  background: radial-gradient(120% 120% at 80% -10%, rgba(254, 88, 21, 0.16), transparent 45%);
}

.group-booking-card {
  position: relative;
  background:
    radial-gradient(120% 120% at 85% -20%, rgba(254, 88, 21, 0.12), transparent 40%),
    var(--bg);
  width: 100%;
  height: 100%;
  max-height: 100dvh;
  border-radius: 0;
  padding: calc(var(--safe-top) + 14px) 16px calc(var(--safe-bottom) + 14px);
  box-shadow: none;
  border: 0;
  z-index: 1;
  display: grid;
  grid-template-rows: auto 1fr auto;
  gap: 0;
}

.group-booking-info-popup {
  position: fixed;
  inset: 0;
  z-index: 2150;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 16px;
  background: rgba(0, 0, 0, 0.55);
}

.group-booking-info-popup.hidden {
  display: none;
}

.group-booking-info-card {
  width: min(420px, 100%);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 12px;
  background: var(--bg);
  box-shadow: 0 24px 48px rgba(0, 0, 0, 0.45);
}

.group-booking-info-card .save-btn {
  width: 100%;
  margin-top: 10px;
}

.group-booking-capsule {
  z-index: 2201;
}

.group-booking-capsule.hidden {
  display: none;
}

.personal-schedule-refresh-capsule {
  z-index: 2201;
  pointer-events: auto;
  cursor: pointer;
  user-select: none;
}

.personal-schedule-refresh-capsule.hidden {
  display: none;
}

.teacher-detail-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.35);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 3000;
}

.teacher-detail-overlay.show {
  display: flex;
}

.teacher-detail-card {
  background: white;
  border-radius: 16px;
  width: min(480px, calc(100% - 32px));
  padding: 20px;
  box-shadow: 0 25px 50px rgba(0,0,0,0.25);
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.teacher-profile-photo {
  width: 100%;
  height: 200px;
  border-radius: 16px;
  background: var(--card);
  margin-bottom: 12px;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
}

.teacher-profile-photo img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

.teacher-profile-photo {
  width: 100%;
  height: 200px;
  border-radius: 16px;
  background: var(--card);
  overflow: hidden;
  display: none;
  align-items: center;
  justify-content: center;
}

.teacher-profile-photo img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

#teacher-profile-individual-btn,
#teacher-profile-groups-toggle-btn {
  -webkit-tap-highlight-color: transparent;
}

#teacher-profile-individual-btn:focus,
#teacher-profile-individual-btn:focus-visible,
#teacher-profile-individual-btn:active,
#teacher-profile-groups-toggle-btn:focus,
#teacher-profile-groups-toggle-btn:focus-visible,
#teacher-profile-groups-toggle-btn:active {
  outline: none;
  box-shadow: none;
}

.teacher-detail-header {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 20px;
}

.teacher-detail-header button {
  border: none;
  background: transparent;
  font-size: 20px;
  cursor: pointer;
  color: var(--hint);
}

.teacher-detail-body {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.teacher-detail-label {
  font-size: 12px;
  color: var(--hint);
  margin: 0;
}

.teacher-detail-text {
  margin: 0;
  font-size: 14px;
  color: var(--text);
  min-height: 40px;
}

.teacher-detail-schedule {
  display: flex;
  flex-direction: column;
  gap: 6px;
  font-size: 13px;
  color: var(--text);
}

.teacher-detail-schedule-row {
  display: flex;
  justify-content: space-between;
  gap: 12px;
}
.group-booking-body label {
  font-size: 12px;
  color: var(--hint);
  margin-bottom: 6px;
  display: block;
  font-weight: 600;
}

.group-booking-body {
  overflow-y: auto;
  padding: 30px 0 14px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.group-booking-body input,
.group-booking-body select,
.group-booking-body textarea {
  width: 100%;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid var(--border);
  font-size: 14px;
  background: var(--card);
  color: var(--text);
}

.group-booking-body input:focus,
.group-booking-body select:focus,
.group-booking-body textarea:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 2px var(--accent-soft);
}

.group-booking-body input[type=range] {
  padding: 0;
  accent-color: var(--accent);
}

.group-booking-body textarea {
  min-height: 96px;
  resize: vertical;
}

.group-booking-compatible-wrapper {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

#group-booking-multi-options.hidden,
.group-booking-compatible-wrapper.hidden {
  display: none;
}

.group-booking-compatible-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.group-booking-compatible-item {
  display: flex;
  gap: 10px;
  align-items: flex-start;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 10px 12px;
}

.group-booking-compatible-item.selected {
  border-color: var(--accent);
  box-shadow: 0 0 0 1px var(--accent-soft);
}

.group-booking-compatible-item.disabled {
  opacity: 0.65;
}

.group-booking-compatible-item input {
  width: auto;
  margin-top: 3px;
}

.group-booking-compatible-content {
  flex: 1;
  min-width: 0;
}

.group-booking-compatible-name {
  font-size: 14px;
  font-weight: 600;
  color: var(--text);
}

.group-booking-compatible-meta {
  margin-top: 4px;
  font-size: 12px;
  color: var(--hint);
}

.group-booking-quote {
  margin-top: 2px;
  padding: 10px 12px;
  border-radius: 12px;
  background: var(--card);
  border: 1px solid var(--border);
}

.group-booking-amount-line {
  color: var(--text);
  font-weight: 600;
}

.group-booking-amount-value {
  display: inline-flex;
  align-items: center;
  padding: 2px 10px;
  border-radius: 999px;
  background: var(--accent-soft);
  border: 1px solid rgba(254, 88, 21, 0.45);
  color: var(--accent);
  font-weight: 700;
}

.group-booking-options-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.group-booking-option-item {
  display: flex;
  align-items: center;
  flex-wrap: nowrap;
  gap: 10px;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 10px 12px;
}

.group-booking-option-item > div {
  min-width: 0;
  flex: 1;
}

.group-booking-option-item.active {
  border-color: var(--accent);
  box-shadow: 0 0 0 1px var(--accent-soft);
}

.group-booking-option-item input {
  width: auto;
  margin: 0;
  flex: 0 0 auto;
}

.group-booking-option-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--text);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.group-booking-option-meta {
  margin-top: 3px;
  font-size: 12px;
  color: var(--hint);
}

.group-booking-picker {
  position: fixed;
  inset: 0;
  z-index: 2100;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 16px;
  background: rgba(0, 0, 0, 0.5);
}

.group-booking-picker.hidden {
  display: none;
}

.group-booking-picker-dialog {
  width: min(440px, 100%);
  max-height: min(70vh, 520px);
  display: flex;
  flex-direction: column;
  gap: 10px;
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 12px;
  background: var(--bg);
  box-shadow: 0 24px 48px rgba(0, 0, 0, 0.45);
}

.group-booking-picker-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
}

.group-booking-picker-header label {
  margin: 0;
  color: var(--text);
  font-size: 14px;
  font-weight: 600;
}

.group-booking-picker-close {
  width: 30px;
  height: 30px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--card);
  color: var(--text);
  cursor: pointer;
  line-height: 1;
}

.group-booking-picker-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
  overflow-y: auto;
  max-height: calc(min(70vh, 520px) - 64px);
}

.group-booking-picker-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 10px;
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 10px 12px;
  background: var(--card);
}

.group-booking-picker-item .save-btn {
  width: auto;
  min-width: 70px;
  padding: 8px 10px;
  border-radius: 10px;
}

.group-booking-footer {
  margin-top: 2px;
  padding-top: 12px;
  border-top: 1px solid var(--border);
}

.group-booking-footer .save-btn {
  width: 100%;
}

.group-booking-directions-block {
  margin-top: 10px;
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 10px 12px;
  background: var(--card);
}

.group-booking-directions-title {
  font-size: 13px;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 8px;
}

.group-booking-main-direction,
.group-booking-extra-slot {
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 9px 10px;
  background: var(--bg);
  font-size: 13px;
  color: var(--text);
}

.group-booking-main-direction {
  margin-bottom: 8px;
}

.group-booking-extra-slots {
  display: grid;
  grid-template-columns: 1fr;
  gap: 8px;
}

.group-booking-plus-btn {
  width: 100%;
  border: 1px dashed var(--border);
  background: var(--bg);
  color: var(--hint);
  border-radius: 12px;
  padding: 10px 12px;
  text-align: left;
  cursor: pointer;
}

.group-booking-plus-btn:disabled {
  opacity: 0.55;
  cursor: not-allowed;
}

.group-booking-slot-header {
  display: flex;
  justify-content: space-between;
  gap: 8px;
  align-items: center;
}

.group-booking-slot-remove {
  border: 1px solid var(--border);
  background: var(--card);
  color: var(--text);
  border-radius: 8px;
  width: 28px;
  height: 28px;
  line-height: 1;
  cursor: pointer;
}
</style>
</head>
<body>
<header id="header">
<button aria-label="Назад" class="header-back" id="header-back" onclick="goBack()"><</button>
<div class="header-center">
<div class="header-center-title" id="header-title">LISSA DANCE</div>
</div>
<div class="header-spacer" aria-hidden="true"></div>
</header>
<!-- ====== ГЛАВНАЯ ====== -->
<div class="page active" id="home">
<div class="home-logo-wrap home-logo-standalone">
<img alt="LISSA DANCE logo" class="home-logo" onerror="this.parentElement.style.display='none'" src="/assets/logo.png"/>
</div>
<div class="card home-welcome-card">
<h3>Добро пожаловать!</h3>
<p class="small">Мы рады видеть вас в нашей студии</p>
</div>
<div class="card home-news-card">
<h4>Новости</h4>
<div class="news-grid" id="news-container">
<p class="news-empty">Новостей пока нет v-v</p>
</div>
</div>
<div class="card studio-section">
<h4>О студии</h4>
<div class="section-item" onclick="showSection('info-directions-sport')">
<div class="section-item-left">
<div class="section-item-icon section-icon--blue">🏅</div>
<div class="section-item-text">
<h4 class="section-item-title">Спортивные направления</h4>
<p class="section-item-desc">Силовые, фитнес и стретчинг</p>
</div>
</div>
<div class="section-item-arrow">›</div>
</div>
<div class="section-item" onclick="showSection('info-directions-dance')">
<div class="section-item-left">
<div class="section-item-icon section-icon--purple">💃</div>
<div class="section-item-text">
<h4 class="section-item-title">Танцевальные направления</h4>
<p class="section-item-desc">Все стили танцев</p>
</div>
</div>
<div class="section-item-arrow">›</div>
</div>
<div class="section-item" onclick="showSection('info-teachers')">
<div class="section-item-left">
<div class="section-item-icon section-icon--orange">🎓</div>
<div class="section-item-text">
<h4 class="section-item-title">Тренеры</h4>
<p class="section-item-desc">Хореографы и наставники студии</p>
</div>
</div>
<div class="section-item-arrow">›</div>
</div>
<div class="section-item" onclick="showSection('info-rent')">
<div class="section-item-left">
<div class="section-item-icon section-icon--pink">🔑</div>
<div class="section-item-text">
<h4 class="section-item-title">Аренда зала</h4>
<p class="section-item-desc">Условия аренды и бронирование</p>
</div>
</div>
<div class="section-item-arrow">›</div>
</div>
<div class="section-item" onclick="showSection('info-about')">
<div class="section-item-left">
<div class="section-item-icon section-icon--orange">☆</div>
<div class="section-item-text">
<h4 class="section-item-title">Информация</h4>
<p class="section-item-desc">О нас, график работы и контакты</p>
</div>
</div>
<div class="section-item-arrow">›</div>
</div>
</div>
</div>
<!-- ====== ИНФОРМАЦИЯ О СТУДИИ ====== -->
<div class="page" id="info-about">
<h3>Информация о студии</h3>
<div class="card">
<h4>⏰ Время работы</h4>
<p>Ежедневно: 09:00 - 22:00</p>
</div>
<div class="card">
<h4>📍 Как добраться</h4>
<script async="" charset="utf-8" src="https://api-maps.yandex.ru/services/constructor/1.0/js/?um=constructor%3Aa1063a1f3fac777c9cdef5b98494aee9e4ffee329067594a69657b435039fe33&amp;width=334&amp;height=265&amp;lang=ru_RU&amp;scroll=true" type="text/javascript"></script>
</div>
<div class="card">
<h4>📞 Контактная информация</h4>
<div class="contact-btn" onclick="copyPhone('+7 800 555 35 35')">
<div class="contact-btn-content">
<span class="contact-icon">📱</span>
<div>
<div class="contact-label">Номер телефона</div>
<div class="contact-value">+7 800 555 35 35</div>
</div>
</div>
<span class="contact-action">Скопировать</span>
</div>
<div class="contact-btn">
<div class="contact-btn-content">
<span class="contact-icon">📱</span>
<div>
<div class="contact-label">Telegram</div>
<div class="contact-value">Скоро</div>
</div>
</div>
<span class="contact-action">Скоро</span>
</div>
</div>
</div>
<!-- ====== РАСПИСАНИЕ ====== -->
<div class="page" data-title="🗓 Расписание" id="schedule">
  <div class="public-schedule-header">
    <div class="public-schedule-title"><span>☆</span>Расписание</div>
    <div class="public-schedule-action" onclick="loadPublicSchedule(true)">Обновить</div>
  </div>
  <div class="public-type-tabs">
    <div class="public-type-tab active" data-type="all" onclick="setPublicScheduleType('all')">Все</div>
    <div class="public-type-tab" data-type="mine" onclick="setPublicScheduleType('mine')">Мое</div>
  </div>
  <div class="public-view-tabs">
    <div class="public-view-tab active" data-view="list" onclick="setPublicScheduleView('list')">Список</div>
    <div class="public-view-tab" data-view="calendar" onclick="setPublicScheduleView('calendar')">Календарь</div>
  </div>
  <div class="public-schedule-month" id="public-schedule-month">—</div>
  <div class="public-week-nav" id="public-week-nav">
    <button type="button" onclick="shiftPublicScheduleWeek(-1)">‹</button>
    <div class="public-week-label" id="public-week-label">—</div>
    <button type="button" onclick="shiftPublicScheduleWeek(1)">›</button>
  </div>
  <div class="public-calendar-nav" id="public-calendar-nav">
    <button type="button" onclick="shiftPublicScheduleMonth(-1)">‹</button>
    <button type="button" onclick="shiftPublicScheduleMonth(1)">›</button>
  </div>
  <div class="public-schedule-strip" id="public-schedule-strip"></div>
  <div class="public-schedule-list" id="schedule-container">
  <p class="small" style="text-align: center; color: var(--hint); padding: 20px;">Загрузка...</p>
</div>
</div>
<div class="page" data-title="🗓 Занятие" id="public-schedule-detail">
  <div class="public-schedule-detail" id="public-schedule-detail-content"></div>
</div>
<!-- ====== РАБОТЫ (ПЕРСОНАЛ) ====== -->
<div class="page work-page" data-title="👨‍💼 Работа" id="staff">
<!-- Панель с информацией о персонале -->
<div class="staff-info-panel">
<div class="staff-avatar-small" id="staff-panel-avatar">
<img alt="Фото" id="staff-panel-avatar-img" src="" style="display: none;"/>
<p style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--hint);">👤</p>
</div>
<div class="staff-info-text">
<div class="staff-name" id="staff-panel-name">—</div>
<div class="staff-position" id="staff-panel-position">—</div>
</div>
<button class="lock-btn" onclick="openStaffProfileEdit()" title="Редактировать рабочий профиль">✏️</button>
</div>
<!-- Меню функционала -->
<div class="card work-section" id="work-section-people" style="margin-bottom: 12px;">
<h4 style="margin-bottom: 10px;">Работа с людьми</h4>
<button class="save-btn" id="staff-manage-btn-work" onclick="showPage('staff-manage')" style="width: 100%; margin-bottom: 8px; display: none; text-align: center;">Персонал</button>
<button class="save-btn" id="clients-btn-work" onclick="showPage('clients-list')" style="width: 100%; margin-bottom: 8px;">Клиенты</button>
</div>
<div class="card work-section" id="work-section-personal" style="margin-bottom: 12px;">
<h4 style="margin-bottom: 10px;">Персональное</h4>
<button class="save-btn" onclick="showPage('personal-schedule')" style="width: 100%; margin-bottom: 8px;">Личное расписание</button>
<button class="save-btn" type="button" style="width: 100%; margin-bottom: 8px;">Личные группы</button>
</div>
<div class="card work-section" id="work-section-structure" style="margin-bottom: 12px;">
<h4 style="margin-bottom: 10px;">Структура</h4>
<button class="save-btn" id="schedule-control-btn-work" onclick="showPage('schedule-control')" style="width: 100%; margin-bottom: 8px;">Расписание</button>
<button class="save-btn" id="directions-groups-btn-work" onclick="showPage('directions-groups')" style="width: 100%; margin-bottom: 8px;">Направления и группы</button>
</div>
<div class="card work-section" id="work-section-communications" style="margin-bottom: 12px;">
<h4 style="margin-bottom: 10px;">Коммуникации</h4>
<button class="save-btn" id="mailings-btn-work" onclick="showPage('mailings')" style="width: 100%; margin-bottom: 8px;">Рассылки</button>
<button class="save-btn" id="news-manage-btn-work" onclick="showPage('news-manage')" style="width: 100%; margin-bottom: 8px;">Новости</button>
</div>
<div class="card work-section" id="work-section-stats-payment" style="margin-bottom: 12px;">
<h4 style="margin-bottom: 10px;">Статистика и настройки</h4>
<button class="save-btn" id="stats-btn" onclick="showPage('stats')" style="width: 100%; margin-bottom: 8px; display: none;">Статистика</button>
<button class="save-btn" id="work-settings-btn-work" onclick="showPage('work-settings')" style="width: 100%; margin-bottom: 8px; display: none;">Параметры настройки</button>
</div>
</div>
<!-- ====== ЛИЧНОЕ РАСПИСАНИЕ ====== -->
<div class="page" id="personal-schedule">

  <div class="public-calendar-nav active" id="personal-calendar-nav">
    <button type="button" onclick="shiftPersonalScheduleMonth(-1)">‹</button>
    <div class="public-schedule-month public-calendar-nav-label" id="personal-schedule-month">—</div>
    <button type="button" onclick="shiftPersonalScheduleMonth(1)">›</button>
  </div>

<div id="personal-schedule-container">
  <p class="small" style="text-align: center; color: var(--hint); padding: 20px;">⏳ Загрузка...</p>
</div>
<button class="save-btn" id="personal-individual-toggle-btn" onclick="togglePersonalIndividualBookingPanel()" style="margin-top: 10px; display: none;">Заявка на индивидуальное</button>
<div class="card personal-individual-form" id="personal-individual-booking-card" style="display: none;">
  <h4 style="margin: 0 0 8px 0;">Заявка на индивидуальное занятие</h4>
  <p class="small" style="margin: 0 0 10px 0; color: var(--hint);">Дата: <b id="personal-individual-selected-date">—</b></p>
  <div style="display: flex; gap: 8px; margin-bottom: 10px;">
    <div style="flex: 1;">
      <label class="label">Время от</label>
      <input class="form-input" id="personal-individual-time-from" type="time" step="1800"/>
    </div>
    <div style="flex: 1;">
      <label class="label">Время до</label>
      <input class="form-input" id="personal-individual-time-to" type="time" step="1800"/>
    </div>
  </div>
  <div class="form-group">
    <label>Клиент</label>
    <input class="form-input" id="personal-individual-user-search" oninput="searchPersonalIndividualUsers()" placeholder="Имя, ID или @юзер" type="text"/>
  </div>
  <div class="personal-individual-user-results" id="personal-individual-user-results">
    <p class="small" style="text-align: center; color: var(--hint); padding: 12px 0;">Начните вводить для поиска клиента...</p>
  </div>
  <div class="personal-individual-user-chip" id="personal-individual-user-selected">Клиент не выбран</div>
  <div class="form-group" style="margin-bottom: 0;">
    <label>Комментарий для админов (опционально)</label>
    <textarea class="form-input" id="personal-individual-comment" rows="2" placeholder="Например: акцент на растяжку"></textarea>
  </div>
  <button class="save-btn" id="personal-individual-submit" onclick="submitPersonalIndividualBooking()" style="margin-top: 10px;">Отправить заявку</button>
  <p class="personal-individual-booking-msg" id="personal-individual-booking-msg"></p>
</div>
</div>
<!-- ====== СТАТИСТИКА ====== -->
<div class="page" data-title="📊 Статистика" id="stats">
  <div class="card" style="margin-bottom: 12px;">
    <h4 style="margin: 0 0 8px;">Статистика по преподавателю</h4>
    <label class="label" style="margin-bottom:6px;">Преподаватель</label>
    <select class="form-input" id="stats-teacher-select"></select>
    <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
      <div style="flex:1; min-width:180px;">
        <label class="label">С даты</label>
        <input class="form-input" id="stats-date-from" type="date">
      </div>
      <div style="flex:1; min-width:180px;">
        <label class="label">По дату</label>
        <input class="form-input" id="stats-date-to" type="date">
      </div>
    </div>
    <button class="save-btn" style="width:100%; margin-top:12px;" onclick="loadTeacherStats()">Показать статистику</button>
  </div>
<div class="card" id="stats-result">
  <p class="small" style="color: var(--hint); margin:0;">Выберите преподавателя и период, чтобы увидеть статистику.</p>
</div>
</div>
<!-- ====== ПАРАМЕТРЫ НАСТРОЙКИ (РАБОТА) ====== -->
<div class="page" data-title="⚙️ Параметры настройки" id="work-settings">
  <p class="work-settings-menu-hint">Разделы для финансовых и организационных параметров.</p>
  <div class="menu-item" id="work-settings-payment-item" onclick="showPage('payment-profiles-admin')">💳 Реквизиты оплаты</div>
  <div class="menu-item" id="work-settings-prices-item" onclick="showPage('work-settings-prices')">💰 Ценники</div>
  <div class="menu-item" id="work-settings-other-item" onclick="showPage('work-settings-other')">⚙️ Остальные параметры</div>
</div>
<div class="page" data-title="💰 Ценники" id="work-settings-prices">
  <div class="card" style="margin-bottom: 12px;">
    <h4 style="margin: 0 0 6px;">Цены по направлениям</h4>
    <p class="small" style="margin: 0; color: var(--hint);">Изменения применяются сразу после сохранения цены.</p>
  </div>
  <div id="work-settings-prices-container">
    <p class="small" style="text-align: center; color: var(--hint); padding: 20px;">⏳ Загрузка...</p>
  </div>
</div>
<div class="page" data-title="⚙️ Остальные параметры" id="work-settings-other">
  <div class="menu-item">🧩 Дополнительные настройки (в разработке)</div>
</div>
<!-- ====== УПРАВЛЕНИЕ РАСПИСАНИЕМ ====== -->
<div class="page" data-title="🗓 Расписание" id="schedule-control">

<div id="schedule-control-container">
    <div class="schedule-toolbar">
      <button class="button active" id="schedule-view-week" onclick="setScheduleView('week')">Неделя</button>
      <button class="button" id="schedule-view-day" onclick="setScheduleView('day')">День</button>
    </div>
    <div class="schedule-filter-row">
      <button class="schedule-filter-toggle" id="schedule-confirmed-toggle" onclick="toggleScheduleConfirmedFilter()">Показать только подтверждённые</button>
    </div>
<div class="schedule-nav">
  <button class="nav-btn-mini" onclick="shiftScheduleDate(-1)">‹</button>
  <div class="date-label" id="schedule-date-label">—</div>
  <button class="nav-btn-mini" onclick="shiftScheduleDate(1)">›</button>
</div>
<div id="schedule-grid-container"></div>
<div class="schedule-detail-overlay" id="schedule-detail-overlay" onclick="closeScheduleDetail()"></div>
<div class="schedule-detail-modal" id="schedule-detail-modal">
  <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px;">
    <h4 style="margin: 0;">Детали занятия</h4>
    <button class="save-btn" style="padding: 6px 10px; background: #777;" onclick="closeScheduleDetail()">Закрыть</button>
  </div>
  <div id="schedule-detail-content" style="margin-top: 8px;"></div>
</div>

<div class="schedule-form" id="schedule-admin-form">
  <h4 style="margin: 0 0 8px 0;">Создать занятие</h4>
  <label class="label">Тип</label>
  <select class="form-input" id="schedule-object-type">
    <option value="group">Групповое</option>
    <option value="individual">Индивидуальное</option>
    <option value="rental">Аренда</option>
  </select>
  <label class="label">ID объекта</label>
  <input class="form-input" id="schedule-object-id" type="number" placeholder="ID объекта"/>
  <label class="label">Дата</label>
  <input class="form-input" id="schedule-date" type="date"/>
  <label class="label">Время от</label>
  <input class="form-input" id="schedule-time-from" type="time" step="1800"/>
  <label class="label">Время до</label>
  <input class="form-input" id="schedule-time-to" type="time" step="1800"/>
  <label class="label">Повторять до (по неделям)</label>
  <input class="form-input" id="schedule-repeat-until" type="date"/>
  <div style="display: flex; gap: 8px; margin-top: 10px;">
    <button class="save-btn" style="flex: 1;" onclick="createScheduleV2()">Создать</button>
    <button class="save-btn" style="flex: 1; background: #777;" onclick="closeScheduleForm()">Отмена</button>
  </div>
</div>

<button class="save-btn" style="width: 100%; margin-top: 12px; background: var(--accent);" onclick="toggleGroupScheduleForm()">➕ Добавить групповое занятие</button>
<div class="group-schedule-overlay" id="group-schedule-overlay" onclick="toggleGroupScheduleForm(false)"></div>
<div class="group-schedule-modal" id="group-schedule-modal">
  <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px;">
    <h4 style="margin: 0;">Групповое занятие</h4>
    <button class="save-btn" style="padding: 6px 10px; background: #777;" onclick="toggleGroupScheduleForm(false)">Закрыть</button>
  </div>
  <label class="label">Группа</label>
  <select class="form-input" id="group-schedule-group">
    <option value="">Выберите группу</option>
  </select>
  <div class="schedule-detail-card" id="group-schedule-preview" style="display: none;"></div>
  <label class="label">Дата</label>
  <input class="form-input" id="group-schedule-date" type="date"/>
  <div style="display: flex; gap: 8px;">
    <div style="flex: 1;">
      <label class="label">Время от</label>
      <input class="form-input" id="group-schedule-time-from" type="time" step="1800"/>
    </div>
    <div style="flex: 1;">
      <label class="label">Время до</label>
      <input class="form-input" id="group-schedule-time-to" type="time" step="1800"/>
    </div>
  </div>

  <div class="repeat-panel">
    <div class="repeat-row">
      <span style="font-size: 12px; font-weight: 600;">Повторять</span>
      <select class="form-input" id="repeat-mode" style="flex: 1;">
        <option value="none">Не повторять</option>
        <option value="weekly" selected>По неделям</option>
        <option value="daily">По дням</option>
        <option value="monthly">По месяцам</option>
      </select>
    </div>

    <div class="repeat-row repeat-inline" id="repeat-interval-row">
      <span>Каждую(ые)</span>
      <input class="form-input" id="repeat-interval" type="number" min="1" value="1"/>
      <span id="repeat-interval-label">неделю</span>
    </div>

    <div class="repeat-row" id="repeat-weekdays-row">
      <span class="chip" data-day="1">Пн</span>
      <span class="chip" data-day="2">Вт</span>
      <span class="chip" data-day="3">Ср</span>
      <span class="chip" data-day="4">Чт</span>
      <span class="chip" data-day="5">Пт</span>
      <span class="chip" data-day="6">Сб</span>
      <span class="chip" data-day="0">Вс</span>
    </div>

  <div class="repeat-row repeat-inline">
      <label class="label" style="margin: 0;">До</label>
      <input class="form-input" id="repeat-until" type="date"/>
  </div>

    <div class="repeat-summary" id="repeat-summary">Без повторения</div>
  </div>

  <div style="display: flex; gap: 8px; margin-top: 10px;">
    <button class="save-btn" style="flex: 1;" onclick="createGroupSchedule()">Создать</button>
    <button class="save-btn" style="flex: 1; background: #777;" onclick="toggleGroupScheduleForm(false)">Отмена</button>
  </div>
</div>
</div>
</div>
<!-- ====== НАПРАВЛЕНИЯ И ГРУППЫ ====== -->
<div class="page" data-title="📚 Направления и группы" id="directions-groups">

<div class="card" style="margin-bottom: 12px;">
<button class="save-btn" onclick="showPage('direction-create-form')" style="width: 100%;">➕ Создать направление</button>
</div>
<!-- ВКЛАДКИ -->
<div class="tabs-container" style="display: flex; gap: 8px; margin-bottom: 12px; border-bottom: 2px solid var(--border); position: relative;">
<button class="nav-tab" id="active-tab" onclick="switchDirectionTab('active')" style="flex: 1; padding: 12px; background: none; border: none; color: var(--accent); font-weight: bold; cursor: pointer;">✅ Активные</button>
<button class="nav-tab" id="archived-tab" onclick="switchDirectionTab('archived')" style="flex: 1; padding: 12px; background: none; border: none; color: var(--hint); font-weight: bold; cursor: pointer;">📦 Архив</button>
<div class="tab-indicator"></div>
</div>
<div id="directions-groups-container">
<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">⏳ Загрузка...</p>
</div>
</div>
<!-- ====== РАССЫЛКИ ====== -->
<div class="page" data-title="📧 Рассылки" id="mailings">

<button class="save-btn" onclick="showPage('mailing-create-form')" style="width: 100%; margin-bottom: 16px;">✉️ Создать новую рассылку</button>
<div id="mailings-container">
<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">⏳ Загрузка...</p>
</div>
</div>
<!-- ====== ФОРМА СОЗДАНИЯ РАССЫЛКИ ====== -->
<div class="page" data-title="✉️ Создать рассылку" id="mailing-create-form">

<!-- БЛОК 1: ОСНОВНЫЕ ДАННЫЕ -->
<div class="card" style="margin-bottom: 16px; border-left: 4px solid var(--accent);">
<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 14px; padding-bottom: 12px; border-bottom: 2px solid var(--border);">
<span style="font-size: 20px;">📝</span>
<h4 style="margin: 0;">Основные данные</h4>
</div>
<!-- Название рассылки -->
<label class="label" style="font-weight: 600;">Название рассылки</label>
<input class="form-input" id="mailing-name" placeholder="Например: Расписание смены" style="margin-bottom: 14px;" type="text"/>
<!-- Описание рассылки -->
<label class="label" style="font-weight: 600;">Описание</label>
<textarea class="form-input" id="mailing-description" placeholder="Описание рассылки..." style="margin-bottom: 14px; min-height: 80px; resize: vertical;"></textarea>
<!-- Назначение -->
<label class="label" style="font-weight: 600;">Назначение</label>
<input class="form-input" id="mailing-purpose" placeholder="Например: Информирование, Приглашение, Напоминание..." type="text"/>
</div>
<!-- БЛОК 2: КОМ ОТПРАВИТЬ -->
<div class="card" style="margin-bottom: 16px; border-left: 4px solid var(--accent);">
<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 14px; padding-bottom: 12px; border-bottom: 2px solid var(--border);">
<span style="font-size: 20px;">📝</span>
<h4 style="margin: 0;">Кому отправить</h4>
</div>
<!-- Тип кому отправлять -->
<label class="label" style="font-weight: 600;">Тип рассылки</label>
<select class="form-input" id="mailing-target-type" onchange="onMailingTargetTypeChange()" style="margin-bottom: 14px; font-size: 14px;">
<option value="">-- Выберите тип --</option>
<option value="all">🌍 Все пользователи</option>
<option value="user">👤 Выбранные пользователи</option>
<option value="group">👫 Группе НГ (от бота участникам группы)</option>
<option value="direction">💃 Направление</option>
<option value="tg_chat">📱 Telegram-группа/канал</option>
</select>
<!-- Контейнер для выбора пользователей -->
<div id="mailing-users-container" style="display: none;">
<label class="label" style="font-weight: 600;">🔍 Выбор пользователей</label>
<!-- Поиск пользователей -->
<input class="form-input" id="mailing-users-search" oninput="searchMailingUsers()" placeholder="Поиск по имени, ID или @юзернейм..." style="margin-bottom: 10px;" type="text"/>
<!-- Результаты поиска -->
<div id="mailing-users-search-results" style="max-height: 300px; overflow-y: auto; background: var(--card); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 12px; padding: 8px;">
<p class="small" style="text-align: center; color: var(--hint); padding: 12px;">Загрузка пользователей...</p>
</div>
<!-- Выбранные пользователи -->
<div style="background: var(--card); padding: 12px; border-radius: 8px; border: 1px solid var(--border); box-shadow: 0 8px 22px rgba(0, 0, 0, 0.3);">
<label class="label" style="font-weight: 600; margin-bottom: 8px;">✓ Выбранные пользователи</label>
<div id="mailing-selected-users" style="display: flex; flex-wrap: wrap; gap: 8px; min-height: 32px; align-content: flex-start;">
<p class="small" style="color: var(--hint); width: 100%;">Выбрано: <span id="mailing-users-count" style="font-weight: 600;">0</span></p>
</div>
</div>
</div>
<!-- ID цели (для направлений и Telegram) -->
<div id="mailing-target-id-container" style="display: none;">
<label class="label" style="font-weight: 600;">ID направления/группы Telegram</label>
<input class="form-input" id="mailing-target-id" placeholder="Введите ID" type="number"/>
</div>
</div>
<!-- БЛОК 3: ВРЕМЯ ОТПРАВКИ -->
<div class="card" style="margin-bottom: 16px; border-left: 4px solid #4CAF50;">
<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 14px; padding-bottom: 12px; border-bottom: 2px solid var(--border);">
<span style="font-size: 20px;">⏰</span>
<h4 style="margin: 0;">Время отправки</h4>
</div>
<!-- Выбор времени отправки -->
<label class="label" style="font-weight: 600; margin-bottom: 10px;">Когда отправить</label>
<div style="display: flex; gap: 10px; margin-bottom: 14px;">
<button class="save-btn" id="send-now-btn" onclick="setMailingSendNow(true)" style="flex: 1; background: var(--accent); font-weight: 600; padding: 12px;">▶️ Сейчас</button>
<button class="save-btn" onclick="setMailingSendNow(false)" style="flex: 1; background: var(--hint); font-weight: 600; padding: 12px;">⏲️ Позже</button>
</div>
<!-- Дата и время для отложенной отправки -->
<div id="mailing-schedule-container" style="display: none;">
<label class="label" style="font-weight: 600;">Дата и время отправки</label>
<input class="form-input" id="mailing-scheduled-at" type="datetime-local"/>
</div>
</div>
<!-- КНОПКА СОЗДАНИЯ -->
<div class="card" style="background: linear-gradient(135deg, var(--accent) 0%, #c2185b 100%); padding: 0; border: none;">
<button class="save-btn" onclick="createMailing()" style="width: 100%; background: transparent; color: white; font-size: 16px; font-weight: 600; padding: 16px; border: none; cursor: pointer;">✉️ Создать рассылку</button>
</div>
</div>
<!-- ====== ОБЪЯВЛЕНИЯ (СТАРОЕ) ====== -->
<div class="page" data-title="Объявления" id="announcements" style="display: none;">

<button class="save-btn" style="width: 100%; margin-bottom: 16px;">📝 Создать объявление</button>
<div id="announcements-container">
<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">⏳ Загрузка...</p>
</div>
</div>
<!-- ====== УПРАВЛЕНИЕ НОВОСТЯМИ ====== -->
<div class="page" data-title="📰 Новости" id="news-manage">

<div style="display: flex; gap: 8px; margin-bottom: 10px;">
  <button class="save-btn" style="flex: 1;" onclick="openBotForCreateNews()">Создать через бота</button>
  <button class="save-btn" style="flex: 1; background: var(--accent);" onclick="openNewsCreateModal()">Создать на сайте</button>
</div>

<div id="news-manage-container">
<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">⏳ Загрузка...</p>
</div>
</div>

<!-- ====== ПОЛНОЭКРАННАЯ ПОСЕЩАЕМОСТЬ ====== -->
<div class="page attendance-screen" id="attendance-screen" data-title="Посещаемость">
  <div class="attendance-screen-header">
    <button class="save-btn" style="padding: 6px 10px; background:#444;" onclick="goBack()">Назад</button>
    <div style="flex:1;">
      <div id="attendance-screen-title" style="font-weight:700;">Занятие</div>
      <div id="attendance-screen-subtitle" class="small" style="color:var(--hint);"></div>
    </div>
  </div>
  <div class="attendance-actions-row" style="display:flex; gap:8px; margin:10px 0 6px 0;">
    <button class="save-btn" style="flex:1; background:#444;" onclick="markAllPresent()">Все присутствуют</button>
    <button class="save-btn" style="flex:1; background:#2e2e2e;" onclick="promptAddAttendanceUser()">Добавить</button>
  </div>
  <div id="attendance-screen-list" class="attendance-list"></div>
  <div class="attendance-footer" style="margin-top:10px;">
    <button class="save-btn" style="flex:1; background:var(--accent);" onclick="saveAttendance()">Сохранить</button>
  </div>
  <div class="small" id="attendance-screen-status" style="margin-top:6px; color: var(--hint);"></div>
</div>

<!-- Модал создания новости -->
<div class="schedule-detail-overlay" id="news-create-overlay" onclick="toggleNewsCreate(false)"></div>
<div class="schedule-detail-modal modal-fullscreen" id="news-create-modal">
  <div style="display:flex; justify-content: space-between; align-items: center; gap: 8px;">
    <h4 style="margin: 0;">Создать новость</h4>
    <button class="save-btn" style="padding: 6px 10px; background: #777;" onclick="toggleNewsCreate(false)">Закрыть</button>
  </div>
  <label class="label">Заголовок</label>
  <input class="form-input" id="news-create-title" type="text" placeholder="Заголовок">
  <label class="label">Описание</label>
  <textarea class="form-input" id="news-create-content" rows="6" placeholder="Описание"></textarea>
  <label class="label">Фото</label>
  <div class="photo-picker">
    <div class="photo-preview" id="news-photo-preview"><span class="small" style="color: var(--hint);">Нет фото</span></div>
    <div style="display:flex; flex-direction: column; gap:6px; flex:1;">
      <button class="save-btn" style="width: 100%; margin:0;" onclick="triggerNewsPhoto()">Выбрать фото</button>
      <button class="save-btn" style="width: 100%; margin:0; background:#333;" onclick="clearNewsPhoto()">Удалить фото</button>
      <input id="news-create-photo" type="file" accept="image/*" style="display:none;">
    </div>
  </div>
  <button class="save-btn" style="width: 100%; margin-top:12px;" onclick="submitNewsCreate()">Сохранить</button>
  <div class="small" id="news-create-status" style="margin-top:6px; color: var(--hint);"></div>
</div>
<!-- ====== УПРАВЛЕНИЕ ПЕРСОНАЛОМ (ИЗ РАБОТЫ) ====== -->
<div class="page" data-title="👥 Персонал" id="staff-manage">

<button class="save-btn" onclick="showAddStaffForm()" style="width: 100%; margin-bottom: 16px;">➕ Добавить персонал</button>
<div class="card" style="margin-bottom: 16px;">
<h4>🔍 Поиск персонала</h4>
<input class="form-input" id="staff-manage-search" oninput="searchStaffManage()" placeholder="Имя, ID или @юзернейм" style="margin-top: 8px;" type="text"/>
</div>
<div class="clients-list staff-list-cards" id="staff-manage-container">
<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">⏳ Загрузка...</p>
</div>
</div>
<!-- ====== КЛИЕНТЫ ====== -->
<div class="page" data-title="👨‍👩‍👧‍👦 Клиенты" id="clients-list">

<div class="card">
<h4>🔍 Поиск клиента</h4>
<input class="form-input" id="staff-search-input" oninput="searchClients()" placeholder="Введите имя или ID клиента..." style="margin-bottom: 12px;" type="text"/>
<div style="display:flex; gap:8px; flex-wrap:wrap;">
<button class="save-btn" onclick="openCreateClientModal()" style="flex:1; margin:0; min-width: 180px;">➕ Создать клиента</button>
<button class="save-btn" onclick="openMergeClientsModal()" style="flex:1; margin:0; min-width: 180px; background:#444;">🔀 Объединение клиентов</button>
</div>
</div>
<div class="clients-list" id="clients-list-container">
<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">⏳ Загрузка...</p>
</div>
</div>
<div class="schedule-detail-overlay" id="client-detail-overlay" onclick="closeClientDetailModal()"></div>
<div class="schedule-detail-modal modal-fullscreen" id="client-detail-modal">
<div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
<h4 style="margin:0;">Карточка клиента</h4>
<button class="save-btn" style="padding:6px 10px; background:#777;" onclick="closeClientDetailModal()">Закрыть</button>
</div>
<div class="small" style="margin-top:8px; color:var(--hint);">Клиент</div>
<div id="client-detail-name" style="font-weight:700; font-size:16px; margin-top:2px;">—</div>
<div class="small" id="client-detail-meta" style="margin-top:6px; color:var(--hint);">—</div>
<div class="card" style="margin-top:12px;">
<h4 style="margin-top:0;">Действия</h4>
<button class="save-btn" style="width:100%; margin:0 0 8px 0;" onclick="openClientAttendanceCalendarScreen()">Календарь посещаемости</button>
<button class="save-btn" style="width:100%; margin:0;" onclick="openClientAbonementExtendScreen()">Продлить абонемент</button>
</div>
</div>
<div class="schedule-detail-overlay" id="client-create-overlay" onclick="closeCreateClientModal()"></div>
<div class="schedule-detail-modal modal-fullscreen" id="client-create-modal">
<div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
<h4 style="margin:0;">Создать клиента</h4>
<button class="save-btn" style="padding:6px 10px; background:#777;" onclick="closeCreateClientModal()">Закрыть</button>
</div>
<div class="form-group">
<label>Имя *</label>
<input class="form-input" id="client-create-name" placeholder="Имя клиента" type="text"/>
</div>
<div class="form-group">
<label>Telegram ID</label>
<input class="form-input" id="client-create-telegram-id" placeholder="Необязательно" type="number"/>
</div>
<div class="form-group">
<label>Username</label>
<input class="form-input" id="client-create-username" placeholder="Без @" type="text"/>
</div>
<div class="form-group">
<label>Телефон</label>
<input class="form-input" id="client-create-phone" placeholder="+7..." type="text"/>
</div>
<div class="form-group">
<label>Email</label>
<input class="form-input" id="client-create-email" placeholder="mail@example.com" type="email"/>
</div>
<div class="form-group">
<label>Пожелания клиента</label>
<textarea class="form-input" id="client-create-user-notes" rows="2"></textarea>
</div>
<div class="form-group">
<label>Заметки персонала</label>
<textarea class="form-input" id="client-create-staff-notes" rows="2"></textarea>
</div>
<button class="save-btn" onclick="submitCreateClient()" style="width:100%; margin:0;">Создать</button>
<div class="small" id="client-create-status" style="margin-top:8px; color:var(--hint);"></div>
</div>
<div class="schedule-detail-overlay" id="client-merge-overlay" onclick="closeMergeClientsModal()"></div>
<div class="schedule-detail-modal modal-fullscreen" id="client-merge-modal">
<div style="display:flex; align-items:center; gap:8px;">
<h4 style="margin:0;">Параметры объединения</h4>
</div>
<div class="form-group">
<label>Неправильный профиль (source)</label>
<select class="form-input" id="client-merge-source-id"></select>
</div>
<div class="form-group">
<label>Правильный профиль (target)</label>
<select class="form-input" id="client-merge-target-id"></select>
</div>
<div class="form-group">
<label>Комментарий</label>
<textarea class="form-input" id="client-merge-note" placeholder="Необязательно" rows="2"></textarea>
</div>
<button class="save-btn" onclick="submitMergeClients()" style="width:100%; margin:0;">Объединить</button>
<div class="small" id="client-merge-status" style="margin-top:8px; color:var(--hint);"></div>
</div>
<div class="page" data-title="🗓️ Календарь посещаемости" id="client-attendance-calendar">
<div class="card">
<div class="small" style="color:var(--hint);">Клиент</div>
<div id="client-calendar-screen-name" style="font-weight:700; font-size:16px; margin-top:2px;">—</div>
<div class="small" id="client-calendar-screen-meta" style="margin-top:6px; color:var(--hint);">—</div>
</div>
<div class="card">
<div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:10px;">
<button class="save-btn" style="width:auto; margin:0; padding:8px 12px;" onclick="shiftClientAttendanceMonth(-1)">◀</button>
<div id="client-calendar-month-label" style="font-weight:700;">—</div>
<button class="save-btn" style="width:auto; margin:0; padding:8px 12px;" onclick="shiftClientAttendanceMonth(1)">▶</button>
</div>
<div id="client-calendar-grid"></div>
<div class="small" style="margin-top:10px; color:var(--hint);">Легенда: П - пришел, Н - неявка, Б - больничный</div>
<div class="small" id="client-calendar-status" style="margin-top:8px; color:var(--hint);"></div>
<div class="client-sick-bottom-actions" id="client-sick-bottom-actions">
<button class="save-btn" id="client-sick-confirm-btn" style="flex:1; margin:0;" onclick="confirmClientSickRange()">Подтвердить</button>
<button class="save-btn" id="client-sick-cancel-btn" style="flex:1; margin:0; background:#555;" onclick="cancelClientSickRange()">Отменить</button>
</div>
</div>
<div class="card">
<h4 style="margin-top:0;">Оформить больничный</h4>
<div class="form-group">
<label>С даты</label>
<input class="form-input" id="client-calendar-sick-date-from" type="date" oninput="onClientSickDateInputsChanged()"/>
</div>
<div class="form-group">
<label>По дату</label>
<input class="form-input" id="client-calendar-sick-date-to" type="date" oninput="onClientSickDateInputsChanged()"/>
</div>
<div class="form-group">
<label>Комментарий</label>
<textarea class="form-input" id="client-calendar-sick-note" rows="2" placeholder="Необязательно"></textarea>
</div>
<button class="save-btn" id="client-sick-range-start-btn" style="width:100%; margin:0;" onclick="startClientSickRangeSelection()">Выбрать период на календаре</button>
<div class="small" id="client-calendar-sick-status" style="margin-top:8px; color:var(--hint);"></div>
</div>
</div>
<div class="page" data-title="🎟️ Продление абонемента" id="client-abonement-extend">
<div class="card">
<div class="small" style="color:var(--hint);">Клиент</div>
<div id="client-extend-screen-name" style="font-weight:700; font-size:16px; margin-top:2px;">—</div>
<div class="small" id="client-extend-screen-meta" style="margin-top:6px; color:var(--hint);">—</div>
</div>
<div class="card">
<h4 style="margin-top:0;">Абонемент</h4>
<select class="form-input" id="client-extend-abonement-select" onchange="onClientExtendAbonementChange()"></select>
<div class="small" id="client-extend-abonement-info" style="margin-top:8px; color:var(--hint);">—</div>
</div>
<div class="card">
<h4 style="margin-top:0;">Параметры продления</h4>
<div class="form-group">
<label>Недели</label>
<input class="form-input" id="client-extend-weeks-input" min="1" step="1" type="number" oninput="syncClientExtendFromWeeksInput()"/>
<input id="client-extend-weeks-range" min="1" max="24" step="1" type="range" style="width:100%; margin-top:8px;" oninput="syncClientExtendFromWeeksRange()"/>
</div>
<div class="form-group">
<label>Занятия</label>
<input class="form-input" id="client-extend-lessons-input" min="1" step="1" type="number" oninput="syncClientExtendFromLessonsInput()"/>
<input id="client-extend-lessons-range" min="1" max="24" step="1" type="range" style="width:100%; margin-top:8px;" oninput="syncClientExtendFromLessonsRange()"/>
</div>
<div class="form-group">
<label>Комментарий</label>
<textarea class="form-input" id="client-extend-note" rows="2" placeholder="Необязательно"></textarea>
</div>
<button class="save-btn" style="width:100%; margin:0;" onclick="submitClientAbonementExtend()">Применить продление</button>
<div class="small" id="client-extend-status" style="margin-top:8px; color:var(--hint);"></div>
</div>
</div>
<!-- ====== ПРОФИЛЬ ====== -->
<div class="page" data-title="👤 Профиль" id="profile">
<div class="profile">
<div class="avatar" id="avatar"></div>
<h3 id="profile-name">—</h3>
<p class="small" id="profile-username">—</p>
</div>
<div class="menu-item" onclick="showPage('profile-info')">📋 Личная информация</div>
<div class="menu-item" onclick="showPage('profile-abonements')">🎟️ Абонементы</div>
<div class="menu-item" onclick="showPage('profile-booking-requests')">🧾 Мои заявки</div>
<div class="menu-item" onclick="showPage('profile-settings')">⚙️ Настройки</div>
</div>
<div class="page" data-title="📋 Личная информация" id="profile-info">
<div class="card">
<h4>Личная информация</h4>
<div class="form-group">
<label>Имя</label>
<input class="form-input" id="profile-input-name" placeholder="Ваше имя" type="text"/>
</div>
<div class="form-group">
<label>Телефон</label>
<div style="display: flex; gap: 8px; align-items: center;">
<input class="form-input" id="profile-input-phone" placeholder="+7 800 555 35 35" type="tel" style="flex: 1;"/>
<button class="save-btn" id="profile-request-phone-btn" onclick="requestPhoneFromTelegram()" style="width: auto; padding: 10px 12px; white-space: nowrap;">Запросить в TG</button>
</div>
<p class="small" id="profile-request-phone-status" style="margin-top: 6px; color: var(--hint);"></p>
</div>
<div class="form-group">
<label>Дата рождения</label>
<input class="form-input" id="profile-input-birth-date" type="date"/>
</div>
<button class="save-btn" onclick="saveProfileChanges()">💾 Сохранить изменения</button>
</div>
<div class="card profile-account-info-card">
<h4>Информация об аккаунте</h4>
<p class="small"><strong>Статус:</strong> <span id="profile-status">—</span></p>
<p class="small"><strong>Дата регистрации:</strong> <span id="profile-registered">—</span></p>
</div>
</div>
<div class="page" data-title="🎟️ Абонементы" id="profile-abonements">
<div id="profile-abonements-container">
<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">Загрузка...</p>
</div>
</div>
<div class="page" data-title="🧾 Мои заявки" id="profile-booking-requests">
<div id="profile-booking-requests-container">
<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">Загрузка...</p>
</div>
</div>
<div class="page" data-title="⚙️ Настройки" id="profile-settings">
<div class="menu-item" onclick="showPage('display-settings')">🖥️ Отображение</div>
</div>
<div class="page" data-title="🖥️ Отображение" id="display-settings">
<div class="card">
<h4>Режим окна</h4>
<div class="form-group">
<label for="display-mode-select">Формат отображения</label>
<select class="form-input" id="display-mode-select" onchange="onDisplayModeChange(this.value)">
<option value="fullsize">Fullsize (рекомендуется)</option>
<option value="fullscreen">Fullscreen</option>
</select>
<p class="small" id="display-mode-desktop-note" style="display:none; color:#f2c94c; margin-top:6px;">Настройка недоступна на ПК</p>
</div>
<p class="small" id="display-mode-status" style="color: var(--hint); margin-top: 6px;">—</p>
</div>
</div>
<div class="page" data-title="💳 Управление оплатой" id="payment-profiles-admin">
<div class="card" style="margin-bottom: 12px;">
<h4>Активный профиль</h4>
<div class="small" id="payment-profiles-active-label" style="margin-bottom: 10px; color: var(--hint);">—</div>
<div class="payment-tabs-container" id="payment-tabs-container">
<button class="payment-tab-btn" id="payment-tab-1" type="button" onclick="selectPaymentProfileTab(1)">✅ Профиль 1</button>
<button class="payment-tab-btn" id="payment-tab-2" type="button" onclick="selectPaymentProfileTab(2)">💳 Профиль 2</button>
<div class="payment-tab-indicator" id="payment-tab-indicator"></div>
</div>
</div>
<div class="card" style="margin-bottom: 12px;">
<h4>Профиль 1</h4>
<div class="form-group">
<label>Банк получателя</label>
<input class="form-input" id="payment-profile-1-bank" type="text" placeholder="Например: Сбербанк"/>
</div>
<div class="form-group">
<label>Номер</label>
<input class="form-input" id="payment-profile-1-number" type="text" placeholder="Номер карты / счета / телефона"/>
</div>
<div class="form-group">
<label>ФИО получателя</label>
<input class="form-input" id="payment-profile-1-full-name" type="text" placeholder="Иванов Иван Иванович"/>
</div>
<button class="save-btn" type="button" onclick="savePaymentProfile(1)">Сохранить профиль 1</button>
</div>
<div class="card">
<h4>Профиль 2</h4>
<div class="form-group">
<label>Банк получателя</label>
<input class="form-input" id="payment-profile-2-bank" type="text" placeholder="Например: Т-Банк"/>
</div>
<div class="form-group">
<label>Номер</label>
<input class="form-input" id="payment-profile-2-number" type="text" placeholder="Номер карты / счета / телефона"/>
</div>
<div class="form-group">
<label>ФИО получателя</label>
<input class="form-input" id="payment-profile-2-full-name" type="text" placeholder="Петров Петр Петрович"/>
</div>
<button class="save-btn" type="button" onclick="savePaymentProfile(2)">Сохранить профиль 2</button>
</div>
</div>
<!-- ====== РАСПИСАНИЕ ПЕРСОНАЛА ====== -->
<div class="page" data-title="📅 Расписание сотрудника" id="staff-schedule">

<div id="staff-schedule-container">
<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">⏳ Загрузка...</p>
</div>
<!-- Кнопка создания занятия для учителя -->
<div id="teacher-create-btn-container" style="display: none; padding: 16px; padding-top: 0;">
<button class="save-btn" onclick="openCreateSchedule()" style="width: 100%;">➕ Создать занятие</button>
</div>
</div>
<!-- ====== СОЗДАНИЕ/РЕДАКТИРОВАНИЕ ЗАНЯТИЯ ====== -->
<div class="page" data-title="🗓 Занятие" id="schedule-form">

<div class="card">
<div class="form-group">
<label>Название занятия</label>
<input class="form-input" id="schedule-input-title" placeholder="Балет, Хип-хоп и т.д." type="text"/>
</div>
<div class="form-group">
<label>Преподаватель</label>
<select class="form-input" id="schedule-input-teacher">
<option value="">Выберите преподавателя</option>
</select>
</div>
<div class="form-group">
<label>Дата</label>
<input class="form-input" id="schedule-input-date" type="date"/>
</div>
<div class="form-group">
<label>Время начала</label>
<input class="form-input" id="schedule-input-start" type="time"/>
</div>
<div class="form-group">
<label>Время окончания</label>
<input class="form-input" id="schedule-input-end" type="time"/>
</div>
<div style="display: flex; gap: 8px;">
<button class="save-btn" onclick="saveSchedule()" style="flex: 1;">💾 Сохранить</button>
<button class="save-btn" id="schedule-delete-btn" onclick="deleteSchedule()" style="flex: 1; background: #ff6b6b; display: none;">🗑️ Удалить</button>
</div>
</div>
</div>
<!-- ====== УПРАВЛЕНИЕ ПЕРСОНАЛОМ ====== -->
<div class="page" data-title="👥 Персонал" id="staff-management">

<button class="save-btn" onclick="showAddStaffForm()" style="width: 100%; margin-bottom: 12px;">➕ Добавить персонал</button>
<div class="clients-list staff-list-cards" id="staff-list-container">
<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">⏳ Загрузка...</p>
</div>
</div>
<!-- ====== ФОРМА ДОБАВЛЕНИЯ ПЕРСОНАЛА ====== -->
<div class="page" data-title="? Добавить персонал" id="staff-add-form">

<div class="card">
<div class="form-group">
<label>🔍 Поиск пользователя</label>
<input class="form-input" id="staff-user-search" oninput="searchForStaffUser()" placeholder="Имя, ID или @юзер" type="text"/>
</div>
<div id="staff-user-search-results" style="max-height: 280px; overflow-y: auto; margin-bottom: 16px; border-radius: 8px; background: var(--card); padding: 8px; border: 1px solid var(--border);">
<p class="small" style="text-align: center; color: var(--hint); padding: 16px 0;">Начните вводить для поиска...</p>
</div>
</div>
<!-- Общие поля для обоих способов -->
<div class="card">
<div class="form-group">
<label>Должность *</label>
<select class="form-input" id="staff-add-position" onchange="updateStaffTeachesToggle()">
<option value="">Выберите должность</option>
<option value="учитель">👩‍🏫 Учитель</option>
<option value="администратор">📋 Администратор</option>
<option value="старший админ">🛡️ Старший админ</option>
</select>
</div>


<div class="form-group">
<label>👩‍🏫 Преподает</label>
<label style="display: inline-flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text);">
<input id="staff-add-teaches" type="checkbox"/>
<span>Преподаватель</span>
</label>
</div>
<div class="form-group">
<label>Специализация (опционально)</label>
<input class="form-input" id="staff-add-specialization" placeholder="Балет, Хип-хоп и т.д." type="text"/>
</div>
<div class="form-group">
<label>Биография (опционально)</label>
<textarea class="form-input" id="staff-add-bio" placeholder="Описание сотрудника" style="height: 80px; resize: none;"></textarea>
</div>
<label style="display: inline-flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text); margin-bottom: 12px;">
<input id="staff-add-notify" type="checkbox" checked/>
<span>Отправить уведомление в Telegram</span>
</label>
<button class="save-btn" onclick="saveNewStaff()" style="width: 100%; margin-top: 12px;">💾 Добавить персонал</button>
</div>
</div>
<!-- ====== СТРАНИЦА ПЕРСОНАЛА ====== -->
<div class="page" id="staff-detail">
<div class="profile">
<div class="avatar" id="staff-detail-avatar">
<img alt="Фото" id="staff-detail-avatar-img" src="" style="display: none;"/>
<p style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--hint); margin: 0;">👤</p>
</div>
<h3 id="staff-detail-name">—</h3>
<p class="small" id="staff-detail-position">—</p>
</div>
<div class="card">
<h4 style="margin: 0 0 8px 0;">📋 Информация</h4>
<div style="margin-bottom: 8px;">
<label style="font-size: 12px; color: var(--hint); line-height: 1.2;">Должность</label>
<div id="staff-detail-position-full" style="font-size: 15px; margin-top: 2px;">—</div>
</div>
<div id="staff-detail-phone-block" style="margin-bottom: 8px; display: none;">
<label style="font-size: 12px; color: var(--hint); line-height: 1.2;">Телефон</label>
<div id="staff-detail-phone" style="font-size: 15px; margin-top: 2px;">—</div>
</div>
<div style="margin-bottom: 4px;">
<label style="font-size: 12px; color: var(--hint); line-height: 1.2;">Специализация</label>
<div id="staff-detail-specialization" style="font-size: 15px; margin-top: 2px;">—</div>
</div>
</div>
<div class="card">
<h4>📝 Биография</h4>
<p id="staff-detail-bio" style="white-space: pre-wrap; line-height: 1.5;">—</p>
</div>
<button class="save-btn" onclick="deleteCurrentStaff()" style="width: 100%; background: #ff6b6b;">🗑️ Удалить персонал</button>
</div>
<!-- ====== ФОРМА СОЗДАНИЯ НАПРАВЛЕНИЯ ====== -->
<div class="page" data-title="➕ Создать направление" id="direction-create-form">

<div class="card" style="margin-bottom: 16px; border-left: 4px solid var(--accent);">
<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 14px; padding-bottom: 12px; border-bottom: 2px solid var(--border);">
<span style="font-size: 20px;">📝</span>
<h4 style="margin: 0;">Основная информация</h4>
</div>
<!-- Название -->
<label class="label" style="font-weight: 600;">Название направления *</label>
<input class="form-input" id="direction-title" placeholder="Например: Балет, Хип-хоп, Современный танец" style="margin-bottom: 14px;" type="text"/>
<!-- Описание -->
<label class="label" style="font-weight: 600;">Описание *</label>
<textarea class="form-input" id="direction-description" placeholder="Опишите направление..." style="margin-bottom: 14px; min-height: 100px; resize: vertical;"></textarea>
<!-- Тип -->
<label class="label" style="font-weight: 600;">Тип направления *</label>
<select class="form-input" id="direction-type" style="margin-bottom: 14px;">
  <option value="dance">💃 Танцевальное</option>
  <option value="sport">🏅 Спортивное</option>
</select>
<!-- Цена -->
<label class="label" style="font-weight: 600;">Базовая цена (?) *</label>
<input class="form-input" id="direction-price" placeholder="Например: 5000" style="margin-bottom: 14px;" type="number"/>
</div>
<div class="card" style="margin-bottom: 16px; border-left: 4px solid #4CAF50;">
<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 14px; padding-bottom: 12px; border-bottom: 2px solid var(--border);">
<span style="font-size: 20px;">📝</span>
<h4 style="margin: 0;">Фотография</h4>
</div>
<!-- Статус загрузки -->
<div id="direction-photo-status" style="padding: 12px; background: #1f1f1f; border-radius: 8px; margin-bottom: 12px; text-align: center;">
<p style="margin: 0; color: var(--hint); font-size: 14px;">❌ Фотография не загружена</p>
</div>
<!-- Скрытый file picker -->
<input id="direction-photo-file" type="file" accept="image/jpeg,image/png,image/webp" style="display: none;" onchange="onDirectionPhotoFileSelected(event)">
<!-- Загрузка из галереи -->
<button class="save-btn" id="direction-upload-gallery-btn" onclick="startDirectionGalleryUpload()" style="width: 100%; margin-bottom: 8px; background: var(--accent);">
      🖼️ Загрузить фото из галереи
    </button>
<!-- Альтернатива: загрузка через бота -->
<button class="save-btn" id="direction-upload-btn" onclick="generateDirectionUploadToken()" style="width: 100%; margin-bottom: 8px; background: #111;">
      📱 Загрузить фото через бот
    </button>
<p style="font-size: 12px; color: var(--hint); margin: 0; line-height: 1.5;">
      💡 Можно загрузить фото из галереи или через бота. После загрузки фото кнопка “Создать направление” станет активной.
    </p>
</div>
<button class="save-btn" id="direction-create-btn" onclick="createDirection()" style="width: 100%; margin-bottom: 8px; background: #4CAF50;">
    ✅ Создать направление
  </button>
<button class="save-btn" onclick="goBack()" style="width: 100%; background: #777;">
    ? Отменить
  </button>
<!-- Сообщение об ошибке -->
<div id="direction-error-msg" style="margin-top: 12px; padding: 12px; background: rgba(244, 67, 54, 0.18); border-radius: 8px; color: #ffb3b3; display: none;">
<p id="direction-error-text" style="margin: 0;"></p>
</div>
<!-- Сообщение об успехе -->
<div id="direction-success-msg" style="margin-top: 12px; padding: 12px; background: rgba(76, 175, 80, 0.2); border-radius: 8px; color: #c8e6c9; display: none;">
<p id="direction-success-text" style="margin: 0;"></p>
</div>
</div>
<!-- ====== РЕДАКТИРОВАНИЕ НАПРАВЛЕНИЯ ====== -->
<div class="page" data-title="✏️ Редактировать направление" id="direction-edit-form">
<div class="direction-edit-header">

<button class="lock-btn" id="direction-edit-lock-btn" onclick="toggleDirectionEditLock()" title="Разблокировать редактирование">🔓</button>
</div>
<p class="small" id="direction-edit-lock-hint" style="margin: 6px 0 12px 0;">Поля заблокированы, чтобы избежать случайных изменений.</p>
<!-- ГРУППЫ -->
<div class="card" style="margin-bottom: 16px; border-left: 4px solid #fe5815;">
<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 14px; padding-bottom: 12px; border-bottom: 2px solid var(--border);">
<span style="font-size: 20px;">📝</span>
<h4 style="margin: 0; flex: 1;">Группы</h4>
<button class="lock-btn" onclick="openCreateGroupPage()" title="Создать группу">➕</button>
</div>
<div id="edit-direction-groups-list" style="display: flex; flex-direction: column; gap: 8px;">
<p style="text-align: center; color: var(--hint); padding: 12px; margin: 0;">⏳ Загрузка групп...</p>
</div>
</div>
<!-- ОСНОВНАЯ ИНФОРМАЦИЯ -->
<div class="card direction-lockable" style="margin-bottom: 16px; border-left: 4px solid var(--accent);">
<div aria-hidden="true" class="lock-overlay"></div>
<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 14px; padding-bottom: 12px; border-bottom: 2px solid var(--border);">
<span style="font-size: 20px;">📝</span>
<h4 style="margin: 0;">Основная информация</h4>
</div>
<!-- Название -->
<label class="label" style="font-weight: 600;">Название направления *</label>
<input class="form-input direction-editable" id="edit-direction-title" placeholder="Например: Балет, Хип-хоп, Современный танец" style="margin-bottom: 14px;" type="text"/>
<!-- Описание -->
<label class="label" style="font-weight: 600;">Описание *</label>
<textarea class="form-input direction-editable" id="edit-direction-description" placeholder="Опишите направление..." style="margin-bottom: 14px; min-height: 100px; resize: vertical;"></textarea>
<!-- Тип -->
<label class="label" style="font-weight: 600;">Тип направления *</label>
<select class="form-input direction-editable" id="edit-direction-type" style="margin-bottom: 14px;">
  <option value="dance">💃 Танцевальное</option>
  <option value="sport">🏅 Спортивное</option>
</select>
<!-- Цена -->
<label class="label" style="font-weight: 600;">Базовая цена (?) *</label>
<input class="form-input direction-editable" id="edit-direction-price" placeholder="Например: 5000" style="margin-bottom: 14px;" type="number"/>
<!-- Статус -->
<label class="label" style="font-weight: 600;">Статус</label>
<select class="form-input direction-editable" id="edit-direction-status" style="margin-bottom: 14px;">
<option value="active">✅ Активное</option>
<option value="inactive">⏸️ Неактивное</option>
</select>
</div>
<!-- ФОТОГРАФИЯ -->
<div class="card direction-lockable" style="margin-bottom: 16px; border-left: 4px solid #4CAF50;">
<div aria-hidden="true" class="lock-overlay"></div>
<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 14px; padding-bottom: 12px; border-bottom: 2px solid var(--border);">
<span style="font-size: 20px;">📝</span>
<h4 style="margin: 0;">Фотография</h4>
</div>
<div id="edit-direction-photo-preview" style="width: 100%; height: 150px; background: #1f1f1f; border-radius: 8px; margin-bottom: 12px; display: flex; align-items: center; justify-content: center; color: var(--hint); overflow: hidden;">
      📸 Фото не загружено
    </div>
<button class="save-btn direction-editable" onclick="generateDirectionUploadToken()" style="width: 100%; margin-bottom: 8px; background: var(--accent);">
      📱 Загрузить новое фото через бот
    </button>
</div>
<!-- КНОПКИ ДЕЙСТВИЯ -->
<div class="direction-lockable" style="margin-bottom: 12px;">
<div aria-hidden="true" class="lock-overlay"></div>
<button class="save-btn direction-editable" id="direction-save-btn" onclick="saveDirectionChanges()" style="width: 100%; margin-bottom: 8px; background: #4CAF50;">
      ? Сохранить изменения
    </button>
<button class="save-btn" onclick="goBack()" style="width: 100%; background: #777;">
      ? Отменить
    </button>
</div>
<!-- Сообщение об ошибке -->
<div id="edit-direction-error-msg" style="margin-top: 12px; padding: 12px; background: rgba(244, 67, 54, 0.18); border-radius: 8px; color: #ffb3b3; display: none;">
<p id="edit-direction-error-text" style="margin: 0;"></p>
</div>
<!-- Сообщение об успехе -->
<div id="edit-direction-success-msg" style="margin-top: 12px; padding: 12px; background: rgba(76, 175, 80, 0.2); border-radius: 8px; color: #c8e6c9; display: none;">
<p id="edit-direction-success-text" style="margin: 0;"></p>
</div>
</div>
<!-- ====== РЕДАКТИРОВАНИЕ РАБОЧЕГО ПРОФИЛЯ ====== -->
<div class="page" data-title="👤 Профиль персонала" id="staff-profile-edit">

<div class="card">
<div class="form-group">
<label>Имя</label>
<input class="form-input" id="staff-profile-name" placeholder="Имя" type="text"/>
</div>
<div class="form-group">
<label>Специализация</label>
<input class="form-input" id="staff-profile-specialization" placeholder="Например: Балет, Хип?хоп" type="text"/>
</div>
<div class="form-group">
<label>Биография</label>
<textarea class="form-input" id="staff-profile-bio" placeholder="Коротко о себе..." style="min-height: 80px;"></textarea>
</div>
<div class="form-group" id="staff-profile-teaches-group" style="display: none;">
<label>👩‍🏫 Преподаёт</label>
<label style="display: inline-flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text);">
<input id="staff-profile-teaches" type="checkbox"/>
<span>Преподаватель</span>
</label>
</div>
<div class="form-group">
<label>Телефон</label>
<input class="form-input" id="staff-profile-phone" placeholder="+7 900 000 00 00" type="text"/>
</div>
<div class="form-group">
<label>Email</label>
<input class="form-input" id="staff-profile-email" placeholder="name@example.com" type="email"/>
</div>
<input id="staff-profile-photo-input" type="file" accept="image/*" style="display: none;" onchange="uploadStaffPhotoFromGallery()"/>
<button class="save-btn" onclick="openStaffPhotoPicker()" style="width: 100%; margin-top: 8px;">
      📸 Загрузить фото
    </button>
<button class="save-btn" onclick="saveStaffProfile()" style="width: 100%; margin-top: 8px;">
      💾 Сохранить
    </button>
</div>
<div class="card" style="margin-top: 12px;">
<h4 style="margin-bottom: 10px;">График работы</h4>
<button class="save-btn" onclick="openTeacherWorkingHours()" style="width: 100%;">🗓 Открыть график работы</button>
</div>
</div>
<!-- ====== РАБОЧИЕ ЧАСЫ ПРЕПОДАВАТЕЛЯ ====== -->
<div class="page" data-title="🗓 Рабочие часы" id="teacher-working-hours">
<div class="card" style="margin-bottom: 12px;">
  <div class="schedule-toolbar">
    <button class="button active" id="working-hours-view-week" onclick="setWorkingHoursView('week')">Неделя</button>
    <button class="button" id="working-hours-view-day" onclick="setWorkingHoursView('day')">День</button>
  </div>
  <div class="form-group" id="working-hours-day-select-group" style="display: none; margin-top: 12px;">
    <label>День недели</label>
    <select class="form-input" id="working-hours-day-select" onchange="renderWorkingHoursEditor()">
      <option value="0">Понедельник</option>
      <option value="1">Вторник</option>
      <option value="2">Среда</option>
      <option value="3">Четверг</option>
      <option value="4">Пятница</option>
      <option value="5">Суббота</option>
      <option value="6">Воскресенье</option>
    </select>
  </div>
</div>
<div id="working-hours-container"></div>
<div class="card" style="margin-top: 12px;">
  <button class="save-btn" onclick="saveTeacherWorkingHours()" style="width: 100%; background: #4CAF50;">✅ Сохранить рабочие часы</button>
  <button class="save-btn" onclick="goBack()" style="width: 100%; margin-top: 8px; background: #777;">❌ Назад</button>
</div>
</div>
<!-- ====== СОЗДАНИЕ ГРУППЫ ====== -->
<div class="page" data-title="? Создать группу" id="direction-group-create">

<div class="card" style="margin-bottom: 16px; border-left: 4px solid #fe5815;">
<div class="form-group">
<label>Название группы *</label>
<input class="form-input" id="edit-direction-group-name" placeholder="Например: Дети 10-12, Хип?хоп Beginners" type="text"/>
</div>
<div class="form-group">
<label>Преподаватель *</label>
<input class="form-input" id="group-teacher-search" oninput="searchGroupTeacher()" placeholder="Имя, ID или @юзер" type="text"/>
</div>
<div id="group-teacher-search-results" style="max-height: 240px; overflow-y: auto; margin-bottom: 12px; border-radius: 8px; background: var(--card); padding: 8px; border: 1px solid var(--border);">
<p class="small" style="text-align: center; color: var(--hint); padding: 12px 0;">Начните вводить для поиска...</p>
</div>
<div class="form-group">
<label>Возрастная группа *</label>
<input class="form-input" id="edit-direction-group-age" placeholder="Например: 12-16" type="text"/>
</div>
<div class="form-group">
<label>Макс. учеников *</label>
<input class="form-input" id="edit-direction-group-max" placeholder="Например: 12" type="number"/>
</div>
<div class="form-group">
<label>Длительность (мин) *</label>
<input class="form-input" id="edit-direction-group-duration" placeholder="Например: 60" type="number"/>
</div>
<div class="form-group">
<label>Занятий в неделю</label>
<input class="form-input" id="edit-direction-group-lessons" placeholder="Например: 3" type="number" min="1"/>
</div>
<div class="form-group">
<label>Описание</label>
<textarea class="form-input" id="edit-direction-group-desc" placeholder="Коротко о группе..." style="min-height: 80px;"></textarea>
</div>
<button class="save-btn" onclick="createDirectionGroup()" style="width: 100%; margin-bottom: 8px; background: #fe5815;">
      ? Создать группу
    </button>
<button class="save-btn" onclick="goBack()" style="width: 100%; background: #777;">
      ? Отменить
    </button>
<div id="edit-direction-group-msg" style="margin: 12px 0 0 0; padding: 10px; border-radius: 8px; display: none;"></div>
</div>
</div>
<!-- ====== РЕДАКТИРОВАНИЕ ГРУППЫ ====== -->
<div class="page" data-title="✏️ Редактировать группу" id="direction-group-edit">

<div class="card" style="margin-bottom: 16px; border-left: 4px solid #4CAF50;">
<div class="form-group">
<label>Название группы *</label>
<input class="form-input" id="edit-group-name" placeholder="Название группы" type="text"/>
</div>
<div class="form-group">
<label>Преподаватель *</label>
<input class="form-input" id="edit-group-teacher-search" oninput="searchEditGroupTeacher()" placeholder="Имя, ID или @юзер" type="text"/>
</div>
<div id="edit-group-teacher-search-results" style="max-height: 240px; overflow-y: auto; margin-bottom: 12px; border-radius: 8px; background: var(--card); padding: 8px; border: 1px solid var(--border);">
<p class="small" style="text-align: center; color: var(--hint); padding: 12px 0;">⏳ Загрузка преподавателей...</p>
</div>
<div class="form-group">
<label>Возрастная группа *</label>
<input class="form-input" id="edit-group-age" placeholder="Например: 12-16" type="text"/>
</div>
<div class="form-group">
<label>Макс. учеников *</label>
<input class="form-input" id="edit-group-max" placeholder="Например: 12" type="number"/>
</div>
<div class="form-group">
<label>Длительность (мин) *</label>
<input class="form-input" id="edit-group-duration" placeholder="Например: 60" type="number"/>
</div>
<div class="form-group">
<label>Занятий в неделю</label>
<input class="form-input" id="edit-group-lessons" placeholder="Например: 3" type="number" min="1"/>
</div>
<div class="form-group">
<label>Описание</label>
<textarea class="form-input" id="edit-group-desc" placeholder="Коротко о группе..." style="min-height: 80px;"></textarea>
</div>
<button class="save-btn" onclick="saveGroupChanges()" style="width: 100%; margin-bottom: 8px; background: #4CAF50;">
      ? Сохранить изменения
    </button>
<button class="save-btn" onclick="goBack()" style="width: 100%; background: #777;">
      ? Отменить
    </button>
<div id="edit-group-msg" style="margin: 12px 0 0 0; padding: 10px; border-radius: 8px; display: none;"></div>
</div>
</div>
<div class="page" data-title="ℹ️ Информация" id="info">
  <h3 id="info-title" style="display: none;"></h3>
  <p class="small" id="info-placeholder">Раздел находится в разработке</p>
  <div id="info-section-content" style="display: none;"></div>
</div>
<div class="page" data-title="👩‍🏫 Преподаватель" id="teacher-profile-page">
  <div class="card">
    <div class="teacher-profile-photo" id="teacher-profile-photo"></div>
    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
      <h3 id="teacher-profile-name">Преподаватель</h3>
      <button class="header-back" style="padding: 4px 10px; font-size: 18px;" onclick="goBack()">Назад</button>
    </div>
    <p class="small" id="teacher-profile-specialization"></p>
    <p class="teacher-detail-label">Биография</p>
    <p id="teacher-profile-bio" class="teacher-detail-text">—</p>
    <p class="teacher-detail-label">График работы</p>
    <div id="teacher-profile-schedule" class="teacher-detail-schedule">
      <p class="small">График загружается…</p>
    </div>
    <button class="save-btn" id="teacher-profile-individual-btn" onclick="openIndividualBookingForTeacher()" style="width: 100%; margin-top: 14px; margin-bottom: 8px;">
      Запись на индивидуальное занятие
    </button>
    <button class="save-btn" id="teacher-profile-groups-toggle-btn" onclick="toggleTeacherGroupsVisibility()" style="width: 100%; margin-bottom: 8px; background: #111;">
      Просмотр групп
    </button>
    <div id="teacher-profile-groups" class="teacher-detail-schedule" style="display: none;">
      <p class="small">Группы загружаются…</p>
    </div>
  </div>
</div>
<div class="page" data-title="🎯 Направление" id="direction-detail">
  <div id="direction-detail-content"></div>
</div>
<div class="page" data-title="⏱️ Индивидуальные занятия" id="info-individual">
  <div class="card individual-intro-card">
    <h3>Персональное занятие</h3>
    <p class="small">Выберите преподавателя, удобную дату, время старта и длительность — админы подтвердят бронь в чате.</p>
  </div>
  <div class="card individual-teacher-card-wrapper">
    <div class="section-title-row">
      <h4>Тренеры</h4>
      <span class="small">Прокрутите, чтобы выбрать</span>
    </div>
    <div class="individual-teacher-strip" id="individual-teacher-strip">
      <p class="small">Загрузка тренеров...</p>
    </div>
    <div class="individual-teacher-detail" id="individual-teacher-detail">
      <p class="small">Выберите преподавателя, чтобы узнать о нём.</p>
    </div>
  </div>
  <div class="card individual-date-card-wrapper">
    <div class="section-title-row">
      <h4>Выберите дату</h4>
      <span class="small">Ближайшие 1-2 недели</span>
    </div>
    <div class="individual-date-strip" id="individual-date-strip">
      <p class="small">Сначала выберите тренера</p>
    </div>
  </div>
  <div class="card individual-slot-card">
    <div class="section-title-row">
      <h4>Время</h4>
      <span class="small" id="individual-slot-duration">Шаг 30 мин · минимум 60 мин</span>
    </div>
    <div class="booking-window-strip" id="individual-window-grid">
      <p class="small">Сначала выберите преподавателя и дату</p>
    </div>
    <div class="booking-time-layout">
      <div class="booking-time-column">
        <div class="section-title-row"><span class="small">Начало</span></div>
        <div class="individual-slot-grid" id="individual-start-grid">
          <p class="small">Сначала выберите преподавателя и дату</p>
        </div>
      </div>
      <div class="booking-time-column">
        <div class="section-title-row"><span class="small">Длительность</span></div>
        <div class="individual-slot-grid" id="individual-duration-grid">
          <p class="small">Выберите начало</p>
        </div>
      </div>
    </div>
    <p class="small individual-slot-status" id="individual-slot-status"></p>
    <p class="small individual-slot-duration-display" id="individual-duration-display"></p>
  </div>
  <div class="card individual-booking-card">
    <div class="form-group">
      <label>Комментарий для админов (по желанию)</label>
      <textarea class="form-input" id="individual-booking-comment" rows="3" placeholder="Например, хочу начать с разбора техники..."></textarea>
    </div>
    <div class="individual-booking-footer">
      <button class="save-btn" id="individual-booking-submit" onclick="submitIndividualBooking()">Отправить заявку</button>
      <p class="small individual-booking-message" id="individual-booking-msg"></p>
    </div>
  </div>
</div>
<div class="page" data-title="🔑 Аренда зала" id="info-rent">
  <div class="card">
    <h3>Аренда зала</h3>
    <p class="small">Выберите удобный день, время старта и длительность — мы перенаправим запрос админам, и они подтвердят бронь в чате.</p>
  </div>
  <div class="card rental-form-card">
    <h4 style="margin:0;">Заявка на аренду</h4>
    <p class="rental-note">Поля даты, старта и длительности обязательны. После отправки администрация проверит доступность и напишет в чат.</p>
    <div class="rental-form-row">
      <div class="rental-fieldset rental-fieldset--wide">
        <label class="label" for="rental-date">Дата</label>
        <input class="form-input" id="rental-date" type="date"/>
        <p class="rental-date-hint" id="rental-date-hint">Сначала выберите дату, чтобы увидеть занятость.</p>
      </div>
    </div>
    <div class="rental-occupancy-panel" id="rental-occupancy-panel">
      <div class="rental-occupancy-header">
        <span>Занятость зала</span>
        <span id="rental-occupancy-date">—</span>
      </div>
      <div class="rental-occupancy-timeline" id="rental-occupancy-timeline"></div>
      <div class="rental-occupancy-debug small" id="rental-occupancy-debug">Запрос пока не выполнялся</div>
      <div class="rental-occupancy-list" id="rental-occupancy-list">
        <div class="small" id="rental-occupancy-placeholder">Выберите дату, чтобы увидеть занятость</div>
      </div>
    </div>
    <div class="rental-form-row">
      <div class="rental-fieldset rental-fieldset--wide">
        <label class="label">Свободные окна</label>
        <div class="rental-slot-strip" id="rental-window-grid">
          <p class="small">Выберите дату, чтобы увидеть свободные окна</p>
        </div>
      </div>
    </div>
    <div class="rental-form-row">
      <div class="rental-fieldset">
        <label class="label">Начало</label>
        <div class="rental-slot-grid" id="rental-start-grid">
          <p class="small">Выберите окно</p>
        </div>
      </div>
      <div class="rental-fieldset">
        <label class="label">Длительность</label>
        <div class="rental-slot-grid" id="rental-duration-grid">
          <p class="small">Выберите начало</p>
        </div>
      </div>
    </div>
    <p class="small rental-time-summary" id="rental-time-summary"></p>
    <div class="form-group">
      <label class="label" for="rental-purpose">Цель аренды и комментарий</label>
      <textarea class="form-input" id="rental-purpose" rows="3" placeholder="Например: репетиция, мастер-класс, фотосъёмка"></textarea>
    </div>
    <div class="form-group">
      <label class="label" for="rental-contact">Контакт</label>
      <input class="form-input" id="rental-contact" type="text" placeholder="Телеграм или телефон (чтобы админы могли уточнить)"/>
    </div>
    <button class="save-btn" id="rental-submit-btn" onclick="submitRentalBooking()">📩 Отправить заявку</button>
    <p class="rental-booking-message" id="rental-booking-msg"></p>
  </div>
  <div class="card">
    <h4 style="margin:0;">Условия</h4>
    <p class="small">Студия работает ежедневно с 09:00 до 22:00. Если время пересекается с другими событиями, админы предложат альтернативу. После подтверждения аренды мы создадим запись в расписании и отправим ссылку на оплату.</p>
  </div>
</div>
<!-- ====== ПРОСМОТР НОВОСТИ ====== -->
<div class="page" data-title="Новости" id="news-detail">
<div id="news-detail-photo-container"></div>
<div class="news-detail-content-wrapper">
<h3 id="news-detail-title"></h3>
<p class="small" id="news-detail-date"></p>
<p id="news-detail-content" style="white-space: pre-wrap;"></p>
</div>
</div>
<div class="confirm-modal-overlay" id="staff-delete-overlay" onclick="closeStaffDeleteModal()"></div>
<div class="confirm-modal" id="staff-delete-modal">
<h4 style="margin: 0 0 6px 0;">Вы действительно хотите удалить?</h4>
<p class="small" id="staff-delete-subtitle" style="margin: 0 0 12px 0; color: var(--hint);">—</p>
<label style="display: inline-flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text); margin-bottom: 12px;">
<input id="staff-delete-notify" type="checkbox" checked/>
<span>Отправить оповещение</span>
</label>
<div style="display: flex; gap: 8px;">
<button class="save-btn" onclick="confirmStaffDelete()" style="flex: 1; background: #ef5350;">Удалить</button>
<button class="save-btn" onclick="closeStaffDeleteModal()" style="flex: 1; background: var(--card); color: var(--text);">Отмена</button>
</div>
</div>
<!-- ====== НИЖНЕЕ МЕНЮ ====== -->
<div class="bottom-nav">
<div class="nav-btn active" onclick="showPage('home')">🏠<br/>Главная</div>
<div class="nav-btn" onclick="showPage('schedule')">🗓<br/>Расписание</div>
<div class="nav-btn hidden" id="staff-nav-btn" onclick="showPage('staff')">👨‍💼<br/>Работа</div>
<div class="nav-btn" onclick="showPage('profile')">👤<br/>Профиль</div>
</div>
<div id="group-booking-capsule" class="action-title-popup group-booking-capsule hidden"></div>
<div id="personal-schedule-refresh-capsule" class="action-title-popup personal-schedule-refresh-capsule hidden" onclick="handlePersonalScheduleRefreshCapsuleClick()"></div>
<div id="group-booking-overlay" class="group-booking-overlay">
  <div class="group-booking-backdrop" onclick="closeGroupBookingForm()"></div>
  <div class="group-booking-card">
      <div id="group-booking-info-popup" class="group-booking-info-popup hidden" onclick="toggleGroupBookingInfoPopup(false)">
        <div class="group-booking-info-card" onclick="event.stopPropagation()">
          <div style="font-weight: 700; margin-bottom: 6px;">Информация о группе</div>
          <div id="group-booking-info-text" class="small">—</div>
          <button type="button" class="save-btn" onclick="toggleGroupBookingInfoPopup(false)">Понятно</button>
        </div>
      </div>
      <div class="group-booking-body">
        <label>Вариант абонемента *</label>
        <div id="group-booking-options-list" class="group-booking-options-list"></div>
        <div id="group-booking-options-hint" class="group-booking-meta">Загрузка доступных вариантов...</div>
        <div class="group-booking-directions-block">
          <div class="group-booking-directions-title">Дополнительные направления (максимум 3 всего)</div>
          <div id="group-booking-main-direction" class="group-booking-main-direction"></div>
          <div id="group-booking-extra-slots" class="group-booking-extra-slots"></div>
          <div id="group-booking-directions-hint" class="group-booking-meta"></div>
        </div>

        <div class="group-booking-quote">
          <div class="group-booking-meta group-booking-amount-line">Сумма: <span id="group-booking-quote-amount" class="group-booking-amount-value">—</span></div>
          <div class="group-booking-meta">Занятий в группе: <span id="group-booking-quote-lessons-per-group">—</span></div>
          <div class="group-booking-meta">Всего занятий: <span id="group-booking-quote-total-lessons">—</span></div>
          <div class="group-booking-meta">Следующее занятие: <span id="group-booking-next-session">—</span></div>
          <div class="group-booking-meta">Абонемент действует до: <span id="group-booking-valid-until">—</span></div>
          <div class="group-booking-meta">Тип направления: <span id="group-booking-direction-type">—</span></div>
          <div class="group-booking-price-preview" id="group-booking-quote-status">Выберите вариант абонемента</div>
        </div>

        <div id="group-booking-picker" class="group-booking-picker hidden" onclick="closeGroupBookingPicker()">
          <div class="group-booking-picker-dialog" onclick="event.stopPropagation()">
            <div class="group-booking-picker-header">
              <label>Выбор дополнительного направления</label>
              <button type="button" class="group-booking-picker-close" onclick="closeGroupBookingPicker()" aria-label="Закрыть">✕</button>
            </div>
            <div id="group-booking-picker-list" class="group-booking-picker-list"></div>
          </div>
        </div>

        <label>Комментарий</label>
        <textarea id="group-booking-note" placeholder="Например, важные детали для администратора"></textarea>
      </div>
    <div class="group-booking-footer">
      <button id="group-booking-submit" class="save-btn" type="button" onclick="submitGroupBookingForm()">Оформить</button>
    </div>
  </div>
</div>
<script>
/* ====== TELEGRAM ====== */
const tg = window.Telegram?.WebApp;
if (tg && typeof tg.ready === 'function') {
  tg.ready();
}

function getSidCookie() {
  if (typeof document === 'undefined') return '';
  const m = document.cookie.split(';').map(s => s.trim()).find(s => s.startsWith('sid='));
  return m ? m.slice(4) : '';
}

async function ensureAuthSession() {
  // If already have a sid or no telegram context, skip.
  if (getSidCookie()) return;
  if (!tg || !tg.initData) return;

  try {
    const res = await fetch('/auth/telegram', {
      method: 'POST',
      headers: {
        // Backend accepts both names; send both for safety.
        'X-TG-Init-Data': tg.initData,
        'X-Telegram-Init-Data': tg.initData,
        'Content-Type': 'application/json',
      },
      credentials: 'include',
      body: JSON.stringify({ init_data: tg.initData }),
    });
    if (!res.ok) {
      const data = await res.json().catch(() => ({}));
      throw new Error(data.error || `Auth failed (${res.status})`);
    }
    console.log('Auth session bootstrapped');
  } catch (err) {
    console.error('Auth bootstrap failed', err);
    showNotification('❌ Требуется аутентификация: откройте приложение через Telegram');
  }
}

function getAuthHeaders(extraHeaders = {}) {
  const debugTelegramId =
    (typeof localStorage !== 'undefined' && localStorage.getItem('debug_telegram_id')) || '';
  const telegramId = tg?.initDataUnsafe?.user?.id || debugTelegramId;
  const headers = { ...extraHeaders };
  if (telegramId) {
    headers['X-Telegram-Id'] = telegramId;
  }
  if (tg?.initData) {
    headers['X-TG-Init-Data'] = tg.initData;
    headers['X-Telegram-Init-Data'] = tg.initData;
  }
  // Нужен sid cookie для защищённых эндпоинтов
  headers['X-Requested-With'] = 'XMLHttpRequest';
  return headers;
}

function _toPlainHeaders(headers) {
  if (!headers) return {};
  if (headers instanceof Headers) {
    const out = {};
    headers.forEach((value, key) => {
      out[key] = value;
    });
    return out;
  }
  return headers;
}

function authFetch(url, options = {}) {
  const extraHeaders = _toPlainHeaders(options.headers);
  const mergedHeaders = getAuthHeaders(extraHeaders);
  return fetch(url, { ...options, headers: mergedHeaders });
}

function updateSafeAreaVars() {
  const inset = tg.safeAreaInset || tg.contentSafeAreaInset || {};
  const top = Number(inset.top) || 0;
  const bottom = Number(inset.bottom) || 0;
  document.documentElement.style.setProperty('--safe-top', `${top}px`);
  document.documentElement.style.setProperty('--safe-bottom', `${bottom}px`);
}

const DISPLAY_MODE_KEY = 'display_mode_pref';
let fullscreenRetryTimer = null;

function isMobileTelegramPlatform() {
  const platform = (tg?.platform || '').toLowerCase();
  return platform === 'android' || platform === 'ios';
}

function getDisplayModePref() {
  if (!isMobileTelegramPlatform()) {
    return 'fullsize';
  }
  try {
    const raw = localStorage.getItem(DISPLAY_MODE_KEY);
    return raw === 'fullsize' ? 'fullsize' : 'fullscreen';
  } catch (_) {
    return 'fullscreen';
  }
}

function setDisplayModePref(mode) {
  try {
    localStorage.setItem(DISPLAY_MODE_KEY, mode === 'fullscreen' ? 'fullscreen' : 'fullsize');
  } catch (_) {}
}

function renderDisplayModeStatus() {
  const el = document.getElementById('display-mode-status');
  if (!el) return;
  if (!isMobileTelegramPlatform()) {
    el.textContent = 'На ПК используется Fullsize (fullscreen доступен только на мобильных устройствах).';
    return;
  }
  const mode = getDisplayModePref();
  const actual = tg?.isFullscreen ? 'Fullscreen активен' : 'Fullscreen не активен';
  el.textContent = mode === 'fullscreen'
    ? `Выбрано: Fullscreen. ${actual}.`
    : 'Выбрано: Fullsize.';
}

function applyDisplayModePref() {
  const mode = getDisplayModePref();
  const supportsFullscreen = !!(tg && typeof tg.requestFullscreen === 'function' && tg.isVersionAtLeast?.('8.0'));
  const isMobile = isMobileTelegramPlatform();

  if (!isMobile) {
    setDisplayModePref('fullsize');
    if (tg?.isFullscreen && typeof tg.exitFullscreen === 'function') {
      try { tg.exitFullscreen(); } catch (_) {}
    }
    renderDisplayModeStatus();
    return;
  }

  if (mode === 'fullscreen') {
    if (supportsFullscreen) {
      try { tg.requestFullscreen(); } catch (_) {}
    } else {
      try { tg.expand(); } catch (_) {}
    }
  } else {
    try { tg.expand(); } catch (_) {}
    if (tg?.isFullscreen && typeof tg.exitFullscreen === 'function') {
      try { tg.exitFullscreen(); } catch (_) {}
    }
  }
  renderDisplayModeStatus();
}

function onDisplayModeChange(mode) {
  if (!isMobileTelegramPlatform()) {
    setDisplayModePref('fullsize');
    applyDisplayModePref();
    return;
  }
  const normalized = mode === 'fullscreen' ? 'fullscreen' : 'fullsize';
  setDisplayModePref(normalized);
  applyDisplayModePref();
}

function initDisplaySettingsPage() {
  const select = document.getElementById('display-mode-select');
  const desktopNote = document.getElementById('display-mode-desktop-note');
  const isMobile = isMobileTelegramPlatform();
  if (select) {
    select.value = getDisplayModePref();
    select.disabled = !isMobile;
    select.style.opacity = isMobile ? '1' : '0.65';
    select.style.cursor = isMobile ? 'pointer' : 'not-allowed';
  }
  if (desktopNote) {
    desktopNote.style.display = isMobile ? 'none' : 'block';
  }
  renderDisplayModeStatus();
}

function initMobileViewport() {
  const isMobile = isMobileTelegramPlatform();
  if (!isMobile) return;

  document.body.classList.add('tg-mobile');

  try {
    if (!tg.isExpanded) {
      tg.expand();
    }
  } catch (err) {
    // ignore expand errors
  }
  setTimeout(() => {
    applyDisplayModePref();
  }, 180);
}

initMobileViewport();
updateSafeAreaVars();
if (typeof tg.onEvent === 'function') {
  tg.onEvent('viewportChanged', () => {
    updateSafeAreaVars();
    // Если пользователь выбрал fullscreen, пытаемся вернуть его после изменений viewport.
    if (isMobileTelegramPlatform() && getDisplayModePref() === 'fullscreen' && !tg?.isFullscreen && typeof tg.requestFullscreen === 'function' && tg.isVersionAtLeast?.('8.0')) {
      if (fullscreenRetryTimer) clearTimeout(fullscreenRetryTimer);
      fullscreenRetryTimer = setTimeout(() => {
        try { tg.requestFullscreen(); } catch (_) {}
      }, 220);
    }
    renderDisplayModeStatus();
  });
}
applyDisplayModePref();

// Bootstrap auth session once WebApp is ready.
const authSessionPromise = ensureAuthSession();

/* ====== НАВИГАЦИЯ ====== */
const ROOT_PAGES = ['home', 'schedule', 'staff', 'profile'];
let currentPageId = 'home';
let activeModalBackHandler = null;

const header = document.getElementById('header');
const headerTitle = document.getElementById('header-title');
const headerBack = document.getElementById('header-back');
const hasTelegramBackButton = typeof tg.BackButton !== 'undefined';

if (hasTelegramBackButton && typeof tg.BackButton.onClick === 'function') {
  tg.BackButton.onClick(() => {
    goBack();
  });
}
const pageTitleCache = {
  home: 'LISSA DANCE',
  schedule: 'LISSA DANCE',
  staff: 'Работа',
  profile: 'LISSA DANCE'
};

function setHeaderTitle(title) {
  if (!headerTitle) return;
  headerTitle.textContent = title;
  pageTitleCache[currentPageId] = title;
}

function setHeaderBackVisible(isVisible) {
  if (!headerBack) return;
  headerBack.style.visibility = isVisible ? 'visible' : 'hidden';
  headerBack.style.pointerEvents = isVisible ? 'auto' : 'none';
}

function syncTelegramBackButton(isVisible) {
  if (hasTelegramBackButton) {
    if (isVisible) {
      tg.BackButton.show();
    } else {
      tg.BackButton.hide();
    }
    if (headerBack) {
      headerBack.style.display = 'none';
    }
  } else if (headerBack) {
    headerBack.style.display = '';
  }
}

function applyHeaderForPage(pageId) {
  currentPageId = pageId;
  const isRoot = ROOT_PAGES.includes(pageId);
  setHeaderBackVisible(!isRoot);
  syncTelegramBackButton(!isRoot);

  const page = document.getElementById(pageId);
  if (!page) return;
  const dataTitle = page.getAttribute('data-title');
  if (dataTitle) {
    let brandEl = page.querySelector('.brand-header');
    if (!brandEl) {
      brandEl = document.createElement('div');
      brandEl.className = 'brand-header';
      brandEl.innerHTML = `
        <div class="brand-row">
          <div class="brand-avatar"></div>
          <div class="brand-name"></div>
        </div>
        <h2 class="page-title"></h2>
      `;
      page.insertBefore(brandEl, page.firstChild);
    }
    const brandNameEl = brandEl.querySelector('.brand-name');
    if (brandNameEl) {
      brandNameEl.textContent = dataTitle;
    }

    const titleEl = brandEl.querySelector('.page-title');
    if (titleEl) {
      titleEl.textContent = '';
      titleEl.style.display = 'none';
    }
    pageTitleCache[pageId] = dataTitle;
  }
}

// Стек для навигации (история переходов)
let navigationStack = ['home'];
applyHeaderForPage('home');

function showPage(id) {
  if (document.body.classList.contains('group-booking-open')) {
    closeGroupBookingForm();
  }
  // Получаем текущую страницу
  const currentPage = Array.from(document.querySelectorAll('.page')).find(p => p.classList.contains('active'));
  
  // Если переходим на другую страницу, добавляем текущую в стек
  if (currentPage && currentPage.id !== id) {
    navigationStack.push(id);
  }
  
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(id).classList.add('active');

  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  const index = ROOT_PAGES.indexOf(id);
  if (index >= 0) {
    document.querySelectorAll('.nav-btn')[index].classList.add('active');
  }

  applyHeaderForPage(id);

  if (id === 'stats') {
    initStatsPageDefaults();
    loadStatsTeachers();
  }

  if (id === 'attendance-screen') {
    const list = document.getElementById('attendance-screen-list');
    if (list) list.innerHTML = '<div class="small">Загрузка...</div>';
    const schedId = currentScheduleItem?.id || attendanceState.scheduleId;
    if (schedId) {
      loadAttendance(schedId);
    } else if (list) {
      list.innerHTML = '<div class="small">Нет выбранного занятия</div>';
    }
  }
  
  // Загружаем клиентов в одноименной странице
  if (id === 'clients-list') {
    loadAllClients();
  }
  
  // Загружаем расписание для вкладки "Расписание"
  if (id === 'schedule') {
    loadPublicSchedule();
  }

  // Личное расписание (для преподавателя)
  if (id === 'personal-schedule') {
    showPersonalScheduleRefreshCapsule();
    loadPersonalSchedule();
  } else {
    hidePersonalScheduleRefreshCapsule();
  }
  
  // Загружаем список персонала для управления
  if (id === 'staff-manage') {
    setHeaderTitle('👥 Управление персоналом');
    loadStaffList();
  }
  
  // Загружаем список персонала для управления (старая версия)
  if (id === 'staff-management') {
    setHeaderTitle('👥 Управление персоналом');
    loadStaffList();
  }
  
  // Загружаем список новостей для управления
  if (id === 'news-manage') {
    setHeaderTitle('📰 Новости');
    loadNewsManage();
  }
  
  // Инициализируем preview фотографии для новостей
  if (id === 'news-add-form') {
    initNewsPhotoPreview();
  }
  
  // Загружаем список направлений для управления
  if (id === 'directions-groups') {
    setHeaderTitle('🎭 Направления и группы');
    loadDirections();
    
    // Инициализируем индикатор вкладок
    setTimeout(() => {
      const activeTab = document.getElementById('active-tab');
      const indicator = document.querySelector('.tab-indicator');
      if (indicator && activeTab) {
        indicator.style.width = activeTab.offsetWidth + 'px';
        indicator.style.transform = `translateX(${activeTab.offsetLeft}px)`;
      }
    }, 0);
  }
  if (id === 'profile-info') {
    setHeaderTitle('Личная информация');
  }

  if (id === 'profile-abonements') {
    setHeaderTitle('Абонементы');
    loadProfileAbonements();
  }

  if (id === 'profile-booking-requests') {
    setHeaderTitle('Мои заявки');
    loadProfileBookingRequests();
  }

  if (id === 'profile-settings') {
    setHeaderTitle('Настройки');
  }
  if (id === 'work-settings') {
    setHeaderTitle('Параметры настройки');
  }
  if (id === 'work-settings-prices') {
    setHeaderTitle('Ценники');
    loadWorkSettingsPrices();
  }
  if (id === 'work-settings-other') {
    setHeaderTitle('Остальные параметры');
  }
  if (id === 'payment-profiles-admin') {
    setHeaderTitle('Управление оплатой');
    loadPaymentProfilesAdmin();
  }
  if (id === 'display-settings') {
    setHeaderTitle('Отображение');
    initDisplaySettingsPage();
  }

}

function openInfo(title) {
  showPage('info');
  document.getElementById('info-title').innerText = title;
  setHeaderTitle(title);
}

function showSection(section) {
  // Переход на страницы разделов
  switch(section) {
    case 'info-about':
      showPage('info-about');
      setHeaderTitle('Информация');
      break;
    case 'info-directions-sport':
      showPage('info');
      document.getElementById('info-title').innerText = 'Спортивные направления';
      setHeaderTitle('Спортивные направления');
      loadInfoDirections('sport');
      break;
    case 'info-directions-dance':
      showPage('info');
      document.getElementById('info-title').innerText = 'Танцевальные направления';
      setHeaderTitle('Танцевальные направления');
      loadInfoDirections('dance');
      break;
    case 'info-teachers':
      showPage('info');
      document.getElementById('info-title').innerText = 'Тренеры';
      setHeaderTitle('Тренеры');
      resetInfoPage();
      loadInfoTeachers();
      break;
    case 'info-directions':
      showPage('info');
      document.getElementById('info-title').innerText = 'Направления';
      setHeaderTitle('Направления');
      loadInfoDirections();
      break;
    case 'info-individual':
      openIndividualBookingPage();
      break;
    case 'info-rent':
      openRentalBookingPage();
      break;
  }
}

function resetInfoPage() {
  const container = document.getElementById('info-section-content');
  const placeholder = document.getElementById('info-placeholder');
  if (container) {
    container.style.display = 'none';
    container.innerHTML = '';
  }
  if (placeholder) {
    placeholder.style.display = 'block';
    placeholder.textContent = 'Раздел находится в разработке';
  }
}

function openRentalBookingPage() {
  showPage('info-rent');
  setHeaderTitle('Аренда зала');
  resetRentalBookingForm();
}

function resetRentalBookingForm() {
  const dateInput = document.getElementById('rental-date');
  const purposeInput = document.getElementById('rental-purpose');
  const contactInput = document.getElementById('rental-contact');
  if (dateInput) {
    dateInput.min = formatDateLocal(new Date());
    dateInput.value = '';
    setRentalDateHint('Сначала выберите дату, чтобы увидеть занятость.', false);
    setOccupancyPlaceholder('Выберите дату, чтобы увидеть занятость.');
  }
  if (purposeInput) purposeInput.value = '';
  if (contactInput) contactInput.value = '';
  setRentalBookingMessage('');
  rentalBookingState.submitting = false;
  rentalBookingState.freeRanges = [];
  rentalBookingState.selectedRangeForStart = null;
  rentalBookingState.selectedStart = null;
  rentalBookingState.selectedStartMinutes = null;
  rentalBookingState.selectedDurationMinutes = null;
  const btn = document.getElementById('rental-submit-btn');
  if (btn) btn.disabled = false;
  setRentalTimeSelectorsEnabled(false);
  resetRentalTimeSelection();
  clearHallOccupancy();
}

function submitRentalBooking() {
  if (rentalBookingState.submitting) return;
  const dateState = getRentalDateInputState();
  const startMinutes = rentalBookingState.selectedStartMinutes;
  const durationMinutes = rentalBookingState.selectedDurationMinutes;
  if (!dateState.hasValue) {
    setRentalBookingMessage(
      dateState.hasBadInput ? 'Укажите существующую дату' : 'Выберите дату',
      true
    );
    return;
  }
  if (!dateState.isValid) {
    setRentalBookingMessage('Укажите существующую дату', true);
    return;
  }
  if (dateState.isPastDate) {
    setRentalBookingMessage('Дата аренды не может быть в прошлом', true);
    return;
  }
  const dateValue = dateState.isoValue;
  if (!Number.isFinite(startMinutes) || !Number.isFinite(durationMinutes)) {
    setRentalBookingMessage('Выберите начало и длительность', true);
    return;
  }
  if (!rentalBookingState.selectedRangeForStart) {
    setRentalBookingMessage('Выберите свободное окно', true);
    return;
  }
  const endMinutes = startMinutes + durationMinutes;
  if (endMinutes > rentalBookingState.selectedRangeForStart.rangeEnd) {
    setRentalBookingMessage('Выбранная длительность не помещается в окно', true);
    return;
  }
  const startValue = formatMinutes(startMinutes);
  const endValue = formatMinutes(endMinutes);
  const purpose = document.getElementById('rental-purpose')?.value?.trim() || '';
  const contact = document.getElementById('rental-contact')?.value?.trim() || '';
  const commentPieces = [];
  if (purpose) commentPieces.push(purpose);
  if (contact) commentPieces.push(`Контакт: ${contact}`);
  const payload = {
    object_type: 'rental',
    date: dateValue,
    time_from: startValue,
    time_to: endValue,
    comment: commentPieces.length ? commentPieces.join('\n') : undefined
  };
  const btn = document.getElementById('rental-submit-btn');
  rentalBookingState.submitting = true;
  if (btn) btn.disabled = true;
  fetch('/api/booking-requests', {
    method: 'POST',
    headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
    body: JSON.stringify(payload)
  })
    .then(async res => {
      const data = await res.json().catch(() => null);
      if (!res.ok) {
        throw new Error((data && data.error) || 'Не удалось отправить заявку');
      }
      resetRentalBookingForm();
      setRentalBookingMessage('Заявка отправлена, админы вам напишут в Telegram.', false);
    })
    .catch(err => {
      setRentalBookingMessage(err.message || 'Ошибка при отправке заявки', true);
    })
  .finally(() => {
    rentalBookingState.submitting = false;
    if (btn) btn.disabled = false;
  });
}

function setRentalBookingMessage(text = '', isError = false) {
  const msg = document.getElementById('rental-booking-msg');
  if (!msg) return;
  msg.textContent = text;
  msg.classList.toggle('error', Boolean(isError));
}

function setRentalTimeSelectorsEnabled(enabled) {
  rentalBookingState.selectorsEnabled = Boolean(enabled);
}

function resetRentalTimeSelection(
  windowsText = 'Выберите дату, чтобы увидеть свободные окна',
  startText = 'Выберите окно',
  durationText = 'Выберите начало'
) {
  const windows = document.getElementById('rental-window-grid');
  const startGrid = document.getElementById('rental-start-grid');
  const durationGrid = document.getElementById('rental-duration-grid');
  if (windows) windows.innerHTML = `<p class="small">${windowsText}</p>`;
  if (startGrid) startGrid.innerHTML = `<p class="small">${startText}</p>`;
  if (durationGrid) durationGrid.innerHTML = `<p class="small">${durationText}</p>`;
  updateRentalTimeSummary();
}

function updateRentalTimeSummary() {
  const summary = document.getElementById('rental-time-summary');
  if (!summary) return;
  const state = rentalBookingState;
  if (!Number.isFinite(state.selectedStartMinutes) || !Number.isFinite(state.selectedDurationMinutes)) {
    summary.textContent = '';
    return;
  }
  const start = state.selectedStartMinutes;
  const end = start + state.selectedDurationMinutes;
  summary.textContent = `Выбрано: ${formatMinutes(start)} — ${formatMinutes(end)} (${formatDurationLabel(state.selectedDurationMinutes)})`;
}

function renderRentalTimeSelectors() {
  const state = rentalBookingState;
  const windows = document.getElementById('rental-window-grid');
  const startGrid = document.getElementById('rental-start-grid');
  const durationGrid = document.getElementById('rental-duration-grid');
  if (!windows || !startGrid || !durationGrid) return;

  if (!state.selectorsEnabled) {
    resetRentalTimeSelection();
    return;
  }

  const freeRanges = normalizeFreeRanges(state.freeRanges, BOOKING_MIN_DURATION_MINUTES);
  if (!freeRanges.length) {
    state.selectedRangeForStart = null;
    state.selectedStart = null;
    state.selectedStartMinutes = null;
    state.selectedDurationMinutes = null;
    if (windows) windows.innerHTML = '<p class="small">Свободных окон от 60 минут нет</p>';
    if (startGrid) startGrid.innerHTML = '<p class="small">Выберите другую дату</p>';
    if (durationGrid) durationGrid.innerHTML = '<p class="small">Выберите другое окно</p>';
    updateRentalTimeSummary();
    return;
  }

  const hasSelectedRange = state.selectedRangeForStart && freeRanges.some(
    range => range.start === state.selectedRangeForStart.rangeStart && range.end === state.selectedRangeForStart.rangeEnd
  );
  if (!hasSelectedRange) {
    state.selectedRangeForStart = null;
    state.selectedStart = null;
    state.selectedStartMinutes = null;
    state.selectedDurationMinutes = null;
  }

  const selectedRange = state.selectedRangeForStart;
  if (selectedRange) {
    windows.innerHTML = `
      <div class="booking-selection-compact">
        <div class="booking-window-chip active">
          <div>${formatMinutes(selectedRange.rangeStart)} — ${formatMinutes(selectedRange.rangeEnd)}</div>
          <div class="small">${formatDurationLabel(selectedRange.rangeEnd - selectedRange.rangeStart)}</div>
        </div>
        <button class="booking-change-btn" type="button" onclick="clearRentalWindowSelection()">Изменить</button>
      </div>
    `;
  } else {
    windows.innerHTML = freeRanges.map(range => `
      <div class="booking-window-chip" onclick="selectRentalWindow(${range.start}, ${range.end})">
        <div>${formatMinutes(range.start)} — ${formatMinutes(range.end)}</div>
        <div class="small">${formatDurationLabel(range.end - range.start)}</div>
      </div>
    `).join('');
  }

  if (!selectedRange) {
    startGrid.innerHTML = '<p class="small">Выберите окно</p>';
    durationGrid.innerHTML = '<p class="small">Выберите начало</p>';
    updateRentalTimeSummary();
    return;
  }

  const startOptions = selectedRange
    ? buildStartOptionsFromRanges([{ start: selectedRange.rangeStart, end: selectedRange.rangeEnd }], BOOKING_STEP_MINUTES, BOOKING_MIN_DURATION_MINUTES)
    : [];

  if (!startOptions.length) {
    startGrid.innerHTML = '<p class="small">Нет стартов в этом окне</p>';
    durationGrid.innerHTML = '<p class="small">Выберите другое окно</p>';
    state.selectedStart = null;
    state.selectedStartMinutes = null;
    state.selectedDurationMinutes = null;
    updateRentalTimeSummary();
    return;
  }

  const hasSelectedStart = Number.isFinite(state.selectedStartMinutes) && startOptions.some(option => option.minutes === state.selectedStartMinutes);
  if (!hasSelectedStart) {
    state.selectedStart = null;
    state.selectedStartMinutes = null;
    state.selectedDurationMinutes = null;
  }

  if (Number.isFinite(state.selectedStartMinutes)) {
    startGrid.innerHTML = `
      <div class="booking-selection-compact">
        <div class="rental-slot-card active">
          <div>${formatMinutes(state.selectedStartMinutes)}</div>
          <div class="small">до ${formatMinutes(selectedRange.rangeEnd)}</div>
        </div>
        <button class="booking-change-btn" type="button" onclick="clearRentalStartSelection()">Изменить</button>
      </div>
    `;
  } else {
    startGrid.innerHTML = startOptions.map(option => `
      <div class="rental-slot-card" onclick="selectRentalStart('${option.time}', ${option.minutes}, ${option.rangeStart}, ${option.rangeEnd})">
        <div>${option.time}</div>
        <div class="small">до ${formatMinutes(option.rangeEnd)}</div>
      </div>
    `).join('');
  }

  if (!Number.isFinite(state.selectedStartMinutes)) {
    durationGrid.innerHTML = '<p class="small">Выберите начало</p>';
    updateRentalTimeSummary();
    return;
  }

  const durationOptions = buildDurationOptionsForStart(
    selectedRange.rangeEnd,
    state.selectedStartMinutes,
    BOOKING_STEP_MINUTES,
    BOOKING_MIN_DURATION_MINUTES
  );

  const hasSelectedDuration = Number.isFinite(state.selectedDurationMinutes)
    && durationOptions.some(option => option.minutes === state.selectedDurationMinutes);
  if (!hasSelectedDuration) {
    state.selectedDurationMinutes = null;
  }

  if (!durationOptions.length) {
    durationGrid.innerHTML = '<p class="small">Для выбранного старта нет длительности</p>';
    updateRentalTimeSummary();
    return;
  }

  if (Number.isFinite(state.selectedDurationMinutes)) {
    durationGrid.innerHTML = `
      <div class="booking-selection-compact">
        <div class="rental-slot-card active">
          <div>${formatDurationLabel(state.selectedDurationMinutes)}</div>
          <div class="small">до ${formatMinutes(state.selectedStartMinutes + state.selectedDurationMinutes)}</div>
        </div>
        <button class="booking-change-btn" type="button" onclick="clearRentalDurationSelection()">Изменить</button>
      </div>
    `;
  } else {
    durationGrid.innerHTML = durationOptions.map(option => `
      <div class="rental-slot-card" onclick="selectRentalDuration(${option.minutes})">
        <div>${option.label}</div>
        <div class="small">до ${formatMinutes(state.selectedStartMinutes + option.minutes)}</div>
      </div>
    `).join('');
  }
  updateRentalTimeSummary();
}

function clearRentalWindowSelection() {
  rentalBookingState.selectedRangeForStart = null;
  rentalBookingState.selectedStart = null;
  rentalBookingState.selectedStartMinutes = null;
  rentalBookingState.selectedDurationMinutes = null;
  setRentalBookingMessage('');
  renderRentalTimeSelectors();
}

function clearRentalStartSelection() {
  rentalBookingState.selectedStart = null;
  rentalBookingState.selectedStartMinutes = null;
  rentalBookingState.selectedDurationMinutes = null;
  setRentalBookingMessage('');
  renderRentalTimeSelectors();
}

function clearRentalDurationSelection() {
  rentalBookingState.selectedDurationMinutes = null;
  setRentalBookingMessage('');
  renderRentalTimeSelectors();
}

function selectRentalWindow(rangeStart, rangeEnd) {
  rentalBookingState.selectedRangeForStart = { rangeStart, rangeEnd };
  rentalBookingState.selectedStart = null;
  rentalBookingState.selectedStartMinutes = null;
  rentalBookingState.selectedDurationMinutes = null;
  setRentalBookingMessage('');
  renderRentalTimeSelectors();
}

function selectRentalStart(timeStr, minutes, rangeStart, rangeEnd) {
  rentalBookingState.selectedRangeForStart = { rangeStart, rangeEnd };
  rentalBookingState.selectedStart = timeStr;
  rentalBookingState.selectedStartMinutes = minutes;
  rentalBookingState.selectedDurationMinutes = null;
  setRentalBookingMessage('');
  renderRentalTimeSelectors();
}

function selectRentalDuration(minutes) {
  const state = rentalBookingState;
  if (!Number.isFinite(state.selectedStartMinutes) || !state.selectedRangeForStart) {
    setRentalBookingMessage('Сначала выберите начало', true);
    return;
  }
  const endMinutes = state.selectedStartMinutes + minutes;
  if (endMinutes > state.selectedRangeForStart.rangeEnd) {
    setRentalBookingMessage('Эта длительность не помещается в окно', true);
    return;
  }
  state.selectedDurationMinutes = minutes;
  setRentalBookingMessage('');
  renderRentalTimeSelectors();
}

function setRentalDateHint(text, isError = false) {
  const hint = document.getElementById('rental-date-hint');
  if (!hint) return;
  hint.textContent = text;
  hint.style.color = isError ? '#c62828' : 'var(--hint)';
}

function setOccupancyPlaceholder(text) {
  const placeholder = document.getElementById('rental-occupancy-placeholder');
  if (!placeholder) return;
  placeholder.textContent = text;
  placeholder.style.display = text ? 'block' : 'none';
}

function updateOccupancyDebug(text) {
  const debug = document.getElementById('rental-occupancy-debug');
  if (!debug) return;
  debug.textContent = text;
}

function clearHallOccupancy() {
  const timeline = document.getElementById('rental-occupancy-timeline');
  const list = document.getElementById('rental-occupancy-list');
  if (timeline) timeline.innerHTML = '';
  if (list) list.innerHTML = '';
}

const rentalDateInput = document.getElementById('rental-date');
function normalizeIsoDate(value) {
  if (!value) return '';
  if (/^\d{4}-\d{2}-\d{2}$/.test(value)) {
    return value;
  }
  if (/^\d{2}\.\d{2}\.\d{4}$/.test(value)) {
    const [day, month, year] = value.split('.');
    return `${year}-${month}-${day}`;
  }
  return value;
}

function isExistingIsoDate(value) {
  if (!/^\d{4}-\d{2}-\d{2}$/.test(value)) return false;
  const [yearStr, monthStr, dayStr] = value.split('-');
  const year = Number(yearStr);
  const month = Number(monthStr);
  const day = Number(dayStr);
  if (!Number.isInteger(year) || !Number.isInteger(month) || !Number.isInteger(day)) {
    return false;
  }
  const candidate = new Date(Date.UTC(year, month - 1, day));
  return candidate.getUTCFullYear() === year
    && candidate.getUTCMonth() + 1 === month
    && candidate.getUTCDate() === day;
}

function isPastIsoDate(value) {
  if (!/^\d{4}-\d{2}-\d{2}$/.test(value)) return false;
  return value < formatDateLocal(new Date());
}

function getRentalDateInputState() {
  if (!rentalDateInput) {
    return { hasValue: false, isValid: false, isPastDate: false, hasBadInput: false, isoValue: '' };
  }
  const hasBadInput = Boolean(rentalDateInput.validity && rentalDateInput.validity.badInput);
  const rawValue = String(rentalDateInput.value || '').trim();
  if (!rawValue) {
    return { hasValue: false, isValid: false, isPastDate: false, hasBadInput, isoValue: '' };
  }
  const isoValue = normalizeIsoDate(rawValue);
  const isValid = isExistingIsoDate(isoValue);
  return {
    hasValue: true,
    hasBadInput: false,
    isValid,
    isPastDate: isValid ? isPastIsoDate(isoValue) : false,
    isoValue
  };
}

function clearRentalDateDependentUi(
  windowsText = 'Выберите дату, чтобы увидеть свободные окна',
  startText = 'Выберите окно',
  durationText = 'Выберите начало'
) {
  rentalBookingState.freeRanges = [];
  rentalBookingState.selectedRangeForStart = null;
  rentalBookingState.selectedStart = null;
  rentalBookingState.selectedStartMinutes = null;
  rentalBookingState.selectedDurationMinutes = null;
  setRentalTimeSelectorsEnabled(false);
  resetRentalTimeSelection(windowsText, startText, durationText);
  clearHallOccupancy();
}

if (rentalDateInput) {
  const onRentalDateChange = () => {
    const state = getRentalDateInputState();
    if (!state.hasValue) {
      if (state.hasBadInput) {
        setRentalDateHint('Такой даты не существует. Выберите корректную дату.', true);
        setOccupancyPlaceholder('Дата указана некорректно.');
        updateOccupancyDebug('Запрос не сделан: несуществующая дата');
        clearRentalDateDependentUi('Введите корректную дату', 'Выберите дату', 'Выберите начало');
        lastRentalDateValue = '';
        return;
      }
      setRentalDateHint('Сначала выберите дату, чтобы увидеть занятость.', false);
      setOccupancyPlaceholder('Выберите дату, чтобы увидеть занятость.');
      updateOccupancyDebug('Запрос не сделан: даты нет');
      clearRentalDateDependentUi();
      lastRentalDateValue = '';
      return;
    }
    if (!state.isValid) {
      setRentalDateHint('Такой даты не существует. Выберите корректную дату.', true);
      setOccupancyPlaceholder('Дата указана некорректно.');
      updateOccupancyDebug(`Запрос не сделан: несуществующая дата (${state.isoValue})`);
      clearRentalDateDependentUi('Введите корректную дату', 'Выберите дату', 'Выберите начало');
      lastRentalDateValue = '';
      return;
    }
    if (state.isPastDate) {
      setRentalDateHint('Нельзя выбрать прошедшую дату для аренды.', true);
      setOccupancyPlaceholder('Выберите сегодня или будущую дату.');
      updateOccupancyDebug(`Запрос не сделан: прошедшая дата (${state.isoValue})`);
      clearRentalDateDependentUi('Прошедшая дата недоступна', 'Выберите дату', 'Выберите начало');
      lastRentalDateValue = '';
      return;
    }
    lastRentalDateValue = state.isoValue;
    loadHallOccupancy(state.isoValue);
  };
  rentalDateInput.addEventListener('change', () => {
    onRentalDateChange();
  });
  rentalDateInput.addEventListener('input', () => {
    onRentalDateChange();
  });
}

let lastRentalDateValue = '';
setInterval(() => {
  if (!rentalDateInput) return;
  const state = getRentalDateInputState();
  if (!state.hasValue || !state.isValid || state.isPastDate) {
    lastRentalDateValue = '';
    return;
  }
  const iso = state.isoValue;
  if (iso && iso !== lastRentalDateValue) {
    lastRentalDateValue = iso;
    loadHallOccupancy(iso);
  }
}, 800);

const RENTAL_TIMELINE_START_HOUR = 8;
const RENTAL_TIMELINE_END_HOUR = 22;
const RENTAL_TIMELINE_TOTAL_MINUTES = (RENTAL_TIMELINE_END_HOUR - RENTAL_TIMELINE_START_HOUR) * 60;
const HALL_EVENT_ICONS = {
  individual: '👤',
  group: '👥',
  rental: '🔑'
};

function loadHallOccupancy(dateStr) {
  const dateInput = document.getElementById('rental-date');
  const dateValue = normalizeIsoDate(dateStr || dateInput?.value || '');
  const hasBadInput = Boolean(dateInput?.validity && dateInput.validity.badInput);
  if (!dateValue) {
    if (hasBadInput) {
      setRentalDateHint('Такой даты не существует. Выберите корректную дату.', true);
      setOccupancyPlaceholder('Дата указана некорректно.');
      clearRentalDateDependentUi('Введите корректную дату', 'Выберите дату', 'Выберите начало');
      updateOccupancyDebug('Запрос не сделан: несуществующая дата');
    } else {
      setRentalDateHint('Сначала выберите дату, чтобы увидеть занятость.', false);
      setOccupancyPlaceholder('Выберите дату, чтобы увидеть занятость.');
      clearRentalDateDependentUi();
      updateOccupancyDebug('Запрос не сделан: даты нет');
    }
    return;
  }
  if (!isExistingIsoDate(dateValue)) {
    setRentalDateHint('Такой даты не существует. Выберите корректную дату.', true);
    setOccupancyPlaceholder('Дата указана некорректно.');
    clearRentalDateDependentUi('Введите корректную дату', 'Выберите дату', 'Выберите начало');
    updateOccupancyDebug(`Запрос не сделан: несуществующая дата (${dateValue})`);
    return;
  }
  if (isPastIsoDate(dateValue)) {
    setRentalDateHint('Нельзя выбрать прошедшую дату для аренды.', true);
    setOccupancyPlaceholder('Выберите сегодня или будущую дату.');
    clearRentalDateDependentUi('Прошедшая дата недоступна', 'Выберите дату', 'Выберите начало');
    updateOccupancyDebug(`Запрос не сделан: прошедшая дата (${dateValue})`);
    return;
  }
  const dateLabel = document.getElementById('rental-occupancy-date');
  if (dateLabel) {
    const parsed = new Date(`${dateValue}T00:00:00`);
    dateLabel.textContent = Number.isNaN(parsed.getTime())
      ? dateValue
      : parsed.toLocaleDateString('ru-RU', { weekday: 'short', day: '2-digit', month: '2-digit' });
  }
  updateOccupancyDebug(`Запрос hall-occupancy?date=${dateValue} (в процессе)`);
  setRentalDateHint('Загружаем текущие записи...', false);
  setOccupancyPlaceholder('Прогружаем текущие записи...');
  rentalBookingState.freeRanges = [];
  rentalBookingState.selectedRangeForStart = null;
  rentalBookingState.selectedStart = null;
  rentalBookingState.selectedStartMinutes = null;
  rentalBookingState.selectedDurationMinutes = null;
  setRentalTimeSelectorsEnabled(false);
  resetRentalTimeSelection('Загружаем окна...', 'Загружаем старты...', 'Выберите начало');
  clearHallOccupancy();
  const params = new URLSearchParams({ date: dateValue });
  fetch(`/api/hall-occupancy?${params.toString()}`, { headers: getAuthHeaders() })
    .then(async res => {
      if (!res.ok) {
        const err = await res.json().catch(() => null);
        throw new Error((err && err.error) || 'Не удалось загрузить занятость');
      }
      return res.json();
    })
    .then(bookings => {
      renderHallOccupancy(dateValue, Array.isArray(bookings) ? bookings : []);
    })
    .catch(err => {
      const parsed = err.message || 'Ошибка при загрузке';
      setRentalDateHint(parsed, true);
      setOccupancyPlaceholder(parsed);
      setRentalTimeSelectorsEnabled(false);
      resetRentalTimeSelection('Не удалось загрузить окна', 'Выберите другую дату', 'Выберите начало');
      updateOccupancyDebug(`Ошибка: ${parsed}`);
    });
}

function renderHallOccupancy(_date, bookings) {
  const timeline = document.getElementById('rental-occupancy-timeline');
  const list = document.getElementById('rental-occupancy-list');
  const placeholder = document.getElementById('rental-occupancy-placeholder');
  if (timeline) {
    timeline.innerHTML = '';
  }
  if (list) {
    list.innerHTML = '';
  }
  setRentalTimeSelectorsEnabled(true);
  if (!bookings.length) {
    setRentalDateHint('Зал свободен, выберите удобное время.', false);
    updateOccupancyDebug('На эту дату нет занятости');
  } else {
    setRentalDateHint('Выберите подходящий интервал.', false);
    updateOccupancyDebug(`Получено ${bookings.length} блоков`);
  }
  if (!bookings.length) {
    if (placeholder) {
      placeholder.textContent = 'Свободно на весь день';
      placeholder.style.display = 'block';
    }
  } else if (placeholder) {
    placeholder.style.display = 'none';
  }

  if (bookings.length) {
    bookings.sort((a, b) => timeStringToMinutes(a.time_from || '00:00') - timeStringToMinutes(b.time_from || '00:00'));
    bookings.forEach(book => {
      const startMin = timeStringToMinutes(book.time_from || '00:00');
      const endMin = timeStringToMinutes(book.time_to || '00:00');
      const relativeStart = Math.max(0, startMin - RENTAL_TIMELINE_START_HOUR * 60);
      const relativeEnd = Math.min(RENTAL_TIMELINE_TOTAL_MINUTES, endMin - RENTAL_TIMELINE_START_HOUR * 60);
      if (timeline && relativeEnd > relativeStart) {
        const slot = document.createElement('div');
        slot.className = 'rental-occupancy-slot';
        slot.style.left = `${(relativeStart / RENTAL_TIMELINE_TOTAL_MINUTES) * 100}%`;
        slot.style.width = `${((relativeEnd - relativeStart) / RENTAL_TIMELINE_TOTAL_MINUTES) * 100}%`;
        slot.title = `${book.time_from || '—'} — ${book.time_to || '—'} · ${formatScheduleStatusLabel(book.status)}`;
        timeline.appendChild(slot);
      }
      if (list) {
        const item = document.createElement('div');
        item.className = 'rental-occupancy-item';
        const timeText = `${book.time_from || '—'} — ${book.time_to || '—'}`;
        const icon = HALL_EVENT_ICONS[book.object_type] || '?';
        item.innerHTML = `
          <span>${icon} ${timeText}</span>
          <span class="rental-occupancy-status">${formatScheduleStatusLabel(book.status)}</span>
        `;
        list.appendChild(item);
      }
    });
  }

  const busyIntervals = bookings.map(book => {
    const start = timeStringToMinutes(book.time_from || '');
    const end = timeStringToMinutes(book.time_to || '');
    return { start, end };
  }).filter(interval => interval.end > interval.start);

  rentalBookingState.freeRanges = buildFreeRangesFromBusyIntervals(
    busyIntervals,
    RENTAL_BOOKING_START_MINUTES,
    RENTAL_BOOKING_END_MINUTES,
    BOOKING_MIN_DURATION_MINUTES
  );
  rentalBookingState.selectedRangeForStart = null;
  rentalBookingState.selectedStart = null;
  rentalBookingState.selectedStartMinutes = null;
  rentalBookingState.selectedDurationMinutes = null;
  renderRentalTimeSelectors();
}

function loadInfoDirections(directionType = null) {
  const container = document.getElementById('info-section-content');
  const placeholder = document.getElementById('info-placeholder');
  if (!container) return;
  container.style.display = 'block';
  if (placeholder) placeholder.style.display = 'none';

  container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 12px;">⏳ Загрузка направлений...</p>';

  const url = directionType ? `/api/directions?direction_type=${directionType}` : '/api/directions';

  fetch(url)
    .then(async res => {
      if (!res.ok) throw new Error('Не удалось загрузить направления');
      return res.json();
    })
    .then(directions => {
      if (!directions || directions.length === 0) {
        container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 12px;">📭 Направлений нет</p>';
        return;
      }
      container.innerHTML = directions.map(d => {
        const type = (directionType || d.direction_type || 'dance').toLowerCase();
        const typeBadge = type === 'sport' ? '🏅 Спортивное' : '💃 Танцевальное';
        const imageHtml = d.image_path
          ? `<img src="${d.image_path}" style="width: 100%; height: 140px; object-fit: cover; border-radius: 10px; margin-bottom: 10px;">`
          : '';
        const price = d.base_price ? `💰 ${d.base_price} ₽` : '';
        const groupsCount = typeof d.groups_count === 'number' ? `👥 ${d.groups_count} групп` : '';
        const metaLine = [price, groupsCount].filter(Boolean).join(' • ');
        return `
          <div class="card" style="cursor: pointer;" onclick="openDirectionDetail(${d.direction_id})">
            ${imageHtml}
            <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:6px;">
              <div style="font-weight: 700; font-size: 16px;">${d.title || 'Направление'}</div>
              <span class="small" style="padding:4px 8px; border-radius:10px; background: var(--accent-soft); color: var(--accent); white-space: nowrap;">${typeBadge}</span>
            </div>
            <div class="small" style="margin-bottom: 8px;">${d.description || 'Описание отсутствует'}</div>
            ${metaLine ? `<div class="small">${metaLine}</div>` : ''}
          </div>
        `;
      }).join('');
    })
    .catch(err => {
      container.innerHTML = `<p class="small" style="text-align: center; color: #ffb3b3; padding: 12px;">❌ ${err.message}</p>`;
    });
}

function loadInfoTeachers() {
  const container = document.getElementById('info-section-content');
  const placeholder = document.getElementById('info-placeholder');
  if (!container) return;
  container.style.display = 'block';
  if (placeholder) placeholder.style.display = 'none';
  container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 12px;">⏳ Загрузка преподавателей...</p>';

  fetch('/api/teachers')
    .then(async res => {
      if (!res.ok) throw new Error('Не удалось загрузить преподавателей');
      return res.json();
    })
    .then(staff => {
      if (!staff || staff.length === 0) {
        container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 12px;">📭 Преподавателей пока нет</p>';
        return;
      }
      container.innerHTML = '<div class="teacher-cards-grid">' + staff.map(t => {
        const safeName = escapeHtml(t.name || '');
        const safeSpecialization = escapeHtml(t.specialization || t.position || '');
        const initials = (t.name || '').split(' ').map(part => part[0]?.toUpperCase()).filter(Boolean).slice(0, 2).join('') || '—';
        const photoUrl = buildMediaUrl(t.photo);
        const photo = photoUrl ? `<img src="${escapeHtml(photoUrl)}" alt="${safeName}">` : `<span>${escapeHtml(initials)}</span>`;
        return `
          <div class="teacher-card" onclick="openTeacherDetail(${t.id})" style="cursor:pointer;">
            <div class="teacher-photo">${photo}</div>
            <div class="teacher-info">
              <div class="teacher-name">${safeName || '—'}</div>
              <div class="teacher-meta">${safeSpecialization}</div>
            </div>
          </div>
        `;
      }).join('') + '</div>';
    })
    .catch(err => {
      container.innerHTML = `<p class="small" style="text-align: center; color: #ffb3b3; padding: 12px;">❌ ${err.message}</p>`;
    });
}

const TEACHER_WEEKDAYS = ['Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота', 'Воскресенье'];

function renderTeacherSchedule(items) {
  if (!items || !items.length) {
    return '<p class="small">Свободен всегда</p>';
  }
  return items.map(item => {
    const weekday = TEACHER_WEEKDAYS[item.weekday] || '—';
    const timeFrom = item.time_from || '—';
    const timeTo = item.time_to || '—';
    const validity = (item.valid_from || item.valid_to)
      ? ` (${item.valid_from || '...' } > ${item.valid_to || '...'})`
      : '';
    return `
      <div class="teacher-detail-schedule-row">
        <span>${weekday}${validity}</span>
        <span>${timeFrom} — ${timeTo}</span>
      </div>
    `;
  }).join('');
}

const INDIVIDUAL_WEEKDAY_LABELS = ['Вс', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб'];
const BOOKING_STEP_MINUTES = 30;
const BOOKING_MIN_DURATION_MINUTES = 60;
const RENTAL_BOOKING_START_MINUTES = 9 * 60;
const RENTAL_BOOKING_END_MINUTES = 22 * 60;
const individualBookingState = {
  teachers: [],
  selectedTeacherId: null,
  availabilityDates: [],
  availabilityByDate: {},
  selectedDate: new Date().toISOString().slice(0, 10),
  daysWindow: 7,
  stepMinutes: BOOKING_STEP_MINUTES,
  minDurationMinutes: BOOKING_MIN_DURATION_MINUTES,
  loadingSlots: false,
  availabilityRequestId: 0,
  submitting: false,
  selectedStart: null,
  selectedStartMinutes: null,
  selectedDurationMinutes: null,
  selectedRangeForStart: null,
};
window.individualBookingState = individualBookingState;
const rentalBookingState = {
  submitting: false,
  selectorsEnabled: false,
  freeRanges: [],
  selectedStart: null,
  selectedStartMinutes: null,
  selectedDurationMinutes: null,
  selectedRangeForStart: null,
};

function openIndividualBookingPage(preselectedTeacherId = null) {
  if (Number.isFinite(Number(preselectedTeacherId))) {
    individualBookingState.selectedTeacherId = Number(preselectedTeacherId);
  }
  const startGrid = document.getElementById('individual-start-grid');
  const durationGrid = document.getElementById('individual-duration-grid');
  const windowGrid = document.getElementById('individual-window-grid');
  if (startGrid) startGrid.innerHTML = '<p class="small">Выберите преподавателя...</p>';
  if (durationGrid) durationGrid.innerHTML = '<p class="small">Выберите начало</p>';
  if (windowGrid) windowGrid.innerHTML = '<p class="small">Сначала выберите преподавателя и дату</p>';
  document.getElementById('individual-slot-status').textContent = '';
  const durationDisplay = document.getElementById('individual-duration-display');
  if (durationDisplay) durationDisplay.textContent = '';
  setIndividualBookingMessage('');
  resetIndividualTimeSelection();
  showPage('info-individual');
  setHeaderTitle('Индивидуальные занятия');
  loadIndividualTeachers();
}

function loadIndividualTeachers() {
  const state = individualBookingState;
  resetIndividualTimeSelection();
  const strip = document.getElementById('individual-teacher-strip');
  if (strip) {
    strip.innerHTML = '<p class="small">Загрузка тренеров...</p>';
  }
  fetch('/api/teachers')
    .then(async res => {
      const data = await res.json();
      if (!res.ok) {
        throw new Error(data.error || 'Не удалось загрузить тренеров');
      }
      return data;
    })
    .then(teachers => {
      state.teachers = Array.isArray(teachers) ? teachers : [];
      renderIndividualTeacherStrip();
      const selected = state.teachers.find(t => t.id === state.selectedTeacherId);
      if (!state.selectedTeacherId && state.teachers.length) {
        selectIndividualTeacher(state.teachers[0].id);
        return;
      }
      if (selected) {
        updateIndividualTeacherDetail(selected);
        loadIndividualAvailability();
        return;
      }
      const detail = document.getElementById('individual-teacher-detail');
      if (detail) {
        detail.innerHTML = '<p class="small">Тренеры временно недоступны.</p>';
      }
      if (strip) {
        strip.innerHTML = '<p class="small">Преподаватели не найдены</p>';
      }
    })
    .catch(err => {
      if (strip) {
        strip.innerHTML = `<p class="small">❌ ${escapeHtml(err.message || 'Ошибка')}</p>`;
      }
      const detail = document.getElementById('individual-teacher-detail');
      if (detail) {
        detail.innerHTML = '<p class="small">Ошибка при загрузке тренеров.</p>';
      }
    });
}

function renderIndividualTeacherStrip() {
  const state = individualBookingState;
  const strip = document.getElementById('individual-teacher-strip');
  if (!strip) return;
  if (!state.teachers.length) {
    strip.innerHTML = '<p class="small">Преподавателей пока нет</p>';
    return;
  }
  const html = state.teachers.map(teacher => {
    const safeName = escapeHtml(teacher.name || '—');
    const safeSpec = escapeHtml(teacher.specialization || teacher.position || 'Преподаватель');
    const photoUrl = buildMediaUrl(teacher.photo);
    const initials = (teacher.name || '—').split(' ').map(part => part[0]?.toUpperCase()).filter(Boolean).join('') || '—';
    const photoBlock = photoUrl
      ? `<img src="${escapeHtml(photoUrl)}" alt="${safeName}">`
      : `<span>${escapeHtml(initials)}</span>`;
    const isSelected = teacher.id === state.selectedTeacherId;
    return `
      <div class="individual-teacher-card ${isSelected ? 'selected' : ''}" onclick="selectIndividualTeacher(${teacher.id})">
        <div class="individual-teacher-photo">${photoBlock}</div>
        <div class="teacher-name">${safeName}</div>
        <div class="small">${safeSpec}</div>
      </div>
    `;
  }).join('');
  strip.innerHTML = html;
}

function updateIndividualTeacherDetail(teacher) {
  const detail = document.getElementById('individual-teacher-detail');
  if (!detail) return;
  if (!teacher) {
    detail.innerHTML = '<p class="small">Выберите преподавателя, чтобы увидеть профиль.</p>';
    return;
  }
  const safeName = escapeHtml(teacher.name || 'Преподаватель');
  const safeSpec = escapeHtml(teacher.specialization || teacher.position || 'Преподаватель');
  const safeBio = escapeHtml(teacher.bio || 'Информация отсутствует.');
  const photoUrl = buildMediaUrl(teacher.photo);
  const initials = (teacher.name || '').split(' ').map(part => part[0]?.toUpperCase()).filter(Boolean).join('') || '—';
  const photoBlock = photoUrl
    ? `<img src="${escapeHtml(photoUrl)}" alt="${safeName}">`
    : `<span>${escapeHtml(initials)}</span>`;
  detail.innerHTML = `
    <div style="display:flex; gap:12px; align-items:flex-start;">
      <div class="individual-teacher-photo" style="border-radius:12px;">${photoBlock}</div>
      <div>
        <div class="teacher-name">${safeName}</div>
        <div class="small">${safeSpec}</div>
        <p class="small" style="margin:8px 0 0 0; line-height:1.4;">${safeBio}</p>
      </div>
    </div>
  `;
}

function selectIndividualTeacher(teacherId) {
  const state = individualBookingState;
  if (state.selectedTeacherId === teacherId) {
    return;
  }
  const teacher = state.teachers.find(t => t.id === teacherId);
  if (!teacher) {
    return;
  }
  state.selectedTeacherId = teacherId;
  state.selectedDate = new Date().toISOString().slice(0, 10);
  resetIndividualTimeSelection();
  setIndividualBookingMessage('');
  renderIndividualTeacherStrip();
  updateIndividualTeacherDetail(teacher);
  loadIndividualAvailability();
}

function loadIndividualAvailability() {
  const state = individualBookingState;
  const startGrid = document.getElementById('individual-start-grid');
  const durationGrid = document.getElementById('individual-duration-grid');
  const windowGrid = document.getElementById('individual-window-grid');
  const status = document.getElementById('individual-slot-status');
  if (!state.selectedTeacherId) {
    if (startGrid) startGrid.innerHTML = '<p class="small">Выберите преподавателя, чтобы загрузить слоты.</p>';
    if (durationGrid) durationGrid.innerHTML = '<p class="small">Выберите начало</p>';
    if (windowGrid) windowGrid.innerHTML = '<p class="small">Сначала выберите преподавателя и дату</p>';
    if (status) status.textContent = '';
    return;
  }
  if (startGrid) startGrid.innerHTML = '<p class="small">Загрузка слотов...</p>';
  if (durationGrid) durationGrid.innerHTML = '<p class="small">Выберите начало</p>';
  if (windowGrid) windowGrid.innerHTML = '<p class="small">Загружаем свободные окна...</p>';
  if (status) status.textContent = '';
  state.loadingSlots = true;
  state.availabilityRequestId += 1;
  const requestId = state.availabilityRequestId;
  const params = new URLSearchParams({
    start: state.selectedDate,
    days: state.daysWindow,
    duration: state.minDurationMinutes,
    step: state.stepMinutes,
  });
  fetch(`/api/teachers/${state.selectedTeacherId}/availability?${params.toString()}`)
    .then(async res => {
      const data = await res.json();
      if (!res.ok) {
        throw new Error(data.error || 'Не удалось загрузить слоты');
      }
      return data;
    })
    .then(data => {
      if (requestId !== state.availabilityRequestId) return;
      state.stepMinutes = Math.max(BOOKING_STEP_MINUTES, data.slot_step_minutes || BOOKING_STEP_MINUTES);
      const durationLabel = document.getElementById('individual-slot-duration');
      if (durationLabel) {
        durationLabel.textContent = `Шаг ${state.stepMinutes} мин · минимум ${state.minDurationMinutes} мин`;
      }
      state.availabilityDates = Array.isArray(data.dates) ? data.dates : [];
      state.availabilityByDate = {};
      state.availabilityDates.forEach(item => {
        state.availabilityByDate[item.date] = item;
      });
      if (!state.selectedDate || !state.availabilityByDate[state.selectedDate]) {
        state.selectedDate = state.availabilityDates[0]?.date || state.selectedDate;
      }
      resetIndividualTimeSelection();
      renderIndividualDateStrip();
      renderIndividualTimeSelectors();
    })
    .catch(err => {
      if (requestId !== state.availabilityRequestId) return;
      if (startGrid) {
        startGrid.innerHTML = '<p class="small">⚠️ Не удалось загрузить слоты.</p>';
      }
      if (durationGrid) {
        durationGrid.innerHTML = '<p class="small">Выберите начало</p>';
      }
      if (windowGrid) {
        windowGrid.innerHTML = '<p class="small">Не удалось загрузить окна</p>';
      }
      if (status) {
        status.textContent = err.message || 'Ошибка сети';
      }
    })
    .finally(() => {
      if (requestId !== state.availabilityRequestId) return;
      state.loadingSlots = false;
    });
}

function renderIndividualDateStrip() {
  const container = document.getElementById('individual-date-strip');
  if (!container) return;
  if (!individualBookingState.availabilityDates.length) {
    container.innerHTML = '<p class="small">Даты пока не готовы</p>';
    return;
  }
  container.innerHTML = individualBookingState.availabilityDates.map(item => {
    const label = formatIndividualDateLabel(item.date);
    const slotCount = item.free_ranges?.length || 0;
    const isActive = individualBookingState.selectedDate === item.date;
    const badge = slotCount
      ? `<div class="small">${slotCount} слот${slotCount === 1 ? '' : 'ов'}</div>`
      : '<div class="small">Нету слотов</div>';
    return `
      <div class="individual-date-card ${isActive ? 'active' : ''}" onclick="setIndividualSelectedDate('${item.date}')">
        <div class="individual-date-day">${label.day}</div>
        <div class="individual-date-weekday">${label.label}</div>
        ${badge}
      </div>
    `;
  }).join('');
}

function setIndividualSelectedDate(dateStr) {
  const state = individualBookingState;
  if (!dateStr || state.selectedDate === dateStr) {
    return;
  }
  state.selectedDate = dateStr;
  resetIndividualTimeSelection();
  renderIndividualDateStrip();
  renderIndividualTimeSelectors();
}

function resetIndividualTimeSelection() {
  const state = individualBookingState;
  state.selectedStart = null;
  state.selectedStartMinutes = null;
  state.selectedDurationMinutes = null;
  state.selectedRangeForStart = null;
  const windowGrid = document.getElementById('individual-window-grid');
  const startGrid = document.getElementById('individual-start-grid');
  const durationGrid = document.getElementById('individual-duration-grid');
  if (windowGrid) windowGrid.innerHTML = '<p class="small">Сначала выберите преподавателя и дату</p>';
  if (startGrid) startGrid.innerHTML = '<p class="small">Выберите дату и преподавателя</p>';
  if (durationGrid) durationGrid.innerHTML = '<p class="small">Выберите начало</p>';
  const durationDisplay = document.getElementById('individual-duration-display');
  if (durationDisplay) durationDisplay.textContent = '';
}

function renderIndividualTimeSelectors() {
  const state = individualBookingState;
  const dateInfo = state.availabilityByDate[state.selectedDate];
  const windowGrid = document.getElementById('individual-window-grid');
  const startGrid = document.getElementById('individual-start-grid');
  const durationGrid = document.getElementById('individual-duration-grid');
  const status = document.getElementById('individual-slot-status');

  if (!windowGrid || !startGrid || !durationGrid) return;

  if (!state.selectedTeacherId) {
    windowGrid.innerHTML = '<p class="small">Выберите преподавателя</p>';
    startGrid.innerHTML = '<p class="small">Выберите преподавателя</p>';
    durationGrid.innerHTML = '<p class="small">Выберите начало</p>';
    if (status) status.textContent = '';
    return;
  }
  if (!dateInfo) {
    windowGrid.innerHTML = '<p class="small">Выберите дату</p>';
    startGrid.innerHTML = '<p class="small">Выберите дату</p>';
    durationGrid.innerHTML = '<p class="small">Выберите начало</p>';
    if (status) status.textContent = '';
    return;
  }

  const freeRanges = normalizeFreeRanges(dateInfo.free_ranges, state.minDurationMinutes);
  if (!freeRanges.length) {
    state.selectedRangeForStart = null;
    state.selectedStart = null;
    state.selectedStartMinutes = null;
    state.selectedDurationMinutes = null;
    windowGrid.innerHTML = '<p class="small">Свободных окон от 60 минут нет</p>';
    startGrid.innerHTML = '<p class="small">Нету слотов</p>';
    durationGrid.innerHTML = '<p class="small">Выберите другую дату</p>';
    if (status) status.textContent = 'Нету слотов';
    updateDurationDisplay();
    return;
  }

  const hasSelectedRange = state.selectedRangeForStart && freeRanges.some(
    range => range.start === state.selectedRangeForStart.rangeStart && range.end === state.selectedRangeForStart.rangeEnd
  );
  if (!hasSelectedRange) {
    state.selectedRangeForStart = null;
    state.selectedStart = null;
    state.selectedStartMinutes = null;
    state.selectedDurationMinutes = null;
  }

  const selectedRange = state.selectedRangeForStart;
  if (selectedRange) {
    windowGrid.innerHTML = `
      <div class="booking-selection-compact">
        <div class="booking-window-chip active">
          <div>${formatMinutes(selectedRange.rangeStart)} — ${formatMinutes(selectedRange.rangeEnd)}</div>
          <div class="small">${formatDurationLabel(selectedRange.rangeEnd - selectedRange.rangeStart)}</div>
        </div>
        <button class="booking-change-btn" type="button" onclick="clearIndividualWindowSelection()">Изменить</button>
      </div>
    `;
  } else {
    windowGrid.innerHTML = freeRanges.map(range => `
      <div class="booking-window-chip" onclick="selectIndividualWindow(${range.start}, ${range.end})">
        <div>${formatMinutes(range.start)} — ${formatMinutes(range.end)}</div>
        <div class="small">${formatDurationLabel(range.end - range.start)}</div>
      </div>
    `).join('');
  }

  if (!selectedRange) {
    startGrid.innerHTML = '<p class="small">Выберите окно</p>';
    durationGrid.innerHTML = '<p class="small">Выберите начало</p>';
    if (status) status.textContent = '';
    updateDurationDisplay();
    return;
  }

  const startOptions = buildStartOptions(dateInfo, selectedRange);
  if (!startOptions.length) {
    state.selectedStart = null;
    state.selectedStartMinutes = null;
    state.selectedDurationMinutes = null;
    startGrid.innerHTML = '<p class="small">Нет стартов в этом окне</p>';
    durationGrid.innerHTML = '<p class="small">Выберите другое окно</p>';
    if (status) status.textContent = 'Выберите другое окно';
    updateDurationDisplay();
    return;
  }

  const hasSelectedStart = Number.isFinite(state.selectedStartMinutes) && startOptions.some(option => option.minutes === state.selectedStartMinutes);
  if (!hasSelectedStart) {
    state.selectedStart = null;
    state.selectedStartMinutes = null;
    state.selectedDurationMinutes = null;
  }

  if (Number.isFinite(state.selectedStartMinutes)) {
    startGrid.innerHTML = `
      <div class="booking-selection-compact">
        <div class="individual-slot-card active">
          <div>${formatMinutes(state.selectedStartMinutes)}</div>
          <div class="small">до ${formatMinutes(selectedRange.rangeEnd)}</div>
        </div>
        <button class="booking-change-btn" type="button" onclick="clearIndividualStartSelection()">Изменить</button>
      </div>
    `;
  } else {
    startGrid.innerHTML = startOptions.map(option => `
      <div class="individual-slot-card" onclick="selectIndividualStart('${option.time}', ${option.minutes}, ${option.rangeStart}, ${option.rangeEnd})">
        <div>${option.time}</div>
        <div class="small">до ${formatMinutes(option.rangeEnd)}</div>
      </div>
    `).join('');
  }

  if (!Number.isFinite(state.selectedStartMinutes)) {
    durationGrid.innerHTML = '<p class="small">Выберите начало</p>';
    if (status) status.textContent = '';
    updateDurationDisplay();
    return;
  }

  const durationOptions = buildDurationOptionsForStart(
    selectedRange.rangeEnd,
    state.selectedStartMinutes,
    state.stepMinutes,
    state.minDurationMinutes
  );

  const hasSelectedDuration = Number.isFinite(state.selectedDurationMinutes)
    && durationOptions.some(option => option.minutes === state.selectedDurationMinutes);
  if (!hasSelectedDuration) {
    state.selectedDurationMinutes = null;
  }

  if (!durationOptions.length) {
    state.selectedDurationMinutes = null;
    durationGrid.innerHTML = '<p class="small">Для выбранного старта нет длительности</p>';
    if (status) status.textContent = 'Выберите другой старт';
    updateDurationDisplay();
    return;
  }

  if (Number.isFinite(state.selectedDurationMinutes)) {
    durationGrid.innerHTML = `
      <div class="booking-selection-compact">
        <div class="individual-slot-card active">
          <div>${formatDurationLabel(state.selectedDurationMinutes)}</div>
          <div class="small">до ${formatMinutes(state.selectedStartMinutes + state.selectedDurationMinutes)}</div>
        </div>
        <button class="booking-change-btn" type="button" onclick="clearIndividualDurationSelection()">Изменить</button>
      </div>
    `;
  } else {
    durationGrid.innerHTML = durationOptions.map(option => `
      <div class="individual-slot-card" onclick="selectIndividualDuration(${option.minutes})">
        <div>${option.label}</div>
        <div class="small">до ${formatMinutes(state.selectedStartMinutes + option.minutes)}</div>
      </div>
    `).join('');
  }
  if (status) status.textContent = '';
  updateDurationDisplay();
}

function buildStartOptions(dateInfo, selectedRange = null) {
  const state = individualBookingState;
  let ranges = normalizeFreeRanges(dateInfo.free_ranges, state.minDurationMinutes);
  if (selectedRange) {
    ranges = ranges.filter(
      range => range.start === selectedRange.rangeStart && range.end === selectedRange.rangeEnd
    );
  }
  return buildStartOptionsFromRanges(ranges, state.stepMinutes, state.minDurationMinutes);
}

function clearIndividualWindowSelection() {
  const state = individualBookingState;
  state.selectedRangeForStart = null;
  state.selectedStart = null;
  state.selectedStartMinutes = null;
  state.selectedDurationMinutes = null;
  setIndividualBookingMessage('');
  renderIndividualTimeSelectors();
}

function clearIndividualStartSelection() {
  const state = individualBookingState;
  state.selectedStart = null;
  state.selectedStartMinutes = null;
  state.selectedDurationMinutes = null;
  setIndividualBookingMessage('');
  renderIndividualTimeSelectors();
}

function clearIndividualDurationSelection() {
  const state = individualBookingState;
  state.selectedDurationMinutes = null;
  setIndividualBookingMessage('');
  renderIndividualTimeSelectors();
}

function selectIndividualWindow(rangeStart, rangeEnd) {
  const state = individualBookingState;
  state.selectedRangeForStart = { rangeStart, rangeEnd };
  state.selectedStart = null;
  state.selectedStartMinutes = null;
  state.selectedDurationMinutes = null;
  setIndividualBookingMessage('');
  renderIndividualTimeSelectors();
}

function selectIndividualStart(timeStr, minutes, rangeStart, rangeEnd) {
  const state = individualBookingState;
  state.selectedStart = timeStr;
  state.selectedStartMinutes = minutes;
  state.selectedRangeForStart = { rangeStart, rangeEnd };
  state.selectedDurationMinutes = null;
  setIndividualBookingMessage('');
  renderIndividualTimeSelectors();
}

function selectIndividualDuration(minutes) {
  const state = individualBookingState;
  if (!Number.isFinite(state.selectedStartMinutes) || !state.selectedRangeForStart) {
    setIndividualBookingMessage('Сначала выберите начало', true);
    return;
  }
  const endMinutes = state.selectedStartMinutes + minutes;
  if (endMinutes > state.selectedRangeForStart.rangeEnd) {
    setIndividualBookingMessage('Эта длительность не помещается в выбранное окно', true);
    return;
  }
  state.selectedDurationMinutes = minutes;
  setIndividualBookingMessage('');
  renderIndividualTimeSelectors();
}

function updateDurationDisplay() {
  const state = individualBookingState;
  const display = document.getElementById('individual-duration-display');
  if (!display) return;
  if (Number.isFinite(state.selectedStartMinutes) && Number.isFinite(state.selectedDurationMinutes)) {
    const endMinutes = state.selectedStartMinutes + state.selectedDurationMinutes;
    display.textContent = `Длительность: ${formatDurationLabel(state.selectedDurationMinutes)} · ${formatMinutes(state.selectedStartMinutes)} — ${formatMinutes(endMinutes)}`;
  } else {
    display.textContent = '';
  }
}

function setModalBackHandler(handler) {
  activeModalBackHandler = typeof handler === 'function' ? handler : null;
  if (!hasTelegramBackButton) return;
  if (activeModalBackHandler) {
    tg.BackButton.show();
    return;
  }
  const isRoot = ROOT_PAGES.includes(currentPageId);
  syncTelegramBackButton(!isRoot);
}

function tryHandleModalBack() {
  if (typeof activeModalBackHandler !== 'function') return false;
  const handler = activeModalBackHandler;
  activeModalBackHandler = null;
  handler();
  return true;
}

function setIndividualBookingMessage(text, isError) {
  const msg = document.getElementById('individual-booking-msg');
  if (!msg) return;
  msg.style.color = isError ? '#c62828' : 'var(--text)';
  msg.textContent = text;
}

function submitIndividualBooking() {
  const state = individualBookingState;
  if (!state.selectedTeacherId) {
    setIndividualBookingMessage('Выберите преподавателя', true);
    return;
  }
  if (!state.selectedDate) {
    setIndividualBookingMessage('Выберите дату', true);
    return;
  }
  if (!state.selectedStart || !Number.isFinite(state.selectedDurationMinutes) || !Number.isFinite(state.selectedStartMinutes)) {
    setIndividualBookingMessage('Выберите начало и длительность', true);
    return;
  }
  const endMinutes = state.selectedStartMinutes + state.selectedDurationMinutes;
  if (!state.selectedRangeForStart || endMinutes > state.selectedRangeForStart.rangeEnd) {
    setIndividualBookingMessage('Выбранная длительность не помещается в окно', true);
    return;
  }
  const endTime = formatMinutes(endMinutes);
  const commentEl = document.getElementById('individual-booking-comment');
  const comment = commentEl?.value?.trim() || '';
  const payload = {
    object_type: 'individual',
    teacher_id: state.selectedTeacherId,
    date: state.selectedDate,
    time_from: state.selectedStart,
    time_to: endTime,
    comment,
  };
  const submitButton = document.getElementById('individual-booking-submit');
  if (!state.submitting) {
    state.submitting = true;
    if (submitButton) submitButton.disabled = true;
    fetch('/api/booking-requests', {
      method: 'POST',
      headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
      body: JSON.stringify(payload),
    })
      .then(async res => {
        const data = await res.json();
        if (!res.ok) {
          throw new Error(data.error || 'Не удалось отправить заявку');
        }
        return data;
      })
      .then(() => {
        setIndividualBookingMessage('Заявка отправлена, админы свяжутся с вами.', false);
        if (commentEl) commentEl.value = '';
      })
      .catch(err => {
        setIndividualBookingMessage(err.message || 'Ошибка при отправке заявки', true);
      })
      .finally(() => {
        state.submitting = false;
        if (submitButton) submitButton.disabled = false;
      });
  }
}

function formatIndividualDateLabel(dateStr) {
  const date = new Date(`${dateStr}T00:00:00`);
  if (Number.isNaN(date.getTime())) {
    return { label: '', day: dateStr };
  }
  const label = INDIVIDUAL_WEEKDAY_LABELS[date.getDay()] || '';
  return {
    label,
    day: date.getDate(),
  };
}

function formatMinutes(minutes) {
  const hrs = Math.floor(minutes / 60);
  const mins = minutes % 60;
  return `${String(hrs).padStart(2, '0')}:${String(mins).padStart(2, '0')}`;
}

function timeStringToMinutes(value) {
  if (!value) return 0;
  const [hours, mins] = String(value).split(':').map(Number);
  if (Number.isNaN(hours) || Number.isNaN(mins)) return 0;
  return hours * 60 + mins;
}

function formatDurationLabel(minutes) {
  if (!Number.isFinite(minutes) || minutes <= 0) {
    return '0 мин';
  }
  const hours = Math.floor(minutes / 60);
  const mins = minutes % 60;
  if (hours && mins) {
    return `${hours} ч ${mins} мин`;
  }
  if (hours) {
    return `${hours} ч`;
  }
  return `${mins} мин`;
}

function normalizeFreeRanges(ranges, minDurationMinutes = 0) {
  const normalized = [];
  (Array.isArray(ranges) ? ranges : []).forEach(range => {
    if (!range) return;
    const startRaw = Number.isFinite(range.start)
      ? range.start
      : (range.from_minutes ?? range.rangeStart);
    const endRaw = Number.isFinite(range.end)
      ? range.end
      : (range.to_minutes ?? range.rangeEnd);
    const start = Number.isFinite(startRaw) ? startRaw : timeStringToMinutes(range.from || range.time_from || '');
    const end = Number.isFinite(endRaw) ? endRaw : timeStringToMinutes(range.to || range.time_to || '');
    if (!Number.isFinite(start) || !Number.isFinite(end) || end <= start) return;
    normalized.push({ start, end });
  });

  normalized.sort((a, b) => a.start - b.start || a.end - b.end);
  const merged = [];
  normalized.forEach(range => {
    const last = merged[merged.length - 1];
    if (!last || range.start > last.end) {
      merged.push({ start: range.start, end: range.end });
      return;
    }
    last.end = Math.max(last.end, range.end);
  });

  const minDuration = Math.max(0, Number(minDurationMinutes) || 0);
  return merged.filter(range => range.end - range.start >= minDuration);
}

function buildFreeRangesFromBusyIntervals(
  busyIntervals,
  dayStartMinutes,
  dayEndMinutes,
  minDurationMinutes = 0
) {
  const start = Number.isFinite(dayStartMinutes) ? dayStartMinutes : 0;
  const end = Number.isFinite(dayEndMinutes) ? dayEndMinutes : 24 * 60;
  if (end <= start) return [];

  const busy = normalizeFreeRanges(busyIntervals)
    .map(range => ({
      start: Math.max(start, range.start),
      end: Math.min(end, range.end),
    }))
    .filter(range => range.end > range.start);

  const freeRanges = [];
  let cursor = start;
  busy.forEach(range => {
    if (range.start > cursor) {
      freeRanges.push({ start: cursor, end: range.start });
    }
    cursor = Math.max(cursor, range.end);
  });
  if (cursor < end) {
    freeRanges.push({ start: cursor, end });
  }

  return normalizeFreeRanges(freeRanges, minDurationMinutes);
}

function buildStartOptionsFromRanges(
  freeRanges,
  stepMinutes = BOOKING_STEP_MINUTES,
  minDurationMinutes = BOOKING_MIN_DURATION_MINUTES
) {
  const step = Math.max(1, Number(stepMinutes) || BOOKING_STEP_MINUTES);
  const minDuration = Math.max(step, Number(minDurationMinutes) || step);
  const options = [];

  normalizeFreeRanges(freeRanges, minDuration).forEach(range => {
    const lastStart = range.end - minDuration;
    for (let minutes = range.start; minutes <= lastStart; minutes += step) {
      options.push({
        time: formatMinutes(minutes),
        minutes,
        rangeStart: range.start,
        rangeEnd: range.end,
      });
    }
  });

  return options;
}

function buildDurationOptionsForStart(
  rangeEndMinutes,
  startMinutes,
  stepMinutes = BOOKING_STEP_MINUTES,
  minDurationMinutes = BOOKING_MIN_DURATION_MINUTES
) {
  if (!Number.isFinite(rangeEndMinutes) || !Number.isFinite(startMinutes)) {
    return [];
  }
  const step = Math.max(1, Number(stepMinutes) || BOOKING_STEP_MINUTES);
  const minDuration = Math.max(step, Number(minDurationMinutes) || step);
  const maxDuration = rangeEndMinutes - startMinutes;
  const options = [];
  for (let minutes = minDuration; minutes <= maxDuration; minutes += step) {
    options.push({
      minutes,
      label: formatDurationLabel(minutes),
    });
  }
  return options;
}

async function openTeacherDetail(id) {
  showPage('teacher-profile-page');
  setHeaderTitle('Преподаватель');
  window.currentTeacherProfileId = id;
  document.getElementById('teacher-profile-name').textContent = 'Загрузка...';
  document.getElementById('teacher-profile-specialization').textContent = '';
  document.getElementById('teacher-profile-bio').textContent = '';
  document.getElementById('teacher-profile-groups').innerHTML = '<p class="small">Группы загружаются...</p>';
  document.getElementById('teacher-profile-groups').style.display = 'none';
  const groupsToggleBtn = document.getElementById('teacher-profile-groups-toggle-btn');
  if (groupsToggleBtn) {
    groupsToggleBtn.disabled = true;
    groupsToggleBtn.textContent = 'Просмотр групп';
  }
  document.getElementById('teacher-profile-schedule').innerHTML = '<p class="small">График загружается...</p>';
  const individualBtn = document.getElementById('teacher-profile-individual-btn');
  if (individualBtn) individualBtn.disabled = true;

  try {
    const [detail, schedule] = await Promise.all([
      fetch(`/api/teachers/${id}`).then(res => res.ok ? res.json() : Promise.reject(new Error('Не удалось загрузить информацию'))),
      fetch(`/api/teachers/${id}/schedule`).then(res => res.ok ? res.json() : []),
    ]);
    window.currentTeacherProfileId = detail.id || id;
    document.getElementById('teacher-profile-name').textContent = detail.name || '—';
    const specialization = detail.specialization || detail.position || '—';
    document.getElementById('teacher-profile-specialization').textContent = specialization;
    document.getElementById('teacher-profile-bio').textContent = detail.bio || 'Информация о биографии отсутствует.';
    document.getElementById('teacher-profile-groups').innerHTML = renderTeacherGroups(detail.groups || []);
    if (groupsToggleBtn) groupsToggleBtn.disabled = false;
    document.getElementById('teacher-profile-schedule').innerHTML = renderTeacherSchedule(schedule);
    const photoContainer = document.getElementById('teacher-profile-photo');
    if (photoContainer) {
      photoContainer.innerHTML = '';
      const photoUrl = buildMediaUrl(detail.photo);
      if (photoUrl) {
        const img = document.createElement('img');
        img.src = photoUrl;
        img.alt = detail.name || 'Преподаватель';
        photoContainer.appendChild(img);
        photoContainer.style.display = 'flex';
      } else {
        photoContainer.style.display = 'none';
      }
    }
    if (individualBtn) individualBtn.disabled = false;
  } catch (err) {
    document.getElementById('teacher-profile-name').textContent = 'Ошибка загрузки';
    document.getElementById('teacher-profile-specialization').textContent = '';
    document.getElementById('teacher-profile-bio').textContent = err.message;
    document.getElementById('teacher-profile-groups').innerHTML = '<p class="small">Не удалось загрузить группы</p>';
    if (groupsToggleBtn) groupsToggleBtn.disabled = false;
    document.getElementById('teacher-profile-schedule').innerHTML = '<p class="small">Не удалось загрузить график</p>';
    const photoContainer = document.getElementById('teacher-profile-photo');
    if (photoContainer) {
      photoContainer.innerHTML = '';
      photoContainer.style.display = 'none';
    }
    if (individualBtn) individualBtn.disabled = true;
  }
}

function toggleTeacherGroupsVisibility() {
  const groupsEl = document.getElementById('teacher-profile-groups');
  const btn = document.getElementById('teacher-profile-groups-toggle-btn');
  if (!groupsEl || !btn) return;
  const isHidden = groupsEl.style.display === 'none';
  groupsEl.style.display = isHidden ? 'block' : 'none';
  btn.textContent = isHidden ? 'Скрыть группы' : 'Просмотр групп';
}

function renderTeacherGroups(groups) {
  if (!Array.isArray(groups) || !groups.length) {
    return '<p class="small">У этого преподавателя пока нет групп</p>';
  }
  return groups.map(group => {
    const directionTitle = escapeHtml(group.direction_title || '—');
    const lessonsText = group.lessons_per_week ? `${group.lessons_per_week} в неделю` : '—';
    return `
      <div class="card" style="margin-bottom: 8px; border: 1px solid var(--border);">
        <div style="font-weight: 700; font-size: 15px; margin-bottom: 4px;">${escapeHtml(group.name || 'Группа')}</div>
        <div class="small" style="margin-bottom: 6px;">Направление: <b>${directionTitle}</b></div>
        <div class="small" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px;">
          <span>👶 ${escapeHtml(group.age_group || '—')}</span>
          <span>⏱️ ${group.duration_minutes ? `${group.duration_minutes} мин` : '—'}</span>
          <span>📆 ${lessonsText}</span>
        </div>
        <button
          class="save-btn"
          style="width: 100%;"
          ${group.direction_id ? `onclick="openDirectionDetail(${group.direction_id})"` : 'disabled'}
        >Открыть направление и записаться</button>
      </div>
    `;
  }).join('');
}

function openIndividualBookingForTeacher(teacherId = null) {
  const targetTeacherId = Number(teacherId || window.currentTeacherProfileId);
  if (!Number.isFinite(targetTeacherId) || targetTeacherId <= 0) {
    showNotification('Не удалось определить преподавателя');
    return;
  }
  openIndividualBookingPage(targetTeacherId);
}

function closeTeacherDetail() {
  showPage('info');
  setHeaderTitle('Информация');
}

function openDirectionDetail(directionId) {
  if (!directionId) return;
  const content = document.getElementById('direction-detail-content');
  if (!content) return;

  content.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 12px;">⏳ Загрузка...</p>';
  showPage('direction-detail');

  Promise.all([
    fetch(`/api/directions/${directionId}`).then(res => res.ok ? res.json() : Promise.reject(new Error('Не удалось загрузить направление'))),
    fetch(`/api/directions/${directionId}/groups`).then(res => res.ok ? res.json() : [])
  ])
    .then(([d, groups]) => {
      const price = d.base_price ? `💰 ${d.base_price} ₽` : '';
      const status = d.status === 'active' ? '✅ Активно' : '⏸️ Неактивно';
      const type = (d.direction_type || 'dance').toLowerCase();
      const typeLabel = type === 'sport' ? '🏅 Спортивное' : '💃 Танцевальное';
      const metaLine = [typeLabel, status, price].filter(Boolean).join(' • ');
      const photoBlock = d.image_path
        ? `<div class="direction-detail-photo"><img src="${d.image_path}" alt="Направление"></div>`
        : '';

      

      window.groupDetails = window.groupDetails || {};
      window.currentDirectionForBooking = d;
      const groupsHtml = (groups && groups.length)
        ? groups.map(g => {
            const teacherName = g.teacher_name || '—';
            const teacher = teacherName ? ` ${teacherName}` : '';
            const lessons = g.lessons_per_week ? `${g.lessons_per_week} в неделю` : '—';
            window.groupDetails[g.id] = g;
            return `
              <div class="card" style="margin-bottom: 8px;">
                <div style="font-weight: 700; font-size: 16px; margin-bottom: 6px;">${g.name || 'Группа'}</div>
                <div class="small group-teacher" id="group-teacher-${g.id}" style="margin-bottom: 6px;">${teacher}</div>
                
                <div class="small group-summary" id="group-summary-${g.id}" style="display: flex; gap: 8px; flex-wrap: wrap;">
                  <span>&#x1F388; ${g.age_group || '-'}</span>
                  <span>&#x23F1; ${g.duration_minutes ? g.duration_minutes + ' min' : '-'}</span>
                  <span>&#x1F4C6; ${lessons}</span>
                  <span>&#x1F465; ${g.max_students || '-'}</span>
                </div>

                <button class="save-btn" id="group-detail-btn-${g.id}" style="width: 100%; margin-top: 8px; background: #111;" onclick="toggleGroupInlineDetails(${g.id})">Подробнее</button>
                <div class="group-inline-details" id="group-inline-details-${g.id}"></div>
              </div>
            `;
          }).join('')
        : '<p class="small" style="text-align: center; color: var(--hint); padding: 10px;">Групп пока нет</p>';

content.innerHTML = `
        ${photoBlock}
        <div class="direction-detail-content">
          <div style="font-weight: 700; font-size: 20px; margin-bottom: 6px;">${d.title || 'Направление'}</div>
          <div class="small" style="margin-bottom: 8px;">${metaLine}</div>
          <div class="small" style="margin-bottom: 10px;">${d.description || 'Описание отсутствует'}</div>
          <div style="font-weight: 700; font-size: 16px; margin: 12px 0 8px 0;">Группы</div>
          ${groupsHtml}
        </div>
      `;
    })
    .catch(err => {
      content.innerHTML = `<p class="small" style="text-align: center; color: #ffb3b3; padding: 12px;">❌ ${err.message}</p>`;
    });
}




function toggleGroupInlineDetails(groupId) {
  const details = document.getElementById(`group-inline-details-${groupId}`);
  const button = document.getElementById(`group-detail-btn-${groupId}`);
  const summary = document.getElementById(`group-summary-${groupId}`);
  const teacher = document.getElementById(`group-teacher-${groupId}`);
  if (!details || !button) return;

  if (!details.innerHTML) {
    const data = (window.groupDetails && window.groupDetails[groupId]) || {};
    const title = data?.name || 'Группа';
    const teacherName = data?.teacher_name || '—';
    const teacherInitials = teacherName
      .split(' ')
      .filter(Boolean)
      .slice(0, 2)
      .map(part => part[0].toUpperCase())
      .join('') || '—';
    const teacherPhoto = data?.teacher_photo || '';
    const age = data?.age_group || '—';
    const duration = data?.duration_minutes ? `${data.duration_minutes} мин` : '—';
    const lessons = data?.lessons_per_week ? `${data.lessons_per_week} в неделю` : '—';
    const maxStudents = data?.max_students ? `${data.max_students}` : '—';
    const description = data?.description || 'Описание отсутствует';

    details.innerHTML = `
      <div style="font-weight: 700; font-size: 15px;">${title}</div>
      <div class="group-teacher-link" onclick="openTeacherProfilePlaceholder(${Number(data?.teacher_id) || 0})">
        <div class="group-teacher-label">Профиль преподавателя</div>
        <div class="group-teacher-row">
          <div class="group-teacher-avatar">
            ${teacherPhoto ? `<img src="${teacherPhoto}" alt="${teacherName}">` : teacherInitials}
          </div>
          <div class="small" style="font-weight: 600;">${teacherName}</div>
        </div>
      </div>
      <div class="group-detail-grid" style="margin-top: 8px;">
        <div class="group-detail-row"><span>Возраст:</span><div>${age}</div></div>
        <div class="group-detail-row"><span>Длительность:</span><div>${duration}</div></div>
        <div class="group-detail-row"><span>Занятий в неделю:</span><div>${lessons}</div></div>
        <div class="group-detail-row"><span>Макс. учеников:</span><div>${maxStudents}</div></div>
      </div>
      <div class="small" style="margin-top: 10px;">${description}</div>
      <button
        id="group-book-btn-${groupId}"
        type="button"
        class="save-btn"
        style="width: 100%; margin-top: 10px;"
        onclick="openGroupBookingForm(${groupId})"
      >Записаться</button>
    `;
  }

  const isOpen = !details.classList.contains('show');
  details.classList.toggle('show', isOpen);
  button.textContent = isOpen ? 'Свернуть' : 'Подробнее';
  if (summary) summary.classList.toggle('hidden', isOpen);
  if (teacher) teacher.classList.toggle('hidden', isOpen);
  if (isOpen) {
    details.style.maxHeight = details.scrollHeight + 'px';
  } else {
    details.style.maxHeight = '0px';
  }
}

function formatBookingDisplayDate(value) {
  if (!value) return '—';
  const date = new Date(value);
  if (Number.isNaN(date.getTime())) return '—';
  return date.toLocaleDateString('ru-RU', {
    day: '2-digit',
    month: 'long',
    year: 'numeric',
  });
}

function escapeHtml(str) {
  if (typeof str !== 'string') return '';
  return str
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/\"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

let activeGroupBookingId = null;
let groupBookingState = {
  mainGroup: null,
  compatibleGroups: [],
  extraGroupIds: [],
  activePickerSlot: null,
  selectedOptionId: null,
  availableOptions: [],
  quotesByOptionId: {},
  quote: null,
  quoteRequestSeq: 0,
};

const GROUP_BOOKING_OPTION_ORDER = ['trial', 'single', 'multi_4', 'multi_8', 'multi_12'];

function resetGroupBookingState() {
  groupBookingState = {
    mainGroup: null,
    compatibleGroups: [],
    extraGroupIds: [],
    activePickerSlot: null,
    selectedOptionId: null,
    availableOptions: [],
    quotesByOptionId: {},
    quote: null,
    quoteRequestSeq: 0,
  };
}

function resetGroupBookingQuoteView() {
  const map = {
    'group-booking-quote-amount': '-',
    'group-booking-quote-lessons-per-group': '-',
    'group-booking-quote-total-lessons': '-',
    'group-booking-next-session': '-',
    'group-booking-valid-until': '-',
    'group-booking-direction-type': '-',
  };
  Object.entries(map).forEach(([id, value]) => {
    const node = document.getElementById(id);
    if (node) node.textContent = value;
  });
}

function setGroupBookingQuoteStatus(text, isError = false) {
  const node = document.getElementById('group-booking-quote-status');
  if (!node) return;
  node.textContent = text;
  node.style.color = isError ? '#ffb3b3' : 'var(--hint)';
}

function setGroupBookingOptionsHint(text, isError = false) {
  const node = document.getElementById('group-booking-options-hint');
  if (!node) return;
  node.textContent = text;
  node.style.color = isError ? '#ffb3b3' : 'var(--hint)';
}

function toggleGroupBookingInfoPopup(show) {
  const popup = document.getElementById('group-booking-info-popup');
  if (!popup) return;
  popup.classList.toggle('hidden', !show);
}

function setGroupBookingInfoText(group) {
  const node = document.getElementById('group-booking-info-text');
  if (!node) return;
  if (!group) {
    node.textContent = '—';
    return;
  }
  const lessonsPerWeek = Number.parseInt(group.lessons_per_week, 10);
  const lessonsText = Number.isFinite(lessonsPerWeek) && lessonsPerWeek > 0 ? `${lessonsPerWeek} в неделю` : '—';
  const directionText = group.direction_title ? `, направление: ${group.direction_title}` : '';
  node.textContent = `${group.name || 'Группа'}${directionText}, занятий: ${lessonsText}`;
}

function getGroupBookingCapsuleText(group) {
  if (!group) return 'Оформление абонемента';
  const lessonsPerWeek = Number.parseInt(group.lessons_per_week, 10);
  const lessonsText = Number.isFinite(lessonsPerWeek) && lessonsPerWeek > 0 ? `${lessonsPerWeek} в неделю` : null;
  const parts = [group.name || 'Группа'];
  if (lessonsText) parts.push(lessonsText);
  return parts.join(' • ');
}

function showGroupBookingCapsule(text) {
  const capsule = document.getElementById('group-booking-capsule');
  if (!capsule) return;
  capsule.textContent = String(text || '').trim() || 'Оформление абонемента';
  capsule.classList.remove('hidden');
  requestAnimationFrame(() => capsule.classList.add('show'));
}

function hideGroupBookingCapsule() {
  const capsule = document.getElementById('group-booking-capsule');
  if (!capsule) return;
  capsule.classList.remove('show');
  capsule.classList.add('hidden');
}

function getPersonalScheduleRefreshCapsuleText() {
  return personalScheduleRefreshLoading
    ? '📅 Личное расписание ⏳'
    : '📅 Личное расписание 🔄';
}

function showPersonalScheduleRefreshCapsule() {
  const capsule = document.getElementById('personal-schedule-refresh-capsule');
  if (!capsule) return;
  capsule.textContent = getPersonalScheduleRefreshCapsuleText();
  capsule.classList.remove('hidden');
  requestAnimationFrame(() => capsule.classList.add('show'));
}

function hidePersonalScheduleRefreshCapsule() {
  const capsule = document.getElementById('personal-schedule-refresh-capsule');
  if (!capsule) return;
  capsule.classList.remove('show');
  capsule.classList.add('hidden');
}

function updatePersonalScheduleRefreshCapsule() {
  const capsule = document.getElementById('personal-schedule-refresh-capsule');
  if (!capsule) return;
  capsule.textContent = getPersonalScheduleRefreshCapsuleText();
}

function handlePersonalScheduleRefreshCapsuleClick() {
  if (personalScheduleRefreshLoading) return;
  refreshPersonalSchedule();
}

function formatDirectionTypeLabel(directionType) {
  const value = String(directionType || '').toLowerCase();
  if (value === 'sport') return '\u0421\u043f\u043e\u0440\u0442';
  if (value === 'dance') return '\u0422\u0430\u043d\u0446\u044b';
  return '-';
}

function formatBookingAmount(amount, currency = 'RUB') {
  const numeric = Number(amount);
  if (!Number.isFinite(numeric)) return '-';
  const formatted = new Intl.NumberFormat('ru-RU').format(numeric);
  return `${formatted} ${currency || 'RUB'}`;
}

function getMainGroupLessonsPerWeek() {
  const group = groupBookingState.mainGroup;
  const perWeek = Number.parseInt(group?.lessons_per_week, 10);
  if (!Number.isFinite(perWeek) || perWeek <= 0) return null;
  return perWeek;
}

function getMainGroupLessonsBucket() {
  const perWeek = getMainGroupLessonsPerWeek();
  if (!perWeek) return null;
  const bucket = perWeek * 4;
  if (bucket === 4 || bucket === 8 || bucket === 12) return bucket;
  return null;
}

function getSelectedExtraGroupIds() {
  return (groupBookingState.extraGroupIds || [])
    .filter(id => Number.isFinite(Number(id)) && Number(id) > 0)
    .map(Number)
    .slice(0, 2);
}

function getSelectedOption() {
  return groupBookingState.availableOptions.find(option => option.id === groupBookingState.selectedOptionId) || null;
}

function isMultiOptionSelected() {
  const selected = getSelectedOption();
  return !!selected && selected.abonementType === 'multi';
}

function buildGroupBookingOptionCandidates() {
  const lessonsBucket = getMainGroupLessonsBucket();
  const candidates = [
    {
      id: 'trial',
      label: '\u041f\u0440\u043e\u0431\u043d\u044b\u0439',
      abonementType: 'trial',
      description: '1 \u0437\u0430\u043d\u044f\u0442\u0438\u0435',
    },
    {
      id: 'single',
      label: '\u041e\u0434\u043d\u043e\u0440\u0430\u0437\u043e\u0432\u044b\u0439',
      abonementType: 'single',
      description: '1 \u0437\u0430\u043d\u044f\u0442\u0438\u0435',
    },
  ];

  if (lessonsBucket) {
    [4, 8, 12].forEach((bucket) => {
      if (bucket <= lessonsBucket) {
        candidates.push({
          id: `multi_${bucket}`,
          label: `${bucket} \u0437\u0430\u043d\u044f\u0442\u0438\u0439`,
          abonementType: 'multi',
          multiLessonsPerGroup: bucket,
          description: '\u041c\u043d\u043e\u0433\u043e\u0440\u0430\u0437\u043e\u0432\u044b\u0439',
        });
      }
    });
  }

  return candidates;
}

function getOptionMultiLessonsPerGroup(option) {
  if (!option || option.abonementType !== 'multi') return null;
  const parsed = Number.parseInt(option.multiLessonsPerGroup, 10);
  if (!Number.isFinite(parsed) || ![4, 8, 12].includes(parsed)) return null;
  return parsed;
}

function getBundleGroupIdsForOption(option) {
  if (!activeGroupBookingId || !option) return [];
  if (option.abonementType !== 'multi') {
    return [activeGroupBookingId];
  }
  return [activeGroupBookingId, ...getSelectedExtraGroupIds()].slice(0, 3);
}

function updateGroupBookingSubmitEnabled() {
  const submitButton = document.getElementById('group-booking-submit');
  if (!submitButton) return;
  submitButton.disabled = !(groupBookingState.quote && groupBookingState.selectedOptionId);
}

function applyGroupBookingQuote(quote) {
  groupBookingState.quote = quote || null;
  updateGroupBookingSubmitEnabled();

  if (!quote) {
    resetGroupBookingQuoteView();
    return;
  }

  const amountNode = document.getElementById('group-booking-quote-amount');
  if (amountNode) amountNode.textContent = formatBookingAmount(quote.amount, quote.currency || 'RUB');

  const perGroupNode = document.getElementById('group-booking-quote-lessons-per-group');
  if (perGroupNode) perGroupNode.textContent = String(quote.lessons_per_group ?? '-');

  const totalNode = document.getElementById('group-booking-quote-total-lessons');
  if (totalNode) totalNode.textContent = String(quote.total_lessons ?? '-');

  const nextSessionNode = document.getElementById('group-booking-next-session');
  if (nextSessionNode) nextSessionNode.textContent = formatBookingDisplayDate(quote.valid_from);

  const validUntilNode = document.getElementById('group-booking-valid-until');
  if (validUntilNode) validUntilNode.textContent = formatBookingDisplayDate(quote.valid_to);

  const directionTypeNode = document.getElementById('group-booking-direction-type');
  if (directionTypeNode) directionTypeNode.textContent = formatDirectionTypeLabel(quote.direction_type);

  const paymentLabel = quote.requires_payment
    ? '\u0422\u0440\u0435\u0431\u0443\u0435\u0442\u0441\u044f \u043e\u043f\u043b\u0430\u0442\u0430'
    : '\u0411\u0435\u0437 \u043e\u043f\u043b\u0430\u0442\u044b';
  setGroupBookingQuoteStatus(paymentLabel, false);
}

function renderGroupBookingOptions() {
  const list = document.getElementById('group-booking-options-list');
  if (!list) return;

  const options = [...groupBookingState.availableOptions].sort((a, b) => {
    const ai = GROUP_BOOKING_OPTION_ORDER.indexOf(a.id);
    const bi = GROUP_BOOKING_OPTION_ORDER.indexOf(b.id);
    return (ai === -1 ? 999 : ai) - (bi === -1 ? 999 : bi);
  });

  if (!options.length) {
    list.innerHTML = '<div class="small">\u0414\u043b\u044f \u044d\u0442\u043e\u0439 \u0433\u0440\u0443\u043f\u043f\u044b \u043d\u0435\u0442 \u0434\u043e\u0441\u0442\u0443\u043f\u043d\u044b\u0445 \u0432\u0430\u0440\u0438\u0430\u043d\u0442\u043e\u0432.</div>';
    return;
  }

  list.innerHTML = options.map(option => {
    const checked = option.id === groupBookingState.selectedOptionId;
    const quote = groupBookingState.quotesByOptionId[option.id];
    const priceText = quote ? formatBookingAmount(quote.amount, quote.currency || 'RUB') : '-';
    const optionLine = quote
      ? `${option.label} ${option.description} - ${priceText}`
      : `${option.label} ${option.description}`;

    return `
      <label class="group-booking-option-item ${checked ? 'active' : ''}">
        <input type="radio" name="group-booking-option" ${checked ? 'checked' : ''} onchange="handleGroupBookingOptionSelect('${option.id}')" />
        <div>
          <div class="group-booking-option-title">${escapeHtml(optionLine)}</div>
        </div>
      </label>
    `;
  }).join('');
}

function getCompatibleGroupById(groupId) {
  return (groupBookingState.compatibleGroups || []).find(item => Number(item.id) === Number(groupId)) || null;
}

function renderGroupBookingPicker() {
  const picker = document.getElementById('group-booking-picker');
  const list = document.getElementById('group-booking-picker-list');
  if (!picker || !list) return;

  if (!isMultiOptionSelected() || groupBookingState.activePickerSlot === null) {
    picker.classList.add('hidden');
    list.innerHTML = '';
    return;
  }

  const selected = new Set(getSelectedExtraGroupIds());
  const available = (groupBookingState.compatibleGroups || []).filter(group => !selected.has(Number(group.id)));
  picker.classList.remove('hidden');

  if (!available.length) {
    list.innerHTML = '<div class="small">\u041d\u0435\u0442 \u0434\u043e\u0441\u0442\u0443\u043f\u043d\u044b\u0445 \u043d\u0430\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u0438\u0439 \u0434\u043b\u044f \u0434\u043e\u0431\u0430\u0432\u043b\u0435\u043d\u0438\u044f.</div>';
    return;
  }

  list.innerHTML = available.map(group => {
    const lessons = Number.parseInt(group.lessons_per_week, 10);
    const lessonsText = Number.isFinite(lessons) && lessons > 0 ? `${lessons} \u0432 \u043d\u0435\u0434\u0435\u043b\u044e` : '-';
    return `
      <div class="group-booking-picker-item">
        <div>
          <div class="group-booking-option-title">${escapeHtml(group.name || '\u0413\u0440\u0443\u043f\u043f\u0430')}</div>
          <div class="group-booking-option-meta">${escapeHtml(group.direction_title || '-')} - ${escapeHtml(lessonsText)}</div>
        </div>
        <button type="button" class="save-btn" onclick="selectGroupBookingExtraDirection(${Number(group.id)})">\u0412\u044b\u0431\u0440\u0430\u0442\u044c</button>
      </div>
    `;
  }).join('');
}

function renderGroupBookingDirections() {
  const mainNode = document.getElementById('group-booking-main-direction');
  const slotsNode = document.getElementById('group-booking-extra-slots');
  const hintNode = document.getElementById('group-booking-directions-hint');
  if (!mainNode || !slotsNode || !hintNode) return;

  const group = groupBookingState.mainGroup;
  if (!group) {
    mainNode.textContent = '';
    slotsNode.innerHTML = '';
    hintNode.textContent = '';
    renderGroupBookingPicker();
    return;
  }

  const lessonsPerWeek = Number.parseInt(group.lessons_per_week, 10);
  const lessonsText = Number.isFinite(lessonsPerWeek) && lessonsPerWeek > 0 ? `${lessonsPerWeek} \u0432 \u043d\u0435\u0434\u0435\u043b\u044e` : '-';
  mainNode.innerHTML = `<b>\u041e\u0441\u043d\u043e\u0432\u043d\u043e\u0435 \u043d\u0430\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u0438\u0435:</b> ${escapeHtml(group.name || '\u0413\u0440\u0443\u043f\u043f\u0430')} - ${escapeHtml(group.direction_title || '-')} - ${escapeHtml(lessonsText)}`;

  const extras = getSelectedExtraGroupIds();
  const multiSelected = isMultiOptionSelected();

  let slotsHtml = '';
  for (let slotIndex = 0; slotIndex < 2; slotIndex += 1) {
    const groupId = extras[slotIndex];
    if (groupId) {
      const groupData = getCompatibleGroupById(groupId);
      slotsHtml += `
        <div class="group-booking-extra-slot">
          <div class="group-booking-slot-header">
            <div><b>\u0414\u043e\u043f. \u043d\u0430\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u0438\u0435 ${slotIndex + 2}:</b> ${escapeHtml(groupData?.name || `ID ${groupId}`)}</div>
            <button type="button" class="group-booking-slot-remove" onclick="removeGroupBookingExtraDirection(${slotIndex})">&times;</button>
          </div>
        </div>
      `;
      continue;
    }

    const hasFreeGroups = (groupBookingState.compatibleGroups || []).length > extras.length;
    const canOpenSlot = multiSelected && slotIndex <= extras.length && hasFreeGroups;
    slotsHtml += `
      <button type="button" class="group-booking-plus-btn" ${canOpenSlot ? '' : 'disabled'} onclick="openGroupBookingDirectionPicker(${slotIndex})">+ \u0414\u043e\u0431\u0430\u0432\u0438\u0442\u044c \u043d\u0430\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u0438\u0435 ${slotIndex + 2}</button>
    `;
  }

  slotsNode.innerHTML = slotsHtml;

  if (!multiSelected) {
    hintNode.textContent = '\u0414\u043e\u043f. \u043d\u0430\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u0438\u044f \u0434\u043e\u0441\u0442\u0443\u043f\u043d\u044b \u0442\u043e\u043b\u044c\u043a\u043e \u0434\u043b\u044f 4/8/12 \u0437\u0430\u043d\u044f\u0442\u0438\u0439.';
  } else if (!groupBookingState.compatibleGroups.length) {
    hintNode.textContent = '\u041d\u0435\u0442 \u0441\u043e\u0432\u043c\u0435\u0441\u0442\u0438\u043c\u044b\u0445 \u043d\u0430\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u0438\u0439 (\u043d\u0443\u0436\u043d\u044b \u0442\u043e\u0442 \u0436\u0435 \u0442\u0438\u043f \u0438 \u0442\u043e \u0436\u0435 \u0447\u0438\u0441\u043b\u043e \u0437\u0430\u043d\u044f\u0442\u0438\u0439 \u0432 \u043d\u0435\u0434\u0435\u043b\u044e).';
  } else {
    hintNode.textContent = '';
  }

  renderGroupBookingPicker();
}

function openGroupBookingDirectionPicker(slotIndex) {
  if (!isMultiOptionSelected()) return;
  const normalized = Number.parseInt(slotIndex, 10);
  if (!Number.isFinite(normalized) || normalized < 0 || normalized > 1) return;
  groupBookingState.activePickerSlot = normalized;
  renderGroupBookingPicker();
}

function closeGroupBookingPicker() {
  groupBookingState.activePickerSlot = null;
  renderGroupBookingPicker();
}

async function selectGroupBookingExtraDirection(groupId) {
  const parsedGroupId = Number.parseInt(groupId, 10);
  if (!Number.isFinite(parsedGroupId) || parsedGroupId <= 0) return;
  if (groupBookingState.activePickerSlot === null) return;

  const slot = groupBookingState.activePickerSlot;
  let extras = getSelectedExtraGroupIds();
  if (extras.includes(parsedGroupId)) {
    groupBookingState.activePickerSlot = null;
    renderGroupBookingDirections();
    return;
  }

  extras[slot] = parsedGroupId;
  extras = extras.filter(Boolean).slice(0, 2);
  groupBookingState.extraGroupIds = extras;
  groupBookingState.activePickerSlot = null;

  renderGroupBookingDirections();
  await refreshGroupBookingOptionsAndQuote();
}

async function removeGroupBookingExtraDirection(slotIndex) {
  const normalized = Number.parseInt(slotIndex, 10);
  if (!Number.isFinite(normalized) || normalized < 0) return;

  const extras = getSelectedExtraGroupIds();
  if (normalized >= extras.length) return;
  extras.splice(normalized, 1);
  groupBookingState.extraGroupIds = extras.slice(0, 2);

  if (groupBookingState.activePickerSlot !== null && groupBookingState.activePickerSlot >= groupBookingState.extraGroupIds.length) {
    groupBookingState.activePickerSlot = null;
  }

  renderGroupBookingDirections();
  await refreshGroupBookingOptionsAndQuote();
}

async function fetchGroupBookingQuoteForOption(option) {
  const bundleGroupIds = getBundleGroupIdsForOption(option);
  const multiLessonsPerGroup = getOptionMultiLessonsPerGroup(option);
  const response = await fetch('/api/booking-requests/group/quote', {
    method: 'POST',
    headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
    body: JSON.stringify({
      group_id: activeGroupBookingId,
      abonement_type: option.abonementType,
      bundle_group_ids: bundleGroupIds,
      multi_lessons_per_group: multiLessonsPerGroup,
    }),
  });

  const payload = await response.json().catch(() => ({}));
  if (!response.ok) {
    throw new Error(payload.error || '\u041d\u0435 \u0443\u0434\u0430\u043b\u043e\u0441\u044c \u0440\u0430\u0441\u0441\u0447\u0438\u0442\u0430\u0442\u044c \u0432\u0430\u0440\u0438\u0430\u043d\u0442');
  }
  return payload;
}

async function refreshGroupBookingOptionsAndQuote() {
  if (!activeGroupBookingId || !groupBookingState.mainGroup) {
    return;
  }

  const requestSeq = ++groupBookingState.quoteRequestSeq;
  const candidates = buildGroupBookingOptionCandidates();
  const available = [];
  const quotesByOptionId = {};

  for (const option of candidates) {
    try {
      const quote = await fetchGroupBookingQuoteForOption(option);
      if (requestSeq !== groupBookingState.quoteRequestSeq) {
        return;
      }
      available.push(option);
      quotesByOptionId[option.id] = quote;
    } catch (error) {
      // Option not available right now.
    }
  }

  if (requestSeq !== groupBookingState.quoteRequestSeq) {
    return;
  }

  groupBookingState.availableOptions = available;
  groupBookingState.quotesByOptionId = quotesByOptionId;

  if (!available.length) {
    groupBookingState.selectedOptionId = null;
    applyGroupBookingQuote(null);
    renderGroupBookingOptions();
    renderGroupBookingDirections();
    setGroupBookingOptionsHint('\u0414\u043b\u044f \u044d\u0442\u043e\u0439 \u0433\u0440\u0443\u043f\u043f\u044b \u043d\u0435\u0442 \u0434\u043e\u0441\u0442\u0443\u043f\u043d\u044b\u0445 \u0432\u0430\u0440\u0438\u0430\u043d\u0442\u043e\u0432.', true);
    setGroupBookingQuoteStatus('\u041e\u0444\u043e\u0440\u043c\u043b\u0435\u043d\u0438\u0435 \u0432\u0440\u0435\u043c\u0435\u043d\u043d\u043e \u043d\u0435\u0434\u043e\u0441\u0442\u0443\u043f\u043d\u043e', true);
    return;
  }

  const selectedExists = available.some(option => option.id === groupBookingState.selectedOptionId);
  if (!selectedExists) {
    groupBookingState.selectedOptionId = available[0].id;
  }

  const quote = groupBookingState.quotesByOptionId[groupBookingState.selectedOptionId] || null;
  applyGroupBookingQuote(quote);
  renderGroupBookingOptions();
  renderGroupBookingDirections();

  const selectedOption = getSelectedOption();
  if (selectedOption) {
    setGroupBookingOptionsHint(`\u0412\u044b\u0431\u0440\u0430\u043d\u043e: ${selectedOption.label}`, false);
  }
}

async function handleGroupBookingOptionSelect(optionId) {
  groupBookingState.selectedOptionId = String(optionId || '').trim();
  const quote = groupBookingState.quotesByOptionId[groupBookingState.selectedOptionId] || null;
  applyGroupBookingQuote(quote);
  renderGroupBookingOptions();
  renderGroupBookingDirections();

  const selectedOption = getSelectedOption();
  if (selectedOption) {
    setGroupBookingOptionsHint(`\u0412\u044b\u0431\u0440\u0430\u043d\u043e: ${selectedOption.label}`, false);
  }
}

async function loadGroupBookingCompatibleGroups() {
  const group = groupBookingState.mainGroup;
  if (!group) {
    groupBookingState.compatibleGroups = [];
    return;
  }

  const directionType = String(group.direction_type || '').toLowerCase();
  const lessonsPerWeek = Number.parseInt(group.lessons_per_week, 10);
  if (!directionType || !Number.isFinite(lessonsPerWeek) || lessonsPerWeek <= 0) {
    groupBookingState.compatibleGroups = [];
    return;
  }

  const params = new URLSearchParams({
    direction_type: directionType,
    lessons_per_week: String(lessonsPerWeek),
    exclude_group_id: String(activeGroupBookingId),
  });

  try {
    const response = await fetch(`/api/groups/compatible?${params.toString()}`, { headers: getAuthHeaders() });
    if (!response.ok) {
      const err = await response.json().catch(() => ({}));
      throw new Error(err.error || '\u041d\u0435 \u0443\u0434\u0430\u043b\u043e\u0441\u044c \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044c \u0441\u043e\u0432\u043c\u0435\u0441\u0442\u0438\u043c\u044b\u0435 \u0433\u0440\u0443\u043f\u043f\u044b');
    }
    const payload = await response.json();
    const rows = Array.isArray(payload) ? payload : [];
    groupBookingState.compatibleGroups = rows
      .map(item => ({ ...item, id: Number.parseInt(item.id, 10) }))
      .filter(item => Number.isFinite(item.id) && item.id > 0);
  } catch (error) {
    console.error(error);
    groupBookingState.compatibleGroups = [];
  }
}

async function openGroupBookingForm(groupId) {
  const group = (window.groupDetails && window.groupDetails[groupId]) || null;
  if (!group) {
    showNotification('\u041d\u0435 \u0443\u0434\u0430\u043b\u043e\u0441\u044c \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u0438\u0442\u044c \u0433\u0440\u0443\u043f\u043f\u0443');
    return;
  }

  activeGroupBookingId = Number(groupId);
  resetGroupBookingState();
  groupBookingState.mainGroup = group;

  const overlay = document.getElementById('group-booking-overlay');
  if (!overlay) return;

  setGroupBookingInfoText(group);
  toggleGroupBookingInfoPopup(false);

  const noteInput = document.getElementById('group-booking-note');
  if (noteInput) noteInput.value = '';

  resetGroupBookingQuoteView();
  setGroupBookingOptionsHint('\u0417\u0430\u0433\u0440\u0443\u0437\u043a\u0430 \u0434\u043e\u0441\u0442\u0443\u043f\u043d\u044b\u0445 \u0432\u0430\u0440\u0438\u0430\u043d\u0442\u043e\u0432...', false);
  setGroupBookingQuoteStatus('\u0420\u0430\u0441\u0447\u0451\u0442 \u0441\u0442\u043e\u0438\u043c\u043e\u0441\u0442\u0438...', false);

  overlay.classList.add('show');
  document.body.classList.add('group-booking-open');
  setModalBackHandler(closeGroupBookingForm);
  showGroupBookingCapsule(getGroupBookingCapsuleText(group));

  renderGroupBookingOptions();
  renderGroupBookingDirections();
  updateGroupBookingSubmitEnabled();

  await loadGroupBookingCompatibleGroups();
  renderGroupBookingDirections();
  await refreshGroupBookingOptionsAndQuote();
}

function closeGroupBookingForm() {
  const overlay = document.getElementById('group-booking-overlay');
  if (!overlay) return;
  hideGroupBookingCapsule();
  toggleGroupBookingInfoPopup(false);
  overlay.classList.remove('show');
  document.body.classList.remove('group-booking-open');
  setModalBackHandler(null);
  activeGroupBookingId = null;
  resetGroupBookingState();
}

async function submitGroupBookingForm() {
  if (!activeGroupBookingId) {
    showNotification('\u0413\u0440\u0443\u043f\u043f\u0430 \u043d\u0435 \u0432\u044b\u0431\u0440\u0430\u043d\u0430');
    return;
  }

  const selectedOption = getSelectedOption();
  if (!selectedOption) {
    showNotification('\u0412\u044b\u0431\u0435\u0440\u0438\u0442\u0435 \u0432\u0430\u0440\u0438\u0430\u043d\u0442 \u0430\u0431\u043e\u043d\u0435\u043c\u0435\u043d\u0442\u0430');
    return;
  }

  if (!groupBookingState.quote) {
    await refreshGroupBookingOptionsAndQuote();
    if (!groupBookingState.quote) {
      showNotification('\u041d\u0435 \u0443\u0434\u0430\u043b\u043e\u0441\u044c \u0440\u0430\u0441\u0441\u0447\u0438\u0442\u0430\u0442\u044c \u0441\u0442\u043e\u0438\u043c\u043e\u0441\u0442\u044c');
      return;
    }
  }

  const bundleGroupIds = getBundleGroupIdsForOption(selectedOption);
  const submitButton = document.getElementById('group-booking-submit');
  if (!submitButton) return;

  const originalText = submitButton.textContent;
  submitButton.disabled = true;
  submitButton.textContent = '\u041e\u0442\u043f\u0440\u0430\u0432\u043a\u0430...';

  const note = document.getElementById('group-booking-note')?.value.trim();
  const multiLessonsPerGroup = getOptionMultiLessonsPerGroup(selectedOption);
  const payload = {
    object_type: 'group',
    group_id: activeGroupBookingId,
    abonement_type: selectedOption.abonementType,
    bundle_group_ids: bundleGroupIds,
    multi_lessons_per_group: multiLessonsPerGroup,
    comment: note || null,
  };

  try {
    const response = await fetch('/api/booking-requests', {
      method: 'POST',
      headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
      body: JSON.stringify(payload),
    });
    const data = await response.json().catch(() => ({}));
    if (!response.ok) {
      throw new Error(data.error || '\u041d\u0435 \u0443\u0434\u0430\u043b\u043e\u0441\u044c \u043e\u0442\u043f\u0440\u0430\u0432\u0438\u0442\u044c \u0437\u0430\u044f\u0432\u043a\u0443');
    }

    if (data.status === 'NEW') {
      showNotification('\u0417\u0430\u044f\u0432\u043a\u0430 \u043e\u0442\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u0430 \u043d\u0430 \u0440\u0443\u0447\u043d\u043e\u0435 \u043e\u0434\u043e\u0431\u0440\u0435\u043d\u0438\u0435');
    } else {
      showNotification('\u0417\u0430\u044f\u0432\u043a\u0430 \u043e\u0442\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u0430. \u041e\u0436\u0438\u0434\u0430\u0435\u0442\u0441\u044f \u043e\u043f\u043b\u0430\u0442\u0430');
    }
    closeGroupBookingForm();
  } catch (error) {
    console.error(error);
    showNotification(error.message || '\u041e\u0448\u0438\u0431\u043a\u0430 \u043e\u0444\u043e\u0440\u043c\u043b\u0435\u043d\u0438\u044f \u0437\u0430\u044f\u0432\u043a\u0438');
  } finally {
    submitButton.textContent = originalText;
    if (activeGroupBookingId) {
      submitButton.disabled = !(groupBookingState.quote && groupBookingState.selectedOptionId);
    }
  }
}

function openTeacherProfilePlaceholder(teacherId) {
  const id = Number(teacherId);
  if (!Number.isFinite(id) || id <= 0) return;
  openTeacherDetail(id);
}


/* ====== АДМИН-РАСПИСАНИЕ (РАБОТА) ====== */
let scheduleView = 'week';
let scheduleFocusDate = toLocalDayStart(new Date());
let scheduleItems = [];
window.publicScheduleType = 'all';
window.publicScheduleView = 'list';
window.publicScheduleCache = {};
window.publicScheduleMonthDate = null;
window.publicScheduleWeekStart = null;
let currentScheduleItem = null;
window.currentScheduleItem = null;
let schedulePollTimer = null;
const CONFIRMED_STATUS_SET = new Set(['scheduled', 'confirmed', 'approved', 'paid']);
const SCHEDULE_POLL_INTERVAL = 15000;
let scheduleInitialized = false;
let scheduleConfirmedFilter = false;

const SCHEDULE_TYPE_TITLES = {
  group: 'Групповое занятие',
  individual: 'Индивидуальное занятие',
  rental: 'Аренда'
};

const SCHEDULE_STATUS_LABELS = {
  scheduled: 'Запланировано',
  pending: 'Ожидается подтверждение',
  NEW: 'Новая заявка',
  APPROVED: 'Подтверждено, но не оплачено',
  PENDING: 'На рассмотрении',
  AWAITING_PAYMENT: 'Ожидается оплата',
  PAID: 'Оплачено',
  CANCELLED: 'Отменено',
  REJECTED: 'Отклонено',
  PAYMENT_FAILED: 'Ошибка оплаты'
};

const WORK_START_HOUR = 9;
const WORK_END_HOUR = 22;
const SLOT_MINUTES = 30;

function initScheduleControl() {
  if (!scheduleInitialized) {
    scheduleInitialized = true;
  }
  updateScheduleControlsUI();
  loadScheduleV2();
  startSchedulePolling();
  initGroupScheduleForm();
}

function startSchedulePolling() {
  stopSchedulePolling();
  schedulePollTimer = setInterval(() => {
    const schedulePage = document.getElementById('schedule-control');
    if (schedulePage && schedulePage.classList.contains('active')) {
      loadScheduleV2();
    }
  }, SCHEDULE_POLL_INTERVAL);
}

function stopSchedulePolling() {
  if (schedulePollTimer) {
    clearInterval(schedulePollTimer);
    schedulePollTimer = null;
  }
}

function setScheduleView(view) {
  scheduleView = view;
  updateScheduleControlsUI();
  loadScheduleV2();
}

function shiftScheduleDate(delta) {
  const stepDays = scheduleView === 'week' ? 7 : 1;
  const next = toLocalDayStart(scheduleFocusDate);
  next.setDate(next.getDate() + delta * stepDays);
  scheduleFocusDate = next;
  updateScheduleControlsUI();
  loadScheduleV2();
}

function updateScheduleControlsUI() {
  const weekBtn = document.getElementById('schedule-view-week');
  const dayBtn = document.getElementById('schedule-view-day');
  if (weekBtn && dayBtn) {
    weekBtn.classList.toggle('active', scheduleView === 'week');
    dayBtn.classList.toggle('active', scheduleView === 'day');
  }
  const filterBtn = document.getElementById('schedule-confirmed-toggle');
  if (filterBtn) {
    filterBtn.classList.toggle('active', scheduleConfirmedFilter);
  }

  const label = document.getElementById('schedule-date-label');
  if (label) {
    if (scheduleView === 'week') {
      const start = getWeekStart(scheduleFocusDate);
      const end = new Date(start.getTime() + 6 * 24 * 60 * 60 * 1000);
      label.textContent = `${formatDateShort(start)} - ${formatDateShort(end)}`;
    } else {
      label.textContent = formatDateLong(scheduleFocusDate);
    }
  }
}

function toggleScheduleConfirmedFilter() {
  scheduleConfirmedFilter = !scheduleConfirmedFilter;
  const toggleBtn = document.getElementById('schedule-confirmed-toggle');
  if (toggleBtn) {
    toggleBtn.classList.toggle('active', scheduleConfirmedFilter);
  }
  renderScheduleGrid();
}

function getActiveScheduleItems() {
  if (!scheduleConfirmedFilter) {
    return scheduleItems;
  }
  return scheduleItems.filter(item => {
    const status = (item.status || 'scheduled').toString().toLowerCase();
    return CONFIRMED_STATUS_SET.has(status);
  });
}

function getWeekStart(date) {
  const d = new Date(date);
  const day = (d.getDay() + 6) % 7; // 0=Mon
  d.setDate(d.getDate() - day);
  d.setHours(0, 0, 0, 0);
  return d;
}

function toLocalDayStart(date) {
  const d = new Date(date);
  d.setHours(0, 0, 0, 0);
  return d;
}

function formatDateShort(d) {
  return d.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
}

function formatDateLong(d) {
  return d.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long', year: 'numeric' });
}

function timeToMinutes(t) {
  const [h, m] = t.split(':').map(Number);
  return h * 60 + m;
}

function minutesToTime(min) {
  const h = Math.floor(min / 60);
  const m = min % 60;
  return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
}

function formatTimeLabel(timeStr) {
  const parts = timeStr.split(':');
  if (parts.length < 2) return '';
  const minutes = parseInt(parts[1], 10);
  return minutes === 0 ? timeStr : '';
}

function isHalfHour(timeStr) {
  const parts = timeStr.split(':');
  if (parts.length < 2) return false;
  const minutes = parseInt(parts[1], 10);
  return minutes === 30;
}

function loadScheduleV2() {
  const dateFrom = scheduleView === 'week' ? getWeekStart(scheduleFocusDate) : toLocalDayStart(scheduleFocusDate);
  const dateTo = scheduleView === 'week'
    ? new Date(dateFrom.getTime() + 6 * 24 * 60 * 60 * 1000)
    : toLocalDayStart(scheduleFocusDate);

  const params = new URLSearchParams({
    date_from: formatDateLocal(dateFrom),
    date_to: formatDateLocal(dateTo)
  });

  fetch(`/schedule/v2?${params.toString()}`, { headers: getAuthHeaders() })
    .then(async res => {
      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.error || 'Ошибка загрузки расписания');
      }
      return res.json();
    })
    .then(data => {
      scheduleItems = Array.isArray(data) ? data : [];
      renderScheduleGrid();
    })
    .catch(err => {
      console.error(err);
      const container = document.getElementById('schedule-grid-container');
      if (container) {
        container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">❌ Ошибка загрузки расписания</p>';
      }
    });

}

function renderScheduleGrid() {
  const container = document.getElementById('schedule-grid-container');
  if (!container) return;

  const slots = [];
  for (let t = WORK_START_HOUR * 60; t < WORK_END_HOUR * 60; t += SLOT_MINUTES) {
    slots.push(minutesToTime(t));
  }

  if (scheduleView === 'day') {
    const dateStr = formatDateLocal(scheduleFocusDate);
    let html = `<div class="schedule-grid day">`;
    html += `<div class="schedule-cell head">Время</div><div class="schedule-cell head">${formatDateShort(scheduleFocusDate)}</div>`;
    for (const time of slots) {
      const timeClass = isHalfHour(time) ? 'schedule-cell time half' : 'schedule-cell time';
      html += `<div class="${timeClass}">${formatTimeLabel(time)}</div>`;
      const confirmedItem = getSlotInfo(dateStr, time);
      html += renderSlotCell(dateStr, time, confirmedItem);
    }
    html += `</div>`;
    container.innerHTML = html;
  } else {
    const weekStart = getWeekStart(scheduleFocusDate);
    const days = [];
    for (let i = 0; i < 7; i++) {
      const d = new Date(weekStart.getTime() + i * 24 * 60 * 60 * 1000);
      days.push(d);
    }

    let html = `<div class="schedule-grid">`;
    html += `<div class="schedule-cell head">Время</div>`;
    for (const d of days) {
      html += `<div class="schedule-cell head">${d.toLocaleDateString('ru-RU', { weekday: 'short', day: '2-digit' })}</div>`;
    }
    for (const time of slots) {
      const timeClass = isHalfHour(time) ? 'schedule-cell time half' : 'schedule-cell time';
      html += `<div class="${timeClass}">${formatTimeLabel(time)}</div>`;
      for (const d of days) {
        const dateStr = formatDateLocal(d);
        const confirmedItem = getSlotInfo(dateStr, time);
        html += renderSlotCell(dateStr, time, confirmedItem);
      }
    }
    html += `</div>`;
    container.innerHTML = html;
  }
  bindSlotHoverGrouping(container);
  renderScheduleNowIndicator(container);
}

function renderScheduleNowIndicator(container) {
  if (!container) return;
  container.querySelectorAll('.schedule-now-line').forEach(el => el.remove());

  const grid = container.querySelector('.schedule-grid');
  if (!grid) return;

  const today = new Date();
  const todayIso = formatDateLocal(today);
  let todayColumnIndex = -1;

  if (scheduleView === 'day') {
    todayColumnIndex = formatDateLocal(scheduleFocusDate) === todayIso ? 0 : -1;
  } else {
    const weekStart = getWeekStart(scheduleFocusDate);
    for (let i = 0; i < 7; i++) {
      const day = new Date(weekStart);
      day.setDate(weekStart.getDate() + i);
      if (formatDateLocal(day) === todayIso) {
        todayColumnIndex = i;
        break;
      }
    }
  }

  if (todayColumnIndex < 0) return;

  const slotCount = Math.floor(((WORK_END_HOUR - WORK_START_HOUR) * 60) / SLOT_MINUTES);
  if (slotCount <= 0) return;

  const columnCount = scheduleView === 'week' ? 8 : 2;
  const dayColumnOffset = scheduleView === 'week' ? todayColumnIndex + 1 : 1;
  const firstCellIndex = columnCount + dayColumnOffset;
  const lastCellIndex = columnCount + (slotCount - 1) * columnCount + dayColumnOffset;
  const firstCell = grid.children[firstCellIndex];
  const lastCell = grid.children[lastCellIndex];
  if (!firstCell || !lastCell) return;

  const nowMinutes = today.getHours() * 60 + today.getMinutes() + (today.getSeconds() / 60);
  const workStartMinutes = WORK_START_HOUR * 60;
  const workEndMinutes = WORK_END_HOUR * 60;
  if (workEndMinutes <= workStartMinutes) return;
  if (nowMinutes < workStartMinutes || nowMinutes > workEndMinutes) return;

  const containerRect = container.getBoundingClientRect();
  const firstRect = firstCell.getBoundingClientRect();
  const lastRect = lastCell.getBoundingClientRect();

  const colLeft = firstRect.left - containerRect.left;
  const colTop = firstRect.top - containerRect.top;
  const colWidth = firstRect.width;
  const colHeight = lastRect.bottom - firstRect.top;
  if (colWidth <= 0 || colHeight <= 0) return;

  const ratio = Math.min(1, Math.max(0, (nowMinutes - workStartMinutes) / (workEndMinutes - workStartMinutes)));
  const lineY = colTop + colHeight * ratio;

  const inset = 2;
  const line = document.createElement('div');
  line.className = 'schedule-now-line';
  line.style.left = `${colLeft + inset}px`;
  line.style.top = `${lineY - 1}px`;
  line.style.width = `${Math.max(2, colWidth - inset * 2)}px`;
  container.appendChild(line);
}

function getSlotInfo(dateStr, timeStr) {
  const activeItems = getActiveScheduleItems();
  const slotStart = timeToMinutes(timeStr);
  const slotEnd = slotStart + SLOT_MINUTES;
  const item = activeItems.find(s => {
    if (s.date !== dateStr) return false;
    if (!s.time_from || !s.time_to) return false;
    const start = timeToMinutes(s.time_from);
    const end = timeToMinutes(s.time_to);
    return slotStart < end && slotEnd > start && s.status !== 'cancelled';
  });
  return item || null;
}

function renderSlotCell(dateStr, timeStr, confirmedItem) {
  if (confirmedItem) {
    return renderConfirmedSlotCell(confirmedItem, timeStr);
  }
  return `<div class="schedule-cell schedule-slot" onclick="openScheduleForm('${dateStr}', '${timeStr}')"></div>`;
}

function renderConfirmedSlotCell(item, timeStr) {
  const info = getSlotRenderInfo(item, timeStr);
  const labelHtml = info.showLabel ? `<div class="schedule-event">${getScheduleLabel(item)}</div>` : '';
  const color = getScheduleColor(item);
  const stateClass = item.status && item.status !== 'scheduled' ? 'pending' : 'confirmed';
  const groupKey = item.id ? `schedule-${item.id}` : '';
  const dataAttr = groupKey ? ` data-slot-group="${groupKey}"` : '';
  return `<div class="schedule-cell schedule-slot confirmed ${stateClass} ${item.object_type}" style="background: ${color};"${dataAttr} onclick="openScheduleDetailById(${item.id})">${labelHtml}</div>`;
}

function getScheduleLabel(item) {
  const typeMap = {
    group: 'Группа',
    individual: 'Индив.',
    rental: 'Аренда'
  };
  const statusIcon = getScheduleStatusIcon(item.status);
  return `${typeMap[item.object_type] || 'Событие'} #${item.object_id}${statusIcon ? ' ' + statusIcon : ''}`;
}

function getScheduleStatusIcon(status) {
  switch (status) {
    case 'AWAITING_PAYMENT':
      return '💰';
    case 'APPROVED':
    case 'PENDING':
      return '?';
    default:
      return '';
  }
}

function formatScheduleStatusLabel(status) {
  if (!status) return '—';
  const normalized = String(status);
  if (SCHEDULE_STATUS_LABELS[normalized]) {
    return SCHEDULE_STATUS_LABELS[normalized];
  }
  const upper = normalized.toUpperCase();
  if (SCHEDULE_STATUS_LABELS[upper]) {
    return SCHEDULE_STATUS_LABELS[upper];
  }
  const lower = normalized.toLowerCase();
  if (SCHEDULE_STATUS_LABELS[lower]) {
    return SCHEDULE_STATUS_LABELS[lower];
  }
  return normalized;
}

function getSlotRenderInfo(item, timeStr) {
  if (!item.time_from || !item.time_to) return { showLabel: true };
  const start = timeToMinutes(item.time_from);
  const end = timeToMinutes(item.time_to);
  const slotStart = timeToMinutes(timeStr);
  const totalSlots = Math.max(1, Math.ceil((end - start) / SLOT_MINUTES));
  const slotIndex = Math.floor((slotStart - start) / SLOT_MINUTES);
  const midIndex = Math.floor((totalSlots - 1) / 2);
  return { showLabel: slotIndex === midIndex };
}

function bindSlotHoverGrouping(container) {
  if (!container) return;
  const groups = new Map();
  container.querySelectorAll('[data-slot-group]').forEach(cell => {
    const key = cell.dataset.slotGroup;
    if (!key) return;
    if (!groups.has(key)) {
      groups.set(key, []);
    }
    groups.get(key).push(cell);
  });

  groups.forEach(group => {
    // сбрасываем предыдущие роли
    group.forEach(cell => cell.classList.remove('slot-group-start', 'slot-group-middle', 'slot-group-end', 'slot-grouped'));
    // назначаем роли для визуального объединения
    group.forEach((cell, index) => {
      cell.classList.add('slot-grouped');
      if (index === 0) cell.classList.add('slot-group-start');
      if (index === group.length - 1) cell.classList.add('slot-group-end');
      if (index > 0 && index < group.length - 1) cell.classList.add('slot-group-middle');
    });

    group.forEach(cell => {
      cell.addEventListener('mouseenter', () => toggleSlotGroupHighlight(group, true, cell, container));
      cell.addEventListener('mouseleave', () => toggleSlotGroupHighlight(group, false, null, container));
    });
  });
}

function toggleSlotGroupHighlight(group, highlight, hoveredCell, container) {
  group.forEach(cell => {
    cell.classList.remove('schedule-slot-highlighted-other', 'schedule-slot-highlighted-active');
    if (!highlight) return;
    if (cell === hoveredCell) {
      cell.classList.add('schedule-slot-highlighted-active');
    } else {
      cell.classList.add('schedule-slot-highlighted-other');
    }
  });
  const overlay = ensureScheduleGridHighlight(container);
  if (!highlight) {
    overlay.style.opacity = '0';
    return;
  }
  const rects = group.map(cell => cell.getBoundingClientRect());
  const containerRect = container.getBoundingClientRect();
  const left = Math.min(...rects.map(r => r.left)) - containerRect.left;
  const right = Math.max(...rects.map(r => r.right)) - containerRect.left;
  const top = Math.min(...rects.map(r => r.top)) - containerRect.top;
  const bottom = Math.max(...rects.map(r => r.bottom)) - containerRect.top;
  overlay.style.left = `${left}px`;
  overlay.style.top = `${top}px`;
  overlay.style.width = `${right - left}px`;
  overlay.style.height = `${bottom - top}px`;
  overlay.style.opacity = '1';
}

function ensureScheduleGridHighlight(container) {
  if (!container) return null;
  let overlay = container.querySelector('.schedule-grid-block-highlight');
  if (!overlay) {
    overlay = document.createElement('div');
    overlay.className = 'schedule-grid-block-highlight';
    container.appendChild(overlay);
  }
  return overlay;
}

function getScheduleColor(item) {
  const baseOffset = {
    group: 210,
    individual: 120,
    rental: 290
  }[item.object_type] || 0;
  const key = `${item.object_type}-${item.object_id || ''}`;
  const hue = (hashString(key) + baseOffset) % 360;
  return `hsla(${hue}, 70%, 85%, 0.8)`;
}

function hashString(str) {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    hash = ((hash << 5) - hash) + str.charCodeAt(i);
    hash |= 0;
  }
  return Math.abs(hash);
}

function openScheduleDetailById(id) {
  const item = scheduleItems.find(s => s.id === id);
  if (!item) return;
  openScheduleDetail(item);
}

function openScheduleDetail(item) {
  currentScheduleItem = item;
  window.currentScheduleItem = item;
  const card = document.getElementById('schedule-detail-modal');
  const overlay = document.getElementById('schedule-detail-overlay');
  const content = document.getElementById('schedule-detail-content');
  if (!card || !content || !overlay) return;

  const typeMap = SCHEDULE_TYPE_TITLES;

  const dateText = item.date ? new Date(item.date).toLocaleDateString('ru-RU') : '—';
  const timeText = item.time_from && item.time_to ? `${item.time_from} - ${item.time_to}` : '—';

  content.innerHTML = `
    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
      <div class="schedule-detail-chip">📌 ${typeMap[item.object_type] || 'Событие'}</div>
      <div class="schedule-detail-chip">📅 ${dateText}</div>
      <div class="schedule-detail-chip">⏰ ${timeText}</div>
    </div>
<div class="schedule-detail-card" id="schedule-detail-extra"></div>
    <div class="schedule-detail-card" id="schedule-attendance-card">
      <div class="schedule-detail-row" style="justify-content: space-between; align-items: center;">
        <div><strong>Посещаемость</strong></div>
        <button class="save-btn" style="padding:6px 10px; margin:0;" onclick="openAttendanceScreen(currentScheduleItem)">Во весь экран</button>
      </div>
      <div class="small" style="color: var(--hint);">Отмечайте посещаемость на отдельном экране.</div>
    </div>
  `;

  card.classList.add('show');
  overlay.classList.add('show');

  const extra = document.getElementById('schedule-detail-extra');
  if (item.object_type === 'group') {
    loadGroupScheduleDetails(item.object_id);
  } else if (item.object_type === 'individual') {
    renderIndividualLessonDetails(item, extra);
  } else if (extra) {
    extra.innerHTML = '<div class="small">Нет дополнительных данных</div>';
  }

  // Не грузим посещаемость в модалке, только в полноэкранном экране
}

function closeScheduleDetail() {
  const card = document.getElementById('schedule-detail-modal');
  const overlay = document.getElementById('schedule-detail-overlay');
  if (card) card.classList.remove('show');
  if (overlay) overlay.classList.remove('show');
}

function loadGroupScheduleDetails(groupId) {
  const extra = document.getElementById('schedule-detail-extra');
  if (!extra) return;
  extra.innerHTML = '<div class="small">⏳ Загрузка деталей группы...</div>';

  fetch(`/api/groups/${groupId}`, { headers: getAuthHeaders() })
    .then(async res => {
      if (!res.ok) throw new Error('Ошибка загрузки группы');
      return res.json();
    })
    .then(async group => {
      let directionTitle = '—';
      let directionPrice = null;
      let teacherName = '—';

      if (group.direction_id) {
        try {
          const dirRes = await fetch(`/api/directions/${group.direction_id}`, { headers: getAuthHeaders() });
          if (dirRes.ok) {
            const dir = await dirRes.json();
            directionTitle = dir.title || directionTitle;
            directionPrice = dir.base_price || directionPrice;
          }
        } catch (err) {
          // ignore
        }
      }

      if (group.teacher_id) {
        try {
          const staffRes = await fetch(`/staff/${group.teacher_id}`, { headers: getAuthHeaders() });
          if (staffRes.ok) {
            const staff = await staffRes.json();
            teacherName = staff.name || teacherName;
          }
        } catch (err) {
          // ignore
        }
      }

      extra.innerHTML = `
        <div class="schedule-detail-row">👥 <strong>Группа:</strong> ${group.name || '—'}</div>
        <div class="schedule-detail-row">🎯 <strong>Направление:</strong> ${directionTitle}</div>
        <div class="schedule-detail-row">👩‍🏫 <strong>Учитель:</strong> ${teacherName}</div>
        <div class="schedule-detail-row">🎈 <strong>Возраст:</strong> ${group.age_group || '—'}</div>
        ${group.lessons_per_week ? `<div class="schedule-detail-row">📆 <strong>Занятий в неделю:</strong> ${group.lessons_per_week}</div>` : ''}
        <div class="schedule-detail-row">💰 <strong>Цена:</strong> ${directionPrice ? directionPrice + ' ?' : '—'}</div>
      `;
    })
    .catch(() => {
      extra.innerHTML = '<div class="small">❌ Не удалось загрузить детали группы</div>';
    });
}

function renderIndividualLessonDetails(item, extra) {
  if (!extra) return;
  extra.innerHTML = '<div class="small">⏳ Загрузка деталей индивидуального занятия...</div>';
  if (!item.object_id) {
    extra.innerHTML = '<div class="small">Идентификатор занятия не указан</div>';
    return;
  }

  fetch(`/api/individual-lessons/${item.object_id}`, { headers: getAuthHeaders() })
    .then(async res => {
      if (!res.ok) {
        const err = await res.json().catch(() => null);
        throw new Error((err && err.error) || 'Ошибка загрузки данных');
      }
      return res.json();
    })
    .then(detail => {
      const teacherName = escapeHtml(detail.teacher?.name || '—');
      const studentName = escapeHtml(detail.student?.name || '—');
      const statusCode = detail.status || item.status;
      const statusIcon = getScheduleStatusIcon(statusCode);
      const statusText = formatScheduleStatusLabel(statusCode);
      extra.innerHTML = `
        <div class="schedule-detail-row">👩‍🏫 <strong>Преподаватель:</strong> ${teacherName}</div>
        <div class="schedule-detail-row">🧑‍🎓 <strong>Ученик:</strong> ${studentName}</div>
        <div class="schedule-detail-row">📌 <strong>Статус:</strong> ${statusIcon ? statusIcon + ' ' : ''}${statusText}</div>
      `;
      const chatLink = buildStudentChatLink(detail.student);
      appendScheduleDetailActionButton(extra, chatLink);
    })
    .catch(() => {
      extra.innerHTML = '<div class="small">❌ Не удалось загрузить детали индивидуального занятия</div>';
    });
}

function appendScheduleDetailActionButton(container, chatLink) {
  if (!container || !chatLink) return;
  const actions = document.createElement('div');
  actions.className = 'schedule-detail-actions';
  const btn = document.createElement('button');
  btn.type = 'button';
  btn.className = 'schedule-detail-client-btn';
  btn.textContent = 'Открыть клиента';
  btn.addEventListener('click', () => openClientChat(chatLink));
  actions.appendChild(btn);
  container.appendChild(actions);
}

function buildStudentChatLink(student) {
  if (!student) return null;
  const rawUsername = student.username ? String(student.username).trim() : '';
  if (rawUsername) {
    const normalizedUsername = rawUsername.startsWith('@') ? rawUsername.slice(1) : rawUsername;
    if (normalizedUsername) {
      return `https://t.me/${encodeURIComponent(normalizedUsername)}`;
    }
  }
  if (student.telegram_id) {
    return `tg://user?id=${student.telegram_id}`;
  }
  return null;
}

function openClientChat(link) {
  if (!link) {
    showNotification('Нет данных для этого клиента');
    return;
  }
  try {
    if (tg?.openLink) {
      tg.openLink(link);
    } else {
      window.open(link, '_blank');
    }
  } catch (error) {
    window.open(link, '_blank');
  }
}

// =============== ATTENDANCE ===============
let attendanceState = {
  scheduleId: null,
  items: [],
  statusLabels: {},
  canEdit: false,
  attendancePhase: null,
  attendancePhaseMessage: '',
  plannedSummary: null
};
let attendanceScreenItem = null;
const ATT_LABELS_FALLBACK = {
  present: 'Присутствовал',
  absent: 'Отсутствовал'
};
const ATT_PLAN_LABELS = {
  will_come: 'Придет',
  will_miss: 'Не придет'
};

function renderAttendance() {
  const containers = [
    document.getElementById('schedule-attendance-content'),
    document.getElementById('attendance-screen-list')
  ].filter(Boolean);
  if (!containers.length) return;

  containers.forEach(container => {
    container.innerHTML = '';
    if (!attendanceState.items.length) {
      container.innerHTML = '<div class="small">Нет участников</div>';
      return;
    }

    attendanceState.items.forEach(item => {
      const wrapper = document.createElement('div');
      wrapper.className = 'attendance-item';
      const top = document.createElement('div');
      top.className = 'attendance-top';

      const name = document.createElement('div');
      name.className = 'attendance-name';
      name.textContent = item.name || ('ID ' + item.user_id);

      const badge = document.createElement('div');
      badge.className = 'attendance-badge';
      const plannedStatus = item.planned_status || (item.planned_absence ? 'will_miss' : 'will_come');
      const plannedLabel = ATT_PLAN_LABELS[plannedStatus] || 'Придет';
      badge.textContent = `${plannedLabel} • ${item.debited ? 'Списано' : (item.abonement_id ? 'Абонемент #' + item.abonement_id : 'Без абонемента')}`;

      top.appendChild(name);
      top.appendChild(badge);

      const actions = document.createElement('div');
      actions.className = 'attendance-actions';

      ['present', 'absent'].forEach(status => {
        const btn = document.createElement('button');
        btn.className = 'attendance-btn' + (item.status === status ? ' active' : '');
        btn.textContent = ATT_LABELS_FALLBACK[status] || attendanceState.statusLabels[status] || status;
        btn.disabled = !attendanceState.canEdit;
        btn.onclick = () => {
          item.status = status;
          renderAttendance();
        };
        actions.appendChild(btn);
      });

      wrapper.appendChild(top);
      if (item.planned_absence_reason) {
        const reason = document.createElement('div');
        reason.className = 'small';
        reason.style.color = 'var(--hint)';
        reason.style.marginTop = '4px';
        reason.textContent = 'Причина: ' + item.planned_absence_reason;
        wrapper.appendChild(reason);
      }
      wrapper.appendChild(actions);
      container.appendChild(wrapper);
    });
  });

  const saveBtns = [
    document.querySelector('#schedule-attendance-card button[onclick="saveAttendance()"]'),
    document.querySelector('#attendance-screen button[onclick="saveAttendance()"]')
  ].filter(Boolean);
  saveBtns.forEach(btn => btn.disabled = !attendanceState.canEdit || !attendanceState.items.length);

  const addBtns = [
    document.querySelector('#schedule-attendance-card button[onclick="promptAddAttendanceUser()"]'),
    document.querySelector('#attendance-screen button[onclick="promptAddAttendanceUser()"]')
  ].filter(Boolean);
  addBtns.forEach(btn => btn.disabled = !attendanceState.canEdit);

  const phaseParts = [];
  if (attendanceState.plannedSummary) {
    const come = attendanceState.plannedSummary.will_come || 0;
    const miss = attendanceState.plannedSummary.will_miss || 0;
    phaseParts.push(`План: придут ${come}, не придут ${miss}`);
  }
  if (attendanceState.attendancePhaseMessage) {
    phaseParts.push(attendanceState.attendancePhaseMessage);
  }
  const phaseText = phaseParts.join(' • ');
  const statusPrimary = document.getElementById('attendance-status-message');
  if (statusPrimary && phaseText) statusPrimary.textContent = phaseText;
  const statusSecondary = document.getElementById('attendance-screen-status');
  if (statusSecondary && phaseText) statusSecondary.textContent = phaseText;
}

async function loadAttendance(scheduleId) {
  const containers = [
    document.getElementById('schedule-attendance-content'),
    document.getElementById('attendance-screen-list')
  ].filter(Boolean);
  containers.forEach(c => c.innerHTML = '<div class="small">Загрузка...</div>');
  try {
    const res = await fetch(`/api/attendance/${scheduleId}`, { headers: getAuthHeaders() });
    if (!res.ok) throw new Error('Ошибка сети');
    const data = await res.json();
    attendanceState = {
      scheduleId,
      items: Array.isArray(data.items) ? data.items : [],
      statusLabels: data.status_labels || {},
      canEdit: !!data.can_edit,
      attendancePhase: data.attendance_phase || null,
      attendancePhaseMessage: data.attendance_phase_message || '',
      plannedSummary: data.planned_summary || null
    };
    renderAttendance();
  } catch (err) {
    containers.forEach(c => c.innerHTML = '<div class="small">Не удалось загрузить посещаемость</div>');
  }
}

function markAllPresent() {
  if (!attendanceState.canEdit) return;
  attendanceState.items = attendanceState.items.map(i => ({ ...i, status: 'present' }));
  renderAttendance();
}

async function saveAttendance() {
  const msg = document.getElementById('attendance-status-message');
  if (!attendanceState.scheduleId) return;
  try {
    const res = await fetch(`/api/attendance/${attendanceState.scheduleId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        ...getAuthHeaders()
      },
      body: JSON.stringify({ items: attendanceState.items })
    });
    if (!res.ok) {
      const err = await res.json().catch(() => null);
      throw new Error((err && err.error) || 'Ошибка сохранения');
    }
    const data = await res.json();
    if (data.items) {
      attendanceState.items = attendanceState.items.map(item => {
        const updated = data.items.find(x => x.user_id === item.user_id);
        return updated ? { ...item, ...updated } : item;
      });
    }
    renderAttendance();
    if (msg) msg.textContent = 'Сохранено';
    const msg2 = document.getElementById('attendance-screen-status');
    if (msg2) msg2.textContent = 'Сохранено';
  } catch (err) {
    if (msg) msg.textContent = err.message || 'Ошибка';
    const msg2 = document.getElementById('attendance-screen-status');
    if (msg2) msg2.textContent = err.message || 'Ошибка';
  }
}

async function promptAddAttendanceUser() {
  if (!attendanceState.scheduleId) return;
  const userId = window.prompt('Введите ID пользователя для добавления');
  if (!userId) return;
  const msg = document.getElementById('attendance-status-message');
  try {
    const res = await fetch(`/api/attendance/${attendanceState.scheduleId}/add-user`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        ...getAuthHeaders()
      },
      body: JSON.stringify({ user_id: userId })
    });
    if (!res.ok) {
      const err = await res.json().catch(() => null);
      throw new Error((err && err.error) || 'Не удалось добавить');
    }
    await loadAttendance(attendanceState.scheduleId);
    if (msg) msg.textContent = 'Добавлен пользователь ' + userId;
  } catch (err) {
    if (msg) msg.textContent = err.message || 'Ошибка';
  }
}

function openAttendanceScreen(item) {
  if (!item) item = window.currentScheduleItem;
  if (!item) return;
  attendanceScreenItem = item;
  const title = document.getElementById('attendance-screen-title');
  const sub = document.getElementById('attendance-screen-subtitle');
  if (title) title.textContent = item.title || 'Занятие';
  if (sub) sub.textContent = `${item.date || ''} ${item.time_from && item.time_to ? item.time_from + '–' + item.time_to : ''}`;
  const list = document.getElementById('attendance-screen-list');
  if (list) list.innerHTML = '<div class="small">Загрузка...</div>';
  showPage('attendance-screen');
  loadAttendance(item.id);
}

function openScheduleForm(dateStr, timeStr) {
  const form = document.getElementById('schedule-admin-form');
  if (!form) return;
  form.classList.add('show');

  const dateInput = document.getElementById('schedule-date');
  const timeFromInput = document.getElementById('schedule-time-from');
  const timeToInput = document.getElementById('schedule-time-to');

  if (dateInput) dateInput.value = dateStr;
  if (timeFromInput) timeFromInput.value = timeStr;
  const end = minutesToTime(timeToMinutes(timeStr) + SLOT_MINUTES);
  if (timeToInput) timeToInput.value = end;
}

function closeScheduleForm() {
  const form = document.getElementById('schedule-admin-form');
  if (form) form.classList.remove('show');
}

function createScheduleV2() {
  const objectType = document.getElementById('schedule-object-type').value;
  const objectId = document.getElementById('schedule-object-id').value;
  const dateStr = document.getElementById('schedule-date').value;
  const timeFrom = document.getElementById('schedule-time-from').value;
  const timeTo = document.getElementById('schedule-time-to').value;
  const repeatUntil = document.getElementById('schedule-repeat-until').value;

  if (!objectId || !dateStr || !timeFrom || !timeTo) {
    showNotification('⚠️ Заполните все поля');
    return;
  }

  if (hasScheduleConflict(dateStr, timeFrom, timeTo)) {
    showNotification('? В это время уже есть занятие');
    return;
  }

  const payload = {
    object_type: objectType,
    object_id: parseInt(objectId, 10),
    date: dateStr,
    time_from: timeFrom,
    time_to: timeTo,
    repeat_weekly_until: repeatUntil || null
  };

  fetch('/schedule/v2', {
    method: 'POST',
    headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
    body: JSON.stringify(payload)
  })
    .then(async res => {
      const data = await res.json();
      if (!res.ok) {
        throw new Error(data.error || 'Ошибка при создании');
      }
      showNotification('? Занятие создано');
      closeScheduleForm();
      loadScheduleV2();
    })
    .catch(err => {
      console.error(err);
      showNotification('? ' + err.message);
    });
}

function hasScheduleConflict(dateStr, timeFrom, timeTo) {
  const start = timeToMinutes(timeFrom);
  const end = timeToMinutes(timeTo);
  return scheduleItems.some(s => {
    if (s.date !== dateStr) return false;
    if (!s.time_from || !s.time_to) return false;
    const sStart = timeToMinutes(s.time_from);
    const sEnd = timeToMinutes(s.time_to);
    return start < sEnd && end > sStart && s.status !== 'cancelled';
  });
}

function initGroupScheduleForm() {
  const select = document.getElementById('group-schedule-group');
  if (!select || select.dataset.loaded === '1') return;

  select.innerHTML = '<option value="">Загрузка групп...</option>';
  fetch('/api/directions/manage', { headers: getAuthHeaders() })
    .then(async res => {
      if (!res.ok) throw new Error('Не удалось загрузить направления');
      return res.json();
    })
    .then(async directions => {
      const groups = [];
      for (const d of directions) {
        try {
          const res = await fetch(`/api/directions/${d.direction_id}/groups`, { headers: getAuthHeaders() });
          if (!res.ok) continue;
          const g = await res.json();
          g.forEach(gr => groups.push(gr));
        } catch (err) {
          // ignore
        }
      }
      if (groups.length === 0) {
        select.innerHTML = '<option value="">Группы не найдены</option>';
        return;
      }
      select.innerHTML = '<option value="">Выберите группу</option>' + groups.map(gr => `<option value="${gr.id}">${gr.name}</option>`).join('');
      select.dataset.loaded = '1';
    })
    .catch(() => {
      select.innerHTML = '<option value="">Ошибка загрузки групп</option>';
    });

  select.addEventListener('change', () => {
    updateGroupFormDefaults();
  });

  const dateInput = document.getElementById('group-schedule-date');
  if (dateInput) {
    dateInput.addEventListener('change', () => {
      updateGroupFormDefaults();
      updateRepeatSummary();
    });
  }

  const weekdayRow = document.getElementById('repeat-weekdays-row');
  if (weekdayRow) {
    weekdayRow.addEventListener('click', e => {
      const target = e.target;
      if (target.classList.contains('chip')) {
        target.classList.toggle('active');
        updateRepeatSummary();
      }
    });
  }

  const repeatMode = document.getElementById('repeat-mode');
  const repeatUntil = document.getElementById('repeat-until');
  const repeatInterval = document.getElementById('repeat-interval');
  if (repeatMode) repeatMode.addEventListener('change', updateRepeatSummary);
  if (repeatInterval) repeatInterval.addEventListener('input', updateRepeatSummary);
  if (repeatUntil) repeatUntil.addEventListener('change', updateRepeatSummary);
  updateRepeatSummary();
  updateGroupFormDefaults();
}

function toggleGroupScheduleForm(force) {
  const modal = document.getElementById('group-schedule-modal');
  const overlay = document.getElementById('group-schedule-overlay');
  if (!modal || !overlay) return;
  const shouldShow = typeof force === 'boolean' ? force : !modal.classList.contains('show');
  if (shouldShow) {
    resetGroupScheduleForm();
    modal.classList.add('show');
    overlay.classList.add('show');
  } else {
    modal.classList.remove('show');
    overlay.classList.remove('show');
  }
}

function updateRepeatSummary() {
  const mode = document.getElementById('repeat-mode')?.value || 'none';
  const interval = parseInt(document.getElementById('repeat-interval')?.value || '1', 10);
  const untilInput = document.getElementById('repeat-until');
  const until = untilInput?.value;
  const dateBase = document.getElementById('group-schedule-date')?.value;
  const summary = document.getElementById('repeat-summary');
  const weekdays = getSelectedWeekdays();

  if (!summary) return;
  if (mode === 'none') {
    summary.textContent = 'Без повторения';
    toggleRepeatControls();
    return;
  }

  let text = 'Повторять ';
  if (mode === 'weekly') {
    text += `каждую ${interval} неделю`;
    if (weekdays.length) {
      text += ` (${weekdays.map(d => WEEKDAY_LABELS[d]).join(', ')})`;
    }
  } else if (mode === 'daily') {
    text += `каждые ${interval} день`;
  } else if (mode === 'monthly') {
    text += `каждый ${interval} месяц`;
  }
  const baseDate = dateBase ? new Date(dateBase) : new Date();
  const finalUntil = until || addMonths(baseDate, 6).toISOString().slice(0, 10);
  text += ` до ${new Date(finalUntil).toLocaleDateString('ru-RU')}`;
  summary.textContent = text;
  toggleRepeatControls();
}

function toggleRepeatControls() {
  const mode = document.getElementById('repeat-mode')?.value || 'none';
  const intervalRow = document.getElementById('repeat-interval-row');
  const weekRow = document.getElementById('repeat-weekdays-row');
  const untilRow = document.getElementById('repeat-until')?.parentElement;
  const label = document.getElementById('repeat-interval-label');
  if (intervalRow) intervalRow.style.display = mode === 'none' ? 'none' : 'flex';
  if (weekRow) weekRow.style.display = mode === 'weekly' ? 'flex' : 'none';
  if (untilRow) untilRow.style.display = mode === 'none' ? 'none' : 'flex';
  if (label) {
    label.textContent = mode === 'daily' ? 'день' : mode === 'monthly' ? 'месяц' : 'неделю';
  }
}

const WEEKDAY_LABELS = {
  0: 'Вс',
  1: 'Пн',
  2: 'Вт',
  3: 'Ср',
  4: 'Чт',
  5: 'Пт',
  6: 'Сб'
};

function getSelectedWeekdays() {
  const chips = document.querySelectorAll('#repeat-weekdays-row .chip.active');
  return Array.from(chips).map(c => parseInt(c.dataset.day, 10));
}

function getWeekRangeForDate(dateStr) {
  const date = new Date(dateStr);
  if (Number.isNaN(date.getTime())) return null;
  const start = getWeekStart(date);
  const end = new Date(start.getTime() + 6 * 24 * 60 * 60 * 1000);
  return {
    dateFrom: start.toISOString().slice(0, 10),
    dateTo: end.toISOString().slice(0, 10)
  };
}

function getGroupWeekCount(groupId, dateStr) {
  const range = getWeekRangeForDate(dateStr);
  if (!range) return Promise.resolve(null);
  const params = new URLSearchParams({
    date_from: range.dateFrom,
    date_to: range.dateTo
  });
  return fetch(`/schedule/v2?${params.toString()}`, { headers: getAuthHeaders() })
    .then(res => res.ok ? res.json() : [])
    .then(items => {
      if (!Array.isArray(items)) return 0;
      return items.filter(s => s.object_type === 'group' && s.object_id === parseInt(groupId, 10) && s.status !== 'cancelled').length;
    })
    .catch(() => null);
}

function createGroupSchedule() {
  const groupId = document.getElementById('group-schedule-group')?.value;
  const dateStr = document.getElementById('group-schedule-date')?.value;
  const timeFrom = document.getElementById('group-schedule-time-from')?.value;
  const timeTo = document.getElementById('group-schedule-time-to')?.value;
  const mode = document.getElementById('repeat-mode')?.value || 'none';
  const interval = parseInt(document.getElementById('repeat-interval')?.value || '1', 10);
  const untilStrInput = document.getElementById('repeat-until')?.value;
  const untilStr = untilStrInput || addMonths(new Date(dateStr), 6).toISOString().slice(0, 10);

  if (!groupId || !dateStr || !timeFrom || !timeTo) {
    showNotification('⚠️ Заполните все поля');
    return;
  }

  if (hasScheduleConflict(dateStr, timeFrom, timeTo)) {
    showNotification('? В это время уже есть занятие');
    return;
  }

  const dates = buildRepeatDates(dateStr, mode, interval, untilStr);
  if (!dates.length) {
    showNotification('⚠️ Не удалось построить даты');
    return;
  }

  const dateFrom = dates[0];
  const dateTo = dates[dates.length - 1];

  const params = new URLSearchParams({
    date_from: dateFrom,
    date_to: dateTo
  });

  fetch(`/schedule/v2?${params.toString()}`, { headers: getAuthHeaders() })
    .then(async res => {
      if (!res.ok) throw new Error('Ошибка проверки конфликтов');
      return res.json();
    })
    .then(data => {
      scheduleItems = Array.isArray(data) ? data : [];
      const conflict = dates.some(d => hasScheduleConflict(d, timeFrom, timeTo));
      if (conflict) {
        showNotification('? В выбранные даты уже есть занятия');
        return;
      }
      createGroupScheduleEntries(groupId, dates, timeFrom, timeTo);
    })
    .catch(err => {
      console.error(err);
      showNotification('? Ошибка проверки конфликтов');
    });
}

function updateGroupFormDefaults() {
  const groupId = document.getElementById('group-schedule-group')?.value;
  const dateStr = document.getElementById('group-schedule-date')?.value;
  const preview = document.getElementById('group-schedule-preview');
  if (!groupId) {
    if (preview) {
      preview.style.display = 'none';
      preview.innerHTML = '';
    }
    return;
  }
  fetch(`/api/groups/${groupId}`, { headers: getAuthHeaders() })
    .then(async res => {
      if (!res.ok) throw new Error('Не удалось загрузить группу');
      return res.json();
    })
    .then(group => {
      const timeFromInput = document.getElementById('group-schedule-time-from');
      const timeToInput = document.getElementById('group-schedule-time-to');
      if (timeFromInput && timeToInput && (!timeFromInput.value || !timeToInput.value)) {
        const base = group.duration_minutes || 60;
        const from = timeFromInput.value || '09:00';
        const endMinutes = timeToMinutes(from) + base;
        timeFromInput.value = from;
        timeToInput.value = minutesToTime(endMinutes);
      }

      if (preview) {
        preview.style.display = 'grid';
        const lessonsRow = group.lessons_per_week
          ? `<div class="schedule-detail-row">📆 <strong>Занятий в неделю:</strong> ${group.lessons_per_week}${dateStr ? ' (в этой неделе: <span id="group-week-count">…</span>)' : ''}</div>`
          : '';
        preview.innerHTML = `
          <div class="schedule-detail-row">👥 <strong>Группа:</strong> ${group.name || '—'}</div>
          <div class="schedule-detail-row">🎈 <strong>Возраст:</strong> ${group.age_group || '—'}</div>
          ${lessonsRow}
          <div class="schedule-detail-row">⏱️ <strong>Длительность:</strong> ${group.duration_minutes ? group.duration_minutes + ' мин' : '—'}</div>
        `;
        if (group.teacher_name) {
          preview.innerHTML += `<div class="schedule-detail-row">👩‍🏫 <strong>Учитель:</strong> ${group.teacher_name}</div>`;
        }
        preview.innerHTML += `<div class="schedule-detail-row">🎯 <strong>Направление:</strong> —</div>`;
        preview.innerHTML += `<div class="schedule-detail-row">💰 <strong>Цена:</strong> —</div>`;
      }

      if (group.lessons_per_week && dateStr) {
        getGroupWeekCount(groupId, dateStr).then(count => {
          const countEl = document.getElementById('group-week-count');
          if (countEl) countEl.textContent = count === null ? '—' : String(count);
        });
      }

      if (group.direction_id && preview) {
        fetch(`/api/directions/${group.direction_id}`, { headers: getAuthHeaders() })
          .then(async res => {
            if (!res.ok) throw new Error('Не удалось загрузить направление');
            return res.json();
          })
          .then(direction => {
            const rows = preview.querySelectorAll('.schedule-detail-row');
            if (rows.length >= 2) {
              rows[rows.length - 2].innerHTML = `🎯 <strong>Направление:</strong> ${direction.title || '—'}`;
              rows[rows.length - 1].innerHTML = `💰 <strong>Цена:</strong> ${direction.base_price ? direction.base_price + ' ?' : '—'}`;
            }
          })
          .catch(() => {});
      }
    })
    .catch(() => {
      // ignore
    });
}

function resetGroupScheduleForm() {
  const groupSelect = document.getElementById('group-schedule-group');
  const dateInput = document.getElementById('group-schedule-date');
  const timeFromInput = document.getElementById('group-schedule-time-from');
  const timeToInput = document.getElementById('group-schedule-time-to');
  const repeatUntil = document.getElementById('repeat-until');
  const repeatInterval = document.getElementById('repeat-interval');
  const repeatMode = document.getElementById('repeat-mode');

  if (groupSelect) groupSelect.value = '';
  if (dateInput) dateInput.value = '';
  if (timeFromInput) timeFromInput.value = '';
  if (timeToInput) timeToInput.value = '';
  if (repeatInterval) repeatInterval.value = '1';
  if (repeatMode) repeatMode.value = 'weekly';
  if (repeatUntil) repeatUntil.value = '';

  const chips = document.querySelectorAll('#repeat-weekdays-row .chip');
  chips.forEach(c => c.classList.remove('active'));

  updateRepeatSummary();
}

function createGroupScheduleEntries(groupId, dates, timeFrom, timeTo) {
  const headers = getAuthHeaders({ 'Content-Type': 'application/json' });
  const requests = dates.map(d => () => fetch('/schedule/v2', {
    method: 'POST',
    headers,
    body: JSON.stringify({
      object_type: 'group',
      object_id: parseInt(groupId, 10),
      date: d,
      time_from: timeFrom,
      time_to: timeTo
    })
  }));

  let chain = Promise.resolve();
  requests.forEach(req => {
    chain = chain.then(() => req());
  });

  chain
    .then(() => {
      showNotification('? Занятия созданы');
      toggleGroupScheduleForm(false);
      loadScheduleV2();
    })
    .catch(err => {
      console.error(err);
      showNotification('? Ошибка создания');
    });
}

function buildRepeatDates(startDateStr, mode, interval, untilStr) {
  const start = new Date(startDateStr);
  if (Number.isNaN(start.getTime())) return [];
  const until = untilStr ? new Date(untilStr) : addMonths(start, 6);
  if (untilStr && Number.isNaN(until.getTime())) return [];

  const dates = [];
  if (mode === 'none') {
    dates.push(startDateStr);
    return dates;
  }

  if (!until) {
    dates.push(startDateStr);
    return dates;
  }

  if (mode === 'daily') {
    let current = new Date(start);
    while (current <= until) {
      dates.push(current.toISOString().slice(0, 10));
      current.setDate(current.getDate() + interval);
    }
    return dates;
  }

  if (mode === 'monthly') {
    let current = new Date(start);
    while (current <= until) {
      dates.push(current.toISOString().slice(0, 10));
      current.setMonth(current.getMonth() + interval);
    }
    return dates;
  }

  const weekdays = getSelectedWeekdays();
  const targetWeekdays = weekdays.length ? weekdays : [start.getDay()];
  let current = new Date(start);
  while (current <= until) {
    const weekStart = new Date(current);
    const day = weekStart.getDay();
    weekStart.setDate(weekStart.getDate() - day);
    for (let i = 0; i < 7; i++) {
      const d = new Date(weekStart);
      d.setDate(weekStart.getDate() + i);
      if (d < start || d > until) continue;
      if (targetWeekdays.includes(d.getDay())) {
        dates.push(d.toISOString().slice(0, 10));
      }
    }
    current.setDate(current.getDate() + interval * 7);
  }
  return Array.from(new Set(dates)).sort();
}

function addMonths(date, count) {
  const d = new Date(date);
  d.setMonth(d.getMonth() + count);
  return d;
}

function goHome() {
  showPage('home');
}

function goBack() {
  if (tryHandleModalBack()) {
    return;
  }
  // Если в стеке есть хотя бы одна страница, берем последнюю
  if (navigationStack.length > 1) {
    navigationStack.pop(); // Удаляем текущую страницу из стека
    const previousPageId = navigationStack[navigationStack.length - 1];
    
    // Переходим на предыдущую страницу без добавления в стек
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(previousPageId).classList.add('active');
    
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    const index = ROOT_PAGES.indexOf(previousPageId);
    if (index >= 0) document.querySelectorAll('.nav-btn')[index].classList.add('active');
    
    applyHeaderForPage(previousPageId);
  } else {
    // Если стек пуст, идем домой
    showPage('home');
  }
}

/* ====== УПРАВЛЕНИЕ РАСПИСАНИЕМ ПЕРСОНАЛА ====== */
let currentStaffPosition = '';
const STAFF_CACHE_KEY = 'staff_status_cache_v1';

function getCachedStaffStatus() {
  try {
    const raw = localStorage.getItem(STAFF_CACHE_KEY);
    if (!raw) return null;
    const parsed = JSON.parse(raw);
    if (typeof parsed !== 'object' || parsed === null) return null;
    if (typeof parsed.isStaff !== 'boolean') return null;
    return parsed;
  } catch (err) {
    return null;
  }
}

function setCachedStaffStatus(isStaffValue, positionValue) {
  try {
    const payload = {
      isStaff: Boolean(isStaffValue),
      position: positionValue || '',
      updatedAt: Date.now()
    };
    localStorage.setItem(STAFF_CACHE_KEY, JSON.stringify(payload));
  } catch (err) {
    // ignore cache write errors
  }
}
let currentScheduleId = null;



async function loadStaffList() {
  try {
    // Определяем контейнер в зависимости от текущей страницы
    const currentPage = Array.from(document.querySelectorAll('.page')).find(p => p.classList.contains('active'));
    const containerId = (currentPage && currentPage.id === 'staff-manage') 
      ? 'staff-manage-container' 
      : 'staff-list-container';
    
    const container = document.getElementById(containerId);
    if (!container) return;
    
    container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">⏳ Загрузка...</p>';
    
    const response = await fetch('/staff/list/all');
    
    if (!response.ok) {
      container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">❌ Ошибка при загрузке</p>';
      return;
    }
    
    const staffList = await response.json();
    window.allStaffList = staffList; // Сохраняем для поиска
    
    if (staffList.length === 0) {
      container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">📭 Персонал не найден</p>';
      return;
    }
    
    displayStaffList(staffList);
  } catch (error) {
    console.error('Ошибка при загрузке персонала:', error);
    const currentPage = Array.from(document.querySelectorAll('.page')).find(p => p.classList.contains('active'));
    const containerId = (currentPage && currentPage.id === 'staff-manage') 
      ? 'staff-manage-container' 
      : 'staff-list-container';
    const container = document.getElementById(containerId);
    if (container) {
      container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">❌ Ошибка сети</p>';
    }
  }
}

function getStaffInitials(name) {
  const safe = (name || '').trim();
  if (!safe) return '?';
  const parts = safe.split(/\s+/).filter(Boolean);
  const first = parts[0] ? parts[0][0] : '';
  const second = parts.length > 1 ? parts[1][0] : (parts[0] && parts[0][1] ? parts[0][1] : '');
  return (first + second).toUpperCase();
}

function getStaffAvatarColor(name) {
  const colors = ['#fe5815', '#ff7a30', '#ff9d4a', '#ffb86c', '#ff7043', '#ff8f00', '#ffa726', '#f4511e'];
  const safe = (name || '').trim();
  if (!safe) return '#9e9e9e';
  let hash = 0;
  for (let i = 0; i < safe.length; i++) {
    hash = (hash * 31 + safe.charCodeAt(i)) >>> 0;
  }
  return colors[hash % colors.length];
}

function openStaffDetailCard(staffId) {
  const list = Array.isArray(window.allStaffList) ? window.allStaffList : [];
  const staff = list.find(item => Number(item.id) === Number(staffId));
  if (!staff) {
    showNotification('Сотрудник не найден');
    return;
  }

  openStaffDetail(
    staff.id,
    staff.name || '—',
    staff.position || '—',
    staff.phone || '',
    staff.email || '',
    staff.specialization || '',
    staff.bio || '',
    staff.status || ''
  );
}

function displayStaffList(staffList) {
  // Определяем правильный контейнер в зависимости от текущей страницы
  const currentPage = Array.from(document.querySelectorAll('.page')).find(p => p.classList.contains('active'));
  const containerId = (currentPage && currentPage.id === 'staff-manage') 
    ? 'staff-manage-container' 
    : 'staff-list-container';
  
  const container = document.getElementById(containerId);
  if (!container) return;
  
  container.innerHTML = staffList.map(s => {
    const photoUrl = s.photo ? buildMediaUrl(s.photo) : null;
    const initials = getStaffInitials(s.name);
    const avatarBg = getStaffAvatarColor(s.name);
    const safeName = escapeHtml(String(s.name || 'Без имени'));
    const safeRole = escapeHtml(String(s.position || 'Без роли'));
    const username = s.username ? `@${s.username}` : '—';
    const phoneText = s.phone ? String(s.phone) : '—';
    const safeUsername = escapeHtml(username);
    const safePhone = escapeHtml(phoneText);
    const teaches = (s.teaches === true || s.teaches === 1 || s.teaches === '1');
    const teachesClass = teaches ? 'is-true' : 'is-false';
    const teachesLabel = '👩‍🏫 Учитель';
    const safePhotoUrl = photoUrl ? escapeHtml(photoUrl) : '';
    const safeStaffId = Number.isFinite(Number(s.id)) ? Number(s.id) : 0;
    return `
    <div class="client-card staff-client-card" onclick="openStaffDetailCard(${safeStaffId})">
      <div class="staff-card-row">
        <div class="staff-card-avatar" style="background: ${photoUrl ? '#262626' : avatarBg};">
          ${photoUrl ? `<img src="${safePhotoUrl}" alt=""/>` : `<span>${escapeHtml(initials)}</span>`}
        </div>
        <div class="staff-card-main">
          <div class="staff-card-title">
            <div class="staff-card-name">${safeName}</div>
            <div class="client-card-status staff-role-chip">${safeRole}</div>
          </div>
          <div class="staff-user-line">${safeUsername}</div>
          <div class="staff-meta-row">
            <div class="staff-phone-line">${safePhone}</div>
            <div class="staff-teaches-chip ${teachesClass}">${teachesLabel}</div>
          </div>
        </div>
      </div>
    </div>
  `;
  }).join('');
}

function searchStaffManage() {
  const searchInput = document.getElementById('staff-manage-search');
  const search = searchInput.value.trim().toLowerCase();
  
  if (!window.allStaffList) {
    return;
  }
  
  if (search.length === 0) {
    displayStaffList(window.allStaffList);
    return;
  }
  
  let filtered = [];
  
  // Проверяем, ищет ли пользователь по юзернейму (с @)
  if (search.startsWith('@')) {
    // Поиск по юзернейму
    const usernameQuery = search.substring(1).toLowerCase();
    filtered = window.allStaffList.filter(s => 
      s.username && s.username.toLowerCase().includes(usernameQuery)
    );
  } else {
    // Поиск по ID или имени
    filtered = window.allStaffList.filter(s => 
      s.name.toLowerCase().includes(search) ||
      s.id.toString().includes(search)
    );
  }
  
  if (filtered.length === 0) {
    document.getElementById('staff-manage-container').innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">📭 Персонал не найден</p>';
  } else {
    displayStaffList(filtered);
  }
}

// Хранилище для выбранного пользователя и текущего персонала
window.selectedStaffUserData = null;
window.currentStaffTelegramIds = []; // Список telegram_id текущего персонала

function showAddStaffForm() {
  // Очищаем поле поиска и форму
  document.getElementById('staff-user-search').value = '';
  document.getElementById('staff-add-position').value = '';
  document.getElementById('staff-add-specialization').value = '';
  document.getElementById('staff-add-bio').value = '';
  const notifyCheckbox = document.getElementById('staff-add-notify');
  if (notifyCheckbox) {
    notifyCheckbox.checked = true;
  }
  const teachesCheckbox = document.getElementById('staff-add-teaches');
  if (teachesCheckbox) {
    teachesCheckbox.checked = false;
    teachesCheckbox.disabled = false;
  }
  updateStaffTeachesToggle();
  
  // Загружаем текущий персонал и всех пользователей при открытии формы
  loadCurrentStaffAndUsers();
  
  showPage('staff-add-form');
  setHeaderTitle('? Добавить персонал');
}

function updateStaffTeachesToggle() {
  const positionSelect = document.getElementById('staff-add-position');
  const teachesCheckbox = document.getElementById('staff-add-teaches');
  if (!positionSelect || !teachesCheckbox) return;

  const position = (positionSelect.value || '').toLowerCase();
  const isTeacher = position === 'учитель';
  teachesCheckbox.checked = isTeacher ? true : teachesCheckbox.checked;
  teachesCheckbox.disabled = isTeacher;
}

async function loadCurrentStaffAndUsers() {
  try {
    // Получаем текущий персонал
    const staffResponse = await fetch('/staff/list/all');
    if (staffResponse.ok) {
      const staffList = await staffResponse.json();
      window.currentStaffTelegramIds = staffList.map(s => s.telegram_id);
    }
    
    // Загружаем всех пользователей
    const response = await fetch('/staff/search');
    if (!response.ok) return;
    
    const users = await response.json();
    // Фильтруем - исключаем уже добавленный персонал
    const filteredUsers = users.filter(u => !window.currentStaffTelegramIds.includes(u.telegram_id));
    displaySearchResults(filteredUsers);
  } catch (error) {
    console.error('Ошибка при загрузке пользователей:', error);
  }
}

async function loadAllStaffUsers() {
  try {
    const response = await fetch('/staff/search');
    if (!response.ok) return;
    
    const users = await response.json();
    // Фильтруем - исключаем уже добавленный персонал
    const filteredUsers = users.filter(u => !window.currentStaffTelegramIds.includes(u.telegram_id));
    displaySearchResults(filteredUsers);
  } catch (error) {
    console.error('Ошибка при загрузке пользователей:', error);
  }
}

async function searchForStaffUser() {
  let search = document.getElementById('staff-user-search').value.trim().toLowerCase();
  
  try {
    // Определяем тип поиска
    const searchByUsername = search.startsWith('@');
    
    // Удаляем @ для отправки на сервер
    const cleanSearch = search.replace(/^@/, '');
    
    console.log('Поиск:', {search, searchByUsername, cleanSearch});
    
    // Формируем параметры запроса
    const params = new URLSearchParams();
    if (cleanSearch) {
      params.append('q', cleanSearch);
      if (searchByUsername) {
        params.append('by_username', 'true');
      }
    }
    
    console.log('Запрос к:', `/staff/search?${params.toString()}`);
    
    const response = await fetch(`/staff/search?${params.toString()}`);
    
    if (!response.ok) {
      document.getElementById('staff-user-search-results').innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 16px 0;">❌ Ошибка при загрузке</p>';
      return;
    }
    
    const users = await response.json();
    // Фильтруем - исключаем уже добавленный персонал
    const filteredUsers = users.filter(u => !window.currentStaffTelegramIds.includes(u.telegram_id));
    
    // Если поле поиска пусто, показываем всех пользователей
    if (!cleanSearch) {
      if (filteredUsers.length === 0) {
        document.getElementById('staff-user-search-results').innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 16px 0;">📭 Нет пользователей</p>';
        return;
      }
    } else {
      if (filteredUsers.length === 0) {
        document.getElementById('staff-user-search-results').innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 16px 0;">📭 Персонал не найден</p>';
        return;
      }
    }
    
    displaySearchResults(filteredUsers);
  } catch (error) {
    console.error('Ошибка при поиске персонала:', error);
    document.getElementById('staff-user-search-results').innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 16px 0;">❌ Ошибка сети</p>';
  }
}

function displaySearchResults(users) {
  const resultsHtml = users.map(u => {
    const safeName = u.name.replace(/'/g, "\\'").replace(/"/g, '\\"');
    const safePhone = (u.phone || '').replace(/'/g, "\\'").replace(/"/g, '\\"');
    const safeEmail = (u.email || '').replace(/'/g, "\\'").replace(/"/g, '\\"');
    const isSelected = window.selectedStaffUserData && window.selectedStaffUserData.id === u.id;
    const borderColor = isSelected ? 'var(--accent)' : 'var(--border)';
    const bgColor = isSelected ? 'var(--accent-soft)' : 'var(--card)';
    
    return `
      <div class="card" id="user-card-${u.id}" style="margin-bottom: 8px; cursor: pointer; background: ${bgColor}; border-left: 4px solid ${borderColor}; transition: all 0.2s;" onclick="selectStaffUser(${u.id}, '${safeName}', ${u.telegram_id}, '${safePhone}', '${safeEmail}')">
        <div style="font-weight: 600; font-size: 14px;">
          ${u.name}
          ${window.selectedStaffUserData && window.selectedStaffUserData.id === u.id ? ' ?' : ''}
        </div>
        <div style="font-size: 12px; color: var(--hint); margin-top: 2px;">ID: ${u.id}${u.telegram_id ? ` • TG: ${u.telegram_id}` : ''}${u.username ? ` • @${u.username}` : ''}</div>
        ${u.phone ? `<div style="font-size: 12px; color: var(--hint);">📱 ${u.phone}</div>` : ''}
      </div>
    `;
  }).join('');
  
  document.getElementById('staff-user-search-results').innerHTML = resultsHtml;
}

function selectStaffUser(id, name, telegramId, phone, email) {
  window.selectedStaffUserData = {
    id,
    name,
    telegram_id: telegramId,
    phone,
    email
  };
  
  // Обновляем стили всех карточек
  const allCards = document.querySelectorAll('[id^="user-card-"]');
  allCards.forEach(card => {
    if (card.id === `user-card-${id}`) {
      card.style.background = 'var(--accent-soft)';
      card.style.borderLeftColor = 'var(--accent)';
      const titleDiv = card.querySelector('div');
      if (!titleDiv.textContent.includes('✅')) {
        titleDiv.textContent += ' ✅';
      }
    } else {
      card.style.background = 'var(--card)';
      card.style.borderLeftColor = 'var(--border)';
      const titleDiv = card.querySelector('div');
      titleDiv.textContent = titleDiv.textContent.replace(' ✅', '');
    }
  });
}

async function saveNewStaff() {
  // Проверяем, выбран ли пользователь
  if (!window.selectedStaffUserData) {
    showNotification('⚠️ Выберите пользователя из списка');
    return;
  }
  
  const position = document.getElementById('staff-add-position').value;
  const specialization = document.getElementById('staff-add-specialization').value.trim();
  const bio = document.getElementById('staff-add-bio').value.trim();
  const teaches = document.getElementById('staff-add-teaches')?.checked;
  const notify = document.getElementById('staff-add-notify')?.checked;
  
  // Проверяем обязательные поля
  if (!position) {
    showNotification('⚠️ Выберите должность');
    return;
  }
  
  try {
    const payload = {
      name: window.selectedStaffUserData.name,
      telegram_id: window.selectedStaffUserData.telegram_id,
      position,
      specialization: specialization || undefined,
      bio: bio || undefined,
      teaches: teaches ? 1 : 0,
      notify: notify ? 1 : 0
    };
    
    const response = await fetch('/staff', {
      method: 'POST',
      headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
      body: JSON.stringify(payload)
    });
    
    if (response.ok) {
      showNotification('? Персонал добавлен');
      setTimeout(() => {
        // Очищаем выбор
        window.selectedStaffUserData = null;
        goBack();
        loadStaffList();
      }, 500);
    } else {
      const error = await response.json();
      showNotification('? Ошибка: ' + (error.error || 'неизвестная ошибка'));
    }
  } catch (error) {
    console.error('Ошибка при добавлении персонала:', error);
    showNotification('❌ Ошибка сети');
  }
}

let pendingDeleteStaffId = null;
let pendingDeleteStaffName = '';

function openStaffDeleteModal(staffId, name) {
  pendingDeleteStaffId = staffId;
  pendingDeleteStaffName = name || '';
  const overlay = document.getElementById('staff-delete-overlay');
  const modal = document.getElementById('staff-delete-modal');
  const subtitle = document.getElementById('staff-delete-subtitle');
  const notifyCheckbox = document.getElementById('staff-delete-notify');
  if (subtitle) {
    subtitle.textContent = pendingDeleteStaffName ? `Персонал: ${pendingDeleteStaffName}` : '—';
  }
  if (notifyCheckbox) {
    notifyCheckbox.checked = true;
  }
  if (overlay) overlay.classList.add('show');
  if (modal) modal.classList.add('show');
}

function closeStaffDeleteModal() {
  const overlay = document.getElementById('staff-delete-overlay');
  const modal = document.getElementById('staff-delete-modal');
  if (overlay) overlay.classList.remove('show');
  if (modal) modal.classList.remove('show');
  pendingDeleteStaffId = null;
  pendingDeleteStaffName = '';
}

async function confirmStaffDelete() {
  if (!pendingDeleteStaffId) return;
  const notifyCheckbox = document.getElementById('staff-delete-notify');
  const notify = notifyCheckbox ? notifyCheckbox.checked : true;
  const staffId = pendingDeleteStaffId;
  const shouldGoBack = (currentDetailStaffId && currentDetailStaffId === staffId);
  closeStaffDeleteModal();

  try {
    const response = await fetch(`/staff/${staffId}?notify=${notify ? 1 : 0}`, {
      method: 'DELETE',
      headers: getAuthHeaders()
    });
    
    if (response.ok) {
      showNotification('? Персонал удален');
      if (shouldGoBack && document.getElementById('staff-detail')?.classList.contains('active')) {
        goBack();
      }
      loadStaffList();
    } else {
      showNotification('? Ошибка при удалении');
    }
  } catch (error) {
    console.error('Ошибка при удалении:', error);
    showNotification('❌ Ошибка сети');
  }
}

function deleteStaffMember(staffId, name) {
  openStaffDeleteModal(staffId, name);
}

let currentDetailStaffId = null;

function openStaffDetail(id, name, position, phone, email, specialization, bio, status) {
  currentDetailStaffId = id;
  
  const phoneValue = (phone === 'null' || phone === 'undefined') ? '' : phone;

  document.getElementById('staff-detail-name').innerText = name;
  document.getElementById('staff-detail-position').innerText = position;
  document.getElementById('staff-detail-position-full').innerText = position;
  const phoneBlock = document.getElementById('staff-detail-phone-block');
  if (phoneValue) {
    document.getElementById('staff-detail-phone').innerText = phoneValue;
    phoneBlock.style.display = 'block';
  } else {
    document.getElementById('staff-detail-phone').innerText = '—';
    phoneBlock.style.display = 'none';
  }
  document.getElementById('staff-detail-specialization').innerText = specialization || '—';
  document.getElementById('staff-detail-bio').innerText = bio || '—';
  
  showPage('staff-detail');
  setHeaderTitle(name);

  // Обновляем аватар (staff -> user -> telegram)
  updateStaffDetailAvatar(null, null);
  fetch(`/staff/${id}`)
    .then(async r => {
      const data = await r.json();
      if (!r.ok) throw new Error(data.error || 'Не удалось загрузить профиль');
      return data;
    })
    .then(staff => {
      updateStaffDetailAvatar(staff.photo_path, staff.telegram_id);
    })
    .catch(() => {
      // если не получилось - оставляем плейсхолдер
    });
}

function buildMediaUrl(photoPath) {
  if (!photoPath) return null;
  let normalized = String(photoPath).replace(/\\/g, '/');
  if (/^https?:\/\//i.test(normalized)) return normalized;
  while (normalized.startsWith('../')) {
    normalized = normalized.slice(3);
  }
  if (normalized.startsWith('./')) {
    normalized = normalized.slice(2);
  }
  if (normalized.startsWith('/media/')) return normalized;
  if (normalized.startsWith('media/')) return `/${normalized}`;
  if (normalized.startsWith('/var/media/')) return `/media/${normalized.slice('/var/media/'.length)}`;
  if (normalized.startsWith('var/media/')) return `/media/${normalized.slice('var/media/'.length)}`;
  if (normalized.startsWith('/database/')) return normalized;
  if (normalized.startsWith('database/')) return `/${normalized}`;
  return `/media/${normalized.replace(/^\/+/, '')}`;
}

function updateStaffDetailAvatar(photoPath, telegramId) {
  const img = document.getElementById('staff-detail-avatar-img');
  const placeholder = document.querySelector('#staff-detail-avatar p');
  if (!img || !placeholder) return;

  if (photoPath) {
    const mediaUrl = buildMediaUrl(photoPath);
    if (mediaUrl) img.src = mediaUrl;
    img.style.display = 'block';
    placeholder.style.display = 'none';
    return;
  }

  const tgUser = tg?.initDataUnsafe?.user;
  if (tgUser && telegramId && tgUser.id === telegramId && tgUser.photo_url) {
    img.src = tgUser.photo_url;
    img.style.display = 'block';
    placeholder.style.display = 'none';
    return;
  }

  img.style.display = 'none';
  img.src = '';
  placeholder.style.display = 'flex';
}

async function deleteCurrentStaff() {
  if (!currentDetailStaffId) return;
  const name = document.getElementById('staff-detail-name')?.innerText || '';
  openStaffDeleteModal(currentDetailStaffId, name);
}

async function loadStaffSchedule() {
  try {
    const container = document.getElementById('staff-schedule-container');
    container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">⏳ Загрузка...</p>';
    
    const response = await fetch('/schedule');
    
    if (!response.ok) {
      container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">❌ Ошибка при загрузке расписания</p>';
      return;
    }
    
    let schedules = await response.json();
    
    // Фильтруем расписание в зависимости от должности
    if (currentStaffPosition === 'учитель') {
      // Учитель видит только свои занятия
      schedules = schedules.filter(s => s.teacher === currentUserData.name);
    }
    // Модератор и выше видят все занятия
    
    if (schedules.length === 0) {
      container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">📭 Занятий нет</p>';
      return;
    }
    
    displayStaffSchedules(schedules);
  } catch (error) {
    console.error('Ошибка при загрузке расписания:', error);
    document.getElementById('staff-schedule-container').innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">❌ Ошибка сети</p>';
  }
}

// Личное расписание преподавателя
async function loadPersonalSchedule() {
  const container = document.getElementById('personal-schedule-container');
  if (!container) return;
  personalScheduleRefreshLoading = true;
  updatePersonalScheduleRefreshCapsule();
  container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">⏳ Загрузка...</p>';
  initPersonalIndividualBookingPanel();

  // Дождёмся загрузки профиля, чтобы знать telegram_id/имя
  if (profileLoadedPromise) {
    try { await profileLoadedPromise; } catch (_) {}
  } else if (!currentUserData && user?.id) {
    try { await loadProfileData(); } catch (_) {}
  }

  // Убеждаемся, что знаем staff.id текущего пользователя
  if (!window.currentStaffProfileId && currentUserData?.telegram_id) {
    try {
      const staffRes = await fetch(`/staff/check/${currentUserData.telegram_id}`);
      if (staffRes.ok) {
        const staffData = await staffRes.json();
        if (staffData?.staff?.id) {
          window.currentStaffProfileId = staffData.staff.id;
          window.currentStaffProfileName = staffData.staff.name || window.currentStaffProfileName;
        }
      }
    } catch (_) {
      // тихо игнорируем, дальше будет фильтрация по имени
    }
  }

  const normalize = (v) => (v || '').toString().trim().toLowerCase();
  const myStaffId = window.currentStaffProfileId;
  const myName = normalize(window.currentStaffProfileName || currentUserData?.name);

  try {
    const headers = getAuthHeaders ? getAuthHeaders() : {};

    // 1) базовое расписание
    let schedules = [];
    try {
      const response = await fetch('/schedule', { headers });
      if (response.ok) {
        schedules = await response.json();
      }
    } catch (_) { /* ignore */ }

    // 2) публичное расписание (может содержать учителя в полях teacher_id/teacher_name)
    try {
      const pubRes = await fetch('/schedule/public', { headers });
      if (pubRes.ok) {
        const pub = await pubRes.json();
        if (Array.isArray(pub)) {
          schedules = schedules.concat(pub);
        }
      }
    } catch (_) { /* ignore */ }

    // 3) если есть staffId — пробуем v2 с фильтром teacher_id (может дать 403 для простого учителя)
    if (myStaffId) {
      try {
        const v2res = await fetch(`/schedule/v2?teacher_id=${myStaffId}`, { headers });
        if (v2res.ok) {
          const v2 = await v2res.json();
          if (Array.isArray(v2)) schedules = schedules.concat(v2);
        }
      } catch (_) { /* ignore */ }
    }

    // Фильтрация по преподавателю
    schedules = schedules.filter(s => {
      const schedTeacherId = s.teacher_id ?? s.teacher?.id ?? s.teacherId;
      const schedTeacherName = normalize(s.teacher?.name || s.teacher || s.teacher_name || s.teacherName);

      if (myStaffId && schedTeacherId != null) {
        return Number(schedTeacherId) === Number(myStaffId);
      }

      if (myName && schedTeacherName) {
        return (
          schedTeacherName === myName ||
          schedTeacherName.includes(myName) ||
          myName.includes(schedTeacherName)
        );
      }

      return false;
    });

    // Дедупликация: один и тот же слот может прийти из нескольких источников (/schedule, /schedule/public, /schedule/v2)
    const scheduleScore = (item) => {
      let score = 0;
      if (item && (item.object_type || item.objectType)) score += 3;
      if (item && (item.time_from || item.start || item.start_time)) score += 2;
      if (item && (item.time_to || item.end || item.end_time)) score += 2;
      if (item && (item.teacher_id ?? item.teacher?.id ?? item.teacherId) != null) score += 1;
      if (item && (item.title || item.direction_title || item.direction)) score += 1;
      return score;
    };

    const scheduleMap = new Map();
    schedules.forEach((item) => {
      const parsedId = Number(item?.id);
      const dateKey = String(item?.date || item?.date_from || '').slice(0, 10);
      const startKey = item?.time_from || item?.start || item?.start_time || '';
      const endKey = item?.time_to || item?.end || item?.end_time || '';
      const typeKey = (item?.object_type || '').toString().toLowerCase();
      const objectIdKey = item?.object_id ?? '';
      const teacherKey = item?.teacher_id ?? item?.teacher?.id ?? item?.teacherId ?? '';
      const dedupeKey = (Number.isFinite(parsedId) && parsedId > 0)
        ? `id:${parsedId}`
        : `k:${dateKey}|${startKey}|${endKey}|${typeKey}|${objectIdKey}|${teacherKey}`;

      const existing = scheduleMap.get(dedupeKey);
      if (!existing) {
        scheduleMap.set(dedupeKey, item);
        return;
      }

      const existingScore = scheduleScore(existing);
      const currentScore = scheduleScore(item);
      if (currentScore >= existingScore) {
        scheduleMap.set(dedupeKey, { ...existing, ...item });
      } else {
        scheduleMap.set(dedupeKey, { ...item, ...existing });
      }
    });

    personalScheduleItems = Array.from(scheduleMap.values());
    if (!personalScheduleDate) {
      const today = new Date();
      personalScheduleDate = formatDateLocal(today);
    }
    if (!personalScheduleMonthDate) {
      const d = new Date(personalScheduleDate + 'T00:00:00');
      personalScheduleMonthDate = new Date(d.getFullYear(), d.getMonth(), 1);
    }
    initPersonalScheduleStrip();
    renderPersonalScheduleList();
    personalScheduleRefreshLoading = false;
    updatePersonalScheduleRefreshCapsule();

  } catch (err) {
    container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">❌ Ошибка загрузки</p>';
    initPersonalIndividualBookingPanel();
    personalScheduleRefreshLoading = false;
    updatePersonalScheduleRefreshCapsule();
  }
}

function displayStaffSchedules(schedules) {
  const container = document.getElementById('staff-schedule-container');
  
  container.innerHTML = schedules.map(s => `
    <div class="card" onclick="editSchedule(${s.id}, '${s.title}', ${s.teacher_id}, '${s.teacher.name}', '${s.date}', '${s.start}', '${s.end}')">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <div style="font-weight: 600; font-size: 15px;">${s.title}</div>
          <div style="font-size: 13px; color: var(--hint); margin-top: 4px;">📅 ${new Date(s.date).toLocaleDateString('ru-RU')}</div>
          <div style="font-size: 13px; color: var(--hint);">🕐 ${s.start} - ${s.end}</div>
          <div style="font-size: 13px; color: var(--hint);">👩‍🏫 ${s.teacher.name}</div>
        </div>
        <div style="font-size: 24px;">></div>
      </div>
    </div>
  `).join('');
}

function setPublicScheduleType(type) {
  window.publicScheduleType = type === 'mine' ? 'mine' : 'all';
  updatePublicTypeTabs();
  loadPublicSchedule(true);
}

function updatePublicTypeTabs() {
  document.querySelectorAll('.public-type-tab').forEach(el => {
    const t = el.dataset.type || 'all';
    el.classList.toggle('active', t === (window.publicScheduleType || 'all'));
  });
}

function formatDateLocal(dateObj) {
  const y = dateObj.getFullYear();
  const m = String(dateObj.getMonth() + 1).padStart(2, '0');
  const d = String(dateObj.getDate()).padStart(2, '0');
  return `${y}-${m}-${d}`;
}

function renderPersonalScheduleList() {
  const container = document.getElementById('personal-schedule-container');
  if (!container) return;
  container.className = '';
  const items = Array.isArray(personalScheduleItems) ? personalScheduleItems : [];
  if (!personalScheduleDate) {
    const today = new Date();
    personalScheduleDate = formatDateLocal(today);
  }

  const selectedDateObj = new Date(personalScheduleDate + 'T00:00:00');
  const monthDate = personalScheduleMonthDate
    ? new Date(personalScheduleMonthDate)
    : new Date(selectedDateObj.getFullYear(), selectedDateObj.getMonth(), 1);
  const monthStart = new Date(monthDate.getFullYear(), monthDate.getMonth(), 1);
  const headers = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'];

  const byDay = {};
  items.forEach((s) => {
    const date = s.date || s.date_from || null;
    if (!date) return;
    const key = String(date).slice(0, 10);
    if (!byDay[key]) byDay[key] = [];
    byDay[key].push(s);
  });
  Object.keys(byDay).forEach((key) => {
    byDay[key].sort((a, b) => {
      const aStart = a.start || a.time_from || a.start_time || '';
      const bStart = b.start || b.time_from || b.start_time || '';
      return aStart.localeCompare(bStart);
    });
  });

  const firstWeekday = (monthStart.getDay() + 6) % 7;
  const totalCells = 42;
  const gridStart = new Date(monthStart);
  gridStart.setDate(monthStart.getDate() - firstWeekday);
  const todayStr = formatDateLocal(new Date());
  const selectedDateStr = personalScheduleDate;

  const headHtml = headers.map(day => `<div class="public-calendar-head">${day}</div>`).join('');
  let cellsHtml = '';

  for (let i = 0; i < totalCells; i++) {
    const cellDate = new Date(gridStart);
    cellDate.setDate(gridStart.getDate() + i);
    const dateStr = formatDateLocal(cellDate);
    const isCurrentMonth = cellDate.getMonth() === monthStart.getMonth();
    const isToday = dateStr === todayStr;
    const isSelected = dateStr === selectedDateStr;
    const dayItems = byDay[dateStr] || [];
    const shownItems = dayItems.slice(0, 2);
    const hiddenCount = Math.max(0, dayItems.length - shownItems.length);

    const eventsHtml = shownItems.map((s) => {
      const title = s.title || s.direction_title || 'Занятие';
      const color = getPublicScheduleColor(title);
      const start = formatTimeShort(s.start || s.time_from || s.start_time);
      return `
        <div class="public-calendar-event" style="pointer-events:none;">
          <span class="public-calendar-event-dot" style="background:${color};"></span>
          <span class="public-calendar-event-text">${start || ''}</span>
        </div>
      `;
    }).join('');

    cellsHtml += `
      <div class="public-calendar-cell ${isCurrentMonth ? '' : 'is-outside'} ${isToday ? 'is-today' : ''} ${isSelected ? 'is-selected' : ''}" onclick="setPersonalScheduleDate('${dateStr}')">
        <div class="public-calendar-day">${cellDate.getDate()}</div>
        <div class="public-calendar-events">
          ${eventsHtml}
          ${hiddenCount > 0 ? `<div class="small" style="font-size: 10px; color: var(--hint);">+${hiddenCount} еще</div>` : ''}
        </div>
      </div>
    `;
  }

  const selectedItems = (byDay[selectedDateStr] || []).slice().sort((a, b) => {
    const aStart = a.start || a.time_from || a.start_time || '';
    const bStart = b.start || b.time_from || b.start_time || '';
    return aStart.localeCompare(bStart);
  });

  const selectedDateLabel = new Date(selectedDateStr + 'T00:00:00').toLocaleDateString('ru-RU', {
    day: 'numeric',
    month: 'long',
    weekday: 'long'
  });

  const agendaHtml = selectedItems.length
    ? selectedItems.map((s) => {
        const title = s.title || s.direction_title || 'Занятие';
        const teacherName = s.teacher_name || (s.teacher && s.teacher.name ? s.teacher.name : '');
        const objectType = (s.object_type || '').toString().toLowerCase();
        const isIndividual = objectType === 'individual';
        const isRental = objectType === 'rental';
        const isGroup = objectType === 'group';
        const directionTitle = isGroup ? (s.direction || s.direction_title || '') : '';
        const typeLabel = isRental
          ? 'Аренда зала'
          : isIndividual
            ? 'Индивидуальное занятие'
            : isGroup
              ? 'Групповое занятие'
              : 'Занятие';
        const startTime = formatTimeShort(s.start || s.time_from || s.start_time);
        const endTime = formatTimeShort(s.end || s.time_to || s.end_time);
        const duration = getDurationMinutes(startTime, endTime);
        const color = getPublicScheduleColor(title);
        return `
          <div class="public-schedule-item" onclick="openPersonalAttendance(${s.id})">
            <div class="public-schedule-time">
              <div class="public-dot" style="background:${color};"></div>
              <div class="public-time">${startTime || '—'}</div>
              <div class="public-duration">${duration ? duration + ' мин' : '—'}</div>
            </div>
            <div>
              <div class="public-info-title">${title}</div>
              ${directionTitle ? `<div class="public-info-sub">${directionTitle}</div>` : ''}
              <div class="public-info-sub">${typeLabel}</div>
              ${teacherName ? `<div class="public-info-teacher">${teacherName}</div>` : ''}
            </div>
            <div class="public-chevron">›</div>
          </div>
        `;
      }).join('')
    : '<p class="small" style="text-align:center; color: var(--hint); margin: 4px 0 0;">На выбранный день занятий нет</p>';

  container.innerHTML = `
    <div class="public-calendar-grid">${headHtml}${cellsHtml}</div>
    <div class="public-calendar-agenda">
      <div class="public-calendar-agenda-title">${selectedDateLabel}</div>
      <div class="public-schedule-list" style="margin-top:0;">${agendaHtml}</div>
    </div>
  `;
  initPersonalIndividualBookingPanel();
}

function initPersonalScheduleStrip() {
  const monthLabel = document.getElementById('personal-schedule-month');
  if (!monthLabel) return;

  if (!personalScheduleDate) {
    const today = new Date();
    personalScheduleDate = formatDateLocal(today);
  }
  if (!personalScheduleMonthDate) {
    const d = new Date(personalScheduleDate + 'T00:00:00');
    personalScheduleMonthDate = new Date(d.getFullYear(), d.getMonth(), 1);
  }
  monthLabel.textContent = personalScheduleMonthDate.toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' });
}

function setPersonalScheduleDate(dateStr) {
  personalScheduleDate = dateStr;
  const d = new Date(dateStr + 'T00:00:00');
  personalScheduleMonthDate = new Date(d.getFullYear(), d.getMonth(), 1);
  initPersonalScheduleStrip();
  renderPersonalScheduleList();
}

function shiftPersonalScheduleMonth(delta) {
  const base = personalScheduleMonthDate ? new Date(personalScheduleMonthDate) : new Date();
  const next = new Date(base.getFullYear(), base.getMonth() + Number(delta || 0), 1);
  personalScheduleMonthDate = next;
  if (!personalScheduleDate) {
    personalScheduleDate = formatDateLocal(next);
  } else {
    const selected = new Date(personalScheduleDate + 'T00:00:00');
    if (selected.getFullYear() !== next.getFullYear() || selected.getMonth() !== next.getMonth()) {
      personalScheduleDate = formatDateLocal(next);
    }
  }
  initPersonalScheduleStrip();
  renderPersonalScheduleList();
}

function refreshPersonalSchedule() {
  loadPersonalSchedule();
}

function canCreatePersonalIndividualBooking() {
  const role = (currentStaffPosition || '').toLowerCase();
  return role === 'учитель' || role === 'тех. админ';
}

function updatePersonalIndividualToggleButton() {
  const btn = document.getElementById('personal-individual-toggle-btn');
  if (!btn) return;
  btn.classList.toggle('is-open', personalIndividualBookingExpanded);
  btn.textContent = personalIndividualBookingExpanded
    ? '▲ Скрыть заявку на индивидуальное'
    : '✨ Заявка на индивидуальное';
}

function togglePersonalIndividualBookingPanel(forceOpen = null) {
  if (!canCreatePersonalIndividualBooking()) return;
  if (typeof forceOpen === 'boolean') {
    personalIndividualBookingExpanded = forceOpen;
  } else {
    personalIndividualBookingExpanded = !personalIndividualBookingExpanded;
  }
  initPersonalIndividualBookingPanel();
}
function setPersonalIndividualBookingMessage(message, isError = false) {
  const el = document.getElementById('personal-individual-booking-msg');
  if (!el) return;
  el.textContent = message || '';
  el.style.color = message ? (isError ? '#ffb3b3' : 'var(--hint)') : 'var(--hint)';
}

function renderPersonalIndividualSelectedUser() {
  const target = document.getElementById('personal-individual-user-selected');
  if (!target) return;
  const selected = personalIndividualBookingState.selectedUser;
  if (!selected) {
    target.textContent = 'Клиент не выбран';
    return;
  }
  const usernamePart = selected.username ? ` • @${selected.username}` : '';
  target.textContent = `Выбран: ${selected.name || 'Без имени'} (ID: ${selected.id}${usernamePart})`;
}

function initPersonalIndividualBookingPanel() {
  const card = document.getElementById('personal-individual-booking-card');
  const toggleBtn = document.getElementById('personal-individual-toggle-btn');
  if (!card) return;

  const canCreate = canCreatePersonalIndividualBooking();
  if (toggleBtn) {
    toggleBtn.style.display = canCreate ? 'block' : 'none';
  }
  if (!canCreate) {
    card.style.display = 'none';
    card.classList.remove('is-open');
    personalIndividualBookingExpanded = false;
    return;
  }

  updatePersonalIndividualToggleButton();
  card.style.display = 'block';
  card.classList.toggle('is-open', personalIndividualBookingExpanded);

  const dateLabel = document.getElementById('personal-individual-selected-date');
  if (dateLabel) {
    if (personalScheduleDate) {
      const dateObj = new Date(personalScheduleDate + 'T00:00:00');
      dateLabel.textContent = dateObj.toLocaleDateString('ru-RU', {
        day: 'numeric',
        month: 'long',
        weekday: 'long',
      });
    } else {
      dateLabel.textContent = '—';
    }
  }

  if (!personalIndividualBookingExpanded) {
    return;
  }

  const timeFrom = document.getElementById('personal-individual-time-from');
  const timeTo = document.getElementById('personal-individual-time-to');
  if (timeFrom && !timeFrom.value) timeFrom.value = '10:00';
  if (timeTo && !timeTo.value) timeTo.value = '11:00';

  renderPersonalIndividualSelectedUser();
}
function renderPersonalIndividualUserResults(users) {
  const results = document.getElementById('personal-individual-user-results');
  if (!results) return;
  if (!Array.isArray(users) || !users.length) {
    results.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 12px 0;">Пользователи не найдены</p>';
    return;
  }

  const selectedId = Number(personalIndividualBookingState.selectedUser?.id || 0);
  results.innerHTML = users.map((u) => {
    const isSelected = selectedId > 0 && Number(u.id) === selectedId;
    const safeName = escapeHtml(u.name || 'Без имени');
    const username = u.username ? ` • @${escapeHtml(u.username)}` : '';
    const phone = u.phone ? `<div style="font-size: 12px; color: var(--hint);">📱 ${escapeHtml(u.phone)}</div>` : '';
    return `
      <div class="card personal-individual-user-card ${isSelected ? 'is-selected' : ''}" onclick="selectPersonalIndividualUser(${Number(u.id)})">
        <div style="font-weight: 600; font-size: 14px;">${safeName}${isSelected ? ' ✓' : ''}</div>
        <div style="font-size: 12px; color: var(--hint); margin-top: 2px;">ID: ${Number(u.id)}${username}</div>
        ${phone}
      </div>
    `;
  }).join('');
}

function selectPersonalIndividualUser(userId) {
  const parsedId = Number(userId);
  if (!Number.isFinite(parsedId) || parsedId <= 0) return;
  const user = (personalIndividualBookingState.searchResults || []).find((item) => Number(item.id) === parsedId);
  if (!user) return;
  personalIndividualBookingState.selectedUser = user;
  renderPersonalIndividualSelectedUser();
  renderPersonalIndividualUserResults(personalIndividualBookingState.searchResults || []);
}

async function searchPersonalIndividualUsers() {
  const input = document.getElementById('personal-individual-user-search');
  const results = document.getElementById('personal-individual-user-results');
  if (!input || !results) return;

  const raw = (input.value || '').trim().toLowerCase();
  const byUsername = raw.startsWith('@');
  const clean = raw.replace(/^@/, '');

  try {
    results.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 12px 0;">⏳ Поиск...</p>';
    const params = new URLSearchParams();
    if (clean) {
      params.append('q', clean);
      if (byUsername) params.append('by_username', 'true');
    }

    const response = await fetch(`/staff/search?${params.toString()}`, { headers: getAuthHeaders() });
    if (!response.ok) {
      throw new Error('Не удалось загрузить пользователей');
    }

    const users = await response.json();
    personalIndividualBookingState.searchResults = Array.isArray(users) ? users.slice(0, 80) : [];
    renderPersonalIndividualUserResults(personalIndividualBookingState.searchResults);
  } catch (error) {
    console.error('Ошибка при поиске клиентов для индивидуального занятия:', error);
    results.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 12px 0;">❌ Ошибка сети</p>';
  }
}

async function submitPersonalIndividualBooking() {
  if (!canCreatePersonalIndividualBooking()) {
    showNotification('⚠️ Нет прав на создание заявки');
    return;
  }

  const selectedUser = personalIndividualBookingState.selectedUser;
  if (!selectedUser || !selectedUser.id) {
    setPersonalIndividualBookingMessage('Выберите клиента из списка', true);
    return;
  }

  if (!personalScheduleDate) {
    setPersonalIndividualBookingMessage('Сначала выберите день в календаре', true);
    return;
  }

  const timeFrom = document.getElementById('personal-individual-time-from')?.value || '';
  const timeTo = document.getElementById('personal-individual-time-to')?.value || '';
  const comment = (document.getElementById('personal-individual-comment')?.value || '').trim();
  if (!timeFrom || !timeTo) {
    setPersonalIndividualBookingMessage('Укажите время начала и окончания', true);
    return;
  }
  if (timeToMinutes(timeFrom) >= timeToMinutes(timeTo)) {
    setPersonalIndividualBookingMessage('Время "до" должно быть позже времени "от"', true);
    return;
  }

  const submitBtn = document.getElementById('personal-individual-submit');
  if (!submitBtn || personalIndividualBookingState.submitting) return;

  personalIndividualBookingState.submitting = true;
  submitBtn.disabled = true;
  const originalText = submitBtn.textContent;
  submitBtn.textContent = 'Отправка...';
  setPersonalIndividualBookingMessage('');

  try {
    const payload = {
      student_user_id: Number(selectedUser.id),
      date: personalScheduleDate,
      time_from: timeFrom,
      time_to: timeTo,
      comment: comment || null,
    };

    const response = await fetch('/api/booking-requests/teacher-individual', {
      method: 'POST',
      headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
      body: JSON.stringify(payload),
    });
    const data = await response.json().catch(() => ({}));
    if (!response.ok) {
      throw new Error(data.error || 'Не удалось отправить заявку');
    }

    const overlapsCount = Array.isArray(data.overlaps) ? data.overlaps.length : 0;
    if (overlapsCount > 0) {
      setPersonalIndividualBookingMessage(`Заявка отправлена. Найдено пересечений: ${overlapsCount}. Админы проверят вручную.`, false);
    } else {
      setPersonalIndividualBookingMessage('Заявка отправлена админам на подтверждение.', false);
    }
    showNotification('Заявка на индивидуальное отправлена');
    loadPersonalSchedule();
  } catch (error) {
    console.error('Ошибка при создании заявки на индивидуальное занятие:', error);
    setPersonalIndividualBookingMessage(error.message || 'Ошибка сети', true);
  } finally {
    personalIndividualBookingState.submitting = false;
    submitBtn.disabled = false;
    submitBtn.textContent = originalText;
  }
}

function openPersonalAttendance(scheduleId) {
  if (!personalScheduleItems || !personalScheduleItems.length) return;
  const item = personalScheduleItems.find(s => s.id === scheduleId);
  if (!item) return;
  const normalized = { ...item };
  // нормализуем время и название для экрана посещаемости
  if (!normalized.time_from && normalized.start) normalized.time_from = normalized.start;
  if (!normalized.time_to && normalized.end) normalized.time_to = normalized.end;
  if (!normalized.title) normalized.title = normalized.direction_title || 'Занятие';
  window.currentScheduleItem = normalized;
  openAttendanceScreen(normalized);
}

/* ====== СТАТИСТИКА ====== */
async function initStatsPageDefaults() {
  const from = document.getElementById('stats-date-from');
  const to = document.getElementById('stats-date-to');
  const today = new Date();
  const start = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().slice(0,10);
  const end = today.toISOString().slice(0,10);
  if (from) from.value = start;
  if (to) to.value = end;
}

async function loadStatsTeachers() {
  const select = document.getElementById('stats-teacher-select');
  if (!select) return;
  select.innerHTML = '<option value=\"\">⏳ Загрузка...</option>';
  try {
    const res = await fetch('/api/teachers');
    if (!res.ok) throw new Error('network');
    const data = await res.json();
    select.innerHTML = '<option value=\"\">Выберите преподавателя</option>' + (data || []).map(t => `<option value=\"${t.id}\">${t.name || 'ID ' + t.id}</option>`).join('');
  } catch (err) {
    select.innerHTML = '<option value=\"\">❌ Не удалось загрузить</option>';
  }
}

async function loadTeacherStats() {
  const teacherId = document.getElementById('stats-teacher-select')?.value;
  const dateFrom = document.getElementById('stats-date-from')?.value;
  const dateTo = document.getElementById('stats-date-to')?.value;
  const result = document.getElementById('stats-result');
  if (!teacherId) {
    if (result) result.innerHTML = '<p class=\"small\" style=\"color:var(--hint); margin:0;\">Выберите преподавателя</p>';
    return;
  }
  if (result) result.innerHTML = '<p class=\"small\" style=\"color:var(--hint); margin:0;\">⏳ Считаем...</p>';
  try {
    const params = new URLSearchParams({ teacher_id: teacherId });
    if (dateFrom) params.append('date_from', dateFrom);
    if (dateTo) params.append('date_to', dateTo);
    const res = await fetch(`/api/stats/teacher?${params.toString()}`);
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Ошибка');
    const period = `${data.date_from || '—'} — ${data.date_to || '—'}`;
    result.innerHTML = `
      <div class=\"stats-grid\">
        <div class=\"stats-card\"><div class=\"stats-label\">Период</div><div class=\"stats-value\">${period}</div></div>
        <div class=\"stats-card\"><div class=\"stats-label\">Занятий</div><div class=\"stats-value\">${data.lessons_count}</div></div>
        <div class=\"stats-card\"><div class=\"stats-label\">Ученики (учтено)</div><div class=\"stats-value\">${data.students_total}</div></div>
        <div class=\"stats-card\"><div class=\"stats-label\">Присутствовали</div><div class=\"stats-value\">${data.present}</div></div>
        <div class=\"stats-card\"><div class=\"stats-label\">Отсутствовали</div><div class=\"stats-value\">${data.absent}</div></div>
        <div class=\"stats-card\"><div class=\"stats-label\">Опоздали</div><div class=\"stats-value\">${data.late}</div></div>
      </div>
    `;
  } catch (err) {
    if (result) result.innerHTML = `<p class=\"small\" style=\"color:var(--hint); margin:0;\">❌ ${err.message}</p>`;
  }
}

async function loadPublicSchedule(force = false) {
  try {
    const container = document.getElementById('schedule-container');
    if (container) {
      container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">⏳ Загрузка...</p>';
    }

    if (!window.publicScheduleType) window.publicScheduleType = 'all';
    if (!window.publicScheduleView) window.publicScheduleView = 'list';
    if (!window.publicScheduleCache) window.publicScheduleCache = {};

    const mode = window.publicScheduleType === 'mine' ? 'mine' : 'all';
    if (!force && Array.isArray(window.publicScheduleCache[mode])) {
      window.publicScheduleItems = window.publicScheduleCache[mode];
      initPublicScheduleStrip();
      updatePublicTypeTabs();
      updatePublicViewTabs();
      renderPublicScheduleList();
      return;
    }

    const query = mode === 'mine' ? '?mine=1' : '?mine=0';
    const response = await fetch(`/schedule/public${query}`, { headers: getAuthHeaders() });

    if (!response.ok) {
      if (container) {
        container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">❌ Ошибка при загрузке расписания</p>';
      }
      return;
    }

    const schedules = await response.json();
    const normalized = Array.isArray(schedules) ? schedules : [];
    window.publicScheduleCache[mode] = normalized;
    window.publicScheduleItems = normalized;

    const today = new Date();
    if (!window.publicScheduleDate) {
      window.publicScheduleDate = formatDateLocal(today);
    }
    if (!window.publicScheduleMonthDate) {
      window.publicScheduleMonthDate = new Date(today.getFullYear(), today.getMonth(), 1);
    }

    preloadPublicDirections().then(() => {
      initPublicScheduleStrip();
      updatePublicTypeTabs();
      updatePublicViewTabs();
      renderPublicScheduleList();
    });
  } catch (error) {
    console.error('Ошибка при загрузке расписания:', error);
    const container = document.getElementById('schedule-container');
    if (container) {
      container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">❌ Ошибка сети</p>';
    }
  }
}

function preloadPublicDirections() {
  const items = Array.isArray(window.publicScheduleItems) ? window.publicScheduleItems : [];
  const missingIds = Array.from(new Set(items
    .filter(s => s.direction_id && !s.direction_image)
    .map(s => s.direction_id)
  ));
  if (!missingIds.length) return Promise.resolve();
  if (!window.publicDirectionsCache) window.publicDirectionsCache = {};

  return Promise.all(missingIds.map(id => {
    if (window.publicDirectionsCache[id]) return Promise.resolve();
    return fetch(`/api/directions/${id}`)
      .then(res => res.ok ? res.json() : null)
      .then(dir => {
        if (dir && dir.image_path) {
          window.publicDirectionsCache[id] = dir.image_path;
        }
      })
      .catch(() => {});
  })).then(() => {
    items.forEach(s => {
      if (!s.direction_image && s.direction_id && window.publicDirectionsCache[s.direction_id]) {
        s.direction_image = window.publicDirectionsCache[s.direction_id];
      }
    });
  });
}

function initPublicScheduleStrip() {
  const strip = document.getElementById('public-schedule-strip');
  const monthLabel = document.getElementById('public-schedule-month');
  const calendarNav = document.getElementById('public-calendar-nav');
  const weekNav = document.getElementById('public-week-nav');
  const weekLabel = document.getElementById('public-week-label');
  if (!strip) return;

  const view = window.publicScheduleView || 'list';
  const today = new Date();
  const selectedDateObj = window.publicScheduleDate ? new Date(window.publicScheduleDate + 'T00:00:00') : today;

  if (!window.publicScheduleDate) {
    window.publicScheduleDate = formatDateLocal(today);
  }
  if (!window.publicScheduleMonthDate || Number.isNaN(new Date(window.publicScheduleMonthDate).getTime())) {
    window.publicScheduleMonthDate = new Date(selectedDateObj.getFullYear(), selectedDateObj.getMonth(), 1);
  }
  if (!window.publicScheduleWeekStart || Number.isNaN(new Date(window.publicScheduleWeekStart).getTime())) {
    window.publicScheduleWeekStart = getPublicWeekStart(selectedDateObj);
  }

  if (view === 'calendar') {
    strip.style.display = 'none';
    if (calendarNav) calendarNav.classList.add('active');
    if (weekNav) weekNav.classList.remove('active');
    if (monthLabel) {
      monthLabel.textContent = window.publicScheduleMonthDate.toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' });
    }
    strip.innerHTML = '';
    return;
  }

  strip.style.display = 'flex';
  if (calendarNav) calendarNav.classList.remove('active');
  if (weekNav) weekNav.classList.add('active');

  if (monthLabel) {
    monthLabel.textContent = selectedDateObj.toLocaleDateString('ru-RU', { month: 'long' });
  }

  const labels = ['вс', 'пн', 'вт', 'ср', 'чт', 'пт', 'сб'];
  const weekStart = new Date(window.publicScheduleWeekStart);
  const days = [];
  for (let i = 0; i < 7; i++) {
    const d = new Date(weekStart);
    d.setDate(weekStart.getDate() + i);
    days.push(d);
  }

  const weekEnd = new Date(weekStart);
  weekEnd.setDate(weekStart.getDate() + 6);
  if (weekLabel) {
    weekLabel.textContent = formatPublicWeekLabel(weekStart, weekEnd);
  }

  const todayStr = formatDateLocal(today);
  strip.innerHTML = days.map((d) => {
    const dateStr = formatDateLocal(d);
    const isActive = window.publicScheduleDate === dateStr;
    const dayLabel = labels[d.getDay()];
    const shortLabel = dateStr === todayStr ? 'сегодня' : '';
    return `
      <div class="public-date-card ${isActive ? 'active' : ''}" onclick="selectPublicScheduleDate('${dateStr}')">
        <div class="public-date-dow">${dayLabel}</div>
        <div class="public-date-day">${d.getDate()}</div>
        <div class="public-date-label">${shortLabel}</div>
      </div>
    `;
  }).join('');
}

function selectPublicScheduleDate(dateStr) {
  window.publicScheduleDate = dateStr;
  const d = new Date(dateStr + 'T00:00:00');
  window.publicScheduleMonthDate = new Date(d.getFullYear(), d.getMonth(), 1);
  window.publicScheduleWeekStart = getPublicWeekStart(d);
  initPublicScheduleStrip();
  renderPublicScheduleList();
}

function getPublicWeekStart(dateObj) {
  const d = new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate());
  const day = (d.getDay() + 6) % 7;
  d.setDate(d.getDate() - day);
  return d;
}

function formatPublicWeekLabel(start, end) {
  const sameMonth = start.getMonth() === end.getMonth() && start.getFullYear() === end.getFullYear();
  if (sameMonth) {
    const month = start.toLocaleDateString('ru-RU', { month: 'long' });
    return `${start.getDate()}-${end.getDate()} ${month}`;
  }
  const startPart = start.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
  const endPart = end.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
  return `${startPart} - ${endPart}`;
}

function shiftPublicScheduleWeek(deltaWeeks) {
  const currentStart = window.publicScheduleWeekStart
    ? new Date(window.publicScheduleWeekStart)
    : getPublicWeekStart(new Date(window.publicScheduleDate || formatDateLocal(new Date())));
  const nextStart = new Date(currentStart);
  nextStart.setDate(currentStart.getDate() + (Number(deltaWeeks || 0) * 7));
  const selected = window.publicScheduleDate ? new Date(window.publicScheduleDate + 'T00:00:00') : new Date();
  const offset = Math.max(0, Math.min(6, Math.floor((selected - currentStart) / (24 * 60 * 60 * 1000))));
  const nextSelected = new Date(nextStart);
  nextSelected.setDate(nextStart.getDate() + offset);

  window.publicScheduleWeekStart = nextStart;
  window.publicScheduleDate = formatDateLocal(nextSelected);
  window.publicScheduleMonthDate = new Date(nextSelected.getFullYear(), nextSelected.getMonth(), 1);

  initPublicScheduleStrip();
  renderPublicScheduleList();
}

function renderPublicScheduleList() {
  const container = document.getElementById('schedule-container');
  if (!container) return;
  const items = Array.isArray(window.publicScheduleItems) ? window.publicScheduleItems : [];
  const view = window.publicScheduleView || 'list';

  if (view === 'calendar') {
    container.className = '';
    renderPublicScheduleCalendar(container, items);
    return;
  }

  container.className = 'public-schedule-list';
  const selected = window.publicScheduleDate;
  const filtered = selected ? items.filter(s => s.date === selected) : items;

  if (!filtered.length) {
    container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">📭 На этот день занятий нет</p>';
    return;
  }

  const sorted = filtered.slice().sort((a, b) => (a.start || '').localeCompare(b.start || ''));
  container.innerHTML = sorted.map(s => {
    const teacherName = s.teacher_name || (s.teacher && s.teacher.name ? s.teacher.name : '—');
    const isIndividual = s.object_type === 'individual';
    const isRental = s.object_type === 'rental';
    const directionTitle = isIndividual || isRental ? '' : (s.direction || '—');
    const startTime = formatTimeShort(s.start);
    const endTime = formatTimeShort(s.end);
    const duration = getDurationMinutes(startTime, endTime);
    const color = getPublicScheduleColor(s.title || '');
    return `
      <div class="public-schedule-item" onclick="openPublicScheduleDetail(${s.id})">
        <div class="public-schedule-time">
          <div class="public-dot" style="background:${color};"></div>
          <div class="public-time">${startTime || '—'}</div>
          <div class="public-duration">${duration ? duration + ' мин' : '—'}</div>
        </div>
        <div>
          <div class="public-info-title">${s.title || 'Занятие'}</div>
          ${directionTitle ? `<div class="public-info-sub">${directionTitle}</div>` : ''}
          <div class="public-info-sub">${isRental ? 'Аренда зала' : isIndividual ? 'Индивидуальное занятие' : 'Групповое занятие'}</div>
          <div class="public-info-teacher">${teacherName}</div>
        </div>
        <div class="public-chevron">›</div>
      </div>
    `;
  }).join('');
}

function renderPublicScheduleCalendar(container, items) {
  const monthDate = window.publicScheduleMonthDate
    ? new Date(window.publicScheduleMonthDate)
    : new Date();
  const monthStart = new Date(monthDate.getFullYear(), monthDate.getMonth(), 1);
  const headers = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'];

  const byDay = {};
  items.forEach((s) => {
    if (!s || !s.date) return;
    if (!byDay[s.date]) byDay[s.date] = [];
    byDay[s.date].push(s);
  });
  Object.keys(byDay).forEach((key) => {
    byDay[key].sort((a, b) => (a.start || '').localeCompare(b.start || ''));
  });

  const firstWeekday = (monthStart.getDay() + 6) % 7;
  const totalCells = 42;
  const gridStart = new Date(monthStart);
  gridStart.setDate(monthStart.getDate() - firstWeekday);
  const todayStr = formatDateLocal(new Date());
  const selectedDateStr = window.publicScheduleDate || todayStr;

  const headHtml = headers.map(day => `<div class="public-calendar-head">${day}</div>`).join('');
  let cellsHtml = '';

  for (let i = 0; i < totalCells; i++) {
    const cellDate = new Date(gridStart);
    cellDate.setDate(gridStart.getDate() + i);
    const dateStr = formatDateLocal(cellDate);
    const isCurrentMonth = cellDate.getMonth() === monthStart.getMonth();
    const isToday = dateStr === todayStr;
    const isSelected = dateStr === selectedDateStr;
    const dayItems = byDay[dateStr] || [];
    const shownItems = dayItems.slice(0, 2);
    const hiddenCount = Math.max(0, dayItems.length - shownItems.length);

    const eventsHtml = shownItems.map((s) => {
      const color = getPublicScheduleColor(s.title || '');
      const start = formatTimeShort(s.start);
      return `
        <div class="public-calendar-event" style="pointer-events:none;">
          <span class="public-calendar-event-dot" style="background:${color};"></span>
          <span class="public-calendar-event-text">${start || ''}</span>
        </div>
      `;
    }).join('');

    cellsHtml += `
      <div class="public-calendar-cell ${isCurrentMonth ? '' : 'is-outside'} ${isToday ? 'is-today' : ''} ${isSelected ? 'is-selected' : ''}" onclick="selectPublicScheduleDate('${dateStr}')">
        <div class="public-calendar-day">${cellDate.getDate()}</div>
        <div class="public-calendar-events">
          ${eventsHtml}
          ${hiddenCount > 0 ? `<div class="small" style="font-size: 10px; color: var(--hint);">+${hiddenCount} еще</div>` : ''}
        </div>
      </div>
    `;
  }

  const selectedItems = (byDay[selectedDateStr] || []).slice().sort((a, b) => (a.start || '').localeCompare(b.start || ''));
  const selectedDateLabel = new Date(selectedDateStr + 'T00:00:00').toLocaleDateString('ru-RU', {
    day: 'numeric',
    month: 'long',
    weekday: 'long'
  });
  const agendaHtml = selectedItems.length
    ? selectedItems.map((s) => {
        const teacherName = s.teacher_name || (s.teacher && s.teacher.name ? s.teacher.name : '—');
        const isIndividual = s.object_type === 'individual';
        const isRental = s.object_type === 'rental';
        const directionTitle = isIndividual || isRental ? '' : (s.direction || '—');
        const startTime = formatTimeShort(s.start);
        const endTime = formatTimeShort(s.end);
        const duration = getDurationMinutes(startTime, endTime);
        const color = getPublicScheduleColor(s.title || '');
        return `
          <div class="public-schedule-item" onclick="openPublicScheduleDetail(${s.id})">
            <div class="public-schedule-time">
              <div class="public-dot" style="background:${color};"></div>
              <div class="public-time">${startTime || '—'}</div>
              <div class="public-duration">${duration ? duration + ' мин' : '—'}</div>
            </div>
            <div>
              <div class="public-info-title">${s.title || 'Занятие'}</div>
              ${directionTitle ? `<div class="public-info-sub">${directionTitle}</div>` : ''}
              <div class="public-info-sub">${isRental ? 'Аренда зала' : isIndividual ? 'Индивидуальное занятие' : 'Групповое занятие'}</div>
              <div class="public-info-teacher">${teacherName}</div>
            </div>
            <div class="public-chevron">›</div>
          </div>
        `;
      }).join('')
    : '<p class="small" style="text-align:center; color: var(--hint); margin: 4px 0 0;">На выбранный день занятий нет</p>';

  container.innerHTML = `
    <div class="public-calendar-grid">${headHtml}${cellsHtml}</div>
    <div class="public-calendar-agenda">
      <div class="public-calendar-agenda-title">${selectedDateLabel}</div>
      <div class="public-schedule-list" style="margin-top:0;">${agendaHtml}</div>
    </div>
  `;
}

function setPublicScheduleView(view) {
  window.publicScheduleView = view === 'calendar' ? 'calendar' : 'list';
  updatePublicViewTabs();
  initPublicScheduleStrip();
  renderPublicScheduleList();
}

function updatePublicViewTabs() {
  document.querySelectorAll('.public-view-tab').forEach(el => {
    const view = el.dataset.view || 'list';
    el.classList.toggle('active', view === (window.publicScheduleView || 'list'));
  });
}

function shiftPublicScheduleMonth(delta) {
  const base = window.publicScheduleMonthDate ? new Date(window.publicScheduleMonthDate) : new Date();
  const next = new Date(base.getFullYear(), base.getMonth() + Number(delta || 0), 1);
  window.publicScheduleMonthDate = next;
  if (window.publicScheduleView === 'calendar') {
    initPublicScheduleStrip();
    renderPublicScheduleList();
  }
}

function getDurationMinutes(start, end) {
  if (!start || !end) return null;
  const [sh, sm] = start.split(':').map(Number);
  const [eh, em] = end.split(':').map(Number);
  if (Number.isNaN(sh) || Number.isNaN(eh)) return null;
  return Math.max(0, (eh * 60 + em) - (sh * 60 + sm));
}

function formatTimeShort(timeStr) {
  if (!timeStr) return '';
  const parts = timeStr.split(':');
  if (parts.length < 2) return timeStr;
  return `${parts[0].padStart(2, '0')}:${parts[1].padStart(2, '0')}`;
}

function getPublicScheduleColor(key) {
  const hue = (hashString(key || '') + 180) % 360;
  return `hsl(${hue}, 70%, 55%)`;
}

function openPublicScheduleDetail(id) {
  const items = Array.isArray(window.publicScheduleItems) ? window.publicScheduleItems : [];
  const item = items.find(i => i.id === id);
  if (!item) return;

  const content = document.getElementById('public-schedule-detail-content');
  if (!content) return;

  const startTime = formatTimeShort(item.start);
  const endTime = formatTimeShort(item.end);
  const duration = getDurationMinutes(startTime, endTime);
  const lessons = item.lessons_per_week ? item.lessons_per_week : '—';
  const directionImage = item.direction_image || '';

  content.innerHTML = `
    ${directionImage ? `<div class="card" style="padding:0; overflow:hidden; margin-bottom:8px;"><img src="${directionImage}" alt="Направление" style="width:100%; height:180px; object-fit:cover; display:block;"></div>` : ''}
    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:6px;">
      <div class="schedule-detail-chip">📅 ${item.date ? new Date(item.date).toLocaleDateString('ru-RU') : '—'}</div>
      <div class="schedule-detail-chip">⏰ ${startTime || '—'} — ${endTime || '—'}</div>
      <div class="schedule-detail-chip">⏳ ${duration ? duration + ' мин' : '—'}</div>
    </div>
    <div class="schedule-detail-card">
      <div class="schedule-detail-row">👥 <strong>Группа:</strong> ${item.title || '—'}</div>
      <div class="schedule-detail-row">👩‍🏫 <strong>Преподаватель:</strong> ${item.teacher_name || '—'}</div>
      <div class="schedule-detail-row">📆 <strong>Занятий в неделю:</strong> ${lessons}</div>
      <div class="schedule-detail-row">🎈 <strong>Возраст:</strong> ${item.age_group || '—'}</div>
    </div>
    <div class="schedule-detail-card">
      <div class="schedule-detail-row">🎯 <strong>Направление:</strong> ${item.direction || '—'}</div>
      <div class="schedule-detail-row">📝 <strong>Описание направления:</strong> ${item.direction_description || '—'}</div>
      <button class="save-btn" style="width:100%; margin-top:4px; background:#111;">Перейти в направление</button>
    </div>
  `;

  showPage('public-schedule-detail');
}

async function loadTeachers() {
  try {
    const response = await fetch('/api/teachers');
    if (!response.ok) return [];
    return await response.json();
  } catch (error) {
    console.error('Ошибка при загрузке учителей:', error);
    return [];
  }
}

function populateTeacherSelect(teachers, selectedTeacherId = null) {
  const select = document.getElementById('schedule-input-teacher');
  const currentValue = select.value;
  
  select.innerHTML = '<option value="">Выберите преподавателя</option>';
  
  teachers.forEach(t => {
    const option = document.createElement('option');
    option.value = t.id;
    option.textContent = t.name;
    if (t.id == (selectedTeacherId || currentValue)) {
      option.selected = true;
    }
    select.appendChild(option);
  });
}

async function openCreateSchedule() {
  currentScheduleId = null;
  
  document.getElementById('schedule-form-title').innerText = 'Создать занятие';
  document.getElementById('schedule-input-title').value = '';
  document.getElementById('schedule-input-date').value = '';
  document.getElementById('schedule-input-start').value = '';
  document.getElementById('schedule-input-end').value = '';
  document.getElementById('schedule-delete-btn').style.display = 'none';
  
  const teachers = await loadTeachers();
  populateTeacherSelect(teachers, currentUserData.id);
  
  showPage('schedule-form');
  setHeaderTitle('Создать занятие');
}

function editSchedule(scheduleId, title, teacherId, teacherName, date, start, end) {
  currentScheduleId = scheduleId;
  
  document.getElementById('schedule-form-title').innerText = 'Редактировать занятие';
  document.getElementById('schedule-input-title').value = title;
  document.getElementById('schedule-input-date').value = date;
  document.getElementById('schedule-input-start').value = start;
  document.getElementById('schedule-input-end').value = end;
  document.getElementById('schedule-delete-btn').style.display = 'block';
  
  // Загружаем учителей и выбираем текущего
  loadTeachers().then(teachers => {
    populateTeacherSelect(teachers, teacherId);
  });
  
  showPage('schedule-form');
  setHeaderTitle('Редактировать занятие');
}

async function saveSchedule() {
  const title = document.getElementById('schedule-input-title').value.trim();
  const teacher_id = document.getElementById('schedule-input-teacher').value;
  const date = document.getElementById('schedule-input-date').value;
  const start = document.getElementById('schedule-input-start').value;
  const end = document.getElementById('schedule-input-end').value;
  
  if (!title || !teacher_id || !date || !start || !end) {
    showNotification('⚠️ Заполните все поля');
    return;
  }
  
  try {
    if (currentScheduleId) {
      // Редактируем существующее занятие
      const response = await fetch(`/schedule/${currentScheduleId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title, teacher_id: parseInt(teacher_id), date, start_time: start, end_time: end })
      });
      
      if (response.ok) {
        showNotification('? Занятие обновлено');
        goBack();
      } else {
        const error = await response.json();
        showNotification('? Ошибка: ' + (error.error || 'неизвестная ошибка'));
      }
    } else {
      // Создаем новое занятие
      const response = await fetch('/schedule', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title, teacher_id: parseInt(teacher_id), date, start_time: start, end_time: end })
      });
      
      if (response.ok) {
        showNotification('? Занятие создано');
        goBack();
      } else {
        const error = await response.json();
        showNotification('? Ошибка: ' + (error.error || 'неизвестная ошибка'));
      }
    }
  } catch (error) {
    console.error('Ошибка при сохранении занятия:', error);
    showNotification('? Ошибка при сохранении занятия');
  }
}

async function deleteSchedule() {
  if (!currentScheduleId) {
    showNotification('? ID занятия не найден');
    return;
  }
  
  if (!confirm('Вы уверены, что хотите удалить это занятие?')) {
    return;
  }
  
  try {
    const response = await fetch(`/schedule/${currentScheduleId}`, {
      method: 'DELETE'
    });
    
    if (response.ok) {
      showNotification('? Занятие удалено');
      goBack();
    } else {
      const error = await response.json();
      showNotification('? Ошибка: ' + (error.error || 'неизвестная ошибка'));
    }
  } catch (error) {
    console.error('Ошибка при удалении занятия:', error);
    showNotification('? Ошибка при удалении занятия');
  }
}

/* ====== ПРОВЕРКА СТАТУСА ПЕРСОНАЛА ====== */
async function checkStaffStatus(telegramId) {
  try {
    const response = await fetch(`/staff/check/${telegramId}`);
    
    if (!response.ok) {
      isStaff = false;
      currentStaffPosition = '';
      setCachedStaffStatus(false, '');
      updateStaffNavigation();
      return;
    }
    
    const data = await response.json();
    isStaff = data.is_staff;
    if (data.staff) {
      currentStaffPosition = data.staff.position.toLowerCase();
      
      // Обновляем имя из Telegram для расширенных админ-ролей
      const user = tg.initDataUnsafe?.user;
      if (user && (currentStaffPosition === 'владелец' || currentStaffPosition === 'старший админ' || currentStaffPosition === 'администратор')) {
        try {
          await fetch(`/staff/update-from-telegram/${telegramId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              first_name: user.first_name,
              last_name: user.last_name
            })
          });
        } catch (error) {
          console.log('Не удалось обновить имя из Telegram:', error);
        }
      }
    }
    setCachedStaffStatus(isStaff, currentStaffPosition);
    updateStaffNavigation();
    
    console.log(`Статус персонала: ${isStaff}, должность: ${currentStaffPosition}`);
  } catch (error) {
    console.error('Ошибка при проверке статуса персонала:', error);
    isStaff = false;
    currentStaffPosition = '';
    setCachedStaffStatus(false, '');
    updateStaffNavigation();
  }
}

function updateStaffNavigation() {
  const staffNavBtn = document.getElementById('staff-nav-btn');
  const staffManageBtn = document.getElementById('staff-manage-btn-work');
  const clientsBtn = document.getElementById('clients-btn-work');
  const scheduleControlBtn = document.getElementById('schedule-control-btn-work');
  const directionsGroupsBtn = document.getElementById('directions-groups-btn-work');
  const mailingsBtn = document.getElementById('mailings-btn-work');
  const newsManageBtn = document.getElementById('news-manage-btn-work');
  const statsBtn = document.getElementById('stats-btn');
  const workSettingsBtn = document.getElementById('work-settings-btn-work');
  const workSettingsPaymentItem = document.getElementById('work-settings-payment-item');
  const workSettingsPricesItem = document.getElementById('work-settings-prices-item');
  const workSettingsOtherItem = document.getElementById('work-settings-other-item');

  const peopleSection = document.getElementById('work-section-people');
  const structureSection = document.getElementById('work-section-structure');
  const communicationsSection = document.getElementById('work-section-communications');
  const statsPaymentSection = document.getElementById('work-section-stats-payment');

  const role = (currentStaffPosition || '').toLowerCase();
  const PERMISSIONS_BY_ROLE = {
    'тех. админ': new Set([
      'manage_staff', 'view_all_users', 'manage_schedule', 'create_direction', 'create_news', 'manage_mailings', 'view_stats'
    ]),
    'владелец': new Set([
      'manage_staff', 'view_all_users', 'manage_schedule', 'create_direction', 'create_news', 'manage_mailings', 'view_stats'
    ]),
    'старший админ': new Set([
      'manage_staff', 'view_all_users', 'manage_schedule', 'create_direction', 'create_news', 'manage_mailings', 'view_stats'
    ]),
    'администратор': new Set([
      'view_all_users', 'manage_schedule', 'create_direction', 'create_news', 'manage_mailings', 'view_stats'
    ]),
    'учитель': new Set([
      'view_personal_lessons', 'rent_hall'
    ]),
  };

  const hasPerm = (perm) => {
    const perms = PERMISSIONS_BY_ROLE[role];
    return !!(perms && perms.has(perm));
  };

  const setBtnVisible = (btn, visible) => {
    if (!btn) return;
    btn.style.display = visible ? 'flex' : 'none';
  };

  const updateSectionVisibility = (sectionEl) => {
    if (!sectionEl) return;
    const actionButtons = Array.from(sectionEl.querySelectorAll('button.save-btn'));
    const hasVisibleActions = actionButtons.some((btn) => btn.style.display !== 'none');
    sectionEl.style.display = hasVisibleActions ? 'block' : 'none';
  };
  
  if (isStaff) {
    staffNavBtn.classList.remove('hidden');

    setBtnVisible(staffManageBtn, hasPerm('manage_staff'));
    setBtnVisible(clientsBtn, hasPerm('view_all_users'));
    setBtnVisible(scheduleControlBtn, hasPerm('manage_schedule'));
    setBtnVisible(directionsGroupsBtn, hasPerm('create_direction'));
    setBtnVisible(mailingsBtn, hasPerm('manage_mailings'));
    setBtnVisible(newsManageBtn, hasPerm('create_news'));
    setBtnVisible(statsBtn, hasPerm('view_stats'));
    setBtnVisible(workSettingsBtn, hasPerm('manage_schedule') || hasPerm('create_direction'));

    if (workSettingsPaymentItem) {
      workSettingsPaymentItem.style.display = hasPerm('manage_schedule') ? 'block' : 'none';
    }
    if (workSettingsPricesItem) {
      workSettingsPricesItem.style.display = hasPerm('create_direction') ? 'block' : 'none';
    }
    if (workSettingsOtherItem) {
      workSettingsOtherItem.style.display = 'block';
    }

    updateSectionVisibility(peopleSection);
    updateSectionVisibility(structureSection);
    updateSectionVisibility(communicationsSection);
    updateSectionVisibility(statsPaymentSection);
  } else {
    staffNavBtn.classList.add('hidden');

    setBtnVisible(staffManageBtn, false);
    setBtnVisible(clientsBtn, false);
    setBtnVisible(scheduleControlBtn, false);
    setBtnVisible(directionsGroupsBtn, false);
    setBtnVisible(mailingsBtn, false);
    setBtnVisible(newsManageBtn, false);
    setBtnVisible(statsBtn, false);
    setBtnVisible(workSettingsBtn, false);

    if (workSettingsPaymentItem) {
      workSettingsPaymentItem.style.display = 'none';
    }
    if (workSettingsPricesItem) {
      workSettingsPricesItem.style.display = 'none';
    }
    if (workSettingsOtherItem) {
      workSettingsOtherItem.style.display = 'none';
    }

    updateSectionVisibility(peopleSection);
    updateSectionVisibility(structureSection);
    updateSectionVisibility(communicationsSection);
    updateSectionVisibility(statsPaymentSection);
    // Если персонал пытается перейти на скрытую страницу, показываем главную
    if (document.getElementById('staff').classList.contains('active')) {
      showPage('home');
    }
  }
}

/* ====== ПРОФИЛЬ ИЗ TELEGRAM ====== */
const user = tg.initDataUnsafe?.user;
let currentUserData = null;
let isStaff = false;
let profileLoadedPromise = null;
let personalScheduleDate = null;
let personalScheduleMonthDate = null;
let personalScheduleItems = [];
let personalScheduleRefreshLoading = false;
let personalIndividualBookingExpanded = false;
let personalIndividualBookingState = {
  selectedUser: null,
  searchResults: [],
  submitting: false,
};

if (user) {
  document.getElementById('profile-name').innerText = user.first_name || '—';
  document.getElementById('profile-username').innerText = user.username ? '@' + user.username : '—';

  if (user.photo_url) {
    document.getElementById('avatar').innerHTML = `<img src="${user.photo_url}">`;
  }
  
  // Автоматическая регистрация пользователя
  registerUserIfNeeded(user);
  
  // Загружаем данные профиля из БД
  profileLoadedPromise = loadProfileData();
  
  // Проверяем, является ли пользователь сотрудником
  const cachedStaff = getCachedStaffStatus();
  if (cachedStaff) {
    isStaff = cachedStaff.isStaff;
    currentStaffPosition = cachedStaff.position || '';
    updateStaffNavigation();
  }

  checkStaffStatus(user.id);
}

/* ====== ЗАГРУЗКА ДАННЫХ ПРОФИЛЯ ====== */
async function loadProfileData() {
  try {
    await authSessionPromise;
    // Небольшая задержка, чтобы дать время на регистрацию
    await new Promise(resolve => setTimeout(resolve, 500));
    
    const response = await fetch('/users/me');
    
    if (!response.ok) {
      console.error('Ошибка при загрузке профиля:', response.status);
      showNotification('⚠️ Не удалось загрузить профиль. Попробуйте позже.');
      return;
    }
    
    const data = await response.json();
    currentUserData = data;
    
    console.log('? Профиль загружен:', data);
    
    // Заполняем форму данными
    document.getElementById('profile-input-name').value = data.name || '';
    document.getElementById('profile-input-phone').value = data.phone || '';
    document.getElementById('profile-input-birth-date').value = data.birth_date || '';
    const userNotesInput = document.getElementById('profile-input-user-notes');
    if (userNotesInput) userNotesInput.value = data.user_notes || '';
    document.getElementById('profile-status').innerText = getStatusText(data.status);
    document.getElementById('profile-registered').innerText = formatDate(data.registered_at);
    
    // Загружаем фото если существует
    if (data.photo_path) {
      displayProfilePhoto(data.photo_path);
    }
    
    // Обновляем информацию на панели персонала
    if (isStaff) {
      displayStaffInfo(data);
    }
    
  } catch (error) {
    console.error('Ошибка при загрузке профиля:', error);
    showNotification('❌ Ошибка при загрузке профиля');
  }
}

/* ====== СОХРАНЕНИЕ ИЗМЕНЕНИЙ ПРОФИЛЯ ====== */
async function saveProfileChanges() {
  if (!currentUserData) {
    showNotification('? Данные профиля не загружены');
    return;
  }
  
  const userId = currentUserData.id;
  const userNotesInput = document.getElementById('profile-input-user-notes');
  
  const updatedData = {
    name: document.getElementById('profile-input-name').value.trim(),
    phone: document.getElementById('profile-input-phone').value.trim(),
    birth_date: document.getElementById('profile-input-birth-date').value || null
  };
  if (userNotesInput) {
    updatedData.user_notes = userNotesInput.value.trim() || null;
  }
  
  // Проверяем, что имя и телефон не пустые
  if (!updatedData.name) {
    showNotification('⚠️ Введите имя');
    return;
  }
  if (!updatedData.phone) {
    showNotification('⚠️ Введите номер телефона');
    return;
  }
  
  try {
    console.log('Отправляем данные:', updatedData);
    
    const response = await fetch(`/users/${userId}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(updatedData)
    });
    
    if (response.ok) {
      const newData = await response.json();
      currentUserData = newData;
      
      console.log('? Профиль сохранен:', newData);
      
      // Обновляем отображение имени
      document.getElementById('profile-name').innerText = newData.name;
      
      showNotification('? Профиль успешно обновлен!');
    } else {
      const error = await response.json();
      console.error('Ошибка сервера:', error);
      showNotification('? Ошибка: ' + (error.error || 'неизвестная ошибка'));
    }
  } catch (error) {
    console.error('Ошибка при сохранении профиля:', error);
    showNotification('? Ошибка при сохранении профиля');
  }
}

function setProfilePhoneRequestStatus(text, isError = false) {
  const statusEl = document.getElementById('profile-request-phone-status');
  if (!statusEl) return;
  statusEl.textContent = text || '';
  statusEl.style.color = isError ? '#ffb3b3' : 'var(--hint)';
}

async function requestPhoneFromTelegram() {
  const phoneBtn = document.getElementById('profile-request-phone-btn');
  const userId = currentUserData?.id;
  if (!tg || typeof tg.requestContact !== 'function') {
    setProfilePhoneRequestStatus('Эта функция работает только внутри Telegram Mini App', true);
    return;
  }
  if (phoneBtn) phoneBtn.disabled = true;
  setProfilePhoneRequestStatus('Подтвердите отправку номера в Telegram');

  let settled = false;
  const finish = async (sent) => {
    if (settled) return;
    settled = true;
    if (sent) {
      setProfilePhoneRequestStatus('Спасибо! Номер отправлен, обновляем профиль...');
      if (userId) {
        try {
          await loadProfileData();
          const phoneValue = document.getElementById('profile-input-phone')?.value?.trim();
          setProfilePhoneRequestStatus(phoneValue ? 'Готово! Номер в профиле обновлен' : 'Номер отправлен. Обновим профиль, как только Telegram передаст контакт.');
        } catch (_) {
          setProfilePhoneRequestStatus('Номер отправлен. Обновим профиль, как только Telegram передаст контакт.');
        }
      } else {
        setProfilePhoneRequestStatus('Номер отправлен. Обновим профиль, как только Telegram передаст контакт.');
      }
    } else {
      setProfilePhoneRequestStatus('Вы отменили отправку номера. Можно попробовать снова', true);
    }
    if (phoneBtn) phoneBtn.disabled = false;
  };

  const onContactRequested = (eventData) => {
    const status = (eventData && eventData.status ? String(eventData.status) : '').toLowerCase();
    if (status === 'sent') finish(true);
    else if (status === 'cancelled' || status === 'canceled') finish(false);
  };

  try {
    if (typeof tg.onEvent === 'function') {
      tg.onEvent('contactRequested', onContactRequested);
    }
    tg.requestContact((result) => {
      if (typeof result === 'boolean') {
        finish(result);
        return;
      }
      const normalized = String(result || '').toLowerCase();
      if (normalized === 'sent') finish(true);
      else if (normalized === 'cancelled' || normalized === 'canceled' || normalized === 'false' || normalized === 'denied') finish(false);
    });
    setTimeout(() => {
      if (!settled) finish(false);
    }, 15000);
  } catch (err) {
    if (phoneBtn) phoneBtn.disabled = false;
    setProfilePhoneRequestStatus('Не получилось запросить номер. Попробуйте еще раз чуть позже', true);
  } finally {
    if (typeof tg.offEvent === 'function') {
      setTimeout(() => tg.offEvent('contactRequested', onContactRequested), 0);
    }
  }
}

/* ====== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ====== */
function getStatusText(status) {
  const statusMap = {
    'active': '✅ Активен',
    'inactive': '⏸️ Неактивен',
    'frozen': '❄️ Заморозка'
  };
  return statusMap[status] || status;
}

function loadProfileAbonements() {
  const container = document.getElementById('profile-abonements-container');
  if (!container) return;
  container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">Загрузка...</p>';

  fetch('/api/group-abonements/my', { headers: getAuthHeaders() })
    .then(async res => {
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Не удалось загрузить абонементы');
      return data;
    })
    .then(items => {
      if (!items.length) {
        container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">Абонементов нет</p>';
        return;
      }
      container.innerHTML = items.map(a => {
        const status = formatAbonementStatus(a.status);
        const validTo = a.valid_to ? formatDate(a.valid_to) : '?';
        return `
          <div class="card">
            <div style="font-weight: 600; margin-bottom: 6px;">${a.group_name || 'Группа'}</div>
            <div class="small" style="margin-bottom: 4px;">${status}</div>
            <div class="small">Остаток занятий: ${a.balance_credits ?? '—'}</div>
            <div class="small" style="margin-top: 6px;">Действует до: ${validTo}</div>
          </div>
        `;
      }).join('');
    })
    .catch(err => {
      container.innerHTML = `<p class="small" style="text-align: center; color: #ffb3b3; padding: 20px;">Ошибка: ${err.message}</p>`;
    });
}

function loadProfileBookingRequests() {
  const container = document.getElementById('profile-booking-requests-container');
  if (!container) return;
  container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">Загрузка...</p>';

  fetch('/api/booking-requests/my', { headers: getAuthHeaders() })
    .then(async res => {
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Не удалось загрузить заявки');
      return data;
    })
    .then(items => {
      const visibleItems = (Array.isArray(items) ? items : []).filter(item => {
        const status = String(item?.status || '').toUpperCase();
        return status !== 'APPROVED' && status !== 'PAID';
      });

      if (!visibleItems.length) {
        container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">Заявок пока нет</p>';
        return;
      }
      container.innerHTML = visibleItems.map(item => {
        const typeLabel = escapeHtml(item.object_type_label || item.object_type || 'Заявка');
        const statusLabel = escapeHtml(item.status_label || item.status || '—');
        const createdText = item.created_at ? new Date(item.created_at).toLocaleString('ru-RU') : '—';
        const amountText = Number.isFinite(Number(item.requested_amount))
          ? `${new Intl.NumberFormat('ru-RU').format(Number(item.requested_amount))} ${item.requested_currency || 'RUB'}`
          : '—';

        let detailsHtml = '';
        if (item.object_type === 'group') {
          const abonementTypeMap = {
            trial: 'Пробный',
            single: 'Одноразовый',
            multi: 'Многоразовый',
          };
          const abonementType = escapeHtml(abonementTypeMap[item.abonement_type] || item.abonement_type || '—');
          const groups = Array.isArray(item.bundle_group_names) ? item.bundle_group_names.filter(Boolean) : [];
          const groupsText = groups.length ? groups.map(name => escapeHtml(name)).join(' + ') : escapeHtml(item.group_name || 'Группа');
          const startDate = item.group_start_date ? new Date(item.group_start_date).toLocaleDateString('ru-RU') : '—';
          const validUntil = item.valid_until ? new Date(item.valid_until).toLocaleDateString('ru-RU') : '—';
          detailsHtml = `
            <div class="small" style="margin-top: 4px;">Группы: ${groupsText}</div>
            <div class="small">Тип абонемента: ${abonementType}</div>
            <div class="small">Занятий: ${item.lessons_count ?? '—'}</div>
            <div class="small">Старт: ${startDate}</div>
            <div class="small">Действует до: ${validUntil}</div>
          `;
        } else {
          const dateText = item.date ? new Date(item.date).toLocaleDateString('ru-RU') : '—';
          const timeFrom = item.time_from || '—';
          const timeTo = item.time_to || '—';
          detailsHtml = `
            <div class="small" style="margin-top: 4px;">Дата: ${dateText}</div>
            <div class="small">Время: ${escapeHtml(timeFrom)} - ${escapeHtml(timeTo)}</div>
          `;
        }

        return `
          <div class="card">
            <div style="font-weight: 700; margin-bottom: 6px;">${typeLabel}</div>
            <div class="small" style="margin-bottom: 4px;">Статус: ${statusLabel}</div>
            <div class="small">Создана: ${escapeHtml(createdText)}</div>
            <div class="small">Сумма: ${escapeHtml(amountText)}</div>
            ${detailsHtml}
            ${item.comment ? `<div class="small" style="margin-top: 6px;">Комментарий: ${escapeHtml(item.comment)}</div>` : ''}
          </div>
        `;
      }).join('');
    })
    .catch(err => {
      container.innerHTML = `<p class="small" style="text-align: center; color: #ffb3b3; padding: 20px;">Ошибка: ${err.message}</p>`;
    });
}

async function loadPaymentProfilesAdmin() {
  const activeLabel = document.getElementById('payment-profiles-active-label');
  if (activeLabel) activeLabel.textContent = 'Загрузка...';
  try {
    const response = await fetch('/api/admin/payment-profiles', { headers: getAuthHeaders() });
    const data = await response.json().catch(() => null);
    if (!response.ok) {
      throw new Error((data && data.error) ? data.error : 'Не удалось загрузить профили');
    }
    const profiles = Array.isArray(data.profiles) ? data.profiles : [];
    for (const profile of profiles) {
      const slot = Number(profile.slot);
      const bankEl = document.getElementById(`payment-profile-${slot}-bank`);
      const numberEl = document.getElementById(`payment-profile-${slot}-number`);
      const fullNameEl = document.getElementById(`payment-profile-${slot}-full-name`);
      if (bankEl) bankEl.value = profile.recipient_bank || '';
      if (numberEl) numberEl.value = profile.recipient_number || '';
      if (fullNameEl) fullNameEl.value = profile.recipient_full_name || '';
    }
    if (activeLabel) {
      activeLabel.textContent = `Сейчас активен профиль №${data.active_slot || 1}`;
    }
    updatePaymentActiveTabs(Number(data.active_slot) || 1);
  } catch (error) {
    if (activeLabel) activeLabel.textContent = error.message || 'Ошибка загрузки';
    showNotification('⚠️ ' + (error.message || 'Не удалось загрузить профили оплаты'));
  }
}

async function savePaymentProfile(slot) {
  const bankEl = document.getElementById(`payment-profile-${slot}-bank`);
  const numberEl = document.getElementById(`payment-profile-${slot}-number`);
  const fullNameEl = document.getElementById(`payment-profile-${slot}-full-name`);
  const recipient_bank = bankEl ? bankEl.value.trim() : '';
  const recipient_number = numberEl ? numberEl.value.trim() : '';
  const recipient_full_name = fullNameEl ? fullNameEl.value.trim() : '';
  if (!recipient_bank || !recipient_number || !recipient_full_name) {
    showNotification('⚠️ Заполните банк, номер и ФИО');
    return;
  }

  try {
    const response = await fetch(`/api/admin/payment-profiles/${slot}`, {
      method: 'PUT',
      headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
      body: JSON.stringify({ recipient_bank, recipient_number, recipient_full_name }),
    });
    const data = await response.json().catch(() => null);
    if (!response.ok) {
      throw new Error((data && data.error) ? data.error : 'Не удалось сохранить профиль');
    }
    showNotification(`✅ Профиль ${slot} сохранен`);
    await loadPaymentProfilesAdmin();
  } catch (error) {
    showNotification('❌ ' + (error.message || 'Не удалось сохранить профиль'));
  }
}

async function switchPaymentProfile(slot) {
  try {
    const response = await fetch('/api/admin/payment-profiles/active', {
      method: 'PUT',
      headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
      body: JSON.stringify({ active_slot: slot }),
    });
    const data = await response.json().catch(() => null);
    if (!response.ok) {
      throw new Error((data && data.error) ? data.error : 'Не удалось переключить профиль');
    }
    showNotification(`✅ Активирован профиль ${slot}`);
    await loadPaymentProfilesAdmin();
  } catch (error) {
    showNotification('❌ ' + (error.message || 'Не удалось переключить профиль'));
  }
}

function selectPaymentProfileTab(slot) {
  switchPaymentProfile(slot);
}

function updatePaymentActiveTabs(activeSlot) {
  const firstTab = document.getElementById('payment-tab-1');
  const secondTab = document.getElementById('payment-tab-2');
  const indicator = document.getElementById('payment-tab-indicator');
  if (!firstTab || !secondTab || !indicator) return;

  firstTab.classList.toggle('active', activeSlot === 1);
  secondTab.classList.toggle('active', activeSlot === 2);

  const activeTab = activeSlot === 2 ? secondTab : firstTab;
  indicator.style.width = `${activeTab.offsetWidth}px`;
  indicator.style.transform = `translateX(${activeTab.offsetLeft}px)`;
}

function setWorkSettingsPriceStatus(directionId, message, isError = false) {
  const statusEl = document.getElementById(`work-price-status-${directionId}`);
  if (!statusEl) return;
  statusEl.textContent = message || '';
  statusEl.style.color = isError ? '#ffb3b3' : 'var(--hint)';
}

async function loadWorkSettingsPrices() {
  const container = document.getElementById('work-settings-prices-container');
  if (!container) return;

  container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">⏳ Загрузка...</p>';
  try {
    const response = await fetch('/api/directions/manage', { headers: getAuthHeaders() });
    const data = await response.json().catch(() => null);
    if (!response.ok) {
      throw new Error((data && data.error) ? data.error : 'Не удалось загрузить ценники');
    }

    const directions = Array.isArray(data) ? data : [];
    if (directions.length === 0) {
      container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">Ценники пока не настроены</p>';
      return;
    }

    container.innerHTML = directions.map((direction) => {
      const directionId = Number(direction.direction_id);
      const safeDirectionId = Number.isFinite(directionId) ? directionId : 0;
      const safeTitle = escapeHtml(String(direction.title || `Направление ${safeDirectionId || '—'}`));
      const typeRaw = String(direction.direction_type || '').toLowerCase();
      const typeLabel = typeRaw === 'sport' ? 'Спорт' : 'Танцы';
      const basePriceValue = direction.base_price === null || direction.base_price === undefined ? '' : String(direction.base_price);
      const safeBasePriceValue = escapeHtml(basePriceValue);
      const currentPriceLabel = basePriceValue !== '' ? `${escapeHtml(basePriceValue)} ₽` : '—';

      return `
        <div class="card" style="margin-bottom: 10px;">
          <div style="display:flex; justify-content: space-between; align-items: center; gap: 8px; margin-bottom: 8px;">
            <div style="font-weight: 700; font-size: 15px;">${safeTitle}</div>
            <div class="small" style="white-space: nowrap;">${typeLabel}</div>
          </div>
          <div class="small" style="margin-bottom: 8px; color: var(--hint);">Текущая цена: ${currentPriceLabel}</div>
          <div class="work-price-row">
            <div class="work-price-input-wrap">
              <input class="form-input" id="work-price-input-${safeDirectionId}" type="number" min="0" step="1" placeholder="Например: 5000" value="${safeBasePriceValue}"/>
            </div>
            <button class="save-btn" type="button" style="margin:0;" onclick="saveWorkSettingsPrice(${safeDirectionId})">Сохранить цену</button>
          </div>
          <div class="work-price-status" id="work-price-status-${safeDirectionId}">—</div>
        </div>
      `;
    }).join('');
  } catch (error) {
    container.innerHTML = `<p class="small" style="text-align: center; color: #ffb3b3; padding: 20px;">❌ ${escapeHtml(String(error.message || 'Ошибка загрузки'))}</p>`;
  }
}

async function saveWorkSettingsPrice(directionId) {
  const inputEl = document.getElementById(`work-price-input-${directionId}`);
  if (!inputEl) return;

  const rawValue = String(inputEl.value || '').trim().replace(',', '.');
  if (!rawValue) {
    setWorkSettingsPriceStatus(directionId, 'Введите цену', true);
    return;
  }

  const parsed = Number(rawValue);
  if (!Number.isFinite(parsed) || parsed < 0) {
    setWorkSettingsPriceStatus(directionId, 'Цена должна быть числом 0 или больше', true);
    return;
  }

  const normalizedPrice = Math.round(parsed);
  setWorkSettingsPriceStatus(directionId, 'Сохранение...');
  try {
    const response = await fetch(`/api/directions/${directionId}`, {
      method: 'PUT',
      headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
      body: JSON.stringify({ base_price: normalizedPrice }),
    });
    const data = await response.json().catch(() => null);
    if (!response.ok) {
      throw new Error((data && data.error) ? data.error : 'Не удалось сохранить цену');
    }

    inputEl.value = String(normalizedPrice);
    setWorkSettingsPriceStatus(directionId, `Сохранено: ${normalizedPrice} ₽`);
    showNotification('✅ Цена обновлена');
    loadWorkSettingsPrices();
  } catch (error) {
    setWorkSettingsPriceStatus(directionId, String(error.message || 'Ошибка сохранения'), true);
    showNotification('❌ ' + (error.message || 'Не удалось сохранить цену'));
  }
}

function formatPaymentStatus(status) {
  const map = {
    pending: 'Ожидание оплаты',
    paid: 'Оплачено',
    failed: 'Ошибка',
    refunded: 'Возврат',
    cancelled: 'Отменено'
  };
  return map[status] || status || '?';
}

function formatAbonementStatus(status) {
  const map = {
    pending_activation: 'Ожидает активации',
    active: 'Активен',
    expired: 'Истек',
    blocked: 'Заблокирован'
  };
  return map[status] || status || '?';
}

function formatDate(dateString) {
  const date = new Date(dateString);
  return date.toLocaleDateString('ru-RU', { 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
}

/* ====== УПРАВЛЕНИЕ КЛИЕНТАМИ (ПЕРСОНАЛ) ====== */
let allClients = [];
let selectedClientForActions = null;
let clientExtendAbonements = [];
let clientExtendSelectedAbonement = null;
let clientExtendLessonsPerWeek = 1;
let clientExtendSyncLock = false;
let clientAttendanceMonth = null;
let clientAttendanceEntries = [];
let clientAttendanceSelectedDate = null;
let clientSickRangeMode = false;
let clientSickRangeStart = null;
let clientSickRangeEnd = null;
let clientSickDragActive = false;

async function loadAllClients() {
  try {
    const container = document.getElementById('clients-list-container');
    if (!container) return;
    container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">⏳ Загрузка...</p>';
    
    // Загружаем информацию о текущем пользователе (персонале)
    if (currentUserData) {
      displayStaffInfo(currentUserData);
    }
    
    const response = await fetch('/users/list/all', { headers: getAuthHeaders() });
    
    if (!response.ok) {
      container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">❌ Ошибка при загрузке клиентов</p>';
      return;
    }
    
    allClients = await response.json();
    
    if (allClients.length === 0) {
      container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">📭 Клиентов еще нет</p>';
      return;
    }
    
    displayClients(allClients);
    console.log(`? Загружено ${allClients.length} клиентов`);
  } catch (error) {
    console.error('Ошибка при загрузке клиентов:', error);
    const container = document.getElementById('clients-list-container');
    if (container) {
      container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">❌ Ошибка сети</p>';
    }
  }
}

function searchClients() {
  const input = document.getElementById('staff-search-input');
  const searchTerm = (input?.value || '').toLowerCase().trim();
  
  if (!searchTerm) {
    displayClients(allClients);
    return;
  }
  
  // Фильтруем по имени или ID
  const filtered = allClients.filter(client => 
    client.name.toLowerCase().includes(searchTerm) ||
    client.id.toString().includes(searchTerm)
  );
  
  displayClients(filtered);
}

function setClientCreateStatus(message, isError = false) {
  const statusEl = document.getElementById('client-create-status');
  if (!statusEl) return;
  statusEl.textContent = message || '';
  statusEl.style.color = isError ? '#ff6b6b' : 'var(--hint)';
}

function openCreateClientModal() {
  const overlayEl = document.getElementById('client-create-overlay');
  const modalEl = document.getElementById('client-create-modal');
  if (!overlayEl || !modalEl) return;

  const fieldIds = [
    'client-create-name',
    'client-create-telegram-id',
    'client-create-username',
    'client-create-phone',
    'client-create-email',
    'client-create-user-notes',
    'client-create-staff-notes'
  ];
  fieldIds.forEach((fieldId) => {
    const el = document.getElementById(fieldId);
    if (el) el.value = '';
  });
  setClientCreateStatus('');
  overlayEl.classList.add('show');
  modalEl.classList.add('show');
}

function closeCreateClientModal() {
  const overlayEl = document.getElementById('client-create-overlay');
  const modalEl = document.getElementById('client-create-modal');
  if (overlayEl) overlayEl.classList.remove('show');
  if (modalEl) modalEl.classList.remove('show');
}

async function submitCreateClient() {
  const name = (document.getElementById('client-create-name')?.value || '').trim();
  const telegramIdRaw = (document.getElementById('client-create-telegram-id')?.value || '').trim();
  const usernameRaw = (document.getElementById('client-create-username')?.value || '').trim();
  const phone = (document.getElementById('client-create-phone')?.value || '').trim();
  const email = (document.getElementById('client-create-email')?.value || '').trim();
  const userNotes = (document.getElementById('client-create-user-notes')?.value || '').trim();
  const staffNotes = (document.getElementById('client-create-staff-notes')?.value || '').trim();

  if (!name) {
    setClientCreateStatus('Введите имя клиента', true);
    return;
  }

  const payload = {
    name,
    username: usernameRaw ? usernameRaw.replace(/^@+/, '') : null,
    phone: phone || null,
    email: email || null,
    birth_date: null,
    user_notes: userNotes || null,
    staff_notes: staffNotes || null
  };

  if (telegramIdRaw) {
    const parsedTelegramId = Number(telegramIdRaw);
    if (!Number.isInteger(parsedTelegramId)) {
      setClientCreateStatus('Telegram ID должен быть целым числом', true);
      return;
    }
    payload.telegram_id = parsedTelegramId;
  }

  try {
    setClientCreateStatus('Создание клиента...');
    const response = await fetch('/users', {
      method: 'POST',
      headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
      body: JSON.stringify(payload)
    });

    let data = {};
    try {
      data = await response.json();
    } catch (e) {
      data = {};
    }

    if (!response.ok) {
      setClientCreateStatus(data.error || 'Не удалось создать клиента', true);
      return;
    }

    closeCreateClientModal();
    showNotification('Клиент создан');
    await loadAllClients();
  } catch (error) {
    console.error('Ошибка при создании клиента:', error);
    setClientCreateStatus('Ошибка сети', true);
  }
}

function setClientMergeStatus(message, isError = false) {
  const statusEl = document.getElementById('client-merge-status');
  if (!statusEl) return;
  statusEl.textContent = message || '';
  statusEl.style.color = isError ? '#ff6b6b' : 'var(--hint)';
}

function showActionTitlePopup(title) {
  const text = String(title || '').trim();
  if (!text) return;

  const existing = document.getElementById('action-title-popup');
  if (existing) existing.remove();

  const popup = document.createElement('div');
  popup.id = 'action-title-popup';
  popup.className = 'action-title-popup';
  popup.textContent = text;
  document.body.appendChild(popup);

  requestAnimationFrame(() => popup.classList.add('show'));

  setTimeout(() => {
    popup.classList.remove('show');
    setTimeout(() => popup.remove(), 220);
  }, 1400);
}

function _clientMergeOptionLabel(client) {
  const parts = [`#${client.id}`, client.name || 'Без имени'];
  if (client.username) parts.push(`@${client.username}`);
  if (client.telegram_id) parts.push(`tg:${client.telegram_id}`);
  return parts.join(' • ');
}

function populateMergeClientSelectors() {
  const sourceSelect = document.getElementById('client-merge-source-id');
  const targetSelect = document.getElementById('client-merge-target-id');
  if (!sourceSelect || !targetSelect) return;

  sourceSelect.innerHTML = '';
  targetSelect.innerHTML = '';

  const sortedClients = [...allClients].sort((a, b) => {
    const nameA = (a.name || '').toLowerCase();
    const nameB = (b.name || '').toLowerCase();
    if (nameA === nameB) return Number(a.id) - Number(b.id);
    return nameA.localeCompare(nameB, 'ru');
  });

  const sourcePlaceholder = document.createElement('option');
  sourcePlaceholder.value = '';
  sourcePlaceholder.textContent = 'Выберите профиль без Telegram ID';
  sourceSelect.appendChild(sourcePlaceholder);

  const targetPlaceholder = document.createElement('option');
  targetPlaceholder.value = '';
  targetPlaceholder.textContent = 'Выберите официальный профиль (с Telegram ID)';
  targetSelect.appendChild(targetPlaceholder);

  const sourceClients = sortedClients.filter((client) => !client.telegram_id);
  const targetClients = sortedClients.filter((client) => !!client.telegram_id);

  sourceClients.forEach((client) => {
    const label = _clientMergeOptionLabel(client);
    const sourceOption = document.createElement('option');
    sourceOption.value = String(client.id);
    sourceOption.textContent = label;
    sourceSelect.appendChild(sourceOption);
  });

  targetClients.forEach((client) => {
    const label = _clientMergeOptionLabel(client);
    const targetOption = document.createElement('option');
    targetOption.value = String(client.id);
    targetOption.textContent = label;
    targetSelect.appendChild(targetOption);
  });  

  if (sourceClients.length === 0) {
    const emptySource = document.createElement('option');
    emptySource.value = '';
    emptySource.textContent = 'Нет профилей без Telegram ID';
    sourceSelect.appendChild(emptySource);
  }
  if (targetClients.length === 0) {
    const emptyTarget = document.createElement('option');
    emptyTarget.value = '';
    emptyTarget.textContent = 'Нет профилей с Telegram ID';
    targetSelect.appendChild(emptyTarget);
  }
}

async function openMergeClientsModal() {
  if (!Array.isArray(allClients) || allClients.length === 0) {
    await loadAllClients();
  }

  populateMergeClientSelectors();
  const noteEl = document.getElementById('client-merge-note');
  if (noteEl) noteEl.value = '';
  setClientMergeStatus('');

  const overlayEl = document.getElementById('client-merge-overlay');
  const modalEl = document.getElementById('client-merge-modal');
  if (overlayEl) overlayEl.classList.add('show');
  if (modalEl) modalEl.classList.add('show');
  setModalBackHandler(closeMergeClientsModal);
  showActionTitlePopup('Объединение клиентов');
}

function closeMergeClientsModal() {
  const overlayEl = document.getElementById('client-merge-overlay');
  const modalEl = document.getElementById('client-merge-modal');
  if (overlayEl) overlayEl.classList.remove('show');
  if (modalEl) modalEl.classList.remove('show');
  setModalBackHandler(null);
}

async function submitMergeClients() {
  const sourceUserId = Number(document.getElementById('client-merge-source-id')?.value || 0);
  const targetUserId = Number(document.getElementById('client-merge-target-id')?.value || 0);
  const note = (document.getElementById('client-merge-note')?.value || '').trim();
  const sourceClient = allClients.find((client) => Number(client.id) === sourceUserId);
  const targetClient = allClients.find((client) => Number(client.id) === targetUserId);

  if (!Number.isInteger(sourceUserId) || sourceUserId <= 0) {
    setClientMergeStatus('Выберите source-профиль', true);
    return;
  }
  if (!Number.isInteger(targetUserId) || targetUserId <= 0) {
    setClientMergeStatus('Выберите target-профиль', true);
    return;
  }
  if (sourceUserId === targetUserId) {
    setClientMergeStatus('Нужно выбрать два разных профиля', true);
    return;
  }
  if (!sourceClient || sourceClient.telegram_id) {
    setClientMergeStatus('Source должен быть без Telegram ID', true);
    return;
  }
  if (!targetClient || !targetClient.telegram_id) {
    setClientMergeStatus('Target должен быть с Telegram ID', true);
    return;
  }

  const confirmed = confirm(`Объединить клиента #${sourceUserId} в #${targetUserId}?`);
  if (!confirmed) return;

  try {
    setClientMergeStatus('Объединение клиентов...');
    const response = await fetch('/api/admin/clients/merge', {
      method: 'POST',
      headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
      body: JSON.stringify({
        source_user_id: sourceUserId,
        target_user_id: targetUserId,
        note: note || null
      })
    });

    let data = {};
    try {
      data = await response.json();
    } catch (e) {
      data = {};
    }

    if (!response.ok) {
      setClientMergeStatus(data.error || 'Не удалось объединить профили', true);
      return;
    }

    closeMergeClientsModal();
    showNotification(`Профили объединены: #${sourceUserId} -> #${targetUserId}`);
    await loadAllClients();
  } catch (error) {
    console.error('Ошибка при объединении клиентов:', error);
    setClientMergeStatus('Ошибка сети', true);
  }
}

/* ====== ОТОБРАЖЕНИЕ ИНФОРМАЦИИ О ПЕРСОНАЛЕ ====== */
async function displayStaffInfo(userData) {
  try {
    // Получаем информацию о персонале
    const response = await fetch(`/staff/check/${userData.telegram_id}`);
    
    if (!response.ok) {
      console.error('Не удалось загрузить информацию о персонале');
      return;
    }
    
    const data = await response.json();
    
    if (data.is_staff && data.staff) {
      const staff = data.staff;
      window.currentStaffProfileName = staff.name || window.currentStaffProfileName;
      
      // Обновляем ФИО
      document.getElementById('staff-panel-name').textContent = staff.name;
      
      // Обновляем должность
      const positionText = staff.position.charAt(0).toUpperCase() + staff.position.slice(1);
      document.getElementById('staff-panel-position').textContent = positionText;
      
      // Обновляем фото
      if (staff.photo_path) {
        const img = document.getElementById('staff-panel-avatar-img');
        const mediaUrl = buildMediaUrl(staff.photo_path);
        if (mediaUrl) img.src = mediaUrl;
        img.style.display = 'block';
        document.querySelector('.staff-avatar-small p').style.display = 'none';
      }

      window.currentStaffProfileId = staff.id;
    }
  } catch (error) {
    console.error('Ошибка при загрузке информации о персонале:', error);
  }
}

async function openStaffProfileEdit() {
  if (!currentUserData) {
    showNotification('⚠️ Профиль не загружен');
    return;
  }

  try {
    const response = await fetch(`/staff/check/${currentUserData.telegram_id}`);
    if (!response.ok) {
      showNotification('? Не удалось загрузить профиль');
      return;
    }
    const data = await response.json();
    if (!data.is_staff || !data.staff) {
      showNotification('? Профиль персонала не найден');
      return;
    }

    const staff = data.staff;
    window.currentStaffProfileId = staff.id;
    document.getElementById('staff-profile-name').value = staff.name || '';
    document.getElementById('staff-profile-specialization').value = staff.specialization || '';
    document.getElementById('staff-profile-bio').value = staff.bio || '';
    document.getElementById('staff-profile-phone').value = staff.phone || '';
    document.getElementById('staff-profile-email').value = staff.email || '';
    const teachesGroup = document.getElementById('staff-profile-teaches-group');
    const teachesCheckbox = document.getElementById('staff-profile-teaches');
    if (teachesCheckbox) {
      teachesCheckbox.checked = !!staff.teaches;
    }
    if (teachesGroup) {
      const canEditTeaches = ['владелец', 'старший админ', 'тех. админ'].includes((currentStaffPosition || '').toLowerCase());
      teachesGroup.style.display = canEditTeaches ? 'block' : 'none';
    }

    showPage('staff-profile-edit');
  } catch (error) {
    console.error('Ошибка при открытии профиля персонала:', error);
    showNotification('❌ Ошибка сети');
  }
}

async function saveStaffProfile() {
  const staffId = window.currentStaffProfileId;
  if (!staffId) {
    showNotification('? ID персонала не найден');
    return;
  }

  const name = document.getElementById('staff-profile-name').value.trim();
  const specialization = document.getElementById('staff-profile-specialization').value.trim();
  const bio = document.getElementById('staff-profile-bio').value.trim();
  const phone = document.getElementById('staff-profile-phone').value.trim();
  const email = document.getElementById('staff-profile-email').value.trim();
  const teachesCheckbox = document.getElementById('staff-profile-teaches');
  const canEditTeaches = ['владелец', 'старший админ', 'тех. админ'].includes((currentStaffPosition || '').toLowerCase());

  try {
    const payload = {
      name: name || null,
      specialization: specialization || null,
      bio: bio || null,
      phone: phone || null,
      email: email || null
    };
    if (canEditTeaches && teachesCheckbox) {
      payload.teaches = teachesCheckbox.checked ? 1 : 0;
    }
    const response = await fetch(`/staff/${staffId}`, {
      method: 'PUT',
      headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
      body: JSON.stringify(payload)
    });

    const data = await response.json();
    if (!response.ok) {
      showNotification('? ' + (data.error || 'Не удалось сохранить'));
      return;
    }

    showNotification('? Профиль обновлен');
    if (currentUserData) {
      displayStaffInfo(currentUserData);
    }
    goBack();
  } catch (error) {
    console.error('Ошибка при сохранении профиля персонала:', error);
    showNotification('❌ Ошибка сети');
  }
}

// ====== РАБОЧИЕ ЧАСЫ ПРЕПОДАВАТЕЛЯ ======
let workingHoursView = 'week';
let currentWorkingHoursTeacherId = null;
let teacherWorkingHours = [];
let nonWorkingSlots = new Set();
let workingHoursDragActive = false;
let workingHoursDragValue = null;
let workingHoursDragBound = false;

const WORKING_WEEKDAY_LABELS = [
  'Понедельник',
  'Вторник',
  'Среда',
  'Четверг',
  'Пятница',
  'Суббота',
  'Воскресенье'
];
const WORKING_WEEKDAY_SHORT = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'];

function openTeacherWorkingHours() {
  const staffId = window.currentStaffProfileId;
  if (!staffId) {
    showNotification('? ID персонала не найден');
    return;
  }
  currentWorkingHoursTeacherId = staffId;
  workingHoursView = 'week';
  const daySelect = document.getElementById('working-hours-day-select');
  if (daySelect) {
    daySelect.value = '0';
  }
  loadTeacherWorkingHours();
  showPage('teacher-working-hours');
}

function setWorkingHoursView(view) {
  workingHoursView = view;
  const weekBtn = document.getElementById('working-hours-view-week');
  const dayBtn = document.getElementById('working-hours-view-day');
  if (weekBtn && dayBtn) {
    weekBtn.classList.toggle('active', view === 'week');
    dayBtn.classList.toggle('active', view === 'day');
  }
  const daySelectGroup = document.getElementById('working-hours-day-select-group');
  if (daySelectGroup) {
    daySelectGroup.style.display = view === 'day' ? 'block' : 'none';
  }
  renderWorkingHoursEditor();
}

async function loadTeacherWorkingHours() {
  if (!currentWorkingHoursTeacherId) return;
  try {
    const response = await fetch(`/teacher-working-hours/${currentWorkingHoursTeacherId}`, {
      headers: getAuthHeaders()
    });
    const data = await response.json();
    if (!response.ok) {
      showNotification('? ' + (data.error || 'Не удалось загрузить рабочие часы'));
      return;
    }
    teacherWorkingHours = Array.isArray(data) ? data : [];
    buildNonWorkingSlots();
    renderWorkingHoursEditor();
  } catch (error) {
    console.error('Ошибка при загрузке рабочих часов:', error);
    showNotification('❌ Ошибка сети');
  }
}

function renderWorkingHoursEditor() {
  const container = document.getElementById('working-hours-container');
  if (!container) return;

  container.innerHTML = renderWorkingHoursGrid();
  bindWorkingHoursDrag(container);
}

function getAllSlotTimes() {
  const slots = [];
  for (let t = WORK_START_HOUR * 60; t < WORK_END_HOUR * 60; t += SLOT_MINUTES) {
    slots.push(minutesToTime(t));
  }
  return slots;
}

function buildNonWorkingSlots() {
  const activeIntervals = teacherWorkingHours.filter(i => i.status !== 'archived');
  if (activeIntervals.length === 0) {
    nonWorkingSlots = new Set();
    return;
  }

  const allSlots = new Set();
  const slotTimes = getAllSlotTimes();
  for (let d = 0; d <= 6; d++) {
    for (const time of slotTimes) {
      allSlots.add(`${d}|${time}`);
    }
  }

  activeIntervals.forEach(i => {
      if (!i.time_from || !i.time_to) return;
      const start = timeToMinutes(i.time_from);
      const end = timeToMinutes(i.time_to);
      for (let t = start; t < end; t += SLOT_MINUTES) {
        allSlots.delete(`${i.weekday}|${minutesToTime(t)}`);
      }
    });

  nonWorkingSlots = allSlots;
}

function renderWorkingHoursGrid() {
  const slots = getAllSlotTimes();

  if (workingHoursView === 'day') {
    const weekday = parseInt(document.getElementById('working-hours-day-select')?.value || '0', 10);
    let html = `<div class="schedule-grid day">`;
    html += `<div class="schedule-cell head">Время</div><div class="schedule-cell head">${WORKING_WEEKDAY_LABELS[weekday]}</div>`;
    for (const time of slots) {
      const timeClass = isHalfHour(time) ? 'schedule-cell time half' : 'schedule-cell time';
      html += `<div class="${timeClass}">${formatTimeLabel(time)}</div>`;
      html += renderWorkingHoursSlotCell(weekday, time);
    }
    html += `</div>`;
    return html;
  }

  let html = `<div class="schedule-grid">`;
  html += `<div class="schedule-cell head">Время</div>`;
  for (let d = 0; d <= 6; d++) {
    html += `<div class="schedule-cell head">${WORKING_WEEKDAY_SHORT[d]}</div>`;
  }
  for (const time of slots) {
    const timeClass = isHalfHour(time) ? 'schedule-cell time half' : 'schedule-cell time';
    html += `<div class="${timeClass}">${formatTimeLabel(time)}</div>`;
    for (let d = 0; d <= 6; d++) {
      html += renderWorkingHoursSlotCell(d, time);
    }
  }
  html += `</div>`;
  return html;
}

function renderWorkingHoursSlotCell(weekday, timeStr) {
  const key = `${weekday}|${timeStr}`;
  const isNonWorking = nonWorkingSlots.has(key);
  const className = isNonWorking ? 'schedule-cell schedule-slot non-working' : 'schedule-cell schedule-slot';
  return `<div class="${className}" data-wh-slot="1" data-weekday="${weekday}" data-time="${timeStr}" onclick="toggleWorkingHoursSlot(${weekday}, '${timeStr}')"></div>`;
}

function toggleWorkingHoursSlot(weekday, timeStr) {
  const key = `${weekday}|${timeStr}`;
  if (nonWorkingSlots.has(key)) {
    nonWorkingSlots.delete(key);
  } else {
    nonWorkingSlots.add(key);
  }
  renderWorkingHoursEditor();
}

function setNonWorkingSlot(weekday, timeStr, makeNonWorking, cellEl) {
  const key = `${weekday}|${timeStr}`;
  if (makeNonWorking) {
    nonWorkingSlots.add(key);
    if (cellEl) cellEl.classList.add('non-working');
  } else {
    nonWorkingSlots.delete(key);
    if (cellEl) cellEl.classList.remove('non-working');
  }
}

function bindWorkingHoursDrag(container) {
  if (workingHoursDragBound) return;
  workingHoursDragBound = true;

  container.addEventListener('pointerdown', (event) => {
    const target = event.target.closest('[data-wh-slot]');
    if (!target) return;
    event.preventDefault();
    const weekday = parseInt(target.dataset.weekday, 10);
    const timeStr = target.dataset.time;
    const isNonWorking = nonWorkingSlots.has(`${weekday}|${timeStr}`);
    workingHoursDragActive = true;
    workingHoursDragValue = !isNonWorking;
    setNonWorkingSlot(weekday, timeStr, workingHoursDragValue, target);
  });

  container.addEventListener('pointerover', (event) => {
    if (!workingHoursDragActive) return;
    const target = event.target.closest('[data-wh-slot]');
    if (!target) return;
    const weekday = parseInt(target.dataset.weekday, 10);
    const timeStr = target.dataset.time;
    setNonWorkingSlot(weekday, timeStr, workingHoursDragValue, target);
  });

  window.addEventListener('pointerup', () => {
    workingHoursDragActive = false;
    workingHoursDragValue = null;
  });
}

function buildIntervalsFromSlots() {
  const byDay = new Map();
  const slotTimes = getAllSlotTimes();
  for (let day = 0; day <= 6; day++) {
    for (const timeStr of slotTimes) {
      const key = `${day}|${timeStr}`;
      if (!nonWorkingSlots.has(key)) {
        if (!byDay.has(day)) byDay.set(day, []);
        byDay.get(day).push(timeToMinutes(timeStr));
      }
    }
  }

  const items = [];
  for (let day = 0; day <= 6; day++) {
    const times = (byDay.get(day) || []).sort((a, b) => a - b);
    if (times.length === 0) continue;
    let start = times[0];
    let prev = times[0];
    for (let i = 1; i < times.length; i++) {
      const t = times[i];
      if (t === prev + SLOT_MINUTES) {
        prev = t;
        continue;
      }
      items.push({
        weekday: day,
        time_from: minutesToTime(start),
        time_to: minutesToTime(prev + SLOT_MINUTES)
      });
      start = t;
      prev = t;
    }
    items.push({
      weekday: day,
      time_from: minutesToTime(start),
      time_to: minutesToTime(prev + SLOT_MINUTES)
    });
  }
  return items;
}

async function saveTeacherWorkingHours() {
  if (!currentWorkingHoursTeacherId) {
    showNotification('? ID персонала не найден');
    return;
  }
  const items = buildIntervalsFromSlots();
  try {
    const response = await fetch(`/teacher-working-hours/${currentWorkingHoursTeacherId}`, {
      method: 'PUT',
      headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
      body: JSON.stringify({ items })
    });
    const data = await response.json();
    if (!response.ok) {
      showNotification('? ' + (data.error || 'Не удалось сохранить'));
      return;
    }
    teacherWorkingHours = Array.isArray(data.items) ? data.items : teacherWorkingHours;
    buildNonWorkingSlots();
    showNotification('? Рабочие часы сохранены');
    renderWorkingHoursEditor();
  } catch (error) {
    console.error('Ошибка при сохранении рабочих часов:', error);
    showNotification('❌ Ошибка сети');
  }
}

function displayClients(clients) {
  const container = document.getElementById('clients-list-container');
  if (!container) return;
  
  if (clients.length === 0) {
    container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">Клиентов не найдено</p>';
    return;
  }

  const getStatusLabel = (status) => {
    const key = String(status || '').toLowerCase();
    if (key === 'active') return 'Активен';
    if (key === 'inactive') return 'Неактивен';
    if (key === 'frozen') return 'Заморозка';
    return status || '—';
  };

  const getStatusClass = (status) => {
    const key = String(status || '').toLowerCase();
    if (key === 'active') return 'status-active';
    if (key === 'inactive') return 'status-inactive';
    if (key === 'frozen') return 'status-frozen';
    return '';
  };
  
  container.innerHTML = clients.map(client => `
    <div class="client-card" onclick="viewClientDetails(${client.id})">
      <div class="client-card-header">
        <div class="client-card-name">${client.name}</div>
        <div class="client-card-status ${getStatusClass(client.status)}">${getStatusLabel(client.status)}</div>
      </div>
      <div class="client-meta-line">
        ${client.phone ? `<span class="client-meta-strong">${client.phone}</span>` : 'Телефон не указан'}
        ${client.email ? ` • ${client.email}` : ''}
        ${client.username ? ` • @${client.username}` : ''}
      </div>
      ${client.user_notes ? `<div class="client-card-notes">Пожелания: ${client.user_notes}</div>` : ''}
      ${client.staff_notes ? `<div class="client-card-notes">Заметки: ${client.staff_notes}</div>` : ''}
    </div>
  `).join('');
}

function viewClientDetails(userId) {
  const client = allClients.find(c => Number(c.id) === Number(userId));
  if (!client) {
    showNotification('Клиент не найден');
    return;
  }

  selectedClientForActions = client;

  const nameEl = document.getElementById('client-detail-name');
  const metaEl = document.getElementById('client-detail-meta');
  const modalEl = document.getElementById('client-detail-modal');
  const overlayEl = document.getElementById('client-detail-overlay');

  if (!nameEl || !metaEl || !modalEl || !overlayEl) {
    showNotification('Окно клиента недоступно');
    return;
  }

  const metaParts = [
    `ID: ${client.id}`,
    client.username ? `@${client.username}` : null,
    client.phone || null,
    client.email || null,
  ].filter(Boolean);

  nameEl.textContent = client.name || 'Без имени';
  metaEl.textContent = metaParts.join(' • ') || '—';

  overlayEl.classList.add('show');
  modalEl.classList.add('show');
}

function closeClientDetailModal() {
  const modalEl = document.getElementById('client-detail-modal');
  const overlayEl = document.getElementById('client-detail-overlay');
  if (overlayEl) overlayEl.classList.remove('show');
  if (modalEl) modalEl.classList.remove('show');
}

function _clientActionMetaParts(client) {
  if (!client) return [];
  return [
    `ID: ${client.id}`,
    client.username ? `@${client.username}` : null,
    client.phone || null,
    client.email || null,
  ].filter(Boolean);
}

function _clientMonthLabel(monthDate) {
  return monthDate.toLocaleDateString('ru-RU', { year: 'numeric', month: 'long' });
}

function _clientMonthParam(monthDate) {
  const y = monthDate.getFullYear();
  const m = String(monthDate.getMonth() + 1).padStart(2, '0');
  return `${y}-${m}`;
}

function _normalizeClientSickRange(startIso, endIso) {
  if (!startIso && !endIso) return { start: null, end: null };
  if (startIso && !endIso) return { start: startIso, end: startIso };
  if (!startIso && endIso) return { start: endIso, end: endIso };
  return startIso <= endIso
    ? { start: startIso, end: endIso }
    : { start: endIso, end: startIso };
}

function _isDateInClientSickRange(isoDate) {
  if (!clientSickRangeStart && !clientSickRangeEnd) return false;
  const norm = _normalizeClientSickRange(clientSickRangeStart, clientSickRangeEnd);
  if (!norm.start || !norm.end) return false;
  return isoDate >= norm.start && isoDate <= norm.end;
}

function _syncClientSickInputsFromRange() {
  const fromEl = document.getElementById('client-calendar-sick-date-from');
  const toEl = document.getElementById('client-calendar-sick-date-to');
  const norm = _normalizeClientSickRange(clientSickRangeStart, clientSickRangeEnd);
  if (fromEl) fromEl.value = norm.start || '';
  if (toEl) toEl.value = norm.end || '';
}

function _updateClientSickRangeToggleUi() {
  const startBtn = document.getElementById('client-sick-range-start-btn');
  const actionsWrap = document.getElementById('client-sick-bottom-actions');
  const confirmBtn = document.getElementById('client-sick-confirm-btn');
  const cancelBtn = document.getElementById('client-sick-cancel-btn');

  const norm = _normalizeClientSickRange(clientSickRangeStart, clientSickRangeEnd);
  const hasRange = Boolean(norm.start && norm.end);

  if (startBtn) {
    if (clientSickRangeMode) {
      startBtn.textContent = 'Выбор периода: ВКЛ';
      startBtn.style.background = 'var(--accent)';
      startBtn.style.color = '#111';
    } else {
      startBtn.textContent = 'Выбрать период на календаре';
      startBtn.style.background = '';
      startBtn.style.color = '';
    }
  }
  if (actionsWrap) actionsWrap.style.display = (clientSickRangeMode || hasRange) ? 'flex' : 'none';
  if (confirmBtn) confirmBtn.disabled = !hasRange;
  if (cancelBtn) cancelBtn.disabled = !hasRange && !clientSickRangeMode;
}

function startClientSickRangeSelection() {
  clientSickRangeMode = true;
  clientSickDragActive = false;
  clientSickRangeStart = null;
  clientSickRangeEnd = null;
  _syncClientSickInputsFromRange();
  const statusEl = document.getElementById('client-calendar-sick-status');
  if (statusEl) statusEl.textContent = 'Выберите период на календаре (две даты или протяжка)';
  _updateClientSickRangeToggleUi();
  const monthLabel = document.getElementById('client-calendar-month-label');
  if (monthLabel) monthLabel.scrollIntoView({ behavior: 'smooth', block: 'start' });
  _renderClientAttendanceCalendar(clientAttendanceEntries, clientAttendanceMonth);
}

function cancelClientSickRange() {
  clientSickRangeMode = false;
  clientSickDragActive = false;
  clientSickRangeStart = null;
  clientSickRangeEnd = null;
  _syncClientSickInputsFromRange();
  const statusEl = document.getElementById('client-calendar-sick-status');
  if (statusEl) statusEl.textContent = 'Выбор периода отменен';
  _updateClientSickRangeToggleUi();
  _renderClientAttendanceCalendar(clientAttendanceEntries, clientAttendanceMonth);
}

function confirmClientSickRange() {
  const norm = _normalizeClientSickRange(clientSickRangeStart, clientSickRangeEnd);
  if (!norm.start || !norm.end) {
    showNotification('Сначала выберите период');
    return;
  }
  clientSickRangeMode = false;
  clientSickDragActive = false;
  _syncClientSickInputsFromRange();
  _updateClientSickRangeToggleUi();
  submitClientSickLeave();
}

function onClientSickDateInputsChanged() {
  const fromEl = document.getElementById('client-calendar-sick-date-from');
  const toEl = document.getElementById('client-calendar-sick-date-to');
  clientSickRangeStart = (fromEl?.value || '').trim() || null;
  clientSickRangeEnd = (toEl?.value || '').trim() || null;
  _updateClientSickRangeToggleUi();
  _renderClientAttendanceCalendar(clientAttendanceEntries, clientAttendanceMonth);
}

function startClientSickRangeDrag(isoDate) {
  if (!clientSickRangeMode) return;
  clientSickDragActive = true;
  clientSickRangeStart = isoDate;
  clientSickRangeEnd = isoDate;
  _syncClientSickInputsFromRange();
  _renderClientAttendanceCalendar(clientAttendanceEntries, clientAttendanceMonth);
}

function extendClientSickRangeDrag(isoDate) {
  if (!clientSickRangeMode || !clientSickDragActive) return;
  clientSickRangeEnd = isoDate;
  _syncClientSickInputsFromRange();
  _renderClientAttendanceCalendar(clientAttendanceEntries, clientAttendanceMonth);
}

function finishClientSickRangeDrag(isoDate) {
  if (!clientSickRangeMode) return;
  clientSickDragActive = false;
  clientSickRangeEnd = isoDate;
  _syncClientSickInputsFromRange();
  _renderClientAttendanceCalendar(clientAttendanceEntries, clientAttendanceMonth);
}

function _clientCalendarStartGrid(monthDate) {
  const first = new Date(monthDate.getFullYear(), monthDate.getMonth(), 1);
  const weekdayMondayBased = (first.getDay() + 6) % 7;
  const start = new Date(first);
  start.setDate(first.getDate() - weekdayMondayBased);
  return start;
}

function _renderClientAttendanceCalendar(entries, monthDate) {
  const container = document.getElementById('client-calendar-grid');
  if (!container) return;
  const monthLabelEl = document.getElementById('client-calendar-month-label');
  if (monthLabelEl) monthLabelEl.textContent = _clientMonthLabel(monthDate);

  const list = Array.isArray(entries) ? [...entries] : [];
  list.sort((a, b) => `${a.date || ''} ${a.time_from || ''}`.localeCompare(`${b.date || ''} ${b.time_from || ''}`));

  const statusInfo = (status) => {
    if (status === 'present' || status === 'late') return { code: 'П', label: 'Пришел', color: '#2e7d32' };
    if (status === 'absent') return { code: 'Н', label: 'Неявка', color: '#c62828' };
    if (status === 'sick') return { code: 'Б', label: 'Больничный', color: '#ef6c00' };
    return { code: '', label: 'Записан', color: '#455a64' };
  };

  const byDate = new Map();
  list.forEach(item => {
    const key = item.date;
    if (!byDate.has(key)) byDate.set(key, []);
    byDate.get(key).push(item);
  });

  const todayIso = formatDateLocal(new Date());
  const monthStart = new Date(monthDate.getFullYear(), monthDate.getMonth(), 1);
  if (!clientAttendanceSelectedDate) {
    clientAttendanceSelectedDate = byDate.has(todayIso) ? todayIso : _clientMonthParam(monthDate) + '-01';
  }
  if (!String(clientAttendanceSelectedDate).startsWith(_clientMonthParam(monthDate))) {
    clientAttendanceSelectedDate = _clientMonthParam(monthDate) + '-01';
  }

  const weekHeads = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'];
  const firstWeekday = (monthStart.getDay() + 6) % 7;
  const gridStart = new Date(monthStart);
  gridStart.setDate(monthStart.getDate() - firstWeekday);

  const headHtml = weekHeads.map(day => `<div class="public-calendar-head">${day}</div>`).join('');
  let cellsHtml = '';
  for (let i = 0; i < 42; i++) {
    const cellDate = new Date(gridStart);
    cellDate.setDate(gridStart.getDate() + i);
    const iso = formatDateLocal(cellDate);
    const isCurrentMonth = cellDate.getMonth() === monthStart.getMonth();
    const isToday = iso === todayIso;
    const isSelected = iso === clientAttendanceSelectedDate;
    const isRange = _isDateInClientSickRange(iso);
    const items = byDate.get(iso) || [];
    const shown = items.slice(0, 2);
    const hidden = Math.max(0, items.length - shown.length);
    const eventsHtml = shown.map(row => {
      const s = statusInfo(row.status);
      return `
        <div class="public-calendar-event" style="pointer-events:none;">
          <span style="display:inline-flex; align-items:center; justify-content:center; width:14px; height:14px; border-radius:999px; background:${s.color}; color:#fff; font-size:9px; font-weight:700; line-height:1;">${s.code || ''}</span>
          <span class="public-calendar-event-text">${row.time_from ? row.time_from : ''}</span>
        </div>
      `;
    }).join('');

    cellsHtml += `
      <div class="public-calendar-cell ${isCurrentMonth ? '' : 'is-outside'} ${isToday ? 'is-today' : ''} ${isSelected ? 'is-selected' : ''} ${isRange ? 'is-range' : ''}" onclick="setClientAttendanceDate('${iso}')" onpointerdown="startClientSickRangeDrag('${iso}')" onpointerenter="extendClientSickRangeDrag('${iso}')" onpointerup="finishClientSickRangeDrag('${iso}')">
        <div class="public-calendar-day">${cellDate.getDate()}</div>
        <div class="public-calendar-events">
          ${eventsHtml}
          ${hidden > 0 ? `<div class="small" style="font-size:10px; color:var(--hint);">+${hidden}</div>` : ''}
        </div>
      </div>
    `;
  }

  const selectedRows = (byDate.get(clientAttendanceSelectedDate) || []).slice().sort((a, b) => {
    return `${a.time_from || ''}`.localeCompare(`${b.time_from || ''}`);
  });
  const selectedLabel = new Date(clientAttendanceSelectedDate + 'T00:00:00').toLocaleDateString('ru-RU', {
    day: 'numeric', month: 'long', weekday: 'long'
  });
  const agendaHtml = selectedRows.length
    ? selectedRows.map(row => {
      const s = statusInfo(row.status);
      const duration = (row.time_from && row.time_to) ? `${row.time_from} - ${row.time_to}` : 'Время не указано';
      return `
        <div class="public-schedule-item" style="grid-template-columns:72px 1fr 10px;">
          <div class="public-schedule-time">
            <span style="display:inline-flex; align-items:center; justify-content:center; width:22px; height:22px; border-radius:999px; font-size:12px; font-weight:700; background:${s.color}; color:#fff;">${s.code || ''}</span>
            <span class="public-time">${row.time_from || '—'}</span>
          </div>
          <div>
            <div class="public-info-title">${row.group_name || 'Группа'}</div>
            <div class="public-info-sub">${row.direction_title || 'Направление'}</div>
            <div class="public-info-sub">${duration} • Статус: ${s.label}</div>
          </div>
          <div></div>
        </div>
      `;
    }).join('')
    : '<p class="small" style="text-align:center; color:var(--hint); margin:4px 0 0;">На выбранный день занятий нет</p>';

  container.innerHTML = `
    <div class="public-calendar-grid">${headHtml}${cellsHtml}</div>
    <div class="public-calendar-agenda">
      <div class="public-calendar-agenda-title">${selectedLabel}</div>
      <div class="public-schedule-list" style="margin-top:0;">${agendaHtml}</div>
    </div>
  `;
}

function setClientAttendanceDate(dateStr) {
  if (clientSickRangeMode && !clientSickDragActive) {
    if (!clientSickRangeStart || (clientSickRangeStart && clientSickRangeEnd && clientSickRangeStart !== clientSickRangeEnd)) {
      clientSickRangeStart = dateStr;
      clientSickRangeEnd = dateStr;
    } else {
      clientSickRangeEnd = dateStr;
    }
    _syncClientSickInputsFromRange();
  }
  clientAttendanceSelectedDate = dateStr;
  _renderClientAttendanceCalendar(clientAttendanceEntries, clientAttendanceMonth);
}

async function loadClientAttendanceCalendar() {
  if (!selectedClientForActions) return;
  const statusEl = document.getElementById('client-calendar-status');
  if (!clientAttendanceMonth) {
    const now = new Date();
    clientAttendanceMonth = new Date(now.getFullYear(), now.getMonth(), 1);
  }
  if (statusEl) statusEl.textContent = 'Загрузка...';

  try {
    const monthParam = _clientMonthParam(clientAttendanceMonth);
    const response = await fetch(`/api/admin/clients/${selectedClientForActions.id}/attendance-calendar?month=${monthParam}`, {
      headers: getAuthHeaders()
    });
    const data = await response.json().catch(() => ({}));
    if (!response.ok) {
      if (statusEl) statusEl.textContent = data.error || 'Не удалось загрузить календарь';
      return;
    }
    clientAttendanceEntries = Array.isArray(data.entries) ? data.entries : [];
    if (!clientAttendanceSelectedDate || !String(clientAttendanceSelectedDate).startsWith(_clientMonthParam(clientAttendanceMonth))) {
      const today = formatDateLocal(new Date());
      clientAttendanceSelectedDate = clientAttendanceEntries.some(e => e.date === today)
        ? today
        : `${_clientMonthParam(clientAttendanceMonth)}-01`;
    }
    _renderClientAttendanceCalendar(clientAttendanceEntries, clientAttendanceMonth);
    if (statusEl) statusEl.textContent = '';
  } catch (error) {
    console.error('Ошибка загрузки календаря посещаемости:', error);
    if (statusEl) statusEl.textContent = 'Ошибка сети';
  }
}

function shiftClientAttendanceMonth(offset) {
  if (!clientAttendanceMonth) {
    const now = new Date();
    clientAttendanceMonth = new Date(now.getFullYear(), now.getMonth(), 1);
  }
  clientAttendanceMonth = new Date(clientAttendanceMonth.getFullYear(), clientAttendanceMonth.getMonth() + offset, 1);
  clientAttendanceSelectedDate = `${_clientMonthParam(clientAttendanceMonth)}-01`;
  loadClientAttendanceCalendar();
}

function openClientAttendanceCalendarScreen() {
  if (!selectedClientForActions) {
    showNotification('Клиент не выбран');
    return;
  }

  const nameEl = document.getElementById('client-calendar-screen-name');
  const metaEl = document.getElementById('client-calendar-screen-meta');
  if (!nameEl || !metaEl) {
    showNotification('Экран календаря недоступен');
    return;
  }

  const client = selectedClientForActions;
  nameEl.textContent = client.name || 'Без имени';
  metaEl.textContent = _clientActionMetaParts(client).join(' • ') || '—';
  const sickFromEl = document.getElementById('client-calendar-sick-date-from');
  const sickToEl = document.getElementById('client-calendar-sick-date-to');
  const sickNoteEl = document.getElementById('client-calendar-sick-note');
  const sickStatusEl = document.getElementById('client-calendar-sick-status');
  if (sickFromEl) sickFromEl.value = '';
  if (sickToEl) sickToEl.value = '';
  if (sickNoteEl) sickNoteEl.value = '';
  if (sickStatusEl) sickStatusEl.textContent = '';
  clientSickRangeMode = false;
  clientSickRangeStart = null;
  clientSickRangeEnd = null;
  clientSickDragActive = false;
  _updateClientSickRangeToggleUi();
  const now = new Date();
  clientAttendanceMonth = new Date(now.getFullYear(), now.getMonth(), 1);
  clientAttendanceSelectedDate = formatDateLocal(now);
  clientAttendanceEntries = [];

  closeClientDetailModal();
  showPage('client-attendance-calendar');
  loadClientAttendanceCalendar();
}

async function openClientAbonementExtendScreen() {
  if (!selectedClientForActions) {
    showNotification('Клиент не выбран');
    return;
  }

  const nameEl = document.getElementById('client-extend-screen-name');
  const metaEl = document.getElementById('client-extend-screen-meta');
  const statusEl = document.getElementById('client-extend-status');
  if (!nameEl || !metaEl || !statusEl) {
    showNotification('Экран продления недоступен');
    return;
  }

  const client = selectedClientForActions;
  nameEl.textContent = client.name || 'Без имени';
  metaEl.textContent = _clientActionMetaParts(client).join(' • ') || '—';
  statusEl.textContent = 'Загрузка абонементов...';

  closeClientDetailModal();
  showPage('client-abonement-extend');
  await loadClientAbonementsForExtend();
}

function _renderClientExtendAbonementSelect() {
  const selectEl = document.getElementById('client-extend-abonement-select');
  if (!selectEl) return;
  if (!clientExtendAbonements.length) {
    selectEl.innerHTML = '<option value="">Нет активных абонементов</option>';
    selectEl.disabled = true;
    clientExtendSelectedAbonement = null;
    return;
  }
  selectEl.disabled = false;
  selectEl.innerHTML = clientExtendAbonements.map(item => {
    const label = `${item.direction_title || 'Направление'} • ${item.group_name || 'Группа'} (остаток: ${item.balance_credits ?? 0})`;
    return `<option value="${item.id}">${label}</option>`;
  }).join('');
  selectEl.value = String(clientExtendAbonements[0].id);
  clientExtendSelectedAbonement = clientExtendAbonements[0];
}

function _applyClientExtendValues(weeksValue) {
  const weeks = Math.max(1, parseInt(weeksValue, 10) || 1);
  const lessons = weeks * clientExtendLessonsPerWeek;
  const weeksInput = document.getElementById('client-extend-weeks-input');
  const weeksRange = document.getElementById('client-extend-weeks-range');
  const lessonsInput = document.getElementById('client-extend-lessons-input');
  const lessonsRange = document.getElementById('client-extend-lessons-range');
  if (!weeksInput || !weeksRange || !lessonsInput || !lessonsRange) return;

  clientExtendSyncLock = true;
  weeksInput.value = String(weeks);
  weeksRange.value = String(weeks);
  lessonsInput.value = String(lessons);
  lessonsRange.value = String(lessons);
  clientExtendSyncLock = false;
}

function _configureClientExtendControls() {
  const infoEl = document.getElementById('client-extend-abonement-info');
  const weeksInput = document.getElementById('client-extend-weeks-input');
  const weeksRange = document.getElementById('client-extend-weeks-range');
  const lessonsInput = document.getElementById('client-extend-lessons-input');
  const lessonsRange = document.getElementById('client-extend-lessons-range');
  const statusEl = document.getElementById('client-extend-status');
  if (!infoEl || !weeksInput || !weeksRange || !lessonsInput || !lessonsRange) return;

  if (!clientExtendSelectedAbonement) {
    infoEl.textContent = 'Выберите абонемент';
    if (statusEl) statusEl.textContent = 'Нет данных для продления';
    return;
  }

  clientExtendLessonsPerWeek = Math.max(1, Number(clientExtendSelectedAbonement.lessons_per_week) || 0);
  if (!clientExtendSelectedAbonement.lessons_per_week || clientExtendSelectedAbonement.lessons_per_week <= 0) {
    infoEl.textContent = 'В группе не настроено количество занятий в неделю';
    if (statusEl) statusEl.textContent = 'Невозможно связать недели и занятия';
    return;
  }

  const maxWeeks = 24;
  const maxLessons = maxWeeks * clientExtendLessonsPerWeek;

  weeksInput.min = '1';
  weeksInput.max = String(maxWeeks);
  weeksInput.step = '1';
  weeksRange.min = '1';
  weeksRange.max = String(maxWeeks);
  weeksRange.step = '1';

  lessonsInput.min = String(clientExtendLessonsPerWeek);
  lessonsInput.max = String(maxLessons);
  lessonsInput.step = String(clientExtendLessonsPerWeek);
  lessonsRange.min = String(clientExtendLessonsPerWeek);
  lessonsRange.max = String(maxLessons);
  lessonsRange.step = String(clientExtendLessonsPerWeek);

  const validToText = clientExtendSelectedAbonement.valid_to
    ? new Date(clientExtendSelectedAbonement.valid_to).toLocaleDateString('ru-RU')
    : 'не задан';
  infoEl.textContent =
    `Занятий в неделю: ${clientExtendLessonsPerWeek} • Остаток: ${clientExtendSelectedAbonement.balance_credits ?? 0} • Действует до: ${validToText}`;

  if (statusEl) statusEl.textContent = '';
  _applyClientExtendValues(1);
}

async function loadClientAbonementsForExtend() {
  if (!selectedClientForActions) return;
  const statusEl = document.getElementById('client-extend-status');
  try {
    const response = await fetch(`/api/admin/clients/${selectedClientForActions.id}/abonements`, {
      headers: getAuthHeaders()
    });
    const data = await response.json().catch(() => ({}));
    if (!response.ok) {
      if (statusEl) statusEl.textContent = data.error || 'Не удалось загрузить абонементы';
      return;
    }

    clientExtendAbonements = Array.isArray(data.items) ? data.items : [];
    _renderClientExtendAbonementSelect();
    _configureClientExtendControls();
    if (!clientExtendAbonements.length && statusEl) {
      statusEl.textContent = 'У клиента нет активных абонементов';
    }
  } catch (error) {
    console.error('Ошибка загрузки абонементов клиента:', error);
    if (statusEl) statusEl.textContent = 'Ошибка сети';
  }
}

function onClientExtendAbonementChange() {
  const selectEl = document.getElementById('client-extend-abonement-select');
  if (!selectEl) return;
  const selectedId = Number(selectEl.value);
  clientExtendSelectedAbonement = clientExtendAbonements.find(a => Number(a.id) === selectedId) || null;
  _configureClientExtendControls();
}

function syncClientExtendFromWeeksInput() {
  if (clientExtendSyncLock) return;
  const weeksInput = document.getElementById('client-extend-weeks-input');
  if (!weeksInput) return;
  _applyClientExtendValues(weeksInput.value);
}

function syncClientExtendFromWeeksRange() {
  if (clientExtendSyncLock) return;
  const weeksRange = document.getElementById('client-extend-weeks-range');
  if (!weeksRange) return;
  _applyClientExtendValues(weeksRange.value);
}

function _normalizeLessonsToWeeks(lessonsRaw) {
  if (!clientExtendLessonsPerWeek || clientExtendLessonsPerWeek <= 0) return 1;
  const lessonsNum = Math.max(clientExtendLessonsPerWeek, parseInt(lessonsRaw, 10) || clientExtendLessonsPerWeek);
  const weeks = Math.max(1, Math.round(lessonsNum / clientExtendLessonsPerWeek));
  return weeks;
}

function syncClientExtendFromLessonsInput() {
  if (clientExtendSyncLock) return;
  const lessonsInput = document.getElementById('client-extend-lessons-input');
  if (!lessonsInput) return;
  _applyClientExtendValues(_normalizeLessonsToWeeks(lessonsInput.value));
}

function syncClientExtendFromLessonsRange() {
  if (clientExtendSyncLock) return;
  const lessonsRange = document.getElementById('client-extend-lessons-range');
  if (!lessonsRange) return;
  _applyClientExtendValues(_normalizeLessonsToWeeks(lessonsRange.value));
}

async function submitClientAbonementExtend() {
  if (!clientExtendSelectedAbonement) {
    showNotification('Выберите абонемент');
    return;
  }
  const weeksInput = document.getElementById('client-extend-weeks-input');
  const lessonsInput = document.getElementById('client-extend-lessons-input');
  const noteEl = document.getElementById('client-extend-note');
  const statusEl = document.getElementById('client-extend-status');
  const weeks = Math.max(1, parseInt(weeksInput?.value || '1', 10) || 1);
  const lessons = Math.max(clientExtendLessonsPerWeek, parseInt(lessonsInput?.value || String(clientExtendLessonsPerWeek), 10) || clientExtendLessonsPerWeek);
  const note = (noteEl?.value || '').trim();

  if (statusEl) statusEl.textContent = 'Применяем продление...';
  try {
    const response = await fetch(`/api/admin/group-abonements/${clientExtendSelectedAbonement.id}/extend`, {
      method: 'POST',
      headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
      body: JSON.stringify({
        weeks,
        lessons,
        note: note || null,
      })
    });
    const data = await response.json().catch(() => ({}));
    if (!response.ok) {
      if (statusEl) statusEl.textContent = data.error || 'Не удалось продлить абонемент';
      showNotification('❌ ' + (data.error || 'Не удалось продлить абонемент'));
      return;
    }

    if (statusEl) {
      statusEl.textContent = `Готово: +${data.applied?.weeks || weeks} нед. и +${data.applied?.lessons || lessons} занятий`;
    }
    showNotification(`✅ Продление применено: +${data.applied?.weeks || weeks} нед. / +${data.applied?.lessons || lessons} занятий`);
    await loadClientAbonementsForExtend();
  } catch (error) {
    console.error('Ошибка при продлении абонемента:', error);
    if (statusEl) statusEl.textContent = 'Ошибка сети';
    showNotification('❌ Ошибка сети');
  }
}

async function submitClientSickLeave() {
  if (!selectedClientForActions) {
    showNotification('Клиент не выбран');
    return;
  }

  const dateFromEl = document.getElementById('client-calendar-sick-date-from');
  const dateToEl = document.getElementById('client-calendar-sick-date-to');
  const noteEl = document.getElementById('client-calendar-sick-note');
  const statusEl = document.getElementById('client-calendar-sick-status');
  const dateFrom = (dateFromEl?.value || '').trim();
  const dateTo = (dateToEl?.value || '').trim();
  const note = (noteEl?.value || '').trim();

  if (!dateFrom || !dateTo) {
    if (statusEl) statusEl.textContent = 'Укажите обе даты';
    return;
  }

  if (statusEl) statusEl.textContent = 'Применяем больничный...';
  _updateClientSickRangeToggleUi();

  try {
    const response = await fetch(`/api/admin/clients/${selectedClientForActions.id}/sick-leave`, {
      method: 'POST',
      headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
      body: JSON.stringify({
        date_from: dateFrom,
        date_to: dateTo,
        note: note || null
      })
    });

    const data = await response.json().catch(() => ({}));
    if (!response.ok) {
      if (statusEl) statusEl.textContent = data.error || 'Не удалось применить больничный';
      showNotification('❌ ' + (data.error || 'Не удалось применить больничный'));
      return;
    }

    if (statusEl) {
      statusEl.textContent =
        `Готово: занятий ${data.affected_schedules || 0}, возвращено ${data.refunded_credits || 0}, продлено абонементов ${data.extended_abonements || 0}`;
    }
    clientSickRangeStart = null;
    clientSickRangeEnd = null;
    _syncClientSickInputsFromRange();
    _updateClientSickRangeToggleUi();
    await loadClientAttendanceCalendar();
    showNotification(
      `✅ Больничный применен: занятий ${data.affected_schedules || 0}, возвращено ${data.refunded_credits || 0}, продлено абонементов ${data.extended_abonements || 0}`
    );
  } catch (error) {
    console.error('Ошибка при применении больничного:', error);
    if (statusEl) statusEl.textContent = 'Ошибка сети';
    showNotification('❌ Ошибка сети');
  }
}

/* ====== РАБОТА С ФОТО ПРОФИЛЯ ====== */
function displayProfilePhoto(photoPath) {
  const img = document.getElementById('profile-photo-img');
  const placeholder = document.getElementById('profile-photo-placeholder');
  
  const mediaUrl = buildMediaUrl(photoPath);
  if (mediaUrl) {
    img.src = mediaUrl;
  }
  img.style.display = 'block';
  placeholder.style.display = 'none';
}

async function uploadProfilePhoto() {
  if (!isStaff) {
    showNotification('? Загрузка фото доступна только для персонала');
    return;
  }
  
  if (!currentUserData) {
    showNotification('? Данные профиля не загружены');
    return;
  }
  
  const fileInput = document.getElementById('profile-photo-input');
  if (!fileInput.files || fileInput.files.length === 0) {
    showNotification('⚠️ Выберите файл');
    return;
  }
  
  const file = fileInput.files[0];
  const userId = currentUserData.id;
  
  // Проверяем размер
  if (file.size > 5 * 1024 * 1024) {
    showNotification('? Размер файла не должен превышать 5 МБ');
    return;
  }
  
  try {
    const formData = new FormData();
    formData.append('photo', file);
    
    console.log('Загружаем фото...');
    
    const response = await fetch(`/users/${userId}/photo`, {
      method: 'POST',
      body: formData
    });
    
    if (response.ok) {
      const data = await response.json();
      currentUserData.photo_path = data.photo_path;
      displayProfilePhoto(data.photo_path);
      showNotification('? Фото успешно загружено!');
      fileInput.value = '';
    } else {
      const error = await response.json();
      showNotification('? Ошибка: ' + (error.error || 'неизвестная ошибка'));
    }
  } catch (error) {
    console.error('Ошибка при загрузке фото:', error);
    showNotification('❌ Ошибка при загрузке фото');
  }
}

async function deleteProfilePhoto() {
  if (!isStaff) {
    showNotification('? Удаление фото доступно только для персонала');
    return;
  }
  
  if (!currentUserData) {
    showNotification('? Данные профиля не загружены');
    return;
  }
  
  if (!currentUserData.photo_path) {
    showNotification('⚠️ Фото не найдено');
    return;
  }
  
  try {
    const response = await fetch(`/users/${currentUserData.id}/photo`, {
      method: 'DELETE'
    });
    
    if (response.ok) {
      currentUserData.photo_path = null;
      
      const img = document.getElementById('profile-photo-img');
      const placeholder = document.getElementById('profile-photo-placeholder');
      img.style.display = 'none';
      placeholder.style.display = 'block';
      
      showNotification('? Фото удалено!');
    } else {
      const error = await response.json();
      showNotification('? Ошибка: ' + (error.error || 'неизвестная ошибка'));
    }
  } catch (error) {
    console.error('Ошибка при удалении фото:', error);
    showNotification('? Ошибка при удалении фото');
  }
}

/* ====== АВТОМАТИЧЕСКАЯ РЕГИСТРАЦИЯ ====== */
async function registerUserIfNeeded(user) {
  try {
    await authSessionPromise;
    // Проверяем, зарегистрирован ли уже пользователь
    const checkResponse = await fetch('/users/me');
    
    if (checkResponse.ok) {
      // Пользователь уже зарегистрирован
      console.log('Пользователь уже в системе');
      return;
    }
    
    // Если пользователя нет, регистрируем его
    console.log('Регистрируем нового пользователя...');
    
    const registerResponse = await fetch('/users', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        telegram_id: user.id,
        username: user.username,
        phone: '',  // Пусто, заполнит в профиле
        name: user.first_name || 'Пользователь',
        email: null,
        birth_date: null,
        notes: null
      })
    });
    
    if (registerResponse.ok) {
      console.log('? Пользователь успешно зарегистрирован');
      showNotification('Добро пожаловать! Пожалуйста, заполните ваши данные.');
      
      // Даем время на регистрацию и загружаем профиль
      setTimeout(() => loadProfileData(), 1000);
    } else {
      const error = await registerResponse.json();
      console.error('Ошибка регистрации:', error);
    }
  } catch (error) {
    console.error('Ошибка при проверке регистрации:', error);
  }
}

/* DEBUG VERSION */
console.log("Mini App version:", new URLSearchParams(location.search).get("v"));

/* ====== STAFF PROFILE ====== */
const NEWS_CACHE_KEY = 'news_cache_v1';
const NEWS_ETAG_KEY = 'news_etag_v1';
let cachedNews = null;

function getCachedNews() {
  if (cachedNews) return cachedNews;
  try {
    const raw = localStorage.getItem(NEWS_CACHE_KEY);
    if (!raw) return null;
    const parsed = JSON.parse(raw);
    if (!Array.isArray(parsed)) return null;
    cachedNews = parsed;
    return parsed;
  } catch (err) {
    return null;
  }
}

function setCachedNews(news, etag) {
  cachedNews = news;
  try {
    localStorage.setItem(NEWS_CACHE_KEY, JSON.stringify(news));
    if (etag) {
      localStorage.setItem(NEWS_ETAG_KEY, etag);
    }
  } catch (err) {
    // ignore cache write errors
  }
}

function renderNewsList(news) {
  const container = document.getElementById('news-container');
  if (!container) return;

  if (!news || news.length === 0) {
    container.innerHTML = '<p class="news-empty">Новостей пока нет v-v</p>';
    return;
  }

  container.innerHTML = news.map(n => `
    <div class="news-item" onclick="showNewsDetail(${n.id})">
      ${n.photo_path ? `<img src="${n.photo_path}" alt="Новость">` : ''}
      <div class="news-item-title">${n.title}</div>
    </div>
  `).join('');
}

// Показать кэш сразу, если есть
const initialCachedNews = getCachedNews();
if (initialCachedNews) {
  renderNewsList(initialCachedNews);
}

async function loadNews() {
  try {
    const cached = getCachedNews();
    if (cached) {
      renderNewsList(cached);
    }

    const headers = {};
    const etag = localStorage.getItem(NEWS_ETAG_KEY);
    if (etag) {
      headers['If-None-Match'] = etag;
    }

    const response = await fetch('/news', { headers });
    if (response.status === 304) {
      return;
    }
    if (!response.ok) {
      throw new Error('Не удалось загрузить новости');
    }

    const news = await response.json();
    setCachedNews(news, response.headers.get('ETag'));
    renderNewsList(news);
  } catch (error) {
    console.error('Ошибка загрузки новостей:', error);
  }
}

async function loadNewsManage() {
  try {
    const response = await fetch('/news/manage', {
      headers: getAuthHeaders()
    });
    const news = await response.json();
    const container = document.getElementById('news-manage-container');
    
    if (news.length === 0) {
      container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">📭 Новостей пока нет</p>';
      return;
    }
    
    container.innerHTML = news.map(n => `
      <div class="card" style="cursor: pointer; margin-bottom: 12px;">
        ${n.photo_path ? `<div style="width: 100%; height: 150px; background: var(--hint); border-radius: 8px 8px 0 0; overflow: hidden; margin: -12px -12px 8px -12px;"><img src="${n.photo_path}" style="width: 100%; height: 100%; object-fit: cover;"></div>` : ''}
        <div style="font-weight: 600; font-size: 16px;">${n.title}</div>
        <div style="font-size: 12px; color: var(--hint); margin-top: 4px;">${new Date(n.created_at).toLocaleDateString('ru-RU')} ${n.status === 'archived' ? '📦 В архиве' : ''}</div>
        <div style="font-size: 13px; margin-top: 8px; color: var(--text);">${n.content.substring(0, 100)}...</div>
        <div style="display: flex; gap: 8px; margin-top: 8px;">
          ${n.status === 'active' ? `<button class="save-btn" onclick="archiveNews(${n.id})" style="flex: 1; background: #ffa940; margin: 0;">📦 Архив</button>` : `<button class="save-btn" onclick="restoreNews(${n.id})" style="flex: 1; background: #52c41a; margin: 0;">↩️ Вернуть</button>`}
          <button class="save-btn" onclick="deleteNews(${n.id})" style="flex: 1; background: #ff6b6b; margin: 0;">🗑️ Удалить</button>
        </div>
      </div>
    `).join('');
  } catch (error) {
    console.error('Ошибка загрузки новостей:', error);
    document.getElementById('news-manage-container').innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">❌ Ошибка при загрузке</p>';
  }
}

function toggleNewsCreate(show) {
  const overlay = document.getElementById('news-create-overlay');
  const modal = document.getElementById('news-create-modal');
  if (!overlay || !modal) return;
  if (show) {
    overlay.classList.add('show');
    modal.classList.add('show');
  } else {
    overlay.classList.remove('show');
    modal.classList.remove('show');
    document.getElementById('news-create-status').textContent = '';
    document.getElementById('news-create-title').value = '';
    document.getElementById('news-create-content').value = '';
    document.getElementById('news-create-photo').value = '';
    resetNewsPhotoPreview();
  }
}

function openNewsCreateModal() {
  toggleNewsCreate(true);
}

function triggerNewsPhoto() {
  const input = document.getElementById('news-create-photo');
  if (input) {
    input.value = '';
    input.click();
  }
}

function clearNewsPhoto() {
  const input = document.getElementById('news-create-photo');
  if (input) input.value = '';
  resetNewsPhotoPreview();
}

function resetNewsPhotoPreview() {
  const preview = document.getElementById('news-photo-preview');
  if (preview) {
    preview.innerHTML = '<span class="small" style="color: var(--hint);">Нет фото</span>';
  }
}

document.addEventListener('change', (e) => {
  if (e.target && e.target.id === 'news-create-photo') {
    const file = e.target.files?.[0];
    const preview = document.getElementById('news-photo-preview');
    if (!file || !preview) {
      resetNewsPhotoPreview();
      return;
    }
    const reader = new FileReader();
    reader.onload = () => {
      preview.innerHTML = `<img src="${reader.result}" alt="preview">`;
    };
    reader.readAsDataURL(file);
  }
});

async function submitNewsCreate() {
  const title = document.getElementById('news-create-title').value.trim();
  const content = document.getElementById('news-create-content').value.trim();
  const fileInput = document.getElementById('news-create-photo');
  const statusEl = document.getElementById('news-create-status');
  statusEl.textContent = '';

  if (!title || !content) {
    statusEl.textContent = 'Заполните заголовок и описание';
    return;
  }

  try {
    // 1) Создаем запись новости
    const createRes = await fetch('/news', {
      method: 'POST',
      headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
      body: JSON.stringify({ title, content })
    });
    if (!createRes.ok) {
      const err = await createRes.json().catch(() => null);
      throw new Error((err && err.error) || 'Не удалось создать новость');
    }
    const created = await createRes.json();

    // 2) Если есть файл — заливаем
    const file = fileInput.files?.[0];
    if (file) {
      const formData = new FormData();
      formData.append('photo', file);
      const uploadRes = await fetch(`/news/${created.id}/photo`, {
        method: 'POST',
        headers: getAuthHeaders(),
        body: formData
      });
      if (!uploadRes.ok) {
        const err = await uploadRes.json().catch(() => null);
        throw new Error((err && err.error) || 'Новость создана, но фото не загрузилось');
      }
    }

    statusEl.textContent = 'Готово';
    loadNewsManage();
    setTimeout(() => toggleNewsCreate(false), 400);
  } catch (err) {
    statusEl.textContent = err.message || 'Ошибка';
  }
}

async function openBotForCreateNews() {
  // Открываем бота для создания новости
  try {
    // Получаем имя бота с сервера
    const response = await fetch('/bot-username');
    const data = await response.json();
    const botUsername = data.bot_username || 'dance_studio_admin_bot';
    
    // Открываем бота с параметром start
    window.open(`https://t.me/${botUsername}?start=create_news`, '_blank');
  } catch (error) {
    console.error('Ошибка при получении имени бота:', error);
    window.open('https://t.me/dance_studio_admin_bot?start=create_news', '_blank');
  }
}

async function openBotForStaffPhoto() {
  const staffId = window.currentStaffProfileId;
  if (!staffId) {
    showNotification('? ID персонала не найден');
    return;
  }
  try {
    const response = await fetch('/bot-username');
    const data = await response.json();
    const botUsername = data.bot_username || 'dance_studio_admin_bot';
    const botLink = `https://t.me/${botUsername}?start=staff_photo_${staffId}`;
    if (tg?.openLink) {
      tg.openLink(botLink);
    } else {
      window.open(botLink, '_blank');
    }
  } catch (error) {
    window.open(`https://t.me/dance_studio_admin_bot?start=staff_photo_${staffId}`, '_blank');
  }
}

function openStaffPhotoPicker() {
  const input = document.getElementById('staff-profile-photo-input');
  if (input) {
    input.value = '';
    input.click();
  }
}

async function uploadStaffPhotoFromGallery() {
  const staffId = window.currentStaffProfileId;
  if (!staffId) {
    showNotification('? ID персонала не найден');
    return;
  }
  const input = document.getElementById('staff-profile-photo-input');
  const file = input?.files?.[0];
  if (!file) return;

  try {
    const formData = new FormData();
    formData.append('photo', file);

    const response = await fetch(`/staff/${staffId}/photo`, {
      method: 'POST',
      body: formData,
      headers: getAuthHeaders()
    });

    if (response.ok) {
      const data = await response.json();
      showNotification('? Фото загружено');
      if (data.photo_path) {
        const mediaUrl = buildMediaUrl(data.photo_path);
        const staffAvatar = document.getElementById('staff-panel-avatar-img');
        if (mediaUrl && staffAvatar) {
          staffAvatar.src = mediaUrl;
          staffAvatar.style.display = 'block';
          document.querySelector('.staff-avatar-small p').style.display = 'none';
        }
      }
      return;
    }

    const error = await response.json();
    showNotification('? ' + (error.error || 'Не удалось загрузить фото'));
  } catch (error) {
    console.error('Ошибка при загрузке фото персонала:', error);
    showNotification('❌ Ошибка сети при загрузке фото: ' + (error && error.message ? error.message : 'unknown'));
  }
}



async function deleteNews(newsId) {
  if (!confirm('Удалить эту новость?')) {
    return;
  }
  
  try {
    const response = await fetch(`/news/${newsId}`, {
      method: 'DELETE',
      headers: getAuthHeaders()
    });
    
    if (response.ok) {
      showNotification('? Новость удалена');
      loadNewsManage();
    } else {
      showNotification('? Ошибка при удалении');
    }
  } catch (error) {
    console.error('Ошибка при удалении новости:', error);
    showNotification('❌ Ошибка сети');
  }
}

async function archiveNews(newsId) {
  try {
    const response = await fetch(`/news/${newsId}/archive`, {
      method: 'PUT',
      headers: getAuthHeaders()
    });
    
    if (response.ok) {
      showNotification('? Новость отправлена в архив');
      loadNewsManage();
    } else {
      showNotification('? Ошибка при архивировании');
    }
  } catch (error) {
    console.error('Ошибка при архивировании новости:', error);
    showNotification('❌ Ошибка сети');
  }
}

async function restoreNews(newsId) {
  try {
    const response = await fetch(`/news/${newsId}/restore`, {
      method: 'PUT',
      headers: getAuthHeaders()
    });
    
    if (response.ok) {
      showNotification('? Новость восстановлена');
      loadNewsManage();
    } else {
      showNotification('? Ошибка при восстановлении');
    }
  } catch (error) {
    console.error('Ошибка при восстановлении новости:', error);
    showNotification('❌ Ошибка сети');
  }
}

function renderNewsDetail(newsItem) {
  document.getElementById('news-detail-title').innerText = newsItem.title;
  document.getElementById('news-detail-date').innerText = new Date(newsItem.created_at).toLocaleDateString('ru-RU', {
    day: 'numeric',
    month: 'long',
    year: 'numeric'
  });

  const photoContainer = document.getElementById('news-detail-photo-container');
  if (newsItem.photo_path) {
    photoContainer.innerHTML = `<img src="${newsItem.photo_path}" alt="Фото новости">`;
    photoContainer.style.height = '';
    photoContainer.style.marginBottom = '';
  } else {
    photoContainer.innerHTML = '';
    photoContainer.style.height = '0';
    photoContainer.style.marginBottom = '0';
  }

  document.getElementById('news-detail-content').innerText = newsItem.content;
  showPage('news-detail');
}

async function showNewsDetail(id) {
  try {
    const cached = getCachedNews();
    if (cached) {
      const newsItem = cached.find(n => n.id === id);
      if (newsItem) {
        renderNewsDetail(newsItem);
        return;
      }
    }

    const response = await fetch('/news');
    if (!response.ok) {
      throw new Error('Не удалось загрузить новость');
    }
    const news = await response.json();
    setCachedNews(news, response.headers.get('ETag'));
    const newsItem = news.find(n => n.id === id);
    if (newsItem) {
      renderNewsDetail(newsItem);
    }
  } catch (error) {
    console.error('Ошибка при загрузке новости:', error);
    showNotification('Ошибка при загрузке новости');
  }
}

function copyPhone(phone) {
  navigator.clipboard.writeText(phone).then(() => {
    // Показываем уведомление
    showNotification('Номер скопирован в буфер обмена!');
  }).catch(() => {
    alert('Не удалось скопировать номер');
  });
}

function openTelegram(username) {
  // Открываем Telegram в новой вкладке
  const telegramUrl = `https://t.me/${username.replace('@', '')}`;
  window.open(telegramUrl, '_blank');
}

function showNotification(message) {
  // Создаем простое уведомление
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--accent);
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 14px;
    z-index: 1000;
    animation: slideDown 0.3s ease-out;
  `;
  notification.innerText = message;
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.remove();
  }, 2000);
}

// Добавляем стили анимации
const style = document.createElement('style');
style.innerText = `
  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateX(-50%) translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
  }
`;
document.head.appendChild(style);

// Загружаем новости как можно раньше
document.addEventListener('DOMContentLoaded', loadNews);

// ======================== СИСТЕМА РАССЫЛОК ========================

// Хранилище для выбранных пользователей в рассылках
let selectedMailingUsers = new Map(); // { userId: userName }
let mailingAllUsers = []; // Все загруженные пользователи
let mailingsSendNow = true; // По умолчанию отправляем сейчас

function setMailingSendNow(value) {
  mailingsSendNow = value;
  
  // Обновляем стиль кнопок
  const nowBtn = document.getElementById('send-now-btn');
  const laterBtn = document.querySelectorAll('[onclick="setMailingSendNow(false)"]')[0];
  
  if (value) {
    nowBtn.style.background = 'var(--accent)';
    if (laterBtn) laterBtn.style.background = 'var(--hint)';
    document.getElementById('mailing-schedule-container').style.display = 'none';
  } else {
    nowBtn.style.background = 'var(--hint)';
    if (laterBtn) laterBtn.style.background = 'var(--accent)';
    document.getElementById('mailing-schedule-container').style.display = 'block';
  }
}

function onMailingTargetTypeChange() {
  const targetType = document.getElementById('mailing-target-type').value;
  const idContainer = document.getElementById('mailing-target-id-container');
  const usersContainer = document.getElementById('mailing-users-container');
  
  // Скрываем оба контейнера по умолчанию
  idContainer.style.display = 'none';
  usersContainer.style.display = 'none';
  
  // Показываем нужный контейнер
  if (targetType === 'user') {
    usersContainer.style.display = 'block';
    clearMailingUserSelection(); // Очищаем предыдущий выбор
    // Всегда загружаем пользователей
    loadMailingUsers();
  } else if (targetType === 'group' || targetType === 'direction' || targetType === 'tg_chat') {
    idContainer.style.display = 'block';
  }
}

async function loadMailingUsers() {
  try {
    console.log('Загрузка пользователей для рассылок...');
    
    // Загружаем всех пользователей
    const response = await fetch('/staff/search');
    if (!response.ok) {
      console.error('Ошибка при загрузке пользователей:', response.status);
      document.getElementById('mailing-users-search-results').innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 12px;">❌ Ошибка при загрузке</p>';
      return;
    }
    
    const users = await response.json();
    console.log('Загружено пользователей:', users.length);
    
    mailingAllUsers = users;
    displayMailingSearchResults(mailingAllUsers);
  } catch (error) {
    console.error('Ошибка при загрузке пользователей:', error);
    document.getElementById('mailing-users-search-results').innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 12px;">❌ Ошибка сети</p>';
  }
}

function searchMailingUsers() {
  const searchInput = document.getElementById('mailing-users-search');
  const search = searchInput.value.trim().toLowerCase();
  
  if (mailingAllUsers.length === 0) {
    console.log('Нет загруженных пользователей');
    return;
  }
  
  if (search.length === 0) {
    displayMailingSearchResults(mailingAllUsers);
    return;
  }
  
  let filtered = [];
  
  // Проверяем, ищет ли пользователь по юзернейму (с @)
  if (search.startsWith('@')) {
    // Поиск по юзернейму
    const usernameQuery = search.substring(1).toLowerCase();
    filtered = mailingAllUsers.filter(u => 
      u.username && u.username.toLowerCase().includes(usernameQuery)
    );
  } else {
    // Поиск по ID или имени
    filtered = mailingAllUsers.filter(u => 
      u.name.toLowerCase().includes(search) ||
      u.id.toString().includes(search)
    );
  }
  
  if (filtered.length === 0) {
    document.getElementById('mailing-users-search-results').innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 12px;">Пользователи не найдены</p>';
  } else {
    displayMailingSearchResults(filtered);
  }
}

function displayMailingSearchResults(users) {
  const resultsHtml = users.map(u => {
    const isSelected = selectedMailingUsers.has(u.id);
    const bgColor = isSelected ? 'var(--accent)' : 'var(--card)';
    const textColor = isSelected ? '#fff' : 'var(--text)';
    const borderColor = isSelected ? 'var(--accent)' : 'var(--border)';
    const safeName = u.name.replace(/'/g, "\\'").replace(/"/g, '\\"');
    
    return `
      <div style="padding: 10px 12px; cursor: pointer; background: ${bgColor}; color: ${textColor}; border-left: 4px solid ${borderColor}; margin-bottom: 8px; border-radius: 6px; transition: all 0.2s; hover-background: opacity(0.9);" onclick="toggleMailingUserSelection(${u.id}, '${safeName}')">
        <div style="font-weight: 600; font-size: 14px; display: flex; align-items: center; justify-content: space-between;">
          <span>${u.name}</span>
          ${isSelected ? '<span style="font-size: 16px;">✖️</span>' : ''}
        </div>
        <div class="small" style="opacity: 0.8; margin-top: 3px; font-size: 12px;">ID: ${u.id}${u.telegram_id ? ` • TG: ${u.telegram_id}` : ''}${u.username ? ` • @${u.username}` : ''}</div>
      </div>
    `;
  }).join('');
  
  document.getElementById('mailing-users-search-results').innerHTML = resultsHtml || '<p class="small" style="text-align: center; color: var(--hint); padding: 12px;">Нет пользователей</p>';
}

function clearMailingUserSelection() {
  selectedMailingUsers.clear();
  document.getElementById('mailing-selected-users').innerHTML = '<p class="small" style="color: var(--hint); width: 100%;">Выбрано: <span id="mailing-users-count">0</span></p>';
  document.getElementById('mailing-users-count').textContent = '0';
}

function toggleMailingUserSelection(userId, userName) {
  if (selectedMailingUsers.has(userId)) {
    selectedMailingUsers.delete(userId);
  } else {
    selectedMailingUsers.set(userId, userName);
  }
  
  updateMailingSelectedUsersDisplay();
  searchMailingUsers(); // Обновляем результаты поиска
}

function updateMailingSelectedUsersDisplay() {
  const container = document.getElementById('mailing-selected-users');
  const count = selectedMailingUsers.size;
  
  if (count === 0) {
    container.innerHTML = '<p class="small" style="color: var(--hint); width: 100%; text-align: center; padding: 8px 0;">Выбранных пользователей: <span id="mailing-users-count" style="font-weight: 600; color: var(--accent);">0</span></p>';
    return;
  }
  
  let html = '<p class="small" style="color: var(--hint); width: 100%; text-align: center; padding: 8px 0; margin-bottom: 8px;">Выбрано: <span id="mailing-users-count" style="font-weight: 600; color: var(--accent);">' + count + '</span></p>';
  
  for (const [userId, userName] of selectedMailingUsers) {
    const safeName = userName.replace(/'/g, "\\'").replace(/"/g, '\\"');
    html += `
      <div style="background: var(--accent); color: white; padding: 8px 12px; border-radius: 20px; display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 500; box-shadow: 0 2px 4px rgba(254, 88, 21, 0.22);">
        <span>👤 ${userName}</span>
        <span onclick="toggleMailingUserSelection(${userId}, '${safeName}')" style="cursor: pointer; font-weight: bold; opacity: 0.8; hover: opacity(1);">✖️</span>
      </div>
    `;
  }
  
  container.innerHTML = html;
}


async function createMailing() {
  try {
    const name = document.getElementById('mailing-name').value.trim();
    const description = document.getElementById('mailing-description').value.trim();
    const purpose = document.getElementById('mailing-purpose').value.trim();
    const targetType = document.getElementById('mailing-target-type').value;
    
    if (!name) {
      showNotification('? Введите название рассылки');
      return;
    }
    
    if (!purpose) {
      showNotification('? Введите назначение рассылки');
      return;
    }
    
    if (!targetType) {
      showNotification('? Выберите кому отправить');
      return;
    }
    
    // Если не "все пользователи", требуется ID
    let targetId = null;
    
    // Специальная обработка для пользователей
    if (targetType === 'user') {
      if (selectedMailingUsers.size === 0) {
        showNotification('? Выберите хотя бы одного пользователя');
        return;
      }
      // Для пользователей используем специальный формат (могут быть несколько)
      targetId = Array.from(selectedMailingUsers.keys()).join(',');
    } else if (targetType !== 'all') {
      // Для остальных типов требуется ID
      const targetIdInput = document.getElementById('mailing-target-id').value.trim();
      if (!targetIdInput) {
        showNotification('? Введите ID цели');
        return;
      }
      targetId = parseInt(targetIdInput);
    }
    
    // Если отправка позже, требуется дата
    let scheduledAt = null;
    if (!mailingsSendNow) {
      const scheduledAtInput = document.getElementById('mailing-scheduled-at').value;
      if (!scheduledAtInput) {
        showNotification('? Выберите дату и время отправки');
        return;
      }
      // datetime-local возвращает строку в формате "2026-01-23T19:11"
      // Преобразуем в ISO формат, сохраняя локальное время пользователя
      const [datePart, timePart] = scheduledAtInput.split('T');
      scheduledAt = `${datePart}T${timePart}:00`;  // Добавляем секунды если их нет
    }
    
    // Получаем ID создателя из localStorage или используем пример
    const staffId = localStorage.getItem('staff_id') || 1;
    
    const payload = {
      creator_id: parseInt(staffId),
      name: name,
      description: description || null,
      purpose: purpose,
      target_type: targetType,
      target_id: targetId,
      send_now: mailingsSendNow,
      scheduled_at: scheduledAt
    };
    
    const response = await fetch('/mailings', {
      method: 'POST',
      headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
      body: JSON.stringify(payload)
    });
    
    if (!response.ok) {
      const error = await response.json();
      showNotification('? ' + (error.error || 'Ошибка при создании рассылки'));
      return;
    }
    
    showNotification('? Рассылка создана успешно!');
    
    // Очищаем форму
    document.getElementById('mailing-name').value = '';
    clearMailingUserSelection();
    document.getElementById('mailing-description').value = '';
    document.getElementById('mailing-purpose').value = '';
    document.getElementById('mailing-target-type').value = '';
    document.getElementById('mailing-target-id').value = '';
    document.getElementById('mailing-scheduled-at').value = '';
    document.getElementById('mailing-users-search').value = '';
    document.getElementById('mailing-users-search-results').innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 12px;">Выберите тип рассылки "Выбранные пользователи" для поиска</p>';
    
    // Возвращаемся к списку рассылок
    setTimeout(() => {
      goBack();
      loadMailings();
    }, 1000);
    
  } catch (error) {
    console.error('Ошибка при создании рассылки:', error);
    showNotification('? Ошибка при создании рассылки');
  }
}

async function loadMailings() {
  try {
    const response = await fetch('/mailings', {
      headers: getAuthHeaders()
    });
    if (!response.ok) throw new Error('Ошибка сервера');
    
    const mailings = await response.json();
    const container = document.getElementById('mailings-container');
    
    if (mailings.length === 0) {
      container.innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">Рассылок не найдено</p>';
      return;
    }
    
    const statusLabels = {
      'pending': '? На ожидании',
      'scheduled': '📅 Запланирована',
      'sending': '📤 В процессе',
      'sent': '? Отправлено',
      'failed': '? Ошибка',
      'cancelled': '🚫 Отменено'
    };
    
    const mailingTypeLabels = {
      'manual': '👤 Ручная рассылка',
      'automatic': '🤖 Автоматическая рассылка'
    };
    
    let html = '';
    for (const m of mailings) {
      const statusLabel = statusLabels[m.status] || m.status;
      const mailingTypeLabel = mailingTypeLabels[m.mailing_type] || m.mailing_type;
      const sentTime = m.sent_at ? new Date(m.sent_at).toLocaleString('ru-RU') : '—';
      const scheduledTime = m.scheduled_at ? new Date(m.scheduled_at).toLocaleString('ru-RU') : '—';
      
      // Показываем кнопку отправки только для рассылок со статусом "pending"
      const sendButtonHtml = m.status === 'pending' ? `
        <button class="button small" style="width: 100%; margin-top: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);" onclick="sendMailingNow(${m.mailing_id})">
          📤 Отправить сейчас
        </button>
      ` : '';
      
      html += `
        <div class="card">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
            <h4 style="margin: 0;">${m.name}</h4>
            <span class="small" style="background: ${m.mailing_type === 'automatic' ? '#4CAF50' : 'var(--accent)'}; color: white; padding: 4px 10px; border-radius: 12px; font-weight: 500;">${mailingTypeLabel}</span>
          </div>
          <p class="small" style="color: var(--hint); margin: 8px 0;">
            <strong>Назначение:</strong> ${m.purpose}
          </p>
          <p class="small" style="color: var(--hint); margin: 8px 0;">
            <strong>Статус:</strong> ${statusLabel}
          </p>
          <p class="small" style="color: var(--hint); margin: 8px 0;">
            <strong>Кому:</strong> ${m.target_type} ${m.target_id ? '(ID: ' + m.target_id + ')' : ''}
          </p>
          ${m.description ? '<p class="small" style="color: var(--hint); margin: 8px 0; font-style: italic;">' + m.description + '</p>' : ''}
          <p class="small" style="color: var(--hint); margin: 8px 0; border-top: 1px solid var(--border); padding-top: 8px; margin-top: 8px;">
            Создана: ${new Date(m.created_at).toLocaleString('ru-RU')}<br>
            ${m.sent_at ? 'Отправлена: ' + sentTime + '<br>' : ''}
            ${m.scheduled_at && !m.sent_at ? 'Запланирована: ' + scheduledTime : ''}
          </p>
          ${sendButtonHtml}
        </div>
      `;
    }
    
    container.innerHTML = html;
  } catch (error) {
    console.error('Ошибка при загрузке рассылок:', error);
    document.getElementById('mailings-container').innerHTML = '<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">❌ Ошибка при загрузке</p>';
  }
}

async function sendMailingNow(mailingId) {
  try {
    const response = await fetch(`/mailings/${mailingId}/send`, {
      method: 'POST',
      headers: getAuthHeaders({ 'Content-Type': 'application/json' })
    });
    
    const data = await response.json();
    
    if (response.ok || response.status === 206) {
      showNotification('? Рассылка отправлена!');
      setTimeout(() => {
        loadMailings();
      }, 1000);
    } else {
      showNotification('? ' + (data.error || 'Ошибка при отправке'));
    }
  } catch (error) {
    console.error('Ошибка при отправке рассылки:', error);
    showNotification('? Ошибка при отправке рассылки');
  }
}

// Загружаем рассылки при отображении страницы
const originalShowPage = window.showPage;
window.showPage = function(pageId) {
  if (pageId === 'mailings') {
    loadMailings();
  }
  if (pageId === 'direction-create-form') {
    resetDirectionForm();
  }
  if (pageId === 'schedule-control') {
    initScheduleControl();
  } else {
    stopSchedulePolling();
  }
  return originalShowPage(pageId);
};

/* ====== УПРАВЛЕНИЕ НАПРАВЛЕНИЯМИ ====== */

async function createDirectionUploadSessionFromForm() {
  // Получаем данные из формы
  const title = document.getElementById('direction-title').value.trim();
  const description = document.getElementById('direction-description').value.trim();
  const price = document.getElementById('direction-price').value.trim();
  const directionType = document.getElementById('direction-type').value;
  
  // Проверяем обязательные поля
  if (!title) {
    showDirectionError('Введите название направления');
    return;
  }
  if (!description) {
    showDirectionError('Введите описание направления');
    return;
  }
  if (!directionType) {
    showDirectionError('Выберите тип направления');
    return;
  }
  if (!price || isNaN(price) || parseInt(price) <= 0) {
    showDirectionError('Введите корректную цену');
    return;
  }
  
  // Получаем Telegram ID админа
  const telegramUserId =
    tg?.initDataUnsafe?.user?.id ||
    ((typeof localStorage !== 'undefined' && localStorage.getItem('debug_telegram_id')) || '');
  if (!telegramUserId) {
    showDirectionError('Не удалось получить telegram_id (откройте WebApp в Telegram или задайте debug_telegram_id)');
    return null;
  }
  
  try {
    // Создаем сессию на сервере
    const response = await authFetch('/api/directions/create-session', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        telegram_user_id: telegramUserId,
        title: title,
        direction_type: directionType,
        description: description,
        base_price: parseInt(price, 10)
      })
    });
    
    let data = null;
    try {
      data = await response.json();
    } catch {
      data = null;
    }
    
    if (!response.ok) {
      showDirectionError((data && data.error) ? data.error : 'Ошибка при создании сессии');
      return null;
    }
    
    // Сохраняем токен в localStorage
    localStorage.setItem('direction_session_token', data.session_token);
    localStorage.setItem('direction_session_id', data.session_id);
    
    return { token: data.session_token, sessionId: data.session_id };
  } catch (error) {
    console.error('Ошибка:', error);
    showDirectionError('Ошибка сети: ' + error.message);
    return null;
  }
}

async function startDirectionGalleryUpload() {
  const session = await createDirectionUploadSessionFromForm();
  if (!session) return;

  window.pendingDirectionPhotoToken = session.token;

  const input = document.getElementById('direction-photo-file');
  if (!input) {
    showDirectionError('Не найден input для загрузки фото');
    return;
  }

  try {
    input.value = '';
    input.click();
  } catch (err) {
    console.error('Не удалось открыть file picker:', err);
    showDirectionError('Не удалось открыть галерею. Попробуйте еще раз.');
  }
}

async function onDirectionPhotoFileSelected(event) {
  const input = event?.target;
  const file = input?.files?.[0];
  if (!file) return;

  const token =
    window.pendingDirectionPhotoToken ||
    (typeof localStorage !== 'undefined' && localStorage.getItem('direction_session_token')) ||
    '';

  if (!token) {
    showDirectionError('Сначала создайте сессию загрузки');
    return;
  }

  const allowedTypes = new Set(['image/jpeg', 'image/png', 'image/webp']);
  if (file.type && !allowedTypes.has(file.type)) {
    showDirectionError('Поддерживаются только JPG/PNG/WEBP');
    return;
  }

  const status = document.getElementById('direction-photo-status');
  if (status) {
    status.innerHTML = '<p style="margin: 0; color: var(--hint); font-size: 14px;">⏳ Загружаем фотографию...</p>';
  }

  try {
    const formData = new FormData();
    formData.append('photo', file, file.name || 'photo');

    const response = await authFetch(`/api/directions/photo/${token}`, {
      method: 'POST',
      body: formData
    });

    let data = null;
    try {
      data = await response.json();
    } catch {
      data = null;
    }

    if (!response.ok) {
      showDirectionError((data && data.error) ? data.error : 'Ошибка при загрузке фото');
      if (status) {
        status.innerHTML = '<p style="margin: 0; color: var(--hint); font-size: 14px;">❌ Фотография не загружена</p>';
      }
      return;
    }

    // Обновляем UI сразу, без polling
    if (status) {
      status.innerHTML = '<p style="margin: 0; color: #4CAF50; font-size: 14px;">✅ Фотография загружена</p>';
    }

    const createBtn = document.getElementById('direction-create-btn');
    if (createBtn) {
      createBtn.style.opacity = '1';
      createBtn.disabled = false;
    }

    localStorage.setItem('direction_upload_token', token);
    window.pendingDirectionPhotoToken = null;

    showDirectionSuccess('Фотография успешно загружена! Теперь нажмите "Создать направление"');
  } catch (error) {
    console.error('Ошибка при загрузке фото:', error);
    showDirectionError('Ошибка сети: ' + error.message);
    if (status) {
      status.innerHTML = '<p style="margin: 0; color: var(--hint); font-size: 14px;">❌ Фотография не загружена</p>';
    }
  }
}

async function generateDirectionUploadToken() {
  const session = await createDirectionUploadSessionFromForm();
  if (!session) return;

  const token = session.token;

  // Сохраняем токен в буфер обмена для удобства
  navigator.clipboard.writeText(token).catch(() => {
    // ignore clipboard errors
  });

  // Открываем бота с параметром session_token
  const botUsername = 'dance_studio_tester_bot';
  const botLink = `https://t.me/${botUsername}?start=upload_${token}`;

  console.log('Открываем бота с ссылкой:', botLink);

  try {
    if (tg?.openLink) {
      tg.openLink(botLink);
    } else {
      window.open(botLink, '_blank');
    }

    showDirectionSuccess('? Бот открыт! Загрузите фотографию.');
    checkDirectionPhotoStatus(token);
  } catch (err) {
    console.error('Ошибка при открытии бота:', err);
    showDirectionError('Не удалось открыть бота. Попробуйте еще раз.');
  }
}

async function checkDirectionPhotoStatus(token) {
  try {
    // Проверяем статус каждую секунду
    const checkInterval = setInterval(async () => {
      try {
        const response = await fetch(`/api/directions/upload-complete/${token}`);
        
        if (response.ok) {
          const data = await response.json();
          
          if (data.status === 'photo_received') {
            clearInterval(checkInterval);
            
            // Обновляем UI
            document.getElementById('direction-photo-status').innerHTML = 
              '<p style="margin: 0; color: #4CAF50; font-size: 14px;">✅ Фотография загружена</p>';
            
            // Активируем кнопку создания
            document.getElementById('direction-create-btn').style.opacity = '1';
            document.getElementById('direction-create-btn').disabled = false;
            
            // Сохраняем токен для создания
            localStorage.setItem('direction_upload_token', token);
            
            showDirectionSuccess('Фотография успешно загружена! Теперь нажмите "Создать направление"');
          }
        }
      } catch (error) {
        // Ошибка при проверке - продолжаем проверять
      }
    }, 1000);
    
    // Останавливаем проверку через 5 минут
    setTimeout(() => clearInterval(checkInterval), 300000);
    
  } catch (error) {
    console.error('Ошибка при проверке статуса:', error);
  }
}

async function createDirection() {
  const token = localStorage.getItem('direction_upload_token');
  const directionType = document.getElementById('direction-type').value || 'dance';
  
  if (!token) {
    showDirectionError('Фотография не загружена. Пожалуйста, загрузите фотографию через бота.');
    return;
  }
  if (!directionType) {
    showDirectionError('Выберите тип направления');
    return;
  }
  
  try {
    const response = await fetch('/api/directions', {
      method: 'POST',
      headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
      body: JSON.stringify({
        session_token: token,
        direction_type: directionType,
        is_popular: 0
      })
    });
    
    const data = await response.json();
    
    if (!response.ok) {
      showDirectionError(data.error || 'Ошибка при создании направления');
      return;
    }
    
    // Очищаем форму и localStorage
    resetDirectionForm();
    localStorage.removeItem('direction_upload_token');
    localStorage.removeItem('direction_session_token');
    localStorage.removeItem('direction_session_id');
    
    showDirectionSuccess(`? Направление "${data.title}" успешно создано!`);
    
    // Возвращаемся в меню
    setTimeout(() => {
      goBack();
    }, 2000);
    
  } catch (error) {
    console.error('Ошибка:', error);
    showDirectionError('Ошибка сети: ' + error.message);
  }
}

function resetDirectionForm() {
  document.getElementById('direction-title').value = '';
  document.getElementById('direction-description').value = '';
  document.getElementById('direction-price').value = '';
  document.getElementById('direction-type').value = 'dance';
  document.getElementById('direction-photo-status').innerHTML = 
    '<p style="margin: 0; color: var(--hint); font-size: 14px;">❌ Фотография не загружена</p>';
  document.getElementById('direction-create-btn').disabled = true;
  document.getElementById('direction-create-btn').style.opacity = '0.5';
  document.getElementById('direction-error-msg').style.display = 'none';
  document.getElementById('direction-success-msg').style.display = 'none';
  localStorage.removeItem('direction_upload_token');
  localStorage.removeItem('direction_session_token');
  localStorage.removeItem('direction_session_id');
  window.pendingDirectionPhotoToken = null;
  const fileInput = document.getElementById('direction-photo-file');
  if (fileInput) fileInput.value = '';
}

function showDirectionError(message) {
  const errorDiv = document.getElementById('direction-error-msg');
  document.getElementById('direction-error-text').textContent = message;
  errorDiv.style.display = 'block';
  
  // Автоматически скрываем через 5 сек
  setTimeout(() => {
    errorDiv.style.display = 'none';
  }, 5000);
}

function showDirectionSuccess(message) {
  const successDiv = document.getElementById('direction-success-msg');
  document.getElementById('direction-success-text').textContent = message;
  successDiv.style.display = 'block';
  
  // Автоматически скрываем через 5 сек
  setTimeout(() => {
    successDiv.style.display = 'none';
  }, 5000);
}

/* ====== ЗАГРУЗКА И ОТОБРАЖЕНИЕ НАПРАВЛЕНИЙ ====== */

let currentDirectionTab = 'active'; // Текущая активная вкладка

async function loadDirections() {
  const container = document.getElementById('directions-groups-container');
  try {
    const response = await authFetch('/api/directions/manage');
    let payload = null;
    try {
      payload = await response.json();
    } catch {
      payload = null;
    }

    if (!response.ok) {
      const message = (payload && payload.error) ? payload.error : 'Ошибка загрузки направлений';
      if (container) {
        container.innerHTML = `<p class="small" style="text-align: center; color: #ffb3b3; padding: 20px;">❌ ${escapeHtml(String(message))}</p>`;
      }
      return;
    }

    const directions = Array.isArray(payload) ? payload : [];
    const activeDirections = directions.filter(d => d.status === 'active');
    const archivedDirections = directions.filter(d => d.status !== 'active');

    renderDirections(currentDirectionTab === 'active' ? activeDirections : archivedDirections);
  } catch (error) {
    console.error('Ошибка при загрузке направлений:', error);
    const message = error && error.message ? error.message : 'Ошибка сети';
    if (container) {
      container.innerHTML = `<p class="small" style="text-align: center; color: #ffb3b3; padding: 20px;">❌ ${escapeHtml(String(message))}</p>`;
    }
  }
}

function renderDirections(directions) {
  const container = document.getElementById('directions-groups-container');
  
  if (!directions || directions.length === 0) {
    const emptyText = currentDirectionTab === 'active' ? 'Активных направлений нет' : 'Архив пуст';
    container.innerHTML = `<p class="small" style="text-align: center; color: var(--hint); padding: 20px;">📭 ${emptyText}</p>`;
    return;
  }
  
  let html = '';
  
  directions.forEach(direction => {
    const statusColor = direction.status === 'active' ? '#4CAF50' : '#fe5815';
    const statusText = direction.status === 'active' ? '✅ Активное' : '⏸️ Неактивное';
    const popularBadge = direction.is_popular ? '? Популярное' : '';
    const typeBadge = direction.direction_type === 'sport' ? '🏅 Спортивное' : '💃 Танцевальное';
    
    const imageHtml = direction.image_path 
      ? `<img src="${direction.image_path}" style="width: 100%; height: 120px; object-fit: cover; border-radius: 8px; margin-bottom: 12px;">`
      : `<div style="width: 100%; height: 120px; background: #1f1f1f; border-radius: 8px; margin-bottom: 12px; display: flex; align-items: center; justify-content: center; color: var(--hint);">📸 Нет фото</div>`;
    
    html += `
      <div class="card" style="margin-bottom: 12px; border-left: 4px solid ${statusColor}; position: relative;">
        ${imageHtml}
        <h4 style="margin: 0 0 8px 0;">${direction.title}</h4>
        <p style="font-size: 13px; color: var(--hint); margin: 0 0 8px 0; line-height: 1.4;">${direction.description || 'Нет описания'}</p>
        
        <div style="display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap;">
          <span style="background: #1f1f1f; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${typeBadge}</span>
          <span style="background: #1f1f1f; padding: 4px 8px; border-radius: 4px; font-size: 12px;">💰 ${direction.base_price} ₽</span>
          <span style="background: #1f1f1f; padding: 4px 8px; border-radius: 4px; font-size: 12px; color: ${statusColor};">${statusText}</span>
          ${popularBadge ? `<span style="background: var(--accent-soft); color: var(--accent); padding: 4px 8px; border-radius: 4px; font-size: 12px;">${popularBadge}</span>` : ''}
        </div>
        
        <div style="font-size: 11px; color: var(--hint); margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border);">
          Создано: ${new Date(direction.created_at).toLocaleDateString('ru-RU')}
        </div>
        
        <div style="display: flex; gap: 8px; margin-top: 8px; align-items: center; justify-content: space-between;">
          <button class="save-btn" style="flex: 0 0 calc(100% - 48px); height: 40px; padding: 8px; font-size: 12px; background: var(--accent); border-radius: 8px;" onclick="editDirection(${direction.direction_id})">✏️ Редактировать</button>
          <button class="save-btn" style="width: 40px; height: 40px; padding: 0; font-size: 18px; background: #fe5815; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;" onclick="archiveDirection(${direction.direction_id})">🗑️</button>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

function switchDirectionTab(tab) {
  currentDirectionTab = tab;
  
  const activeTabBtn = document.getElementById('active-tab');
  const archivedTabBtn = document.getElementById('archived-tab');
  const indicator = document.querySelector('.tab-indicator');
  
  // Обновляем цвета текста вкладок
  activeTabBtn.style.color = tab === 'active' ? 'var(--accent)' : 'var(--hint)';
  archivedTabBtn.style.color = tab === 'archived' ? 'var(--accent)' : 'var(--hint)';
  
  // Анимируем индикатор
  const activeTab = tab === 'active' ? activeTabBtn : archivedTabBtn;
  const tabWidth = activeTab.offsetWidth;
  const tabLeft = activeTab.offsetLeft;
  
  indicator.style.width = tabWidth + 'px';
  indicator.style.transform = `translateX(${tabLeft}px)`;
  
  // Перезагружаем направления
  loadDirections();
}

function setDirectionEditLocked(locked) {
  window.directionEditLocked = locked;
  const editableFields = document.querySelectorAll('.direction-editable');
  const editPage = document.getElementById('direction-edit-form');

  editableFields.forEach(el => {
    if (el.tagName === 'BUTTON') {
      el.disabled = locked;
      el.style.opacity = locked ? '0.5' : '1';
      el.style.pointerEvents = locked ? 'none' : 'auto';
    } else {
      el.disabled = locked;
    }
  });

  const lockBtn = document.getElementById('direction-edit-lock-btn');
  const lockHint = document.getElementById('direction-edit-lock-hint');
  if (editPage) {
    if (locked) editPage.classList.add('direction-locked');
    else editPage.classList.remove('direction-locked');
  }
  if (lockBtn && lockHint) {
    if (locked) {
      lockBtn.textContent = '🔓';
      lockBtn.title = 'Разблокировать редактирование';
      lockHint.textContent = 'Поля заблокированы, чтобы избежать случайных изменений.';
    } else {
      lockBtn.textContent = '🔓';
      lockBtn.title = 'Заблокировать редактирование';
      lockHint.textContent = 'Редактирование разблокировано. Не забудьте сохранить изменения.';
    }
  }
}

function toggleDirectionEditLock() {
  setDirectionEditLocked(!window.directionEditLocked);
}

function editDirection(directionId) {
  // Сохраняем ID направления для использования в других функциях
  window.currentEditDirectionId = directionId;
  
  // Загружаем данные направления
  fetch(`/api/directions/${directionId}`)
    .then(r => r.json())
    .then(direction => {
      // Заполняем форму данными
      document.getElementById('edit-direction-title').value = direction.title || '';
      document.getElementById('edit-direction-description').value = direction.description || '';
      document.getElementById('edit-direction-price').value = direction.base_price || '';
      document.getElementById('edit-direction-type').value = direction.direction_type || 'dance';
      document.getElementById('edit-direction-status').value = direction.status || 'active';
      
      // Показываем фотографию если она есть
      if (direction.image_path) {
        const photoDiv = document.getElementById('edit-direction-photo-preview');
        photoDiv.innerHTML = `<img src="${direction.image_path}" style="width: 100%; height: 100%; object-fit: cover;">`;
      }
      
      // Загружаем группы
      loadDirectionGroups();
      
      // Переходим на страницу редактирования
      showPage('direction-edit-form');
      setDirectionEditLocked(true);
    })
    .catch(err => {
      alert('❌ Ошибка при загрузке данных: ' + err.message);
    });
}

function loadDirectionGroups() {
  const directionId = window.currentEditDirectionId;
  const groupsList = document.getElementById('edit-direction-groups-list');
  if (!directionId || !groupsList) return;

  groupsList.innerHTML = `<p style="text-align: center; color: var(--hint); padding: 12px; margin: 0;">⏳ Загрузка групп...</p>`;

  fetch(`/api/directions/${directionId}/groups`)
    .then(async groupsRes => {
      if (!groupsRes.ok) {
        const err = await groupsRes.json();
        throw new Error(err.error || 'Не удалось загрузить группы');
      }
      const groups = await groupsRes.json();

      // Рендерим группы
      if (!groups.length) {
        groupsList.innerHTML = `<p style="text-align: center; color: var(--hint); padding: 12px; margin: 0;">📭 Групп пока нет</p>`;
        return;
      }

      let html = '';
      groups.forEach(g => {
        html += `
          <div class="card" style="margin-bottom: 8px; border-left: 4px solid #4CAF50;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
              <div style="font-weight: 600; flex: 1;">${g.name}</div>
              <button class="lock-btn" title="Редактировать группу" onclick="openEditGroupPage(${g.id});">✏️</button>
            </div>
            <div class="small" style="margin-bottom: 6px;">Преподаватель: <b>${g.teacher_name || '—'}</b></div>
            <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 6px;">
              <span style="background: #1f1f1f; padding: 4px 8px; border-radius: 4px; font-size: 12px;">👶 ${g.age_group}</span>
              <span style="background: #1f1f1f; padding: 4px 8px; border-radius: 4px; font-size: 12px;">👥 ${g.max_students} учеников</span>
              <span style="background: #1f1f1f; padding: 4px 8px; border-radius: 4px; font-size: 12px;">⏱️ ${g.duration_minutes} мин</span>
              ${g.lessons_per_week ? `<span style="background: #1f1f1f; padding: 4px 8px; border-radius: 4px; font-size: 12px;">📆 ${g.lessons_per_week} в неделю</span>` : ''}
            </div>
            <div class="small">${g.description || 'Описание не указано'}</div>
          </div>
        `;
      });
      groupsList.innerHTML = html;
    })
    .catch(err => {
      groupsList.innerHTML = `<p style="text-align: center; color: #ffb3b3; padding: 12px; margin: 0;">❌ ${err.message}</p>`;
    });
}

function loadGroupTeachers() {
  const results = document.getElementById('group-teacher-search-results');
  if (!results) return;

  results.innerHTML = `<p class="small" style="text-align: center; color: var(--hint); padding: 12px 0;">⏳ Загрузка преподавателей...</p>`;

  fetch('/api/teachers')
    .then(async res => {
      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.error || 'Не удалось загрузить преподавателей');
      }
      return res.json();
    })
    .then(teachers => {
      window.groupTeachers = teachers || [];
      displayGroupTeacherResults(window.groupTeachers);
    })
    .catch(err => {
      results.innerHTML = `<p class="small" style="text-align: center; color: var(--hint); padding: 12px 0;">❌ ${err.message}</p>`;
    });
}

function searchGroupTeacher() {
  const input = document.getElementById('group-teacher-search');
  const query = (input?.value || '').trim().toLowerCase();
  const results = document.getElementById('group-teacher-search-results');
  if (!results) return;

  if (!window.groupTeachers) {
    results.innerHTML = `<p class="small" style="text-align: center; color: var(--hint); padding: 12px 0;">⏳ Загрузка преподавателей...</p>`;
    return;
  }

  if (!query) {
    displayGroupTeacherResults(window.groupTeachers);
    return;
  }

  const filtered = window.groupTeachers.filter(t => {
    const name = (t.name || '').toLowerCase();
    const username = (t.username || '').toLowerCase();
    const idStr = String(t.id || '');
    return name.includes(query) || username.includes(query) || idStr.includes(query);
  });

  if (!filtered.length) {
    results.innerHTML = `<p class="small" style="text-align: center; color: var(--hint); padding: 12px 0;">Преподаватели не найдены</p>`;
    return;
  }

  displayGroupTeacherResults(filtered);
}

function displayGroupTeacherResults(teachers) {
  const results = document.getElementById('group-teacher-search-results');
  if (!results) return;

  const html = teachers.map(t => {
    const safeName = (t.name || '—').replace(/'/g, "\\'").replace(/"/g, '\\"');
    const safeUsername = (t.username || '').replace(/'/g, "\\'").replace(/"/g, '\\"');
    const isSelected = window.selectedGroupTeacher && window.selectedGroupTeacher.id === t.id;
    const borderColor = isSelected ? 'var(--accent)' : 'var(--border)';
    const bgColor = isSelected ? 'var(--accent-soft)' : 'var(--card)';
    return `
      <div class="card" id="group-teacher-card-${t.id}" style="margin-bottom: 8px; cursor: pointer; background: ${bgColor}; border-left: 4px solid ${borderColor}; transition: all 0.2s;" onclick="selectGroupTeacher(${t.id}, '${safeName}', '${safeUsername}')">
        <div style="font-weight: 600; font-size: 14px;">
          ${t.name || '—'}
          ${isSelected ? ' ?' : ''}
        </div>
        <div style="font-size: 12px; color: var(--hint); margin-top: 2px;">ID: ${t.id}${t.username ? ` • @${t.username}` : ''}</div>
      </div>
    `;
  }).join('');

  results.innerHTML = html || '<p class="small" style="text-align: center; color: var(--hint); padding: 12px 0;">Нет преподавателей</p>';
}

function selectGroupTeacher(id, name, username) {
  window.selectedGroupTeacher = { id, name, username };
  displayGroupTeacherResults(window.groupTeachers || []);
}

function openCreateGroupPage() {
  if (!window.currentEditDirectionId) {
    alert('? Сначала откройте направление для редактирования');
    return;
  }
  showPage('direction-group-create');
  window.selectedGroupTeacher = null;
  document.getElementById('group-teacher-search').value = '';
  document.getElementById('edit-direction-group-lessons').value = '';
  loadGroupTeachers();
}

function setDirectionGroupMessage(text, isError) {
  const msg = document.getElementById('edit-direction-group-msg');
  if (!msg) return;
  msg.style.display = 'block';
  msg.style.background = isError ? 'rgba(244, 67, 54, 0.18)' : 'rgba(76, 175, 80, 0.2)';
  msg.style.color = isError ? '#c62828' : '#2e7d32';
  msg.textContent = text;
  setTimeout(() => {
    msg.style.display = 'none';
  }, 4000);
}

function createDirectionGroup() {
  const directionId = window.currentEditDirectionId;
  if (!directionId) {
    setDirectionGroupMessage('? ID направления не найден', true);
    return;
  }

  const name = document.getElementById('edit-direction-group-name').value.trim();
  const teacherId = window.selectedGroupTeacher ? window.selectedGroupTeacher.id : null;
  const ageGroup = document.getElementById('edit-direction-group-age').value.trim();
  const maxStudents = document.getElementById('edit-direction-group-max').value;
  const durationMinutes = document.getElementById('edit-direction-group-duration').value;
  const lessonsPerWeek = document.getElementById('edit-direction-group-lessons').value;
  const description = document.getElementById('edit-direction-group-desc').value.trim();

  if (!name || !teacherId || !ageGroup || !maxStudents || !durationMinutes) {
    setDirectionGroupMessage('? Заполните обязательные поля', true);
    return;
  }

  authFetch(`/api/directions/${directionId}/groups`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      name,
      teacher_id: parseInt(teacherId, 10),
      age_group: ageGroup,
      max_students: parseInt(maxStudents, 10),
      duration_minutes: parseInt(durationMinutes, 10),
      lessons_per_week: lessonsPerWeek ? parseInt(lessonsPerWeek, 10) : null,
      description
    })
  })
    .then(async r => {
      const data = await r.json();
      if (!r.ok) throw new Error(data.error || 'Не удалось создать группу');
      return data;
    })
    .then(() => {
      document.getElementById('edit-direction-group-name').value = '';
      document.getElementById('edit-direction-group-age').value = '';
      document.getElementById('edit-direction-group-max').value = '';
      document.getElementById('edit-direction-group-duration').value = '';
      document.getElementById('edit-direction-group-lessons').value = '';
      document.getElementById('edit-direction-group-desc').value = '';
      document.getElementById('group-teacher-search').value = '';
      window.selectedGroupTeacher = null;
      setDirectionGroupMessage('? Группа создана', false);
      loadDirectionGroups();
      setTimeout(() => {
        goBack();
      }, 600);
    })
    .catch(err => {
      setDirectionGroupMessage('? ' + err.message, true);
    });
}

function setEditGroupMessage(text, isError) {
  const msg = document.getElementById('edit-group-msg');
  if (!msg) return;
  msg.style.display = 'block';
  msg.style.background = isError ? 'rgba(244, 67, 54, 0.18)' : 'rgba(76, 175, 80, 0.2)';
  msg.style.color = isError ? '#c62828' : '#2e7d32';
  msg.textContent = text;
  setTimeout(() => {
    msg.style.display = 'none';
  }, 4000);
}

function loadEditGroupTeachers() {
  const results = document.getElementById('edit-group-teacher-search-results');
  if (!results) return;

  results.innerHTML = `<p class="small" style="text-align: center; color: var(--hint); padding: 12px 0;">⏳ Загрузка преподавателей...</p>`;

  fetch('/api/teachers')
    .then(async res => {
      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.error || 'Не удалось загрузить преподавателей');
      }
      return res.json();
    })
    .then(teachers => {
      window.editGroupTeachers = teachers || [];
      // Предвыбор по teacher_id
      if (window.editGroupPreselectTeacherId) {
        const selected = window.editGroupTeachers.find(t => t.id === window.editGroupPreselectTeacherId);
        if (selected) {
          window.selectedEditGroupTeacher = { id: selected.id, name: selected.name, username: selected.username };
        }
      }
      displayEditGroupTeacherResults(window.editGroupTeachers);
    })
    .catch(err => {
      results.innerHTML = `<p class="small" style="text-align: center; color: var(--hint); padding: 12px 0;">❌ ${err.message}</p>`;
    });
}

function searchEditGroupTeacher() {
  const input = document.getElementById('edit-group-teacher-search');
  const query = (input?.value || '').trim().toLowerCase();
  const results = document.getElementById('edit-group-teacher-search-results');
  if (!results) return;

  if (!window.editGroupTeachers) {
    results.innerHTML = `<p class="small" style="text-align: center; color: var(--hint); padding: 12px 0;">⏳ Загрузка преподавателей...</p>`;
    return;
  }

  if (!query) {
    displayEditGroupTeacherResults(window.editGroupTeachers);
    return;
  }

  const filtered = window.editGroupTeachers.filter(t => {
    const name = (t.name || '').toLowerCase();
    const username = (t.username || '').toLowerCase();
    const idStr = String(t.id || '');
    return name.includes(query) || username.includes(query) || idStr.includes(query);
  });

  if (!filtered.length) {
    results.innerHTML = `<p class="small" style="text-align: center; color: var(--hint); padding: 12px 0;">Преподаватели не найдены</p>`;
    return;
  }

  displayEditGroupTeacherResults(filtered);
}

function displayEditGroupTeacherResults(teachers) {
  const results = document.getElementById('edit-group-teacher-search-results');
  if (!results) return;

  const html = teachers.map(t => {
    const safeName = (t.name || '—').replace(/'/g, "\\'").replace(/"/g, '\\"');
    const safeUsername = (t.username || '').replace(/'/g, "\\'").replace(/"/g, '\\"');
    const isSelected = window.selectedEditGroupTeacher && window.selectedEditGroupTeacher.id === t.id;
    const borderColor = isSelected ? 'var(--accent)' : 'var(--border)';
    const bgColor = isSelected ? 'var(--accent-soft)' : 'var(--card)';
    return `
      <div class="card" id="edit-group-teacher-card-${t.id}" style="margin-bottom: 8px; cursor: pointer; background: ${bgColor}; border-left: 4px solid ${borderColor}; transition: all 0.2s;" onclick="selectEditGroupTeacher(${t.id}, '${safeName}', '${safeUsername}')">
        <div style="font-weight: 600; font-size: 14px;">
          ${t.name || '—'}
          ${isSelected ? ' ?' : ''}
        </div>
        <div style="font-size: 12px; color: var(--hint); margin-top: 2px;">ID: ${t.id}${t.username ? ` • @${t.username}` : ''}</div>
      </div>
    `;
  }).join('');

  results.innerHTML = html || '<p class="small" style="text-align: center; color: var(--hint); padding: 12px 0;">Нет преподавателей</p>';
}

function selectEditGroupTeacher(id, name, username) {
  window.selectedEditGroupTeacher = { id, name, username };
  displayEditGroupTeacherResults(window.editGroupTeachers || []);
}

function openEditGroupPage(groupId) {
  window.currentEditGroupId = groupId;
  window.selectedEditGroupTeacher = null;
  window.editGroupPreselectTeacherId = null;

  try {
    showPage('direction-group-edit');
  } catch (err) {
    showNotification('? Не удалось открыть форму редактирования группы');
    return;
  }
  const teacherSearch = document.getElementById('edit-group-teacher-search');
  if (teacherSearch) teacherSearch.value = '';

  fetch(`/api/groups/${groupId}`)
    .then(async r => {
      const data = await r.json();
      if (!r.ok) throw new Error(data.error || 'Не удалось загрузить группу');
      return data;
    })
    .then(group => {
      document.getElementById('edit-group-name').value = group.name || '';
      document.getElementById('edit-group-age').value = group.age_group || '';
      document.getElementById('edit-group-max').value = group.max_students || '';
      document.getElementById('edit-group-duration').value = group.duration_minutes || '';
      document.getElementById('edit-group-desc').value = group.description || '';
      document.getElementById('edit-group-lessons').value = group.lessons_per_week || '';
      window.editGroupPreselectTeacherId = group.teacher_id;
      loadEditGroupTeachers();
    })
    .catch(err => {
      setEditGroupMessage('? ' + err.message, true);
      showNotification('? ' + err.message);
    });
}

function saveGroupChanges() {
  const groupId = window.currentEditGroupId;
  if (!groupId) {
    setEditGroupMessage('? ID группы не найден', true);
    return;
  }

  const name = document.getElementById('edit-group-name').value.trim();
  const teacherId = window.selectedEditGroupTeacher ? window.selectedEditGroupTeacher.id : null;
  const ageGroup = document.getElementById('edit-group-age').value.trim();
  const maxStudents = document.getElementById('edit-group-max').value;
  const durationMinutes = document.getElementById('edit-group-duration').value;
  const lessonsPerWeek = document.getElementById('edit-group-lessons').value;
  const description = document.getElementById('edit-group-desc').value.trim();

  if (!name || !teacherId || !ageGroup || !maxStudents || !durationMinutes) {
    setEditGroupMessage('? Заполните обязательные поля', true);
    return;
  }

  authFetch(`/api/groups/${groupId}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      name,
      teacher_id: parseInt(teacherId, 10),
      age_group: ageGroup,
      max_students: parseInt(maxStudents, 10),
      duration_minutes: parseInt(durationMinutes, 10),
      lessons_per_week: lessonsPerWeek ? parseInt(lessonsPerWeek, 10) : null,
      description
    })
  })
    .then(async r => {
      const data = await r.json();
      if (!r.ok) throw new Error(data.error || 'Не удалось сохранить группу');
      return data;
    })
    .then(() => {
      setEditGroupMessage('? Группа обновлена', false);
      loadDirectionGroups();
      setTimeout(() => {
        goBack();
      }, 600);
    })
    .catch(err => {
      setEditGroupMessage('? ' + err.message, true);
    });
}

function saveDirectionChanges() {
  if (window.directionEditLocked) {
    alert('🔒 Сначала разблокируйте редактирование.');
    return;
  }

  const directionId = window.currentEditDirectionId;
  if (!directionId) {
    alert('? ID направления не найден');
    return;
  }
  
  const title = document.getElementById('edit-direction-title').value.trim();
  const description = document.getElementById('edit-direction-description').value.trim();
  const price = document.getElementById('edit-direction-price').value;
  const directionType = document.getElementById('edit-direction-type').value || 'dance';
  const status = document.getElementById('edit-direction-status').value;
  
  if (!title || !description || !price || !directionType) {
    alert('? Пожалуйста, заполните все поля');
    return;
  }
  
  fetch(`/api/directions/${directionId}`, {
    method: 'PUT',
    headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
    body: JSON.stringify({
      title,
      description,
      base_price: parseFloat(price),
      direction_type: directionType,
      status
    })
  })
    .then(r => r.json())
    .then(data => {
      alert('? Направление обновлено');
      goBack();
      loadDirections();
    })
    .catch(err => alert('? Ошибка: ' + err.message));
}

function archiveDirection(directionId) {
  if (confirm('Архивировать это направление?')) {
    fetch(`/api/directions/${directionId}`, { method: 'DELETE', headers: getAuthHeaders() })
      .then(r => r.json())
      .then(data => {
        alert('? Направление архивировано');
        loadDirections();
      })
      .catch(err => alert('? Ошибка: ' + err.message));
  }
}

</script>
</body>
</html>






























